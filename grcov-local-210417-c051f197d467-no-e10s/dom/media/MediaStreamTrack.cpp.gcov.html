<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - dom/media/MediaStreamTrack.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">dom/media</a> - MediaStreamTrack.cpp<span style="font-size: 80%;"> (source / <a href="MediaStreamTrack.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">178</td>
            <td class="headerCovTableEntry">235</td>
            <td class="headerCovTableEntryMed">75.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21 12:59:10</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">48</td>
            <td class="headerCovTableEntry">60</td>
            <td class="headerCovTableEntryMed">80.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-*/</a>
<span class="lineNum">       2 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       3 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this file,
<span class="lineNum">       4 </span>            :  * You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            : #include &quot;MediaStreamTrack.h&quot;
<span class="lineNum">       7 </span>            : 
<span class="lineNum">       8 </span>            : #include &quot;DOMMediaStream.h&quot;
<span class="lineNum">       9 </span>            : #include &quot;MediaStreamGraph.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;nsIUUIDGenerator.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;nsServiceManagerUtils.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;MediaStreamListener.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;systemservices/MediaUtils.h&quot;
<span class="lineNum">      14 </span>            : 
<span class="lineNum">      15 </span>            : #include &quot;mozilla/dom/Promise.h&quot;
<span class="lineNum">      16 </span>            : 
<span class="lineNum">      17 </span>            : #ifdef LOG
<span class="lineNum">      18 </span>            : #undef LOG
<span class="lineNum">      19 </span>            : #endif
<span class="lineNum">      20 </span>            : 
<span class="lineNum">      21 </span>            : static mozilla::LazyLogModule gMediaStreamTrackLog(&quot;MediaStreamTrack&quot;);
<span class="lineNum">      22 </span>            : #define LOG(type, msg) MOZ_LOG(gMediaStreamTrackLog, type, msg)
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : namespace mozilla {
<a name="25"><span class="lineNum">      25 </span>            : namespace dom {</a>
<a name="26"><span class="lineNum">      26 </span>            : </a>
<a name="27"><span class="lineNum">      27 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTING_ADDREF(MediaStreamTrackSource)</span></a>
<span class="lineNum">      28 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTING_RELEASE(MediaStreamTrackSource)</span>
<span class="lineNum">      29 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(MediaStreamTrackSource)</span>
<span class="lineNum">      30 </span><span class="lineNoCov">          0 :   NS_INTERFACE_MAP_ENTRY(nsISupports)</span>
<span class="lineNum">      31 </span><span class="lineNoCov">          0 : NS_INTERFACE_MAP_END</span>
<span class="lineNum">      32 </span>            : 
<a name="33"><span class="lineNum">      33 </span>            : NS_IMPL_CYCLE_COLLECTION_CLASS(MediaStreamTrackSource)</a>
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(MediaStreamTrackSource)</span>
<span class="lineNum">      36 </span><span class="lineCov">          1 :   tmp-&gt;Destroy();</span>
<span class="lineNum">      37 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mPrincipal)</span>
<a name="38"><span class="lineNum">      38 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_UNLINK_END</span></a>
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(MediaStreamTrackSource)</span>
<span class="lineNum">      41 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mPrincipal)</span>
<span class="lineNum">      42 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END</span>
<a name="43"><span class="lineNum">      43 </span>            : </a>
<span class="lineNum">      44 </span>            : auto
<span class="lineNum">      45 </span><span class="lineNoCov">          0 : MediaStreamTrackSource::ApplyConstraints(</span>
<span class="lineNum">      46 </span>            :     nsPIDOMWindowInner* aWindow,
<span class="lineNum">      47 </span>            :     const dom::MediaTrackConstraints&amp; aConstraints,
<span class="lineNum">      48 </span>            :     CallerType aCallerType) -&gt; already_AddRefed&lt;PledgeVoid&gt;
<span class="lineNum">      49 </span>            : {
<span class="lineNum">      50 </span><span class="lineNoCov">          0 :   RefPtr&lt;PledgeVoid&gt; p = new PledgeVoid();</span>
<span class="lineNum">      51 </span>            :   p-&gt;Reject(new MediaStreamError(aWindow,
<span class="lineNum">      52 </span>            :                                  NS_LITERAL_STRING(&quot;OverconstrainedError&quot;),
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :                                  NS_LITERAL_STRING(&quot;&quot;)));</span>
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :   return p.forget();</span>
<a name="55"><span class="lineNum">      55 </span>            : }</a>
<a name="56"><span class="lineNum">      56 </span>            : </a>
<a name="57"><span class="lineNum">      57 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTING_ADDREF(MediaStreamTrackConsumer)</span></a>
<span class="lineNum">      58 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTING_RELEASE(MediaStreamTrackConsumer)</span>
<span class="lineNum">      59 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(MediaStreamTrackConsumer)</span>
<span class="lineNum">      60 </span><span class="lineNoCov">          0 :   NS_INTERFACE_MAP_ENTRY(nsISupports)</span>
<a name="61"><span class="lineNum">      61 </span><span class="lineNoCov">          0 : NS_INTERFACE_MAP_END</span></a>
<span class="lineNum">      62 </span>            : 
<span class="lineNum">      63 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_0(MediaStreamTrackConsumer)</span>
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span>            : /**
<span class="lineNum">      66 </span>            :  * PrincipalHandleListener monitors changes in PrincipalHandle of the media flowing
<span class="lineNum">      67 </span>            :  * through the MediaStreamGraph.
<span class="lineNum">      68 </span>            :  *
<span class="lineNum">      69 </span>            :  * When the main thread principal for a MediaStreamTrack changes, its principal
<span class="lineNum">      70 </span>            :  * will be set to the combination of the previous principal and the new one.
<span class="lineNum">      71 </span>            :  *
<span class="lineNum">      72 </span>            :  * As a PrincipalHandle change later happens on the MediaStreamGraph thread, we will
<span class="lineNum">      73 </span>            :  * be notified. If the latest principal on main thread matches the PrincipalHandle
<span class="lineNum">      74 </span>            :  * we just saw on MSG thread, we will set the track's principal to the new one.
<span class="lineNum">      75 </span>            :  *
<span class="lineNum">      76 </span>            :  * We know at this point that the old principal has been flushed out and data
<span class="lineNum">      77 </span>            :  * under it cannot leak to consumers.
<span class="lineNum">      78 </span>            :  *
<span class="lineNum">      79 </span>            :  * In case of multiple changes to the main thread state, the track's principal
<span class="lineNum">      80 </span>            :  * will be a combination of its old principal and all the new ones until the
<a name="81"><span class="lineNum">      81 </span>            :  * latest main thread principal matches the PrincipalHandle on the MSG thread.</a>
<span class="lineNum">      82 </span>            :  */
<span class="lineNum">      83 </span><span class="lineCov">          1 : class MediaStreamTrack::PrincipalHandleListener : public MediaStreamTrackListener</span>
<a name="84"><span class="lineNum">      84 </span>            : {</a>
<span class="lineNum">      85 </span>            : public:
<span class="lineNum">      86 </span><span class="lineCov">          1 :   explicit PrincipalHandleListener(MediaStreamTrack* aTrack)</span>
<span class="lineNum">      87 </span>            :     : mTrack(aTrack)
<span class="lineNum">      88 </span><span class="lineCov">          1 :     , mAbstractMainThread(aTrack-&gt;mOwningStream-&gt;AbstractMainThread())</span>
<span class="lineNum">      89 </span><span class="lineCov">          1 :     {}</span>
<span class="lineNum">      90 </span>            : 
<span class="lineNum">      91 </span>            :   void Forget()
<span class="lineNum">      92 </span>            :   {
<span class="lineNum">      93 </span>            :     MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">      94 </span><span class="lineCov">          1 :     mTrack = nullptr;</span>
<a name="95"><span class="lineNum">      95 </span>            :   }</a>
<span class="lineNum">      96 </span>            : 
<span class="lineNum">      97 </span><span class="lineCov">          1 :   void DoNotifyPrincipalHandleChanged(const PrincipalHandle&amp; aNewPrincipalHandle)</span>
<span class="lineNum">      98 </span>            :   {
<span class="lineNum">      99 </span>            :     MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     100 </span>            : 
<span class="lineNum">     101 </span><span class="lineCov">          1 :     if (!mTrack) {</span>
<span class="lineNum">     102 </span><span class="lineCov">          1 :       return;</span>
<span class="lineNum">     103 </span>            :     }
<span class="lineNum">     104 </span>            : 
<span class="lineNum">     105 </span><span class="lineCov">          1 :     mTrack-&gt;NotifyPrincipalHandleChanged(aNewPrincipalHandle);</span>
<a name="106"><span class="lineNum">     106 </span>            :   }</a>
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span><span class="lineCov">          1 :   void NotifyPrincipalHandleChanged(MediaStreamGraph* aGraph,</span>
<span class="lineNum">     109 </span>            :                                     const PrincipalHandle&amp; aNewPrincipalHandle) override
<span class="lineNum">     110 </span>            :   {
<span class="lineNum">     111 </span>            :     aGraph-&gt;DispatchToMainThreadAfterStreamStateUpdate(
<span class="lineNum">     112 </span>            :       mAbstractMainThread,
<span class="lineNum">     113 </span>            :       NewRunnableMethod&lt;StoreCopyPassByConstLRef&lt;PrincipalHandle&gt;&gt;(
<span class="lineNum">     114 </span><span class="lineCov">          1 :         this, &amp;PrincipalHandleListener::DoNotifyPrincipalHandleChanged, aNewPrincipalHandle));</span>
<span class="lineNum">     115 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span>            : protected:
<span class="lineNum">     118 </span>            :   // These fields may only be accessed on the main thread
<span class="lineNum">     119 </span>            :   MediaStreamTrack* mTrack;
<span class="lineNum">     120 </span>            :   const RefPtr&lt;AbstractThread&gt; mAbstractMainThread;
<a name="121"><span class="lineNum">     121 </span>            : };</a>
<span class="lineNum">     122 </span>            : 
<span class="lineNum">     123 </span><span class="lineCov">          1 : MediaStreamTrack::MediaStreamTrack(DOMMediaStream* aStream, TrackID aTrackID,</span>
<span class="lineNum">     124 </span>            :                                    TrackID aInputTrackID,
<span class="lineNum">     125 </span>            :                                    MediaStreamTrackSource* aSource,
<span class="lineNum">     126 </span>            :                                    const MediaTrackConstraints&amp; aConstraints)
<span class="lineNum">     127 </span>            :   : mOwningStream(aStream), mTrackID(aTrackID),
<span class="lineNum">     128 </span>            :     mInputTrackID(aInputTrackID), mSource(aSource),
<span class="lineNum">     129 </span>            :     mPrincipal(aSource-&gt;GetPrincipal()),
<span class="lineNum">     130 </span>            :     mReadyState(MediaStreamTrackState::Live),
<span class="lineNum">     131 </span><span class="lineCov">          1 :     mEnabled(true), mConstraints(aConstraints)</span>
<span class="lineNum">     132 </span>            : {
<span class="lineNum">     133 </span><span class="lineCov">          1 :   GetSource().RegisterSink(this);</span>
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span><span class="lineCov">          1 :   if (GetOwnedStream()) {</span>
<span class="lineNum">     136 </span><span class="lineCov">          1 :     mPrincipalHandleListener = new PrincipalHandleListener(this);</span>
<span class="lineNum">     137 </span><span class="lineCov">          1 :     AddListener(mPrincipalHandleListener);</span>
<span class="lineNum">     138 </span>            :   }
<span class="lineNum">     139 </span>            : 
<span class="lineNum">     140 </span>            :   nsresult rv;
<span class="lineNum">     141 </span>            :   nsCOMPtr&lt;nsIUUIDGenerator&gt; uuidgen =
<span class="lineNum">     142 </span><span class="lineCov">          1 :     do_GetService(&quot;@mozilla.org/uuid-generator;1&quot;, &amp;rv);</span>
<span class="lineNum">     143 </span>            : 
<span class="lineNum">     144 </span>            :   nsID uuid;
<span class="lineNum">     145 </span><span class="lineCov">          1 :   memset(&amp;uuid, 0, sizeof(uuid));</span>
<span class="lineNum">     146 </span><span class="lineCov">          1 :   if (uuidgen) {</span>
<span class="lineNum">     147 </span><span class="lineCov">          1 :     uuidgen-&gt;GenerateUUIDInPlace(&amp;uuid);</span>
<span class="lineNum">     148 </span>            :   }
<span class="lineNum">     149 </span>            : 
<span class="lineNum">     150 </span>            :   char chars[NSID_LENGTH];
<span class="lineNum">     151 </span><span class="lineCov">          1 :   uuid.ToProvidedString(chars);</span>
<span class="lineNum">     152 </span><span class="lineCov">          1 :   mID = NS_ConvertASCIItoUTF16(chars);</span>
<a name="153"><span class="lineNum">     153 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span><span class="lineCov">          1 : MediaStreamTrack::~MediaStreamTrack()</span>
<span class="lineNum">     156 </span>            : {
<span class="lineNum">     157 </span><span class="lineCov">          1 :   Destroy();</span>
<span class="lineNum">     158 </span><span class="lineCov">          1 : }</span>
<a name="159"><span class="lineNum">     159 </span>            : </a>
<span class="lineNum">     160 </span>            : void
<span class="lineNum">     161 </span><span class="lineCov">          1 : MediaStreamTrack::Destroy()</span>
<span class="lineNum">     162 </span>            : {
<span class="lineNum">     163 </span><span class="lineCov">          1 :   if (mSource) {</span>
<span class="lineNum">     164 </span><span class="lineCov">          1 :     mSource-&gt;UnregisterSink(this);</span>
<span class="lineNum">     165 </span>            :   }
<span class="lineNum">     166 </span><span class="lineCov">          1 :   if (mPrincipalHandleListener) {</span>
<span class="lineNum">     167 </span><span class="lineCov">          1 :     if (GetOwnedStream()) {</span>
<span class="lineNum">     168 </span><span class="lineCov">          1 :       RemoveListener(mPrincipalHandleListener);</span>
<span class="lineNum">     169 </span>            :     }
<span class="lineNum">     170 </span><span class="lineCov">          1 :     mPrincipalHandleListener-&gt;Forget();</span>
<span class="lineNum">     171 </span><span class="lineCov">          1 :     mPrincipalHandleListener = nullptr;</span>
<span class="lineNum">     172 </span>            :   }
<span class="lineNum">     173 </span><span class="lineCov">          1 :   for (auto l : mTrackListeners) {</span>
<span class="lineNum">     174 </span><span class="lineCov">          1 :     RemoveListener(l);</span>
<span class="lineNum">     175 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     176 </span><span class="lineCov">          1 :   for (auto l : mDirectTrackListeners) {</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :     RemoveDirectListener(l);</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     179 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     180 </span>            : 
<a name="181"><span class="lineNum">     181 </span>            : NS_IMPL_CYCLE_COLLECTION_CLASS(MediaStreamTrack)</a>
<span class="lineNum">     182 </span>            : 
<span class="lineNum">     183 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN_INHERITED(MediaStreamTrack,</span>
<span class="lineNum">     184 </span>            :                                                 DOMEventTargetHelper)
<span class="lineNum">     185 </span><span class="lineCov">          1 :   tmp-&gt;Destroy();</span>
<span class="lineNum">     186 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mConsumers)</span>
<span class="lineNum">     187 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mOwningStream)</span>
<span class="lineNum">     188 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mSource)</span>
<span class="lineNum">     189 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mOriginalTrack)</span>
<span class="lineNum">     190 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mPrincipal)</span>
<span class="lineNum">     191 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mPendingPrincipal)</span>
<a name="192"><span class="lineNum">     192 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_UNLINK_END</span></a>
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_INHERITED(MediaStreamTrack,</span>
<span class="lineNum">     195 </span>            :                                                   DOMEventTargetHelper)
<span class="lineNum">     196 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mConsumers)</span>
<span class="lineNum">     197 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mOwningStream)</span>
<span class="lineNum">     198 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mSource)</span>
<span class="lineNum">     199 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mOriginalTrack)</span>
<span class="lineNum">     200 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mPrincipal)</span>
<span class="lineNum">     201 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mPendingPrincipal)</span>
<a name="202"><span class="lineNum">     202 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END</span></a>
<a name="203"><span class="lineNum">     203 </span>            : </a>
<a name="204"><span class="lineNum">     204 </span><span class="lineCov">          1 : NS_IMPL_ADDREF_INHERITED(MediaStreamTrack, DOMEventTargetHelper)</span></a>
<span class="lineNum">     205 </span><span class="lineCov">          1 : NS_IMPL_RELEASE_INHERITED(MediaStreamTrack, DOMEventTargetHelper)</span>
<span class="lineNum">     206 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION_INHERITED(MediaStreamTrack)</span>
<span class="lineNum">     207 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_END_INHERITING(DOMEventTargetHelper)</span>
<a name="208"><span class="lineNum">     208 </span>            : </a>
<span class="lineNum">     209 </span>            : nsPIDOMWindowInner*
<span class="lineNum">     210 </span><span class="lineCov">          1 : MediaStreamTrack::GetParentObject() const</span>
<span class="lineNum">     211 </span>            : {
<span class="lineNum">     212 </span><span class="lineCov">          1 :   MOZ_RELEASE_ASSERT(mOwningStream);</span>
<span class="lineNum">     213 </span><span class="lineCov">          1 :   return mOwningStream-&gt;GetParentObject();</span>
<span class="lineNum">     214 </span>            : }
<a name="215"><span class="lineNum">     215 </span>            : </a>
<span class="lineNum">     216 </span>            : void
<span class="lineNum">     217 </span><span class="lineCov">          1 : MediaStreamTrack::GetId(nsAString&amp; aID) const</span>
<span class="lineNum">     218 </span>            : {
<span class="lineNum">     219 </span><span class="lineCov">          1 :   aID = mID;</span>
<span class="lineNum">     220 </span><span class="lineCov">          1 : }</span>
<a name="221"><span class="lineNum">     221 </span>            : </a>
<span class="lineNum">     222 </span>            : void
<span class="lineNum">     223 </span><span class="lineCov">          1 : MediaStreamTrack::SetEnabled(bool aEnabled)</span>
<span class="lineNum">     224 </span>            : {
<span class="lineNum">     225 </span><span class="lineCov">          1 :   LOG(LogLevel::Info, (&quot;MediaStreamTrack %p %s&quot;,</span>
<span class="lineNum">     226 </span>            :                        this, aEnabled ? &quot;Enabled&quot; : &quot;Disabled&quot;));
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineCov">          1 :   mEnabled = aEnabled;</span>
<span class="lineNum">     229 </span><span class="lineCov">          1 :   GetOwnedStream()-&gt;SetTrackEnabled(mTrackID, mEnabled ? DisabledTrackMode::ENABLED</span>
<span class="lineNum">     230 </span><span class="lineCov">          1 :                                                        : DisabledTrackMode::SILENCE_BLACK);</span>
<span class="lineNum">     231 </span><span class="lineCov">          1 : }</span>
<a name="232"><span class="lineNum">     232 </span>            : </a>
<span class="lineNum">     233 </span>            : void
<span class="lineNum">     234 </span><span class="lineCov">          1 : MediaStreamTrack::Stop()</span>
<span class="lineNum">     235 </span>            : {
<span class="lineNum">     236 </span><span class="lineCov">          1 :   LOG(LogLevel::Info, (&quot;MediaStreamTrack %p Stop()&quot;, this));</span>
<span class="lineNum">     237 </span>            : 
<span class="lineNum">     238 </span><span class="lineCov">          1 :   if (Ended()) {</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :     LOG(LogLevel::Warning, (&quot;MediaStreamTrack %p Already ended&quot;, this));</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     241 </span>            :   }
<span class="lineNum">     242 </span>            : 
<span class="lineNum">     243 </span><span class="lineCov">          1 :   if (!mSource) {</span>
<span class="lineNum">     244 </span>            :     MOZ_ASSERT(false);
<span class="lineNum">     245 </span>            :     return;
<span class="lineNum">     246 </span>            :   }
<span class="lineNum">     247 </span>            : 
<span class="lineNum">     248 </span><span class="lineCov">          1 :   mSource-&gt;UnregisterSink(this);</span>
<span class="lineNum">     249 </span>            : 
<span class="lineNum">     250 </span>            :   MOZ_ASSERT(mOwningStream, &quot;Every MediaStreamTrack needs an owning DOMMediaStream&quot;);
<span class="lineNum">     251 </span><span class="lineCov">          1 :   DOMMediaStream::TrackPort* port = mOwningStream-&gt;FindOwnedTrackPort(*this);</span>
<span class="lineNum">     252 </span>            :   MOZ_ASSERT(port, &quot;A MediaStreamTrack must exist in its owning DOMMediaStream&quot;);
<span class="lineNum">     253 </span><span class="lineCov">          1 :   RefPtr&lt;Pledge&lt;bool&gt;&gt; p = port-&gt;BlockSourceTrackId(mInputTrackID, BlockingMode::CREATION);</span>
<span class="lineNum">     254 </span><span class="lineCov">          1 :   Unused &lt;&lt; p;</span>
<span class="lineNum">     255 </span>            : 
<span class="lineNum">     256 </span><span class="lineCov">          1 :   mReadyState = MediaStreamTrackState::Ended;</span>
<span class="lineNum">     257 </span>            : 
<span class="lineNum">     258 </span><span class="lineCov">          1 :   NotifyEnded();</span>
<span class="lineNum">     259 </span>            : }
<a name="260"><span class="lineNum">     260 </span>            : </a>
<span class="lineNum">     261 </span>            : void
<span class="lineNum">     262 </span><span class="lineNoCov">          0 : MediaStreamTrack::GetConstraints(dom::MediaTrackConstraints&amp; aResult)</span>
<span class="lineNum">     263 </span>            : {
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :   aResult = mConstraints;</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 : }</span>
<a name="266"><span class="lineNum">     266 </span>            : </a>
<span class="lineNum">     267 </span>            : void
<span class="lineNum">     268 </span><span class="lineNoCov">          0 : MediaStreamTrack::GetSettings(dom::MediaTrackSettings&amp; aResult)</span>
<span class="lineNum">     269 </span>            : {
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :   GetSource().GetSettings(aResult);</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 : }</span>
<a name="272"><span class="lineNum">     272 </span>            : </a>
<span class="lineNum">     273 </span>            : already_AddRefed&lt;Promise&gt;
<span class="lineNum">     274 </span><span class="lineNoCov">          0 : MediaStreamTrack::ApplyConstraints(const MediaTrackConstraints&amp; aConstraints,</span>
<span class="lineNum">     275 </span>            :                                    CallerType aCallerType,
<span class="lineNum">     276 </span>            :                                    ErrorResult &amp;aRv)
<span class="lineNum">     277 </span>            : {
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :   if (MOZ_LOG_TEST(gMediaStreamTrackLog, LogLevel::Info)) {</span>
<span class="lineNum">     279 </span>            :     nsString str;
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :     aConstraints.ToJSON(str);</span>
<span class="lineNum">     281 </span>            : 
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :     LOG(LogLevel::Info, (&quot;MediaStreamTrack %p ApplyConstraints() with &quot;</span>
<span class="lineNum">     283 </span>            :                          &quot;constraints %s&quot;, this, NS_ConvertUTF16toUTF8(str).get()));
<span class="lineNum">     284 </span>            :   }
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span>            :   typedef media::Pledge&lt;bool, MediaStreamError*&gt; PledgeVoid;
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :   nsPIDOMWindowInner* window = mOwningStream-&gt;GetParentObject();</span>
<span class="lineNum">     289 </span>            : 
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIGlobalObject&gt; go = do_QueryInterface(window);</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :   RefPtr&lt;Promise&gt; promise = Promise::Create(go, aRv);</span>
<span class="lineNum">     292 </span>            : 
<span class="lineNum">     293 </span>            :   // Forward constraints to the source.
<span class="lineNum">     294 </span>            :   //
<span class="lineNum">     295 </span>            :   // After GetSource().ApplyConstraints succeeds (after it's been to media-thread
<span class="lineNum">     296 </span>            :   // and back), and no sooner, do we set mConstraints to the newly applied values.
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span>            :   // Keep a reference to this, to make sure it's still here when we get back.
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :   RefPtr&lt;MediaStreamTrack&gt; that = this;</span>
<a name="300"><span class="lineNum">     300 </span><span class="lineNoCov">          0 :   RefPtr&lt;PledgeVoid&gt; p = GetSource().ApplyConstraints(window, aConstraints,</span></a>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :                                                       aCallerType);</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :   p-&gt;Then([this, that, promise, aConstraints](bool&amp; aDummy) mutable {</span>
<a name="303"><span class="lineNum">     303 </span><span class="lineNoCov">          0 :     mConstraints = aConstraints;</span></a>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :     promise-&gt;MaybeResolve(false);</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :   }, [promise](MediaStreamError*&amp; reason) mutable {</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :     promise-&gt;MaybeReject(reason);</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :   });</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :   return promise.forget();</span>
<span class="lineNum">     309 </span>            : }
<a name="310"><span class="lineNum">     310 </span>            : </a>
<span class="lineNum">     311 </span>            : MediaStreamGraph*
<span class="lineNum">     312 </span><span class="lineCov">          1 : MediaStreamTrack::Graph()</span>
<span class="lineNum">     313 </span>            : {
<span class="lineNum">     314 </span><span class="lineCov">          1 :   return GetOwnedStream()-&gt;Graph();</span>
<span class="lineNum">     315 </span>            : }
<a name="316"><span class="lineNum">     316 </span>            : </a>
<span class="lineNum">     317 </span>            : MediaStreamGraphImpl*
<span class="lineNum">     318 </span><span class="lineNoCov">          0 : MediaStreamTrack::GraphImpl()</span>
<span class="lineNum">     319 </span>            : {
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :   return GetOwnedStream()-&gt;GraphImpl();</span>
<span class="lineNum">     321 </span>            : }
<a name="322"><span class="lineNum">     322 </span>            : </a>
<span class="lineNum">     323 </span>            : void
<span class="lineNum">     324 </span><span class="lineNoCov">          0 : MediaStreamTrack::SetPrincipal(nsIPrincipal* aPrincipal)</span>
<span class="lineNum">     325 </span>            : {
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :   if (aPrincipal == mPrincipal) {</span>
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     328 </span>            :   }
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :   mPrincipal = aPrincipal;</span>
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :   LOG(LogLevel::Info, (&quot;MediaStreamTrack %p principal changed to %p. Now: &quot;</span>
<span class="lineNum">     332 </span>            :                        &quot;null=%d, codebase=%d, expanded=%d, system=%d&quot;,
<span class="lineNum">     333 </span>            :                        this, mPrincipal.get(),
<span class="lineNum">     334 </span>            :                        mPrincipal-&gt;GetIsNullPrincipal(),
<span class="lineNum">     335 </span>            :                        mPrincipal-&gt;GetIsCodebasePrincipal(),
<span class="lineNum">     336 </span>            :                        mPrincipal-&gt;GetIsExpandedPrincipal(),
<span class="lineNum">     337 </span>            :                        mPrincipal-&gt;GetIsSystemPrincipal()));
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :   for (PrincipalChangeObserver&lt;MediaStreamTrack&gt;* observer</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :       : mPrincipalChangeObservers) {</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :     observer-&gt;PrincipalChanged(this);</span>
<span class="lineNum">     341 </span>            :   }
<span class="lineNum">     342 </span>            : }
<a name="343"><span class="lineNum">     343 </span>            : </a>
<span class="lineNum">     344 </span>            : void
<span class="lineNum">     345 </span><span class="lineNoCov">          0 : MediaStreamTrack::PrincipalChanged()</span>
<span class="lineNum">     346 </span>            : {
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :   mPendingPrincipal = GetSource().GetPrincipal();</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIPrincipal&gt; newPrincipal = mPrincipal;</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :   LOG(LogLevel::Info, (&quot;MediaStreamTrack %p Principal changed on main thread &quot;</span>
<span class="lineNum">     350 </span>            :                        &quot;to %p (pending). Combining with existing principal %p.&quot;,
<span class="lineNum">     351 </span>            :                        this, mPendingPrincipal.get(), mPrincipal.get()));
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :   if (nsContentUtils::CombineResourcePrincipals(&amp;newPrincipal,</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :                                                 mPendingPrincipal)) {</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :     SetPrincipal(newPrincipal);</span>
<span class="lineNum">     355 </span>            :   }
<span class="lineNum">     356 </span><span class="lineNoCov">          0 : }</span>
<a name="357"><span class="lineNum">     357 </span>            : </a>
<span class="lineNum">     358 </span>            : void
<span class="lineNum">     359 </span><span class="lineCov">          1 : MediaStreamTrack::NotifyPrincipalHandleChanged(const PrincipalHandle&amp; aNewPrincipalHandle)</span>
<span class="lineNum">     360 </span>            : {
<span class="lineNum">     361 </span>            :   PrincipalHandle handle(aNewPrincipalHandle);
<span class="lineNum">     362 </span><span class="lineCov">          1 :   LOG(LogLevel::Info, (&quot;MediaStreamTrack %p principalHandle changed on &quot;</span>
<span class="lineNum">     363 </span>            :                        &quot;MediaStreamGraph thread to %p. Current principal: %p, &quot;
<span class="lineNum">     364 </span>            :                        &quot;pending: %p&quot;,
<span class="lineNum">     365 </span>            :                        this, GetPrincipalFromHandle(handle),
<span class="lineNum">     366 </span>            :                        mPrincipal.get(), mPendingPrincipal.get()));
<span class="lineNum">     367 </span><span class="lineCov">          1 :   if (PrincipalHandleMatches(handle, mPendingPrincipal)) {</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :     SetPrincipal(mPendingPrincipal);</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :     mPendingPrincipal = nullptr;</span>
<span class="lineNum">     370 </span>            :   }
<span class="lineNum">     371 </span><span class="lineCov">          1 : }</span>
<a name="372"><span class="lineNum">     372 </span>            : </a>
<span class="lineNum">     373 </span>            : void
<span class="lineNum">     374 </span><span class="lineCov">          1 : MediaStreamTrack::NotifyEnded()</span>
<span class="lineNum">     375 </span>            : {
<span class="lineNum">     376 </span>            :   MOZ_ASSERT(mReadyState == MediaStreamTrackState::Ended);
<span class="lineNum">     377 </span>            : 
<span class="lineNum">     378 </span><span class="lineCov">          1 :   for (int32_t i = mConsumers.Length() - 1; i &gt;= 0; --i) {</span>
<span class="lineNum">     379 </span>            :     // Loop backwards by index in case the consumer removes itself in the
<span class="lineNum">     380 </span>            :     // callback.
<span class="lineNum">     381 </span><span class="lineCov">          1 :     mConsumers[i]-&gt;NotifyEnded(this);</span>
<span class="lineNum">     382 </span>            :   }
<span class="lineNum">     383 </span><span class="lineCov">          1 : }</span>
<a name="384"><span class="lineNum">     384 </span>            : </a>
<span class="lineNum">     385 </span>            : bool
<span class="lineNum">     386 </span><span class="lineCov">          1 : MediaStreamTrack::AddPrincipalChangeObserver(</span>
<span class="lineNum">     387 </span>            :   PrincipalChangeObserver&lt;MediaStreamTrack&gt;* aObserver)
<span class="lineNum">     388 </span>            : {
<span class="lineNum">     389 </span><span class="lineCov">          1 :   return mPrincipalChangeObservers.AppendElement(aObserver) != nullptr;</span>
<span class="lineNum">     390 </span>            : }
<a name="391"><span class="lineNum">     391 </span>            : </a>
<span class="lineNum">     392 </span>            : bool
<span class="lineNum">     393 </span><span class="lineCov">          1 : MediaStreamTrack::RemovePrincipalChangeObserver(</span>
<span class="lineNum">     394 </span>            :   PrincipalChangeObserver&lt;MediaStreamTrack&gt;* aObserver)
<span class="lineNum">     395 </span>            : {
<span class="lineNum">     396 </span><span class="lineCov">          1 :   return mPrincipalChangeObservers.RemoveElement(aObserver);</span>
<span class="lineNum">     397 </span>            : }
<a name="398"><span class="lineNum">     398 </span>            : </a>
<span class="lineNum">     399 </span>            : void
<span class="lineNum">     400 </span><span class="lineCov">          1 : MediaStreamTrack::AddConsumer(MediaStreamTrackConsumer* aConsumer)</span>
<span class="lineNum">     401 </span>            : {
<span class="lineNum">     402 </span>            :   MOZ_ASSERT(!mConsumers.Contains(aConsumer));
<span class="lineNum">     403 </span><span class="lineCov">          1 :   mConsumers.AppendElement(aConsumer);</span>
<span class="lineNum">     404 </span><span class="lineCov">          1 : }</span>
<a name="405"><span class="lineNum">     405 </span>            : </a>
<span class="lineNum">     406 </span>            : void
<span class="lineNum">     407 </span><span class="lineCov">          1 : MediaStreamTrack::RemoveConsumer(MediaStreamTrackConsumer* aConsumer)</span>
<span class="lineNum">     408 </span>            : {
<span class="lineNum">     409 </span><span class="lineCov">          1 :   mConsumers.RemoveElement(aConsumer);</span>
<span class="lineNum">     410 </span><span class="lineCov">          1 : }</span>
<a name="411"><span class="lineNum">     411 </span>            : </a>
<span class="lineNum">     412 </span>            : already_AddRefed&lt;MediaStreamTrack&gt;
<span class="lineNum">     413 </span><span class="lineCov">          1 : MediaStreamTrack::Clone()</span>
<span class="lineNum">     414 </span>            : {
<span class="lineNum">     415 </span>            :   // MediaStreamTracks are currently governed by streams, so we need a dummy
<span class="lineNum">     416 </span>            :   // DOMMediaStream to own our track clone. The dummy will never see any
<span class="lineNum">     417 </span>            :   // dynamically created tracks (no input stream) so no need for a SourceGetter.
<span class="lineNum">     418 </span>            :   RefPtr&lt;DOMMediaStream&gt; newStream =
<span class="lineNum">     419 </span><span class="lineCov">          1 :     new DOMMediaStream(mOwningStream-&gt;GetParentObject(), nullptr);</span>
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineCov">          1 :   MediaStreamGraph* graph = Graph();</span>
<span class="lineNum">     422 </span><span class="lineCov">          1 :   newStream-&gt;InitOwnedStreamCommon(graph);</span>
<span class="lineNum">     423 </span><span class="lineCov">          1 :   newStream-&gt;InitPlaybackStreamCommon(graph);</span>
<span class="lineNum">     424 </span>            : 
<span class="lineNum">     425 </span><span class="lineCov">          1 :   return newStream-&gt;CloneDOMTrack(*this, mTrackID);</span>
<span class="lineNum">     426 </span>            : }
<a name="427"><span class="lineNum">     427 </span>            : </a>
<span class="lineNum">     428 </span>            : void
<span class="lineNum">     429 </span><span class="lineCov">          1 : MediaStreamTrack::SetReadyState(MediaStreamTrackState aState)</span>
<span class="lineNum">     430 </span>            : {
<span class="lineNum">     431 </span>            :   MOZ_ASSERT(!(mReadyState == MediaStreamTrackState::Ended &amp;&amp;
<span class="lineNum">     432 </span>            :                aState == MediaStreamTrackState::Live),
<span class="lineNum">     433 </span>            :              &quot;We don't support overriding the ready state from ended to live&quot;);
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span><span class="lineCov">          1 :   if (mReadyState == MediaStreamTrackState::Live &amp;&amp;</span>
<span class="lineNum">     436 </span><span class="lineCov">          1 :       aState == MediaStreamTrackState::Ended &amp;&amp;</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :       mSource) {</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :     mSource-&gt;UnregisterSink(this);</span>
<span class="lineNum">     439 </span>            :   }
<span class="lineNum">     440 </span>            : 
<span class="lineNum">     441 </span><span class="lineCov">          1 :   mReadyState = aState;</span>
<span class="lineNum">     442 </span><span class="lineCov">          1 : }</span>
<a name="443"><span class="lineNum">     443 </span>            : </a>
<span class="lineNum">     444 </span>            : void
<span class="lineNum">     445 </span><span class="lineCov">          1 : MediaStreamTrack::OverrideEnded()</span>
<span class="lineNum">     446 </span>            : {
<span class="lineNum">     447 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     448 </span>            : 
<span class="lineNum">     449 </span><span class="lineCov">          1 :   if (Ended()) {</span>
<span class="lineNum">     450 </span>            :     return;
<span class="lineNum">     451 </span>            :   }
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span><span class="lineCov">          1 :   LOG(LogLevel::Info, (&quot;MediaStreamTrack %p ended&quot;, this));</span>
<span class="lineNum">     454 </span>            : 
<span class="lineNum">     455 </span><span class="lineCov">          1 :   if (!mSource) {</span>
<span class="lineNum">     456 </span>            :     MOZ_ASSERT(false);
<span class="lineNum">     457 </span>            :     return;
<span class="lineNum">     458 </span>            :   }
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span><span class="lineCov">          1 :   mSource-&gt;UnregisterSink(this);</span>
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span><span class="lineCov">          1 :   mReadyState = MediaStreamTrackState::Ended;</span>
<span class="lineNum">     463 </span>            : 
<span class="lineNum">     464 </span><span class="lineCov">          1 :   NotifyEnded();</span>
<span class="lineNum">     465 </span>            : 
<span class="lineNum">     466 </span><span class="lineCov">          1 :   DispatchTrustedEvent(NS_LITERAL_STRING(&quot;ended&quot;));</span>
<span class="lineNum">     467 </span>            : }
<a name="468"><span class="lineNum">     468 </span>            : </a>
<span class="lineNum">     469 </span>            : DOMMediaStream*
<span class="lineNum">     470 </span><span class="lineCov">          1 : MediaStreamTrack::GetInputDOMStream()</span>
<span class="lineNum">     471 </span>            : {
<span class="lineNum">     472 </span>            :   MediaStreamTrack* originalTrack =
<span class="lineNum">     473 </span><span class="lineCov">          1 :     mOriginalTrack ? mOriginalTrack.get() : this;</span>
<span class="lineNum">     474 </span><span class="lineCov">          1 :   MOZ_RELEASE_ASSERT(originalTrack-&gt;mOwningStream);</span>
<span class="lineNum">     475 </span><span class="lineCov">          1 :   return originalTrack-&gt;mOwningStream;</span>
<span class="lineNum">     476 </span>            : }
<a name="477"><span class="lineNum">     477 </span>            : </a>
<span class="lineNum">     478 </span>            : MediaStream*
<span class="lineNum">     479 </span><span class="lineCov">          1 : MediaStreamTrack::GetInputStream()</span>
<span class="lineNum">     480 </span>            : {
<span class="lineNum">     481 </span><span class="lineCov">          1 :   DOMMediaStream* inputDOMStream = GetInputDOMStream();</span>
<span class="lineNum">     482 </span><span class="lineCov">          1 :   MOZ_RELEASE_ASSERT(inputDOMStream-&gt;GetInputStream());</span>
<span class="lineNum">     483 </span><span class="lineCov">          1 :   return inputDOMStream-&gt;GetInputStream();</span>
<span class="lineNum">     484 </span>            : }
<a name="485"><span class="lineNum">     485 </span>            : </a>
<span class="lineNum">     486 </span>            : ProcessedMediaStream*
<span class="lineNum">     487 </span><span class="lineCov">          1 : MediaStreamTrack::GetOwnedStream()</span>
<span class="lineNum">     488 </span>            : {
<span class="lineNum">     489 </span><span class="lineCov">          1 :   if (!mOwningStream)</span>
<span class="lineNum">     490 </span>            :   {
<span class="lineNum">     491 </span>            :     return nullptr;
<span class="lineNum">     492 </span>            :   }
<span class="lineNum">     493 </span>            : 
<span class="lineNum">     494 </span><span class="lineCov">          1 :   return mOwningStream-&gt;GetOwnedStream();</span>
<span class="lineNum">     495 </span>            : }
<a name="496"><span class="lineNum">     496 </span>            : </a>
<span class="lineNum">     497 </span>            : void
<span class="lineNum">     498 </span><span class="lineCov">          1 : MediaStreamTrack::AddListener(MediaStreamTrackListener* aListener)</span>
<span class="lineNum">     499 </span>            : {
<span class="lineNum">     500 </span><span class="lineCov">          1 :   LOG(LogLevel::Debug, (&quot;MediaStreamTrack %p adding listener %p&quot;,</span>
<span class="lineNum">     501 </span>            :                         this, aListener));
<span class="lineNum">     502 </span>            :   MOZ_ASSERT(GetOwnedStream());
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span><span class="lineCov">          1 :   GetOwnedStream()-&gt;AddTrackListener(aListener, mTrackID);</span>
<span class="lineNum">     505 </span><span class="lineCov">          1 :   mTrackListeners.AppendElement(aListener);</span>
<span class="lineNum">     506 </span><span class="lineCov">          1 : }</span>
<a name="507"><span class="lineNum">     507 </span>            : </a>
<span class="lineNum">     508 </span>            : void
<span class="lineNum">     509 </span><span class="lineCov">          1 : MediaStreamTrack::RemoveListener(MediaStreamTrackListener* aListener)</span>
<span class="lineNum">     510 </span>            : {
<span class="lineNum">     511 </span><span class="lineCov">          1 :   LOG(LogLevel::Debug, (&quot;MediaStreamTrack %p removing listener %p&quot;,</span>
<span class="lineNum">     512 </span>            :                         this, aListener));
<span class="lineNum">     513 </span>            : 
<span class="lineNum">     514 </span><span class="lineCov">          1 :   if (GetOwnedStream()) {</span>
<span class="lineNum">     515 </span><span class="lineCov">          1 :     GetOwnedStream()-&gt;RemoveTrackListener(aListener, mTrackID);</span>
<span class="lineNum">     516 </span><span class="lineCov">          1 :     mTrackListeners.RemoveElement(aListener);</span>
<span class="lineNum">     517 </span>            :   }
<span class="lineNum">     518 </span><span class="lineCov">          1 : }</span>
<a name="519"><span class="lineNum">     519 </span>            : </a>
<span class="lineNum">     520 </span>            : void
<span class="lineNum">     521 </span><span class="lineCov">          1 : MediaStreamTrack::AddDirectListener(DirectMediaStreamTrackListener *aListener)</span>
<span class="lineNum">     522 </span>            : {
<span class="lineNum">     523 </span><span class="lineCov">          1 :   LOG(LogLevel::Debug, (&quot;MediaStreamTrack %p (%s) adding direct listener %p to &quot;</span>
<span class="lineNum">     524 </span>            :                         &quot;stream %p, track %d&quot;,
<span class="lineNum">     525 </span>            :                         this, AsAudioStreamTrack() ? &quot;audio&quot; : &quot;video&quot;,
<span class="lineNum">     526 </span>            :                         aListener, GetOwnedStream(), mTrackID));
<span class="lineNum">     527 </span>            :   MOZ_ASSERT(GetOwnedStream());
<span class="lineNum">     528 </span>            : 
<span class="lineNum">     529 </span><span class="lineCov">          1 :   GetOwnedStream()-&gt;AddDirectTrackListener(aListener, mTrackID);</span>
<span class="lineNum">     530 </span><span class="lineCov">          1 :   mDirectTrackListeners.AppendElement(aListener);</span>
<span class="lineNum">     531 </span><span class="lineCov">          1 : }</span>
<a name="532"><span class="lineNum">     532 </span>            : </a>
<span class="lineNum">     533 </span>            : void
<span class="lineNum">     534 </span><span class="lineCov">          1 : MediaStreamTrack::RemoveDirectListener(DirectMediaStreamTrackListener *aListener)</span>
<span class="lineNum">     535 </span>            : {
<span class="lineNum">     536 </span><span class="lineCov">          1 :   LOG(LogLevel::Debug, (&quot;MediaStreamTrack %p removing direct listener %p from stream %p&quot;,</span>
<span class="lineNum">     537 </span>            :                         this, aListener, GetOwnedStream()));
<span class="lineNum">     538 </span>            : 
<span class="lineNum">     539 </span><span class="lineCov">          1 :   if (GetOwnedStream()) {</span>
<span class="lineNum">     540 </span><span class="lineCov">          1 :     GetOwnedStream()-&gt;RemoveDirectTrackListener(aListener, mTrackID);</span>
<span class="lineNum">     541 </span><span class="lineCov">          1 :     mDirectTrackListeners.RemoveElement(aListener);</span>
<span class="lineNum">     542 </span>            :   }
<span class="lineNum">     543 </span><span class="lineCov">          1 : }</span>
<a name="544"><span class="lineNum">     544 </span>            : </a>
<span class="lineNum">     545 </span>            : already_AddRefed&lt;MediaInputPort&gt;
<span class="lineNum">     546 </span><span class="lineCov">          1 : MediaStreamTrack::ForwardTrackContentsTo(ProcessedMediaStream* aStream,</span>
<span class="lineNum">     547 </span>            :                                          TrackID aDestinationTrackID)
<span class="lineNum">     548 </span>            : {
<span class="lineNum">     549 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     550 </span><span class="lineCov">          1 :   MOZ_RELEASE_ASSERT(aStream);</span>
<span class="lineNum">     551 </span>            :   RefPtr&lt;MediaInputPort&gt; port =
<span class="lineNum">     552 </span><span class="lineCov">          1 :     aStream-&gt;AllocateInputPort(GetOwnedStream(), mTrackID, aDestinationTrackID);</span>
<span class="lineNum">     553 </span><span class="lineCov">          1 :   return port.forget();</span>
<span class="lineNum">     554 </span>            : }
<a name="555"><span class="lineNum">     555 </span>            : </a>
<span class="lineNum">     556 </span>            : bool
<span class="lineNum">     557 </span><span class="lineCov">          1 : MediaStreamTrack::IsForwardedThrough(MediaInputPort* aPort)</span>
<span class="lineNum">     558 </span>            : {
<span class="lineNum">     559 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     560 </span>            :   MOZ_ASSERT(aPort);
<span class="lineNum">     561 </span><span class="lineCov">          1 :   if (!aPort) {</span>
<span class="lineNum">     562 </span>            :     return false;
<span class="lineNum">     563 </span>            :   }
<span class="lineNum">     564 </span><span class="lineCov">          1 :   return aPort-&gt;GetSource() == GetOwnedStream() &amp;&amp;</span>
<span class="lineNum">     565 </span><span class="lineCov">          1 :          aPort-&gt;PassTrackThrough(mTrackID);</span>
<span class="lineNum">     566 </span>            : }
<span class="lineNum">     567 </span>            : 
<span class="lineNum">     568 </span>            : } // namespace dom
<span class="lineNum">     569 </span>            : } // namespace mozilla
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
