<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - media/webrtc/trunk/webrtc/video/vie_channel.cc</title>
  <link rel="stylesheet" type="text/css" href="../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../index.html">top level</a> - <a href="index.html">media/webrtc/trunk/webrtc/video</a> - vie_channel.cc<span style="font-size: 80%;"> (source / <a href="vie_channel.cc.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">629</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21 12:59:10</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">103</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *  Copyright (c) 2012 The WebRTC project authors. All Rights Reserved.
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *  Use of this source code is governed by a BSD-style license
<span class="lineNum">       5 </span>            :  *  that can be found in the LICENSE file in the root of the source
<span class="lineNum">       6 </span>            :  *  tree. An additional intellectual property rights grant can be found
<span class="lineNum">       7 </span>            :  *  in the file PATENTS.  All contributing project authors may
<span class="lineNum">       8 </span>            :  *  be found in the AUTHORS file in the root of the source tree.
<span class="lineNum">       9 </span>            :  */
<span class="lineNum">      10 </span>            : 
<span class="lineNum">      11 </span>            : #include &quot;webrtc/video/vie_channel.h&quot;
<span class="lineNum">      12 </span>            : 
<span class="lineNum">      13 </span>            : #include &lt;algorithm&gt;
<span class="lineNum">      14 </span>            : #include &lt;map&gt;
<span class="lineNum">      15 </span>            : #include &lt;vector&gt;
<span class="lineNum">      16 </span>            : 
<span class="lineNum">      17 </span>            : #include &quot;webrtc/base/checks.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;webrtc/base/logging.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;webrtc/base/platform_thread.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;webrtc/common.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;webrtc/common_video/include/incoming_video_stream.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;webrtc/common_video/libyuv/include/webrtc_libyuv.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;webrtc/frame_callback.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;webrtc/modules/pacing/paced_sender.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;webrtc/modules/pacing/packet_router.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;webrtc/modules/rtp_rtcp/include/rtp_receiver.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;webrtc/modules/rtp_rtcp/include/rtp_rtcp.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;webrtc/modules/utility/include/process_thread.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;webrtc/modules/video_coding/include/video_coding.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;webrtc/modules/video_processing/include/video_processing.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;webrtc/modules/video_render/video_render_defines.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;webrtc/system_wrappers/include/critical_section_wrapper.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;webrtc/system_wrappers/include/metrics.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;webrtc/video/call_stats.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;webrtc/video/payload_router.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;webrtc/video/receive_statistics_proxy.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;webrtc/video/report_block_stats.h&quot;
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            : namespace webrtc {
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : const int kMaxDecodeWaitTimeMs = 50;
<span class="lineNum">      42 </span>            : static const int kMaxTargetDelayMs = 10000;
<span class="lineNum">      43 </span>            : const int kMinSendSidePacketHistorySize = 600;
<span class="lineNum">      44 </span>            : const int kMaxPacketAgeToNack = 450;
<span class="lineNum">      45 </span>            : const int kMaxNackListSize = 250;
<span class="lineNum">      46 </span>            : 
<span class="lineNum">      47 </span>            : // Helper class receiving statistics callbacks.
<span class="lineNum">      48 </span>            : class ChannelStatsObserver : public CallStatsObserver {
<a name="49"><span class="lineNum">      49 </span>            :  public:</a>
<span class="lineNum">      50 </span><span class="lineNoCov">          0 :   explicit ChannelStatsObserver(ViEChannel* owner) : owner_(owner) {}</span>
<span class="lineNum">      51 </span><span class="lineNoCov">          0 :   virtual ~ChannelStatsObserver() {}</span>
<a name="52"><span class="lineNum">      52 </span>            : </a>
<span class="lineNum">      53 </span>            :   // Implements StatsObserver.
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :   virtual void OnRttUpdate(int64_t avg_rtt_ms, int64_t max_rtt_ms) {</span>
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :     owner_-&gt;OnRttUpdate(avg_rtt_ms, max_rtt_ms);</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span>            :  private:
<span class="lineNum">      59 </span>            :   ViEChannel* const owner_;
<span class="lineNum">      60 </span>            : };
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span>            : class ViEChannelProtectionCallback : public VCMProtectionCallback {
<a name="63"><span class="lineNum">      63 </span>            :  public:</a>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :   explicit ViEChannelProtectionCallback(ViEChannel* owner) : owner_(owner) {}</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :   ~ViEChannelProtectionCallback() {}</span>
<a name="66"><span class="lineNum">      66 </span>            : </a>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :   int ProtectionRequest(</span>
<span class="lineNum">      69 </span>            :       const FecProtectionParams* delta_fec_params,
<span class="lineNum">      70 </span>            :       const FecProtectionParams* key_fec_params,
<span class="lineNum">      71 </span>            :       uint32_t* sent_video_rate_bps,
<span class="lineNum">      72 </span>            :       uint32_t* sent_nack_rate_bps,
<span class="lineNum">      73 </span>            :       uint32_t* sent_fec_rate_bps) override {
<span class="lineNum">      74 </span>            :     return owner_-&gt;ProtectionRequest(delta_fec_params, key_fec_params,
<span class="lineNum">      75 </span>            :                                      sent_video_rate_bps, sent_nack_rate_bps,
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :                                      sent_fec_rate_bps);</span>
<span class="lineNum">      77 </span>            :   }
<span class="lineNum">      78 </span>            :  private:
<span class="lineNum">      79 </span>            :   ViEChannel* owner_;
<a name="80"><span class="lineNum">      80 </span>            : };</a>
<span class="lineNum">      81 </span>            : 
<span class="lineNum">      82 </span><span class="lineNoCov">          0 : ViEChannel::ViEChannel(uint32_t number_of_cores,</span>
<span class="lineNum">      83 </span>            :                        Transport* transport,
<span class="lineNum">      84 </span>            :                        ProcessThread* module_process_thread,
<span class="lineNum">      85 </span>            :                        RtcpIntraFrameObserver* intra_frame_observer,
<span class="lineNum">      86 </span>            :                        RtcpBandwidthObserver* bandwidth_observer,
<span class="lineNum">      87 </span>            :                        TransportFeedbackObserver* transport_feedback_observer,
<span class="lineNum">      88 </span>            :                        RemoteBitrateEstimator* remote_bitrate_estimator,
<span class="lineNum">      89 </span>            :                        RtcpRttStats* rtt_stats,
<span class="lineNum">      90 </span>            :                        PacedSender* paced_sender,
<span class="lineNum">      91 </span>            :                        PacketRouter* packet_router,
<span class="lineNum">      92 </span>            :                        size_t max_rtp_streams,
<span class="lineNum">      93 </span>            :                        bool sender)
<span class="lineNum">      94 </span>            :     : number_of_cores_(number_of_cores),
<span class="lineNum">      95 </span>            :       sender_(sender),
<span class="lineNum">      96 </span>            :       module_process_thread_(module_process_thread),
<span class="lineNum">      97 </span>            :       crit_(CriticalSectionWrapper::CreateCriticalSection()),
<span class="lineNum">      98 </span>            :       send_payload_router_(new PayloadRouter()),
<span class="lineNum">      99 </span>            :       vcm_protection_callback_(new ViEChannelProtectionCallback(this)),
<span class="lineNum">     100 </span>            :       vcm_(VideoCodingModule::Create(Clock::GetRealTimeClock(),
<span class="lineNum">     101 </span>            :                                      nullptr,
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :                                      nullptr)),</span>
<span class="lineNum">     103 </span>            :       vie_receiver_(vcm_, remote_bitrate_estimator, this),
<span class="lineNum">     104 </span>            :       vie_sync_(vcm_),
<span class="lineNum">     105 </span>            :       stats_observer_(new ChannelStatsObserver(this)),
<span class="lineNum">     106 </span>            :       receive_stats_callback_(nullptr),
<span class="lineNum">     107 </span>            :       incoming_video_stream_(nullptr),
<span class="lineNum">     108 </span>            :       intra_frame_observer_(intra_frame_observer),
<span class="lineNum">     109 </span>            :       rtt_stats_(rtt_stats),
<span class="lineNum">     110 </span>            :       paced_sender_(paced_sender),
<span class="lineNum">     111 </span>            :       packet_router_(packet_router),
<span class="lineNum">     112 </span>            :       bandwidth_observer_(bandwidth_observer),
<span class="lineNum">     113 </span>            :       transport_feedback_observer_(transport_feedback_observer),
<span class="lineNum">     114 </span>            :       decode_thread_(ChannelDecodeThreadFunction, this, &quot;DecodingThread&quot;),
<span class="lineNum">     115 </span>            :       nack_history_size_sender_(kMinSendSidePacketHistorySize),
<span class="lineNum">     116 </span>            :       max_nack_reordering_threshold_(kMaxPacketAgeToNack),
<span class="lineNum">     117 </span>            :       pre_render_callback_(NULL),
<span class="lineNum">     118 </span>            :       report_block_stats_sender_(new ReportBlockStats()),
<span class="lineNum">     119 </span>            :       time_of_first_rtt_ms_(-1),
<span class="lineNum">     120 </span>            :       rtt_sum_ms_(0),
<span class="lineNum">     121 </span>            :       last_rtt_ms_(0),
<span class="lineNum">     122 </span>            :       num_rtts_(0),
<span class="lineNum">     123 </span>            :       rtp_rtcp_modules_(
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :           CreateRtpRtcpModules(!sender,</span>
<span class="lineNum">     125 </span>            :                                vie_receiver_.GetReceiveStatistics(),
<span class="lineNum">     126 </span>            :                                transport,
<span class="lineNum">     127 </span>            :                                intra_frame_observer_,
<span class="lineNum">     128 </span>            :                                bandwidth_observer_.get(),
<span class="lineNum">     129 </span>            :                                transport_feedback_observer_,
<span class="lineNum">     130 </span>            :                                rtt_stats_,
<span class="lineNum">     131 </span>            :                                &amp;rtcp_packet_type_counter_observer_,
<span class="lineNum">     132 </span>            :                                remote_bitrate_estimator,
<span class="lineNum">     133 </span>            :                                paced_sender_,
<span class="lineNum">     134 </span>            :                                packet_router_,
<span class="lineNum">     135 </span>            :                                &amp;send_bitrate_observer_,
<span class="lineNum">     136 </span>            :                                &amp;send_frame_count_observer_,
<span class="lineNum">     137 </span>            :                                &amp;send_side_delay_observer_,
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :                                max_rtp_streams)),</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :       num_active_rtp_rtcp_modules_(1) {</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :   vie_receiver_.SetRtpRtcpModule(rtp_rtcp_modules_[0]);</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :   vcm_-&gt;SetNackSettings(kMaxNackListSize, max_nack_reordering_threshold_, 0);</span>
<a name="142"><span class="lineNum">     142 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     143 </span>            : 
<span class="lineNum">     144 </span><span class="lineNoCov">          0 : int32_t ViEChannel::Init() {</span>
<span class="lineNum">     145 </span>            :   static const int kDefaultRenderDelayMs = 10;
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :   module_process_thread_-&gt;RegisterModule(vie_receiver_.GetReceiveStatistics());</span>
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span>            :   // RTP/RTCP initialization.
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :   module_process_thread_-&gt;RegisterModule(rtp_rtcp_modules_[0]);</span>
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span><span class="lineNoCov">          0 :   rtp_rtcp_modules_[0]-&gt;SetKeyFrameRequestMethod(kKeyFrameReqPliRtcp);</span>
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :   if (paced_sender_) {</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :     for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :       rtp_rtcp-&gt;SetStorePacketsStatus(true, nack_history_size_sender_);</span>
<span class="lineNum">     155 </span>            :   }
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :   packet_router_-&gt;AddRtpModule(rtp_rtcp_modules_[0]);</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :   if (sender_) {</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :     std::list&lt;RtpRtcp*&gt; send_rtp_modules(1, rtp_rtcp_modules_[0]);</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :     send_payload_router_-&gt;SetSendingRtpModules(send_rtp_modules);</span>
<span class="lineNum">     160 </span>            :     RTC_DCHECK(!send_payload_router_-&gt;active());
<span class="lineNum">     161 </span>            :   }
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :   if (vcm_-&gt;RegisterReceiveCallback(this) != 0) {</span>
<span class="lineNum">     163 </span>            :     return -1;
<span class="lineNum">     164 </span>            :   }
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :   vcm_-&gt;RegisterFrameTypeCallback(this);</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :         vcm_-&gt;RegisterReceiveStateCallback(this); //MOZ addition for RID</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :   vcm_-&gt;RegisterReceiveStatisticsCallback(this);</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :   vcm_-&gt;RegisterDecoderTimingCallback(this);</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :   vcm_-&gt;SetRenderDelay(kDefaultRenderDelayMs);</span>
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :   module_process_thread_-&gt;RegisterModule(vcm_);</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :   module_process_thread_-&gt;RegisterModule(&amp;vie_sync_);</span>
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="175"><span class="lineNum">     175 </span>            : }</a>
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span><span class="lineNoCov">          0 : ViEChannel::~ViEChannel() {</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :   UpdateHistograms();</span>
<span class="lineNum">     179 </span>            :   // Make sure we don't get more callbacks from the RTP module.
<span class="lineNum">     180 </span>            :   module_process_thread_-&gt;DeRegisterModule(
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :       vie_receiver_.GetReceiveStatistics());</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :   module_process_thread_-&gt;DeRegisterModule(vcm_);</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :   module_process_thread_-&gt;DeRegisterModule(&amp;vie_sync_);</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :   send_payload_router_-&gt;SetSendingRtpModules(std::list&lt;RtpRtcp*&gt;());</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :   for (size_t i = 0; i &lt; num_active_rtp_rtcp_modules_; ++i)</span>
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :     packet_router_-&gt;RemoveRtpModule(rtp_rtcp_modules_[i]);</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :     module_process_thread_-&gt;DeRegisterModule(rtp_rtcp);</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :     delete rtp_rtcp;</span>
<span class="lineNum">     190 </span>            :   }
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :   if (!sender_)</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :     StopDecodeThread();</span>
<span class="lineNum">     193 </span>            :   // Release modules.
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :   VideoCodingModule::Destroy(vcm_);</span>
<a name="195"><span class="lineNum">     195 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     196 </span>            : 
<span class="lineNum">     197 </span><span class="lineNoCov">          0 : void ViEChannel::UpdateHistograms() {</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :   int64_t now = Clock::GetRealTimeClock()-&gt;TimeInMilliseconds();</span>
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span>            :   {
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :     CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :     int64_t elapsed_sec = (now - time_of_first_rtt_ms_) / 1000;</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :     if (time_of_first_rtt_ms_ != -1 &amp;&amp; num_rtts_ &gt; 0 &amp;&amp;</span>
<span class="lineNum">     204 </span>            :         elapsed_sec &gt; metrics::kMinRunTimeInSeconds) {
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :       int64_t avg_rtt_ms = (rtt_sum_ms_ + num_rtts_ / 2) / num_rtts_;</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     207 </span>            :           &quot;WebRTC.Video.AverageRoundTripTimeInMilliseconds&quot;, avg_rtt_ms);
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     209 </span>            :   }
<span class="lineNum">     210 </span>            : 
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :   if (sender_) {</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :     RtcpPacketTypeCounter rtcp_counter;</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :     GetSendRtcpPacketTypeCounter(&amp;rtcp_counter);</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :     int64_t elapsed_sec = rtcp_counter.TimeSinceFirstPacketInMs(now) / 1000;</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :     if (elapsed_sec &gt; metrics::kMinRunTimeInSeconds) {</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     217 </span>            :           &quot;WebRTC.Video.NackPacketsReceivedPerMinute&quot;,
<span class="lineNum">     218 </span>            :           rtcp_counter.nack_packets * 60 / elapsed_sec);
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     220 </span>            :           &quot;WebRTC.Video.FirPacketsReceivedPerMinute&quot;,
<span class="lineNum">     221 </span>            :           rtcp_counter.fir_packets * 60 / elapsed_sec);
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     223 </span>            :           &quot;WebRTC.Video.PliPacketsReceivedPerMinute&quot;,
<span class="lineNum">     224 </span>            :           rtcp_counter.pli_packets * 60 / elapsed_sec);
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :       if (rtcp_counter.nack_requests &gt; 0) {</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :         RTC_HISTOGRAM_PERCENTAGE_SPARSE(</span>
<span class="lineNum">     227 </span>            :             &quot;WebRTC.Video.UniqueNackRequestsReceivedInPercent&quot;,
<span class="lineNum">     228 </span>            :             rtcp_counter.UniqueNackRequestsInPercent());
<span class="lineNum">     229 </span>            :       }
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :       int fraction_lost = report_block_stats_sender_-&gt;FractionLostInPercent();</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :       if (fraction_lost != -1) {</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :         RTC_HISTOGRAM_PERCENTAGE_SPARSE(&quot;WebRTC.Video.SentPacketsLostInPercent&quot;,</span>
<span class="lineNum">     233 </span>            :                                         fraction_lost);
<span class="lineNum">     234 </span>            :       }
<span class="lineNum">     235 </span>            :     }
<span class="lineNum">     236 </span>            : 
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :     StreamDataCounters rtp;</span>
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :     StreamDataCounters rtx;</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :     GetSendStreamDataCounters(&amp;rtp, &amp;rtx);</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :     StreamDataCounters rtp_rtx = rtp;</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :     rtp_rtx.Add(rtx);</span>
<span class="lineNum">     242 </span>            :     elapsed_sec = rtp_rtx.TimeSinceFirstPacketInMs(
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :                       Clock::GetRealTimeClock()-&gt;TimeInMilliseconds()) /</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :                   1000;</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :     if (elapsed_sec &gt; metrics::kMinRunTimeInSeconds) {</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_100000(</span>
<span class="lineNum">     247 </span>            :           &quot;WebRTC.Video.BitrateSentInKbps&quot;,
<span class="lineNum">     248 </span>            :           static_cast&lt;int&gt;(rtp_rtx.transmitted.TotalBytes() * 8 / elapsed_sec /
<span class="lineNum">     249 </span>            :                            1000));
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     251 </span>            :           &quot;WebRTC.Video.MediaBitrateSentInKbps&quot;,
<span class="lineNum">     252 </span>            :           static_cast&lt;int&gt;(rtp.MediaPayloadBytes() * 8 / elapsed_sec / 1000));
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     254 </span>            :           &quot;WebRTC.Video.PaddingBitrateSentInKbps&quot;,
<span class="lineNum">     255 </span>            :           static_cast&lt;int&gt;(rtp_rtx.transmitted.padding_bytes * 8 / elapsed_sec /
<span class="lineNum">     256 </span>            :                            1000));
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     258 </span>            :           &quot;WebRTC.Video.RetransmittedBitrateSentInKbps&quot;,
<span class="lineNum">     259 </span>            :           static_cast&lt;int&gt;(rtp_rtx.retransmitted.TotalBytes() * 8 /
<span class="lineNum">     260 </span>            :                            elapsed_sec / 1000));
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :       if (rtp_rtcp_modules_[0]-&gt;RtxSendStatus() != kRtxOff) {</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :         RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     263 </span>            :             &quot;WebRTC.Video.RtxBitrateSentInKbps&quot;,
<span class="lineNum">     264 </span>            :             static_cast&lt;int&gt;(rtx.transmitted.TotalBytes() * 8 / elapsed_sec /
<span class="lineNum">     265 </span>            :                              1000));
<span class="lineNum">     266 </span>            :       }
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :       bool fec_enabled = false;</span>
<span class="lineNum">     268 </span>            :       uint8_t pltype_red;
<span class="lineNum">     269 </span>            :       uint8_t pltype_fec;
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :       rtp_rtcp_modules_[0]-&gt;GenericFECStatus(&amp;fec_enabled, &amp;pltype_red,</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :                                              &amp;pltype_fec);</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :       if (fec_enabled) {</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :         RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     274 </span>            :             &quot;WebRTC.Video.FecBitrateSentInKbps&quot;,
<span class="lineNum">     275 </span>            :             static_cast&lt;int&gt;(rtp_rtx.fec.TotalBytes() * 8 / elapsed_sec /
<span class="lineNum">     276 </span>            :                              1000));
<span class="lineNum">     277 </span>            :       }
<span class="lineNum">     278 </span>            :     }
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :   } else if (vie_receiver_.GetRemoteSsrc() &gt; 0) {</span>
<span class="lineNum">     280 </span>            :     // Get receive stats if we are receiving packets, i.e. there is a remote
<span class="lineNum">     281 </span>            :     // ssrc.
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :     RtcpPacketTypeCounter rtcp_counter;</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :     GetReceiveRtcpPacketTypeCounter(&amp;rtcp_counter);</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     int64_t elapsed_sec = rtcp_counter.TimeSinceFirstPacketInMs(now) / 1000;</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :     if (elapsed_sec &gt; metrics::kMinRunTimeInSeconds) {</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     287 </span>            :           &quot;WebRTC.Video.NackPacketsSentPerMinute&quot;,
<span class="lineNum">     288 </span>            :           rtcp_counter.nack_packets * 60 / elapsed_sec);
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     290 </span>            :           &quot;WebRTC.Video.FirPacketsSentPerMinute&quot;,
<span class="lineNum">     291 </span>            :           rtcp_counter.fir_packets * 60 / elapsed_sec);
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     293 </span>            :           &quot;WebRTC.Video.PliPacketsSentPerMinute&quot;,
<span class="lineNum">     294 </span>            :           rtcp_counter.pli_packets * 60 / elapsed_sec);
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :       if (rtcp_counter.nack_requests &gt; 0) {</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :         RTC_HISTOGRAM_PERCENTAGE_SPARSE(</span>
<span class="lineNum">     297 </span>            :             &quot;WebRTC.Video.UniqueNackRequestsSentInPercent&quot;,
<span class="lineNum">     298 </span>            :             rtcp_counter.UniqueNackRequestsInPercent());
<span class="lineNum">     299 </span>            :       }
<span class="lineNum">     300 </span>            :     }
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :     StreamDataCounters rtp;</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :     StreamDataCounters rtx;</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :     GetReceiveStreamDataCounters(&amp;rtp, &amp;rtx);</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :     StreamDataCounters rtp_rtx = rtp;</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :     rtp_rtx.Add(rtx);</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :     elapsed_sec = rtp_rtx.TimeSinceFirstPacketInMs(now) / 1000;</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :     if (elapsed_sec &gt; metrics::kMinRunTimeInSeconds) {</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     310 </span>            :           &quot;WebRTC.Video.BitrateReceivedInKbps&quot;,
<span class="lineNum">     311 </span>            :           static_cast&lt;int&gt;(rtp_rtx.transmitted.TotalBytes() * 8 / elapsed_sec /
<span class="lineNum">     312 </span>            :                            1000));
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     314 </span>            :           &quot;WebRTC.Video.MediaBitrateReceivedInKbps&quot;,
<span class="lineNum">     315 </span>            :           static_cast&lt;int&gt;(rtp.MediaPayloadBytes() * 8 / elapsed_sec / 1000));
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     317 </span>            :           &quot;WebRTC.Video.PaddingBitrateReceivedInKbps&quot;,
<span class="lineNum">     318 </span>            :           static_cast&lt;int&gt;(rtp_rtx.transmitted.padding_bytes * 8 / elapsed_sec /
<span class="lineNum">     319 </span>            :                            1000));
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :       RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     321 </span>            :           &quot;WebRTC.Video.RetransmittedBitrateReceivedInKbps&quot;,
<span class="lineNum">     322 </span>            :           static_cast&lt;int&gt;(rtp_rtx.retransmitted.TotalBytes() * 8 /
<span class="lineNum">     323 </span>            :                            elapsed_sec / 1000));
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :       uint32_t ssrc = 0;</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :       if (vie_receiver_.GetRtxSsrc(&amp;ssrc)) {</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :         RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     327 </span>            :             &quot;WebRTC.Video.RtxBitrateReceivedInKbps&quot;,
<span class="lineNum">     328 </span>            :             static_cast&lt;int&gt;(rtx.transmitted.TotalBytes() * 8 / elapsed_sec /
<span class="lineNum">     329 </span>            :                              1000));
<span class="lineNum">     330 </span>            :       }
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :       if (vie_receiver_.IsFecEnabled()) {</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :         RTC_HISTOGRAM_COUNTS_SPARSE_10000(</span>
<span class="lineNum">     333 </span>            :             &quot;WebRTC.Video.FecBitrateReceivedInKbps&quot;,
<span class="lineNum">     334 </span>            :             static_cast&lt;int&gt;(rtp_rtx.fec.TotalBytes() * 8 / elapsed_sec /
<span class="lineNum">     335 </span>            :                              1000));
<span class="lineNum">     336 </span>            :       }
<span class="lineNum">     337 </span>            :     }
<span class="lineNum">     338 </span>            :   }
<a name="339"><span class="lineNum">     339 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span><span class="lineNoCov">          0 : int32_t ViEChannel::SetSendCodec(const VideoCodec&amp; video_codec,</span>
<span class="lineNum">     342 </span>            :                                  bool new_stream) {
<span class="lineNum">     343 </span>            :   RTC_DCHECK(sender_);
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :   if (video_codec.codecType == kVideoCodecRED ||</span>
<span class="lineNum">     345 </span>            :       video_codec.codecType == kVideoCodecULPFEC) {
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :     LOG_F(LS_ERROR) &lt;&lt; &quot;Not a valid send codec &quot; &lt;&lt; video_codec.codecType;</span>
<span class="lineNum">     347 </span>            :     return -1;
<span class="lineNum">     348 </span>            :   }
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :   if (kMaxSimulcastStreams &lt; video_codec.numberOfSimulcastStreams) {</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :     LOG_F(LS_ERROR) &lt;&lt; &quot;Incorrect config &quot;</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :                     &lt;&lt; video_codec.numberOfSimulcastStreams;</span>
<span class="lineNum">     352 </span>            :     return -1;
<span class="lineNum">     353 </span>            :   }
<span class="lineNum">     354 </span>            :   // Update the RTP module with the settings.
<span class="lineNum">     355 </span>            :   // Stop and Start the RTP module -&gt; trigger new SSRC, if an SSRC hasn't been
<span class="lineNum">     356 </span>            :   // set explicitly.
<span class="lineNum">     357 </span>            :   // The first layer is always active, so the first module can be checked for
<span class="lineNum">     358 </span>            :   // sending status.
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :   bool is_sending = rtp_rtcp_modules_[0]-&gt;Sending();</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :   bool router_was_active = send_payload_router_-&gt;active();</span>
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :   send_payload_router_-&gt;set_active(false);</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :   send_payload_router_-&gt;SetSendingRtpModules(std::list&lt;RtpRtcp*&gt;());</span>
<span class="lineNum">     363 </span>            : 
<span class="lineNum">     364 </span>            :   std::vector&lt;RtpRtcp*&gt; registered_modules;
<span class="lineNum">     365 </span>            :   std::vector&lt;RtpRtcp*&gt; deregistered_modules;
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :   size_t num_active_modules = video_codec.numberOfSimulcastStreams &gt; 0</span>
<span class="lineNum">     367 </span>            :                                    ? video_codec.numberOfSimulcastStreams
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :                                    : 1;</span>
<span class="lineNum">     369 </span>            :   size_t num_prev_active_modules;
<span class="lineNum">     370 </span>            :   {
<span class="lineNum">     371 </span>            :     // Cache which modules are active so StartSend can know which ones to start.
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :     CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :     num_prev_active_modules = num_active_rtp_rtcp_modules_;</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :     num_active_rtp_rtcp_modules_ = num_active_modules;</span>
<span class="lineNum">     375 </span>            :   }
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :   for (size_t i = 0; i &lt; num_active_modules; ++i)</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :     registered_modules.push_back(rtp_rtcp_modules_[i]);</span>
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :   for (size_t i = num_active_modules; i &lt; rtp_rtcp_modules_.size(); ++i)</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :     deregistered_modules.push_back(rtp_rtcp_modules_[i]);</span>
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span>            :   // Disable inactive modules.
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : deregistered_modules) {</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetSendingStatus(false);</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetSendingMediaStatus(false);</span>
<span class="lineNum">     386 </span>            :   }
<span class="lineNum">     387 </span>            : 
<span class="lineNum">     388 </span>            :   // Configure active modules.
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : registered_modules) {</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;DeRegisterSendPayload(video_codec.plType);</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     if (rtp_rtcp-&gt;RegisterSendPayload(video_codec) != 0) {</span>
<span class="lineNum">     392 </span>            :       return -1;
<span class="lineNum">     393 </span>            :     }
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetSendingStatus(is_sending);</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetSendingMediaStatus(is_sending);</span>
<span class="lineNum">     396 </span>            :   }
<span class="lineNum">     397 </span>            : 
<span class="lineNum">     398 </span>            :   // |RegisterSimulcastRtpRtcpModules| resets all old weak pointers and old
<span class="lineNum">     399 </span>            :   // modules can be deleted after this step.
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :   vie_receiver_.RegisterRtpRtcpModules(registered_modules);</span>
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span>            :   // Update the packet and payload routers with the sending RtpRtcp modules.
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :   if (sender_) {</span>
<span class="lineNum">     404 </span>            :     std::list&lt;RtpRtcp*&gt; active_send_modules;
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :     for (RtpRtcp* rtp_rtcp : registered_modules)</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :       active_send_modules.push_back(rtp_rtcp);</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :     send_payload_router_-&gt;SetSendingRtpModules(active_send_modules);</span>
<span class="lineNum">     408 </span>            :   }
<span class="lineNum">     409 </span>            : 
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :   if (router_was_active)</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :     send_payload_router_-&gt;set_active(true);</span>
<span class="lineNum">     412 </span>            : 
<span class="lineNum">     413 </span>            :   // Deregister previously registered modules.
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :   for (size_t i = num_active_modules; i &lt; num_prev_active_modules; ++i) {</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :     module_process_thread_-&gt;DeRegisterModule(rtp_rtcp_modules_[i]);</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :     packet_router_-&gt;RemoveRtpModule(rtp_rtcp_modules_[i]);</span>
<span class="lineNum">     417 </span>            :   }
<span class="lineNum">     418 </span>            :   // Register new active modules.
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :   for (size_t i = num_prev_active_modules; i &lt; num_active_modules; ++i) {</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :     module_process_thread_-&gt;RegisterModule(rtp_rtcp_modules_[i]);</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :     packet_router_-&gt;AddRtpModule(rtp_rtcp_modules_[i]);</span>
<span class="lineNum">     422 </span>            :   }
<span class="lineNum">     423 </span>            :   return 0;
<a name="424"><span class="lineNum">     424 </span>            : }</a>
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span><span class="lineNoCov">          0 : int32_t ViEChannel::SetReceiveCodec(const VideoCodec&amp; video_codec) {</span>
<span class="lineNum">     427 </span>            :   RTC_DCHECK(!sender_);
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :   if (!vie_receiver_.SetReceiveCodec(video_codec)) {</span>
<span class="lineNum">     429 </span>            :     return -1;
<span class="lineNum">     430 </span>            :   }
<span class="lineNum">     431 </span>            : 
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :   if (video_codec.codecType != kVideoCodecRED &amp;&amp;</span>
<span class="lineNum">     433 </span>            :       video_codec.codecType != kVideoCodecULPFEC) {
<span class="lineNum">     434 </span>            :     // Register codec type with VCM, but do not register RED or ULPFEC.
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :     if (vcm_-&gt;RegisterReceiveCodec(&amp;video_codec, number_of_cores_, false) !=</span>
<span class="lineNum">     436 </span>            :         VCM_OK) {
<span class="lineNum">     437 </span>            :       return -1;
<span class="lineNum">     438 </span>            :     }
<span class="lineNum">     439 </span>            :   }
<span class="lineNum">     440 </span>            :   return 0;
<a name="441"><span class="lineNum">     441 </span>            : }</a>
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span><span class="lineNoCov">          0 : void ViEChannel::RegisterExternalDecoder(const uint8_t pl_type,</span>
<span class="lineNum">     444 </span>            :                                          VideoDecoder* decoder) {
<span class="lineNum">     445 </span>            :   RTC_DCHECK(!sender_);
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :   vcm_-&gt;RegisterExternalDecoder(decoder, pl_type);</span>
<a name="447"><span class="lineNum">     447 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     448 </span>            : 
<span class="lineNum">     449 </span><span class="lineNoCov">          0 : int32_t ViEChannel::ReceiveCodecStatistics(uint32_t* num_key_frames,</span>
<span class="lineNum">     450 </span>            :                                            uint32_t* num_delta_frames) {
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :   CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :   *num_key_frames = receive_frame_counts_.key_frames;</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :   *num_delta_frames = receive_frame_counts_.delta_frames;</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="455"><span class="lineNum">     455 </span>            : }</a>
<span class="lineNum">     456 </span>            : 
<span class="lineNum">     457 </span><span class="lineNoCov">          0 : uint32_t ViEChannel::DiscardedPackets() const {</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :   return vcm_-&gt;DiscardedPackets();</span>
<a name="459"><span class="lineNum">     459 </span>            : }</a>
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span><span class="lineNoCov">          0 : int ViEChannel::ReceiveDelay() const {</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :   return vcm_-&gt;Delay();</span>
<a name="463"><span class="lineNum">     463 </span>            : }</a>
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span><span class="lineNoCov">          0 : void ViEChannel::SetExpectedRenderDelay(int delay_ms) {</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :   vcm_-&gt;SetRenderDelay(delay_ms);</span>
<a name="467"><span class="lineNum">     467 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     468 </span>            : 
<span class="lineNum">     469 </span><span class="lineNoCov">          0 : void ViEChannel::SetRTCPMode(const RtcpMode rtcp_mode) {</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetRTCPStatus(rtcp_mode);</span>
<a name="472"><span class="lineNum">     472 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span><span class="lineNoCov">          0 : void ViEChannel::SetProtectionMode(bool enable_nack,</span>
<span class="lineNum">     475 </span>            :                                    bool enable_fec,
<span class="lineNum">     476 </span>            :                                    int payload_type_red,
<span class="lineNum">     477 </span>            :                                    int payload_type_fec) {
<span class="lineNum">     478 </span>            :   // Validate payload types.
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :   if (enable_fec) {</span>
<span class="lineNum">     480 </span>            :     RTC_DCHECK_GE(payload_type_red, 0);
<span class="lineNum">     481 </span>            :     RTC_DCHECK_GE(payload_type_fec, 0);
<span class="lineNum">     482 </span>            :     RTC_DCHECK_LE(payload_type_red, 127);
<span class="lineNum">     483 </span>            :     RTC_DCHECK_LE(payload_type_fec, 127);
<span class="lineNum">     484 </span>            :   } else {
<span class="lineNum">     485 </span>            :     RTC_DCHECK_EQ(payload_type_red, -1);
<span class="lineNum">     486 </span>            :     RTC_DCHECK_EQ(payload_type_fec, -1);
<span class="lineNum">     487 </span>            :     // Set to valid uint8_ts to be castable later without signed overflows.
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :     payload_type_red = 0;</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :     payload_type_fec = 0;</span>
<span class="lineNum">     490 </span>            :   }
<span class="lineNum">     491 </span>            : 
<span class="lineNum">     492 </span>            :   VCMVideoProtection protection_method;
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :   if (enable_nack) {</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :     protection_method = enable_fec ? kProtectionNackFEC : kProtectionNack;</span>
<span class="lineNum">     495 </span>            :   } else {
<span class="lineNum">     496 </span>            :     protection_method = kProtectionNone;
<span class="lineNum">     497 </span>            :   }
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :   vcm_-&gt;SetVideoProtection(protection_method, true);</span>
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span>            :   // Set NACK.
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :   ProcessNACKRequest(enable_nack);</span>
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span>            :   // Set FEC.
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     506 </span>            :     rtp_rtcp-&gt;SetGenericFECStatus(enable_fec,
<span class="lineNum">     507 </span>            :                                   static_cast&lt;uint8_t&gt;(payload_type_red),
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                                   static_cast&lt;uint8_t&gt;(payload_type_fec));</span>
<span class="lineNum">     509 </span>            :   }
<a name="510"><span class="lineNum">     510 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span><span class="lineNoCov">          0 : void ViEChannel::ProcessNACKRequest(const bool enable) {</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :   if (enable) {</span>
<span class="lineNum">     514 </span>            :     // Turn on NACK.
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :     if (rtp_rtcp_modules_[0]-&gt;RTCP() == RtcpMode::kOff)</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :     vie_receiver_.SetNackStatus(true, max_nack_reordering_threshold_);</span>
<span class="lineNum">     518 </span>            : 
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :     for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :       rtp_rtcp-&gt;SetStorePacketsStatus(true, nack_history_size_sender_);</span>
<span class="lineNum">     521 </span>            : 
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :     vcm_-&gt;RegisterPacketRequestCallback(this);</span>
<span class="lineNum">     523 </span>            :     // Don't introduce errors when NACK is enabled.
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :     vcm_-&gt;SetDecodeErrorMode(kNoErrors);</span>
<span class="lineNum">     525 </span>            :   } else {
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :     vcm_-&gt;RegisterPacketRequestCallback(NULL);</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :     if (paced_sender_ == nullptr) {</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :       for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :         rtp_rtcp-&gt;SetStorePacketsStatus(false, 0);</span>
<span class="lineNum">     530 </span>            :     }
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :     vie_receiver_.SetNackStatus(false, max_nack_reordering_threshold_);</span>
<span class="lineNum">     532 </span>            :     // When NACK is off, allow decoding with errors. Otherwise, the video
<span class="lineNum">     533 </span>            :     // will freeze, and will only recover with a complete key frame.
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :     vcm_-&gt;SetDecodeErrorMode(kWithErrors);</span>
<span class="lineNum">     535 </span>            :   }
<a name="536"><span class="lineNum">     536 </span>            : }</a>
<span class="lineNum">     537 </span>            : 
<span class="lineNum">     538 </span><span class="lineNoCov">          0 : bool ViEChannel::IsSendingFecEnabled() {</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :   bool fec_enabled = false;</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :   uint8_t pltype_red = 0;</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :   uint8_t pltype_fec = 0;</span>
<span class="lineNum">     542 </span>            : 
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;GenericFECStatus(&amp;fec_enabled, &amp;pltype_red, &amp;pltype_fec);</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :     if (fec_enabled)</span>
<span class="lineNum">     546 </span>            :       return true;
<span class="lineNum">     547 </span>            :   }
<span class="lineNum">     548 </span>            :   return false;
<a name="549"><span class="lineNum">     549 </span>            : }</a>
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span><span class="lineNoCov">          0 : int ViEChannel::SetSenderBufferingMode(int target_delay_ms) {</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :   if ((target_delay_ms &lt; 0) || (target_delay_ms &gt; kMaxTargetDelayMs)) {</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :     LOG(LS_ERROR) &lt;&lt; &quot;Invalid send buffer value.&quot;;</span>
<span class="lineNum">     554 </span>            :     return -1;
<span class="lineNum">     555 </span>            :   }
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :   if (target_delay_ms == 0) {</span>
<span class="lineNum">     557 </span>            :     // Real-time mode.
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :     nack_history_size_sender_ = kMinSendSidePacketHistorySize;</span>
<span class="lineNum">     559 </span>            :   } else {
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :     nack_history_size_sender_ = GetRequiredNackListSize(target_delay_ms);</span>
<span class="lineNum">     561 </span>            :     // Don't allow a number lower than the default value.
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :     if (nack_history_size_sender_ &lt; kMinSendSidePacketHistorySize) {</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :       nack_history_size_sender_ = kMinSendSidePacketHistorySize;</span>
<span class="lineNum">     564 </span>            :     }
<span class="lineNum">     565 </span>            :   }
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetStorePacketsStatus(true, nack_history_size_sender_);</span>
<span class="lineNum">     568 </span>            :   return 0;
<a name="569"><span class="lineNum">     569 </span>            : }</a>
<span class="lineNum">     570 </span>            : 
<span class="lineNum">     571 </span><span class="lineNoCov">          0 : int ViEChannel::GetRequiredNackListSize(int target_delay_ms) {</span>
<span class="lineNum">     572 </span>            :   // The max size of the nack list should be large enough to accommodate the
<span class="lineNum">     573 </span>            :   // the number of packets (frames) resulting from the increased delay.
<span class="lineNum">     574 </span>            :   // Roughly estimating for ~40 packets per frame @ 30fps.
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :   return target_delay_ms * 40 * 30 / 1000;</span>
<a name="576"><span class="lineNum">     576 </span>            : }</a>
<span class="lineNum">     577 </span>            : 
<span class="lineNum">     578 </span><span class="lineNoCov">          0 : int ViEChannel::SetSendTimestampOffsetStatus(bool enable, int id) {</span>
<span class="lineNum">     579 </span>            :   // Disable any previous registrations of this extension to avoid errors.
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     581 </span>            :     rtp_rtcp-&gt;DeregisterSendRtpHeaderExtension(
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :         kRtpExtensionTransmissionTimeOffset);</span>
<span class="lineNum">     583 </span>            :   }
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :   if (!enable)</span>
<span class="lineNum">     585 </span>            :     return 0;
<span class="lineNum">     586 </span>            :   // Enable the extension.
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :   int error = 0;</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     589 </span>            :     error |= rtp_rtcp-&gt;RegisterSendRtpHeaderExtension(
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :         kRtpExtensionTransmissionTimeOffset, id);</span>
<span class="lineNum">     591 </span>            :   }
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :   return error;</span>
<a name="593"><span class="lineNum">     593 </span>            : }</a>
<span class="lineNum">     594 </span>            : 
<span class="lineNum">     595 </span><span class="lineNoCov">          0 : int ViEChannel::SetReceiveTimestampOffsetStatus(bool enable, int id) {</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :   return vie_receiver_.SetReceiveTimestampOffsetStatus(enable, id) ? 0 : -1;</span>
<a name="597"><span class="lineNum">     597 </span>            : }</a>
<span class="lineNum">     598 </span>            : 
<span class="lineNum">     599 </span><span class="lineNoCov">          0 : int ViEChannel::SetSendAbsoluteSendTimeStatus(bool enable, int id) {</span>
<span class="lineNum">     600 </span>            :   // Disable any previous registrations of this extension to avoid errors.
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;DeregisterSendRtpHeaderExtension(kRtpExtensionAbsoluteSendTime);</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :   if (!enable)</span>
<span class="lineNum">     604 </span>            :     return 0;
<span class="lineNum">     605 </span>            :   // Enable the extension.
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :   int error = 0;</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     608 </span>            :     error |= rtp_rtcp-&gt;RegisterSendRtpHeaderExtension(
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :         kRtpExtensionAbsoluteSendTime, id);</span>
<span class="lineNum">     610 </span>            :   }
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :   return error;</span>
<a name="612"><span class="lineNum">     612 </span>            : }</a>
<span class="lineNum">     613 </span>            : 
<span class="lineNum">     614 </span><span class="lineNoCov">          0 : int ViEChannel::SetReceiveAbsoluteSendTimeStatus(bool enable, int id) {</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :   return vie_receiver_.SetReceiveAbsoluteSendTimeStatus(enable, id) ? 0 : -1;</span>
<a name="616"><span class="lineNum">     616 </span>            : }</a>
<span class="lineNum">     617 </span>            : 
<span class="lineNum">     618 </span><span class="lineNoCov">          0 : int ViEChannel::SetSendVideoRotationStatus(bool enable, int id) {</span>
<span class="lineNum">     619 </span>            :   // Disable any previous registrations of this extension to avoid errors.
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;DeregisterSendRtpHeaderExtension(kRtpExtensionVideoRotation);</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :   if (!enable)</span>
<span class="lineNum">     623 </span>            :     return 0;
<span class="lineNum">     624 </span>            :   // Enable the extension.
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :   int error = 0;</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     627 </span>            :     error |= rtp_rtcp-&gt;RegisterSendRtpHeaderExtension(
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :         kRtpExtensionVideoRotation, id);</span>
<span class="lineNum">     629 </span>            :   }
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :   return error;</span>
<a name="631"><span class="lineNum">     631 </span>            : }</a>
<span class="lineNum">     632 </span>            : 
<span class="lineNum">     633 </span><span class="lineNoCov">          0 : int ViEChannel::SetReceiveVideoRotationStatus(bool enable, int id) {</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :   return vie_receiver_.SetReceiveVideoRotationStatus(enable, id) ? 0 : -1;</span>
<a name="635"><span class="lineNum">     635 </span>            : }</a>
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span><span class="lineNoCov">          0 : int ViEChannel::SetSendTransportSequenceNumber(bool enable, int id) {</span>
<span class="lineNum">     638 </span>            :   // Disable any previous registrations of this extension to avoid errors.
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     640 </span>            :     rtp_rtcp-&gt;DeregisterSendRtpHeaderExtension(
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :         kRtpExtensionTransportSequenceNumber);</span>
<span class="lineNum">     642 </span>            :   }
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :   if (!enable)</span>
<span class="lineNum">     644 </span>            :     return 0;
<span class="lineNum">     645 </span>            :   // Enable the extension.
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :   int error = 0;</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     648 </span>            :     error |= rtp_rtcp-&gt;RegisterSendRtpHeaderExtension(
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :         kRtpExtensionTransportSequenceNumber, id);</span>
<span class="lineNum">     650 </span>            :   }
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :   return error;</span>
<a name="652"><span class="lineNum">     652 </span>            : }</a>
<span class="lineNum">     653 </span>            : 
<span class="lineNum">     654 </span><span class="lineNoCov">          0 : int ViEChannel::SetReceiveTransportSequenceNumber(bool enable, int id) {</span>
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :   return vie_receiver_.SetReceiveTransportSequenceNumber(enable, id) ? 0 : -1;</span>
<a name="656"><span class="lineNum">     656 </span>            : }</a>
<span class="lineNum">     657 </span>            : 
<span class="lineNum">     658 </span><span class="lineNoCov">          0 : int ViEChannel::SetSendRtpStreamId(bool enable, int id,</span>
<span class="lineNum">     659 </span>            :                                    std::vector&lt;std::string&gt; rids) {
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     661 </span>            :     rtp_rtcp-&gt;DeregisterSendRtpHeaderExtension(
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :       kRtpExtensionRtpStreamId);</span>
<span class="lineNum">     663 </span>            :   }
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :   if (!enable) {</span>
<span class="lineNum">     665 </span>            :     return 0;
<span class="lineNum">     666 </span>            :   }
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :   int error = 0;</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :   unsigned long i = 0;</span>
<span class="lineNum">     669 </span>            :   // Enable the extension
<span class="lineNum">     670 </span>            :   // NOTE: simulcast streams must be set via the SetSendCodec() API
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     672 </span>            :     error |= rtp_rtcp-&gt;RegisterSendRtpHeaderExtension(
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :       kRtpExtensionRtpStreamId, id);</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :     if (rids.size() &gt; i) {</span>
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :       rtp_rtcp-&gt;SetRID(rids[i++].c_str());</span>
<span class="lineNum">     676 </span>            :     }
<span class="lineNum">     677 </span>            :   }
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :   return error;</span>
<a name="679"><span class="lineNum">     679 </span>            : }</a>
<span class="lineNum">     680 </span>            : 
<span class="lineNum">     681 </span><span class="lineNoCov">          0 : int ViEChannel::SetReceiveRtpStreamId(bool enable, int id) {</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :   return vie_receiver_.SetReceiveRIDStatus(enable, id) ? 0 : -1;</span>
<a name="683"><span class="lineNum">     683 </span>            : }</a>
<span class="lineNum">     684 </span>            : 
<span class="lineNum">     685 </span><span class="lineNoCov">          0 : void ViEChannel::SetRtcpXrRrtrStatus(bool enable) {</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :   rtp_rtcp_modules_[0]-&gt;SetRtcpXrRrtrStatus(enable);</span>
<a name="687"><span class="lineNum">     687 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     688 </span>            : 
<span class="lineNum">     689 </span><span class="lineNoCov">          0 : void ViEChannel::EnableTMMBR(bool enable) {</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :   rtp_rtcp_modules_[0]-&gt;SetTMMBRStatus(enable);</span>
<a name="691"><span class="lineNum">     691 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span><span class="lineNoCov">          0 : int32_t ViEChannel::SetSSRC(const uint32_t SSRC,</span>
<span class="lineNum">     694 </span>            :                             const StreamType usage,
<span class="lineNum">     695 </span>            :                             const uint8_t simulcast_idx) {
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :   RtpRtcp* rtp_rtcp = rtp_rtcp_modules_[simulcast_idx];</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :   if (usage == kViEStreamTypeRtx) {</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetRtxSsrc(SSRC);</span>
<span class="lineNum">     699 </span>            :   } else {
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetSSRC(SSRC);</span>
<span class="lineNum">     701 </span>            :   }
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="703"><span class="lineNum">     703 </span>            : }</a>
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span><span class="lineNoCov">          0 : int32_t ViEChannel::SetRemoteSSRCType(const StreamType usage,</span>
<span class="lineNum">     706 </span>            :                                       const uint32_t SSRC) {
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :   vie_receiver_.SetRtxSsrc(SSRC);</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="709"><span class="lineNum">     709 </span>            : }</a>
<span class="lineNum">     710 </span>            : 
<span class="lineNum">     711 </span><span class="lineNoCov">          0 : int32_t ViEChannel::GetLocalSSRC(uint8_t idx, unsigned int* ssrc) {</span>
<span class="lineNum">     712 </span>            :   RTC_DCHECK_LE(idx, rtp_rtcp_modules_.size());
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :   *ssrc = rtp_rtcp_modules_[idx]-&gt;SSRC();</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="715"><span class="lineNum">     715 </span>            : }</a>
<span class="lineNum">     716 </span>            : 
<span class="lineNum">     717 </span><span class="lineNoCov">          0 : uint32_t ViEChannel::GetRemoteSSRC() {</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :   return vie_receiver_.GetRemoteSsrc();</span>
<a name="719"><span class="lineNum">     719 </span>            : }</a>
<span class="lineNum">     720 </span>            : 
<span class="lineNum">     721 </span><span class="lineNoCov">          0 : int ViEChannel::SetRtxSendPayloadType(int payload_type,</span>
<span class="lineNum">     722 </span>            :                                       int associated_payload_type) {
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetRtxSendPayloadType(payload_type, associated_payload_type);</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :   SetRtxSendStatus(true);</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="727"><span class="lineNum">     727 </span>            : }</a>
<span class="lineNum">     728 </span>            : 
<span class="lineNum">     729 </span><span class="lineNoCov">          0 : void ViEChannel::SetRtxSendStatus(bool enable) {</span>
<span class="lineNum">     730 </span>            :   int rtx_settings =
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :       enable ? kRtxRetransmitted | kRtxRedundantPayloads : kRtxOff;</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetRtxSendStatus(rtx_settings);</span>
<a name="734"><span class="lineNum">     734 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     735 </span>            : 
<span class="lineNum">     736 </span><span class="lineNoCov">          0 : void ViEChannel::SetRtxReceivePayloadType(int payload_type,</span>
<span class="lineNum">     737 </span>            :                                           int associated_payload_type) {
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :   vie_receiver_.SetRtxPayloadType(payload_type, associated_payload_type);</span>
<a name="739"><span class="lineNum">     739 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     740 </span>            : 
<span class="lineNum">     741 </span><span class="lineNoCov">          0 : void ViEChannel::SetUseRtxPayloadMappingOnRestore(bool val) {</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :   vie_receiver_.SetUseRtxPayloadMappingOnRestore(val);</span>
<a name="743"><span class="lineNum">     743 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     744 </span>            : 
<span class="lineNum">     745 </span><span class="lineNoCov">          0 : void ViEChannel::SetRtpStateForSsrc(uint32_t ssrc, const RtpState&amp; rtp_state) {</span>
<span class="lineNum">     746 </span>            :   RTC_DCHECK(!rtp_rtcp_modules_[0]-&gt;Sending());
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :     if (rtp_rtcp-&gt;SetRtpStateForSsrc(ssrc, rtp_state))</span>
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     750 </span>            :   }
<a name="751"><span class="lineNum">     751 </span>            : }</a>
<span class="lineNum">     752 </span>            : 
<span class="lineNum">     753 </span><span class="lineNoCov">          0 : RtpState ViEChannel::GetRtpStateForSsrc(uint32_t ssrc) {</span>
<span class="lineNum">     754 </span>            :   RTC_DCHECK(!rtp_rtcp_modules_[0]-&gt;Sending());
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :   RtpState rtp_state;</span>
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :     if (rtp_rtcp-&gt;GetRtpStateForSsrc(ssrc, &amp;rtp_state))</span>
<span class="lineNum">     758 </span>            :       return rtp_state;
<span class="lineNum">     759 </span>            :   }
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :   LOG(LS_ERROR) &lt;&lt; &quot;Couldn't get RTP state for ssrc: &quot; &lt;&lt; ssrc;</span>
<span class="lineNum">     761 </span>            :   return rtp_state;
<span class="lineNum">     762 </span>            : }
<a name="763"><span class="lineNum">     763 </span>            : </a>
<span class="lineNum">     764 </span>            : // TODO(pbos): Set CNAME on all modules.
<span class="lineNum">     765 </span><span class="lineNoCov">          0 : int32_t ViEChannel::SetRTCPCName(const char* rtcp_cname) {</span>
<span class="lineNum">     766 </span>            :   RTC_DCHECK(!rtp_rtcp_modules_[0]-&gt;Sending());
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :   return rtp_rtcp_modules_[0]-&gt;SetCNAME(rtcp_cname);</span>
<a name="768"><span class="lineNum">     768 </span>            : }</a>
<span class="lineNum">     769 </span>            : 
<span class="lineNum">     770 </span><span class="lineNoCov">          0 : int32_t ViEChannel::GetRemoteRTCPCName(char rtcp_cname[]) {</span>
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :   uint32_t remoteSSRC = vie_receiver_.GetRemoteSsrc();</span>
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :   return rtp_rtcp_modules_[0]-&gt;RemoteCNAME(remoteSSRC, rtcp_cname);</span>
<a name="773"><span class="lineNum">     773 </span>            : }</a>
<span class="lineNum">     774 </span>            : 
<span class="lineNum">     775 </span><span class="lineNoCov">          0 : int32_t ViEChannel::GetSendRtcpStatistics(uint16_t* fraction_lost,</span>
<span class="lineNum">     776 </span>            :                                           uint32_t* cumulative_lost,
<span class="lineNum">     777 </span>            :                                           uint32_t* extended_max,
<span class="lineNum">     778 </span>            :                                           uint32_t* jitter_samples,
<span class="lineNum">     779 </span>            :                                           int64_t* rtt_ms) {
<span class="lineNum">     780 </span>            :   // Aggregate the report blocks associated with streams sent on this channel.
<span class="lineNum">     781 </span>            :   std::vector&lt;RTCPReportBlock&gt; report_blocks;
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;RemoteRTCPStat(&amp;report_blocks);</span>
<span class="lineNum">     784 </span>            : 
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :   if (report_blocks.empty())</span>
<span class="lineNum">     786 </span>            :     return -1;
<span class="lineNum">     787 </span>            : 
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :   uint32_t remote_ssrc = vie_receiver_.GetRemoteSsrc();</span>
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :   std::vector&lt;RTCPReportBlock&gt;::const_iterator it = report_blocks.begin();</span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :   for (; it != report_blocks.end(); ++it) {</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :     if (it-&gt;remoteSSRC == remote_ssrc)</span>
<span class="lineNum">     792 </span>            :       break;
<span class="lineNum">     793 </span>            :   }
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :   if (it == report_blocks.end()) {</span>
<span class="lineNum">     795 </span>            :     // We have not received packets with an SSRC matching the report blocks. To
<span class="lineNum">     796 </span>            :     // have a chance of calculating an RTT we will try with the SSRC of the
<span class="lineNum">     797 </span>            :     // first report block received.
<span class="lineNum">     798 </span>            :     // This is very important for send-only channels where we don't know the
<span class="lineNum">     799 </span>            :     // SSRC of the other end.
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :     remote_ssrc = report_blocks[0].remoteSSRC;</span>
<span class="lineNum">     801 </span>            :   }
<span class="lineNum">     802 </span>            : 
<span class="lineNum">     803 </span>            :   // TODO(asapersson): Change report_block_stats to not rely on
<span class="lineNum">     804 </span>            :   // GetSendRtcpStatistics to be called.
<span class="lineNum">     805 </span>            :   RTCPReportBlock report =
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :       report_block_stats_sender_-&gt;AggregateAndStore(report_blocks);</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :   *fraction_lost = report.fractionLost;</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :   *cumulative_lost = report.cumulativeLost;</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :   *extended_max = report.extendedHighSeqNum;</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :   *jitter_samples = report.jitter;</span>
<span class="lineNum">     811 </span>            : 
<span class="lineNum">     812 </span>            :   int64_t dummy;
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :   int64_t rtt = 0;</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :   if (rtp_rtcp_modules_[0]-&gt;RTT(remote_ssrc, &amp;rtt, &amp;dummy, &amp;dummy, &amp;dummy) !=</span>
<span class="lineNum">     815 </span>            :       0) {
<span class="lineNum">     816 </span>            :     return -1;
<span class="lineNum">     817 </span>            :   }
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :   *rtt_ms = rtt;</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="820"><span class="lineNum">     820 </span>            : }</a>
<span class="lineNum">     821 </span>            : 
<span class="lineNum">     822 </span><span class="lineNoCov">          0 : int32_t ViEChannel::GetRemoteRTCPReceiverInfo(uint32_t&amp; NTPHigh,</span>
<span class="lineNum">     823 </span>            :                                               uint32_t&amp; NTPLow,
<span class="lineNum">     824 </span>            :                                               uint32_t&amp; receivedPacketCount,
<span class="lineNum">     825 </span>            :                                               uint64_t&amp; receivedOctetCount,
<span class="lineNum">     826 </span>            :                                               uint32_t* jitterSamples,
<span class="lineNum">     827 </span>            :                                               uint16_t* fractionLost,
<span class="lineNum">     828 </span>            :                                               uint32_t* cumulativeLost,
<span class="lineNum">     829 </span>            :                                              int64_t* rttMs) {
<span class="lineNum">     830 </span>            :   // TODO: how do we do this for simulcast ? average for all
<span class="lineNum">     831 </span>            :   // except cumulative_lost that is the sum ?
<span class="lineNum">     832 </span>            :   // CriticalSectionScoped cs(rtp_rtcp_cs_.get());
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span>            :   // for (std::list&lt;RtpRtcp*&gt;::const_iterator it = simulcast_rtp_rtcp_.begin();
<span class="lineNum">     835 </span>            :   //      it != simulcast_rtp_rtcp_.end();
<span class="lineNum">     836 </span>            :   //      it++) {
<span class="lineNum">     837 </span>            :   //   RtpRtcp* rtp_rtcp = *it;
<span class="lineNum">     838 </span>            :   // }
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :   uint32_t remote_ssrc = vie_receiver_.GetRemoteSsrc();</span>
<span class="lineNum">     840 </span>            : 
<span class="lineNum">     841 </span>            :   // Get all RTCP receiver report blocks that have been received on this
<span class="lineNum">     842 </span>            :   // channel. If we receive RTP packets from a remote source we know the
<span class="lineNum">     843 </span>            :   // remote SSRC and use the report block from him.
<span class="lineNum">     844 </span>            :   // Otherwise use the first report block.
<span class="lineNum">     845 </span>            :   std::vector&lt;RTCPReportBlock&gt; remote_stats;
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :         for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;RemoteRTCPStat(&amp;remote_stats);</span>
<span class="lineNum">     848 </span>            :   }
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :   if (remote_stats.empty()) {</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :     LOG_F(LS_ERROR) &lt;&lt; &quot;Could not get remote stats&quot;;</span>
<span class="lineNum">     851 </span>            :     return -1;
<span class="lineNum">     852 </span>            :   }
<span class="lineNum">     853 </span>            :   std::vector&lt;RTCPReportBlock&gt;::const_iterator statistics =
<span class="lineNum">     854 </span>            :       remote_stats.begin();
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :   for (; statistics != remote_stats.end(); ++statistics) {</span>
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :     if (statistics-&gt;remoteSSRC == remote_ssrc)</span>
<span class="lineNum">     857 </span>            :       break;
<span class="lineNum">     858 </span>            :   }
<span class="lineNum">     859 </span>            : 
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :   if (statistics == remote_stats.end()) {</span>
<span class="lineNum">     861 </span>            :     // If we have not received any RTCP packets from this SSRC it probably means
<span class="lineNum">     862 </span>            :     // we have not received any RTP packets.
<span class="lineNum">     863 </span>            :     // Use the first received report block instead.
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :     statistics = remote_stats.begin();</span>
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :     remote_ssrc = statistics-&gt;remoteSSRC;</span>
<span class="lineNum">     866 </span>            :   }
<span class="lineNum">     867 </span>            : 
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :   if (!rtp_rtcp_modules_[0]) {</span>
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :     LOG_F(LS_ERROR) &lt;&lt; &quot;no RtpRtcp modules to retrieve RTT from&quot;;</span>
<span class="lineNum">     870 </span>            :   } else {
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :     if (rtp_rtcp_modules_[0]-&gt;GetReportBlockInfo(remote_ssrc, &amp;NTPHigh, &amp;NTPLow,</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :           &amp;receivedPacketCount, &amp;receivedOctetCount) != 0) {</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :       LOG_F(LS_ERROR) &lt;&lt; &quot;failed to retrieve block info&quot;;</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :       NTPHigh = 0;</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :       NTPLow = 0;</span>
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :       receivedPacketCount = 0;</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :       receivedOctetCount = 0;</span>
<span class="lineNum">     878 </span>            :     }
<span class="lineNum">     879 </span>            :   }
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :   *fractionLost = statistics-&gt;fractionLost;</span>
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :   *cumulativeLost = statistics-&gt;cumulativeLost;</span>
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :   *jitterSamples = statistics-&gt;jitter;</span>
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span>            :   int64_t dummy;
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :   int64_t rtt = 0;</span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :   if (rtp_rtcp_modules_[0]-&gt;RTT(remote_ssrc, &amp;rtt, &amp;dummy, &amp;dummy, &amp;dummy) != 0) {</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :     LOG_F(LS_ERROR) &lt;&lt; &quot;failed to get RTT&quot;;</span>
<span class="lineNum">     888 </span>            :     return -1;
<span class="lineNum">     889 </span>            :   }
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :   *rttMs = rtt;</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="892"><span class="lineNum">     892 </span>            : }</a>
<span class="lineNum">     893 </span>            : 
<span class="lineNum">     894 </span><span class="lineNoCov">          0 : int32_t ViEChannel::GetRemoteRTCPSenderInfo(RTCPSenderInfo* sender_info) const {</span>
<span class="lineNum">     895 </span>            :   // Get the sender info from the latest received RTCP Sender Report.
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :   if (rtp_rtcp_modules_[0] &amp;&amp;</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :     rtp_rtcp_modules_[0]-&gt;RemoteRTCPStat(sender_info) != 0) {</span>
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :     LOG_F(LS_ERROR) &lt;&lt; &quot;failed to read RTCP SR sender info&quot;;</span>
<span class="lineNum">     899 </span>            :     return -1;
<span class="lineNum">     900 </span>            :   }
<span class="lineNum">     901 </span>            :   return 0;
<a name="902"><span class="lineNum">     902 </span>            : }</a>
<span class="lineNum">     903 </span>            : 
<span class="lineNum">     904 </span><span class="lineNoCov">          0 : void ViEChannel::RegisterSendChannelRtcpStatisticsCallback(</span>
<span class="lineNum">     905 </span>            :     RtcpStatisticsCallback* callback) {
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;RegisterRtcpStatisticsCallback(callback);</span>
<a name="908"><span class="lineNum">     908 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     909 </span>            : 
<span class="lineNum">     910 </span><span class="lineNoCov">          0 : void ViEChannel::RegisterReceiveChannelRtcpStatisticsCallback(</span>
<span class="lineNum">     911 </span>            :     RtcpStatisticsCallback* callback) {
<span class="lineNum">     912 </span><span class="lineNoCov">          0 :   vie_receiver_.GetReceiveStatistics()-&gt;RegisterRtcpStatisticsCallback(</span>
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :       callback);</span>
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :   rtp_rtcp_modules_[0]-&gt;RegisterRtcpStatisticsCallback(callback);</span>
<a name="915"><span class="lineNum">     915 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     916 </span>            : 
<span class="lineNum">     917 </span><span class="lineNoCov">          0 : void ViEChannel::RegisterRtcpPacketTypeCounterObserver(</span>
<span class="lineNum">     918 </span>            :     RtcpPacketTypeCounterObserver* observer) {
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :   rtcp_packet_type_counter_observer_.Set(observer);</span>
<a name="920"><span class="lineNum">     920 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     921 </span>            : 
<span class="lineNum">     922 </span><span class="lineNoCov">          0 : void ViEChannel::GetSendStreamDataCounters(</span>
<span class="lineNum">     923 </span>            :     StreamDataCounters* rtp_counters,
<span class="lineNum">     924 </span>            :     StreamDataCounters* rtx_counters) const {
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :   *rtp_counters = StreamDataCounters();</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :   *rtx_counters = StreamDataCounters();</span>
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :     StreamDataCounters rtp_data;</span>
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :     StreamDataCounters rtx_data;</span>
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;GetSendStreamDataCounters(&amp;rtp_data, &amp;rtx_data);</span>
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :     rtp_counters-&gt;Add(rtp_data);</span>
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :     rtx_counters-&gt;Add(rtx_data);</span>
<span class="lineNum">     933 </span>            :   }
<a name="934"><span class="lineNum">     934 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     935 </span>            : 
<span class="lineNum">     936 </span><span class="lineNoCov">          0 : void ViEChannel::GetReceiveStreamDataCounters(</span>
<span class="lineNum">     937 </span>            :     StreamDataCounters* rtp_counters,
<span class="lineNum">     938 </span>            :     StreamDataCounters* rtx_counters) const {
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :   StreamStatistician* statistician = vie_receiver_.GetReceiveStatistics()-&gt;</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :       GetStatistician(vie_receiver_.GetRemoteSsrc());</span>
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :   if (statistician) {</span>
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :     statistician-&gt;GetReceiveStreamDataCounters(rtp_counters);</span>
<span class="lineNum">     943 </span>            :   }
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :   uint32_t rtx_ssrc = 0;</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :   if (vie_receiver_.GetRtxSsrc(&amp;rtx_ssrc)) {</span>
<span class="lineNum">     946 </span>            :     StreamStatistician* statistician =
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :         vie_receiver_.GetReceiveStatistics()-&gt;GetStatistician(rtx_ssrc);</span>
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :     if (statistician) {</span>
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :       statistician-&gt;GetReceiveStreamDataCounters(rtx_counters);</span>
<span class="lineNum">     950 </span>            :     }
<span class="lineNum">     951 </span>            :   }
<a name="952"><span class="lineNum">     952 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     953 </span>            : 
<span class="lineNum">     954 </span><span class="lineNoCov">          0 : void ViEChannel::RegisterSendChannelRtpStatisticsCallback(</span>
<span class="lineNum">     955 </span>            :       StreamDataCountersCallback* callback) {
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;RegisterSendChannelRtpStatisticsCallback(callback);</span>
<a name="958"><span class="lineNum">     958 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     959 </span>            : 
<span class="lineNum">     960 </span><span class="lineNoCov">          0 : void ViEChannel::RegisterReceiveChannelRtpStatisticsCallback(</span>
<span class="lineNum">     961 </span>            :     StreamDataCountersCallback* callback) {
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :   vie_receiver_.GetReceiveStatistics()-&gt;RegisterRtpStatisticsCallback(callback);</span>
<a name="963"><span class="lineNum">     963 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     964 </span>            : 
<span class="lineNum">     965 </span><span class="lineNoCov">          0 : void ViEChannel::GetSendRtcpPacketTypeCounter(</span>
<span class="lineNum">     966 </span>            :     RtcpPacketTypeCounter* packet_counter) const {
<span class="lineNum">     967 </span>            :   std::map&lt;uint32_t, RtcpPacketTypeCounter&gt; counter_map =
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :       rtcp_packet_type_counter_observer_.GetPacketTypeCounterMap();</span>
<span class="lineNum">     969 </span>            : 
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :   RtcpPacketTypeCounter counter;</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :     counter.Add(counter_map[rtp_rtcp-&gt;SSRC()]);</span>
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :   *packet_counter = counter;</span>
<a name="974"><span class="lineNum">     974 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     975 </span>            : 
<span class="lineNum">     976 </span><span class="lineNoCov">          0 : void ViEChannel::GetReceiveRtcpPacketTypeCounter(</span>
<span class="lineNum">     977 </span>            :     RtcpPacketTypeCounter* packet_counter) const {
<span class="lineNum">     978 </span>            :   std::map&lt;uint32_t, RtcpPacketTypeCounter&gt; counter_map =
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :       rtcp_packet_type_counter_observer_.GetPacketTypeCounterMap();</span>
<span class="lineNum">     980 </span>            : 
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :   RtcpPacketTypeCounter counter;</span>
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :   counter.Add(counter_map[vie_receiver_.GetRemoteSsrc()]);</span>
<span class="lineNum">     983 </span>            : 
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :   *packet_counter = counter;</span>
<a name="985"><span class="lineNum">     985 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     986 </span>            : 
<span class="lineNum">     987 </span><span class="lineNoCov">          0 : void ViEChannel::RegisterSendSideDelayObserver(</span>
<span class="lineNum">     988 </span>            :     SendSideDelayObserver* observer) {
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :   send_side_delay_observer_.Set(observer);</span>
<a name="990"><span class="lineNum">     990 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     991 </span>            : 
<span class="lineNum">     992 </span><span class="lineNoCov">          0 : void ViEChannel::RegisterSendBitrateObserver(</span>
<span class="lineNum">     993 </span>            :     BitrateStatisticsObserver* observer) {
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :   send_bitrate_observer_.Set(observer);</span>
<a name="995"><span class="lineNum">     995 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     996 </span>            : 
<span class="lineNum">     997 </span><span class="lineNoCov">          0 : int32_t ViEChannel::StartSend() {</span>
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :   CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">     999 </span>            : 
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :   if (rtp_rtcp_modules_[0]-&gt;Sending())</span>
<span class="lineNum">    1001 </span>            :     return -1;
<span class="lineNum">    1002 </span>            : 
<span class="lineNum">    1003 </span><span class="lineNoCov">          0 :   for (size_t i = 0; i &lt; num_active_rtp_rtcp_modules_; ++i) {</span>
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :     RtpRtcp* rtp_rtcp = rtp_rtcp_modules_[i];</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetSendingMediaStatus(true);</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetSendingStatus(true);</span>
<span class="lineNum">    1007 </span>            :   }
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :   send_payload_router_-&gt;set_active(true);</span>
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="1010"><span class="lineNum">    1010 </span>            : }</a>
<span class="lineNum">    1011 </span>            : 
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 : int32_t ViEChannel::StopSend() {</span>
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :   send_payload_router_-&gt;set_active(false);</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetSendingMediaStatus(false);</span>
<span class="lineNum">    1016 </span>            : 
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :   if (!rtp_rtcp_modules_[0]-&gt;Sending()) {</span>
<span class="lineNum">    1018 </span>            :     return -1;
<span class="lineNum">    1019 </span>            :   }
<span class="lineNum">    1020 </span>            : 
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetSendingStatus(false);</span>
<span class="lineNum">    1023 </span>            :   }
<span class="lineNum">    1024 </span>            :   return 0;
<a name="1025"><span class="lineNum">    1025 </span>            : }</a>
<span class="lineNum">    1026 </span>            : 
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 : bool ViEChannel::Sending() {</span>
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :   return rtp_rtcp_modules_[0]-&gt;Sending();</span>
<a name="1029"><span class="lineNum">    1029 </span>            : }</a>
<span class="lineNum">    1030 </span>            : 
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 : void ViEChannel::StartReceive() {</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :   if (!sender_)</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :     StartDecodeThread();</span>
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :   vie_receiver_.StartReceive();</span>
<a name="1035"><span class="lineNum">    1035 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1036 </span>            : 
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 : void ViEChannel::StopReceive() {</span>
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :   vie_receiver_.StopReceive();</span>
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :   if (!sender_) {</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :     StopDecodeThread();</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :     vcm_-&gt;ResetDecoder();</span>
<span class="lineNum">    1042 </span>            :   }
<a name="1043"><span class="lineNum">    1043 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1044 </span>            : 
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 : int32_t ViEChannel::ReceivedRTPPacket(const void* rtp_packet,</span>
<span class="lineNum">    1046 </span>            :                                       size_t rtp_packet_length,
<span class="lineNum">    1047 </span>            :                                       const PacketTime&amp; packet_time) {
<span class="lineNum">    1048 </span>            :   return vie_receiver_.ReceivedRTPPacket(
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :       rtp_packet, rtp_packet_length, packet_time);</span>
<a name="1050"><span class="lineNum">    1050 </span>            : }</a>
<span class="lineNum">    1051 </span>            : 
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 : int32_t ViEChannel::ReceivedRTCPPacket(const void* rtcp_packet,</span>
<span class="lineNum">    1053 </span>            :                                        size_t rtcp_packet_length) {
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :   return vie_receiver_.ReceivedRTCPPacket(rtcp_packet, rtcp_packet_length);</span>
<a name="1055"><span class="lineNum">    1055 </span>            : }</a>
<span class="lineNum">    1056 </span>            : 
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 : int32_t ViEChannel::SetMTU(uint16_t mtu) {</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_)</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetMaxTransferUnit(mtu);</span>
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="1061"><span class="lineNum">    1061 </span>            : }</a>
<span class="lineNum">    1062 </span>            : 
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 : RtpRtcp* ViEChannel::rtp_rtcp() {</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :   return rtp_rtcp_modules_[0];</span>
<a name="1065"><span class="lineNum">    1065 </span>            : }</a>
<span class="lineNum">    1066 </span>            : 
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 : rtc::scoped_refptr&lt;PayloadRouter&gt; ViEChannel::send_payload_router() {</span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :   return send_payload_router_;</span>
<a name="1069"><span class="lineNum">    1069 </span>            : }</a>
<span class="lineNum">    1070 </span>            : 
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 : VCMProtectionCallback* ViEChannel::vcm_protection_callback() {</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :   return vcm_protection_callback_.get();</span>
<a name="1073"><span class="lineNum">    1073 </span>            : }</a>
<span class="lineNum">    1074 </span>            : 
<span class="lineNum">    1075 </span><span class="lineNoCov">          0 : CallStatsObserver* ViEChannel::GetStatsObserver() {</span>
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :   return stats_observer_.get();</span>
<span class="lineNum">    1077 </span>            : }
<span class="lineNum">    1078 </span>            : 
<span class="lineNum">    1079 </span>            : // Do not acquire the lock of |vcm_| in this function. Decode callback won't
<span class="lineNum">    1080 </span>            : // necessarily be called from the decoding thread. The decoding thread may have
<a name="1081"><span class="lineNum">    1081 </span>            : // held the lock when calling VideoDecoder::Decode, Reset, or Release. Acquiring</a>
<span class="lineNum">    1082 </span>            : // the same lock in the path of decode callback can deadlock.
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 : int32_t ViEChannel::FrameToRender(VideoFrame&amp; video_frame) {  // NOLINT</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :   CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">    1085 </span>            : 
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :   if (pre_render_callback_ != NULL)</span>
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :     pre_render_callback_-&gt;FrameCallback(&amp;video_frame);</span>
<span class="lineNum">    1088 </span>            : 
<span class="lineNum">    1089 </span>            :   // TODO(pbos): Remove stream id argument.
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :   incoming_video_stream_-&gt;RenderFrame(0xFFFFFFFF, video_frame);</span>
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="1092"><span class="lineNum">    1092 </span>            : }</a>
<span class="lineNum">    1093 </span>            : 
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 : int32_t ViEChannel::ReceivedDecodedReferenceFrame(</span>
<span class="lineNum">    1095 </span>            :   const uint64_t picture_id) {
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :   return rtp_rtcp_modules_[0]-&gt;SendRTCPReferencePictureSelection(picture_id);</span>
<a name="1097"><span class="lineNum">    1097 </span>            : }</a>
<span class="lineNum">    1098 </span>            : 
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 : void ViEChannel::OnIncomingPayloadType(int payload_type) {</span>
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 :   CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :   if (receive_stats_callback_)</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :     receive_stats_callback_-&gt;OnIncomingPayloadType(payload_type);</span>
<a name="1103"><span class="lineNum">    1103 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1104 </span>            : 
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 : void ViEChannel::OnDecoderImplementationName(const char* implementation_name) {</span>
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :   CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :   if (receive_stats_callback_)</span>
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :     receive_stats_callback_-&gt;OnDecoderImplementationName(implementation_name);</span>
<a name="1109"><span class="lineNum">    1109 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1110 </span>            : 
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 : void ViEChannel::OnReceiveRatesUpdated(uint32_t bit_rate, uint32_t frame_rate) {</span>
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :   CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :   if (receive_stats_callback_)</span>
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 :     receive_stats_callback_-&gt;OnIncomingRate(frame_rate, bit_rate);</span>
<a name="1115"><span class="lineNum">    1115 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1116 </span>            : 
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 : void ViEChannel::OnDiscardedPacketsUpdated(int discarded_packets) {</span>
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :   CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :   if (receive_stats_callback_)</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :     receive_stats_callback_-&gt;OnDiscardedPacketsUpdated(discarded_packets);</span>
<a name="1121"><span class="lineNum">    1121 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1122 </span>            : 
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 : void ViEChannel::OnFrameCountsUpdated(const FrameCounts&amp; frame_counts) {</span>
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :   CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :   receive_frame_counts_ = frame_counts;</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :   if (receive_stats_callback_)</span>
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 :     receive_stats_callback_-&gt;OnFrameCountsUpdated(frame_counts);</span>
<a name="1128"><span class="lineNum">    1128 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1129 </span>            : 
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 : void ViEChannel::OnDecoderTiming(int decode_ms,</span>
<span class="lineNum">    1131 </span>            :                                  int max_decode_ms,
<span class="lineNum">    1132 </span>            :                                  int current_delay_ms,
<span class="lineNum">    1133 </span>            :                                  int target_delay_ms,
<span class="lineNum">    1134 </span>            :                                  int jitter_buffer_ms,
<span class="lineNum">    1135 </span>            :                                  int min_playout_delay_ms,
<span class="lineNum">    1136 </span>            :                                  int render_delay_ms) {
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :   CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :   if (!receive_stats_callback_)</span>
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    1140 </span>            :   receive_stats_callback_-&gt;OnDecoderTiming(
<span class="lineNum">    1141 </span>            :       decode_ms, max_decode_ms, current_delay_ms, target_delay_ms,
<span class="lineNum">    1142 </span><span class="lineNoCov">          0 :       jitter_buffer_ms, min_playout_delay_ms, render_delay_ms, last_rtt_ms_);</span>
<a name="1143"><span class="lineNum">    1143 </span>            : }</a>
<span class="lineNum">    1144 </span>            : 
<span class="lineNum">    1145 </span><span class="lineNoCov">          0 : int32_t ViEChannel::RequestKeyFrame() {</span>
<span class="lineNum">    1146 </span><span class="lineNoCov">          0 :   return rtp_rtcp_modules_[0]-&gt;RequestKeyFrame();</span>
<a name="1147"><span class="lineNum">    1147 </span>            : }</a>
<span class="lineNum">    1148 </span>            : 
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 : int32_t ViEChannel::SliceLossIndicationRequest(</span>
<span class="lineNum">    1150 </span>            :   const uint64_t picture_id) {
<span class="lineNum">    1151 </span><span class="lineNoCov">          0 :   return rtp_rtcp_modules_[0]-&gt;SendRTCPSliceLossIndication(</span>
<span class="lineNum">    1152 </span><span class="lineNoCov">          0 :       static_cast&lt;uint8_t&gt;(picture_id));</span>
<a name="1153"><span class="lineNum">    1153 </span>            : }</a>
<span class="lineNum">    1154 </span>            : 
<span class="lineNum">    1155 </span><span class="lineNoCov">          0 : int32_t ViEChannel::ResendPackets(const uint16_t* sequence_numbers,</span>
<span class="lineNum">    1156 </span>            :                                   uint16_t length) {
<span class="lineNum">    1157 </span><span class="lineNoCov">          0 :   return rtp_rtcp_modules_[0]-&gt;SendNACK(sequence_numbers, length);</span>
<a name="1158"><span class="lineNum">    1158 </span>            : }</a>
<span class="lineNum">    1159 </span>            : 
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 : void ViEChannel::ReceiveStateChange(VideoReceiveState state) {</span>
<a name="1161"><span class="lineNum">    1161 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1162 </span>            : 
<span class="lineNum">    1163 </span><span class="lineNoCov">          0 : bool ViEChannel::ChannelDecodeThreadFunction(void* obj) {</span>
<span class="lineNum">    1164 </span><span class="lineNoCov">          0 :   return static_cast&lt;ViEChannel*&gt;(obj)-&gt;ChannelDecodeProcess();</span>
<a name="1165"><span class="lineNum">    1165 </span>            : }</a>
<span class="lineNum">    1166 </span>            : 
<span class="lineNum">    1167 </span><span class="lineNoCov">          0 : bool ViEChannel::ChannelDecodeProcess() {</span>
<span class="lineNum">    1168 </span><span class="lineNoCov">          0 :   vcm_-&gt;Decode(kMaxDecodeWaitTimeMs);</span>
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :   return true;</span>
<a name="1170"><span class="lineNum">    1170 </span>            : }</a>
<span class="lineNum">    1171 </span>            : 
<span class="lineNum">    1172 </span><span class="lineNoCov">          0 : void ViEChannel::OnRttUpdate(int64_t avg_rtt_ms, int64_t max_rtt_ms) {</span>
<span class="lineNum">    1173 </span><span class="lineNoCov">          0 :   vcm_-&gt;SetReceiveChannelParameters(max_rtt_ms);</span>
<span class="lineNum">    1174 </span>            : 
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :   CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :   if (time_of_first_rtt_ms_ == -1)</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :     time_of_first_rtt_ms_ = Clock::GetRealTimeClock()-&gt;TimeInMilliseconds();</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :   rtt_sum_ms_ += avg_rtt_ms;</span>
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :   last_rtt_ms_ = avg_rtt_ms;</span>
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :   ++num_rtts_;</span>
<a name="1181"><span class="lineNum">    1181 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1182 </span>            : 
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 : int ViEChannel::ProtectionRequest(const FecProtectionParams* delta_fec_params,</span>
<span class="lineNum">    1184 </span>            :                                   const FecProtectionParams* key_fec_params,
<span class="lineNum">    1185 </span>            :                                   uint32_t* video_rate_bps,
<span class="lineNum">    1186 </span>            :                                   uint32_t* nack_rate_bps,
<span class="lineNum">    1187 </span>            :                                   uint32_t* fec_rate_bps) {
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :   *video_rate_bps = 0;</span>
<span class="lineNum">    1189 </span><span class="lineNoCov">          0 :   *nack_rate_bps = 0;</span>
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 :   *fec_rate_bps = 0;</span>
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :   for (RtpRtcp* rtp_rtcp : rtp_rtcp_modules_) {</span>
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 :     uint32_t not_used = 0;</span>
<span class="lineNum">    1193 </span><span class="lineNoCov">          0 :     uint32_t module_video_rate = 0;</span>
<span class="lineNum">    1194 </span><span class="lineNoCov">          0 :     uint32_t module_fec_rate = 0;</span>
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :     uint32_t module_nack_rate = 0;</span>
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetFecParameters(delta_fec_params, key_fec_params);</span>
<span class="lineNum">    1197 </span>            :     rtp_rtcp-&gt;BitrateSent(&amp;not_used, &amp;module_video_rate, &amp;module_fec_rate,
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :                           &amp;module_nack_rate);</span>
<span class="lineNum">    1199 </span><span class="lineNoCov">          0 :     *video_rate_bps += module_video_rate;</span>
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :     *nack_rate_bps += module_nack_rate;</span>
<span class="lineNum">    1201 </span><span class="lineNoCov">          0 :     *fec_rate_bps += module_fec_rate;</span>
<span class="lineNum">    1202 </span>            :   }
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="1204"><span class="lineNum">    1204 </span>            : }</a>
<span class="lineNum">    1205 </span>            : 
<span class="lineNum">    1206 </span><span class="lineNoCov">          0 : std::vector&lt;RtpRtcp*&gt; ViEChannel::CreateRtpRtcpModules(</span>
<span class="lineNum">    1207 </span>            :     bool receiver_only,
<span class="lineNum">    1208 </span>            :     ReceiveStatistics* receive_statistics,
<span class="lineNum">    1209 </span>            :     Transport* outgoing_transport,
<span class="lineNum">    1210 </span>            :     RtcpIntraFrameObserver* intra_frame_callback,
<span class="lineNum">    1211 </span>            :     RtcpBandwidthObserver* bandwidth_callback,
<span class="lineNum">    1212 </span>            :     TransportFeedbackObserver* transport_feedback_callback,
<span class="lineNum">    1213 </span>            :     RtcpRttStats* rtt_stats,
<span class="lineNum">    1214 </span>            :     RtcpPacketTypeCounterObserver* rtcp_packet_type_counter_observer,
<span class="lineNum">    1215 </span>            :     RemoteBitrateEstimator* remote_bitrate_estimator,
<span class="lineNum">    1216 </span>            :     RtpPacketSender* paced_sender,
<span class="lineNum">    1217 </span>            :     TransportSequenceNumberAllocator* transport_sequence_number_allocator,
<span class="lineNum">    1218 </span>            :     BitrateStatisticsObserver* send_bitrate_observer,
<span class="lineNum">    1219 </span>            :     FrameCountObserver* send_frame_count_observer,
<span class="lineNum">    1220 </span>            :     SendSideDelayObserver* send_side_delay_observer,
<span class="lineNum">    1221 </span>            :     size_t num_modules) {
<span class="lineNum">    1222 </span>            :   RTC_DCHECK_GT(num_modules, 0u);
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :   RtpRtcp::Configuration configuration;</span>
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :   ReceiveStatistics* null_receive_statistics = configuration.receive_statistics;</span>
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :   configuration.audio = false;</span>
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :   configuration.receiver_only = receiver_only;</span>
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :   configuration.receive_statistics = receive_statistics;</span>
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :   configuration.outgoing_transport = outgoing_transport;</span>
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :   configuration.intra_frame_callback = intra_frame_callback;</span>
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :   configuration.rtt_stats = rtt_stats;</span>
<span class="lineNum">    1231 </span>            :   configuration.rtcp_packet_type_counter_observer =
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :       rtcp_packet_type_counter_observer;</span>
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :   configuration.paced_sender = paced_sender;</span>
<span class="lineNum">    1234 </span>            :   configuration.transport_sequence_number_allocator =
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :       transport_sequence_number_allocator;</span>
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :   configuration.send_bitrate_observer = send_bitrate_observer;</span>
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :   configuration.send_frame_count_observer = send_frame_count_observer;</span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :   configuration.send_side_delay_observer = send_side_delay_observer;</span>
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :   configuration.bandwidth_callback = bandwidth_callback;</span>
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :   configuration.transport_feedback_callback = transport_feedback_callback;</span>
<span class="lineNum">    1241 </span>            : 
<span class="lineNum">    1242 </span>            :   std::vector&lt;RtpRtcp*&gt; modules;
<span class="lineNum">    1243 </span><span class="lineNoCov">          0 :   for (size_t i = 0; i &lt; num_modules; ++i) {</span>
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 :     RtpRtcp* rtp_rtcp = RtpRtcp::CreateRtpRtcp(configuration);</span>
<span class="lineNum">    1245 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetSendingStatus(false);</span>
<span class="lineNum">    1246 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetSendingMediaStatus(false);</span>
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 :     rtp_rtcp-&gt;SetRTCPStatus(RtcpMode::kCompound);</span>
<span class="lineNum">    1248 </span><span class="lineNoCov">          0 :     modules.push_back(rtp_rtcp);</span>
<span class="lineNum">    1249 </span>            :     // Receive statistics and remote bitrate estimator should only be set for
<span class="lineNum">    1250 </span>            :     // the primary (first) module.
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :     configuration.receive_statistics = null_receive_statistics;</span>
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :     configuration.remote_bitrate_estimator = nullptr;</span>
<span class="lineNum">    1253 </span>            :   }
<span class="lineNum">    1254 </span><span class="lineNoCov">          0 :   return modules;</span>
<a name="1255"><span class="lineNum">    1255 </span>            : }</a>
<span class="lineNum">    1256 </span>            : 
<span class="lineNum">    1257 </span><span class="lineNoCov">          0 : void ViEChannel::StartDecodeThread() {</span>
<span class="lineNum">    1258 </span>            :   RTC_DCHECK(!sender_);
<span class="lineNum">    1259 </span><span class="lineNoCov">          0 :   if (decode_thread_.IsRunning())</span>
<span class="lineNum">    1260 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    1261 </span>            :   // Start the decode thread
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 :   decode_thread_.Start();</span>
<span class="lineNum">    1263 </span><span class="lineNoCov">          0 :   decode_thread_.SetPriority(rtc::kHighestPriority);</span>
<a name="1264"><span class="lineNum">    1264 </span>            : }</a>
<span class="lineNum">    1265 </span>            : 
<span class="lineNum">    1266 </span><span class="lineNoCov">          0 : void ViEChannel::StopDecodeThread() {</span>
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :   vcm_-&gt;TriggerDecoderShutdown();</span>
<span class="lineNum">    1268 </span>            : 
<span class="lineNum">    1269 </span><span class="lineNoCov">          0 :   decode_thread_.Stop();</span>
<a name="1270"><span class="lineNum">    1270 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1271 </span>            : 
<span class="lineNum">    1272 </span><span class="lineNoCov">          0 : int32_t ViEChannel::SetVoiceChannel(int32_t ve_channel_id,</span>
<span class="lineNum">    1273 </span>            :                                     VoEVideoSync* ve_sync_interface) {
<span class="lineNum">    1274 </span>            :   return vie_sync_.ConfigureSync(ve_channel_id, ve_sync_interface,
<span class="lineNum">    1275 </span><span class="lineNoCov">          0 :                                  rtp_rtcp_modules_[0],</span>
<span class="lineNum">    1276 </span><span class="lineNoCov">          0 :                                  vie_receiver_.GetRtpReceiver());</span>
<a name="1277"><span class="lineNum">    1277 </span>            : }</a>
<span class="lineNum">    1278 </span>            : 
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 : int32_t ViEChannel::VoiceChannel() {</span>
<span class="lineNum">    1280 </span><span class="lineNoCov">          0 :   return vie_sync_.VoiceChannel();</span>
<a name="1281"><span class="lineNum">    1281 </span>            : }</a>
<span class="lineNum">    1282 </span>            : 
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 : void ViEChannel::RegisterPreRenderCallback(</span>
<span class="lineNum">    1284 </span>            :     I420FrameCallback* pre_render_callback) {
<span class="lineNum">    1285 </span><span class="lineNoCov">          0 :   CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">    1286 </span><span class="lineNoCov">          0 :   pre_render_callback_ = pre_render_callback;</span>
<a name="1287"><span class="lineNum">    1287 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1288 </span>            : 
<span class="lineNum">    1289 </span><span class="lineNoCov">          0 : void ViEChannel::RegisterPreDecodeImageCallback(</span>
<span class="lineNum">    1290 </span>            :     EncodedImageCallback* pre_decode_callback) {
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :   vcm_-&gt;RegisterPreDecodeImageCallback(pre_decode_callback);</span>
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1293 </span>            : 
<a name="1294"><span class="lineNum">    1294 </span>            : // TODO(pbos): Remove OnInitializeDecoder which is called from the RTP module,</a>
<span class="lineNum">    1295 </span>            : // any decoder resetting should be handled internally within the VCM.
<span class="lineNum">    1296 </span><span class="lineNoCov">          0 : int32_t ViEChannel::OnInitializeDecoder(</span>
<span class="lineNum">    1297 </span>            :     const int8_t payload_type,
<span class="lineNum">    1298 </span>            :     const char payload_name[RTP_PAYLOAD_NAME_SIZE],
<span class="lineNum">    1299 </span>            :     const int frequency,
<span class="lineNum">    1300 </span>            :     const size_t channels,
<span class="lineNum">    1301 </span>            :     const uint32_t rate) {
<span class="lineNum">    1302 </span><span class="lineNoCov">          0 :   LOG(LS_INFO) &lt;&lt; &quot;OnInitializeDecoder &quot; &lt;&lt; static_cast&lt;int&gt;(payload_type)</span>
<span class="lineNum">    1303 </span><span class="lineNoCov">          0 :                &lt;&lt; &quot; &quot; &lt;&lt; payload_name;</span>
<span class="lineNum">    1304 </span><span class="lineNoCov">          0 :   vcm_-&gt;ResetDecoder();</span>
<span class="lineNum">    1305 </span>            : 
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 :   return 0;</span>
<a name="1307"><span class="lineNum">    1307 </span>            : }</a>
<span class="lineNum">    1308 </span>            : 
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 : void ViEChannel::OnIncomingSSRCChanged(const uint32_t ssrc) {</span>
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :   rtp_rtcp_modules_[0]-&gt;SetRemoteSSRC(ssrc);</span>
<a name="1311"><span class="lineNum">    1311 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1312 </span>            : 
<a name="1313"><span class="lineNum">    1313 </span><span class="lineNoCov">          0 : void ViEChannel::OnIncomingCSRCChanged(const uint32_t CSRC, const bool added) {}</span></a>
<span class="lineNum">    1314 </span>            : 
<span class="lineNum">    1315 </span><span class="lineNoCov">          0 : void ViEChannel::RegisterSendFrameCountObserver(</span>
<span class="lineNum">    1316 </span>            :     FrameCountObserver* observer) {
<span class="lineNum">    1317 </span><span class="lineNoCov">          0 :   send_frame_count_observer_.Set(observer);</span>
<a name="1318"><span class="lineNum">    1318 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1319 </span>            : 
<span class="lineNum">    1320 </span><span class="lineNoCov">          0 : void ViEChannel::RegisterReceiveStatisticsProxy(</span>
<span class="lineNum">    1321 </span>            :     ReceiveStatisticsProxy* receive_statistics_proxy) {
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :   CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">    1323 </span><span class="lineNoCov">          0 :   receive_stats_callback_ = receive_statistics_proxy;</span>
<a name="1324"><span class="lineNum">    1324 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1325 </span>            : 
<span class="lineNum">    1326 </span><span class="lineNoCov">          0 : void ViEChannel::SetIncomingVideoStream(</span>
<span class="lineNum">    1327 </span>            :     IncomingVideoStream* incoming_video_stream) {
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :   CriticalSectionScoped cs(crit_.get());</span>
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :   incoming_video_stream_ = incoming_video_stream;</span>
<span class="lineNum">    1330 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1331 </span>            : }  // namespace webrtc
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
