<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - toolkit/components/places/nsNavHistory.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../index.html">top level</a> - <a href="index.html">toolkit/components/places</a> - nsNavHistory.cpp<span style="font-size: 80%;"> (source / <a href="nsNavHistory.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1345</td>
            <td class="headerCovTableEntry">1594</td>
            <td class="headerCovTableEntryMed">84.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21 12:59:10</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">113</td>
            <td class="headerCovTableEntry">134</td>
            <td class="headerCovTableEntryMed">84.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* vim: set ts=8 sts=2 et sw=2 tw=80: */
<span class="lineNum">       3 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       4 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       5 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            : #include &lt;stdio.h&gt;
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : #include &quot;mozilla/DebugOnly.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;mozilla/IntegerPrintfMacros.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;mozilla/SizePrintfMacros.h&quot;
<span class="lineNum">      12 </span>            : 
<span class="lineNum">      13 </span>            : #include &quot;nsNavHistory.h&quot;
<span class="lineNum">      14 </span>            : 
<span class="lineNum">      15 </span>            : #include &quot;mozIPlacesAutoComplete.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;nsNavBookmarks.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;nsAnnotationService.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;nsFaviconService.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;nsPlacesMacros.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;DateTimeFormat.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;History.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;Helpers.h&quot;
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : #include &quot;nsTArray.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;nsCollationCID.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;nsNetUtil.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;nsPrintfCString.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;nsPromiseFlatString.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;nsString.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;nsUnicharUtils.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;prsystem.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;prtime.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;nsEscape.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;nsIEffectiveTLDService.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;nsIClassInfoImpl.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;nsIIDNService.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;nsThreadUtils.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;nsAppDirectoryServiceDefs.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;nsMathUtils.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;mozilla/storage.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;mozilla/Preferences.h&quot;
<span class="lineNum">      42 </span>            : #include &lt;algorithm&gt;
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            : #ifdef MOZ_XUL
<span class="lineNum">      45 </span>            : #include &quot;nsIAutoCompleteInput.h&quot;
<span class="lineNum">      46 </span>            : #include &quot;nsIAutoCompletePopup.h&quot;
<span class="lineNum">      47 </span>            : #endif
<span class="lineNum">      48 </span>            : 
<span class="lineNum">      49 </span>            : using namespace mozilla;
<span class="lineNum">      50 </span>            : using namespace mozilla::places;
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span>            : // The maximum number of things that we will store in the recent events list
<span class="lineNum">      53 </span>            : // before calling ExpireNonrecentEvents. This number should be big enough so it
<span class="lineNum">      54 </span>            : // is very difficult to get that many unconsumed events (for example, typed but
<span class="lineNum">      55 </span>            : // never visited) in the RECENT_EVENT_THRESHOLD. Otherwise, we'll start
<span class="lineNum">      56 </span>            : // checking each one for every page visit, which will be somewhat slower.
<span class="lineNum">      57 </span>            : #define RECENT_EVENT_QUEUE_MAX_LENGTH 128
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span>            : // preference ID strings
<span class="lineNum">      60 </span>            : #define PREF_HISTORY_ENABLED                    &quot;places.history.enabled&quot;
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span>            : #define PREF_FREC_NUM_VISITS                    &quot;places.frecency.numVisits&quot;
<span class="lineNum">      63 </span>            : #define PREF_FREC_NUM_VISITS_DEF                10
<span class="lineNum">      64 </span>            : #define PREF_FREC_FIRST_BUCKET_CUTOFF           &quot;places.frecency.firstBucketCutoff&quot;
<span class="lineNum">      65 </span>            : #define PREF_FREC_FIRST_BUCKET_CUTOFF_DEF       4
<span class="lineNum">      66 </span>            : #define PREF_FREC_SECOND_BUCKET_CUTOFF          &quot;places.frecency.secondBucketCutoff&quot;
<span class="lineNum">      67 </span>            : #define PREF_FREC_SECOND_BUCKET_CUTOFF_DEF      14
<span class="lineNum">      68 </span>            : #define PREF_FREC_THIRD_BUCKET_CUTOFF           &quot;places.frecency.thirdBucketCutoff&quot;
<span class="lineNum">      69 </span>            : #define PREF_FREC_THIRD_BUCKET_CUTOFF_DEF       31
<span class="lineNum">      70 </span>            : #define PREF_FREC_FOURTH_BUCKET_CUTOFF          &quot;places.frecency.fourthBucketCutoff&quot;
<span class="lineNum">      71 </span>            : #define PREF_FREC_FOURTH_BUCKET_CUTOFF_DEF      90
<span class="lineNum">      72 </span>            : #define PREF_FREC_FIRST_BUCKET_WEIGHT           &quot;places.frecency.firstBucketWeight&quot;
<span class="lineNum">      73 </span>            : #define PREF_FREC_FIRST_BUCKET_WEIGHT_DEF       100
<span class="lineNum">      74 </span>            : #define PREF_FREC_SECOND_BUCKET_WEIGHT          &quot;places.frecency.secondBucketWeight&quot;
<span class="lineNum">      75 </span>            : #define PREF_FREC_SECOND_BUCKET_WEIGHT_DEF      70
<span class="lineNum">      76 </span>            : #define PREF_FREC_THIRD_BUCKET_WEIGHT           &quot;places.frecency.thirdBucketWeight&quot;
<span class="lineNum">      77 </span>            : #define PREF_FREC_THIRD_BUCKET_WEIGHT_DEF       50
<span class="lineNum">      78 </span>            : #define PREF_FREC_FOURTH_BUCKET_WEIGHT          &quot;places.frecency.fourthBucketWeight&quot;
<span class="lineNum">      79 </span>            : #define PREF_FREC_FOURTH_BUCKET_WEIGHT_DEF      30
<span class="lineNum">      80 </span>            : #define PREF_FREC_DEFAULT_BUCKET_WEIGHT         &quot;places.frecency.defaultBucketWeight&quot;
<span class="lineNum">      81 </span>            : #define PREF_FREC_DEFAULT_BUCKET_WEIGHT_DEF     10
<span class="lineNum">      82 </span>            : #define PREF_FREC_EMBED_VISIT_BONUS             &quot;places.frecency.embedVisitBonus&quot;
<span class="lineNum">      83 </span>            : #define PREF_FREC_EMBED_VISIT_BONUS_DEF         0
<span class="lineNum">      84 </span>            : #define PREF_FREC_FRAMED_LINK_VISIT_BONUS       &quot;places.frecency.framedLinkVisitBonus&quot;
<span class="lineNum">      85 </span>            : #define PREF_FREC_FRAMED_LINK_VISIT_BONUS_DEF   0
<span class="lineNum">      86 </span>            : #define PREF_FREC_LINK_VISIT_BONUS              &quot;places.frecency.linkVisitBonus&quot;
<span class="lineNum">      87 </span>            : #define PREF_FREC_LINK_VISIT_BONUS_DEF          100
<span class="lineNum">      88 </span>            : #define PREF_FREC_TYPED_VISIT_BONUS             &quot;places.frecency.typedVisitBonus&quot;
<span class="lineNum">      89 </span>            : #define PREF_FREC_TYPED_VISIT_BONUS_DEF         2000
<span class="lineNum">      90 </span>            : #define PREF_FREC_BOOKMARK_VISIT_BONUS          &quot;places.frecency.bookmarkVisitBonus&quot;
<span class="lineNum">      91 </span>            : #define PREF_FREC_BOOKMARK_VISIT_BONUS_DEF      75
<span class="lineNum">      92 </span>            : #define PREF_FREC_DOWNLOAD_VISIT_BONUS          &quot;places.frecency.downloadVisitBonus&quot;
<span class="lineNum">      93 </span>            : #define PREF_FREC_DOWNLOAD_VISIT_BONUS_DEF      0
<span class="lineNum">      94 </span>            : #define PREF_FREC_PERM_REDIRECT_VISIT_BONUS     &quot;places.frecency.permRedirectVisitBonus&quot;
<span class="lineNum">      95 </span>            : #define PREF_FREC_PERM_REDIRECT_VISIT_BONUS_DEF 0
<span class="lineNum">      96 </span>            : #define PREF_FREC_TEMP_REDIRECT_VISIT_BONUS     &quot;places.frecency.tempRedirectVisitBonus&quot;
<span class="lineNum">      97 </span>            : #define PREF_FREC_TEMP_REDIRECT_VISIT_BONUS_DEF 0
<span class="lineNum">      98 </span>            : #define PREF_FREC_REDIR_SOURCE_VISIT_BONUS      &quot;places.frecency.redirectSourceVisitBonus&quot;
<span class="lineNum">      99 </span>            : #define PREF_FREC_REDIR_SOURCE_VISIT_BONUS_DEF  25
<span class="lineNum">     100 </span>            : #define PREF_FREC_DEFAULT_VISIT_BONUS           &quot;places.frecency.defaultVisitBonus&quot;
<span class="lineNum">     101 </span>            : #define PREF_FREC_DEFAULT_VISIT_BONUS_DEF       0
<span class="lineNum">     102 </span>            : #define PREF_FREC_UNVISITED_BOOKMARK_BONUS      &quot;places.frecency.unvisitedBookmarkBonus&quot;
<span class="lineNum">     103 </span>            : #define PREF_FREC_UNVISITED_BOOKMARK_BONUS_DEF  140
<span class="lineNum">     104 </span>            : #define PREF_FREC_UNVISITED_TYPED_BONUS         &quot;places.frecency.unvisitedTypedBonus&quot;
<span class="lineNum">     105 </span>            : #define PREF_FREC_UNVISITED_TYPED_BONUS_DEF     200
<span class="lineNum">     106 </span>            : #define PREF_FREC_RELOAD_VISIT_BONUS            &quot;places.frecency.reloadVisitBonus&quot;
<span class="lineNum">     107 </span>            : #define PREF_FREC_RELOAD_VISIT_BONUS_DEF        0
<span class="lineNum">     108 </span>            : 
<span class="lineNum">     109 </span>            : // This is a 'hidden' pref for the purposes of unit tests.
<span class="lineNum">     110 </span>            : #define PREF_FREC_DECAY_RATE     &quot;places.frecency.decayRate&quot;
<span class="lineNum">     111 </span>            : #define PREF_FREC_DECAY_RATE_DEF 0.975f
<span class="lineNum">     112 </span>            : 
<span class="lineNum">     113 </span>            : // In order to avoid calling PR_now() too often we use a cached &quot;now&quot; value
<span class="lineNum">     114 </span>            : // for repeating stuff.  These are milliseconds between &quot;now&quot; cache refreshes.
<span class="lineNum">     115 </span>            : #define RENEW_CACHED_NOW_TIMEOUT ((int32_t)3 * PR_MSEC_PER_SEC)
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span>            : // character-set annotation
<span class="lineNum">     118 </span>            : #define CHARSET_ANNO NS_LITERAL_CSTRING(&quot;URIProperties/characterSet&quot;)
<span class="lineNum">     119 </span>            : 
<span class="lineNum">     120 </span>            : // These macros are used when splitting history by date.
<span class="lineNum">     121 </span>            : // These are the day containers and catch-all final container.
<span class="lineNum">     122 </span>            : #define HISTORY_ADDITIONAL_DATE_CONT_NUM 3
<span class="lineNum">     123 </span>            : // We use a guess of the number of months considering all of them 30 days
<span class="lineNum">     124 </span>            : // long, but we split only the last 6 months.
<span class="lineNum">     125 </span>            : #define HISTORY_DATE_CONT_NUM(_daysFromOldestVisit) \
<span class="lineNum">     126 </span>            :   (HISTORY_ADDITIONAL_DATE_CONT_NUM + \
<span class="lineNum">     127 </span>            :    std::min(6, (int32_t)ceilf((float)_daysFromOldestVisit/30)))
<span class="lineNum">     128 </span>            : // Max number of containers, used to initialize the params hash.
<span class="lineNum">     129 </span>            : #define HISTORY_DATE_CONT_LENGTH 8
<span class="lineNum">     130 </span>            : 
<span class="lineNum">     131 </span>            : // Initial length of the embed visits cache.
<span class="lineNum">     132 </span>            : #define EMBED_VISITS_INITIAL_CACHE_LENGTH 64
<span class="lineNum">     133 </span>            : 
<span class="lineNum">     134 </span>            : // Initial length of the recent events cache.
<span class="lineNum">     135 </span>            : #define RECENT_EVENTS_INITIAL_CACHE_LENGTH 64
<span class="lineNum">     136 </span>            : 
<span class="lineNum">     137 </span>            : // Observed topics.
<span class="lineNum">     138 </span>            : #ifdef MOZ_XUL
<span class="lineNum">     139 </span>            : #define TOPIC_AUTOCOMPLETE_FEEDBACK_INCOMING &quot;autocomplete-will-enter-text&quot;
<span class="lineNum">     140 </span>            : #endif
<span class="lineNum">     141 </span>            : #define TOPIC_IDLE_DAILY &quot;idle-daily&quot;
<span class="lineNum">     142 </span>            : #define TOPIC_PREF_CHANGED &quot;nsPref:changed&quot;
<span class="lineNum">     143 </span>            : #define TOPIC_PROFILE_TEARDOWN &quot;profile-change-teardown&quot;
<span class="lineNum">     144 </span>            : #define TOPIC_PROFILE_CHANGE &quot;profile-before-change&quot;
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span>            : static const char* kObservedPrefs[] = {
<span class="lineNum">     147 </span>            :   PREF_HISTORY_ENABLED
<span class="lineNum">     148 </span>            : , PREF_FREC_NUM_VISITS
<span class="lineNum">     149 </span>            : , PREF_FREC_FIRST_BUCKET_CUTOFF
<span class="lineNum">     150 </span>            : , PREF_FREC_SECOND_BUCKET_CUTOFF
<span class="lineNum">     151 </span>            : , PREF_FREC_THIRD_BUCKET_CUTOFF
<span class="lineNum">     152 </span>            : , PREF_FREC_FOURTH_BUCKET_CUTOFF
<span class="lineNum">     153 </span>            : , PREF_FREC_FIRST_BUCKET_WEIGHT
<span class="lineNum">     154 </span>            : , PREF_FREC_SECOND_BUCKET_WEIGHT
<span class="lineNum">     155 </span>            : , PREF_FREC_THIRD_BUCKET_WEIGHT
<span class="lineNum">     156 </span>            : , PREF_FREC_FOURTH_BUCKET_WEIGHT
<span class="lineNum">     157 </span>            : , PREF_FREC_DEFAULT_BUCKET_WEIGHT
<span class="lineNum">     158 </span>            : , PREF_FREC_EMBED_VISIT_BONUS
<span class="lineNum">     159 </span>            : , PREF_FREC_FRAMED_LINK_VISIT_BONUS
<span class="lineNum">     160 </span>            : , PREF_FREC_LINK_VISIT_BONUS
<span class="lineNum">     161 </span>            : , PREF_FREC_TYPED_VISIT_BONUS
<span class="lineNum">     162 </span>            : , PREF_FREC_BOOKMARK_VISIT_BONUS
<span class="lineNum">     163 </span>            : , PREF_FREC_DOWNLOAD_VISIT_BONUS
<span class="lineNum">     164 </span>            : , PREF_FREC_PERM_REDIRECT_VISIT_BONUS
<span class="lineNum">     165 </span>            : , PREF_FREC_TEMP_REDIRECT_VISIT_BONUS
<span class="lineNum">     166 </span>            : , PREF_FREC_REDIR_SOURCE_VISIT_BONUS
<span class="lineNum">     167 </span>            : , PREF_FREC_DEFAULT_VISIT_BONUS
<span class="lineNum">     168 </span>            : , PREF_FREC_UNVISITED_BOOKMARK_BONUS
<span class="lineNum">     169 </span>            : , PREF_FREC_UNVISITED_TYPED_BONUS
<span class="lineNum">     170 </span>            : , nullptr
<a name="171"><span class="lineNum">     171 </span>            : };</a>
<a name="172"><span class="lineNum">     172 </span>            : </a>
<span class="lineNum">     173 </span><span class="lineCov">          1 : NS_IMPL_ADDREF(nsNavHistory)</span>
<span class="lineNum">     174 </span><span class="lineCov">          1 : NS_IMPL_RELEASE(nsNavHistory)</span>
<span class="lineNum">     175 </span>            : 
<a name="176"><span class="lineNum">     176 </span>            : NS_IMPL_CLASSINFO(nsNavHistory, nullptr, nsIClassInfo::SINGLETON,</a>
<span class="lineNum">     177 </span>            :                   NS_NAVHISTORYSERVICE_CID)
<span class="lineNum">     178 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_BEGIN(nsNavHistory)</span>
<span class="lineNum">     179 </span><span class="lineCov">          1 :   NS_INTERFACE_MAP_ENTRY(nsINavHistoryService)</span>
<span class="lineNum">     180 </span><span class="lineCov">          1 :   NS_INTERFACE_MAP_ENTRY(nsIBrowserHistory)</span>
<span class="lineNum">     181 </span><span class="lineCov">          1 :   NS_INTERFACE_MAP_ENTRY(nsIObserver)</span>
<span class="lineNum">     182 </span><span class="lineCov">          1 :   NS_INTERFACE_MAP_ENTRY(nsISupportsWeakReference)</span>
<span class="lineNum">     183 </span><span class="lineCov">          1 :   NS_INTERFACE_MAP_ENTRY(nsPIPlacesDatabase)</span>
<span class="lineNum">     184 </span><span class="lineCov">          1 :   NS_INTERFACE_MAP_ENTRY(mozIStorageVacuumParticipant)</span>
<span class="lineNum">     185 </span><span class="lineCov">          1 :   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsINavHistoryService)</span>
<span class="lineNum">     186 </span><span class="lineCov">          1 :   NS_IMPL_QUERY_CLASSINFO(nsNavHistory)</span>
<span class="lineNum">     187 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_END</span>
<a name="188"><span class="lineNum">     188 </span>            : </a>
<span class="lineNum">     189 </span>            : // We don't care about flattening everything
<span class="lineNum">     190 </span><span class="lineCov">          1 : NS_IMPL_CI_INTERFACE_GETTER(nsNavHistory,</span>
<span class="lineNum">     191 </span>            :                             nsINavHistoryService,
<span class="lineNum">     192 </span>            :                             nsIBrowserHistory)
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span>            : namespace {
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span>            : static int64_t GetSimpleBookmarksQueryFolder(
<span class="lineNum">     197 </span>            :     const nsCOMArray&lt;nsNavHistoryQuery&gt;&amp; aQueries,
<span class="lineNum">     198 </span>            :     nsNavHistoryQueryOptions* aOptions);
<span class="lineNum">     199 </span>            : static void ParseSearchTermsFromQueries(const nsCOMArray&lt;nsNavHistoryQuery&gt;&amp; aQueries,
<a name="200"><span class="lineNum">     200 </span>            :                                         nsTArray&lt;nsTArray&lt;nsString&gt;*&gt;* aTerms);</a>
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span><span class="lineCov">          1 : void GetTagsSqlFragment(int64_t aTagsFolder,</span>
<span class="lineNum">     203 </span>            :                         const nsACString&amp; aRelation,
<span class="lineNum">     204 </span>            :                         bool aHasSearchTerms,
<span class="lineNum">     205 </span>            :                         nsACString&amp; _sqlFragment) {
<span class="lineNum">     206 </span><span class="lineCov">          1 :   if (!aHasSearchTerms)</span>
<span class="lineNum">     207 </span><span class="lineCov">          1 :     _sqlFragment.AssignLiteral(&quot;null&quot;);</span>
<span class="lineNum">     208 </span>            :   else {
<span class="lineNum">     209 </span>            :     // This subquery DOES NOT order tags for performance reasons.
<span class="lineNum">     210 </span>            :     _sqlFragment.Assign(NS_LITERAL_CSTRING(
<span class="lineNum">     211 </span>            :          &quot;(SELECT GROUP_CONCAT(t_t.title, ',') &quot;
<span class="lineNum">     212 </span>            :            &quot;FROM moz_bookmarks b_t &quot;
<span class="lineNum">     213 </span>            :            &quot;JOIN moz_bookmarks t_t ON t_t.id = +b_t.parent  &quot;
<span class="lineNum">     214 </span><span class="lineCov">          1 :            &quot;WHERE b_t.fk = &quot;) + aRelation + NS_LITERAL_CSTRING(&quot; &quot;</span>
<span class="lineNum">     215 </span><span class="lineCov">          1 :            &quot;AND t_t.parent = &quot;) +</span>
<span class="lineNum">     216 </span><span class="lineCov">          1 :            nsPrintfCString(&quot;%&quot; PRId64, aTagsFolder) + NS_LITERAL_CSTRING(&quot; &quot;</span>
<span class="lineNum">     217 </span><span class="lineCov">          1 :          &quot;)&quot;));</span>
<span class="lineNum">     218 </span>            :   }
<span class="lineNum">     219 </span>            : 
<span class="lineNum">     220 </span><span class="lineCov">          1 :   _sqlFragment.AppendLiteral(&quot; AS tags &quot;);</span>
<span class="lineNum">     221 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     222 </span>            : 
<span class="lineNum">     223 </span>            : /**
<span class="lineNum">     224 </span>            :  * This class sets begin/end of batch updates to correspond to C++ scopes so
<span class="lineNum">     225 </span>            :  * we can be sure end always gets called.
<span class="lineNum">     226 </span>            :  */
<span class="lineNum">     227 </span>            : class UpdateBatchScoper
<span class="lineNum">     228 </span>            : {
<span class="lineNum">     229 </span>            : public:
<span class="lineNum">     230 </span><span class="lineCov">          1 :   explicit UpdateBatchScoper(nsNavHistory&amp; aNavHistory) : mNavHistory(aNavHistory)</span>
<span class="lineNum">     231 </span>            :   {
<a name="232"><span class="lineNum">     232 </span><span class="lineCov">          1 :     mNavHistory.BeginUpdateBatch();</span></a>
<span class="lineNum">     233 </span>            :   }
<span class="lineNum">     234 </span><span class="lineCov">          1 :   ~UpdateBatchScoper()</span>
<span class="lineNum">     235 </span>            :   {
<span class="lineNum">     236 </span><span class="lineCov">          1 :     mNavHistory.EndUpdateBatch();</span>
<span class="lineNum">     237 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     238 </span>            : protected:
<span class="lineNum">     239 </span>            :   nsNavHistory&amp; mNavHistory;
<span class="lineNum">     240 </span>            : };
<span class="lineNum">     241 </span>            : 
<span class="lineNum">     242 </span>            : } // namespace
<span class="lineNum">     243 </span>            : 
<span class="lineNum">     244 </span>            : 
<span class="lineNum">     245 </span>            : // Queries rows indexes to bind or get values, if adding a new one, be sure to
<span class="lineNum">     246 </span>            : // update nsNavBookmarks statements and its kGetChildrenIndex_* constants
<span class="lineNum">     247 </span>            : const int32_t nsNavHistory::kGetInfoIndex_PageID = 0;
<span class="lineNum">     248 </span>            : const int32_t nsNavHistory::kGetInfoIndex_URL = 1;
<span class="lineNum">     249 </span>            : const int32_t nsNavHistory::kGetInfoIndex_Title = 2;
<span class="lineNum">     250 </span>            : const int32_t nsNavHistory::kGetInfoIndex_RevHost = 3;
<span class="lineNum">     251 </span>            : const int32_t nsNavHistory::kGetInfoIndex_VisitCount = 4;
<span class="lineNum">     252 </span>            : const int32_t nsNavHistory::kGetInfoIndex_VisitDate = 5;
<span class="lineNum">     253 </span>            : const int32_t nsNavHistory::kGetInfoIndex_FaviconURL = 6;
<span class="lineNum">     254 </span>            : const int32_t nsNavHistory::kGetInfoIndex_ItemId = 7;
<span class="lineNum">     255 </span>            : const int32_t nsNavHistory::kGetInfoIndex_ItemDateAdded = 8;
<span class="lineNum">     256 </span>            : const int32_t nsNavHistory::kGetInfoIndex_ItemLastModified = 9;
<span class="lineNum">     257 </span>            : const int32_t nsNavHistory::kGetInfoIndex_ItemParentId = 10;
<span class="lineNum">     258 </span>            : const int32_t nsNavHistory::kGetInfoIndex_ItemTags = 11;
<span class="lineNum">     259 </span>            : const int32_t nsNavHistory::kGetInfoIndex_Frecency = 12;
<span class="lineNum">     260 </span>            : const int32_t nsNavHistory::kGetInfoIndex_Hidden = 13;
<span class="lineNum">     261 </span>            : const int32_t nsNavHistory::kGetInfoIndex_Guid = 14;
<span class="lineNum">     262 </span>            : const int32_t nsNavHistory::kGetInfoIndex_VisitId = 15;
<span class="lineNum">     263 </span>            : const int32_t nsNavHistory::kGetInfoIndex_FromVisitId = 16;
<span class="lineNum">     264 </span>            : const int32_t nsNavHistory::kGetInfoIndex_VisitType = 17;
<span class="lineNum">     265 </span>            : // These columns are followed by corresponding constants in nsNavBookmarks.cpp,
<span class="lineNum">     266 </span>            : // which must be kept in sync:
<span class="lineNum">     267 </span>            : // nsNavBookmarks::kGetChildrenIndex_Guid = 18;
<span class="lineNum">     268 </span>            : // nsNavBookmarks::kGetChildrenIndex_Position = 19;
<span class="lineNum">     269 </span>            : // nsNavBookmarks::kGetChildrenIndex_Type = 20;
<a name="270"><span class="lineNum">     270 </span>            : // nsNavBookmarks::kGetChildrenIndex_PlaceID = 21;</a>
<span class="lineNum">     271 </span>            : 
<span class="lineNum">     272 </span><span class="lineCov">          1 : PLACES_FACTORY_SINGLETON_IMPLEMENTATION(nsNavHistory, gHistoryService)</span>
<a name="273"><span class="lineNum">     273 </span>            : </a>
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span><span class="lineCov">          1 : nsNavHistory::nsNavHistory()</span>
<span class="lineNum">     276 </span>            :   : mBatchLevel(0)
<span class="lineNum">     277 </span>            :   , mBatchDBTransaction(nullptr)
<span class="lineNum">     278 </span>            :   , mCachedNow(0)
<span class="lineNum">     279 </span>            :   , mRecentTyped(RECENT_EVENTS_INITIAL_CACHE_LENGTH)
<span class="lineNum">     280 </span>            :   , mRecentLink(RECENT_EVENTS_INITIAL_CACHE_LENGTH)
<span class="lineNum">     281 </span>            :   , mRecentBookmark(RECENT_EVENTS_INITIAL_CACHE_LENGTH)
<span class="lineNum">     282 </span>            :   , mEmbedVisits(EMBED_VISITS_INITIAL_CACHE_LENGTH)
<span class="lineNum">     283 </span>            :   , mHistoryEnabled(true)
<span class="lineNum">     284 </span>            :   , mNumVisitsForFrecency(10)
<span class="lineNum">     285 </span>            :   , mTagsFolder(-1)
<span class="lineNum">     286 </span>            :   , mDaysOfHistory(-1)
<span class="lineNum">     287 </span>            :   , mLastCachedStartOfDay(INT64_MAX)
<span class="lineNum">     288 </span>            :   , mLastCachedEndOfDay(0)
<span class="lineNum">     289 </span>            :   , mCanNotify(true)
<span class="lineNum">     290 </span><span class="lineCov">          1 :   , mCacheObservers(&quot;history-observers&quot;)</span>
<span class="lineNum">     291 </span>            : {
<span class="lineNum">     292 </span>            :   NS_ASSERTION(!gHistoryService,
<span class="lineNum">     293 </span>            :                &quot;Attempting to create two instances of the service!&quot;);
<span class="lineNum">     294 </span><span class="lineCov">          1 :   gHistoryService = this;</span>
<span class="lineNum">     295 </span><span class="lineCov">          1 : }</span>
<a name="296"><span class="lineNum">     296 </span>            : </a>
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span><span class="lineNoCov">          0 : nsNavHistory::~nsNavHistory()</span>
<span class="lineNum">     299 </span>            : {
<span class="lineNum">     300 </span>            :   // remove the static reference to the service. Check to make sure its us
<span class="lineNum">     301 </span>            :   // in case somebody creates an extra instance of the service.
<span class="lineNum">     302 </span>            :   NS_ASSERTION(gHistoryService == this,
<span class="lineNum">     303 </span>            :                &quot;Deleting a non-singleton instance of the service&quot;);
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :   if (gHistoryService == this)</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :     gHistoryService = nullptr;</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     307 </span>            : 
<a name="308"><span class="lineNum">     308 </span>            : </a>
<span class="lineNum">     309 </span>            : nsresult
<span class="lineNum">     310 </span><span class="lineCov">          1 : nsNavHistory::Init()</span>
<span class="lineNum">     311 </span>            : {
<span class="lineNum">     312 </span><span class="lineCov">          1 :   LoadPrefs();</span>
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span><span class="lineCov">          1 :   mDB = Database::GetDatabase();</span>
<span class="lineNum">     315 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(mDB);</span>
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span>            :   /*****************************************************************************
<span class="lineNum">     318 </span>            :    *** IMPORTANT NOTICE!
<span class="lineNum">     319 </span>            :    ***
<span class="lineNum">     320 </span>            :    *** Nothing after these add observer calls should return anything but NS_OK.
<span class="lineNum">     321 </span>            :    *** If a failure code is returned, this nsNavHistory object will be held onto
<span class="lineNum">     322 </span>            :    *** by the observer service and the preference service.
<span class="lineNum">     323 </span>            :    ****************************************************************************/
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span>            :   // Observe preferences changes.
<span class="lineNum">     326 </span><span class="lineCov">          1 :   Preferences::AddWeakObservers(this, kObservedPrefs);</span>
<span class="lineNum">     327 </span>            : 
<span class="lineNum">     328 </span><span class="lineCov">          1 :   nsCOMPtr&lt;nsIObserverService&gt; obsSvc = services::GetObserverService();</span>
<span class="lineNum">     329 </span><span class="lineCov">          1 :   if (obsSvc) {</span>
<span class="lineNum">     330 </span><span class="lineCov">          1 :     (void)obsSvc-&gt;AddObserver(this, TOPIC_PLACES_CONNECTION_CLOSED, true);</span>
<span class="lineNum">     331 </span><span class="lineCov">          1 :     (void)obsSvc-&gt;AddObserver(this, TOPIC_IDLE_DAILY, true);</span>
<span class="lineNum">     332 </span>            : #ifdef MOZ_XUL
<span class="lineNum">     333 </span><span class="lineCov">          1 :     (void)obsSvc-&gt;AddObserver(this, TOPIC_AUTOCOMPLETE_FEEDBACK_INCOMING, true);</span>
<span class="lineNum">     334 </span>            : #endif
<span class="lineNum">     335 </span>            :   }
<span class="lineNum">     336 </span>            : 
<span class="lineNum">     337 </span>            :   // Don't add code that can fail here! Do it up above, before we add our
<span class="lineNum">     338 </span>            :   // observers.
<span class="lineNum">     339 </span>            : 
<span class="lineNum">     340 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">     341 </span>            : }
<a name="342"><span class="lineNum">     342 </span>            : </a>
<span class="lineNum">     343 </span>            : NS_IMETHODIMP
<span class="lineNum">     344 </span><span class="lineCov">          1 : nsNavHistory::GetDatabaseStatus(uint16_t *aDatabaseStatus)</span>
<span class="lineNum">     345 </span>            : {
<span class="lineNum">     346 </span><span class="lineCov">          1 :   NS_ENSURE_ARG_POINTER(aDatabaseStatus);</span>
<span class="lineNum">     347 </span><span class="lineCov">          1 :   *aDatabaseStatus = mDB-&gt;GetDatabaseStatus();</span>
<span class="lineNum">     348 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">     349 </span>            : }
<a name="350"><span class="lineNum">     350 </span>            : </a>
<span class="lineNum">     351 </span>            : uint32_t
<span class="lineNum">     352 </span><span class="lineCov">          1 : nsNavHistory::GetRecentFlags(nsIURI *aURI)</span>
<span class="lineNum">     353 </span>            : {
<span class="lineNum">     354 </span><span class="lineCov">          1 :   uint32_t result = 0;</span>
<span class="lineNum">     355 </span><span class="lineCov">          1 :   nsAutoCString spec;</span>
<span class="lineNum">     356 </span><span class="lineCov">          1 :   nsresult rv = aURI-&gt;GetSpec(spec);</span>
<span class="lineNum">     357 </span>            :   NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;Unable to get aURI's spec&quot;);
<span class="lineNum">     358 </span>            : 
<span class="lineNum">     359 </span><span class="lineCov">          1 :   if (NS_SUCCEEDED(rv)) {</span>
<span class="lineNum">     360 </span><span class="lineCov">          1 :     if (CheckIsRecentEvent(&amp;mRecentTyped, spec))</span>
<span class="lineNum">     361 </span><span class="lineCov">          1 :       result |= RECENT_TYPED;</span>
<span class="lineNum">     362 </span><span class="lineCov">          1 :     if (CheckIsRecentEvent(&amp;mRecentLink, spec))</span>
<span class="lineNum">     363 </span><span class="lineCov">          1 :       result |= RECENT_ACTIVATED;</span>
<span class="lineNum">     364 </span><span class="lineCov">          1 :     if (CheckIsRecentEvent(&amp;mRecentBookmark, spec))</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :       result |= RECENT_BOOKMARKED;</span>
<span class="lineNum">     366 </span>            :   }
<span class="lineNum">     367 </span>            : 
<span class="lineNum">     368 </span><span class="lineCov">          1 :   return result;</span>
<span class="lineNum">     369 </span>            : }
<a name="370"><span class="lineNum">     370 </span>            : </a>
<span class="lineNum">     371 </span>            : nsresult
<span class="lineNum">     372 </span><span class="lineCov">          1 : nsNavHistory::GetIdForPage(nsIURI* aURI,</span>
<span class="lineNum">     373 </span>            :                            int64_t* _pageId,
<span class="lineNum">     374 </span>            :                            nsCString&amp; _GUID)
<span class="lineNum">     375 </span>            : {
<span class="lineNum">     376 </span><span class="lineCov">          1 :   *_pageId = 0;</span>
<span class="lineNum">     377 </span>            : 
<span class="lineNum">     378 </span>            :   nsCOMPtr&lt;mozIStorageStatement&gt; stmt = mDB-&gt;GetStatement(
<span class="lineNum">     379 </span>            :     &quot;SELECT id, url, title, rev_host, visit_count, guid &quot;
<span class="lineNum">     380 </span>            :     &quot;FROM moz_places &quot;
<span class="lineNum">     381 </span>            :     &quot;WHERE url_hash = hash(:page_url) AND url = :page_url &quot;
<span class="lineNum">     382 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">     383 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(stmt);</span>
<span class="lineNum">     384 </span><span class="lineCov">          1 :   mozStorageStatementScoper scoper(stmt);</span>
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span><span class="lineCov">          1 :   nsresult rv = URIBinder::Bind(stmt, NS_LITERAL_CSTRING(&quot;page_url&quot;), aURI);</span>
<span class="lineNum">     387 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span><span class="lineCov">          1 :   bool hasEntry = false;</span>
<span class="lineNum">     390 </span><span class="lineCov">          1 :   rv = stmt-&gt;ExecuteStep(&amp;hasEntry);</span>
<span class="lineNum">     391 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     392 </span>            : 
<span class="lineNum">     393 </span><span class="lineCov">          1 :   if (hasEntry) {</span>
<span class="lineNum">     394 </span><span class="lineCov">          1 :     rv = stmt-&gt;GetInt64(0, _pageId);</span>
<span class="lineNum">     395 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     396 </span><span class="lineCov">          1 :     rv = stmt-&gt;GetUTF8String(5, _GUID);</span>
<span class="lineNum">     397 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     398 </span>            :   }
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span>            :   return NS_OK;
<span class="lineNum">     401 </span>            : }
<a name="402"><span class="lineNum">     402 </span>            : </a>
<span class="lineNum">     403 </span>            : nsresult
<span class="lineNum">     404 </span><span class="lineCov">          1 : nsNavHistory::GetOrCreateIdForPage(nsIURI* aURI,</span>
<span class="lineNum">     405 </span>            :                                    int64_t* _pageId,
<span class="lineNum">     406 </span>            :                                    nsCString&amp; _GUID)
<span class="lineNum">     407 </span>            : {
<span class="lineNum">     408 </span><span class="lineCov">          1 :   nsresult rv = GetIdForPage(aURI, _pageId, _GUID);</span>
<span class="lineNum">     409 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     410 </span>            : 
<span class="lineNum">     411 </span><span class="lineCov">          1 :   if (*_pageId != 0) {</span>
<span class="lineNum">     412 </span>            :     return NS_OK;
<span class="lineNum">     413 </span>            :   }
<span class="lineNum">     414 </span>            : 
<span class="lineNum">     415 </span>            :   // Create a new hidden, untyped and unvisited entry.
<span class="lineNum">     416 </span>            :   nsCOMPtr&lt;mozIStorageStatement&gt; stmt = mDB-&gt;GetStatement(
<span class="lineNum">     417 </span>            :     &quot;INSERT INTO moz_places (url, url_hash, rev_host, hidden, frecency, guid) &quot;
<span class="lineNum">     418 </span>            :     &quot;VALUES (:page_url, hash(:page_url), :rev_host, :hidden, :frecency, :guid) &quot;
<span class="lineNum">     419 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">     420 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(stmt);</span>
<span class="lineNum">     421 </span><span class="lineCov">          1 :   mozStorageStatementScoper scoper(stmt);</span>
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span><span class="lineCov">          1 :   rv = URIBinder::Bind(stmt, NS_LITERAL_CSTRING(&quot;page_url&quot;), aURI);</span>
<span class="lineNum">     424 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     425 </span>            :   // host (reversed with trailing period)
<span class="lineNum">     426 </span><span class="lineCov">          1 :   nsAutoString revHost;</span>
<span class="lineNum">     427 </span><span class="lineCov">          1 :   rv = GetReversedHostname(aURI, revHost);</span>
<span class="lineNum">     428 </span>            :   // Not all URI types have hostnames, so this is optional.
<span class="lineNum">     429 </span><span class="lineCov">          1 :   if (NS_SUCCEEDED(rv)) {</span>
<span class="lineNum">     430 </span><span class="lineCov">          1 :     rv = stmt-&gt;BindStringByName(NS_LITERAL_CSTRING(&quot;rev_host&quot;), revHost);</span>
<span class="lineNum">     431 </span>            :   } else {
<span class="lineNum">     432 </span><span class="lineCov">          1 :     rv = stmt-&gt;BindNullByName(NS_LITERAL_CSTRING(&quot;rev_host&quot;));</span>
<span class="lineNum">     433 </span>            :   }
<span class="lineNum">     434 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     435 </span><span class="lineCov">          1 :   rv = stmt-&gt;BindInt32ByName(NS_LITERAL_CSTRING(&quot;hidden&quot;), 1);</span>
<span class="lineNum">     436 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     437 </span><span class="lineCov">          1 :   nsAutoCString spec;</span>
<span class="lineNum">     438 </span><span class="lineCov">          1 :   rv = aURI-&gt;GetSpec(spec);</span>
<span class="lineNum">     439 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     440 </span>            :   rv = stmt-&gt;BindInt32ByName(NS_LITERAL_CSTRING(&quot;frecency&quot;),
<span class="lineNum">     441 </span><span class="lineCov">          1 :                              IsQueryURI(spec) ? 0 : -1);</span>
<span class="lineNum">     442 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     443 </span><span class="lineCov">          1 :   rv = GenerateGUID(_GUID);</span>
<span class="lineNum">     444 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     445 </span><span class="lineCov">          1 :   rv = stmt-&gt;BindUTF8StringByName(NS_LITERAL_CSTRING(&quot;guid&quot;), _GUID);</span>
<span class="lineNum">     446 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     447 </span>            : 
<span class="lineNum">     448 </span><span class="lineCov">          1 :   rv = stmt-&gt;Execute();</span>
<span class="lineNum">     449 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     450 </span>            : 
<span class="lineNum">     451 </span><span class="lineCov">          1 :   *_pageId = sLastInsertedPlaceId;</span>
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">     454 </span>            : }
<span class="lineNum">     455 </span>            : 
<a name="456"><span class="lineNum">     456 </span>            : </a>
<span class="lineNum">     457 </span>            : void
<span class="lineNum">     458 </span><span class="lineCov">          1 : nsNavHistory::LoadPrefs()</span>
<span class="lineNum">     459 </span>            : {
<span class="lineNum">     460 </span>            :   // History preferences.
<span class="lineNum">     461 </span><span class="lineCov">          1 :   mHistoryEnabled = Preferences::GetBool(PREF_HISTORY_ENABLED, true);</span>
<span class="lineNum">     462 </span>            : 
<span class="lineNum">     463 </span>            :   // Frecency preferences.
<span class="lineNum">     464 </span>            : #define FRECENCY_PREF(_prop, _pref) \
<span class="lineNum">     465 </span>            :   _prop = Preferences::GetInt(_pref, _pref##_DEF)
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span><span class="lineCov">          1 :   FRECENCY_PREF(mNumVisitsForFrecency,     PREF_FREC_NUM_VISITS);</span>
<span class="lineNum">     468 </span><span class="lineCov">          1 :   FRECENCY_PREF(mFirstBucketCutoffInDays,  PREF_FREC_FIRST_BUCKET_CUTOFF);</span>
<span class="lineNum">     469 </span><span class="lineCov">          1 :   FRECENCY_PREF(mSecondBucketCutoffInDays, PREF_FREC_SECOND_BUCKET_CUTOFF);</span>
<span class="lineNum">     470 </span><span class="lineCov">          1 :   FRECENCY_PREF(mThirdBucketCutoffInDays,  PREF_FREC_THIRD_BUCKET_CUTOFF);</span>
<span class="lineNum">     471 </span><span class="lineCov">          1 :   FRECENCY_PREF(mFourthBucketCutoffInDays, PREF_FREC_FOURTH_BUCKET_CUTOFF);</span>
<span class="lineNum">     472 </span><span class="lineCov">          1 :   FRECENCY_PREF(mEmbedVisitBonus,          PREF_FREC_EMBED_VISIT_BONUS);</span>
<span class="lineNum">     473 </span><span class="lineCov">          1 :   FRECENCY_PREF(mFramedLinkVisitBonus,     PREF_FREC_FRAMED_LINK_VISIT_BONUS);</span>
<span class="lineNum">     474 </span><span class="lineCov">          1 :   FRECENCY_PREF(mLinkVisitBonus,           PREF_FREC_LINK_VISIT_BONUS);</span>
<span class="lineNum">     475 </span><span class="lineCov">          1 :   FRECENCY_PREF(mTypedVisitBonus,          PREF_FREC_TYPED_VISIT_BONUS);</span>
<span class="lineNum">     476 </span><span class="lineCov">          1 :   FRECENCY_PREF(mBookmarkVisitBonus,       PREF_FREC_BOOKMARK_VISIT_BONUS);</span>
<span class="lineNum">     477 </span><span class="lineCov">          1 :   FRECENCY_PREF(mDownloadVisitBonus,       PREF_FREC_DOWNLOAD_VISIT_BONUS);</span>
<span class="lineNum">     478 </span><span class="lineCov">          1 :   FRECENCY_PREF(mPermRedirectVisitBonus,   PREF_FREC_PERM_REDIRECT_VISIT_BONUS);</span>
<span class="lineNum">     479 </span><span class="lineCov">          1 :   FRECENCY_PREF(mTempRedirectVisitBonus,   PREF_FREC_TEMP_REDIRECT_VISIT_BONUS);</span>
<span class="lineNum">     480 </span><span class="lineCov">          1 :   FRECENCY_PREF(mRedirectSourceVisitBonus, PREF_FREC_REDIR_SOURCE_VISIT_BONUS);</span>
<span class="lineNum">     481 </span><span class="lineCov">          1 :   FRECENCY_PREF(mDefaultVisitBonus,        PREF_FREC_DEFAULT_VISIT_BONUS);</span>
<span class="lineNum">     482 </span><span class="lineCov">          1 :   FRECENCY_PREF(mUnvisitedBookmarkBonus,   PREF_FREC_UNVISITED_BOOKMARK_BONUS);</span>
<span class="lineNum">     483 </span><span class="lineCov">          1 :   FRECENCY_PREF(mUnvisitedTypedBonus,      PREF_FREC_UNVISITED_TYPED_BONUS);</span>
<span class="lineNum">     484 </span><span class="lineCov">          1 :   FRECENCY_PREF(mReloadVisitBonus,         PREF_FREC_RELOAD_VISIT_BONUS);</span>
<span class="lineNum">     485 </span><span class="lineCov">          1 :   FRECENCY_PREF(mFirstBucketWeight,        PREF_FREC_FIRST_BUCKET_WEIGHT);</span>
<span class="lineNum">     486 </span><span class="lineCov">          1 :   FRECENCY_PREF(mSecondBucketWeight,       PREF_FREC_SECOND_BUCKET_WEIGHT);</span>
<span class="lineNum">     487 </span><span class="lineCov">          1 :   FRECENCY_PREF(mThirdBucketWeight,        PREF_FREC_THIRD_BUCKET_WEIGHT);</span>
<span class="lineNum">     488 </span><span class="lineCov">          1 :   FRECENCY_PREF(mFourthBucketWeight,       PREF_FREC_FOURTH_BUCKET_WEIGHT);</span>
<span class="lineNum">     489 </span><span class="lineCov">          1 :   FRECENCY_PREF(mDefaultWeight,            PREF_FREC_DEFAULT_BUCKET_WEIGHT);</span>
<span class="lineNum">     490 </span>            : 
<span class="lineNum">     491 </span>            : #undef FRECENCY_PREF
<span class="lineNum">     492 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     493 </span>            : 
<a name="494"><span class="lineNum">     494 </span>            : </a>
<span class="lineNum">     495 </span>            : void
<span class="lineNum">     496 </span><span class="lineCov">          1 : nsNavHistory::NotifyOnVisit(nsIURI* aURI,</span>
<span class="lineNum">     497 </span>            :                             int64_t aVisitId,
<span class="lineNum">     498 </span>            :                             PRTime aTime,
<span class="lineNum">     499 </span>            :                             int64_t aReferrerVisitId,
<span class="lineNum">     500 </span>            :                             int32_t aTransitionType,
<span class="lineNum">     501 </span>            :                             const nsACString&amp; aGuid,
<span class="lineNum">     502 </span>            :                             bool aHidden,
<span class="lineNum">     503 </span>            :                             uint32_t aVisitCount,
<span class="lineNum">     504 </span>            :                             uint32_t aTyped,
<span class="lineNum">     505 </span>            :                             const nsAString&amp; aLastKnownTitle)
<span class="lineNum">     506 </span>            : {
<span class="lineNum">     507 </span>            :   MOZ_ASSERT(!aGuid.IsEmpty());
<span class="lineNum">     508 </span>            :   MOZ_ASSERT(aVisitCount, &quot;Should have at least 1 visit when notifying&quot;);
<span class="lineNum">     509 </span>            :   // If there's no history, this visit will surely add a day.  If the visit is
<span class="lineNum">     510 </span>            :   // added before or after the last cached day, the day count may have changed.
<span class="lineNum">     511 </span>            :   // Otherwise adding multiple visits in the same day should not invalidate
<span class="lineNum">     512 </span>            :   // the cache.
<span class="lineNum">     513 </span><span class="lineCov">          1 :   if (mDaysOfHistory == 0) {</span>
<span class="lineNum">     514 </span><span class="lineCov">          1 :     mDaysOfHistory = 1;</span>
<span class="lineNum">     515 </span><span class="lineCov">          1 :   } else if (aTime &gt; mLastCachedEndOfDay || aTime &lt; mLastCachedStartOfDay) {</span>
<span class="lineNum">     516 </span><span class="lineCov">          1 :     mDaysOfHistory = -1;</span>
<span class="lineNum">     517 </span>            :   }
<span class="lineNum">     518 </span>            : 
<span class="lineNum">     519 </span><span class="lineCov">          1 :   NOTIFY_OBSERVERS(mCanNotify, mCacheObservers, mObservers,</span>
<span class="lineNum">     520 </span>            :                    nsINavHistoryObserver,
<span class="lineNum">     521 </span>            :                    OnVisit(aURI, aVisitId, aTime, 0, aReferrerVisitId,
<span class="lineNum">     522 </span>            :                            aTransitionType, aGuid, aHidden, aVisitCount, aTyped, aLastKnownTitle));
<span class="lineNum">     523 </span><span class="lineCov">          1 : }</span>
<a name="524"><span class="lineNum">     524 </span>            : </a>
<span class="lineNum">     525 </span>            : void
<span class="lineNum">     526 </span><span class="lineCov">          1 : nsNavHistory::NotifyTitleChange(nsIURI* aURI,</span>
<span class="lineNum">     527 </span>            :                                 const nsString&amp; aTitle,
<span class="lineNum">     528 </span>            :                                 const nsACString&amp; aGUID)
<span class="lineNum">     529 </span>            : {
<span class="lineNum">     530 </span>            :   MOZ_ASSERT(!aGUID.IsEmpty());
<span class="lineNum">     531 </span><span class="lineCov">          1 :   NOTIFY_OBSERVERS(mCanNotify, mCacheObservers, mObservers,</span>
<span class="lineNum">     532 </span>            :                    nsINavHistoryObserver, OnTitleChanged(aURI, aTitle, aGUID));
<span class="lineNum">     533 </span><span class="lineCov">          1 : }</span>
<a name="534"><span class="lineNum">     534 </span>            : </a>
<span class="lineNum">     535 </span>            : void
<span class="lineNum">     536 </span><span class="lineCov">          1 : nsNavHistory::NotifyFrecencyChanged(nsIURI* aURI,</span>
<span class="lineNum">     537 </span>            :                                     int32_t aNewFrecency,
<span class="lineNum">     538 </span>            :                                     const nsACString&amp; aGUID,
<span class="lineNum">     539 </span>            :                                     bool aHidden,
<span class="lineNum">     540 </span>            :                                     PRTime aLastVisitDate)
<span class="lineNum">     541 </span>            : {
<span class="lineNum">     542 </span>            :   MOZ_ASSERT(!aGUID.IsEmpty());
<span class="lineNum">     543 </span><span class="lineCov">          1 :   NOTIFY_OBSERVERS(mCanNotify, mCacheObservers, mObservers,</span>
<span class="lineNum">     544 </span>            :                    nsINavHistoryObserver,
<span class="lineNum">     545 </span>            :                    OnFrecencyChanged(aURI, aNewFrecency, aGUID, aHidden,
<span class="lineNum">     546 </span>            :                                      aLastVisitDate));
<span class="lineNum">     547 </span><span class="lineCov">          1 : }</span>
<a name="548"><span class="lineNum">     548 </span>            : </a>
<span class="lineNum">     549 </span>            : void
<span class="lineNum">     550 </span><span class="lineCov">          1 : nsNavHistory::NotifyManyFrecenciesChanged()</span>
<span class="lineNum">     551 </span>            : {
<span class="lineNum">     552 </span><span class="lineCov">          1 :   NOTIFY_OBSERVERS(mCanNotify, mCacheObservers, mObservers,</span>
<span class="lineNum">     553 </span>            :                    nsINavHistoryObserver,
<span class="lineNum">     554 </span>            :                    OnManyFrecenciesChanged());
<span class="lineNum">     555 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     556 </span>            : 
<a name="557"><span class="lineNum">     557 </span>            : namespace {</a>
<span class="lineNum">     558 </span>            : 
<span class="lineNum">     559 </span><span class="lineCov">          1 : class FrecencyNotification : public Runnable</span>
<a name="560"><span class="lineNum">     560 </span>            : {</a>
<span class="lineNum">     561 </span>            : public:
<span class="lineNum">     562 </span><span class="lineCov">          1 :   FrecencyNotification(const nsACString&amp; aSpec,</span>
<span class="lineNum">     563 </span>            :                        int32_t aNewFrecency,
<span class="lineNum">     564 </span>            :                        const nsACString&amp; aGUID,
<span class="lineNum">     565 </span>            :                        bool aHidden,
<span class="lineNum">     566 </span>            :                        PRTime aLastVisitDate)
<span class="lineNum">     567 </span>            :     : mSpec(aSpec)
<span class="lineNum">     568 </span>            :     , mNewFrecency(aNewFrecency)
<span class="lineNum">     569 </span>            :     , mGUID(aGUID)
<span class="lineNum">     570 </span>            :     , mHidden(aHidden)
<span class="lineNum">     571 </span><span class="lineCov">          1 :     , mLastVisitDate(aLastVisitDate)</span>
<span class="lineNum">     572 </span>            :   {
<a name="573"><span class="lineNum">     573 </span><span class="lineCov">          1 :   }</span></a>
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span><span class="lineCov">          1 :   NS_IMETHOD Run() override</span>
<span class="lineNum">     576 </span>            :   {
<span class="lineNum">     577 </span>            :     MOZ_ASSERT(NS_IsMainThread(), &quot;Must be called on the main thread&quot;);
<span class="lineNum">     578 </span><span class="lineCov">          1 :     nsNavHistory* navHistory = nsNavHistory::GetHistoryService();</span>
<span class="lineNum">     579 </span><span class="lineCov">          1 :     if (navHistory) {</span>
<span class="lineNum">     580 </span>            :       nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">     581 </span><span class="lineCov">          1 :       (void)NS_NewURI(getter_AddRefs(uri), mSpec);</span>
<span class="lineNum">     582 </span>            :       // We cannot assert since some automated tests are checking this path.
<span class="lineNum">     583 </span>            :       NS_WARNING_ASSERTION(uri, &quot;Invalid URI in FrecencyNotification&quot;);
<span class="lineNum">     584 </span>            :       // Notify a frecency change only if we have a valid uri, otherwise
<span class="lineNum">     585 </span>            :       // the observer couldn't gather any useful data from the notification.
<span class="lineNum">     586 </span><span class="lineCov">          1 :       if (uri) {</span>
<span class="lineNum">     587 </span>            :         navHistory-&gt;NotifyFrecencyChanged(uri, mNewFrecency, mGUID, mHidden,
<span class="lineNum">     588 </span><span class="lineCov">          1 :                                           mLastVisitDate);</span>
<span class="lineNum">     589 </span>            :       }
<span class="lineNum">     590 </span>            :     }
<span class="lineNum">     591 </span><span class="lineCov">          1 :     return NS_OK;</span>
<span class="lineNum">     592 </span>            :   }
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span>            : private:
<span class="lineNum">     595 </span>            :   nsCString mSpec;
<span class="lineNum">     596 </span>            :   int32_t mNewFrecency;
<span class="lineNum">     597 </span>            :   nsCString mGUID;
<span class="lineNum">     598 </span>            :   bool mHidden;
<span class="lineNum">     599 </span>            :   PRTime mLastVisitDate;
<span class="lineNum">     600 </span>            : };
<span class="lineNum">     601 </span>            : 
<span class="lineNum">     602 </span>            : } // namespace
<a name="603"><span class="lineNum">     603 </span>            : </a>
<span class="lineNum">     604 </span>            : void
<span class="lineNum">     605 </span><span class="lineCov">          1 : nsNavHistory::DispatchFrecencyChangedNotification(const nsACString&amp; aSpec,</span>
<span class="lineNum">     606 </span>            :                                                   int32_t aNewFrecency,
<span class="lineNum">     607 </span>            :                                                   const nsACString&amp; aGUID,
<span class="lineNum">     608 </span>            :                                                   bool aHidden,
<span class="lineNum">     609 </span>            :                                                   PRTime aLastVisitDate) const
<span class="lineNum">     610 </span>            : {
<span class="lineNum">     611 </span>            :   nsCOMPtr&lt;nsIRunnable&gt; notif = new FrecencyNotification(aSpec, aNewFrecency,
<span class="lineNum">     612 </span>            :                                                          aGUID, aHidden,
<span class="lineNum">     613 </span><span class="lineCov">          1 :                                                          aLastVisitDate);</span>
<span class="lineNum">     614 </span><span class="lineCov">          1 :   (void)NS_DispatchToMainThread(notif);</span>
<span class="lineNum">     615 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span>            : Atomic&lt;int64_t&gt; nsNavHistory::sLastInsertedPlaceId(0);
<span class="lineNum">     618 </span>            : Atomic&lt;int64_t&gt; nsNavHistory::sLastInsertedVisitId(0);
<a name="619"><span class="lineNum">     619 </span>            : </a>
<span class="lineNum">     620 </span>            : void // static
<span class="lineNum">     621 </span><span class="lineCov">          1 : nsNavHistory::StoreLastInsertedId(const nsACString&amp; aTable,</span>
<span class="lineNum">     622 </span>            :                                   const int64_t aLastInsertedId) {
<span class="lineNum">     623 </span><span class="lineCov">          1 :   if (aTable.Equals(NS_LITERAL_CSTRING(&quot;moz_places&quot;))) {</span>
<span class="lineNum">     624 </span>            :     nsNavHistory::sLastInsertedPlaceId = aLastInsertedId;
<span class="lineNum">     625 </span><span class="lineCov">          1 :   } else if (aTable.Equals(NS_LITERAL_CSTRING(&quot;moz_historyvisits&quot;))) {</span>
<span class="lineNum">     626 </span>            :     nsNavHistory::sLastInsertedVisitId = aLastInsertedId;
<span class="lineNum">     627 </span>            :   } else {
<span class="lineNum">     628 </span>            :     MOZ_ASSERT(false, &quot;Trying to store the insert id for an unknown table?&quot;);
<span class="lineNum">     629 </span>            :   }
<span class="lineNum">     630 </span><span class="lineCov">          1 : }</span>
<a name="631"><span class="lineNum">     631 </span>            : </a>
<span class="lineNum">     632 </span>            : int32_t
<span class="lineNum">     633 </span><span class="lineCov">          1 : nsNavHistory::GetDaysOfHistory() {</span>
<span class="lineNum">     634 </span>            :   MOZ_ASSERT(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span><span class="lineCov">          1 :   if (mDaysOfHistory != -1)</span>
<span class="lineNum">     637 </span>            :     return mDaysOfHistory;
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span>            :   // SQLite doesn't have a CEIL() function, so we must do that later.
<span class="lineNum">     640 </span>            :   // We should also take into account timers resolution, that may be as bad as
<span class="lineNum">     641 </span>            :   // 16ms on Windows, so in some cases the difference may be 0, if the
<span class="lineNum">     642 </span>            :   // check is done near the visit.  Thus remember to check for NULL separately.
<span class="lineNum">     643 </span>            :   nsCOMPtr&lt;mozIStorageStatement&gt; stmt = mDB-&gt;GetStatement(
<span class="lineNum">     644 </span>            :     &quot;SELECT CAST(( &quot;
<span class="lineNum">     645 </span>            :         &quot;strftime('%s','now','localtime','utc') - &quot;
<span class="lineNum">     646 </span>            :         &quot;(SELECT MIN(visit_date)/1000000 FROM moz_historyvisits) &quot;
<span class="lineNum">     647 </span>            :       &quot;) AS DOUBLE) &quot;
<span class="lineNum">     648 </span>            :     &quot;/86400, &quot;
<span class="lineNum">     649 </span>            :     &quot;strftime('%s','now','localtime','+1 day','start of day','utc') * 1000000&quot;
<span class="lineNum">     650 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">     651 </span><span class="lineCov">          1 :   NS_ENSURE_TRUE(stmt, 0);</span>
<span class="lineNum">     652 </span><span class="lineCov">          1 :   mozStorageStatementScoper scoper(stmt);</span>
<span class="lineNum">     653 </span>            : 
<span class="lineNum">     654 </span>            :   bool hasResult;
<span class="lineNum">     655 </span><span class="lineCov">          1 :   if (NS_SUCCEEDED(stmt-&gt;ExecuteStep(&amp;hasResult)) &amp;&amp; hasResult) {</span>
<span class="lineNum">     656 </span>            :     // If we get NULL, then there are no visits, otherwise there must always be
<span class="lineNum">     657 </span>            :     // at least 1 day of history.
<span class="lineNum">     658 </span>            :     bool hasNoVisits;
<span class="lineNum">     659 </span><span class="lineCov">          1 :     (void)stmt-&gt;GetIsNull(0, &amp;hasNoVisits);</span>
<span class="lineNum">     660 </span>            :     mDaysOfHistory = hasNoVisits ?
<span class="lineNum">     661 </span><span class="lineCov">          1 :       0 : std::max(1, static_cast&lt;int32_t&gt;(ceil(stmt-&gt;AsDouble(0))));</span>
<span class="lineNum">     662 </span>            :     mLastCachedStartOfDay =
<span class="lineNum">     663 </span><span class="lineCov">          1 :       NormalizeTime(nsINavHistoryQuery::TIME_RELATIVE_TODAY, 0);</span>
<span class="lineNum">     664 </span><span class="lineCov">          1 :     mLastCachedEndOfDay = stmt-&gt;AsInt64(1) - 1; // Start of tomorrow - 1.</span>
<span class="lineNum">     665 </span>            :   }
<span class="lineNum">     666 </span>            : 
<span class="lineNum">     667 </span><span class="lineCov">          1 :   return mDaysOfHistory;</span>
<span class="lineNum">     668 </span>            : }
<a name="669"><span class="lineNum">     669 </span>            : </a>
<span class="lineNum">     670 </span>            : PRTime
<span class="lineNum">     671 </span><span class="lineCov">          1 : nsNavHistory::GetNow()</span>
<span class="lineNum">     672 </span>            : {
<span class="lineNum">     673 </span><span class="lineCov">          1 :   if (!mCachedNow) {</span>
<span class="lineNum">     674 </span><span class="lineCov">          1 :     mCachedNow = PR_Now();</span>
<span class="lineNum">     675 </span><span class="lineCov">          1 :     if (!mExpireNowTimer)</span>
<span class="lineNum">     676 </span><span class="lineCov">          1 :       mExpireNowTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;);</span>
<span class="lineNum">     677 </span><span class="lineCov">          1 :     if (mExpireNowTimer)</span>
<span class="lineNum">     678 </span><span class="lineCov">          1 :       mExpireNowTimer-&gt;InitWithFuncCallback(expireNowTimerCallback, this,</span>
<span class="lineNum">     679 </span>            :                                             RENEW_CACHED_NOW_TIMEOUT,
<span class="lineNum">     680 </span><span class="lineCov">          1 :                                             nsITimer::TYPE_ONE_SHOT);</span>
<span class="lineNum">     681 </span>            :   }
<span class="lineNum">     682 </span><span class="lineCov">          1 :   return mCachedNow;</span>
<span class="lineNum">     683 </span>            : }
<a name="684"><span class="lineNum">     684 </span>            : </a>
<span class="lineNum">     685 </span>            : 
<span class="lineNum">     686 </span><span class="lineCov">          1 : void nsNavHistory::expireNowTimerCallback(nsITimer* aTimer, void* aClosure)</span>
<span class="lineNum">     687 </span>            : {
<span class="lineNum">     688 </span><span class="lineCov">          1 :   nsNavHistory *history = static_cast&lt;nsNavHistory *&gt;(aClosure);</span>
<span class="lineNum">     689 </span><span class="lineCov">          1 :   if (history) {</span>
<span class="lineNum">     690 </span><span class="lineCov">          1 :     history-&gt;mCachedNow = 0;</span>
<span class="lineNum">     691 </span><span class="lineCov">          1 :     history-&gt;mExpireNowTimer = nullptr;</span>
<span class="lineNum">     692 </span>            :   }
<span class="lineNum">     693 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     694 </span>            : 
<span class="lineNum">     695 </span>            : 
<span class="lineNum">     696 </span>            : /**
<span class="lineNum">     697 </span>            :  * Code borrowed from mozilla/xpfe/components/history/src/nsGlobalHistory.cpp
<span class="lineNum">     698 </span>            :  * Pass in a pre-normalized now and a date, and we'll find the difference since
<span class="lineNum">     699 </span>            :  * midnight on each of the days.
<a name="700"><span class="lineNum">     700 </span>            :  */</a>
<span class="lineNum">     701 </span>            : static PRTime
<span class="lineNum">     702 </span><span class="lineCov">          1 : NormalizeTimeRelativeToday(PRTime aTime)</span>
<span class="lineNum">     703 </span>            : {
<span class="lineNum">     704 </span>            :   // round to midnight this morning
<span class="lineNum">     705 </span>            :   PRExplodedTime explodedTime;
<span class="lineNum">     706 </span><span class="lineCov">          1 :   PR_ExplodeTime(aTime, PR_LocalTimeParameters, &amp;explodedTime);</span>
<span class="lineNum">     707 </span>            : 
<span class="lineNum">     708 </span>            :   // set to midnight (0:00)
<span class="lineNum">     709 </span>            :   explodedTime.tm_min =
<span class="lineNum">     710 </span>            :     explodedTime.tm_hour =
<span class="lineNum">     711 </span>            :     explodedTime.tm_sec =
<span class="lineNum">     712 </span><span class="lineCov">          1 :     explodedTime.tm_usec = 0;</span>
<span class="lineNum">     713 </span>            : 
<span class="lineNum">     714 </span><span class="lineCov">          1 :   return PR_ImplodeTime(&amp;explodedTime);</span>
<span class="lineNum">     715 </span>            : }
<span class="lineNum">     716 </span>            : 
<span class="lineNum">     717 </span>            : // nsNavHistory::NormalizeTime
<span class="lineNum">     718 </span>            : //
<span class="lineNum">     719 </span>            : //    Converts a nsINavHistoryQuery reference+offset time into a PRTime
<span class="lineNum">     720 </span>            : //    relative to the epoch.
<span class="lineNum">     721 </span>            : //
<span class="lineNum">     722 </span>            : //    It is important that this function NOT use the current time optimization.
<span class="lineNum">     723 </span>            : //    It is called to update queries, and we really need to know what right
<span class="lineNum">     724 </span>            : //    now is because those incoming values will also have current times that
<span class="lineNum">     725 </span>            : //    we will have to compare against.
<a name="726"><span class="lineNum">     726 </span>            : </a>
<span class="lineNum">     727 </span>            : PRTime // static
<span class="lineNum">     728 </span><span class="lineCov">          1 : nsNavHistory::NormalizeTime(uint32_t aRelative, PRTime aOffset)</span>
<span class="lineNum">     729 </span>            : {
<span class="lineNum">     730 </span>            :   PRTime ref;
<span class="lineNum">     731 </span><span class="lineCov">          1 :   switch (aRelative)</span>
<span class="lineNum">     732 </span>            :   {
<span class="lineNum">     733 </span>            :     case nsINavHistoryQuery::TIME_RELATIVE_EPOCH:
<span class="lineNum">     734 </span><span class="lineCov">          1 :       return aOffset;</span>
<span class="lineNum">     735 </span>            :     case nsINavHistoryQuery::TIME_RELATIVE_TODAY:
<span class="lineNum">     736 </span><span class="lineCov">          1 :       ref = NormalizeTimeRelativeToday(PR_Now());</span>
<span class="lineNum">     737 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">     738 </span>            :     case nsINavHistoryQuery::TIME_RELATIVE_NOW:
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :       ref = PR_Now();</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">     741 </span>            :     default:
<span class="lineNum">     742 </span>            :       NS_NOTREACHED(&quot;Invalid relative time&quot;);
<span class="lineNum">     743 </span>            :       return 0;
<span class="lineNum">     744 </span>            :   }
<span class="lineNum">     745 </span><span class="lineCov">          1 :   return ref + aOffset;</span>
<span class="lineNum">     746 </span>            : }
<span class="lineNum">     747 </span>            : 
<span class="lineNum">     748 </span>            : // nsNavHistory::GetUpdateRequirements
<span class="lineNum">     749 </span>            : //
<span class="lineNum">     750 </span>            : //    Returns conditions for query update.
<span class="lineNum">     751 </span>            : //
<span class="lineNum">     752 </span>            : //    QUERYUPDATE_TIME:
<span class="lineNum">     753 </span>            : //      This query is only limited by an inclusive time range on the first
<span class="lineNum">     754 </span>            : //      query object. The caller can quickly evaluate the time itself if it
<span class="lineNum">     755 </span>            : //      chooses. This is even simpler than &quot;simple&quot; below.
<span class="lineNum">     756 </span>            : //    QUERYUPDATE_SIMPLE:
<span class="lineNum">     757 </span>            : //      This query is evaluatable using EvaluateQueryForNode to do live
<span class="lineNum">     758 </span>            : //      updating.
<span class="lineNum">     759 </span>            : //    QUERYUPDATE_COMPLEX:
<span class="lineNum">     760 </span>            : //      This query is not evaluatable using EvaluateQueryForNode. When something
<span class="lineNum">     761 </span>            : //      happens that this query updates, you will need to re-run the query.
<span class="lineNum">     762 </span>            : //    QUERYUPDATE_COMPLEX_WITH_BOOKMARKS:
<span class="lineNum">     763 </span>            : //      A complex query that additionally has dependence on bookmarks. All
<span class="lineNum">     764 </span>            : //      bookmark-dependent queries fall under this category.
<span class="lineNum">     765 </span>            : //
<span class="lineNum">     766 </span>            : //    aHasSearchTerms will be set to true if the query has any dependence on
<span class="lineNum">     767 </span>            : //    keywords. When there is no dependence on keywords, we can handle title
<span class="lineNum">     768 </span>            : //    change operations as simple instead of complex.
<a name="769"><span class="lineNum">     769 </span>            : </a>
<span class="lineNum">     770 </span>            : uint32_t
<span class="lineNum">     771 </span><span class="lineCov">          1 : nsNavHistory::GetUpdateRequirements(const nsCOMArray&lt;nsNavHistoryQuery&gt;&amp; aQueries,</span>
<span class="lineNum">     772 </span>            :                                     nsNavHistoryQueryOptions* aOptions,
<span class="lineNum">     773 </span>            :                                     bool* aHasSearchTerms)
<span class="lineNum">     774 </span>            : {
<span class="lineNum">     775 </span>            :   NS_ASSERTION(aQueries.Count() &gt; 0, &quot;Must have at least one query&quot;);
<span class="lineNum">     776 </span>            : 
<span class="lineNum">     777 </span>            :   // first check if there are search terms
<span class="lineNum">     778 </span><span class="lineCov">          1 :   *aHasSearchTerms = false;</span>
<span class="lineNum">     779 </span>            :   int32_t i;
<span class="lineNum">     780 </span><span class="lineCov">          1 :   for (i = 0; i &lt; aQueries.Count(); i ++) {</span>
<span class="lineNum">     781 </span><span class="lineCov">          1 :     aQueries[i]-&gt;GetHasSearchTerms(aHasSearchTerms);</span>
<span class="lineNum">     782 </span><span class="lineCov">          1 :     if (*aHasSearchTerms)</span>
<span class="lineNum">     783 </span>            :       break;
<span class="lineNum">     784 </span>            :   }
<span class="lineNum">     785 </span>            : 
<span class="lineNum">     786 </span><span class="lineCov">          1 :   bool nonTimeBasedItems = false;</span>
<span class="lineNum">     787 </span><span class="lineCov">          1 :   bool domainBasedItems = false;</span>
<span class="lineNum">     788 </span>            : 
<span class="lineNum">     789 </span><span class="lineCov">          1 :   for (i = 0; i &lt; aQueries.Count(); i ++) {</span>
<span class="lineNum">     790 </span><span class="lineCov">          1 :     nsNavHistoryQuery* query = aQueries[i];</span>
<span class="lineNum">     791 </span>            : 
<span class="lineNum">     792 </span><span class="lineCov">          1 :     if (query-&gt;Folders().Length() &gt; 0 ||</span>
<span class="lineNum">     793 </span><span class="lineCov">          1 :         query-&gt;OnlyBookmarked() ||</span>
<span class="lineNum">     794 </span><span class="lineCov">          1 :         query-&gt;Tags().Length() &gt; 0) {</span>
<span class="lineNum">     795 </span>            :       return QUERYUPDATE_COMPLEX_WITH_BOOKMARKS;
<span class="lineNum">     796 </span>            :     }
<span class="lineNum">     797 </span>            : 
<span class="lineNum">     798 </span>            :     // Note: we don't currently have any complex non-bookmarked items, but these
<span class="lineNum">     799 </span>            :     // are expected to be added. Put detection of these items here.
<span class="lineNum">     800 </span><span class="lineCov">          1 :     if (!query-&gt;SearchTerms().IsEmpty() ||</span>
<span class="lineNum">     801 </span><span class="lineCov">          1 :         !query-&gt;Domain().IsVoid() ||</span>
<span class="lineNum">     802 </span>            :         query-&gt;Uri() != nullptr)
<span class="lineNum">     803 </span><span class="lineCov">          1 :       nonTimeBasedItems = true;</span>
<span class="lineNum">     804 </span>            : 
<span class="lineNum">     805 </span><span class="lineCov">          1 :     if (! query-&gt;Domain().IsVoid())</span>
<span class="lineNum">     806 </span><span class="lineCov">          1 :       domainBasedItems = true;</span>
<span class="lineNum">     807 </span>            :   }
<span class="lineNum">     808 </span>            : 
<span class="lineNum">     809 </span><span class="lineCov">          1 :   if (aOptions-&gt;ResultType() ==</span>
<span class="lineNum">     810 </span>            :       nsINavHistoryQueryOptions::RESULTS_AS_TAG_QUERY)
<span class="lineNum">     811 </span>            :     return QUERYUPDATE_COMPLEX_WITH_BOOKMARKS;
<span class="lineNum">     812 </span>            : 
<span class="lineNum">     813 </span>            :   // Whenever there is a maximum number of results,
<span class="lineNum">     814 </span>            :   // and we are not a bookmark query we must requery. This
<span class="lineNum">     815 </span>            :   // is because we can't generally know if any given addition/change causes
<span class="lineNum">     816 </span>            :   // the item to be in the top N items in the database.
<span class="lineNum">     817 </span><span class="lineCov">          1 :   if (aOptions-&gt;MaxResults() &gt; 0)</span>
<span class="lineNum">     818 </span>            :     return QUERYUPDATE_COMPLEX;
<span class="lineNum">     819 </span>            : 
<span class="lineNum">     820 </span><span class="lineCov">          1 :   if (aQueries.Count() == 1 &amp;&amp; domainBasedItems)</span>
<span class="lineNum">     821 </span>            :     return QUERYUPDATE_HOST;
<span class="lineNum">     822 </span><span class="lineCov">          1 :   if (aQueries.Count() == 1 &amp;&amp; !nonTimeBasedItems)</span>
<span class="lineNum">     823 </span>            :     return QUERYUPDATE_TIME;
<span class="lineNum">     824 </span>            : 
<span class="lineNum">     825 </span><span class="lineCov">          1 :   return QUERYUPDATE_SIMPLE;</span>
<span class="lineNum">     826 </span>            : }
<span class="lineNum">     827 </span>            : 
<span class="lineNum">     828 </span>            : 
<span class="lineNum">     829 </span>            : // nsNavHistory::EvaluateQueryForNode
<span class="lineNum">     830 </span>            : //
<span class="lineNum">     831 </span>            : //    This runs the node through the given queries to see if satisfies the
<span class="lineNum">     832 </span>            : //    query conditions. Not every query parameters are handled by this code,
<span class="lineNum">     833 </span>            : //    but we handle the most common ones so that performance is better.
<span class="lineNum">     834 </span>            : //
<span class="lineNum">     835 </span>            : //    We assume that the time on the node is the time that we want to compare.
<span class="lineNum">     836 </span>            : //    This is not necessarily true because URL nodes have the last access time,
<span class="lineNum">     837 </span>            : //    which is not necessarily the same. However, since this is being called
<span class="lineNum">     838 </span>            : //    to update the list, we assume that the last access time is the current
<span class="lineNum">     839 </span>            : //    access time that we are being asked to compare so it works out.
<span class="lineNum">     840 </span>            : //
<span class="lineNum">     841 </span>            : //    Returns true if node matches the query, false if not.
<a name="842"><span class="lineNum">     842 </span>            : </a>
<span class="lineNum">     843 </span>            : bool
<span class="lineNum">     844 </span><span class="lineCov">          1 : nsNavHistory::EvaluateQueryForNode(const nsCOMArray&lt;nsNavHistoryQuery&gt;&amp; aQueries,</span>
<span class="lineNum">     845 </span>            :                                    nsNavHistoryQueryOptions* aOptions,
<span class="lineNum">     846 </span>            :                                    nsNavHistoryResultNode* aNode)
<span class="lineNum">     847 </span>            : {
<span class="lineNum">     848 </span>            :   // lazily created from the node's string when we need to match URIs
<span class="lineNum">     849 </span>            :   nsCOMPtr&lt;nsIURI&gt; nodeUri;
<span class="lineNum">     850 </span>            : 
<span class="lineNum">     851 </span>            :   // --- hidden ---
<span class="lineNum">     852 </span><span class="lineCov">          1 :   if (aNode-&gt;mHidden &amp;&amp; !aOptions-&gt;IncludeHidden())</span>
<span class="lineNum">     853 </span>            :     return false;
<span class="lineNum">     854 </span>            : 
<span class="lineNum">     855 </span><span class="lineCov">          1 :   for (int32_t i = 0; i &lt; aQueries.Count(); i ++) {</span>
<span class="lineNum">     856 </span>            :     bool hasIt;
<span class="lineNum">     857 </span><span class="lineCov">          1 :     nsCOMPtr&lt;nsNavHistoryQuery&gt; query = aQueries[i];</span>
<span class="lineNum">     858 </span>            : 
<span class="lineNum">     859 </span>            :     // --- begin time ---
<span class="lineNum">     860 </span><span class="lineCov">          1 :     query-&gt;GetHasBeginTime(&amp;hasIt);</span>
<span class="lineNum">     861 </span><span class="lineCov">          1 :     if (hasIt) {</span>
<span class="lineNum">     862 </span>            :       PRTime beginTime = NormalizeTime(query-&gt;BeginTimeReference(),
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :                                        query-&gt;BeginTime());</span>
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :       if (aNode-&gt;mTime &lt; beginTime)</span>
<span class="lineNum">     865 </span>            :         continue; // before our time range
<span class="lineNum">     866 </span>            :     }
<span class="lineNum">     867 </span>            : 
<span class="lineNum">     868 </span>            :     // --- end time ---
<span class="lineNum">     869 </span><span class="lineCov">          1 :     query-&gt;GetHasEndTime(&amp;hasIt);</span>
<span class="lineNum">     870 </span><span class="lineCov">          1 :     if (hasIt) {</span>
<span class="lineNum">     871 </span>            :       PRTime endTime = NormalizeTime(query-&gt;EndTimeReference(),
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :                                      query-&gt;EndTime());</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :       if (aNode-&gt;mTime &gt; endTime)</span>
<span class="lineNum">     874 </span>            :         continue; // after our time range
<span class="lineNum">     875 </span>            :     }
<span class="lineNum">     876 </span>            : 
<span class="lineNum">     877 </span>            :     // --- search terms ---
<span class="lineNum">     878 </span><span class="lineCov">          1 :     if (! query-&gt;SearchTerms().IsEmpty()) {</span>
<span class="lineNum">     879 </span>            :       // we can use the existing filtering code, just give it our one object in
<span class="lineNum">     880 </span>            :       // an array.
<span class="lineNum">     881 </span>            :       nsCOMArray&lt;nsNavHistoryResultNode&gt; inputSet;
<span class="lineNum">     882 </span><span class="lineCov">          1 :       inputSet.AppendObject(aNode);</span>
<span class="lineNum">     883 </span>            :       nsCOMArray&lt;nsNavHistoryQuery&gt; queries;
<span class="lineNum">     884 </span><span class="lineCov">          1 :       queries.AppendObject(query);</span>
<span class="lineNum">     885 </span>            :       nsCOMArray&lt;nsNavHistoryResultNode&gt; filteredSet;
<span class="lineNum">     886 </span><span class="lineCov">          1 :       nsresult rv = FilterResultSet(nullptr, inputSet, &amp;filteredSet, queries, aOptions);</span>
<span class="lineNum">     887 </span><span class="lineCov">          1 :       if (NS_FAILED(rv))</span>
<span class="lineNum">     888 </span>            :         continue;
<span class="lineNum">     889 </span><span class="lineCov">          1 :       if (! filteredSet.Count())</span>
<span class="lineNum">     890 </span>            :         continue; // did not make it through the filter, doesn't match
<span class="lineNum">     891 </span>            :     }
<span class="lineNum">     892 </span>            : 
<span class="lineNum">     893 </span>            :     // --- domain/host matching ---
<span class="lineNum">     894 </span><span class="lineCov">          1 :     query-&gt;GetHasDomain(&amp;hasIt);</span>
<span class="lineNum">     895 </span><span class="lineCov">          1 :     if (hasIt) {</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :       if (! nodeUri) {</span>
<span class="lineNum">     897 </span>            :         // lazy creation of nodeUri, which might be checked for multiple queries
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :         if (NS_FAILED(NS_NewURI(getter_AddRefs(nodeUri), aNode-&gt;mURI)))</span>
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     900 </span>            :       }
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :       nsAutoCString asciiRequest;</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :       if (NS_FAILED(AsciiHostNameFromHostString(query-&gt;Domain(), asciiRequest)))</span>
<span class="lineNum">     903 </span>            :         continue;
<span class="lineNum">     904 </span>            : 
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :       if (query-&gt;DomainIsHost()) {</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :         nsAutoCString host;</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :         if (NS_FAILED(nodeUri-&gt;GetAsciiHost(host)))</span>
<span class="lineNum">     908 </span>            :           continue;
<span class="lineNum">     909 </span>            : 
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :         if (! asciiRequest.Equals(host))</span>
<span class="lineNum">     911 </span>            :           continue; // host names don't match
<span class="lineNum">     912 </span>            :       }
<span class="lineNum">     913 </span>            :       // check domain names
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :       nsAutoCString domain;</span>
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :       DomainNameFromURI(nodeUri, domain);</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :       if (! asciiRequest.Equals(domain))</span>
<span class="lineNum">     917 </span>            :         continue; // domain names don't match
<span class="lineNum">     918 </span>            :     }
<span class="lineNum">     919 </span>            : 
<span class="lineNum">     920 </span>            :     // --- URI matching ---
<span class="lineNum">     921 </span><span class="lineCov">          1 :     if (query-&gt;Uri()) {</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :       if (! nodeUri) { // lazy creation of nodeUri</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :         if (NS_FAILED(NS_NewURI(getter_AddRefs(nodeUri), aNode-&gt;mURI)))</span>
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     925 </span>            :       }
<span class="lineNum">     926 </span>            : 
<span class="lineNum">     927 </span>            :       bool equals;
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :       nsresult rv = query-&gt;Uri()-&gt;Equals(nodeUri, &amp;equals);</span>
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, false);</span>
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :       if (! equals)</span>
<span class="lineNum">     931 </span>            :         continue;
<span class="lineNum">     932 </span>            :     }
<span class="lineNum">     933 </span>            : 
<span class="lineNum">     934 </span>            :     // Transitions matching.
<span class="lineNum">     935 </span><span class="lineCov">          1 :     const nsTArray&lt;uint32_t&gt;&amp; transitions = query-&gt;Transitions();</span>
<span class="lineNum">     936 </span><span class="lineCov">          1 :     if (aNode-&gt;mTransitionType &gt; 0 &amp;&amp;</span>
<span class="lineNum">     937 </span><span class="lineCov">          1 :         transitions.Length() &amp;&amp;</span>
<span class="lineNum">     938 </span><span class="lineCov">          1 :         !transitions.Contains(aNode-&gt;mTransitionType)) {</span>
<span class="lineNum">     939 </span>            :       continue; // transition doesn't match.
<span class="lineNum">     940 </span>            :     }
<span class="lineNum">     941 </span>            : 
<span class="lineNum">     942 </span>            :     // If we ever make it to the bottom of this loop, that means it passed all
<span class="lineNum">     943 </span>            :     // tests for the given query. Since queries are ORed together, that means
<span class="lineNum">     944 </span>            :     // it passed everything and we are done.
<span class="lineNum">     945 </span>            :     return true;
<span class="lineNum">     946 </span>            :   }
<span class="lineNum">     947 </span>            : 
<span class="lineNum">     948 </span>            :   // didn't match any query
<span class="lineNum">     949 </span>            :   return false;
<span class="lineNum">     950 </span>            : }
<span class="lineNum">     951 </span>            : 
<span class="lineNum">     952 </span>            : 
<span class="lineNum">     953 </span>            : // nsNavHistory::AsciiHostNameFromHostString
<span class="lineNum">     954 </span>            : //
<span class="lineNum">     955 </span>            : //    We might have interesting encodings and different case in the host name.
<span class="lineNum">     956 </span>            : //    This will convert that host name into an ASCII host name by sending it
<span class="lineNum">     957 </span>            : //    through the URI canonicalization. The result can be used for comparison
<a name="958"><span class="lineNum">     958 </span>            : //    with other ASCII host name strings.</a>
<span class="lineNum">     959 </span>            : nsresult // static
<span class="lineNum">     960 </span><span class="lineNoCov">          0 : nsNavHistory::AsciiHostNameFromHostString(const nsACString&amp; aHostName,</span>
<span class="lineNum">     961 </span>            :                                           nsACString&amp; aAscii)
<span class="lineNum">     962 </span>            : {
<span class="lineNum">     963 </span>            :   aAscii.Truncate();
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :   if (aHostName.IsEmpty()) {</span>
<span class="lineNum">     965 </span>            :     return NS_OK;
<span class="lineNum">     966 </span>            :   }
<span class="lineNum">     967 </span>            :   // To properly generate a uri we must provide a protocol.
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :   nsAutoCString fakeURL(&quot;http://&quot;);</span>
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :   fakeURL.Append(aHostName);</span>
<span class="lineNum">     970 </span>            :   nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :   nsresult rv = NS_NewURI(getter_AddRefs(uri), fakeURL);</span>
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :   rv = uri-&gt;GetAsciiHost(aAscii);</span>
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     975 </span>            :   return NS_OK;
<span class="lineNum">     976 </span>            : }
<span class="lineNum">     977 </span>            : 
<span class="lineNum">     978 </span>            : 
<span class="lineNum">     979 </span>            : // nsNavHistory::DomainNameFromURI
<span class="lineNum">     980 </span>            : //
<span class="lineNum">     981 </span>            : //    This does the www.mozilla.org -&gt; mozilla.org and
<a name="982"><span class="lineNum">     982 </span>            : //    foo.theregister.co.uk -&gt; theregister.co.uk conversion</a>
<span class="lineNum">     983 </span>            : void
<span class="lineNum">     984 </span><span class="lineNoCov">          0 : nsNavHistory::DomainNameFromURI(nsIURI *aURI,</span>
<span class="lineNum">     985 </span>            :                                 nsACString&amp; aDomainName)
<span class="lineNum">     986 </span>            : {
<span class="lineNum">     987 </span>            :   // lazily get the effective tld service
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :   if (!mTLDService)</span>
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :     mTLDService = do_GetService(NS_EFFECTIVETLDSERVICE_CONTRACTID);</span>
<span class="lineNum">     990 </span>            : 
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :   if (mTLDService) {</span>
<span class="lineNum">     992 </span>            :     // get the base domain for a given hostname.
<span class="lineNum">     993 </span>            :     // e.g. for &quot;images.bbc.co.uk&quot;, this would be &quot;bbc.co.uk&quot;.
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :     nsresult rv = mTLDService-&gt;GetBaseDomain(aURI, 0, aDomainName);</span>
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :     if (NS_SUCCEEDED(rv))</span>
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     997 </span>            :   }
<span class="lineNum">     998 </span>            : 
<span class="lineNum">     999 </span>            :   // just return the original hostname
<span class="lineNum">    1000 </span>            :   // (it's also possible the host is an IP address)
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :   aURI-&gt;GetAsciiHost(aDomainName);</span>
<span class="lineNum">    1002 </span>            : }
<span class="lineNum">    1003 </span>            : 
<a name="1004"><span class="lineNum">    1004 </span>            : </a>
<span class="lineNum">    1005 </span>            : NS_IMETHODIMP
<span class="lineNum">    1006 </span><span class="lineCov">          1 : nsNavHistory::GetHasHistoryEntries(bool* aHasEntries)</span>
<span class="lineNum">    1007 </span>            : {
<span class="lineNum">    1008 </span><span class="lineCov">          1 :   NS_ENSURE_ARG_POINTER(aHasEntries);</span>
<span class="lineNum">    1009 </span><span class="lineCov">          1 :   *aHasEntries = GetDaysOfHistory() &gt; 0;</span>
<span class="lineNum">    1010 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    1011 </span>            : }
<span class="lineNum">    1012 </span>            : 
<span class="lineNum">    1013 </span>            : 
<a name="1014"><span class="lineNum">    1014 </span>            : namespace {</a>
<span class="lineNum">    1015 </span>            : 
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 : class InvalidateAllFrecenciesCallback : public AsyncStatementCallback</span>
<a name="1017"><span class="lineNum">    1017 </span>            : {</a>
<span class="lineNum">    1018 </span>            : public:
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :   InvalidateAllFrecenciesCallback()</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :   {</span>
<a name="1021"><span class="lineNum">    1021 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    1022 </span>            : 
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :   NS_IMETHOD HandleCompletion(uint16_t aReason)</span>
<span class="lineNum">    1024 </span>            :   {
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :     if (aReason == REASON_FINISHED) {</span>
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :       nsNavHistory *navHistory = nsNavHistory::GetHistoryService();</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :       NS_ENSURE_STATE(navHistory);</span>
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :       navHistory-&gt;NotifyManyFrecenciesChanged();</span>
<span class="lineNum">    1029 </span>            :     }
<span class="lineNum">    1030 </span>            :     return NS_OK;
<span class="lineNum">    1031 </span>            :   }
<span class="lineNum">    1032 </span>            : };
<span class="lineNum">    1033 </span>            : 
<span class="lineNum">    1034 </span>            : } // namespace
<a name="1035"><span class="lineNum">    1035 </span>            : </a>
<span class="lineNum">    1036 </span>            : nsresult
<span class="lineNum">    1037 </span><span class="lineCov">          1 : nsNavHistory::invalidateFrecencies(const nsCString&amp; aPlaceIdsQueryString)</span>
<span class="lineNum">    1038 </span>            : {
<span class="lineNum">    1039 </span>            :   // Exclude place: queries by setting their frecency to zero.
<span class="lineNum">    1040 </span>            :   nsCString invalidFrecenciesSQLFragment(
<span class="lineNum">    1041 </span>            :     &quot;UPDATE moz_places SET frecency = &quot;
<span class="lineNum">    1042 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    1043 </span><span class="lineCov">          1 :   if (!aPlaceIdsQueryString.IsEmpty())</span>
<span class="lineNum">    1044 </span><span class="lineCov">          1 :     invalidFrecenciesSQLFragment.AppendLiteral(&quot;NOTIFY_FRECENCY(&quot;);</span>
<span class="lineNum">    1045 </span>            :   invalidFrecenciesSQLFragment.AppendLiteral(
<span class="lineNum">    1046 </span>            :       &quot;(CASE &quot;
<span class="lineNum">    1047 </span>            :        &quot;WHEN url_hash BETWEEN hash('place', 'prefix_lo') AND &quot;
<span class="lineNum">    1048 </span>            :                              &quot;hash('place', 'prefix_hi') &quot;
<span class="lineNum">    1049 </span>            :        &quot;THEN 0 &quot;
<span class="lineNum">    1050 </span>            :        &quot;ELSE -1 &quot;
<span class="lineNum">    1051 </span>            :        &quot;END) &quot;
<span class="lineNum">    1052 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    1053 </span><span class="lineCov">          1 :   if (!aPlaceIdsQueryString.IsEmpty()) {</span>
<span class="lineNum">    1054 </span>            :     invalidFrecenciesSQLFragment.AppendLiteral(
<span class="lineNum">    1055 </span>            :       &quot;, url, guid, hidden, last_visit_date) &quot;
<span class="lineNum">    1056 </span><span class="lineCov">          1 :     );</span>
<span class="lineNum">    1057 </span>            :   }
<span class="lineNum">    1058 </span>            :   invalidFrecenciesSQLFragment.AppendLiteral(
<span class="lineNum">    1059 </span>            :     &quot;WHERE frecency &gt; 0 &quot;
<span class="lineNum">    1060 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    1061 </span><span class="lineCov">          1 :   if (!aPlaceIdsQueryString.IsEmpty()) {</span>
<span class="lineNum">    1062 </span><span class="lineCov">          1 :     invalidFrecenciesSQLFragment.AppendLiteral(&quot;AND id IN(&quot;);</span>
<span class="lineNum">    1063 </span><span class="lineCov">          1 :     invalidFrecenciesSQLFragment.Append(aPlaceIdsQueryString);</span>
<span class="lineNum">    1064 </span><span class="lineCov">          1 :     invalidFrecenciesSQLFragment.Append(')');</span>
<span class="lineNum">    1065 </span>            :   }
<span class="lineNum">    1066 </span>            :   RefPtr&lt;InvalidateAllFrecenciesCallback&gt; cb =
<span class="lineNum">    1067 </span><span class="lineCov">          1 :     aPlaceIdsQueryString.IsEmpty() ? new InvalidateAllFrecenciesCallback()</span>
<span class="lineNum">    1068 </span><span class="lineCov">          1 :                                    : nullptr;</span>
<span class="lineNum">    1069 </span>            : 
<span class="lineNum">    1070 </span>            :   nsCOMPtr&lt;mozIStorageAsyncStatement&gt; stmt = mDB-&gt;GetAsyncStatement(
<span class="lineNum">    1071 </span>            :     invalidFrecenciesSQLFragment
<span class="lineNum">    1072 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    1073 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(stmt);</span>
<span class="lineNum">    1074 </span>            : 
<span class="lineNum">    1075 </span>            :   nsCOMPtr&lt;mozIStoragePendingStatement&gt; ps;
<span class="lineNum">    1076 </span><span class="lineCov">          1 :   nsresult rv = stmt-&gt;ExecuteAsync(cb, getter_AddRefs(ps));</span>
<span class="lineNum">    1077 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1078 </span>            : 
<span class="lineNum">    1079 </span>            :   return NS_OK;
<span class="lineNum">    1080 </span>            : }
<span class="lineNum">    1081 </span>            : 
<span class="lineNum">    1082 </span>            : 
<span class="lineNum">    1083 </span>            : // Call this method before visiting a URL in order to help determine the
<span class="lineNum">    1084 </span>            : // transition type of the visit.
<span class="lineNum">    1085 </span>            : //
<span class="lineNum">    1086 </span>            : // @see MarkPageAsTyped
<a name="1087"><span class="lineNum">    1087 </span>            : </a>
<span class="lineNum">    1088 </span>            : NS_IMETHODIMP
<span class="lineNum">    1089 </span><span class="lineCov">          1 : nsNavHistory::MarkPageAsFollowedBookmark(nsIURI* aURI)</span>
<span class="lineNum">    1090 </span>            : {
<span class="lineNum">    1091 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    1092 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aURI);</span>
<span class="lineNum">    1093 </span>            : 
<span class="lineNum">    1094 </span>            :   // don't add when history is disabled
<span class="lineNum">    1095 </span><span class="lineCov">          1 :   if (IsHistoryDisabled())</span>
<span class="lineNum">    1096 </span>            :     return NS_OK;
<span class="lineNum">    1097 </span>            : 
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :   nsAutoCString uriString;</span>
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :   nsresult rv = aURI-&gt;GetSpec(uriString);</span>
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1101 </span>            : 
<span class="lineNum">    1102 </span>            :   // if URL is already in the bookmark queue, then we need to remove the old one
<span class="lineNum">    1103 </span>            :   int64_t unusedEventTime;
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :   if (mRecentBookmark.Get(uriString, &amp;unusedEventTime))</span>
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :     mRecentBookmark.Remove(uriString);</span>
<span class="lineNum">    1106 </span>            : 
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :   if (mRecentBookmark.Count() &gt; RECENT_EVENT_QUEUE_MAX_LENGTH)</span>
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :     ExpireNonrecentEvents(&amp;mRecentBookmark);</span>
<span class="lineNum">    1109 </span>            : 
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :   mRecentBookmark.Put(uriString, GetNow());</span>
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1112 </span>            : }
<span class="lineNum">    1113 </span>            : 
<span class="lineNum">    1114 </span>            : 
<span class="lineNum">    1115 </span>            : // nsNavHistory::CanAddURI
<span class="lineNum">    1116 </span>            : //
<span class="lineNum">    1117 </span>            : //    Filter out unwanted URIs such as &quot;chrome:&quot;, &quot;mailbox:&quot;, etc.
<span class="lineNum">    1118 </span>            : //
<span class="lineNum">    1119 </span>            : //    The model is if we don't know differently then add which basically means
<span class="lineNum">    1120 </span>            : //    we are suppose to try all the things we know not to allow in and then if
<span class="lineNum">    1121 </span>            : //    we don't bail go on and allow it in.
<a name="1122"><span class="lineNum">    1122 </span>            : </a>
<span class="lineNum">    1123 </span>            : NS_IMETHODIMP
<span class="lineNum">    1124 </span><span class="lineCov">          1 : nsNavHistory::CanAddURI(nsIURI* aURI, bool* canAdd)</span>
<span class="lineNum">    1125 </span>            : {
<span class="lineNum">    1126 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    1127 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aURI);</span>
<span class="lineNum">    1128 </span><span class="lineCov">          1 :   NS_ENSURE_ARG_POINTER(canAdd);</span>
<span class="lineNum">    1129 </span>            : 
<span class="lineNum">    1130 </span>            :   // Default to false.
<span class="lineNum">    1131 </span><span class="lineCov">          1 :   *canAdd = false;</span>
<span class="lineNum">    1132 </span>            : 
<span class="lineNum">    1133 </span>            :   // If history is disabled, don't add any entry.
<span class="lineNum">    1134 </span><span class="lineCov">          1 :   if (IsHistoryDisabled()) {</span>
<span class="lineNum">    1135 </span>            :     return NS_OK;
<span class="lineNum">    1136 </span>            :   }
<span class="lineNum">    1137 </span>            : 
<span class="lineNum">    1138 </span>            :   // If the url length is over a threshold, don't add it.
<span class="lineNum">    1139 </span>            :   nsCString spec;
<span class="lineNum">    1140 </span><span class="lineCov">          1 :   nsresult rv = aURI-&gt;GetSpec(spec);</span>
<span class="lineNum">    1141 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1142 </span><span class="lineCov">          1 :   if (!mDB || spec.Length() &gt; mDB-&gt;MaxUrlLength()) {</span>
<span class="lineNum">    1143 </span>            :     return NS_OK;
<span class="lineNum">    1144 </span>            :   }
<span class="lineNum">    1145 </span>            : 
<span class="lineNum">    1146 </span><span class="lineCov">          1 :   nsAutoCString scheme;</span>
<span class="lineNum">    1147 </span><span class="lineCov">          1 :   rv = aURI-&gt;GetScheme(scheme);</span>
<span class="lineNum">    1148 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1149 </span>            : 
<span class="lineNum">    1150 </span>            :   // first check the most common cases (HTTP, HTTPS) to allow in to avoid most
<span class="lineNum">    1151 </span>            :   // of the work
<span class="lineNum">    1152 </span><span class="lineCov">          1 :   if (scheme.EqualsLiteral(&quot;http&quot;)) {</span>
<span class="lineNum">    1153 </span><span class="lineCov">          1 :     *canAdd = true;</span>
<span class="lineNum">    1154 </span><span class="lineCov">          1 :     return NS_OK;</span>
<span class="lineNum">    1155 </span>            :   }
<span class="lineNum">    1156 </span><span class="lineCov">          1 :   if (scheme.EqualsLiteral(&quot;https&quot;)) {</span>
<span class="lineNum">    1157 </span><span class="lineCov">          1 :     *canAdd = true;</span>
<span class="lineNum">    1158 </span><span class="lineCov">          1 :     return NS_OK;</span>
<span class="lineNum">    1159 </span>            :   }
<span class="lineNum">    1160 </span>            : 
<span class="lineNum">    1161 </span>            :   // now check for all bad things
<span class="lineNum">    1162 </span><span class="lineCov">          1 :   if (scheme.EqualsLiteral(&quot;about&quot;) ||</span>
<span class="lineNum">    1163 </span><span class="lineCov">          1 :       scheme.EqualsLiteral(&quot;blob&quot;) ||</span>
<span class="lineNum">    1164 </span><span class="lineCov">          1 :       scheme.EqualsLiteral(&quot;chrome&quot;) ||</span>
<span class="lineNum">    1165 </span><span class="lineCov">          1 :       scheme.EqualsLiteral(&quot;data&quot;) ||</span>
<span class="lineNum">    1166 </span><span class="lineCov">          1 :       scheme.EqualsLiteral(&quot;imap&quot;) ||</span>
<span class="lineNum">    1167 </span><span class="lineCov">          1 :       scheme.EqualsLiteral(&quot;javascript&quot;) ||</span>
<span class="lineNum">    1168 </span><span class="lineCov">          1 :       scheme.EqualsLiteral(&quot;mailbox&quot;) ||</span>
<span class="lineNum">    1169 </span><span class="lineCov">          1 :       scheme.EqualsLiteral(&quot;moz-anno&quot;) ||</span>
<span class="lineNum">    1170 </span><span class="lineCov">          1 :       scheme.EqualsLiteral(&quot;news&quot;) ||</span>
<span class="lineNum">    1171 </span><span class="lineCov">          1 :       scheme.EqualsLiteral(&quot;page-icon&quot;) ||</span>
<span class="lineNum">    1172 </span><span class="lineCov">          1 :       scheme.EqualsLiteral(&quot;resource&quot;) ||</span>
<span class="lineNum">    1173 </span><span class="lineCov">          1 :       scheme.EqualsLiteral(&quot;view-source&quot;) ||</span>
<span class="lineNum">    1174 </span><span class="lineCov">          1 :       scheme.EqualsLiteral(&quot;wyciwyg&quot;)) {</span>
<span class="lineNum">    1175 </span>            :     return NS_OK;
<span class="lineNum">    1176 </span>            :   }
<span class="lineNum">    1177 </span><span class="lineCov">          1 :   *canAdd = true;</span>
<span class="lineNum">    1178 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    1179 </span>            : }
<span class="lineNum">    1180 </span>            : 
<span class="lineNum">    1181 </span>            : // nsNavHistory::GetNewQuery
<a name="1182"><span class="lineNum">    1182 </span>            : </a>
<span class="lineNum">    1183 </span>            : NS_IMETHODIMP
<span class="lineNum">    1184 </span><span class="lineCov">          1 : nsNavHistory::GetNewQuery(nsINavHistoryQuery **_retval)</span>
<span class="lineNum">    1185 </span>            : {
<span class="lineNum">    1186 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    1187 </span><span class="lineCov">          1 :   NS_ENSURE_ARG_POINTER(_retval);</span>
<span class="lineNum">    1188 </span>            : 
<span class="lineNum">    1189 </span><span class="lineCov">          1 :   RefPtr&lt;nsNavHistoryQuery&gt; query = new nsNavHistoryQuery();</span>
<span class="lineNum">    1190 </span>            :   query.forget(_retval);
<span class="lineNum">    1191 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    1192 </span>            : }
<span class="lineNum">    1193 </span>            : 
<span class="lineNum">    1194 </span>            : // nsNavHistory::GetNewQueryOptions
<a name="1195"><span class="lineNum">    1195 </span>            : </a>
<span class="lineNum">    1196 </span>            : NS_IMETHODIMP
<span class="lineNum">    1197 </span><span class="lineCov">          1 : nsNavHistory::GetNewQueryOptions(nsINavHistoryQueryOptions **_retval)</span>
<span class="lineNum">    1198 </span>            : {
<span class="lineNum">    1199 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    1200 </span><span class="lineCov">          1 :   NS_ENSURE_ARG_POINTER(_retval);</span>
<span class="lineNum">    1201 </span>            : 
<span class="lineNum">    1202 </span><span class="lineCov">          1 :   RefPtr&lt;nsNavHistoryQueryOptions&gt; queryOptions = new nsNavHistoryQueryOptions();</span>
<span class="lineNum">    1203 </span>            :   queryOptions.forget(_retval);
<span class="lineNum">    1204 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    1205 </span>            : }
<span class="lineNum">    1206 </span>            : 
<span class="lineNum">    1207 </span>            : // nsNavHistory::ExecuteQuery
<span class="lineNum">    1208 </span>            : //
<a name="1209"><span class="lineNum">    1209 </span>            : </a>
<span class="lineNum">    1210 </span>            : NS_IMETHODIMP
<span class="lineNum">    1211 </span><span class="lineCov">          1 : nsNavHistory::ExecuteQuery(nsINavHistoryQuery *aQuery, nsINavHistoryQueryOptions *aOptions,</span>
<span class="lineNum">    1212 </span>            :                            nsINavHistoryResult** _retval)
<span class="lineNum">    1213 </span>            : {
<span class="lineNum">    1214 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    1215 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aQuery);</span>
<span class="lineNum">    1216 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aOptions);</span>
<span class="lineNum">    1217 </span><span class="lineCov">          1 :   NS_ENSURE_ARG_POINTER(_retval);</span>
<span class="lineNum">    1218 </span>            : 
<span class="lineNum">    1219 </span><span class="lineCov">          1 :   return ExecuteQueries(&amp;aQuery, 1, aOptions, _retval);</span>
<span class="lineNum">    1220 </span>            : }
<span class="lineNum">    1221 </span>            : 
<span class="lineNum">    1222 </span>            : 
<span class="lineNum">    1223 </span>            : // nsNavHistory::ExecuteQueries
<span class="lineNum">    1224 </span>            : //
<span class="lineNum">    1225 </span>            : //    This function is actually very simple, we just create the proper root node (either
<span class="lineNum">    1226 </span>            : //    a bookmark folder or a complex query node) and assign it to the result. The node
<span class="lineNum">    1227 </span>            : //    will then populate itself accordingly.
<span class="lineNum">    1228 </span>            : //
<span class="lineNum">    1229 </span>            : //    Quick overview of query operation: When you call this function, we will construct
<span class="lineNum">    1230 </span>            : //    the correct container node and set the options you give it. This node will then
<span class="lineNum">    1231 </span>            : //    fill itself. Folder nodes will call nsNavBookmarks::QueryFolderChildren, and
<span class="lineNum">    1232 </span>            : //    all other queries will call GetQueryResults. If these results contain other
<span class="lineNum">    1233 </span>            : //    queries, those will be populated when the container is opened.
<a name="1234"><span class="lineNum">    1234 </span>            : </a>
<span class="lineNum">    1235 </span>            : NS_IMETHODIMP
<span class="lineNum">    1236 </span><span class="lineCov">          1 : nsNavHistory::ExecuteQueries(nsINavHistoryQuery** aQueries, uint32_t aQueryCount,</span>
<span class="lineNum">    1237 </span>            :                              nsINavHistoryQueryOptions *aOptions,
<span class="lineNum">    1238 </span>            :                              nsINavHistoryResult** _retval)
<span class="lineNum">    1239 </span>            : {
<span class="lineNum">    1240 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    1241 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aQueries);</span>
<span class="lineNum">    1242 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aOptions);</span>
<span class="lineNum">    1243 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aQueryCount);</span>
<span class="lineNum">    1244 </span><span class="lineCov">          1 :   NS_ENSURE_ARG_POINTER(_retval);</span>
<span class="lineNum">    1245 </span>            : 
<span class="lineNum">    1246 </span>            :   nsresult rv;
<span class="lineNum">    1247 </span>            :   // concrete options
<span class="lineNum">    1248 </span><span class="lineCov">          1 :   nsCOMPtr&lt;nsNavHistoryQueryOptions&gt; options = do_QueryInterface(aOptions);</span>
<span class="lineNum">    1249 </span><span class="lineCov">          1 :   NS_ENSURE_TRUE(options, NS_ERROR_INVALID_ARG);</span>
<span class="lineNum">    1250 </span>            : 
<span class="lineNum">    1251 </span>            :   // concrete queries array
<span class="lineNum">    1252 </span>            :   nsCOMArray&lt;nsNavHistoryQuery&gt; queries;
<span class="lineNum">    1253 </span><span class="lineCov">          1 :   for (uint32_t i = 0; i &lt; aQueryCount; i ++) {</span>
<span class="lineNum">    1254 </span><span class="lineCov">          1 :     nsCOMPtr&lt;nsNavHistoryQuery&gt; query = do_QueryInterface(aQueries[i], &amp;rv);</span>
<span class="lineNum">    1255 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1256 </span><span class="lineCov">          1 :     queries.AppendElement(query.forget());</span>
<span class="lineNum">    1257 </span>            :   }
<span class="lineNum">    1258 </span>            : 
<span class="lineNum">    1259 </span>            :   // Create the root node.
<span class="lineNum">    1260 </span><span class="lineCov">          1 :   RefPtr&lt;nsNavHistoryContainerResultNode&gt; rootNode;</span>
<span class="lineNum">    1261 </span><span class="lineCov">          1 :   int64_t folderId = GetSimpleBookmarksQueryFolder(queries, options);</span>
<span class="lineNum">    1262 </span><span class="lineCov">          1 :   if (folderId) {</span>
<span class="lineNum">    1263 </span>            :     // In the simple case where we're just querying children of a single
<span class="lineNum">    1264 </span>            :     // bookmark folder, we can more efficiently generate results.
<span class="lineNum">    1265 </span><span class="lineCov">          1 :     nsNavBookmarks* bookmarks = nsNavBookmarks::GetBookmarksService();</span>
<span class="lineNum">    1266 </span><span class="lineCov">          1 :     NS_ENSURE_TRUE(bookmarks, NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">    1267 </span>            :     RefPtr&lt;nsNavHistoryResultNode&gt; tempRootNode;
<span class="lineNum">    1268 </span>            :     rv = bookmarks-&gt;ResultNodeForContainer(folderId, options,
<span class="lineNum">    1269 </span><span class="lineCov">          1 :                                            getter_AddRefs(tempRootNode));</span>
<span class="lineNum">    1270 </span><span class="lineCov">          1 :     if (NS_SUCCEEDED(rv)) {</span>
<span class="lineNum">    1271 </span><span class="lineCov">          1 :       rootNode = tempRootNode-&gt;GetAsContainer();</span>
<span class="lineNum">    1272 </span>            :     }
<span class="lineNum">    1273 </span>            :     else {
<span class="lineNum">    1274 </span>            :       NS_WARNING(&quot;Generating a generic empty node for a broken query!&quot;);
<span class="lineNum">    1275 </span>            :       // This is a perf hack to generate an empty query that skips filtering.
<span class="lineNum">    1276 </span><span class="lineNoCov">          0 :       options-&gt;SetExcludeItems(true);</span>
<span class="lineNum">    1277 </span><span class="lineCov">          1 :     }</span>
<span class="lineNum">    1278 </span>            :   }
<span class="lineNum">    1279 </span>            : 
<span class="lineNum">    1280 </span><span class="lineCov">          1 :   if (!rootNode) {</span>
<span class="lineNum">    1281 </span>            :     // Either this is not a folder shortcut, or is a broken one.  In both cases
<span class="lineNum">    1282 </span>            :     // just generate a query node.
<span class="lineNum">    1283 </span><span class="lineCov">          1 :     rootNode = new nsNavHistoryQueryResultNode(EmptyCString(),</span>
<span class="lineNum">    1284 </span><span class="lineCov">          1 :                                                queries, options);</span>
<span class="lineNum">    1285 </span>            :   }
<span class="lineNum">    1286 </span>            : 
<span class="lineNum">    1287 </span>            :   // Create the result that will hold nodes.  Inject batching status into it.
<span class="lineNum">    1288 </span><span class="lineCov">          1 :   RefPtr&lt;nsNavHistoryResult&gt; result;</span>
<span class="lineNum">    1289 </span>            :   rv = nsNavHistoryResult::NewHistoryResult(aQueries, aQueryCount, options,
<span class="lineNum">    1290 </span><span class="lineCov">          1 :                                             rootNode, isBatching(),</span>
<span class="lineNum">    1291 </span><span class="lineCov">          1 :                                             getter_AddRefs(result));</span>
<span class="lineNum">    1292 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1293 </span>            : 
<span class="lineNum">    1294 </span><span class="lineCov">          1 :   result.forget(_retval);</span>
<span class="lineNum">    1295 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    1296 </span>            : }
<span class="lineNum">    1297 </span>            : 
<span class="lineNum">    1298 </span>            : // determine from our nsNavHistoryQuery array and nsNavHistoryQueryOptions
<span class="lineNum">    1299 </span>            : // if this is the place query from the history menu.
<span class="lineNum">    1300 </span>            : // from browser-menubar.inc, our history menu query is:
<span class="lineNum">    1301 </span>            : // place:sort=4&amp;maxResults=10
<span class="lineNum">    1302 </span>            : // note, any maxResult &gt; 0 will still be considered a history menu query
<span class="lineNum">    1303 </span>            : // or if this is the place query from the &quot;Most Visited&quot; item in the
<span class="lineNum">    1304 </span>            : // &quot;Smart Bookmarks&quot; folder: place:sort=8&amp;maxResults=10
<a name="1305"><span class="lineNum">    1305 </span>            : // note, any maxResult &gt; 0 will still be considered a Most Visited menu query</a>
<span class="lineNum">    1306 </span>            : static
<span class="lineNum">    1307 </span><span class="lineCov">          1 : bool IsOptimizableHistoryQuery(const nsCOMArray&lt;nsNavHistoryQuery&gt;&amp; aQueries,</span>
<span class="lineNum">    1308 </span>            :                                  nsNavHistoryQueryOptions *aOptions,
<span class="lineNum">    1309 </span>            :                                  uint16_t aSortMode)
<span class="lineNum">    1310 </span>            : {
<span class="lineNum">    1311 </span><span class="lineCov">          1 :   if (aQueries.Count() != 1)</span>
<span class="lineNum">    1312 </span>            :     return false;
<span class="lineNum">    1313 </span>            : 
<span class="lineNum">    1314 </span><span class="lineCov">          1 :   nsNavHistoryQuery *aQuery = aQueries[0];</span>
<span class="lineNum">    1315 </span>            : 
<span class="lineNum">    1316 </span><span class="lineCov">          1 :   if (aOptions-&gt;QueryType() != nsINavHistoryQueryOptions::QUERY_TYPE_HISTORY)</span>
<span class="lineNum">    1317 </span>            :     return false;
<span class="lineNum">    1318 </span>            : 
<span class="lineNum">    1319 </span><span class="lineCov">          1 :   if (aOptions-&gt;ResultType() != nsINavHistoryQueryOptions::RESULTS_AS_URI)</span>
<span class="lineNum">    1320 </span>            :     return false;
<span class="lineNum">    1321 </span>            : 
<span class="lineNum">    1322 </span><span class="lineCov">          1 :   if (aOptions-&gt;SortingMode() != aSortMode)</span>
<span class="lineNum">    1323 </span>            :     return false;
<span class="lineNum">    1324 </span>            : 
<span class="lineNum">    1325 </span><span class="lineCov">          1 :   if (aOptions-&gt;MaxResults() &lt;= 0)</span>
<span class="lineNum">    1326 </span>            :     return false;
<span class="lineNum">    1327 </span>            : 
<span class="lineNum">    1328 </span><span class="lineCov">          1 :   if (aOptions-&gt;ExcludeItems())</span>
<span class="lineNum">    1329 </span>            :     return false;
<span class="lineNum">    1330 </span>            : 
<span class="lineNum">    1331 </span><span class="lineCov">          1 :   if (aOptions-&gt;IncludeHidden())</span>
<span class="lineNum">    1332 </span>            :     return false;
<span class="lineNum">    1333 </span>            : 
<span class="lineNum">    1334 </span><span class="lineCov">          1 :   if (aQuery-&gt;MinVisits() != -1 || aQuery-&gt;MaxVisits() != -1)</span>
<span class="lineNum">    1335 </span>            :     return false;
<span class="lineNum">    1336 </span>            : 
<span class="lineNum">    1337 </span><span class="lineCov">          1 :   if (aQuery-&gt;BeginTime() || aQuery-&gt;BeginTimeReference())</span>
<span class="lineNum">    1338 </span>            :     return false;
<span class="lineNum">    1339 </span>            : 
<span class="lineNum">    1340 </span><span class="lineCov">          1 :   if (aQuery-&gt;EndTime() || aQuery-&gt;EndTimeReference())</span>
<span class="lineNum">    1341 </span>            :     return false;
<span class="lineNum">    1342 </span>            : 
<span class="lineNum">    1343 </span><span class="lineCov">          1 :   if (!aQuery-&gt;SearchTerms().IsEmpty())</span>
<span class="lineNum">    1344 </span>            :     return false;
<span class="lineNum">    1345 </span>            : 
<span class="lineNum">    1346 </span><span class="lineCov">          1 :   if (aQuery-&gt;OnlyBookmarked())</span>
<span class="lineNum">    1347 </span>            :     return false;
<span class="lineNum">    1348 </span>            : 
<span class="lineNum">    1349 </span><span class="lineCov">          1 :   if (aQuery-&gt;DomainIsHost() || !aQuery-&gt;Domain().IsEmpty())</span>
<span class="lineNum">    1350 </span>            :     return false;
<span class="lineNum">    1351 </span>            : 
<span class="lineNum">    1352 </span><span class="lineCov">          1 :   if (aQuery-&gt;AnnotationIsNot() || !aQuery-&gt;Annotation().IsEmpty())</span>
<span class="lineNum">    1353 </span>            :     return false;
<span class="lineNum">    1354 </span>            : 
<span class="lineNum">    1355 </span><span class="lineCov">          1 :   if (aQuery-&gt;Folders().Length() &gt; 0)</span>
<span class="lineNum">    1356 </span>            :     return false;
<span class="lineNum">    1357 </span>            : 
<span class="lineNum">    1358 </span><span class="lineCov">          1 :   if (aQuery-&gt;Tags().Length() &gt; 0)</span>
<span class="lineNum">    1359 </span>            :     return false;
<span class="lineNum">    1360 </span>            : 
<span class="lineNum">    1361 </span><span class="lineCov">          1 :   if (aQuery-&gt;Transitions().Length() &gt; 0)</span>
<span class="lineNum">    1362 </span>            :     return false;
<span class="lineNum">    1363 </span>            : 
<span class="lineNum">    1364 </span><span class="lineCov">          1 :   return true;</span>
<span class="lineNum">    1365 </span>            : }
<span class="lineNum">    1366 </span>            : 
<span class="lineNum">    1367 </span>            : static
<span class="lineNum">    1368 </span>            : bool NeedToFilterResultSet(const nsCOMArray&lt;nsNavHistoryQuery&gt;&amp; aQueries,
<span class="lineNum">    1369 </span>            :                              nsNavHistoryQueryOptions *aOptions)
<span class="lineNum">    1370 </span>            : {
<span class="lineNum">    1371 </span><span class="lineCov">          1 :   uint16_t resultType = aOptions-&gt;ResultType();</span>
<span class="lineNum">    1372 </span>            :   return resultType == nsINavHistoryQueryOptions::RESULTS_AS_TAG_CONTENTS;
<span class="lineNum">    1373 </span>            : }
<span class="lineNum">    1374 </span>            : 
<a name="1375"><span class="lineNum">    1375 </span>            : // ** Helper class for ConstructQueryString **/</a>
<span class="lineNum">    1376 </span>            : 
<span class="lineNum">    1377 </span><span class="lineCov">          1 : class PlacesSQLQueryBuilder</span>
<span class="lineNum">    1378 </span>            : {
<span class="lineNum">    1379 </span>            : public:
<span class="lineNum">    1380 </span>            :   PlacesSQLQueryBuilder(const nsCString&amp; aConditions,
<span class="lineNum">    1381 </span>            :                         nsNavHistoryQueryOptions* aOptions,
<span class="lineNum">    1382 </span>            :                         bool aUseLimit,
<span class="lineNum">    1383 </span>            :                         nsNavHistory::StringHash&amp; aAddParams,
<span class="lineNum">    1384 </span>            :                         bool aHasSearchTerms);
<span class="lineNum">    1385 </span>            : 
<span class="lineNum">    1386 </span>            :   nsresult GetQueryString(nsCString&amp; aQueryString);
<span class="lineNum">    1387 </span>            : 
<span class="lineNum">    1388 </span>            : private:
<span class="lineNum">    1389 </span>            :   nsresult Select();
<span class="lineNum">    1390 </span>            : 
<span class="lineNum">    1391 </span>            :   nsresult SelectAsURI();
<span class="lineNum">    1392 </span>            :   nsresult SelectAsVisit();
<span class="lineNum">    1393 </span>            :   nsresult SelectAsDay();
<span class="lineNum">    1394 </span>            :   nsresult SelectAsSite();
<span class="lineNum">    1395 </span>            :   nsresult SelectAsTag();
<span class="lineNum">    1396 </span>            : 
<span class="lineNum">    1397 </span>            :   nsresult Where();
<span class="lineNum">    1398 </span>            :   nsresult GroupBy();
<span class="lineNum">    1399 </span>            :   nsresult OrderBy();
<span class="lineNum">    1400 </span>            :   nsresult Limit();
<span class="lineNum">    1401 </span>            : 
<span class="lineNum">    1402 </span>            :   void OrderByColumnIndexAsc(int32_t aIndex);
<span class="lineNum">    1403 </span>            :   void OrderByColumnIndexDesc(int32_t aIndex);
<span class="lineNum">    1404 </span>            :   // Use these if you want a case insensitive sorting.
<span class="lineNum">    1405 </span>            :   void OrderByTextColumnIndexAsc(int32_t aIndex);
<span class="lineNum">    1406 </span>            :   void OrderByTextColumnIndexDesc(int32_t aIndex);
<span class="lineNum">    1407 </span>            : 
<span class="lineNum">    1408 </span>            :   const nsCString&amp; mConditions;
<span class="lineNum">    1409 </span>            :   bool mUseLimit;
<span class="lineNum">    1410 </span>            :   bool mHasSearchTerms;
<span class="lineNum">    1411 </span>            : 
<span class="lineNum">    1412 </span>            :   uint16_t mResultType;
<span class="lineNum">    1413 </span>            :   uint16_t mQueryType;
<span class="lineNum">    1414 </span>            :   bool mIncludeHidden;
<span class="lineNum">    1415 </span>            :   uint16_t mSortingMode;
<span class="lineNum">    1416 </span>            :   uint32_t mMaxResults;
<span class="lineNum">    1417 </span>            : 
<span class="lineNum">    1418 </span>            :   nsCString mQueryString;
<span class="lineNum">    1419 </span>            :   nsCString mGroupBy;
<span class="lineNum">    1420 </span>            :   bool mHasDateColumns;
<span class="lineNum">    1421 </span>            :   bool mSkipOrderBy;
<span class="lineNum">    1422 </span>            :   nsNavHistory::StringHash&amp; mAddParams;
<a name="1423"><span class="lineNum">    1423 </span>            : };</a>
<span class="lineNum">    1424 </span>            : 
<span class="lineNum">    1425 </span><span class="lineCov">          1 : PlacesSQLQueryBuilder::PlacesSQLQueryBuilder(</span>
<span class="lineNum">    1426 </span>            :     const nsCString&amp; aConditions,
<span class="lineNum">    1427 </span>            :     nsNavHistoryQueryOptions* aOptions,
<span class="lineNum">    1428 </span>            :     bool aUseLimit,
<span class="lineNum">    1429 </span>            :     nsNavHistory::StringHash&amp; aAddParams,
<span class="lineNum">    1430 </span>            :     bool aHasSearchTerms)
<span class="lineNum">    1431 </span>            : : mConditions(aConditions)
<span class="lineNum">    1432 </span>            : , mUseLimit(aUseLimit)
<span class="lineNum">    1433 </span>            : , mHasSearchTerms(aHasSearchTerms)
<span class="lineNum">    1434 </span><span class="lineCov">          1 : , mResultType(aOptions-&gt;ResultType())</span>
<span class="lineNum">    1435 </span><span class="lineCov">          1 : , mQueryType(aOptions-&gt;QueryType())</span>
<span class="lineNum">    1436 </span><span class="lineCov">          1 : , mIncludeHidden(aOptions-&gt;IncludeHidden())</span>
<span class="lineNum">    1437 </span><span class="lineCov">          1 : , mSortingMode(aOptions-&gt;SortingMode())</span>
<span class="lineNum">    1438 </span><span class="lineCov">          1 : , mMaxResults(aOptions-&gt;MaxResults())</span>
<span class="lineNum">    1439 </span>            : , mSkipOrderBy(false)
<span class="lineNum">    1440 </span><span class="lineCov">          1 : , mAddParams(aAddParams)</span>
<span class="lineNum">    1441 </span>            : {
<span class="lineNum">    1442 </span><span class="lineCov">          1 :   mHasDateColumns = (mQueryType == nsINavHistoryQueryOptions::QUERY_TYPE_BOOKMARKS);</span>
<span class="lineNum">    1443 </span><span class="lineCov">          1 : }</span>
<a name="1444"><span class="lineNum">    1444 </span>            : </a>
<span class="lineNum">    1445 </span>            : nsresult
<span class="lineNum">    1446 </span><span class="lineCov">          1 : PlacesSQLQueryBuilder::GetQueryString(nsCString&amp; aQueryString)</span>
<span class="lineNum">    1447 </span>            : {
<span class="lineNum">    1448 </span><span class="lineCov">          1 :   nsresult rv = Select();</span>
<span class="lineNum">    1449 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1450 </span><span class="lineCov">          1 :   rv = Where();</span>
<span class="lineNum">    1451 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1452 </span><span class="lineCov">          1 :   rv = GroupBy();</span>
<span class="lineNum">    1453 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1454 </span><span class="lineCov">          1 :   rv = OrderBy();</span>
<span class="lineNum">    1455 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1456 </span><span class="lineCov">          1 :   rv = Limit();</span>
<span class="lineNum">    1457 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1458 </span>            : 
<span class="lineNum">    1459 </span><span class="lineCov">          1 :   aQueryString = mQueryString;</span>
<span class="lineNum">    1460 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    1461 </span>            : }
<a name="1462"><span class="lineNum">    1462 </span>            : </a>
<span class="lineNum">    1463 </span>            : nsresult
<span class="lineNum">    1464 </span><span class="lineCov">          1 : PlacesSQLQueryBuilder::Select()</span>
<span class="lineNum">    1465 </span>            : {
<span class="lineNum">    1466 </span>            :   nsresult rv;
<span class="lineNum">    1467 </span>            : 
<span class="lineNum">    1468 </span><span class="lineCov">          1 :   switch (mResultType)</span>
<span class="lineNum">    1469 </span>            :   {
<span class="lineNum">    1470 </span>            :     case nsINavHistoryQueryOptions::RESULTS_AS_URI:
<span class="lineNum">    1471 </span>            :     case nsINavHistoryQueryOptions::RESULTS_AS_TAG_CONTENTS:
<span class="lineNum">    1472 </span><span class="lineCov">          1 :       rv = SelectAsURI();</span>
<span class="lineNum">    1473 </span><span class="lineCov">          1 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1474 </span>            :       break;
<span class="lineNum">    1475 </span>            : 
<span class="lineNum">    1476 </span>            :     case nsINavHistoryQueryOptions::RESULTS_AS_VISIT:
<span class="lineNum">    1477 </span>            :     case nsINavHistoryQueryOptions::RESULTS_AS_FULL_VISIT:
<span class="lineNum">    1478 </span><span class="lineCov">          1 :       rv = SelectAsVisit();</span>
<span class="lineNum">    1479 </span><span class="lineCov">          1 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1480 </span>            :       break;
<span class="lineNum">    1481 </span>            : 
<span class="lineNum">    1482 </span>            :     case nsINavHistoryQueryOptions::RESULTS_AS_DATE_QUERY:
<span class="lineNum">    1483 </span>            :     case nsINavHistoryQueryOptions::RESULTS_AS_DATE_SITE_QUERY:
<span class="lineNum">    1484 </span><span class="lineCov">          1 :       rv = SelectAsDay();</span>
<span class="lineNum">    1485 </span><span class="lineCov">          1 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1486 </span>            :       break;
<span class="lineNum">    1487 </span>            : 
<span class="lineNum">    1488 </span>            :     case nsINavHistoryQueryOptions::RESULTS_AS_SITE_QUERY:
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :       rv = SelectAsSite();</span>
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1491 </span>            :       break;
<span class="lineNum">    1492 </span>            : 
<span class="lineNum">    1493 </span>            :     case nsINavHistoryQueryOptions::RESULTS_AS_TAG_QUERY:
<span class="lineNum">    1494 </span><span class="lineCov">          1 :       rv = SelectAsTag();</span>
<span class="lineNum">    1495 </span><span class="lineCov">          1 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1496 </span>            :       break;
<span class="lineNum">    1497 </span>            : 
<span class="lineNum">    1498 </span>            :     default:
<span class="lineNum">    1499 </span>            :       NS_NOTREACHED(&quot;Invalid result type&quot;);
<span class="lineNum">    1500 </span>            :   }
<span class="lineNum">    1501 </span>            :   return NS_OK;
<span class="lineNum">    1502 </span>            : }
<a name="1503"><span class="lineNum">    1503 </span>            : </a>
<span class="lineNum">    1504 </span>            : nsresult
<span class="lineNum">    1505 </span><span class="lineCov">          1 : PlacesSQLQueryBuilder::SelectAsURI()</span>
<span class="lineNum">    1506 </span>            : {
<span class="lineNum">    1507 </span><span class="lineCov">          1 :   nsNavHistory *history = nsNavHistory::GetHistoryService();</span>
<span class="lineNum">    1508 </span><span class="lineCov">          1 :   NS_ENSURE_TRUE(history, NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">    1509 </span><span class="lineCov">          1 :   nsAutoCString tagsSqlFragment;</span>
<span class="lineNum">    1510 </span>            : 
<span class="lineNum">    1511 </span><span class="lineCov">          1 :   switch (mQueryType) {</span>
<span class="lineNum">    1512 </span>            :     case nsINavHistoryQueryOptions::QUERY_TYPE_HISTORY:
<span class="lineNum">    1513 </span>            :       GetTagsSqlFragment(history-&gt;GetTagsFolder(),
<span class="lineNum">    1514 </span>            :                          NS_LITERAL_CSTRING(&quot;h.id&quot;),
<span class="lineNum">    1515 </span>            :                          mHasSearchTerms,
<span class="lineNum">    1516 </span><span class="lineCov">          1 :                          tagsSqlFragment);</span>
<span class="lineNum">    1517 </span>            : 
<span class="lineNum">    1518 </span><span class="lineCov">          1 :       mQueryString = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1519 </span>            :         &quot;SELECT h.id, h.url, h.title AS page_title, h.rev_host, h.visit_count, &quot;
<span class="lineNum">    1520 </span><span class="lineCov">          1 :         &quot;h.last_visit_date, null, null, null, null, null, &quot;) +</span>
<span class="lineNum">    1521 </span><span class="lineCov">          1 :         tagsSqlFragment + NS_LITERAL_CSTRING(&quot;, h.frecency, h.hidden, h.guid, &quot;</span>
<span class="lineNum">    1522 </span>            :         &quot;null, null, null &quot;
<span class="lineNum">    1523 </span>            :         &quot;FROM moz_places h &quot;
<span class="lineNum">    1524 </span>            :         // WHERE 1 is a no-op since additonal conditions will start with AND.
<span class="lineNum">    1525 </span>            :         &quot;WHERE 1 &quot;
<span class="lineNum">    1526 </span>            :           &quot;{QUERY_OPTIONS_VISITS} {QUERY_OPTIONS_PLACES} &quot;
<span class="lineNum">    1527 </span>            :           &quot;{ADDITIONAL_CONDITIONS} &quot;);
<span class="lineNum">    1528 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    1529 </span>            : 
<span class="lineNum">    1530 </span>            :     case nsINavHistoryQueryOptions::QUERY_TYPE_BOOKMARKS:
<span class="lineNum">    1531 </span><span class="lineCov">          1 :       if (mResultType == nsINavHistoryQueryOptions::RESULTS_AS_TAG_CONTENTS) {</span>
<span class="lineNum">    1532 </span>            :         // Order-by clause is hardcoded because we need to discard duplicates
<span class="lineNum">    1533 </span>            :         // in FilterResultSet. We will retain only the last modified item,
<span class="lineNum">    1534 </span>            :         // so we are ordering by place id and last modified to do a faster
<span class="lineNum">    1535 </span>            :         // filtering.
<span class="lineNum">    1536 </span><span class="lineCov">          1 :         mSkipOrderBy = true;</span>
<span class="lineNum">    1537 </span>            : 
<span class="lineNum">    1538 </span>            :         GetTagsSqlFragment(history-&gt;GetTagsFolder(),
<span class="lineNum">    1539 </span>            :                            NS_LITERAL_CSTRING(&quot;b2.fk&quot;),
<span class="lineNum">    1540 </span>            :                            mHasSearchTerms,
<span class="lineNum">    1541 </span><span class="lineCov">          1 :                            tagsSqlFragment);</span>
<span class="lineNum">    1542 </span>            : 
<span class="lineNum">    1543 </span><span class="lineCov">          1 :         mQueryString = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1544 </span>            :           &quot;SELECT b2.fk, h.url, COALESCE(b2.title, h.title) AS page_title, &quot;
<span class="lineNum">    1545 </span>            :             &quot;h.rev_host, h.visit_count, h.last_visit_date, null, b2.id, &quot;
<span class="lineNum">    1546 </span><span class="lineCov">          1 :             &quot;b2.dateAdded, b2.lastModified, b2.parent, &quot;) +</span>
<span class="lineNum">    1547 </span><span class="lineCov">          1 :             tagsSqlFragment + NS_LITERAL_CSTRING(&quot;, h.frecency, h.hidden, h.guid, &quot;</span>
<span class="lineNum">    1548 </span>            :             &quot;null, null, null, b2.guid, b2.position, b2.type, b2.fk &quot;
<span class="lineNum">    1549 </span>            :           &quot;FROM moz_bookmarks b2 &quot;
<span class="lineNum">    1550 </span>            :           &quot;JOIN (SELECT b.fk &quot;
<span class="lineNum">    1551 </span>            :                 &quot;FROM moz_bookmarks b &quot;
<span class="lineNum">    1552 </span>            :                 // ADDITIONAL_CONDITIONS will filter on parent.
<span class="lineNum">    1553 </span>            :                 &quot;WHERE b.type = 1 {ADDITIONAL_CONDITIONS} &quot;
<span class="lineNum">    1554 </span>            :                 &quot;) AS seed ON b2.fk = seed.fk &quot;
<span class="lineNum">    1555 </span>            :           &quot;JOIN moz_places h ON h.id = b2.fk &quot;
<span class="lineNum">    1556 </span>            :           &quot;WHERE NOT EXISTS ( &quot;
<span class="lineNum">    1557 </span><span class="lineCov">          1 :             &quot;SELECT id FROM moz_bookmarks WHERE id = b2.parent AND parent = &quot;) +</span>
<span class="lineNum">    1558 </span><span class="lineCov">          1 :                 nsPrintfCString(&quot;%&quot; PRId64, history-&gt;GetTagsFolder()) +</span>
<span class="lineNum">    1559 </span><span class="lineCov">          1 :           NS_LITERAL_CSTRING(&quot;) &quot;</span>
<span class="lineNum">    1560 </span>            :           &quot;ORDER BY b2.fk DESC, b2.lastModified DESC&quot;);
<span class="lineNum">    1561 </span>            :       }
<span class="lineNum">    1562 </span>            :       else {
<span class="lineNum">    1563 </span>            :         GetTagsSqlFragment(history-&gt;GetTagsFolder(),
<span class="lineNum">    1564 </span>            :                            NS_LITERAL_CSTRING(&quot;b.fk&quot;),
<span class="lineNum">    1565 </span>            :                            mHasSearchTerms,
<span class="lineNum">    1566 </span><span class="lineCov">          1 :                            tagsSqlFragment);</span>
<span class="lineNum">    1567 </span><span class="lineCov">          1 :         mQueryString = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1568 </span>            :           &quot;SELECT b.fk, h.url, COALESCE(b.title, h.title) AS page_title, &quot;
<span class="lineNum">    1569 </span>            :             &quot;h.rev_host, h.visit_count, h.last_visit_date, null, b.id, &quot;
<span class="lineNum">    1570 </span><span class="lineCov">          1 :             &quot;b.dateAdded, b.lastModified, b.parent, &quot;) +</span>
<span class="lineNum">    1571 </span><span class="lineCov">          1 :             tagsSqlFragment + NS_LITERAL_CSTRING(&quot;, h.frecency, h.hidden, h.guid,&quot;</span>
<span class="lineNum">    1572 </span>            :             &quot;null, null, null, b.guid, b.position, b.type, b.fk &quot;
<span class="lineNum">    1573 </span>            :           &quot;FROM moz_bookmarks b &quot;
<span class="lineNum">    1574 </span>            :           &quot;JOIN moz_places h ON b.fk = h.id &quot;
<span class="lineNum">    1575 </span>            :           &quot;WHERE NOT EXISTS &quot;
<span class="lineNum">    1576 </span>            :               &quot;(SELECT id FROM moz_bookmarks &quot;
<span class="lineNum">    1577 </span><span class="lineCov">          1 :                 &quot;WHERE id = b.parent AND parent = &quot;) +</span>
<span class="lineNum">    1578 </span><span class="lineCov">          1 :                   nsPrintfCString(&quot;%&quot; PRId64, history-&gt;GetTagsFolder()) +</span>
<span class="lineNum">    1579 </span><span class="lineCov">          1 :               NS_LITERAL_CSTRING(&quot;) &quot;</span>
<span class="lineNum">    1580 </span>            :             &quot;{ADDITIONAL_CONDITIONS}&quot;);
<span class="lineNum">    1581 </span>            :       }
<span class="lineNum">    1582 </span>            :       break;
<span class="lineNum">    1583 </span>            : 
<span class="lineNum">    1584 </span>            :     default:
<span class="lineNum">    1585 </span>            :       return NS_ERROR_NOT_IMPLEMENTED;
<span class="lineNum">    1586 </span>            :   }
<span class="lineNum">    1587 </span>            :   return NS_OK;
<span class="lineNum">    1588 </span>            : }
<a name="1589"><span class="lineNum">    1589 </span>            : </a>
<span class="lineNum">    1590 </span>            : nsresult
<span class="lineNum">    1591 </span><span class="lineCov">          1 : PlacesSQLQueryBuilder::SelectAsVisit()</span>
<span class="lineNum">    1592 </span>            : {
<span class="lineNum">    1593 </span><span class="lineCov">          1 :   nsNavHistory *history = nsNavHistory::GetHistoryService();</span>
<span class="lineNum">    1594 </span><span class="lineCov">          1 :   NS_ENSURE_TRUE(history, NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">    1595 </span><span class="lineCov">          1 :   nsAutoCString tagsSqlFragment;</span>
<span class="lineNum">    1596 </span>            :   GetTagsSqlFragment(history-&gt;GetTagsFolder(),
<span class="lineNum">    1597 </span>            :                      NS_LITERAL_CSTRING(&quot;h.id&quot;),
<span class="lineNum">    1598 </span>            :                      mHasSearchTerms,
<span class="lineNum">    1599 </span><span class="lineCov">          1 :                      tagsSqlFragment);</span>
<span class="lineNum">    1600 </span><span class="lineCov">          1 :   mQueryString = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1601 </span>            :     &quot;SELECT h.id, h.url, h.title AS page_title, h.rev_host, h.visit_count, &quot;
<span class="lineNum">    1602 </span><span class="lineCov">          1 :       &quot;v.visit_date, null, null, null, null, null, &quot;) +</span>
<span class="lineNum">    1603 </span><span class="lineCov">          1 :       tagsSqlFragment + NS_LITERAL_CSTRING(&quot;, h.frecency, h.hidden, h.guid, &quot;</span>
<span class="lineNum">    1604 </span>            :       &quot;v.id, v.from_visit, v.visit_type &quot;
<span class="lineNum">    1605 </span>            :     &quot;FROM moz_places h &quot;
<span class="lineNum">    1606 </span>            :     &quot;JOIN moz_historyvisits v ON h.id = v.place_id &quot;
<span class="lineNum">    1607 </span>            :     // WHERE 1 is a no-op since additonal conditions will start with AND.
<span class="lineNum">    1608 </span>            :     &quot;WHERE 1 &quot;
<span class="lineNum">    1609 </span>            :       &quot;{QUERY_OPTIONS_VISITS} {QUERY_OPTIONS_PLACES} &quot;
<span class="lineNum">    1610 </span>            :       &quot;{ADDITIONAL_CONDITIONS} &quot;);
<span class="lineNum">    1611 </span>            : 
<span class="lineNum">    1612 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    1613 </span>            : }
<a name="1614"><span class="lineNum">    1614 </span>            : </a>
<span class="lineNum">    1615 </span>            : nsresult
<span class="lineNum">    1616 </span><span class="lineCov">          1 : PlacesSQLQueryBuilder::SelectAsDay()</span>
<span class="lineNum">    1617 </span>            : {
<span class="lineNum">    1618 </span><span class="lineCov">          1 :   mSkipOrderBy = true;</span>
<span class="lineNum">    1619 </span>            : 
<span class="lineNum">    1620 </span>            :   // Sort child queries based on sorting mode if it's provided, otherwise
<span class="lineNum">    1621 </span>            :   // fallback to default sort by title ascending.
<span class="lineNum">    1622 </span><span class="lineCov">          1 :   uint16_t sortingMode = nsINavHistoryQueryOptions::SORT_BY_TITLE_ASCENDING;</span>
<span class="lineNum">    1623 </span><span class="lineCov">          1 :   if (mSortingMode != nsINavHistoryQueryOptions::SORT_BY_NONE &amp;&amp;</span>
<span class="lineNum">    1624 </span><span class="lineCov">          1 :       mResultType == nsINavHistoryQueryOptions::RESULTS_AS_DATE_QUERY)</span>
<span class="lineNum">    1625 </span><span class="lineCov">          1 :     sortingMode = mSortingMode;</span>
<span class="lineNum">    1626 </span>            : 
<span class="lineNum">    1627 </span>            :   uint16_t resultType =
<span class="lineNum">    1628 </span><span class="lineCov">          1 :     mResultType == nsINavHistoryQueryOptions::RESULTS_AS_DATE_QUERY ?</span>
<span class="lineNum">    1629 </span>            :       (uint16_t)nsINavHistoryQueryOptions::RESULTS_AS_URI :
<span class="lineNum">    1630 </span><span class="lineCov">          1 :       (uint16_t)nsINavHistoryQueryOptions::RESULTS_AS_SITE_QUERY;</span>
<span class="lineNum">    1631 </span>            : 
<span class="lineNum">    1632 </span>            :   // beginTime will become the node's time property, we don't use endTime
<span class="lineNum">    1633 </span>            :   // because it could overlap, and we use time to sort containers and find
<span class="lineNum">    1634 </span>            :   // insert position in a result.
<span class="lineNum">    1635 </span><span class="lineCov">          1 :   mQueryString = nsPrintfCString(</span>
<span class="lineNum">    1636 </span>            :      &quot;SELECT null, &quot;
<span class="lineNum">    1637 </span>            :        &quot;'place:type=%d&amp;sort=%d&amp;beginTime='||beginTime||'&amp;endTime='||endTime, &quot;
<span class="lineNum">    1638 </span>            :       &quot;dayTitle, null, null, beginTime, null, null, null, null, null, null, &quot;
<span class="lineNum">    1639 </span>            :       &quot;null, null, null &quot;
<span class="lineNum">    1640 </span>            :      &quot;FROM (&quot;, // TOUTER BEGIN
<span class="lineNum">    1641 </span>            :      resultType,
<span class="lineNum">    1642 </span>            :      sortingMode);
<span class="lineNum">    1643 </span>            : 
<span class="lineNum">    1644 </span><span class="lineCov">          1 :   nsNavHistory *history = nsNavHistory::GetHistoryService();</span>
<span class="lineNum">    1645 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(history);</span>
<span class="lineNum">    1646 </span>            : 
<span class="lineNum">    1647 </span><span class="lineCov">          1 :   int32_t daysOfHistory = history-&gt;GetDaysOfHistory();</span>
<span class="lineNum">    1648 </span><span class="lineCov">          1 :   for (int32_t i = 0; i &lt;= HISTORY_DATE_CONT_NUM(daysOfHistory); i++) {</span>
<span class="lineNum">    1649 </span><span class="lineCov">          1 :     nsAutoCString dateName;</span>
<span class="lineNum">    1650 </span>            :     // Timeframes are calculated as BeginTime &lt;= container &lt; EndTime.
<span class="lineNum">    1651 </span>            :     // Notice times can't be relative to now, since to recognize a query we
<span class="lineNum">    1652 </span>            :     // must ensure it won't change based on the time it is built.
<span class="lineNum">    1653 </span>            :     // So, to select till now, we really select till start of tomorrow, that is
<span class="lineNum">    1654 </span>            :     // a fixed timestamp.
<span class="lineNum">    1655 </span>            :     // These are used as limits for the inside containers.
<span class="lineNum">    1656 </span><span class="lineCov">          1 :     nsAutoCString sqlFragmentContainerBeginTime, sqlFragmentContainerEndTime;</span>
<span class="lineNum">    1657 </span>            :     // These are used to query if the container should be visible.
<span class="lineNum">    1658 </span><span class="lineCov">          1 :     nsAutoCString sqlFragmentSearchBeginTime, sqlFragmentSearchEndTime;</span>
<span class="lineNum">    1659 </span><span class="lineCov">          1 :     switch(i) {</span>
<span class="lineNum">    1660 </span>            :        case 0:
<span class="lineNum">    1661 </span>            :         // Today
<span class="lineNum">    1662 </span>            :          history-&gt;GetStringFromName(
<span class="lineNum">    1663 </span><span class="lineCov">          1 :           u&quot;finduri-AgeInDays-is-0&quot;, dateName);</span>
<span class="lineNum">    1664 </span>            :         // From start of today
<span class="lineNum">    1665 </span><span class="lineCov">          1 :         sqlFragmentContainerBeginTime = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1666 </span>            :           &quot;(strftime('%s','now','localtime','start of day','utc')*1000000)&quot;);
<span class="lineNum">    1667 </span>            :         // To now (tomorrow)
<span class="lineNum">    1668 </span><span class="lineCov">          1 :         sqlFragmentContainerEndTime = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1669 </span>            :           &quot;(strftime('%s','now','localtime','start of day','+1 day','utc')*1000000)&quot;);
<span class="lineNum">    1670 </span>            :         // Search for the same timeframe.
<span class="lineNum">    1671 </span>            :         sqlFragmentSearchBeginTime = sqlFragmentContainerBeginTime;
<span class="lineNum">    1672 </span>            :         sqlFragmentSearchEndTime = sqlFragmentContainerEndTime;
<span class="lineNum">    1673 </span>            :          break;
<span class="lineNum">    1674 </span>            :        case 1:
<span class="lineNum">    1675 </span>            :         // Yesterday
<span class="lineNum">    1676 </span>            :          history-&gt;GetStringFromName(
<span class="lineNum">    1677 </span><span class="lineCov">          1 :           u&quot;finduri-AgeInDays-is-1&quot;, dateName);</span>
<span class="lineNum">    1678 </span>            :         // From start of yesterday
<span class="lineNum">    1679 </span><span class="lineCov">          1 :         sqlFragmentContainerBeginTime = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1680 </span>            :           &quot;(strftime('%s','now','localtime','start of day','-1 day','utc')*1000000)&quot;);
<span class="lineNum">    1681 </span>            :         // To start of today
<span class="lineNum">    1682 </span><span class="lineCov">          1 :         sqlFragmentContainerEndTime = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1683 </span>            :           &quot;(strftime('%s','now','localtime','start of day','utc')*1000000)&quot;);
<span class="lineNum">    1684 </span>            :         // Search for the same timeframe.
<span class="lineNum">    1685 </span>            :         sqlFragmentSearchBeginTime = sqlFragmentContainerBeginTime;
<span class="lineNum">    1686 </span>            :         sqlFragmentSearchEndTime = sqlFragmentContainerEndTime;
<span class="lineNum">    1687 </span>            :         break;
<span class="lineNum">    1688 </span>            :       case 2:
<span class="lineNum">    1689 </span>            :         // Last 7 days
<span class="lineNum">    1690 </span>            :         history-&gt;GetAgeInDaysString(7,
<span class="lineNum">    1691 </span><span class="lineCov">          1 :           u&quot;finduri-AgeInDays-last-is&quot;, dateName);</span>
<span class="lineNum">    1692 </span>            :         // From start of 7 days ago
<span class="lineNum">    1693 </span><span class="lineCov">          1 :         sqlFragmentContainerBeginTime = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1694 </span>            :           &quot;(strftime('%s','now','localtime','start of day','-7 days','utc')*1000000)&quot;);
<span class="lineNum">    1695 </span>            :         // To now (tomorrow)
<span class="lineNum">    1696 </span><span class="lineCov">          1 :         sqlFragmentContainerEndTime = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1697 </span>            :           &quot;(strftime('%s','now','localtime','start of day','+1 day','utc')*1000000)&quot;);
<span class="lineNum">    1698 </span>            :         // This is an overlapped container, but we show it only if there are
<span class="lineNum">    1699 </span>            :         // visits older than yesterday.
<span class="lineNum">    1700 </span>            :         sqlFragmentSearchBeginTime = sqlFragmentContainerBeginTime;
<span class="lineNum">    1701 </span><span class="lineCov">          1 :         sqlFragmentSearchEndTime = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1702 </span>            :           &quot;(strftime('%s','now','localtime','start of day','-2 days','utc')*1000000)&quot;);
<span class="lineNum">    1703 </span><span class="lineCov">          1 :         break;</span>
<span class="lineNum">    1704 </span>            :       case 3:
<span class="lineNum">    1705 </span>            :         // This month
<span class="lineNum">    1706 </span>            :         history-&gt;GetStringFromName(
<span class="lineNum">    1707 </span><span class="lineCov">          1 :           u&quot;finduri-AgeInMonths-is-0&quot;, dateName);</span>
<span class="lineNum">    1708 </span>            :         // From start of this month
<span class="lineNum">    1709 </span><span class="lineCov">          1 :         sqlFragmentContainerBeginTime = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1710 </span>            :           &quot;(strftime('%s','now','localtime','start of month','utc')*1000000)&quot;);
<span class="lineNum">    1711 </span>            :         // To now (tomorrow)
<span class="lineNum">    1712 </span><span class="lineCov">          1 :         sqlFragmentContainerEndTime = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1713 </span>            :           &quot;(strftime('%s','now','localtime','start of day','+1 day','utc')*1000000)&quot;);
<span class="lineNum">    1714 </span>            :         // This is an overlapped container, but we show it only if there are
<span class="lineNum">    1715 </span>            :         // visits older than 7 days ago.
<span class="lineNum">    1716 </span>            :         sqlFragmentSearchBeginTime = sqlFragmentContainerBeginTime;
<span class="lineNum">    1717 </span><span class="lineCov">          1 :         sqlFragmentSearchEndTime = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1718 </span>            :           &quot;(strftime('%s','now','localtime','start of day','-7 days','utc')*1000000)&quot;);
<span class="lineNum">    1719 </span><span class="lineCov">          1 :          break;</span>
<span class="lineNum">    1720 </span>            :        default:
<span class="lineNum">    1721 </span><span class="lineCov">          1 :         if (i == HISTORY_ADDITIONAL_DATE_CONT_NUM + 6) {</span>
<span class="lineNum">    1722 </span>            :           // Older than 6 months
<span class="lineNum">    1723 </span>            :           history-&gt;GetAgeInDaysString(6,
<span class="lineNum">    1724 </span><span class="lineNoCov">          0 :             u&quot;finduri-AgeInMonths-isgreater&quot;, dateName);</span>
<span class="lineNum">    1725 </span>            :           // From start of epoch
<span class="lineNum">    1726 </span><span class="lineNoCov">          0 :           sqlFragmentContainerBeginTime = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1727 </span>            :             &quot;(datetime(0, 'unixepoch')*1000000)&quot;);
<span class="lineNum">    1728 </span>            :           // To start of 6 months ago ( 5 months + this month).
<span class="lineNum">    1729 </span><span class="lineNoCov">          0 :           sqlFragmentContainerEndTime = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1730 </span>            :             &quot;(strftime('%s','now','localtime','start of month','-5 months','utc')*1000000)&quot;);
<span class="lineNum">    1731 </span>            :           // Search for the same timeframe.
<span class="lineNum">    1732 </span>            :           sqlFragmentSearchBeginTime = sqlFragmentContainerBeginTime;
<span class="lineNum">    1733 </span>            :           sqlFragmentSearchEndTime = sqlFragmentContainerEndTime;
<span class="lineNum">    1734 </span>            :           break;
<span class="lineNum">    1735 </span>            :         }
<span class="lineNum">    1736 </span><span class="lineCov">          1 :         int32_t MonthIndex = i - HISTORY_ADDITIONAL_DATE_CONT_NUM;</span>
<span class="lineNum">    1737 </span>            :         // Previous months' titles are month's name if inside this year,
<span class="lineNum">    1738 </span>            :         // month's name and year for previous years.
<span class="lineNum">    1739 </span>            :         PRExplodedTime tm;
<span class="lineNum">    1740 </span><span class="lineCov">          1 :         PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;tm);</span>
<span class="lineNum">    1741 </span><span class="lineCov">          1 :         uint16_t currentYear = tm.tm_year;</span>
<span class="lineNum">    1742 </span>            :         // Set day before month, setting month without day could cause issues.
<span class="lineNum">    1743 </span>            :         // For example setting month to February when today is 30, since
<span class="lineNum">    1744 </span>            :         // February has not 30 days, will return March instead.
<span class="lineNum">    1745 </span>            :         // Also, we use day 2 instead of day 1, so that the GMT month is always
<span class="lineNum">    1746 </span>            :         // the same as the local month. (Bug 603002)
<span class="lineNum">    1747 </span><span class="lineCov">          1 :         tm.tm_mday = 2;</span>
<span class="lineNum">    1748 </span><span class="lineCov">          1 :         tm.tm_month -= MonthIndex;</span>
<span class="lineNum">    1749 </span>            :         // Notice we use GMTParameters because we just want to get the first
<span class="lineNum">    1750 </span>            :         // day of each month.  Using LocalTimeParameters would instead force us
<span class="lineNum">    1751 </span>            :         // to apply a DST correction that we don't really need here.
<span class="lineNum">    1752 </span><span class="lineCov">          1 :         PR_NormalizeTime(&amp;tm, PR_GMTParameters);</span>
<span class="lineNum">    1753 </span>            :         // If the container is for a past year, add the year to its title,
<span class="lineNum">    1754 </span>            :         // otherwise just show the month name.
<span class="lineNum">    1755 </span><span class="lineCov">          1 :         if (tm.tm_year &lt; currentYear) {</span>
<span class="lineNum">    1756 </span><span class="lineNoCov">          0 :           nsNavHistory::GetMonthYear(tm, dateName);</span>
<span class="lineNum">    1757 </span>            :         }
<span class="lineNum">    1758 </span>            :         else {
<span class="lineNum">    1759 </span><span class="lineCov">          1 :           nsNavHistory::GetMonthName(tm, dateName);</span>
<span class="lineNum">    1760 </span>            :         }
<span class="lineNum">    1761 </span>            : 
<span class="lineNum">    1762 </span>            :         // From start of MonthIndex + 1 months ago
<span class="lineNum">    1763 </span><span class="lineCov">          1 :         sqlFragmentContainerBeginTime = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1764 </span>            :           &quot;(strftime('%s','now','localtime','start of month','-&quot;);
<span class="lineNum">    1765 </span><span class="lineCov">          1 :         sqlFragmentContainerBeginTime.AppendInt(MonthIndex);</span>
<span class="lineNum">    1766 </span>            :         sqlFragmentContainerBeginTime.Append(NS_LITERAL_CSTRING(
<span class="lineNum">    1767 </span><span class="lineCov">          1 :             &quot; months','utc')*1000000)&quot;));</span>
<span class="lineNum">    1768 </span>            :         // To start of MonthIndex months ago
<span class="lineNum">    1769 </span><span class="lineCov">          1 :         sqlFragmentContainerEndTime = NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1770 </span>            :           &quot;(strftime('%s','now','localtime','start of month','-&quot;);
<span class="lineNum">    1771 </span><span class="lineCov">          1 :         sqlFragmentContainerEndTime.AppendInt(MonthIndex - 1);</span>
<span class="lineNum">    1772 </span>            :         sqlFragmentContainerEndTime.Append(NS_LITERAL_CSTRING(
<span class="lineNum">    1773 </span><span class="lineCov">          1 :             &quot; months','utc')*1000000)&quot;));</span>
<span class="lineNum">    1774 </span>            :         // Search for the same timeframe.
<span class="lineNum">    1775 </span>            :         sqlFragmentSearchBeginTime = sqlFragmentContainerBeginTime;
<span class="lineNum">    1776 </span>            :         sqlFragmentSearchEndTime = sqlFragmentContainerEndTime;
<span class="lineNum">    1777 </span>            :         break;
<span class="lineNum">    1778 </span>            :     }
<span class="lineNum">    1779 </span>            : 
<span class="lineNum">    1780 </span><span class="lineCov">          1 :     nsPrintfCString dateParam(&quot;dayTitle%d&quot;, i);</span>
<span class="lineNum">    1781 </span><span class="lineCov">          1 :     mAddParams.Put(dateParam, dateName);</span>
<span class="lineNum">    1782 </span>            : 
<span class="lineNum">    1783 </span>            :     nsPrintfCString dayRange(
<span class="lineNum">    1784 </span>            :       &quot;SELECT :%s AS dayTitle, &quot;
<span class="lineNum">    1785 </span>            :              &quot;%s AS beginTime, &quot;
<span class="lineNum">    1786 </span>            :              &quot;%s AS endTime &quot;
<span class="lineNum">    1787 </span>            :        &quot;WHERE EXISTS ( &quot;
<span class="lineNum">    1788 </span>            :         &quot;SELECT id FROM moz_historyvisits &quot;
<span class="lineNum">    1789 </span>            :         &quot;WHERE visit_date &gt;= %s &quot;
<span class="lineNum">    1790 </span>            :           &quot;AND visit_date &lt; %s &quot;
<span class="lineNum">    1791 </span>            :            &quot;AND visit_type NOT IN (0,%d,%d) &quot;
<span class="lineNum">    1792 </span>            :            &quot;{QUERY_OPTIONS_VISITS} &quot;
<span class="lineNum">    1793 </span>            :          &quot;LIMIT 1 &quot;
<span class="lineNum">    1794 </span>            :       &quot;) &quot;,
<span class="lineNum">    1795 </span>            :       dateParam.get(),
<span class="lineNum">    1796 </span>            :       sqlFragmentContainerBeginTime.get(),
<span class="lineNum">    1797 </span>            :       sqlFragmentContainerEndTime.get(),
<span class="lineNum">    1798 </span>            :       sqlFragmentSearchBeginTime.get(),
<span class="lineNum">    1799 </span>            :       sqlFragmentSearchEndTime.get(),
<span class="lineNum">    1800 </span>            :       nsINavHistoryService::TRANSITION_EMBED,
<span class="lineNum">    1801 </span>            :       nsINavHistoryService::TRANSITION_FRAMED_LINK
<span class="lineNum">    1802 </span><span class="lineCov">          1 :     );</span>
<span class="lineNum">    1803 </span>            : 
<span class="lineNum">    1804 </span><span class="lineCov">          1 :     mQueryString.Append(dayRange);</span>
<span class="lineNum">    1805 </span>            : 
<span class="lineNum">    1806 </span><span class="lineCov">          1 :     if (i &lt; HISTORY_DATE_CONT_NUM(daysOfHistory))</span>
<span class="lineNum">    1807 </span><span class="lineCov">          1 :       mQueryString.AppendLiteral(&quot; UNION ALL &quot;);</span>
<span class="lineNum">    1808 </span>            :   }
<span class="lineNum">    1809 </span>            : 
<span class="lineNum">    1810 </span><span class="lineCov">          1 :   mQueryString.AppendLiteral(&quot;) &quot;); // TOUTER END</span>
<span class="lineNum">    1811 </span>            : 
<span class="lineNum">    1812 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    1813 </span>            : }
<a name="1814"><span class="lineNum">    1814 </span>            : </a>
<span class="lineNum">    1815 </span>            : nsresult
<span class="lineNum">    1816 </span><span class="lineNoCov">          0 : PlacesSQLQueryBuilder::SelectAsSite()</span>
<span class="lineNum">    1817 </span>            : {
<span class="lineNum">    1818 </span><span class="lineNoCov">          0 :   nsAutoCString localFiles;</span>
<span class="lineNum">    1819 </span>            : 
<span class="lineNum">    1820 </span><span class="lineNoCov">          0 :   nsNavHistory *history = nsNavHistory::GetHistoryService();</span>
<span class="lineNum">    1821 </span><span class="lineNoCov">          0 :   NS_ENSURE_STATE(history);</span>
<span class="lineNum">    1822 </span>            : 
<span class="lineNum">    1823 </span><span class="lineNoCov">          0 :   history-&gt;GetStringFromName(u&quot;localhost&quot;, localFiles);</span>
<span class="lineNum">    1824 </span><span class="lineNoCov">          0 :   mAddParams.Put(NS_LITERAL_CSTRING(&quot;localhost&quot;), localFiles);</span>
<span class="lineNum">    1825 </span>            : 
<span class="lineNum">    1826 </span>            :   // If there are additional conditions the query has to join on visits too.
<span class="lineNum">    1827 </span><span class="lineNoCov">          0 :   nsAutoCString visitsJoin;</span>
<span class="lineNum">    1828 </span><span class="lineNoCov">          0 :   nsAutoCString additionalConditions;</span>
<span class="lineNum">    1829 </span><span class="lineNoCov">          0 :   nsAutoCString timeConstraints;</span>
<span class="lineNum">    1830 </span><span class="lineNoCov">          0 :   if (!mConditions.IsEmpty()) {</span>
<span class="lineNum">    1831 </span><span class="lineNoCov">          0 :     visitsJoin.AssignLiteral(&quot;JOIN moz_historyvisits v ON v.place_id = h.id &quot;);</span>
<span class="lineNum">    1832 </span>            :     additionalConditions.AssignLiteral(&quot;{QUERY_OPTIONS_VISITS} &quot;
<span class="lineNum">    1833 </span>            :                                        &quot;{QUERY_OPTIONS_PLACES} &quot;
<span class="lineNum">    1834 </span><span class="lineNoCov">          0 :                                        &quot;{ADDITIONAL_CONDITIONS} &quot;);</span>
<span class="lineNum">    1835 </span>            :     timeConstraints.AssignLiteral(&quot;||'&amp;beginTime='||:begin_time||&quot;
<span class="lineNum">    1836 </span><span class="lineNoCov">          0 :                                     &quot;'&amp;endTime='||:end_time&quot;);</span>
<span class="lineNum">    1837 </span>            :   }
<span class="lineNum">    1838 </span>            : 
<span class="lineNum">    1839 </span><span class="lineNoCov">          0 :   mQueryString = nsPrintfCString(</span>
<span class="lineNum">    1840 </span>            :     &quot;SELECT null, 'place:type=%d&amp;sort=%d&amp;domain=&amp;domainIsHost=true'%s, &quot;
<span class="lineNum">    1841 </span>            :            &quot;:localhost, :localhost, null, null, null, null, null, null, null, &quot;
<span class="lineNum">    1842 </span>            :            &quot;null, null, null &quot;
<span class="lineNum">    1843 </span>            :     &quot;WHERE EXISTS ( &quot;
<span class="lineNum">    1844 </span>            :       &quot;SELECT h.id FROM moz_places h &quot;
<span class="lineNum">    1845 </span>            :       &quot;%s &quot;
<span class="lineNum">    1846 </span>            :       &quot;WHERE h.hidden = 0 &quot;
<span class="lineNum">    1847 </span>            :         &quot;AND h.visit_count &gt; 0 &quot;
<span class="lineNum">    1848 </span>            :         &quot;AND h.url_hash BETWEEN hash('file', 'prefix_lo') AND &quot;
<span class="lineNum">    1849 </span>            :                                &quot;hash('file', 'prefix_hi') &quot;
<span class="lineNum">    1850 </span>            :       &quot;%s &quot;
<span class="lineNum">    1851 </span>            :       &quot;LIMIT 1 &quot;
<span class="lineNum">    1852 </span>            :     &quot;) &quot;
<span class="lineNum">    1853 </span>            :     &quot;UNION ALL &quot;
<span class="lineNum">    1854 </span>            :     &quot;SELECT null, &quot;
<span class="lineNum">    1855 </span>            :            &quot;'place:type=%d&amp;sort=%d&amp;domain='||host||'&amp;domainIsHost=true'%s, &quot;
<span class="lineNum">    1856 </span>            :            &quot;host, host, null, null, null, null, null, null, null, &quot;
<span class="lineNum">    1857 </span>            :            &quot;null, null, null &quot;
<span class="lineNum">    1858 </span>            :     &quot;FROM ( &quot;
<span class="lineNum">    1859 </span>            :       &quot;SELECT get_unreversed_host(h.rev_host) AS host &quot;
<span class="lineNum">    1860 </span>            :       &quot;FROM moz_places h &quot;
<span class="lineNum">    1861 </span>            :       &quot;%s &quot;
<span class="lineNum">    1862 </span>            :       &quot;WHERE h.hidden = 0 &quot;
<span class="lineNum">    1863 </span>            :         &quot;AND h.rev_host &lt;&gt; '.' &quot;
<span class="lineNum">    1864 </span>            :         &quot;AND h.visit_count &gt; 0 &quot;
<span class="lineNum">    1865 </span>            :         &quot;%s &quot;
<span class="lineNum">    1866 </span>            :       &quot;GROUP BY h.rev_host &quot;
<span class="lineNum">    1867 </span>            :       &quot;ORDER BY host ASC &quot;
<span class="lineNum">    1868 </span>            :     &quot;) &quot;,
<span class="lineNum">    1869 </span>            :     nsINavHistoryQueryOptions::RESULTS_AS_URI,
<span class="lineNum">    1870 </span>            :     mSortingMode,
<span class="lineNum">    1871 </span>            :     timeConstraints.get(),
<span class="lineNum">    1872 </span>            :     visitsJoin.get(),
<span class="lineNum">    1873 </span>            :     additionalConditions.get(),
<span class="lineNum">    1874 </span>            :     nsINavHistoryQueryOptions::RESULTS_AS_URI,
<span class="lineNum">    1875 </span>            :     mSortingMode,
<span class="lineNum">    1876 </span>            :     timeConstraints.get(),
<span class="lineNum">    1877 </span>            :     visitsJoin.get(),
<span class="lineNum">    1878 </span>            :     additionalConditions.get()
<span class="lineNum">    1879 </span>            :   );
<span class="lineNum">    1880 </span>            : 
<span class="lineNum">    1881 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1882 </span>            : }
<a name="1883"><span class="lineNum">    1883 </span>            : </a>
<span class="lineNum">    1884 </span>            : nsresult
<span class="lineNum">    1885 </span><span class="lineCov">          1 : PlacesSQLQueryBuilder::SelectAsTag()</span>
<span class="lineNum">    1886 </span>            : {
<span class="lineNum">    1887 </span><span class="lineCov">          1 :   nsNavHistory *history = nsNavHistory::GetHistoryService();</span>
<span class="lineNum">    1888 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(history);</span>
<span class="lineNum">    1889 </span>            : 
<span class="lineNum">    1890 </span>            :   // This allows sorting by date fields what is not possible with
<span class="lineNum">    1891 </span>            :   // other history queries.
<span class="lineNum">    1892 </span><span class="lineCov">          1 :   mHasDateColumns = true;</span>
<span class="lineNum">    1893 </span>            : 
<span class="lineNum">    1894 </span><span class="lineCov">          1 :   mQueryString = nsPrintfCString(</span>
<span class="lineNum">    1895 </span>            :     &quot;SELECT null, 'place:folder=' || id || '&amp;queryType=%d&amp;type=%d', &quot;
<span class="lineNum">    1896 </span>            :            &quot;title, null, null, null, null, null, dateAdded, &quot;
<span class="lineNum">    1897 </span>            :            &quot;lastModified, null, null, null, null, null, null &quot;
<span class="lineNum">    1898 </span>            :     &quot;FROM moz_bookmarks &quot;
<span class="lineNum">    1899 </span>            :     &quot;WHERE parent = %&quot; PRId64,
<span class="lineNum">    1900 </span>            :     nsINavHistoryQueryOptions::QUERY_TYPE_BOOKMARKS,
<span class="lineNum">    1901 </span>            :     nsINavHistoryQueryOptions::RESULTS_AS_TAG_CONTENTS,
<span class="lineNum">    1902 </span>            :     history-&gt;GetTagsFolder()
<span class="lineNum">    1903 </span>            :   );
<span class="lineNum">    1904 </span>            : 
<span class="lineNum">    1905 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    1906 </span>            : }
<a name="1907"><span class="lineNum">    1907 </span>            : </a>
<span class="lineNum">    1908 </span>            : nsresult
<span class="lineNum">    1909 </span><span class="lineCov">          1 : PlacesSQLQueryBuilder::Where()</span>
<span class="lineNum">    1910 </span>            : {
<span class="lineNum">    1911 </span>            : 
<span class="lineNum">    1912 </span>            :   // Set query options
<span class="lineNum">    1913 </span><span class="lineCov">          1 :   nsAutoCString additionalVisitsConditions;</span>
<span class="lineNum">    1914 </span><span class="lineCov">          1 :   nsAutoCString additionalPlacesConditions;</span>
<span class="lineNum">    1915 </span>            : 
<span class="lineNum">    1916 </span><span class="lineCov">          1 :   if (!mIncludeHidden) {</span>
<span class="lineNum">    1917 </span><span class="lineCov">          1 :     additionalPlacesConditions += NS_LITERAL_CSTRING(&quot;AND hidden = 0 &quot;);</span>
<span class="lineNum">    1918 </span>            :   }
<span class="lineNum">    1919 </span>            : 
<span class="lineNum">    1920 </span><span class="lineCov">          1 :   if (mQueryType == nsINavHistoryQueryOptions::QUERY_TYPE_HISTORY) {</span>
<span class="lineNum">    1921 </span>            :     // last_visit_date is updated for any kind of visit, so it's a good
<span class="lineNum">    1922 </span>            :     // indicator whether the page has visits.
<span class="lineNum">    1923 </span><span class="lineCov">          1 :     additionalPlacesConditions += NS_LITERAL_CSTRING(</span>
<span class="lineNum">    1924 </span>            :       &quot;AND last_visit_date NOTNULL &quot;
<span class="lineNum">    1925 </span>            :     );
<span class="lineNum">    1926 </span>            :   }
<span class="lineNum">    1927 </span>            : 
<span class="lineNum">    1928 </span><span class="lineCov">          1 :   if (mResultType == nsINavHistoryQueryOptions::RESULTS_AS_URI &amp;&amp;</span>
<span class="lineNum">    1929 </span><span class="lineCov">          1 :       !additionalVisitsConditions.IsEmpty()) {</span>
<span class="lineNum">    1930 </span>            :     // URI results don't join on visits.
<span class="lineNum">    1931 </span><span class="lineNoCov">          0 :     nsAutoCString tmp = additionalVisitsConditions;</span>
<span class="lineNum">    1932 </span>            :     additionalVisitsConditions = &quot;AND EXISTS (SELECT 1 FROM moz_historyvisits WHERE place_id = h.id &quot;;
<span class="lineNum">    1933 </span><span class="lineNoCov">          0 :     additionalVisitsConditions.Append(tmp);</span>
<span class="lineNum">    1934 </span><span class="lineNoCov">          0 :     additionalVisitsConditions.AppendLiteral(&quot;LIMIT 1)&quot;);</span>
<span class="lineNum">    1935 </span>            :   }
<span class="lineNum">    1936 </span>            : 
<span class="lineNum">    1937 </span>            :   mQueryString.ReplaceSubstring(&quot;{QUERY_OPTIONS_VISITS}&quot;,
<span class="lineNum">    1938 </span><span class="lineCov">          1 :                                 additionalVisitsConditions.get());</span>
<span class="lineNum">    1939 </span>            :   mQueryString.ReplaceSubstring(&quot;{QUERY_OPTIONS_PLACES}&quot;,
<span class="lineNum">    1940 </span><span class="lineCov">          1 :                                 additionalPlacesConditions.get());</span>
<span class="lineNum">    1941 </span>            : 
<span class="lineNum">    1942 </span>            :   // If we used WHERE already, we inject the conditions
<span class="lineNum">    1943 </span>            :   // in place of {ADDITIONAL_CONDITIONS}
<span class="lineNum">    1944 </span><span class="lineCov">          1 :   if (mQueryString.Find(&quot;{ADDITIONAL_CONDITIONS}&quot;, 0) != kNotFound) {</span>
<span class="lineNum">    1945 </span><span class="lineCov">          1 :     nsAutoCString innerCondition;</span>
<span class="lineNum">    1946 </span>            :     // If we have condition AND it
<span class="lineNum">    1947 </span><span class="lineCov">          1 :     if (!mConditions.IsEmpty()) {</span>
<span class="lineNum">    1948 </span>            :       innerCondition = &quot; AND (&quot;;
<span class="lineNum">    1949 </span><span class="lineCov">          1 :       innerCondition += mConditions;</span>
<span class="lineNum">    1950 </span><span class="lineCov">          1 :       innerCondition += &quot;)&quot;;</span>
<span class="lineNum">    1951 </span>            :     }
<span class="lineNum">    1952 </span>            :     mQueryString.ReplaceSubstring(&quot;{ADDITIONAL_CONDITIONS}&quot;,
<span class="lineNum">    1953 </span><span class="lineCov">          1 :                                   innerCondition.get());</span>
<span class="lineNum">    1954 </span>            : 
<span class="lineNum">    1955 </span><span class="lineCov">          1 :   } else if (!mConditions.IsEmpty()) {</span>
<span class="lineNum">    1956 </span>            : 
<span class="lineNum">    1957 </span><span class="lineNoCov">          0 :     mQueryString += &quot;WHERE &quot;;</span>
<span class="lineNum">    1958 </span><span class="lineNoCov">          0 :     mQueryString += mConditions;</span>
<span class="lineNum">    1959 </span>            : 
<span class="lineNum">    1960 </span>            :   }
<span class="lineNum">    1961 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    1962 </span>            : }
<a name="1963"><span class="lineNum">    1963 </span>            : </a>
<span class="lineNum">    1964 </span>            : nsresult
<span class="lineNum">    1965 </span><span class="lineNoCov">          0 : PlacesSQLQueryBuilder::GroupBy()</span>
<span class="lineNum">    1966 </span>            : {
<span class="lineNum">    1967 </span><span class="lineCov">          1 :   mQueryString += mGroupBy;</span>
<span class="lineNum">    1968 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1969 </span>            : }
<a name="1970"><span class="lineNum">    1970 </span>            : </a>
<span class="lineNum">    1971 </span>            : nsresult
<span class="lineNum">    1972 </span><span class="lineCov">          1 : PlacesSQLQueryBuilder::OrderBy()</span>
<span class="lineNum">    1973 </span>            : {
<span class="lineNum">    1974 </span><span class="lineCov">          1 :   if (mSkipOrderBy)</span>
<span class="lineNum">    1975 </span>            :     return NS_OK;
<span class="lineNum">    1976 </span>            : 
<span class="lineNum">    1977 </span>            :   // Sort clause: we will sort later, but if it comes out of the DB sorted,
<span class="lineNum">    1978 </span>            :   // our later sort will be basically free. The DB can sort these for free
<span class="lineNum">    1979 </span>            :   // most of the time anyway, because it has indices over these items.
<span class="lineNum">    1980 </span><span class="lineCov">          1 :   switch(mSortingMode)</span>
<span class="lineNum">    1981 </span>            :   {
<span class="lineNum">    1982 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_NONE:
<span class="lineNum">    1983 </span>            :       // Ensure sorting does not change based on tables status.
<span class="lineNum">    1984 </span><span class="lineCov">          1 :       if (mResultType == nsINavHistoryQueryOptions::RESULTS_AS_URI) {</span>
<span class="lineNum">    1985 </span><span class="lineCov">          1 :         if (mQueryType == nsINavHistoryQueryOptions::QUERY_TYPE_BOOKMARKS)</span>
<span class="lineNum">    1986 </span><span class="lineCov">          1 :           mQueryString += NS_LITERAL_CSTRING(&quot; ORDER BY b.id ASC &quot;);</span>
<span class="lineNum">    1987 </span><span class="lineCov">          1 :         else if (mQueryType == nsINavHistoryQueryOptions::QUERY_TYPE_HISTORY)</span>
<span class="lineNum">    1988 </span><span class="lineCov">          1 :           mQueryString += NS_LITERAL_CSTRING(&quot; ORDER BY h.id ASC &quot;);</span>
<span class="lineNum">    1989 </span>            :       }
<span class="lineNum">    1990 </span>            :       break;
<span class="lineNum">    1991 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_TITLE_ASCENDING:
<span class="lineNum">    1992 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_TITLE_DESCENDING:
<span class="lineNum">    1993 </span>            :       // If the user wants few results, we limit them by date, necessitating
<span class="lineNum">    1994 </span>            :       // a sort by date here (see the IDL definition for maxResults).
<span class="lineNum">    1995 </span>            :       // Otherwise we will do actual sorting by title, but since we could need
<span class="lineNum">    1996 </span>            :       // to special sort for some locale we will repeat a second sorting at the
<span class="lineNum">    1997 </span>            :       // end in nsNavHistoryResult, that should be faster since the list will be
<span class="lineNum">    1998 </span>            :       // almost ordered.
<span class="lineNum">    1999 </span><span class="lineCov">          1 :       if (mMaxResults &gt; 0)</span>
<span class="lineNum">    2000 </span><span class="lineNoCov">          0 :         OrderByColumnIndexDesc(nsNavHistory::kGetInfoIndex_VisitDate);</span>
<span class="lineNum">    2001 </span><span class="lineCov">          1 :       else if (mSortingMode == nsINavHistoryQueryOptions::SORT_BY_TITLE_ASCENDING)</span>
<span class="lineNum">    2002 </span><span class="lineCov">          1 :         OrderByTextColumnIndexAsc(nsNavHistory::kGetInfoIndex_Title);</span>
<span class="lineNum">    2003 </span>            :       else
<span class="lineNum">    2004 </span><span class="lineCov">          1 :         OrderByTextColumnIndexDesc(nsNavHistory::kGetInfoIndex_Title);</span>
<span class="lineNum">    2005 </span>            :       break;
<span class="lineNum">    2006 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_DATE_ASCENDING:
<span class="lineNum">    2007 </span><span class="lineCov">          1 :       OrderByColumnIndexAsc(nsNavHistory::kGetInfoIndex_VisitDate);</span>
<span class="lineNum">    2008 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    2009 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_DATE_DESCENDING:
<span class="lineNum">    2010 </span><span class="lineCov">          1 :       OrderByColumnIndexDesc(nsNavHistory::kGetInfoIndex_VisitDate);</span>
<span class="lineNum">    2011 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    2012 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_URI_ASCENDING:
<span class="lineNum">    2013 </span><span class="lineCov">          1 :       OrderByColumnIndexAsc(nsNavHistory::kGetInfoIndex_URL);</span>
<span class="lineNum">    2014 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    2015 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_URI_DESCENDING:
<span class="lineNum">    2016 </span><span class="lineCov">          1 :       OrderByColumnIndexDesc(nsNavHistory::kGetInfoIndex_URL);</span>
<span class="lineNum">    2017 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    2018 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_VISITCOUNT_ASCENDING:
<span class="lineNum">    2019 </span><span class="lineCov">          1 :       OrderByColumnIndexAsc(nsNavHistory::kGetInfoIndex_VisitCount);</span>
<span class="lineNum">    2020 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    2021 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_VISITCOUNT_DESCENDING:
<span class="lineNum">    2022 </span><span class="lineCov">          1 :       OrderByColumnIndexDesc(nsNavHistory::kGetInfoIndex_VisitCount);</span>
<span class="lineNum">    2023 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    2024 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_DATEADDED_ASCENDING:
<span class="lineNum">    2025 </span><span class="lineCov">          1 :       if (mHasDateColumns)</span>
<span class="lineNum">    2026 </span><span class="lineCov">          1 :         OrderByColumnIndexAsc(nsNavHistory::kGetInfoIndex_ItemDateAdded);</span>
<span class="lineNum">    2027 </span>            :       break;
<span class="lineNum">    2028 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_DATEADDED_DESCENDING:
<span class="lineNum">    2029 </span><span class="lineCov">          1 :       if (mHasDateColumns)</span>
<span class="lineNum">    2030 </span><span class="lineCov">          1 :         OrderByColumnIndexDesc(nsNavHistory::kGetInfoIndex_ItemDateAdded);</span>
<span class="lineNum">    2031 </span>            :       break;
<span class="lineNum">    2032 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_LASTMODIFIED_ASCENDING:
<span class="lineNum">    2033 </span><span class="lineCov">          1 :       if (mHasDateColumns)</span>
<span class="lineNum">    2034 </span><span class="lineCov">          1 :         OrderByColumnIndexAsc(nsNavHistory::kGetInfoIndex_ItemLastModified);</span>
<span class="lineNum">    2035 </span>            :       break;
<span class="lineNum">    2036 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_LASTMODIFIED_DESCENDING:
<span class="lineNum">    2037 </span><span class="lineCov">          1 :       if (mHasDateColumns)</span>
<span class="lineNum">    2038 </span><span class="lineCov">          1 :         OrderByColumnIndexDesc(nsNavHistory::kGetInfoIndex_ItemLastModified);</span>
<span class="lineNum">    2039 </span>            :       break;
<span class="lineNum">    2040 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_TAGS_ASCENDING:
<span class="lineNum">    2041 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_TAGS_DESCENDING:
<span class="lineNum">    2042 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_ANNOTATION_ASCENDING:
<span class="lineNum">    2043 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_ANNOTATION_DESCENDING:
<span class="lineNum">    2044 </span>            :       break; // Sort later in nsNavHistoryQueryResultNode::FillChildren()
<span class="lineNum">    2045 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_FRECENCY_ASCENDING:
<span class="lineNum">    2046 </span><span class="lineNoCov">          0 :         OrderByColumnIndexAsc(nsNavHistory::kGetInfoIndex_Frecency);</span>
<span class="lineNum">    2047 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    2048 </span>            :     case nsINavHistoryQueryOptions::SORT_BY_FRECENCY_DESCENDING:
<span class="lineNum">    2049 </span><span class="lineCov">          1 :         OrderByColumnIndexDesc(nsNavHistory::kGetInfoIndex_Frecency);</span>
<span class="lineNum">    2050 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    2051 </span>            :     default:
<span class="lineNum">    2052 </span>            :       NS_NOTREACHED(&quot;Invalid sorting mode&quot;);
<span class="lineNum">    2053 </span>            :   }
<span class="lineNum">    2054 </span>            :   return NS_OK;
<a name="2055"><span class="lineNum">    2055 </span>            : }</a>
<span class="lineNum">    2056 </span>            : 
<span class="lineNum">    2057 </span><span class="lineCov">          1 : void PlacesSQLQueryBuilder::OrderByColumnIndexAsc(int32_t aIndex)</span>
<span class="lineNum">    2058 </span>            : {
<span class="lineNum">    2059 </span><span class="lineCov">          1 :   mQueryString += nsPrintfCString(&quot; ORDER BY %d ASC&quot;, aIndex+1);</span>
<a name="2060"><span class="lineNum">    2060 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    2061 </span>            : 
<span class="lineNum">    2062 </span><span class="lineCov">          1 : void PlacesSQLQueryBuilder::OrderByColumnIndexDesc(int32_t aIndex)</span>
<span class="lineNum">    2063 </span>            : {
<span class="lineNum">    2064 </span><span class="lineCov">          1 :   mQueryString += nsPrintfCString(&quot; ORDER BY %d DESC&quot;, aIndex+1);</span>
<a name="2065"><span class="lineNum">    2065 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    2066 </span>            : 
<span class="lineNum">    2067 </span><span class="lineCov">          1 : void PlacesSQLQueryBuilder::OrderByTextColumnIndexAsc(int32_t aIndex)</span>
<span class="lineNum">    2068 </span>            : {
<span class="lineNum">    2069 </span><span class="lineCov">          1 :   mQueryString += nsPrintfCString(&quot; ORDER BY %d COLLATE NOCASE ASC&quot;,</span>
<span class="lineNum">    2070 </span>            :                                   aIndex+1);
<a name="2071"><span class="lineNum">    2071 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    2072 </span>            : 
<span class="lineNum">    2073 </span><span class="lineCov">          1 : void PlacesSQLQueryBuilder::OrderByTextColumnIndexDesc(int32_t aIndex)</span>
<span class="lineNum">    2074 </span>            : {
<span class="lineNum">    2075 </span><span class="lineCov">          1 :   mQueryString += nsPrintfCString(&quot; ORDER BY %d COLLATE NOCASE DESC&quot;,</span>
<span class="lineNum">    2076 </span>            :                                   aIndex+1);
<span class="lineNum">    2077 </span><span class="lineCov">          1 : }</span>
<a name="2078"><span class="lineNum">    2078 </span>            : </a>
<span class="lineNum">    2079 </span>            : nsresult
<span class="lineNum">    2080 </span><span class="lineCov">          1 : PlacesSQLQueryBuilder::Limit()</span>
<span class="lineNum">    2081 </span>            : {
<span class="lineNum">    2082 </span><span class="lineCov">          1 :   if (mUseLimit &amp;&amp; mMaxResults &gt; 0) {</span>
<span class="lineNum">    2083 </span><span class="lineCov">          1 :     mQueryString += NS_LITERAL_CSTRING(&quot; LIMIT &quot;);</span>
<span class="lineNum">    2084 </span><span class="lineCov">          1 :     mQueryString.AppendInt(mMaxResults);</span>
<span class="lineNum">    2085 </span><span class="lineCov">          1 :     mQueryString.Append(' ');</span>
<span class="lineNum">    2086 </span>            :   }
<span class="lineNum">    2087 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    2088 </span>            : }
<a name="2089"><span class="lineNum">    2089 </span>            : </a>
<span class="lineNum">    2090 </span>            : nsresult
<span class="lineNum">    2091 </span><span class="lineCov">          1 : nsNavHistory::ConstructQueryString(</span>
<span class="lineNum">    2092 </span>            :     const nsCOMArray&lt;nsNavHistoryQuery&gt;&amp; aQueries,
<span class="lineNum">    2093 </span>            :     nsNavHistoryQueryOptions* aOptions,
<span class="lineNum">    2094 </span>            :     nsCString&amp; queryString,
<span class="lineNum">    2095 </span>            :     bool&amp; aParamsPresent,
<span class="lineNum">    2096 </span>            :     nsNavHistory::StringHash&amp; aAddParams)
<span class="lineNum">    2097 </span>            : {
<span class="lineNum">    2098 </span>            :   // For information about visit_type see nsINavHistoryService.idl.
<span class="lineNum">    2099 </span>            :   // visitType == 0 is undefined (see bug #375777 for details).
<span class="lineNum">    2100 </span>            :   // Some sites, especially Javascript-heavy ones, load things in frames to
<span class="lineNum">    2101 </span>            :   // display them, resulting in a lot of these entries. This is the reason
<span class="lineNum">    2102 </span>            :   // why such visits are filtered out.
<span class="lineNum">    2103 </span>            :   nsresult rv;
<span class="lineNum">    2104 </span><span class="lineCov">          1 :   aParamsPresent = false;</span>
<span class="lineNum">    2105 </span>            : 
<span class="lineNum">    2106 </span><span class="lineCov">          1 :   int32_t sortingMode = aOptions-&gt;SortingMode();</span>
<span class="lineNum">    2107 </span>            :   NS_ASSERTION(sortingMode &gt;= nsINavHistoryQueryOptions::SORT_BY_NONE &amp;&amp;
<span class="lineNum">    2108 </span>            :                sortingMode &lt;= nsINavHistoryQueryOptions::SORT_BY_FRECENCY_DESCENDING,
<span class="lineNum">    2109 </span>            :                &quot;Invalid sortingMode found while building query!&quot;);
<span class="lineNum">    2110 </span>            : 
<span class="lineNum">    2111 </span><span class="lineCov">          1 :   bool hasSearchTerms = false;</span>
<span class="lineNum">    2112 </span><span class="lineCov">          1 :   for (int32_t i = 0; i &lt; aQueries.Count() &amp;&amp; !hasSearchTerms; i++) {</span>
<span class="lineNum">    2113 </span><span class="lineCov">          1 :     aQueries[i]-&gt;GetHasSearchTerms(&amp;hasSearchTerms);</span>
<span class="lineNum">    2114 </span>            :   }
<span class="lineNum">    2115 </span>            : 
<span class="lineNum">    2116 </span><span class="lineCov">          1 :   nsAutoCString tagsSqlFragment;</span>
<span class="lineNum">    2117 </span>            :   GetTagsSqlFragment(GetTagsFolder(),
<span class="lineNum">    2118 </span>            :                      NS_LITERAL_CSTRING(&quot;h.id&quot;),
<span class="lineNum">    2119 </span>            :                      hasSearchTerms,
<span class="lineNum">    2120 </span><span class="lineCov">          1 :                      tagsSqlFragment);</span>
<span class="lineNum">    2121 </span>            : 
<span class="lineNum">    2122 </span><span class="lineCov">          1 :   if (IsOptimizableHistoryQuery(aQueries, aOptions,</span>
<span class="lineNum">    2123 </span><span class="lineCov">          1 :         nsINavHistoryQueryOptions::SORT_BY_DATE_DESCENDING) ||</span>
<span class="lineNum">    2124 </span>            :       IsOptimizableHistoryQuery(aQueries, aOptions,
<span class="lineNum">    2125 </span><span class="lineCov">          1 :         nsINavHistoryQueryOptions::SORT_BY_VISITCOUNT_DESCENDING)) {</span>
<span class="lineNum">    2126 </span>            :     // Generate an optimized query for the history menu and most visited
<span class="lineNum">    2127 </span>            :     // smart bookmark.
<span class="lineNum">    2128 </span>            :     queryString = NS_LITERAL_CSTRING(
<span class="lineNum">    2129 </span>            :       &quot;SELECT h.id, h.url, h.title AS page_title, h.rev_host, h.visit_count, h.last_visit_date, &quot;
<span class="lineNum">    2130 </span><span class="lineCov">          1 :           &quot;null, null, null, null, null, &quot;) +</span>
<span class="lineNum">    2131 </span><span class="lineCov">          1 :           tagsSqlFragment + NS_LITERAL_CSTRING(&quot;, h.frecency, h.hidden, h.guid, &quot;</span>
<span class="lineNum">    2132 </span>            :           &quot;null, null, null &quot;
<span class="lineNum">    2133 </span>            :         &quot;FROM moz_places h &quot;
<span class="lineNum">    2134 </span>            :         &quot;WHERE h.hidden = 0 &quot;
<span class="lineNum">    2135 </span>            :           &quot;AND EXISTS (SELECT id FROM moz_historyvisits WHERE place_id = h.id &quot;
<span class="lineNum">    2136 </span><span class="lineCov">          1 :                        &quot;AND visit_type NOT IN &quot;) +</span>
<span class="lineNum">    2137 </span>            :                        nsPrintfCString(&quot;(0,%d,%d) &quot;,
<span class="lineNum">    2138 </span>            :                                        nsINavHistoryService::TRANSITION_EMBED,
<span class="lineNum">    2139 </span><span class="lineCov">          1 :                                        nsINavHistoryService::TRANSITION_FRAMED_LINK) +</span>
<span class="lineNum">    2140 </span><span class="lineCov">          1 :                        NS_LITERAL_CSTRING(&quot;LIMIT 1) &quot;</span>
<span class="lineNum">    2141 </span>            :           &quot;{QUERY_OPTIONS} &quot;
<span class="lineNum">    2142 </span>            :         );
<span class="lineNum">    2143 </span>            : 
<span class="lineNum">    2144 </span><span class="lineCov">          1 :     queryString.AppendLiteral(&quot;ORDER BY &quot;);</span>
<span class="lineNum">    2145 </span><span class="lineCov">          1 :     if (sortingMode == nsINavHistoryQueryOptions::SORT_BY_DATE_DESCENDING)</span>
<span class="lineNum">    2146 </span><span class="lineNoCov">          0 :       queryString.AppendLiteral(&quot;last_visit_date DESC &quot;);</span>
<span class="lineNum">    2147 </span>            :     else
<span class="lineNum">    2148 </span><span class="lineCov">          1 :       queryString.AppendLiteral(&quot;visit_count DESC &quot;);</span>
<span class="lineNum">    2149 </span>            : 
<span class="lineNum">    2150 </span><span class="lineCov">          1 :     queryString.AppendLiteral(&quot;LIMIT &quot;);</span>
<span class="lineNum">    2151 </span><span class="lineCov">          1 :     queryString.AppendInt(aOptions-&gt;MaxResults());</span>
<span class="lineNum">    2152 </span>            : 
<span class="lineNum">    2153 </span><span class="lineCov">          1 :     nsAutoCString additionalQueryOptions;</span>
<span class="lineNum">    2154 </span>            : 
<span class="lineNum">    2155 </span>            :     queryString.ReplaceSubstring(&quot;{QUERY_OPTIONS}&quot;,
<span class="lineNum">    2156 </span><span class="lineCov">          1 :                                   additionalQueryOptions.get());</span>
<span class="lineNum">    2157 </span><span class="lineCov">          1 :     return NS_OK;</span>
<span class="lineNum">    2158 </span>            :   }
<span class="lineNum">    2159 </span>            : 
<span class="lineNum">    2160 </span><span class="lineCov">          1 :   nsAutoCString conditions;</span>
<span class="lineNum">    2161 </span><span class="lineCov">          1 :   for (int32_t i = 0; i &lt; aQueries.Count(); i++) {</span>
<span class="lineNum">    2162 </span>            :     nsCString queryClause;
<span class="lineNum">    2163 </span><span class="lineCov">          1 :     rv = QueryToSelectClause(aQueries[i], aOptions, i, &amp;queryClause);</span>
<span class="lineNum">    2164 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2165 </span><span class="lineCov">          1 :     if (! queryClause.IsEmpty()) {</span>
<span class="lineNum">    2166 </span><span class="lineCov">          1 :       aParamsPresent = true;</span>
<span class="lineNum">    2167 </span><span class="lineCov">          1 :       if (! conditions.IsEmpty()) // exists previous clause: multiple ones are ORed</span>
<span class="lineNum">    2168 </span><span class="lineCov">          1 :         conditions += NS_LITERAL_CSTRING(&quot; OR &quot;);</span>
<span class="lineNum">    2169 </span><span class="lineCov">          1 :       conditions += NS_LITERAL_CSTRING(&quot;(&quot;) + queryClause +</span>
<span class="lineNum">    2170 </span><span class="lineCov">          1 :         NS_LITERAL_CSTRING(&quot;)&quot;);</span>
<span class="lineNum">    2171 </span>            :     }
<span class="lineNum">    2172 </span>            :   }
<span class="lineNum">    2173 </span>            : 
<span class="lineNum">    2174 </span>            :   // Determine whether we can push maxResults constraints into the queries
<span class="lineNum">    2175 </span>            :   // as LIMIT, or if we need to do result count clamping later
<span class="lineNum">    2176 </span>            :   // using FilterResultSet()
<span class="lineNum">    2177 </span><span class="lineCov">          1 :   bool useLimitClause = !NeedToFilterResultSet(aQueries, aOptions);</span>
<span class="lineNum">    2178 </span>            : 
<span class="lineNum">    2179 </span>            :   PlacesSQLQueryBuilder queryStringBuilder(conditions, aOptions,
<span class="lineNum">    2180 </span>            :                                            useLimitClause, aAddParams,
<span class="lineNum">    2181 </span><span class="lineCov">          1 :                                            hasSearchTerms);</span>
<span class="lineNum">    2182 </span><span class="lineCov">          1 :   rv = queryStringBuilder.GetQueryString(queryString);</span>
<span class="lineNum">    2183 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2184 </span>            : 
<span class="lineNum">    2185 </span>            :   return NS_OK;
<span class="lineNum">    2186 </span>            : }
<span class="lineNum">    2187 </span>            : 
<span class="lineNum">    2188 </span>            : // nsNavHistory::GetQueryResults
<span class="lineNum">    2189 </span>            : //
<span class="lineNum">    2190 </span>            : //    Call this to get the results from a complex query. This is used by
<span class="lineNum">    2191 </span>            : //    nsNavHistoryQueryResultNode to populate its children. For simple bookmark
<span class="lineNum">    2192 </span>            : //    queries, use nsNavBookmarks::QueryFolderChildren.
<span class="lineNum">    2193 </span>            : //
<span class="lineNum">    2194 </span>            : //    THIS DOES NOT DO SORTING. You will need to sort the container yourself
<span class="lineNum">    2195 </span>            : //    when you get the results. This is because sorting depends on tree
<span class="lineNum">    2196 </span>            : //    statistics that will be built from the perspective of the tree. See
<span class="lineNum">    2197 </span>            : //    nsNavHistoryQueryResultNode::FillChildren
<span class="lineNum">    2198 </span>            : //
<span class="lineNum">    2199 </span>            : //    FIXME: This only does keyword searching for the first query, and does
<span class="lineNum">    2200 </span>            : //    it ANDed with the all the rest of the queries.
<a name="2201"><span class="lineNum">    2201 </span>            : </a>
<span class="lineNum">    2202 </span>            : nsresult
<span class="lineNum">    2203 </span><span class="lineCov">          1 : nsNavHistory::GetQueryResults(nsNavHistoryQueryResultNode *aResultNode,</span>
<span class="lineNum">    2204 </span>            :                               const nsCOMArray&lt;nsNavHistoryQuery&gt;&amp; aQueries,
<span class="lineNum">    2205 </span>            :                               nsNavHistoryQueryOptions *aOptions,
<span class="lineNum">    2206 </span>            :                               nsCOMArray&lt;nsNavHistoryResultNode&gt;* aResults)
<span class="lineNum">    2207 </span>            : {
<span class="lineNum">    2208 </span><span class="lineCov">          1 :   NS_ENSURE_ARG_POINTER(aOptions);</span>
<span class="lineNum">    2209 </span>            :   NS_ASSERTION(aResults-&gt;Count() == 0, &quot;Initial result array must be empty&quot;);
<span class="lineNum">    2210 </span><span class="lineCov">          1 :   if (! aQueries.Count())</span>
<span class="lineNum">    2211 </span>            :     return NS_ERROR_INVALID_ARG;
<span class="lineNum">    2212 </span>            : 
<span class="lineNum">    2213 </span>            :   nsCString queryString;
<span class="lineNum">    2214 </span><span class="lineCov">          1 :   bool paramsPresent = false;</span>
<span class="lineNum">    2215 </span>            :   nsNavHistory::StringHash addParams(HISTORY_DATE_CONT_LENGTH);
<span class="lineNum">    2216 </span>            :   nsresult rv = ConstructQueryString(aQueries, aOptions, queryString,
<span class="lineNum">    2217 </span><span class="lineCov">          1 :                                      paramsPresent, addParams);</span>
<span class="lineNum">    2218 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv,rv);</span>
<span class="lineNum">    2219 </span>            : 
<span class="lineNum">    2220 </span>            :   // create statement
<span class="lineNum">    2221 </span><span class="lineCov">          1 :   nsCOMPtr&lt;mozIStorageStatement&gt; statement = mDB-&gt;GetStatement(queryString);</span>
<span class="lineNum">    2222 </span>            : #ifdef DEBUG
<span class="lineNum">    2223 </span>            :   if (!statement) {
<span class="lineNum">    2224 </span>            :     nsAutoCString lastErrorString;
<span class="lineNum">    2225 </span>            :     (void)mDB-&gt;MainConn()-&gt;GetLastErrorString(lastErrorString);
<span class="lineNum">    2226 </span>            :     int32_t lastError = 0;
<span class="lineNum">    2227 </span>            :     (void)mDB-&gt;MainConn()-&gt;GetLastError(&amp;lastError);
<span class="lineNum">    2228 </span>            :     printf(&quot;Places failed to create a statement from this query:\n%s\nStorage error (%d): %s\n&quot;,
<span class="lineNum">    2229 </span>            :            queryString.get(), lastError, lastErrorString.get());
<span class="lineNum">    2230 </span>            :   }
<span class="lineNum">    2231 </span>            : #endif
<span class="lineNum">    2232 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(statement);</span>
<span class="lineNum">    2233 </span><span class="lineCov">          1 :   mozStorageStatementScoper scoper(statement);</span>
<span class="lineNum">    2234 </span>            : 
<span class="lineNum">    2235 </span><span class="lineCov">          1 :   if (paramsPresent) {</span>
<span class="lineNum">    2236 </span>            :     // bind parameters
<span class="lineNum">    2237 </span>            :     int32_t i;
<span class="lineNum">    2238 </span><span class="lineCov">          1 :     for (i = 0; i &lt; aQueries.Count(); i++) {</span>
<span class="lineNum">    2239 </span><span class="lineCov">          1 :       rv = BindQueryClauseParameters(statement, i, aQueries[i], aOptions);</span>
<span class="lineNum">    2240 </span><span class="lineCov">          1 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2241 </span>            :     }
<span class="lineNum">    2242 </span>            :   }
<span class="lineNum">    2243 </span>            : 
<span class="lineNum">    2244 </span><span class="lineCov">          1 :   for (auto iter = addParams.Iter(); !iter.Done(); iter.Next()) {</span>
<span class="lineNum">    2245 </span><span class="lineCov">          1 :     nsresult rv = statement-&gt;BindUTF8StringByName(iter.Key(), iter.Data());</span>
<span class="lineNum">    2246 </span><span class="lineCov">          1 :     if (NS_FAILED(rv)) {</span>
<span class="lineNum">    2247 </span>            :       break;
<span class="lineNum">    2248 </span>            :     }
<span class="lineNum">    2249 </span>            :   }
<span class="lineNum">    2250 </span>            : 
<span class="lineNum">    2251 </span>            :   // Optimize the case where there is no need for any post-query filtering.
<span class="lineNum">    2252 </span><span class="lineCov">          1 :   if (NeedToFilterResultSet(aQueries, aOptions)) {</span>
<span class="lineNum">    2253 </span>            :     // Generate the top-level results.
<span class="lineNum">    2254 </span>            :     nsCOMArray&lt;nsNavHistoryResultNode&gt; toplevel;
<span class="lineNum">    2255 </span><span class="lineCov">          1 :     rv = ResultsAsList(statement, aOptions, &amp;toplevel);</span>
<span class="lineNum">    2256 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2257 </span>            : 
<span class="lineNum">    2258 </span><span class="lineCov">          1 :     FilterResultSet(aResultNode, toplevel, aResults, aQueries, aOptions);</span>
<span class="lineNum">    2259 </span>            :   } else {
<span class="lineNum">    2260 </span><span class="lineCov">          1 :     rv = ResultsAsList(statement, aOptions, aResults);</span>
<span class="lineNum">    2261 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2262 </span>            :   }
<span class="lineNum">    2263 </span>            : 
<span class="lineNum">    2264 </span>            :   return NS_OK;
<span class="lineNum">    2265 </span>            : }
<a name="2266"><span class="lineNum">    2266 </span>            : </a>
<span class="lineNum">    2267 </span>            : NS_IMETHODIMP
<span class="lineNum">    2268 </span><span class="lineCov">          1 : nsNavHistory::AddObserver(nsINavHistoryObserver* aObserver, bool aOwnsWeak)</span>
<span class="lineNum">    2269 </span>            : {
<span class="lineNum">    2270 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    2271 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aObserver);</span>
<span class="lineNum">    2272 </span>            : 
<span class="lineNum">    2273 </span><span class="lineCov">          1 :   if (NS_WARN_IF(!mCanNotify))</span>
<span class="lineNum">    2274 </span>            :     return NS_ERROR_UNEXPECTED;
<span class="lineNum">    2275 </span>            : 
<span class="lineNum">    2276 </span><span class="lineCov">          1 :   return mObservers.AppendWeakElement(aObserver, aOwnsWeak);</span>
<span class="lineNum">    2277 </span>            : }
<a name="2278"><span class="lineNum">    2278 </span>            : </a>
<span class="lineNum">    2279 </span>            : NS_IMETHODIMP
<span class="lineNum">    2280 </span><span class="lineCov">          1 : nsNavHistory::RemoveObserver(nsINavHistoryObserver* aObserver)</span>
<span class="lineNum">    2281 </span>            : {
<span class="lineNum">    2282 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    2283 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aObserver);</span>
<span class="lineNum">    2284 </span>            : 
<span class="lineNum">    2285 </span><span class="lineCov">          1 :   return mObservers.RemoveWeakElement(aObserver);</span>
<span class="lineNum">    2286 </span>            : }
<a name="2287"><span class="lineNum">    2287 </span>            : </a>
<span class="lineNum">    2288 </span>            : NS_IMETHODIMP
<span class="lineNum">    2289 </span><span class="lineCov">          1 : nsNavHistory::GetObservers(uint32_t* _count,</span>
<span class="lineNum">    2290 </span>            :                            nsINavHistoryObserver*** _observers)
<span class="lineNum">    2291 </span>            : {
<span class="lineNum">    2292 </span><span class="lineCov">          1 :   NS_ENSURE_ARG_POINTER(_count);</span>
<span class="lineNum">    2293 </span><span class="lineCov">          1 :   NS_ENSURE_ARG_POINTER(_observers);</span>
<span class="lineNum">    2294 </span>            : 
<span class="lineNum">    2295 </span><span class="lineCov">          1 :   *_count = 0;</span>
<span class="lineNum">    2296 </span><span class="lineCov">          1 :   *_observers = nullptr;</span>
<span class="lineNum">    2297 </span>            : 
<span class="lineNum">    2298 </span>            :   // Clear any cached value, cause it's very likely the consumer has made
<span class="lineNum">    2299 </span>            :   // changes to history and is now trying to notify them.
<span class="lineNum">    2300 </span><span class="lineCov">          1 :   mDaysOfHistory = -1;</span>
<span class="lineNum">    2301 </span>            : 
<span class="lineNum">    2302 </span><span class="lineCov">          1 :   if (!mCanNotify)</span>
<span class="lineNum">    2303 </span>            :     return NS_OK;
<span class="lineNum">    2304 </span>            : 
<span class="lineNum">    2305 </span>            :   nsCOMArray&lt;nsINavHistoryObserver&gt; observers;
<span class="lineNum">    2306 </span>            : 
<span class="lineNum">    2307 </span>            :   // First add the category cache observers.
<span class="lineNum">    2308 </span><span class="lineCov">          1 :   mCacheObservers.GetEntries(observers);</span>
<span class="lineNum">    2309 </span>            : 
<span class="lineNum">    2310 </span>            :   // Then add the other observers.
<span class="lineNum">    2311 </span><span class="lineCov">          1 :   for (uint32_t i = 0; i &lt; mObservers.Length(); ++i) {</span>
<span class="lineNum">    2312 </span><span class="lineCov">          1 :     const nsCOMPtr&lt;nsINavHistoryObserver&gt; &amp;observer = mObservers.ElementAt(i).GetValue();</span>
<span class="lineNum">    2313 </span>            :     // Skip nullified weak observers.
<span class="lineNum">    2314 </span><span class="lineCov">          1 :     if (observer)</span>
<span class="lineNum">    2315 </span><span class="lineCov">          1 :       observers.AppendElement(observer);</span>
<span class="lineNum">    2316 </span>            :   }
<span class="lineNum">    2317 </span>            : 
<span class="lineNum">    2318 </span><span class="lineCov">          1 :   if (observers.Count() == 0)</span>
<span class="lineNum">    2319 </span>            :     return NS_OK;
<span class="lineNum">    2320 </span>            : 
<span class="lineNum">    2321 </span><span class="lineCov">          1 :   *_count = observers.Count();</span>
<span class="lineNum">    2322 </span><span class="lineCov">          1 :   observers.Forget(_observers);</span>
<span class="lineNum">    2323 </span>            : 
<span class="lineNum">    2324 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    2325 </span>            : }
<span class="lineNum">    2326 </span>            : 
<a name="2327"><span class="lineNum">    2327 </span>            : // See RunInBatchMode</a>
<span class="lineNum">    2328 </span>            : nsresult
<span class="lineNum">    2329 </span><span class="lineCov">          1 : nsNavHistory::BeginUpdateBatch()</span>
<span class="lineNum">    2330 </span>            : {
<span class="lineNum">    2331 </span><span class="lineCov">          1 :   if (mBatchLevel++ == 0) {</span>
<span class="lineNum">    2332 </span><span class="lineCov">          1 :     mBatchDBTransaction = new mozStorageTransaction(mDB-&gt;MainConn(), false,</span>
<span class="lineNum">    2333 </span>            :                                                     mozIStorageConnection::TRANSACTION_DEFERRED,
<span class="lineNum">    2334 </span><span class="lineCov">          1 :                                                     true);</span>
<span class="lineNum">    2335 </span>            : 
<span class="lineNum">    2336 </span><span class="lineCov">          1 :     NOTIFY_OBSERVERS(mCanNotify, mCacheObservers, mObservers,</span>
<span class="lineNum">    2337 </span>            :                      nsINavHistoryObserver, OnBeginUpdateBatch());
<span class="lineNum">    2338 </span>            :   }
<span class="lineNum">    2339 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    2340 </span>            : }
<span class="lineNum">    2341 </span>            : 
<a name="2342"><span class="lineNum">    2342 </span>            : // nsNavHistory::EndUpdateBatch</a>
<span class="lineNum">    2343 </span>            : nsresult
<span class="lineNum">    2344 </span><span class="lineCov">          1 : nsNavHistory::EndUpdateBatch()</span>
<span class="lineNum">    2345 </span>            : {
<span class="lineNum">    2346 </span><span class="lineCov">          1 :   if (--mBatchLevel == 0) {</span>
<span class="lineNum">    2347 </span><span class="lineCov">          1 :     if (mBatchDBTransaction) {</span>
<span class="lineNum">    2348 </span><span class="lineCov">          1 :       DebugOnly&lt;nsresult&gt; rv = mBatchDBTransaction-&gt;Commit();</span>
<span class="lineNum">    2349 </span>            :       NS_WARNING_ASSERTION(NS_SUCCEEDED(rv),
<span class="lineNum">    2350 </span>            :                            &quot;Batch failed to commit transaction&quot;);
<span class="lineNum">    2351 </span><span class="lineCov">          1 :       delete mBatchDBTransaction;</span>
<span class="lineNum">    2352 </span><span class="lineCov">          1 :       mBatchDBTransaction = nullptr;</span>
<span class="lineNum">    2353 </span>            :     }
<span class="lineNum">    2354 </span>            : 
<span class="lineNum">    2355 </span><span class="lineCov">          1 :     NOTIFY_OBSERVERS(mCanNotify, mCacheObservers, mObservers,</span>
<span class="lineNum">    2356 </span>            :                      nsINavHistoryObserver, OnEndUpdateBatch());
<span class="lineNum">    2357 </span>            :   }
<span class="lineNum">    2358 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    2359 </span>            : }
<a name="2360"><span class="lineNum">    2360 </span>            : </a>
<span class="lineNum">    2361 </span>            : NS_IMETHODIMP
<span class="lineNum">    2362 </span><span class="lineCov">          1 : nsNavHistory::RunInBatchMode(nsINavHistoryBatchCallback* aCallback,</span>
<span class="lineNum">    2363 </span>            :                              nsISupports* aUserData)
<span class="lineNum">    2364 </span>            : {
<span class="lineNum">    2365 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    2366 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aCallback);</span>
<span class="lineNum">    2367 </span>            : 
<span class="lineNum">    2368 </span>            :   UpdateBatchScoper batch(*this);
<span class="lineNum">    2369 </span><span class="lineCov">          1 :   return aCallback-&gt;RunBatched(aUserData);</span>
<span class="lineNum">    2370 </span>            : }
<a name="2371"><span class="lineNum">    2371 </span>            : </a>
<span class="lineNum">    2372 </span>            : NS_IMETHODIMP
<span class="lineNum">    2373 </span><span class="lineNoCov">          0 : nsNavHistory::GetHistoryDisabled(bool *_retval)</span>
<span class="lineNum">    2374 </span>            : {
<span class="lineNum">    2375 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    2376 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(_retval);</span>
<span class="lineNum">    2377 </span>            : 
<span class="lineNum">    2378 </span><span class="lineNoCov">          0 :   *_retval = IsHistoryDisabled();</span>
<span class="lineNum">    2379 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    2380 </span>            : }
<span class="lineNum">    2381 </span>            : 
<span class="lineNum">    2382 </span>            : // Browser history *************************************************************
<span class="lineNum">    2383 </span>            : 
<span class="lineNum">    2384 </span>            : 
<span class="lineNum">    2385 </span>            : // nsNavHistory::RemovePagesInternal
<span class="lineNum">    2386 </span>            : //
<span class="lineNum">    2387 </span>            : //    Deletes a list of placeIds from history.
<span class="lineNum">    2388 </span>            : //    This is an internal method used by RemovePages, RemovePagesFromHost and
<span class="lineNum">    2389 </span>            : //    RemovePagesByTimeframe.
<span class="lineNum">    2390 </span>            : //    Takes a comma separated list of place ids.
<span class="lineNum">    2391 </span>            : //    This method does not do any observer notification.
<a name="2392"><span class="lineNum">    2392 </span>            : </a>
<span class="lineNum">    2393 </span>            : nsresult
<span class="lineNum">    2394 </span><span class="lineCov">          1 : nsNavHistory::RemovePagesInternal(const nsCString&amp; aPlaceIdsQueryString)</span>
<span class="lineNum">    2395 </span>            : {
<span class="lineNum">    2396 </span>            :   // Return early if there is nothing to delete.
<span class="lineNum">    2397 </span><span class="lineCov">          1 :   if (aPlaceIdsQueryString.IsEmpty())</span>
<span class="lineNum">    2398 </span>            :     return NS_OK;
<span class="lineNum">    2399 </span>            : 
<span class="lineNum">    2400 </span>            :   mozStorageTransaction transaction(mDB-&gt;MainConn(), false,
<span class="lineNum">    2401 </span>            :                                     mozIStorageConnection::TRANSACTION_DEFERRED,
<span class="lineNum">    2402 </span><span class="lineCov">          1 :                                     true);</span>
<span class="lineNum">    2403 </span>            : 
<span class="lineNum">    2404 </span>            :   // Delete all visits for the specified place ids.
<span class="lineNum">    2405 </span><span class="lineCov">          1 :   nsresult rv = mDB-&gt;MainConn()-&gt;ExecuteSimpleSQL(</span>
<span class="lineNum">    2406 </span>            :     NS_LITERAL_CSTRING(
<span class="lineNum">    2407 </span><span class="lineCov">          1 :       &quot;DELETE FROM moz_historyvisits WHERE place_id IN (&quot;) +</span>
<span class="lineNum">    2408 </span><span class="lineCov">          1 :         aPlaceIdsQueryString +</span>
<span class="lineNum">    2409 </span><span class="lineCov">          1 :         NS_LITERAL_CSTRING(&quot;)&quot;)</span>
<span class="lineNum">    2410 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    2411 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2412 </span>            : 
<span class="lineNum">    2413 </span><span class="lineCov">          1 :   rv = CleanupPlacesOnVisitsDelete(aPlaceIdsQueryString);</span>
<span class="lineNum">    2414 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2415 </span>            : 
<span class="lineNum">    2416 </span>            :   // Invalidate the cached value for whether there's history or not.
<span class="lineNum">    2417 </span><span class="lineCov">          1 :   mDaysOfHistory = -1;</span>
<span class="lineNum">    2418 </span>            : 
<span class="lineNum">    2419 </span><span class="lineCov">          1 :   return transaction.Commit();</span>
<span class="lineNum">    2420 </span>            : }
<span class="lineNum">    2421 </span>            : 
<span class="lineNum">    2422 </span>            : 
<span class="lineNum">    2423 </span>            : /**
<span class="lineNum">    2424 </span>            :  * Performs cleanup on places that just had all their visits removed, including
<span class="lineNum">    2425 </span>            :  * deletion of those places.  This is an internal method used by
<span class="lineNum">    2426 </span>            :  * RemovePagesInternal.  This method does not execute in a transaction, so
<span class="lineNum">    2427 </span>            :  * callers should make sure they begin one if needed.
<span class="lineNum">    2428 </span>            :  *
<span class="lineNum">    2429 </span>            :  * @param aPlaceIdsQueryString
<span class="lineNum">    2430 </span>            :  *        A comma-separated list of place IDs, each of which just had all its
<span class="lineNum">    2431 </span>            :  *        visits removed
<a name="2432"><span class="lineNum">    2432 </span>            :  */</a>
<span class="lineNum">    2433 </span>            : nsresult
<span class="lineNum">    2434 </span><span class="lineCov">          1 : nsNavHistory::CleanupPlacesOnVisitsDelete(const nsCString&amp; aPlaceIdsQueryString)</span>
<span class="lineNum">    2435 </span>            : {
<span class="lineNum">    2436 </span>            :   // Return early if there is nothing to delete.
<span class="lineNum">    2437 </span><span class="lineCov">          1 :   if (aPlaceIdsQueryString.IsEmpty())</span>
<span class="lineNum">    2438 </span>            :     return NS_OK;
<span class="lineNum">    2439 </span>            : 
<span class="lineNum">    2440 </span>            :   // Collect about-to-be-deleted URIs to notify onDeleteURI.
<span class="lineNum">    2441 </span>            :   nsCOMPtr&lt;mozIStorageStatement&gt; stmt = mDB-&gt;GetStatement(NS_LITERAL_CSTRING(
<span class="lineNum">    2442 </span>            :     &quot;SELECT h.id, h.url, h.guid, &quot;
<span class="lineNum">    2443 </span>            :            &quot;(SUBSTR(h.url, 1, 6) &lt;&gt; 'place:' &quot;
<span class="lineNum">    2444 </span>            :            &quot; AND NOT EXISTS (SELECT b.id FROM moz_bookmarks b &quot;
<span class="lineNum">    2445 </span>            :                             &quot;WHERE b.fk = h.id LIMIT 1)) as whole_entry &quot;
<span class="lineNum">    2446 </span>            :     &quot;FROM moz_places h &quot;
<span class="lineNum">    2447 </span><span class="lineCov">          1 :     &quot;WHERE h.id IN ( &quot;) + aPlaceIdsQueryString + NS_LITERAL_CSTRING(&quot;)&quot;)</span>
<span class="lineNum">    2448 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    2449 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(stmt);</span>
<span class="lineNum">    2450 </span><span class="lineCov">          1 :   mozStorageStatementScoper scoper(stmt);</span>
<span class="lineNum">    2451 </span>            : 
<span class="lineNum">    2452 </span>            :   nsCString filteredPlaceIds;
<span class="lineNum">    2453 </span>            :   nsCOMArray&lt;nsIURI&gt; URIs;
<span class="lineNum">    2454 </span>            :   nsTArray&lt;nsCString&gt; GUIDs;
<span class="lineNum">    2455 </span>            :   bool hasMore;
<span class="lineNum">    2456 </span><span class="lineCov">          1 :   while (NS_SUCCEEDED(stmt-&gt;ExecuteStep(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<span class="lineNum">    2457 </span>            :     int64_t placeId;
<span class="lineNum">    2458 </span><span class="lineCov">          1 :     nsresult rv = stmt-&gt;GetInt64(0, &amp;placeId);</span>
<span class="lineNum">    2459 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2460 </span><span class="lineCov">          1 :     nsAutoCString URLString;</span>
<span class="lineNum">    2461 </span><span class="lineCov">          1 :     rv = stmt-&gt;GetUTF8String(1, URLString);</span>
<span class="lineNum">    2462 </span>            :     nsCString guid;
<span class="lineNum">    2463 </span><span class="lineCov">          1 :     rv = stmt-&gt;GetUTF8String(2, guid);</span>
<span class="lineNum">    2464 </span>            :     int32_t wholeEntry;
<span class="lineNum">    2465 </span><span class="lineCov">          1 :     rv = stmt-&gt;GetInt32(3, &amp;wholeEntry);</span>
<span class="lineNum">    2466 </span>            :     nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">    2467 </span><span class="lineCov">          1 :     rv = NS_NewURI(getter_AddRefs(uri), URLString);</span>
<span class="lineNum">    2468 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2469 </span><span class="lineCov">          1 :     if (wholeEntry) {</span>
<span class="lineNum">    2470 </span><span class="lineCov">          1 :       if (!filteredPlaceIds.IsEmpty()) {</span>
<span class="lineNum">    2471 </span><span class="lineCov">          1 :         filteredPlaceIds.Append(',');</span>
<span class="lineNum">    2472 </span>            :       }
<span class="lineNum">    2473 </span><span class="lineCov">          1 :       filteredPlaceIds.AppendInt(placeId);</span>
<span class="lineNum">    2474 </span><span class="lineCov">          1 :       URIs.AppendElement(uri.forget());</span>
<span class="lineNum">    2475 </span><span class="lineCov">          1 :       GUIDs.AppendElement(guid);</span>
<span class="lineNum">    2476 </span>            :     }
<span class="lineNum">    2477 </span>            :     else {
<span class="lineNum">    2478 </span>            :       // Notify that we will delete all visits for this page, but not the page
<span class="lineNum">    2479 </span>            :       // itself, since it's bookmarked or a place: query.
<span class="lineNum">    2480 </span><span class="lineNoCov">          0 :       NOTIFY_OBSERVERS(mCanNotify, mCacheObservers, mObservers,</span>
<span class="lineNum">    2481 </span>            :                        nsINavHistoryObserver,
<span class="lineNum">    2482 </span>            :                        OnDeleteVisits(uri, 0, guid, nsINavHistoryObserver::REASON_DELETED, 0));
<span class="lineNum">    2483 </span>            :     }
<span class="lineNum">    2484 </span>            :   }
<span class="lineNum">    2485 </span>            : 
<span class="lineNum">    2486 </span>            :   // if the entry is not bookmarked and is not a place: uri
<span class="lineNum">    2487 </span>            :   // then we can remove it from moz_places.
<span class="lineNum">    2488 </span>            :   // Note that we do NOT delete favicons. Any unreferenced favicons will be
<span class="lineNum">    2489 </span>            :   // deleted next time the browser is shut down.
<span class="lineNum">    2490 </span><span class="lineCov">          1 :   nsresult rv = mDB-&gt;MainConn()-&gt;ExecuteSimpleSQL(</span>
<span class="lineNum">    2491 </span>            :     NS_LITERAL_CSTRING(
<span class="lineNum">    2492 </span>            :       &quot;DELETE FROM moz_places WHERE id IN ( &quot;
<span class="lineNum">    2493 </span><span class="lineCov">          1 :         ) + filteredPlaceIds + NS_LITERAL_CSTRING(</span>
<span class="lineNum">    2494 </span>            :       &quot;) &quot;
<span class="lineNum">    2495 </span>            :     )
<span class="lineNum">    2496 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    2497 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2498 </span>            : 
<span class="lineNum">    2499 </span>            :   // Expire orphan icons.
<span class="lineNum">    2500 </span><span class="lineCov">          1 :   rv = mDB-&gt;MainConn()-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<span class="lineNum">    2501 </span>            :     &quot;DELETE FROM moz_pages_w_icons &quot;
<span class="lineNum">    2502 </span>            :     &quot;WHERE page_url_hash NOT IN (SELECT url_hash FROM moz_places) &quot;
<span class="lineNum">    2503 </span><span class="lineCov">          1 :   ));</span>
<span class="lineNum">    2504 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2505 </span><span class="lineCov">          1 :   rv = mDB-&gt;MainConn()-&gt;ExecuteSimpleSQL(NS_LITERAL_CSTRING(</span>
<span class="lineNum">    2506 </span>            :     &quot;DELETE FROM moz_icons &quot;
<span class="lineNum">    2507 </span>            :     &quot;WHERE root = 0 AND id NOT IN (SELECT icon_id FROM moz_icons_to_pages) &quot;
<span class="lineNum">    2508 </span><span class="lineCov">          1 :   ));</span>
<span class="lineNum">    2509 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2510 </span>            : 
<span class="lineNum">    2511 </span>            :   // Hosts accumulated during the places delete are updated through a trigger
<span class="lineNum">    2512 </span>            :   // (see nsPlacesTriggers.h).
<span class="lineNum">    2513 </span><span class="lineCov">          1 :   rv = mDB-&gt;MainConn()-&gt;ExecuteSimpleSQL(</span>
<span class="lineNum">    2514 </span>            :     NS_LITERAL_CSTRING(&quot;DELETE FROM moz_updatehosts_temp&quot;)
<span class="lineNum">    2515 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    2516 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2517 </span>            : 
<span class="lineNum">    2518 </span>            :   // Invalidate frecencies of touched places, since they need recalculation.
<span class="lineNum">    2519 </span><span class="lineCov">          1 :   rv = invalidateFrecencies(aPlaceIdsQueryString);</span>
<span class="lineNum">    2520 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2521 </span>            : 
<span class="lineNum">    2522 </span>            :   // Finally notify about the removed URIs.
<span class="lineNum">    2523 </span><span class="lineCov">          1 :   for (int32_t i = 0; i &lt; URIs.Count(); ++i) {</span>
<span class="lineNum">    2524 </span><span class="lineCov">          1 :     NOTIFY_OBSERVERS(mCanNotify, mCacheObservers, mObservers,</span>
<span class="lineNum">    2525 </span>            :                      nsINavHistoryObserver,
<span class="lineNum">    2526 </span>            :                      OnDeleteURI(URIs[i], GUIDs[i], nsINavHistoryObserver::REASON_DELETED));
<span class="lineNum">    2527 </span>            :   }
<span class="lineNum">    2528 </span>            : 
<span class="lineNum">    2529 </span>            :   return NS_OK;
<span class="lineNum">    2530 </span>            : }
<span class="lineNum">    2531 </span>            : 
<span class="lineNum">    2532 </span>            : 
<span class="lineNum">    2533 </span>            : // nsNavHistory::RemovePages
<span class="lineNum">    2534 </span>            : //
<span class="lineNum">    2535 </span>            : //    Removes a bunch of uris from history.
<span class="lineNum">    2536 </span>            : //    Has better performance than RemovePage when deleting a lot of history.
<span class="lineNum">    2537 </span>            : //    We don't do duplicates removal, URIs array should be cleaned-up before.
<a name="2538"><span class="lineNum">    2538 </span>            : </a>
<span class="lineNum">    2539 </span>            : NS_IMETHODIMP
<span class="lineNum">    2540 </span><span class="lineNoCov">          0 : nsNavHistory::RemovePages(nsIURI **aURIs, uint32_t aLength)</span>
<span class="lineNum">    2541 </span>            : {
<span class="lineNum">    2542 </span><span class="lineNoCov">          0 :   PLACES_WARN_DEPRECATED();</span>
<span class="lineNum">    2543 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    2544 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG(aURIs);</span>
<span class="lineNum">    2545 </span>            : 
<span class="lineNum">    2546 </span>            :   nsresult rv;
<span class="lineNum">    2547 </span>            :   // build a list of place ids to delete
<span class="lineNum">    2548 </span>            :   nsCString deletePlaceIdsQueryString;
<span class="lineNum">    2549 </span><span class="lineNoCov">          0 :   for (uint32_t i = 0; i &lt; aLength; i++) {</span>
<span class="lineNum">    2550 </span>            :     int64_t placeId;
<span class="lineNum">    2551 </span><span class="lineNoCov">          0 :     nsAutoCString guid;</span>
<span class="lineNum">    2552 </span><span class="lineNoCov">          0 :     if (!aURIs[i])</span>
<span class="lineNum">    2553 </span>            :       continue;
<span class="lineNum">    2554 </span><span class="lineNoCov">          0 :     rv = GetIdForPage(aURIs[i], &amp;placeId, guid);</span>
<span class="lineNum">    2555 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2556 </span><span class="lineNoCov">          0 :     if (placeId != 0) {</span>
<span class="lineNum">    2557 </span><span class="lineNoCov">          0 :       if (!deletePlaceIdsQueryString.IsEmpty())</span>
<span class="lineNum">    2558 </span><span class="lineNoCov">          0 :         deletePlaceIdsQueryString.Append(',');</span>
<span class="lineNum">    2559 </span><span class="lineNoCov">          0 :       deletePlaceIdsQueryString.AppendInt(placeId);</span>
<span class="lineNum">    2560 </span>            :     }
<span class="lineNum">    2561 </span>            :   }
<span class="lineNum">    2562 </span>            : 
<span class="lineNum">    2563 </span><span class="lineNoCov">          0 :   UpdateBatchScoper batch(*this); // sends Begin/EndUpdateBatch to observers</span>
<span class="lineNum">    2564 </span>            : 
<span class="lineNum">    2565 </span><span class="lineNoCov">          0 :   rv = RemovePagesInternal(deletePlaceIdsQueryString);</span>
<span class="lineNum">    2566 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2567 </span>            : 
<span class="lineNum">    2568 </span>            :   // Clear the registered embed visits.
<span class="lineNum">    2569 </span>            :   clearEmbedVisits();
<span class="lineNum">    2570 </span>            : 
<span class="lineNum">    2571 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    2572 </span>            : }
<span class="lineNum">    2573 </span>            : 
<span class="lineNum">    2574 </span>            : 
<span class="lineNum">    2575 </span>            : // nsNavHistory::RemovePage
<span class="lineNum">    2576 </span>            : //
<span class="lineNum">    2577 </span>            : //    Removes all visits and the main history entry for the given URI.
<span class="lineNum">    2578 </span>            : //    Silently fails if we have no knowledge of the page.
<a name="2579"><span class="lineNum">    2579 </span>            : </a>
<span class="lineNum">    2580 </span>            : NS_IMETHODIMP
<span class="lineNum">    2581 </span><span class="lineNoCov">          0 : nsNavHistory::RemovePage(nsIURI *aURI)</span>
<span class="lineNum">    2582 </span>            : {
<span class="lineNum">    2583 </span><span class="lineNoCov">          0 :   PLACES_WARN_DEPRECATED();</span>
<span class="lineNum">    2584 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    2585 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG(aURI);</span>
<span class="lineNum">    2586 </span>            : 
<span class="lineNum">    2587 </span>            :   // Build a list of place ids to delete.
<span class="lineNum">    2588 </span>            :   int64_t placeId;
<span class="lineNum">    2589 </span><span class="lineNoCov">          0 :   nsAutoCString guid;</span>
<span class="lineNum">    2590 </span><span class="lineNoCov">          0 :   nsresult rv = GetIdForPage(aURI, &amp;placeId, guid);</span>
<span class="lineNum">    2591 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2592 </span><span class="lineNoCov">          0 :   if (placeId == 0) {</span>
<span class="lineNum">    2593 </span>            :     return NS_OK;
<span class="lineNum">    2594 </span>            :   }
<span class="lineNum">    2595 </span><span class="lineNoCov">          0 :   nsAutoCString deletePlaceIdQueryString;</span>
<span class="lineNum">    2596 </span><span class="lineNoCov">          0 :   deletePlaceIdQueryString.AppendInt(placeId);</span>
<span class="lineNum">    2597 </span>            : 
<span class="lineNum">    2598 </span><span class="lineNoCov">          0 :   rv = RemovePagesInternal(deletePlaceIdQueryString);</span>
<span class="lineNum">    2599 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2600 </span>            : 
<span class="lineNum">    2601 </span>            :   // Clear the registered embed visits.
<span class="lineNum">    2602 </span>            :   clearEmbedVisits();
<span class="lineNum">    2603 </span>            : 
<span class="lineNum">    2604 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    2605 </span>            : }
<span class="lineNum">    2606 </span>            : 
<span class="lineNum">    2607 </span>            : 
<span class="lineNum">    2608 </span>            : // nsNavHistory::RemovePagesFromHost
<span class="lineNum">    2609 </span>            : //
<span class="lineNum">    2610 </span>            : //    This function will delete all history information about pages from a
<span class="lineNum">    2611 </span>            : //    given host. If aEntireDomain is set, we will also delete pages from
<span class="lineNum">    2612 </span>            : //    sub hosts (so if we are passed in &quot;microsoft.com&quot; we delete
<span class="lineNum">    2613 </span>            : //    &quot;www.microsoft.com&quot;, &quot;msdn.microsoft.com&quot;, etc.). An empty host name
<span class="lineNum">    2614 </span>            : //    means local files and anything else with no host name. You can also pass
<span class="lineNum">    2615 </span>            : //    in the localized &quot;(local files)&quot; title given to you from a history query.
<span class="lineNum">    2616 </span>            : //
<span class="lineNum">    2617 </span>            : //    Silently fails if we have no knowledge of the host.
<span class="lineNum">    2618 </span>            : //
<span class="lineNum">    2619 </span>            : //    This sends onBeginUpdateBatch/onEndUpdateBatch to observers
<a name="2620"><span class="lineNum">    2620 </span>            : </a>
<span class="lineNum">    2621 </span>            : NS_IMETHODIMP
<span class="lineNum">    2622 </span><span class="lineCov">          1 : nsNavHistory::RemovePagesFromHost(const nsACString&amp; aHost, bool aEntireDomain)</span>
<span class="lineNum">    2623 </span>            : {
<span class="lineNum">    2624 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    2625 </span>            : 
<span class="lineNum">    2626 </span>            :   nsresult rv;
<span class="lineNum">    2627 </span>            :   // Local files don't have any host name. We don't want to delete all files in
<span class="lineNum">    2628 </span>            :   // history when we get passed an empty string, so force to exact match
<span class="lineNum">    2629 </span><span class="lineCov">          1 :   if (aHost.IsEmpty())</span>
<span class="lineNum">    2630 </span><span class="lineNoCov">          0 :     aEntireDomain = false;</span>
<span class="lineNum">    2631 </span>            : 
<span class="lineNum">    2632 </span>            :   // translate &quot;(local files)&quot; to an empty host name
<span class="lineNum">    2633 </span>            :   // be sure to use the TitleForDomain to get the localized name
<span class="lineNum">    2634 </span>            :   nsCString localFiles;
<span class="lineNum">    2635 </span><span class="lineCov">          1 :   TitleForDomain(EmptyCString(), localFiles);</span>
<span class="lineNum">    2636 </span><span class="lineCov">          1 :   nsAutoString host16;</span>
<span class="lineNum">    2637 </span><span class="lineCov">          1 :   if (!aHost.Equals(localFiles))</span>
<span class="lineNum">    2638 </span><span class="lineCov">          1 :     CopyUTF8toUTF16(aHost, host16);</span>
<span class="lineNum">    2639 </span>            : 
<span class="lineNum">    2640 </span>            :   // see BindQueryClauseParameters for how this host selection works
<span class="lineNum">    2641 </span><span class="lineCov">          1 :   nsAutoString revHostDot;</span>
<span class="lineNum">    2642 </span><span class="lineCov">          1 :   GetReversedHostname(host16, revHostDot);</span>
<span class="lineNum">    2643 </span>            :   NS_ASSERTION(revHostDot[revHostDot.Length() - 1] == '.', &quot;Invalid rev. host&quot;);
<span class="lineNum">    2644 </span><span class="lineCov">          1 :   nsAutoString revHostSlash(revHostDot);</span>
<span class="lineNum">    2645 </span><span class="lineCov">          1 :   revHostSlash.Truncate(revHostSlash.Length() - 1);</span>
<span class="lineNum">    2646 </span><span class="lineCov">          1 :   revHostSlash.Append('/');</span>
<span class="lineNum">    2647 </span>            : 
<span class="lineNum">    2648 </span>            :   // build condition string based on host selection type
<span class="lineNum">    2649 </span><span class="lineCov">          1 :   nsAutoCString conditionString;</span>
<span class="lineNum">    2650 </span><span class="lineCov">          1 :   if (aEntireDomain)</span>
<span class="lineNum">    2651 </span><span class="lineCov">          1 :     conditionString.AssignLiteral(&quot;rev_host &gt;= ?1 AND rev_host &lt; ?2 &quot;);</span>
<span class="lineNum">    2652 </span>            :   else
<span class="lineNum">    2653 </span><span class="lineNoCov">          0 :     conditionString.AssignLiteral(&quot;rev_host = ?1 &quot;);</span>
<span class="lineNum">    2654 </span>            : 
<span class="lineNum">    2655 </span>            :   // create statement depending on delete type
<span class="lineNum">    2656 </span>            :   nsCOMPtr&lt;mozIStorageStatement&gt; statement = mDB-&gt;GetStatement(
<span class="lineNum">    2657 </span><span class="lineCov">          1 :     NS_LITERAL_CSTRING(&quot;SELECT id FROM moz_places WHERE &quot;) + conditionString</span>
<span class="lineNum">    2658 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    2659 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(statement);</span>
<span class="lineNum">    2660 </span><span class="lineCov">          1 :   mozStorageStatementScoper scoper(statement);</span>
<span class="lineNum">    2661 </span>            : 
<span class="lineNum">    2662 </span><span class="lineCov">          1 :   rv = statement-&gt;BindStringByIndex(0, revHostDot);</span>
<span class="lineNum">    2663 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2664 </span><span class="lineCov">          1 :   if (aEntireDomain) {</span>
<span class="lineNum">    2665 </span><span class="lineCov">          1 :     rv = statement-&gt;BindStringByIndex(1, revHostSlash);</span>
<span class="lineNum">    2666 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2667 </span>            :   }
<span class="lineNum">    2668 </span>            : 
<span class="lineNum">    2669 </span>            :   nsCString hostPlaceIds;
<span class="lineNum">    2670 </span><span class="lineCov">          1 :   bool hasMore = false;</span>
<span class="lineNum">    2671 </span><span class="lineCov">          1 :   while (NS_SUCCEEDED(statement-&gt;ExecuteStep(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<span class="lineNum">    2672 </span><span class="lineCov">          1 :     if (!hostPlaceIds.IsEmpty())</span>
<span class="lineNum">    2673 </span><span class="lineCov">          1 :       hostPlaceIds.Append(',');</span>
<span class="lineNum">    2674 </span>            :     int64_t placeId;
<span class="lineNum">    2675 </span><span class="lineCov">          1 :     rv = statement-&gt;GetInt64(0, &amp;placeId);</span>
<span class="lineNum">    2676 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2677 </span><span class="lineCov">          1 :     hostPlaceIds.AppendInt(placeId);</span>
<span class="lineNum">    2678 </span>            :   }
<span class="lineNum">    2679 </span>            : 
<span class="lineNum">    2680 </span>            :   // force a full refresh calling onEndUpdateBatch (will call Refresh())
<span class="lineNum">    2681 </span><span class="lineCov">          1 :   UpdateBatchScoper batch(*this); // sends Begin/EndUpdateBatch to observers</span>
<span class="lineNum">    2682 </span>            : 
<span class="lineNum">    2683 </span><span class="lineCov">          1 :   rv = RemovePagesInternal(hostPlaceIds);</span>
<span class="lineNum">    2684 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2685 </span>            : 
<span class="lineNum">    2686 </span>            :   // Clear the registered embed visits.
<span class="lineNum">    2687 </span>            :   clearEmbedVisits();
<span class="lineNum">    2688 </span>            : 
<span class="lineNum">    2689 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    2690 </span>            : }
<span class="lineNum">    2691 </span>            : 
<span class="lineNum">    2692 </span>            : 
<span class="lineNum">    2693 </span>            : // nsNavHistory::RemovePagesByTimeframe
<span class="lineNum">    2694 </span>            : //
<span class="lineNum">    2695 </span>            : //    This function will delete all history information about
<span class="lineNum">    2696 </span>            : //    pages for a given timeframe.
<span class="lineNum">    2697 </span>            : //    Limits are included: aBeginTime &lt;= timeframe &lt;= aEndTime
<span class="lineNum">    2698 </span>            : //
<span class="lineNum">    2699 </span>            : //    This method sends onBeginUpdateBatch/onEndUpdateBatch to observers
<a name="2700"><span class="lineNum">    2700 </span>            : </a>
<span class="lineNum">    2701 </span>            : NS_IMETHODIMP
<span class="lineNum">    2702 </span><span class="lineCov">          1 : nsNavHistory::RemovePagesByTimeframe(PRTime aBeginTime, PRTime aEndTime)</span>
<span class="lineNum">    2703 </span>            : {
<span class="lineNum">    2704 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    2705 </span>            : 
<span class="lineNum">    2706 </span>            :   nsresult rv;
<span class="lineNum">    2707 </span>            :   // build a list of place ids to delete
<span class="lineNum">    2708 </span>            :   nsCString deletePlaceIdsQueryString;
<span class="lineNum">    2709 </span>            : 
<span class="lineNum">    2710 </span>            :   // we only need to know if a place has a visit into the given timeframe
<span class="lineNum">    2711 </span>            :   // this query is faster than actually selecting in moz_historyvisits
<span class="lineNum">    2712 </span>            :   nsCOMPtr&lt;mozIStorageStatement&gt; selectByTime = mDB-&gt;GetStatement(
<span class="lineNum">    2713 </span>            :     &quot;SELECT h.id FROM moz_places h WHERE &quot;
<span class="lineNum">    2714 </span>            :       &quot;EXISTS &quot;
<span class="lineNum">    2715 </span>            :         &quot;(SELECT id FROM moz_historyvisits v WHERE v.place_id = h.id &quot;
<span class="lineNum">    2716 </span>            :           &quot;AND v.visit_date &gt;= :from_date AND v.visit_date &lt;= :to_date LIMIT 1)&quot;
<span class="lineNum">    2717 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    2718 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(selectByTime);</span>
<span class="lineNum">    2719 </span><span class="lineCov">          1 :   mozStorageStatementScoper selectByTimeScoper(selectByTime);</span>
<span class="lineNum">    2720 </span>            : 
<span class="lineNum">    2721 </span><span class="lineCov">          1 :   rv = selectByTime-&gt;BindInt64ByName(NS_LITERAL_CSTRING(&quot;from_date&quot;), aBeginTime);</span>
<span class="lineNum">    2722 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2723 </span><span class="lineCov">          1 :   rv = selectByTime-&gt;BindInt64ByName(NS_LITERAL_CSTRING(&quot;to_date&quot;), aEndTime);</span>
<span class="lineNum">    2724 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2725 </span>            : 
<span class="lineNum">    2726 </span><span class="lineCov">          1 :   bool hasMore = false;</span>
<span class="lineNum">    2727 </span><span class="lineCov">          1 :   while (NS_SUCCEEDED(selectByTime-&gt;ExecuteStep(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<span class="lineNum">    2728 </span>            :     int64_t placeId;
<span class="lineNum">    2729 </span><span class="lineCov">          1 :     rv = selectByTime-&gt;GetInt64(0, &amp;placeId);</span>
<span class="lineNum">    2730 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2731 </span><span class="lineCov">          1 :     if (placeId != 0) {</span>
<span class="lineNum">    2732 </span><span class="lineCov">          1 :       if (!deletePlaceIdsQueryString.IsEmpty())</span>
<span class="lineNum">    2733 </span><span class="lineNoCov">          0 :         deletePlaceIdsQueryString.Append(',');</span>
<span class="lineNum">    2734 </span><span class="lineCov">          1 :       deletePlaceIdsQueryString.AppendInt(placeId);</span>
<span class="lineNum">    2735 </span>            :     }
<span class="lineNum">    2736 </span>            :   }
<span class="lineNum">    2737 </span>            : 
<span class="lineNum">    2738 </span>            :   // force a full refresh calling onEndUpdateBatch (will call Refresh())
<span class="lineNum">    2739 </span><span class="lineCov">          1 :   UpdateBatchScoper batch(*this); // sends Begin/EndUpdateBatch to observers</span>
<span class="lineNum">    2740 </span>            : 
<span class="lineNum">    2741 </span><span class="lineCov">          1 :   rv = RemovePagesInternal(deletePlaceIdsQueryString);</span>
<span class="lineNum">    2742 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2743 </span>            : 
<span class="lineNum">    2744 </span>            :   // Clear the registered embed visits.
<span class="lineNum">    2745 </span>            :   clearEmbedVisits();
<span class="lineNum">    2746 </span>            : 
<span class="lineNum">    2747 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    2748 </span>            : }
<span class="lineNum">    2749 </span>            : 
<span class="lineNum">    2750 </span>            : 
<span class="lineNum">    2751 </span>            : // Call this method before visiting a URL in order to help determine the
<span class="lineNum">    2752 </span>            : // transition type of the visit.
<span class="lineNum">    2753 </span>            : //
<span class="lineNum">    2754 </span>            : // @see MarkPageAsFollowedBookmark
<a name="2755"><span class="lineNum">    2755 </span>            : </a>
<span class="lineNum">    2756 </span>            : NS_IMETHODIMP
<span class="lineNum">    2757 </span><span class="lineCov">          1 : nsNavHistory::MarkPageAsTyped(nsIURI *aURI)</span>
<span class="lineNum">    2758 </span>            : {
<span class="lineNum">    2759 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    2760 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aURI);</span>
<span class="lineNum">    2761 </span>            : 
<span class="lineNum">    2762 </span>            :   // don't add when history is disabled
<span class="lineNum">    2763 </span><span class="lineCov">          1 :   if (IsHistoryDisabled())</span>
<span class="lineNum">    2764 </span>            :     return NS_OK;
<span class="lineNum">    2765 </span>            : 
<span class="lineNum">    2766 </span><span class="lineCov">          1 :   nsAutoCString uriString;</span>
<span class="lineNum">    2767 </span><span class="lineCov">          1 :   nsresult rv = aURI-&gt;GetSpec(uriString);</span>
<span class="lineNum">    2768 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2769 </span>            : 
<span class="lineNum">    2770 </span>            :   // if URL is already in the typed queue, then we need to remove the old one
<span class="lineNum">    2771 </span>            :   int64_t unusedEventTime;
<span class="lineNum">    2772 </span><span class="lineCov">          1 :   if (mRecentTyped.Get(uriString, &amp;unusedEventTime))</span>
<span class="lineNum">    2773 </span><span class="lineNoCov">          0 :     mRecentTyped.Remove(uriString);</span>
<span class="lineNum">    2774 </span>            : 
<span class="lineNum">    2775 </span><span class="lineCov">          1 :   if (mRecentTyped.Count() &gt; RECENT_EVENT_QUEUE_MAX_LENGTH)</span>
<span class="lineNum">    2776 </span><span class="lineNoCov">          0 :     ExpireNonrecentEvents(&amp;mRecentTyped);</span>
<span class="lineNum">    2777 </span>            : 
<span class="lineNum">    2778 </span><span class="lineCov">          1 :   mRecentTyped.Put(uriString, GetNow());</span>
<span class="lineNum">    2779 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    2780 </span>            : }
<span class="lineNum">    2781 </span>            : 
<span class="lineNum">    2782 </span>            : 
<span class="lineNum">    2783 </span>            : // Call this method before visiting a URL in order to help determine the
<span class="lineNum">    2784 </span>            : // transition type of the visit.
<span class="lineNum">    2785 </span>            : //
<span class="lineNum">    2786 </span>            : // @see MarkPageAsTyped
<a name="2787"><span class="lineNum">    2787 </span>            : </a>
<span class="lineNum">    2788 </span>            : NS_IMETHODIMP
<span class="lineNum">    2789 </span><span class="lineCov">          1 : nsNavHistory::MarkPageAsFollowedLink(nsIURI *aURI)</span>
<span class="lineNum">    2790 </span>            : {
<span class="lineNum">    2791 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    2792 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aURI);</span>
<span class="lineNum">    2793 </span>            : 
<span class="lineNum">    2794 </span>            :   // don't add when history is disabled
<span class="lineNum">    2795 </span><span class="lineCov">          1 :   if (IsHistoryDisabled())</span>
<span class="lineNum">    2796 </span>            :     return NS_OK;
<span class="lineNum">    2797 </span>            : 
<span class="lineNum">    2798 </span><span class="lineCov">          1 :   nsAutoCString uriString;</span>
<span class="lineNum">    2799 </span><span class="lineCov">          1 :   nsresult rv = aURI-&gt;GetSpec(uriString);</span>
<span class="lineNum">    2800 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2801 </span>            : 
<span class="lineNum">    2802 </span>            :   // if URL is already in the links queue, then we need to remove the old one
<span class="lineNum">    2803 </span>            :   int64_t unusedEventTime;
<span class="lineNum">    2804 </span><span class="lineCov">          1 :   if (mRecentLink.Get(uriString, &amp;unusedEventTime))</span>
<span class="lineNum">    2805 </span><span class="lineCov">          1 :     mRecentLink.Remove(uriString);</span>
<span class="lineNum">    2806 </span>            : 
<span class="lineNum">    2807 </span><span class="lineCov">          1 :   if (mRecentLink.Count() &gt; RECENT_EVENT_QUEUE_MAX_LENGTH)</span>
<span class="lineNum">    2808 </span><span class="lineNoCov">          0 :     ExpireNonrecentEvents(&amp;mRecentLink);</span>
<span class="lineNum">    2809 </span>            : 
<span class="lineNum">    2810 </span><span class="lineCov">          1 :   mRecentLink.Put(uriString, GetNow());</span>
<span class="lineNum">    2811 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    2812 </span>            : }
<span class="lineNum">    2813 </span>            : 
<a name="2814"><span class="lineNum">    2814 </span>            : </a>
<span class="lineNum">    2815 </span>            : NS_IMETHODIMP
<span class="lineNum">    2816 </span><span class="lineCov">          1 : nsNavHistory::GetPageTitle(nsIURI* aURI, nsAString&amp; aTitle)</span>
<span class="lineNum">    2817 </span>            : {
<span class="lineNum">    2818 </span><span class="lineCov">          1 :   PLACES_WARN_DEPRECATED();</span>
<span class="lineNum">    2819 </span>            : 
<span class="lineNum">    2820 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    2821 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aURI);</span>
<span class="lineNum">    2822 </span>            : 
<span class="lineNum">    2823 </span>            :   aTitle.Truncate(0);
<span class="lineNum">    2824 </span>            : 
<span class="lineNum">    2825 </span>            :   nsCOMPtr&lt;mozIStorageStatement&gt; stmt = mDB-&gt;GetStatement(
<span class="lineNum">    2826 </span>            :     &quot;SELECT id, url, title, rev_host, visit_count, guid &quot;
<span class="lineNum">    2827 </span>            :     &quot;FROM moz_places &quot;
<span class="lineNum">    2828 </span>            :     &quot;WHERE url_hash = hash(:page_url) AND url = :page_url &quot;
<span class="lineNum">    2829 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    2830 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(stmt);</span>
<span class="lineNum">    2831 </span><span class="lineCov">          1 :   mozStorageStatementScoper scoper(stmt);</span>
<span class="lineNum">    2832 </span>            : 
<span class="lineNum">    2833 </span><span class="lineCov">          1 :   nsresult rv = URIBinder::Bind(stmt, NS_LITERAL_CSTRING(&quot;page_url&quot;), aURI);</span>
<span class="lineNum">    2834 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2835 </span>            : 
<span class="lineNum">    2836 </span><span class="lineCov">          1 :   bool hasResults = false;</span>
<span class="lineNum">    2837 </span><span class="lineCov">          1 :   rv = stmt-&gt;ExecuteStep(&amp;hasResults);</span>
<span class="lineNum">    2838 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2839 </span>            : 
<span class="lineNum">    2840 </span><span class="lineCov">          1 :   if (!hasResults) {</span>
<span class="lineNum">    2841 </span><span class="lineCov">          1 :     aTitle.SetIsVoid(true);</span>
<span class="lineNum">    2842 </span><span class="lineCov">          1 :     return NS_OK; // Not found, return a void string.</span>
<span class="lineNum">    2843 </span>            :   }
<span class="lineNum">    2844 </span>            : 
<span class="lineNum">    2845 </span><span class="lineCov">          1 :   rv = stmt-&gt;GetString(2, aTitle);</span>
<span class="lineNum">    2846 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2847 </span>            : 
<span class="lineNum">    2848 </span>            :   return NS_OK;
<span class="lineNum">    2849 </span>            : }
<span class="lineNum">    2850 </span>            : 
<span class="lineNum">    2851 </span>            : 
<span class="lineNum">    2852 </span>            : ////////////////////////////////////////////////////////////////////////////////
<span class="lineNum">    2853 </span>            : //// mozIStorageVacuumParticipant
<a name="2854"><span class="lineNum">    2854 </span>            : </a>
<span class="lineNum">    2855 </span>            : NS_IMETHODIMP
<span class="lineNum">    2856 </span><span class="lineCov">          1 : nsNavHistory::GetDatabaseConnection(mozIStorageConnection** _DBConnection)</span>
<span class="lineNum">    2857 </span>            : {
<span class="lineNum">    2858 </span><span class="lineCov">          1 :   return GetDBConnection(_DBConnection);</span>
<span class="lineNum">    2859 </span>            : }
<span class="lineNum">    2860 </span>            : 
<a name="2861"><span class="lineNum">    2861 </span>            : </a>
<span class="lineNum">    2862 </span>            : NS_IMETHODIMP
<span class="lineNum">    2863 </span><span class="lineCov">          1 : nsNavHistory::GetExpectedDatabasePageSize(int32_t* _expectedPageSize)</span>
<span class="lineNum">    2864 </span>            : {
<span class="lineNum">    2865 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(mDB);</span>
<span class="lineNum">    2866 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(mDB-&gt;MainConn());</span>
<span class="lineNum">    2867 </span><span class="lineCov">          1 :   return mDB-&gt;MainConn()-&gt;GetDefaultPageSize(_expectedPageSize);</span>
<span class="lineNum">    2868 </span>            : }
<span class="lineNum">    2869 </span>            : 
<a name="2870"><span class="lineNum">    2870 </span>            : </a>
<span class="lineNum">    2871 </span>            : NS_IMETHODIMP
<span class="lineNum">    2872 </span><span class="lineCov">          1 : nsNavHistory::OnBeginVacuum(bool* _vacuumGranted)</span>
<span class="lineNum">    2873 </span>            : {
<span class="lineNum">    2874 </span>            :   // TODO: Check if we have to deny the vacuum in some heavy-load case.
<span class="lineNum">    2875 </span>            :   // We could maybe want to do that during batches?
<span class="lineNum">    2876 </span><span class="lineCov">          1 :   *_vacuumGranted = true;</span>
<span class="lineNum">    2877 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    2878 </span>            : }
<span class="lineNum">    2879 </span>            : 
<a name="2880"><span class="lineNum">    2880 </span>            : </a>
<span class="lineNum">    2881 </span>            : NS_IMETHODIMP
<span class="lineNum">    2882 </span><span class="lineCov">          1 : nsNavHistory::OnEndVacuum(bool aSucceeded)</span>
<span class="lineNum">    2883 </span>            : {
<span class="lineNum">    2884 </span>            :   NS_WARNING_ASSERTION(aSucceeded, &quot;Places.sqlite vacuum failed.&quot;);
<span class="lineNum">    2885 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    2886 </span>            : }
<span class="lineNum">    2887 </span>            : 
<span class="lineNum">    2888 </span>            : 
<span class="lineNum">    2889 </span>            : ////////////////////////////////////////////////////////////////////////////////
<span class="lineNum">    2890 </span>            : //// nsPIPlacesDatabase
<a name="2891"><span class="lineNum">    2891 </span>            : </a>
<span class="lineNum">    2892 </span>            : NS_IMETHODIMP
<span class="lineNum">    2893 </span><span class="lineCov">          1 : nsNavHistory::GetDBConnection(mozIStorageConnection **_DBConnection)</span>
<span class="lineNum">    2894 </span>            : {
<span class="lineNum">    2895 </span><span class="lineCov">          1 :   NS_ENSURE_ARG_POINTER(_DBConnection);</span>
<span class="lineNum">    2896 </span><span class="lineCov">          1 :   RefPtr&lt;mozIStorageConnection&gt; connection = mDB-&gt;MainConn();</span>
<span class="lineNum">    2897 </span>            :   connection.forget(_DBConnection);
<span class="lineNum">    2898 </span>            : 
<span class="lineNum">    2899 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    2900 </span>            : }
<a name="2901"><span class="lineNum">    2901 </span>            : </a>
<span class="lineNum">    2902 </span>            : NS_IMETHODIMP
<span class="lineNum">    2903 </span><span class="lineCov">          1 : nsNavHistory::GetShutdownClient(nsIAsyncShutdownClient **_shutdownClient)</span>
<span class="lineNum">    2904 </span>            : {
<span class="lineNum">    2905 </span><span class="lineCov">          1 :   NS_ENSURE_ARG_POINTER(_shutdownClient);</span>
<span class="lineNum">    2906 </span><span class="lineCov">          1 :   RefPtr&lt;nsIAsyncShutdownClient&gt; client = mDB-&gt;GetClientsShutdown();</span>
<span class="lineNum">    2907 </span>            :   MOZ_ASSERT(client);
<span class="lineNum">    2908 </span>            :   client.forget(_shutdownClient);
<span class="lineNum">    2909 </span>            : 
<span class="lineNum">    2910 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    2911 </span>            : }
<a name="2912"><span class="lineNum">    2912 </span>            : </a>
<span class="lineNum">    2913 </span>            : NS_IMETHODIMP
<span class="lineNum">    2914 </span><span class="lineCov">          1 : nsNavHistory::AsyncExecuteLegacyQueries(nsINavHistoryQuery** aQueries,</span>
<span class="lineNum">    2915 </span>            :                                         uint32_t aQueryCount,
<span class="lineNum">    2916 </span>            :                                         nsINavHistoryQueryOptions* aOptions,
<span class="lineNum">    2917 </span>            :                                         mozIStorageStatementCallback* aCallback,
<span class="lineNum">    2918 </span>            :                                         mozIStoragePendingStatement** _stmt)
<span class="lineNum">    2919 </span>            : {
<span class="lineNum">    2920 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    2921 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aQueries);</span>
<span class="lineNum">    2922 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aOptions);</span>
<span class="lineNum">    2923 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(aCallback);</span>
<span class="lineNum">    2924 </span><span class="lineCov">          1 :   NS_ENSURE_ARG_POINTER(_stmt);</span>
<span class="lineNum">    2925 </span>            : 
<span class="lineNum">    2926 </span>            :   nsCOMArray&lt;nsNavHistoryQuery&gt; queries;
<span class="lineNum">    2927 </span><span class="lineCov">          1 :   for (uint32_t i = 0; i &lt; aQueryCount; i ++) {</span>
<span class="lineNum">    2928 </span><span class="lineCov">          1 :     nsCOMPtr&lt;nsNavHistoryQuery&gt; query = do_QueryInterface(aQueries[i]);</span>
<span class="lineNum">    2929 </span><span class="lineCov">          1 :     NS_ENSURE_STATE(query);</span>
<span class="lineNum">    2930 </span><span class="lineCov">          1 :     queries.AppendElement(query.forget());</span>
<span class="lineNum">    2931 </span>            :   }
<span class="lineNum">    2932 </span><span class="lineCov">          1 :   NS_ENSURE_ARG_MIN(queries.Count(), 1);</span>
<span class="lineNum">    2933 </span>            : 
<span class="lineNum">    2934 </span><span class="lineCov">          1 :   nsCOMPtr&lt;nsNavHistoryQueryOptions&gt; options = do_QueryInterface(aOptions);</span>
<span class="lineNum">    2935 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(options);</span>
<span class="lineNum">    2936 </span>            : 
<span class="lineNum">    2937 </span>            :   nsCString queryString;
<span class="lineNum">    2938 </span><span class="lineCov">          1 :   bool paramsPresent = false;</span>
<span class="lineNum">    2939 </span>            :   nsNavHistory::StringHash addParams(HISTORY_DATE_CONT_LENGTH);
<span class="lineNum">    2940 </span>            :   nsresult rv = ConstructQueryString(queries, options, queryString,
<span class="lineNum">    2941 </span><span class="lineCov">          1 :                                      paramsPresent, addParams);</span>
<span class="lineNum">    2942 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv,rv);</span>
<span class="lineNum">    2943 </span>            : 
<span class="lineNum">    2944 </span>            :   nsCOMPtr&lt;mozIStorageAsyncStatement&gt; statement =
<span class="lineNum">    2945 </span><span class="lineCov">          1 :     mDB-&gt;GetAsyncStatement(queryString);</span>
<span class="lineNum">    2946 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(statement);</span>
<span class="lineNum">    2947 </span>            : 
<span class="lineNum">    2948 </span>            : #ifdef DEBUG
<span class="lineNum">    2949 </span>            :   if (NS_FAILED(rv)) {
<span class="lineNum">    2950 </span>            :     nsAutoCString lastErrorString;
<span class="lineNum">    2951 </span>            :     (void)mDB-&gt;MainConn()-&gt;GetLastErrorString(lastErrorString);
<span class="lineNum">    2952 </span>            :     int32_t lastError = 0;
<span class="lineNum">    2953 </span>            :     (void)mDB-&gt;MainConn()-&gt;GetLastError(&amp;lastError);
<span class="lineNum">    2954 </span>            :     printf(&quot;Places failed to create a statement from this query:\n%s\nStorage error (%d): %s\n&quot;,
<span class="lineNum">    2955 </span>            :            queryString.get(), lastError, lastErrorString.get());
<span class="lineNum">    2956 </span>            :   }
<span class="lineNum">    2957 </span>            : #endif
<span class="lineNum">    2958 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2959 </span>            : 
<span class="lineNum">    2960 </span><span class="lineCov">          1 :   if (paramsPresent) {</span>
<span class="lineNum">    2961 </span>            :     // bind parameters
<span class="lineNum">    2962 </span>            :     int32_t i;
<span class="lineNum">    2963 </span><span class="lineNoCov">          0 :     for (i = 0; i &lt; queries.Count(); i++) {</span>
<span class="lineNum">    2964 </span><span class="lineNoCov">          0 :       rv = BindQueryClauseParameters(statement, i, queries[i], options);</span>
<span class="lineNum">    2965 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2966 </span>            :     }
<span class="lineNum">    2967 </span>            :   }
<span class="lineNum">    2968 </span>            : 
<span class="lineNum">    2969 </span><span class="lineNoCov">          0 :   for (auto iter = addParams.Iter(); !iter.Done(); iter.Next()) {</span>
<span class="lineNum">    2970 </span><span class="lineNoCov">          0 :     nsresult rv = statement-&gt;BindUTF8StringByName(iter.Key(), iter.Data());</span>
<span class="lineNum">    2971 </span><span class="lineNoCov">          0 :     if (NS_FAILED(rv)) {</span>
<span class="lineNum">    2972 </span>            :       break;
<span class="lineNum">    2973 </span>            :     }
<span class="lineNum">    2974 </span>            :   }
<span class="lineNum">    2975 </span>            : 
<span class="lineNum">    2976 </span><span class="lineCov">          1 :   rv = statement-&gt;ExecuteAsync(aCallback, _stmt);</span>
<span class="lineNum">    2977 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    2978 </span>            : 
<span class="lineNum">    2979 </span>            :   return NS_OK;
<span class="lineNum">    2980 </span>            : }
<span class="lineNum">    2981 </span>            : 
<a name="2982"><span class="lineNum">    2982 </span>            : </a>
<span class="lineNum">    2983 </span>            : nsresult
<span class="lineNum">    2984 </span><span class="lineNoCov">          0 : nsNavHistory::NotifyOnPageExpired(nsIURI *aURI, PRTime aVisitTime,</span>
<span class="lineNum">    2985 </span>            :                                   bool aWholeEntry, const nsACString&amp; aGUID,
<span class="lineNum">    2986 </span>            :                                   uint16_t aReason, uint32_t aTransitionType)
<span class="lineNum">    2987 </span>            : {
<span class="lineNum">    2988 </span>            :   // Invalidate the cached value for whether there's history or not.
<span class="lineNum">    2989 </span><span class="lineNoCov">          0 :   mDaysOfHistory = -1;</span>
<span class="lineNum">    2990 </span>            : 
<span class="lineNum">    2991 </span>            :   MOZ_ASSERT(!aGUID.IsEmpty());
<span class="lineNum">    2992 </span><span class="lineNoCov">          0 :   if (aWholeEntry) {</span>
<span class="lineNum">    2993 </span>            :     // Notify our observers that the page has been removed.
<span class="lineNum">    2994 </span><span class="lineNoCov">          0 :     NOTIFY_OBSERVERS(mCanNotify, mCacheObservers, mObservers,</span>
<span class="lineNum">    2995 </span>            :                      nsINavHistoryObserver, OnDeleteURI(aURI, aGUID, aReason));
<span class="lineNum">    2996 </span>            :   }
<span class="lineNum">    2997 </span>            :   else {
<span class="lineNum">    2998 </span>            :     // Notify our observers that some visits for the page have been removed.
<span class="lineNum">    2999 </span><span class="lineNoCov">          0 :     NOTIFY_OBSERVERS(mCanNotify, mCacheObservers, mObservers,</span>
<span class="lineNum">    3000 </span>            :                      nsINavHistoryObserver,
<span class="lineNum">    3001 </span>            :                      OnDeleteVisits(aURI, aVisitTime, aGUID, aReason,
<span class="lineNum">    3002 </span>            :                                     aTransitionType));
<span class="lineNum">    3003 </span>            :   }
<span class="lineNum">    3004 </span>            : 
<span class="lineNum">    3005 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    3006 </span>            : }
<span class="lineNum">    3007 </span>            : 
<span class="lineNum">    3008 </span>            : ////////////////////////////////////////////////////////////////////////////////
<span class="lineNum">    3009 </span>            : //// nsIObserver
<a name="3010"><span class="lineNum">    3010 </span>            : </a>
<span class="lineNum">    3011 </span>            : NS_IMETHODIMP
<span class="lineNum">    3012 </span><span class="lineCov">          1 : nsNavHistory::Observe(nsISupports *aSubject, const char *aTopic,</span>
<span class="lineNum">    3013 </span>            :                     const char16_t *aData)
<span class="lineNum">    3014 </span>            : {
<span class="lineNum">    3015 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    3016 </span><span class="lineCov">          1 :   if (strcmp(aTopic, TOPIC_PROFILE_TEARDOWN) == 0 ||</span>
<span class="lineNum">    3017 </span><span class="lineCov">          1 :       strcmp(aTopic, TOPIC_PROFILE_CHANGE) == 0 ||</span>
<span class="lineNum">    3018 </span><span class="lineCov">          1 :       strcmp(aTopic, TOPIC_SIMULATE_PLACES_SHUTDOWN) == 0) {</span>
<span class="lineNum">    3019 </span>            :     // These notifications are used by tests to simulate a Places shutdown.
<span class="lineNum">    3020 </span>            :     // They should just be forwarded to the Database handle.
<span class="lineNum">    3021 </span><span class="lineNoCov">          0 :     mDB-&gt;Observe(aSubject, aTopic, aData);</span>
<span class="lineNum">    3022 </span>            :   }
<span class="lineNum">    3023 </span>            : 
<span class="lineNum">    3024 </span><span class="lineCov">          1 :   else if (strcmp(aTopic, TOPIC_PLACES_CONNECTION_CLOSED) == 0) {</span>
<span class="lineNum">    3025 </span>            :     // Don't even try to notify observers from this point on, the category
<span class="lineNum">    3026 </span>            :     // cache would init services that could try to use our APIs.
<span class="lineNum">    3027 </span><span class="lineCov">          1 :     mCanNotify = false;</span>
<span class="lineNum">    3028 </span><span class="lineCov">          1 :     mObservers.Clear();</span>
<span class="lineNum">    3029 </span>            :   }
<span class="lineNum">    3030 </span>            : 
<span class="lineNum">    3031 </span>            : #ifdef MOZ_XUL
<span class="lineNum">    3032 </span><span class="lineCov">          1 :   else if (strcmp(aTopic, TOPIC_AUTOCOMPLETE_FEEDBACK_INCOMING) == 0) {</span>
<span class="lineNum">    3033 </span><span class="lineCov">          1 :     nsCOMPtr&lt;nsIAutoCompleteInput&gt; input = do_QueryInterface(aSubject);</span>
<span class="lineNum">    3034 </span><span class="lineCov">          1 :     if (!input)</span>
<span class="lineNum">    3035 </span>            :       return NS_OK;
<span class="lineNum">    3036 </span>            : 
<span class="lineNum">    3037 </span>            :     // If the source is a private window, don't add any input history.
<span class="lineNum">    3038 </span>            :     bool isPrivate;
<span class="lineNum">    3039 </span><span class="lineCov">          1 :     nsresult rv = input-&gt;GetInPrivateContext(&amp;isPrivate);</span>
<span class="lineNum">    3040 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3041 </span><span class="lineCov">          1 :     if (isPrivate)</span>
<span class="lineNum">    3042 </span>            :       return NS_OK;
<span class="lineNum">    3043 </span>            : 
<span class="lineNum">    3044 </span>            :     nsCOMPtr&lt;nsIAutoCompletePopup&gt; popup;
<span class="lineNum">    3045 </span><span class="lineCov">          1 :     input-&gt;GetPopup(getter_AddRefs(popup));</span>
<span class="lineNum">    3046 </span><span class="lineCov">          1 :     if (!popup)</span>
<span class="lineNum">    3047 </span>            :       return NS_OK;
<span class="lineNum">    3048 </span>            : 
<span class="lineNum">    3049 </span>            :     nsCOMPtr&lt;nsIAutoCompleteController&gt; controller;
<span class="lineNum">    3050 </span><span class="lineCov">          1 :     input-&gt;GetController(getter_AddRefs(controller));</span>
<span class="lineNum">    3051 </span><span class="lineCov">          1 :     if (!controller)</span>
<span class="lineNum">    3052 </span>            :       return NS_OK;
<span class="lineNum">    3053 </span>            : 
<span class="lineNum">    3054 </span>            :     // Don't bother if the popup is closed
<span class="lineNum">    3055 </span>            :     bool open;
<span class="lineNum">    3056 </span><span class="lineCov">          1 :     rv = popup-&gt;GetPopupOpen(&amp;open);</span>
<span class="lineNum">    3057 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3058 </span><span class="lineCov">          1 :     if (!open)</span>
<span class="lineNum">    3059 </span>            :       return NS_OK;
<span class="lineNum">    3060 </span>            : 
<span class="lineNum">    3061 </span>            :     // Ignore if nothing selected from the popup
<span class="lineNum">    3062 </span>            :     int32_t selectedIndex;
<span class="lineNum">    3063 </span><span class="lineCov">          1 :     rv = popup-&gt;GetSelectedIndex(&amp;selectedIndex);</span>
<span class="lineNum">    3064 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3065 </span><span class="lineCov">          1 :     if (selectedIndex == -1)</span>
<span class="lineNum">    3066 </span>            :       return NS_OK;
<span class="lineNum">    3067 </span>            : 
<span class="lineNum">    3068 </span><span class="lineCov">          1 :     rv = AutoCompleteFeedback(selectedIndex, controller);</span>
<span class="lineNum">    3069 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3070 </span>            :   }
<span class="lineNum">    3071 </span>            : 
<span class="lineNum">    3072 </span>            : #endif
<span class="lineNum">    3073 </span><span class="lineCov">          1 :   else if (strcmp(aTopic, TOPIC_PREF_CHANGED) == 0) {</span>
<span class="lineNum">    3074 </span><span class="lineCov">          1 :     LoadPrefs();</span>
<span class="lineNum">    3075 </span>            :   }
<span class="lineNum">    3076 </span>            : 
<span class="lineNum">    3077 </span><span class="lineCov">          1 :   else if (strcmp(aTopic, TOPIC_IDLE_DAILY) == 0) {</span>
<span class="lineNum">    3078 </span><span class="lineCov">          1 :     (void)DecayFrecency();</span>
<span class="lineNum">    3079 </span>            :   }
<span class="lineNum">    3080 </span>            : 
<span class="lineNum">    3081 </span>            :   return NS_OK;
<span class="lineNum">    3082 </span>            : }
<span class="lineNum">    3083 </span>            : 
<span class="lineNum">    3084 </span>            : 
<a name="3085"><span class="lineNum">    3085 </span>            : namespace {</a>
<span class="lineNum">    3086 </span>            : 
<span class="lineNum">    3087 </span><span class="lineCov">          1 : class DecayFrecencyCallback : public AsyncStatementTelemetryTimer</span>
<a name="3088"><span class="lineNum">    3088 </span>            : {</a>
<span class="lineNum">    3089 </span>            : public:
<span class="lineNum">    3090 </span><span class="lineCov">          1 :   DecayFrecencyCallback()</span>
<span class="lineNum">    3091 </span><span class="lineCov">          1 :     : AsyncStatementTelemetryTimer(Telemetry::PLACES_IDLE_FRECENCY_DECAY_TIME_MS)</span>
<span class="lineNum">    3092 </span>            :   {
<a name="3093"><span class="lineNum">    3093 </span><span class="lineCov">          1 :   }</span></a>
<span class="lineNum">    3094 </span>            : 
<span class="lineNum">    3095 </span><span class="lineCov">          1 :   NS_IMETHOD HandleCompletion(uint16_t aReason)</span>
<span class="lineNum">    3096 </span>            :   {
<span class="lineNum">    3097 </span><span class="lineCov">          1 :     (void)AsyncStatementTelemetryTimer::HandleCompletion(aReason);</span>
<span class="lineNum">    3098 </span><span class="lineCov">          1 :     if (aReason == REASON_FINISHED) {</span>
<span class="lineNum">    3099 </span><span class="lineCov">          1 :       nsNavHistory *navHistory = nsNavHistory::GetHistoryService();</span>
<span class="lineNum">    3100 </span><span class="lineCov">          1 :       NS_ENSURE_STATE(navHistory);</span>
<span class="lineNum">    3101 </span><span class="lineCov">          1 :       navHistory-&gt;NotifyManyFrecenciesChanged();</span>
<span class="lineNum">    3102 </span>            :     }
<span class="lineNum">    3103 </span>            :     return NS_OK;
<span class="lineNum">    3104 </span>            :   }
<span class="lineNum">    3105 </span>            : };
<span class="lineNum">    3106 </span>            : 
<span class="lineNum">    3107 </span>            : } // namespace
<a name="3108"><span class="lineNum">    3108 </span>            : </a>
<span class="lineNum">    3109 </span>            : nsresult
<span class="lineNum">    3110 </span><span class="lineCov">          1 : nsNavHistory::DecayFrecency()</span>
<span class="lineNum">    3111 </span>            : {
<span class="lineNum">    3112 </span><span class="lineCov">          1 :   nsresult rv = FixInvalidFrecencies();</span>
<span class="lineNum">    3113 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3114 </span>            : 
<span class="lineNum">    3115 </span><span class="lineCov">          1 :   float decayRate = Preferences::GetFloat(PREF_FREC_DECAY_RATE, PREF_FREC_DECAY_RATE_DEF);</span>
<span class="lineNum">    3116 </span>            : 
<span class="lineNum">    3117 </span>            :   // Globally decay places frecency rankings to estimate reduced frecency
<span class="lineNum">    3118 </span>            :   // values of pages that haven't been visited for a while, i.e., they do
<span class="lineNum">    3119 </span>            :   // not get an updated frecency.  A scaling factor of .975 results in .5 the
<span class="lineNum">    3120 </span>            :   // original value after 28 days.
<span class="lineNum">    3121 </span>            :   // When changing the scaling factor, ensure that the barrier in
<span class="lineNum">    3122 </span>            :   // moz_places_afterupdate_frecency_trigger still ignores these changes.
<span class="lineNum">    3123 </span>            :   nsCOMPtr&lt;mozIStorageAsyncStatement&gt; decayFrecency = mDB-&gt;GetAsyncStatement(
<span class="lineNum">    3124 </span>            :     &quot;UPDATE moz_places SET frecency = ROUND(frecency * :decay_rate) &quot;
<span class="lineNum">    3125 </span>            :     &quot;WHERE frecency &gt; 0&quot;
<span class="lineNum">    3126 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    3127 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(decayFrecency);</span>
<span class="lineNum">    3128 </span>            : 
<span class="lineNum">    3129 </span>            :   rv = decayFrecency-&gt;BindDoubleByName(NS_LITERAL_CSTRING(&quot;decay_rate&quot;),
<span class="lineNum">    3130 </span><span class="lineCov">          1 :                                        static_cast&lt;double&gt;(decayRate));</span>
<span class="lineNum">    3131 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3132 </span>            : 
<span class="lineNum">    3133 </span>            :   // Decay potentially unused adaptive entries (e.g. those that are at 1)
<span class="lineNum">    3134 </span>            :   // to allow better chances for new entries that will start at 1.
<span class="lineNum">    3135 </span>            :   nsCOMPtr&lt;mozIStorageAsyncStatement&gt; decayAdaptive = mDB-&gt;GetAsyncStatement(
<span class="lineNum">    3136 </span>            :     &quot;UPDATE moz_inputhistory SET use_count = use_count * .975&quot;
<span class="lineNum">    3137 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    3138 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(decayAdaptive);</span>
<span class="lineNum">    3139 </span>            : 
<span class="lineNum">    3140 </span>            :   // Delete any adaptive entries that won't help in ordering anymore.
<span class="lineNum">    3141 </span>            :   nsCOMPtr&lt;mozIStorageAsyncStatement&gt; deleteAdaptive = mDB-&gt;GetAsyncStatement(
<span class="lineNum">    3142 </span>            :     &quot;DELETE FROM moz_inputhistory WHERE use_count &lt; .01&quot;
<span class="lineNum">    3143 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    3144 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(deleteAdaptive);</span>
<span class="lineNum">    3145 </span>            : 
<span class="lineNum">    3146 </span>            :   mozIStorageBaseStatement *stmts[] = {
<span class="lineNum">    3147 </span>            :     decayFrecency.get(),
<span class="lineNum">    3148 </span>            :     decayAdaptive.get(),
<span class="lineNum">    3149 </span>            :     deleteAdaptive.get()
<span class="lineNum">    3150 </span><span class="lineCov">          1 :   };</span>
<span class="lineNum">    3151 </span>            :   nsCOMPtr&lt;mozIStoragePendingStatement&gt; ps;
<span class="lineNum">    3152 </span><span class="lineCov">          1 :   RefPtr&lt;DecayFrecencyCallback&gt; cb = new DecayFrecencyCallback();</span>
<span class="lineNum">    3153 </span><span class="lineCov">          1 :   rv = mDB-&gt;MainConn()-&gt;ExecuteAsync(stmts, ArrayLength(stmts), cb,</span>
<span class="lineNum">    3154 </span><span class="lineCov">          1 :                                      getter_AddRefs(ps));</span>
<span class="lineNum">    3155 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3156 </span>            : 
<span class="lineNum">    3157 </span>            :   return NS_OK;
<span class="lineNum">    3158 </span>            : }
<span class="lineNum">    3159 </span>            : 
<span class="lineNum">    3160 </span>            : 
<span class="lineNum">    3161 </span>            : // Query stuff *****************************************************************
<span class="lineNum">    3162 </span>            : 
<span class="lineNum">    3163 </span>            : // Helper class for QueryToSelectClause
<span class="lineNum">    3164 </span>            : //
<span class="lineNum">    3165 </span>            : // This class helps to build part of the WHERE clause. It supports
<span class="lineNum">    3166 </span>            : // multiple queries by appending the query index to the parameter name.
<span class="lineNum">    3167 </span>            : // For the query with index 0 the parameter name is not altered what
<span class="lineNum">    3168 </span>            : // allows using this parameter in other situations (see SelectAsSite).
<span class="lineNum">    3169 </span>            : 
<span class="lineNum">    3170 </span><span class="lineCov">          1 : class ConditionBuilder</span>
<span class="lineNum">    3171 </span>            : {
<span class="lineNum">    3172 </span>            : public:
<span class="lineNum">    3173 </span>            : 
<span class="lineNum">    3174 </span><span class="lineCov">          1 :   explicit ConditionBuilder(int32_t aQueryIndex): mQueryIndex(aQueryIndex)</span>
<a name="3175"><span class="lineNum">    3175 </span>            :   { }</a>
<span class="lineNum">    3176 </span>            : 
<span class="lineNum">    3177 </span><span class="lineCov">          1 :   ConditionBuilder&amp; Condition(const char* aStr)</span>
<span class="lineNum">    3178 </span>            :   {
<span class="lineNum">    3179 </span><span class="lineCov">          1 :     if (!mClause.IsEmpty())</span>
<span class="lineNum">    3180 </span><span class="lineCov">          1 :       mClause.AppendLiteral(&quot; AND &quot;);</span>
<span class="lineNum">    3181 </span><span class="lineCov">          1 :     Str(aStr);</span>
<span class="lineNum">    3182 </span><span class="lineCov">          1 :     return *this;</span>
<a name="3183"><span class="lineNum">    3183 </span>            :   }</a>
<span class="lineNum">    3184 </span>            : 
<span class="lineNum">    3185 </span><span class="lineCov">          1 :   ConditionBuilder&amp; Str(const char* aStr)</span>
<span class="lineNum">    3186 </span>            :   {
<span class="lineNum">    3187 </span><span class="lineCov">          1 :     mClause.Append(' ');</span>
<span class="lineNum">    3188 </span><span class="lineCov">          1 :     mClause.Append(aStr);</span>
<span class="lineNum">    3189 </span><span class="lineCov">          1 :     mClause.Append(' ');</span>
<span class="lineNum">    3190 </span><span class="lineCov">          1 :     return *this;</span>
<a name="3191"><span class="lineNum">    3191 </span>            :   }</a>
<span class="lineNum">    3192 </span>            : 
<span class="lineNum">    3193 </span><span class="lineCov">          1 :   ConditionBuilder&amp; Param(const char* aParam)</span>
<span class="lineNum">    3194 </span>            :   {
<span class="lineNum">    3195 </span><span class="lineCov">          1 :     mClause.Append(' ');</span>
<span class="lineNum">    3196 </span><span class="lineCov">          1 :     if (!mQueryIndex)</span>
<span class="lineNum">    3197 </span><span class="lineCov">          1 :       mClause.Append(aParam);</span>
<span class="lineNum">    3198 </span>            :     else
<span class="lineNum">    3199 </span><span class="lineCov">          1 :       mClause += nsPrintfCString(&quot;%s%d&quot;, aParam, mQueryIndex);</span>
<span class="lineNum">    3200 </span>            : 
<span class="lineNum">    3201 </span><span class="lineCov">          1 :     mClause.Append(' ');</span>
<span class="lineNum">    3202 </span><span class="lineCov">          1 :     return *this;</span>
<span class="lineNum">    3203 </span>            :   }
<span class="lineNum">    3204 </span>            : 
<span class="lineNum">    3205 </span>            :   void GetClauseString(nsCString&amp; aResult)
<span class="lineNum">    3206 </span>            :   {
<span class="lineNum">    3207 </span><span class="lineCov">          1 :     aResult = mClause;</span>
<span class="lineNum">    3208 </span>            :   }
<span class="lineNum">    3209 </span>            : 
<span class="lineNum">    3210 </span>            : private:
<span class="lineNum">    3211 </span>            : 
<span class="lineNum">    3212 </span>            :   int32_t mQueryIndex;
<span class="lineNum">    3213 </span>            :   nsCString mClause;
<span class="lineNum">    3214 </span>            : };
<span class="lineNum">    3215 </span>            : 
<span class="lineNum">    3216 </span>            : 
<span class="lineNum">    3217 </span>            : // nsNavHistory::QueryToSelectClause
<span class="lineNum">    3218 </span>            : //
<span class="lineNum">    3219 </span>            : //    THE BEHAVIOR SHOULD BE IN SYNC WITH BindQueryClauseParameters
<span class="lineNum">    3220 </span>            : //
<span class="lineNum">    3221 </span>            : //    I don't check return values from the query object getters because there's
<span class="lineNum">    3222 </span>            : //    no way for those to fail.
<a name="3223"><span class="lineNum">    3223 </span>            : </a>
<span class="lineNum">    3224 </span>            : nsresult
<span class="lineNum">    3225 </span><span class="lineCov">          1 : nsNavHistory::QueryToSelectClause(nsNavHistoryQuery* aQuery, // const</span>
<span class="lineNum">    3226 </span>            :                                   nsNavHistoryQueryOptions* aOptions,
<span class="lineNum">    3227 </span>            :                                   int32_t aQueryIndex,
<span class="lineNum">    3228 </span>            :                                   nsCString* aClause)
<span class="lineNum">    3229 </span>            : {
<span class="lineNum">    3230 </span>            :   bool hasIt;
<span class="lineNum">    3231 </span><span class="lineCov">          1 :   bool excludeQueries = aOptions-&gt;ExcludeQueries();</span>
<span class="lineNum">    3232 </span>            : 
<span class="lineNum">    3233 </span>            :   ConditionBuilder clause(aQueryIndex);
<span class="lineNum">    3234 </span>            : 
<span class="lineNum">    3235 </span><span class="lineCov">          1 :   if ((NS_SUCCEEDED(aQuery-&gt;GetHasBeginTime(&amp;hasIt)) &amp;&amp; hasIt) ||</span>
<span class="lineNum">    3236 </span><span class="lineCov">          1 :     (NS_SUCCEEDED(aQuery-&gt;GetHasEndTime(&amp;hasIt)) &amp;&amp; hasIt)) {</span>
<span class="lineNum">    3237 </span>            :     clause.Condition(&quot;EXISTS (SELECT 1 FROM moz_historyvisits &quot;
<span class="lineNum">    3238 </span><span class="lineCov">          1 :                               &quot;WHERE place_id = h.id&quot;);</span>
<span class="lineNum">    3239 </span>            :     // begin time
<span class="lineNum">    3240 </span><span class="lineCov">          1 :     if (NS_SUCCEEDED(aQuery-&gt;GetHasBeginTime(&amp;hasIt)) &amp;&amp; hasIt)</span>
<span class="lineNum">    3241 </span><span class="lineCov">          1 :       clause.Condition(&quot;visit_date &gt;=&quot;).Param(&quot;:begin_time&quot;);</span>
<span class="lineNum">    3242 </span>            :     // end time
<span class="lineNum">    3243 </span><span class="lineCov">          1 :     if (NS_SUCCEEDED(aQuery-&gt;GetHasEndTime(&amp;hasIt)) &amp;&amp; hasIt)</span>
<span class="lineNum">    3244 </span><span class="lineCov">          1 :       clause.Condition(&quot;visit_date &lt;=&quot;).Param(&quot;:end_time&quot;);</span>
<span class="lineNum">    3245 </span><span class="lineCov">          1 :     clause.Str(&quot; LIMIT 1)&quot;);</span>
<span class="lineNum">    3246 </span>            :   }
<span class="lineNum">    3247 </span>            : 
<span class="lineNum">    3248 </span>            :   // search terms
<span class="lineNum">    3249 </span>            :   bool hasSearchTerms;
<span class="lineNum">    3250 </span>            :   int32_t searchBehavior = mozIPlacesAutoComplete::BEHAVIOR_HISTORY |
<span class="lineNum">    3251 </span><span class="lineCov">          1 :                            mozIPlacesAutoComplete::BEHAVIOR_BOOKMARK;</span>
<span class="lineNum">    3252 </span><span class="lineCov">          1 :   if (NS_SUCCEEDED(aQuery-&gt;GetHasSearchTerms(&amp;hasSearchTerms)) &amp;&amp; hasSearchTerms) {</span>
<span class="lineNum">    3253 </span>            :     // Re-use the autocomplete_match function.  Setting the behavior to match
<span class="lineNum">    3254 </span>            :     // history or typed history or bookmarks or open pages will match almost
<span class="lineNum">    3255 </span>            :     // everything.
<span class="lineNum">    3256 </span><span class="lineCov">          1 :     clause.Condition(&quot;AUTOCOMPLETE_MATCH(&quot;).Param(&quot;:search_string&quot;)</span>
<span class="lineNum">    3257 </span><span class="lineCov">          1 :           .Str(&quot;, h.url, page_title, tags, &quot;)</span>
<span class="lineNum">    3258 </span>            :           .Str(nsPrintfCString(&quot;1, 1, 1, 1, %d, %d)&quot;,
<span class="lineNum">    3259 </span>            :                                mozIPlacesAutoComplete::MATCH_ANYWHERE_UNMODIFIED,
<span class="lineNum">    3260 </span><span class="lineCov">          1 :                                searchBehavior).get());</span>
<span class="lineNum">    3261 </span>            :     // Serching by terms implicitly exclude queries.
<span class="lineNum">    3262 </span><span class="lineCov">          1 :     excludeQueries = true;</span>
<span class="lineNum">    3263 </span>            :   }
<span class="lineNum">    3264 </span>            : 
<span class="lineNum">    3265 </span>            :   // min and max visit count
<span class="lineNum">    3266 </span><span class="lineCov">          1 :   if (aQuery-&gt;MinVisits() &gt;= 0)</span>
<span class="lineNum">    3267 </span><span class="lineNoCov">          0 :     clause.Condition(&quot;h.visit_count &gt;=&quot;).Param(&quot;:min_visits&quot;);</span>
<span class="lineNum">    3268 </span>            : 
<span class="lineNum">    3269 </span><span class="lineCov">          1 :   if (aQuery-&gt;MaxVisits() &gt;= 0)</span>
<span class="lineNum">    3270 </span><span class="lineNoCov">          0 :     clause.Condition(&quot;h.visit_count &lt;=&quot;).Param(&quot;:max_visits&quot;);</span>
<span class="lineNum">    3271 </span>            : 
<span class="lineNum">    3272 </span>            :   // only bookmarked, has no affect on bookmarks-only queries
<span class="lineNum">    3273 </span><span class="lineCov">          1 :   if (aOptions-&gt;QueryType() != nsINavHistoryQueryOptions::QUERY_TYPE_BOOKMARKS &amp;&amp;</span>
<span class="lineNum">    3274 </span><span class="lineCov">          1 :       aQuery-&gt;OnlyBookmarked())</span>
<span class="lineNum">    3275 </span><span class="lineNoCov">          0 :     clause.Condition(&quot;EXISTS (SELECT b.fk FROM moz_bookmarks b WHERE b.type = &quot;)</span>
<span class="lineNum">    3276 </span><span class="lineNoCov">          0 :           .Str(nsPrintfCString(&quot;%d&quot;, nsNavBookmarks::TYPE_BOOKMARK).get())</span>
<span class="lineNum">    3277 </span><span class="lineNoCov">          0 :           .Str(&quot;AND b.fk = h.id)&quot;);</span>
<span class="lineNum">    3278 </span>            : 
<span class="lineNum">    3279 </span>            :   // domain
<span class="lineNum">    3280 </span><span class="lineCov">          1 :   if (NS_SUCCEEDED(aQuery-&gt;GetHasDomain(&amp;hasIt)) &amp;&amp; hasIt) {</span>
<span class="lineNum">    3281 </span><span class="lineCov">          1 :     bool domainIsHost = false;</span>
<span class="lineNum">    3282 </span>            :     aQuery-&gt;GetDomainIsHost(&amp;domainIsHost);
<span class="lineNum">    3283 </span><span class="lineCov">          1 :     if (domainIsHost)</span>
<span class="lineNum">    3284 </span><span class="lineCov">          1 :       clause.Condition(&quot;h.rev_host =&quot;).Param(&quot;:domain_lower&quot;);</span>
<span class="lineNum">    3285 </span>            :     else
<span class="lineNum">    3286 </span>            :       // see domain setting in BindQueryClauseParameters for why we do this
<span class="lineNum">    3287 </span><span class="lineCov">          1 :       clause.Condition(&quot;h.rev_host &gt;=&quot;).Param(&quot;:domain_lower&quot;)</span>
<span class="lineNum">    3288 </span><span class="lineCov">          1 :             .Condition(&quot;h.rev_host &lt;&quot;).Param(&quot;:domain_upper&quot;);</span>
<span class="lineNum">    3289 </span>            :   }
<span class="lineNum">    3290 </span>            : 
<span class="lineNum">    3291 </span>            :   // URI
<span class="lineNum">    3292 </span><span class="lineCov">          1 :   if (NS_SUCCEEDED(aQuery-&gt;GetHasUri(&amp;hasIt)) &amp;&amp; hasIt) {</span>
<span class="lineNum">    3293 </span><span class="lineCov">          1 :     clause.Condition(&quot;h.url_hash = hash(&quot;).Param(&quot;:uri&quot;).Str(&quot;)&quot;)</span>
<span class="lineNum">    3294 </span><span class="lineCov">          1 :           .Condition(&quot;h.url =&quot;).Param(&quot;:uri&quot;);</span>
<span class="lineNum">    3295 </span>            :   }
<span class="lineNum">    3296 </span>            : 
<span class="lineNum">    3297 </span>            :   // annotation
<span class="lineNum">    3298 </span>            :   aQuery-&gt;GetHasAnnotation(&amp;hasIt);
<span class="lineNum">    3299 </span><span class="lineCov">          1 :   if (hasIt) {</span>
<span class="lineNum">    3300 </span><span class="lineNoCov">          0 :     clause.Condition(&quot;&quot;);</span>
<span class="lineNum">    3301 </span><span class="lineNoCov">          0 :     if (aQuery-&gt;AnnotationIsNot())</span>
<span class="lineNum">    3302 </span><span class="lineNoCov">          0 :       clause.Str(&quot;NOT&quot;);</span>
<span class="lineNum">    3303 </span>            :     clause.Str(
<span class="lineNum">    3304 </span>            :       &quot;EXISTS &quot;
<span class="lineNum">    3305 </span>            :         &quot;(SELECT h.id &quot;
<span class="lineNum">    3306 </span>            :          &quot;FROM moz_annos anno &quot;
<span class="lineNum">    3307 </span>            :          &quot;JOIN moz_anno_attributes annoname &quot;
<span class="lineNum">    3308 </span>            :            &quot;ON anno.anno_attribute_id = annoname.id &quot;
<span class="lineNum">    3309 </span>            :          &quot;WHERE anno.place_id = h.id &quot;
<span class="lineNum">    3310 </span><span class="lineNoCov">          0 :            &quot;AND annoname.name = &quot;).Param(&quot;:anno&quot;).Str(&quot;)&quot;);</span>
<span class="lineNum">    3311 </span>            :     // annotation-based queries don't get the common conditions, so you get
<span class="lineNum">    3312 </span>            :     // all URLs with that annotation
<span class="lineNum">    3313 </span>            :   }
<span class="lineNum">    3314 </span>            : 
<span class="lineNum">    3315 </span>            :   // tags
<span class="lineNum">    3316 </span><span class="lineCov">          1 :   const nsTArray&lt;nsString&gt; &amp;tags = aQuery-&gt;Tags();</span>
<span class="lineNum">    3317 </span><span class="lineCov">          1 :   if (tags.Length() &gt; 0) {</span>
<span class="lineNum">    3318 </span><span class="lineCov">          1 :     clause.Condition(&quot;h.id&quot;);</span>
<span class="lineNum">    3319 </span><span class="lineCov">          1 :     if (aQuery-&gt;TagsAreNot())</span>
<span class="lineNum">    3320 </span><span class="lineNoCov">          0 :       clause.Str(&quot;NOT&quot;);</span>
<span class="lineNum">    3321 </span>            :     clause.Str(
<span class="lineNum">    3322 </span>            :       &quot;IN &quot;
<span class="lineNum">    3323 </span>            :         &quot;(SELECT bms.fk &quot;
<span class="lineNum">    3324 </span>            :          &quot;FROM moz_bookmarks bms &quot;
<span class="lineNum">    3325 </span>            :          &quot;JOIN moz_bookmarks tags ON bms.parent = tags.id &quot;
<span class="lineNum">    3326 </span><span class="lineCov">          1 :          &quot;WHERE tags.parent =&quot;).</span>
<span class="lineNum">    3327 </span><span class="lineCov">          1 :            Param(&quot;:tags_folder&quot;).</span>
<span class="lineNum">    3328 </span><span class="lineCov">          1 :            Str(&quot;AND tags.title IN (&quot;);</span>
<span class="lineNum">    3329 </span><span class="lineCov">          1 :     for (uint32_t i = 0; i &lt; tags.Length(); ++i) {</span>
<span class="lineNum">    3330 </span><span class="lineCov">          1 :       nsPrintfCString param(&quot;:tag%d_&quot;, i);</span>
<span class="lineNum">    3331 </span><span class="lineCov">          1 :       clause.Param(param.get());</span>
<span class="lineNum">    3332 </span><span class="lineCov">          1 :       if (i &lt; tags.Length() - 1)</span>
<span class="lineNum">    3333 </span><span class="lineCov">          1 :         clause.Str(&quot;,&quot;);</span>
<span class="lineNum">    3334 </span>            :     }
<span class="lineNum">    3335 </span><span class="lineCov">          1 :     clause.Str(&quot;)&quot;);</span>
<span class="lineNum">    3336 </span><span class="lineCov">          1 :     if (!aQuery-&gt;TagsAreNot())</span>
<span class="lineNum">    3337 </span><span class="lineCov">          1 :       clause.Str(&quot;GROUP BY bms.fk HAVING count(*) &gt;=&quot;).Param(&quot;:tag_count&quot;);</span>
<span class="lineNum">    3338 </span><span class="lineCov">          1 :     clause.Str(&quot;)&quot;);</span>
<span class="lineNum">    3339 </span>            :   }
<span class="lineNum">    3340 </span>            : 
<span class="lineNum">    3341 </span>            :   // transitions
<span class="lineNum">    3342 </span>            :   const nsTArray&lt;uint32_t&gt;&amp; transitions = aQuery-&gt;Transitions();
<span class="lineNum">    3343 </span><span class="lineCov">          1 :   for (uint32_t i = 0; i &lt; transitions.Length(); ++i) {</span>
<span class="lineNum">    3344 </span><span class="lineCov">          1 :     nsPrintfCString param(&quot;:transition%d_&quot;, i);</span>
<span class="lineNum">    3345 </span>            :     clause.Condition(&quot;h.id IN (SELECT place_id FROM moz_historyvisits &quot;
<span class="lineNum">    3346 </span><span class="lineCov">          1 :                              &quot;WHERE visit_type = &quot;)</span>
<span class="lineNum">    3347 </span><span class="lineCov">          1 :           .Param(param.get())</span>
<span class="lineNum">    3348 </span><span class="lineCov">          1 :           .Str(&quot;)&quot;);</span>
<span class="lineNum">    3349 </span>            :   }
<span class="lineNum">    3350 </span>            : 
<span class="lineNum">    3351 </span>            :   // folders
<span class="lineNum">    3352 </span><span class="lineCov">          1 :   const nsTArray&lt;int64_t&gt;&amp; folders = aQuery-&gt;Folders();</span>
<span class="lineNum">    3353 </span><span class="lineCov">          1 :   if (folders.Length() &gt; 0) {</span>
<span class="lineNum">    3354 </span><span class="lineCov">          1 :     aOptions-&gt;SetQueryType(nsNavHistoryQueryOptions::QUERY_TYPE_BOOKMARKS);</span>
<span class="lineNum">    3355 </span>            : 
<span class="lineNum">    3356 </span>            :     nsTArray&lt;int64_t&gt; includeFolders;
<span class="lineNum">    3357 </span><span class="lineCov">          1 :     includeFolders.AppendElements(folders);</span>
<span class="lineNum">    3358 </span>            : 
<span class="lineNum">    3359 </span><span class="lineCov">          1 :     nsNavBookmarks* bookmarks = nsNavBookmarks::GetBookmarksService();</span>
<span class="lineNum">    3360 </span><span class="lineCov">          1 :     NS_ENSURE_STATE(bookmarks);</span>
<span class="lineNum">    3361 </span>            : 
<span class="lineNum">    3362 </span><span class="lineCov">          1 :     for (nsTArray&lt;int64_t&gt;::size_type i = 0; i &lt; folders.Length(); ++i) {</span>
<span class="lineNum">    3363 </span>            :       nsTArray&lt;int64_t&gt; subFolders;
<span class="lineNum">    3364 </span><span class="lineCov">          1 :       if (NS_FAILED(bookmarks-&gt;GetDescendantFolders(folders[i], subFolders)))</span>
<span class="lineNum">    3365 </span>            :         continue;
<span class="lineNum">    3366 </span><span class="lineCov">          1 :       includeFolders.AppendElements(subFolders);</span>
<span class="lineNum">    3367 </span>            :     }
<span class="lineNum">    3368 </span>            : 
<span class="lineNum">    3369 </span><span class="lineCov">          1 :     clause.Condition(&quot;b.parent IN(&quot;);</span>
<span class="lineNum">    3370 </span><span class="lineCov">          1 :     for (nsTArray&lt;int64_t&gt;::size_type i = 0; i &lt; includeFolders.Length(); ++i) {</span>
<span class="lineNum">    3371 </span><span class="lineCov">          1 :       clause.Str(nsPrintfCString(&quot;%&quot; PRId64, includeFolders[i]).get());</span>
<span class="lineNum">    3372 </span><span class="lineCov">          1 :       if (i &lt; includeFolders.Length() - 1) {</span>
<span class="lineNum">    3373 </span><span class="lineCov">          1 :         clause.Str(&quot;,&quot;);</span>
<span class="lineNum">    3374 </span>            :       }
<span class="lineNum">    3375 </span>            :     }
<span class="lineNum">    3376 </span><span class="lineCov">          1 :     clause.Str(&quot;)&quot;);</span>
<span class="lineNum">    3377 </span>            :   }
<span class="lineNum">    3378 </span>            : 
<span class="lineNum">    3379 </span><span class="lineCov">          1 :   if (excludeQueries) {</span>
<span class="lineNum">    3380 </span>            :     // Serching by terms implicitly exclude queries.
<span class="lineNum">    3381 </span>            :     clause.Condition(&quot;NOT h.url_hash BETWEEN hash('place', 'prefix_lo') AND &quot;
<span class="lineNum">    3382 </span><span class="lineCov">          1 :                                             &quot;hash('place', 'prefix_hi')&quot;);</span>
<span class="lineNum">    3383 </span>            :   }
<span class="lineNum">    3384 </span>            : 
<span class="lineNum">    3385 </span>            :   clause.GetClauseString(*aClause);
<span class="lineNum">    3386 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    3387 </span>            : }
<span class="lineNum">    3388 </span>            : 
<span class="lineNum">    3389 </span>            : 
<span class="lineNum">    3390 </span>            : // nsNavHistory::BindQueryClauseParameters
<span class="lineNum">    3391 </span>            : //
<span class="lineNum">    3392 </span>            : //    THE BEHAVIOR SHOULD BE IN SYNC WITH QueryToSelectClause
<a name="3393"><span class="lineNum">    3393 </span>            : </a>
<span class="lineNum">    3394 </span>            : nsresult
<span class="lineNum">    3395 </span><span class="lineCov">          1 : nsNavHistory::BindQueryClauseParameters(mozIStorageBaseStatement* statement,</span>
<span class="lineNum">    3396 </span>            :                                         int32_t aQueryIndex,
<span class="lineNum">    3397 </span>            :                                         nsNavHistoryQuery* aQuery, // const
<span class="lineNum">    3398 </span>            :                                         nsNavHistoryQueryOptions* aOptions)
<span class="lineNum">    3399 </span>            : {
<span class="lineNum">    3400 </span>            :   nsresult rv;
<span class="lineNum">    3401 </span>            : 
<span class="lineNum">    3402 </span>            :   bool hasIt;
<span class="lineNum">    3403 </span>            :   // Append numbered index to param names, to replace them correctly in
<span class="lineNum">    3404 </span>            :   // case of multiple queries.  If we have just one query we don't change the
<span class="lineNum">    3405 </span>            :   // param name though.
<span class="lineNum">    3406 </span><span class="lineCov">          1 :   nsAutoCString qIndex;</span>
<span class="lineNum">    3407 </span><span class="lineCov">          1 :   if (aQueryIndex &gt; 0)</span>
<span class="lineNum">    3408 </span><span class="lineCov">          1 :     qIndex.AppendInt(aQueryIndex);</span>
<span class="lineNum">    3409 </span>            : 
<span class="lineNum">    3410 </span>            :   // begin time
<span class="lineNum">    3411 </span><span class="lineCov">          1 :   if (NS_SUCCEEDED(aQuery-&gt;GetHasBeginTime(&amp;hasIt)) &amp;&amp; hasIt) {</span>
<span class="lineNum">    3412 </span>            :     PRTime time = NormalizeTime(aQuery-&gt;BeginTimeReference(),
<span class="lineNum">    3413 </span><span class="lineCov">          1 :                                 aQuery-&gt;BeginTime());</span>
<span class="lineNum">    3414 </span>            :     rv = statement-&gt;BindInt64ByName(
<span class="lineNum">    3415 </span><span class="lineCov">          1 :       NS_LITERAL_CSTRING(&quot;begin_time&quot;) + qIndex, time);</span>
<span class="lineNum">    3416 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3417 </span>            :   }
<span class="lineNum">    3418 </span>            : 
<span class="lineNum">    3419 </span>            :   // end time
<span class="lineNum">    3420 </span><span class="lineCov">          1 :   if (NS_SUCCEEDED(aQuery-&gt;GetHasEndTime(&amp;hasIt)) &amp;&amp; hasIt) {</span>
<span class="lineNum">    3421 </span>            :     PRTime time = NormalizeTime(aQuery-&gt;EndTimeReference(),
<span class="lineNum">    3422 </span><span class="lineCov">          1 :                                 aQuery-&gt;EndTime());</span>
<span class="lineNum">    3423 </span>            :     rv = statement-&gt;BindInt64ByName(
<span class="lineNum">    3424 </span><span class="lineCov">          1 :       NS_LITERAL_CSTRING(&quot;end_time&quot;) + qIndex, time</span>
<span class="lineNum">    3425 </span><span class="lineCov">          1 :     );</span>
<span class="lineNum">    3426 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3427 </span>            :   }
<span class="lineNum">    3428 </span>            : 
<span class="lineNum">    3429 </span>            :   // search terms
<span class="lineNum">    3430 </span><span class="lineCov">          1 :   if (NS_SUCCEEDED(aQuery-&gt;GetHasSearchTerms(&amp;hasIt)) &amp;&amp; hasIt) {</span>
<span class="lineNum">    3431 </span>            :     rv = statement-&gt;BindStringByName(
<span class="lineNum">    3432 </span><span class="lineCov">          1 :       NS_LITERAL_CSTRING(&quot;search_string&quot;) + qIndex,</span>
<span class="lineNum">    3433 </span>            :       aQuery-&gt;SearchTerms()
<span class="lineNum">    3434 </span><span class="lineCov">          1 :     );</span>
<span class="lineNum">    3435 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3436 </span>            :   }
<span class="lineNum">    3437 </span>            : 
<span class="lineNum">    3438 </span>            :   // min and max visit count
<span class="lineNum">    3439 </span><span class="lineCov">          1 :   int32_t visits = aQuery-&gt;MinVisits();</span>
<span class="lineNum">    3440 </span><span class="lineCov">          1 :   if (visits &gt;= 0) {</span>
<span class="lineNum">    3441 </span>            :     rv = statement-&gt;BindInt32ByName(
<span class="lineNum">    3442 </span><span class="lineNoCov">          0 :       NS_LITERAL_CSTRING(&quot;min_visits&quot;) + qIndex, visits</span>
<span class="lineNum">    3443 </span><span class="lineNoCov">          0 :     );</span>
<span class="lineNum">    3444 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3445 </span>            :   }
<span class="lineNum">    3446 </span>            : 
<span class="lineNum">    3447 </span><span class="lineCov">          1 :   visits = aQuery-&gt;MaxVisits();</span>
<span class="lineNum">    3448 </span><span class="lineCov">          1 :   if (visits &gt;= 0) {</span>
<span class="lineNum">    3449 </span>            :     rv = statement-&gt;BindInt32ByName(
<span class="lineNum">    3450 </span><span class="lineNoCov">          0 :       NS_LITERAL_CSTRING(&quot;max_visits&quot;) + qIndex, visits</span>
<span class="lineNum">    3451 </span><span class="lineNoCov">          0 :     );</span>
<span class="lineNum">    3452 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3453 </span>            :   }
<span class="lineNum">    3454 </span>            : 
<span class="lineNum">    3455 </span>            :   // domain (see GetReversedHostname for more info on reversed host names)
<span class="lineNum">    3456 </span><span class="lineCov">          1 :   if (NS_SUCCEEDED(aQuery-&gt;GetHasDomain(&amp;hasIt)) &amp;&amp; hasIt) {</span>
<span class="lineNum">    3457 </span>            :     nsString revDomain;
<span class="lineNum">    3458 </span><span class="lineCov">          1 :     GetReversedHostname(NS_ConvertUTF8toUTF16(aQuery-&gt;Domain()), revDomain);</span>
<span class="lineNum">    3459 </span>            : 
<span class="lineNum">    3460 </span><span class="lineCov">          1 :     if (aQuery-&gt;DomainIsHost()) {</span>
<span class="lineNum">    3461 </span>            :       rv = statement-&gt;BindStringByName(
<span class="lineNum">    3462 </span><span class="lineCov">          1 :         NS_LITERAL_CSTRING(&quot;domain_lower&quot;) + qIndex, revDomain</span>
<span class="lineNum">    3463 </span><span class="lineCov">          1 :       );</span>
<span class="lineNum">    3464 </span><span class="lineCov">          1 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3465 </span>            :     } else {
<span class="lineNum">    3466 </span>            :       // for &quot;mozilla.org&quot; do query &gt;= &quot;gro.allizom.&quot; AND &lt; &quot;gro.allizom/&quot;
<span class="lineNum">    3467 </span>            :       // which will get everything starting with &quot;gro.allizom.&quot; while using the
<span class="lineNum">    3468 </span>            :       // index (using SUBSTRING() causes indexes to be discarded).
<span class="lineNum">    3469 </span>            :       NS_ASSERTION(revDomain[revDomain.Length() - 1] == '.', &quot;Invalid rev. host&quot;);
<span class="lineNum">    3470 </span>            :       rv = statement-&gt;BindStringByName(
<span class="lineNum">    3471 </span><span class="lineCov">          1 :         NS_LITERAL_CSTRING(&quot;domain_lower&quot;) + qIndex, revDomain</span>
<span class="lineNum">    3472 </span><span class="lineCov">          1 :       );</span>
<span class="lineNum">    3473 </span><span class="lineCov">          1 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3474 </span><span class="lineCov">          1 :       revDomain.Truncate(revDomain.Length() - 1);</span>
<span class="lineNum">    3475 </span><span class="lineCov">          1 :       revDomain.Append(char16_t('/'));</span>
<span class="lineNum">    3476 </span>            :       rv = statement-&gt;BindStringByName(
<span class="lineNum">    3477 </span><span class="lineCov">          1 :         NS_LITERAL_CSTRING(&quot;domain_upper&quot;) + qIndex, revDomain</span>
<span class="lineNum">    3478 </span><span class="lineCov">          1 :       );</span>
<span class="lineNum">    3479 </span><span class="lineCov">          1 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3480 </span>            :     }
<span class="lineNum">    3481 </span>            :   }
<span class="lineNum">    3482 </span>            : 
<span class="lineNum">    3483 </span>            :   // URI
<span class="lineNum">    3484 </span><span class="lineCov">          1 :   if (aQuery-&gt;Uri()) {</span>
<span class="lineNum">    3485 </span>            :     rv = URIBinder::Bind(
<span class="lineNum">    3486 </span><span class="lineCov">          1 :       statement, NS_LITERAL_CSTRING(&quot;uri&quot;) + qIndex, aQuery-&gt;Uri()</span>
<span class="lineNum">    3487 </span><span class="lineCov">          1 :     );</span>
<span class="lineNum">    3488 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3489 </span>            :   }
<span class="lineNum">    3490 </span>            : 
<span class="lineNum">    3491 </span>            :   // annotation
<span class="lineNum">    3492 </span><span class="lineCov">          1 :   if (!aQuery-&gt;Annotation().IsEmpty()) {</span>
<span class="lineNum">    3493 </span>            :     rv = statement-&gt;BindUTF8StringByName(
<span class="lineNum">    3494 </span><span class="lineNoCov">          0 :       NS_LITERAL_CSTRING(&quot;anno&quot;) + qIndex, aQuery-&gt;Annotation()</span>
<span class="lineNum">    3495 </span><span class="lineNoCov">          0 :     );</span>
<span class="lineNum">    3496 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3497 </span>            :   }
<span class="lineNum">    3498 </span>            : 
<span class="lineNum">    3499 </span>            :   // tags
<span class="lineNum">    3500 </span><span class="lineCov">          1 :   const nsTArray&lt;nsString&gt; &amp;tags = aQuery-&gt;Tags();</span>
<span class="lineNum">    3501 </span><span class="lineCov">          1 :   if (tags.Length() &gt; 0) {</span>
<span class="lineNum">    3502 </span><span class="lineCov">          1 :     for (uint32_t i = 0; i &lt; tags.Length(); ++i) {</span>
<span class="lineNum">    3503 </span><span class="lineCov">          1 :       nsPrintfCString paramName(&quot;tag%d_&quot;, i);</span>
<span class="lineNum">    3504 </span><span class="lineCov">          1 :       NS_ConvertUTF16toUTF8 tag(tags[i]);</span>
<span class="lineNum">    3505 </span><span class="lineCov">          1 :       rv = statement-&gt;BindUTF8StringByName(paramName + qIndex, tag);</span>
<span class="lineNum">    3506 </span><span class="lineCov">          1 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3507 </span>            :     }
<span class="lineNum">    3508 </span><span class="lineCov">          1 :     int64_t tagsFolder = GetTagsFolder();</span>
<span class="lineNum">    3509 </span>            :     rv = statement-&gt;BindInt64ByName(
<span class="lineNum">    3510 </span><span class="lineCov">          1 :       NS_LITERAL_CSTRING(&quot;tags_folder&quot;) + qIndex, tagsFolder</span>
<span class="lineNum">    3511 </span><span class="lineCov">          1 :     );</span>
<span class="lineNum">    3512 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3513 </span><span class="lineCov">          1 :     if (!aQuery-&gt;TagsAreNot()) {</span>
<span class="lineNum">    3514 </span>            :       rv = statement-&gt;BindInt32ByName(
<span class="lineNum">    3515 </span><span class="lineCov">          1 :         NS_LITERAL_CSTRING(&quot;tag_count&quot;) + qIndex, tags.Length()</span>
<span class="lineNum">    3516 </span><span class="lineCov">          1 :       );</span>
<span class="lineNum">    3517 </span><span class="lineCov">          1 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3518 </span>            :     }
<span class="lineNum">    3519 </span>            :   }
<span class="lineNum">    3520 </span>            : 
<span class="lineNum">    3521 </span>            :   // transitions
<span class="lineNum">    3522 </span><span class="lineCov">          1 :   const nsTArray&lt;uint32_t&gt;&amp; transitions = aQuery-&gt;Transitions();</span>
<span class="lineNum">    3523 </span><span class="lineCov">          1 :   if (transitions.Length() &gt; 0) {</span>
<span class="lineNum">    3524 </span><span class="lineCov">          1 :     for (uint32_t i = 0; i &lt; transitions.Length(); ++i) {</span>
<span class="lineNum">    3525 </span><span class="lineCov">          1 :       nsPrintfCString paramName(&quot;transition%d_&quot;, i);</span>
<span class="lineNum">    3526 </span><span class="lineCov">          1 :       rv = statement-&gt;BindInt64ByName(paramName + qIndex, transitions[i]);</span>
<span class="lineNum">    3527 </span><span class="lineCov">          1 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3528 </span>            :     }
<span class="lineNum">    3529 </span>            :   }
<span class="lineNum">    3530 </span>            : 
<span class="lineNum">    3531 </span>            :   return NS_OK;
<span class="lineNum">    3532 </span>            : }
<span class="lineNum">    3533 </span>            : 
<span class="lineNum">    3534 </span>            : 
<span class="lineNum">    3535 </span>            : // nsNavHistory::ResultsAsList
<span class="lineNum">    3536 </span>            : //
<a name="3537"><span class="lineNum">    3537 </span>            : </a>
<span class="lineNum">    3538 </span>            : nsresult
<span class="lineNum">    3539 </span><span class="lineCov">          1 : nsNavHistory::ResultsAsList(mozIStorageStatement* statement,</span>
<span class="lineNum">    3540 </span>            :                             nsNavHistoryQueryOptions* aOptions,
<span class="lineNum">    3541 </span>            :                             nsCOMArray&lt;nsNavHistoryResultNode&gt;* aResults)
<span class="lineNum">    3542 </span>            : {
<span class="lineNum">    3543 </span>            :   nsresult rv;
<span class="lineNum">    3544 </span><span class="lineCov">          1 :   nsCOMPtr&lt;mozIStorageValueArray&gt; row = do_QueryInterface(statement, &amp;rv);</span>
<span class="lineNum">    3545 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3546 </span>            : 
<span class="lineNum">    3547 </span><span class="lineCov">          1 :   bool hasMore = false;</span>
<span class="lineNum">    3548 </span><span class="lineCov">          1 :   while (NS_SUCCEEDED(statement-&gt;ExecuteStep(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<span class="lineNum">    3549 </span>            :     RefPtr&lt;nsNavHistoryResultNode&gt; result;
<span class="lineNum">    3550 </span><span class="lineCov">          1 :     rv = RowToResult(row, aOptions, getter_AddRefs(result));</span>
<span class="lineNum">    3551 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3552 </span><span class="lineCov">          1 :     aResults-&gt;AppendElement(result.forget());</span>
<span class="lineNum">    3553 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">    3554 </span>            :   return NS_OK;
<span class="lineNum">    3555 </span>            : }
<span class="lineNum">    3556 </span>            : 
<span class="lineNum">    3557 </span>            : const int64_t UNDEFINED_URN_VALUE = -1;
<span class="lineNum">    3558 </span>            : 
<span class="lineNum">    3559 </span>            : // Create a urn (like
<span class="lineNum">    3560 </span>            : // urn:places-persist:place:group=0&amp;group=1&amp;sort=1&amp;type=1,,%28local%20files%29)
<a name="3561"><span class="lineNum">    3561 </span>            : // to be used to persist the open state of this container</a>
<span class="lineNum">    3562 </span>            : nsresult
<span class="lineNum">    3563 </span><span class="lineNoCov">          0 : CreatePlacesPersistURN(nsNavHistoryQueryResultNode *aResultNode,</span>
<span class="lineNum">    3564 </span>            :                        int64_t aValue, const nsCString&amp; aTitle, nsCString&amp; aURN)
<span class="lineNum">    3565 </span>            : {
<span class="lineNum">    3566 </span><span class="lineNoCov">          0 :   nsAutoCString uri;</span>
<span class="lineNum">    3567 </span><span class="lineNoCov">          0 :   nsresult rv = aResultNode-&gt;GetUri(uri);</span>
<span class="lineNum">    3568 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3569 </span>            : 
<span class="lineNum">    3570 </span><span class="lineNoCov">          0 :   aURN.AssignLiteral(&quot;urn:places-persist:&quot;);</span>
<span class="lineNum">    3571 </span><span class="lineNoCov">          0 :   aURN.Append(uri);</span>
<span class="lineNum">    3572 </span>            : 
<span class="lineNum">    3573 </span><span class="lineNoCov">          0 :   aURN.Append(',');</span>
<span class="lineNum">    3574 </span><span class="lineNoCov">          0 :   if (aValue != UNDEFINED_URN_VALUE)</span>
<span class="lineNum">    3575 </span><span class="lineNoCov">          0 :     aURN.AppendInt(aValue);</span>
<span class="lineNum">    3576 </span>            : 
<span class="lineNum">    3577 </span><span class="lineNoCov">          0 :   aURN.Append(',');</span>
<span class="lineNum">    3578 </span><span class="lineNoCov">          0 :   if (!aTitle.IsEmpty()) {</span>
<span class="lineNum">    3579 </span><span class="lineNoCov">          0 :     nsAutoCString escapedTitle;</span>
<span class="lineNum">    3580 </span><span class="lineNoCov">          0 :     bool success = NS_Escape(aTitle, escapedTitle, url_XAlphas);</span>
<span class="lineNum">    3581 </span><span class="lineNoCov">          0 :     NS_ENSURE_TRUE(success, NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">    3582 </span><span class="lineNoCov">          0 :     aURN.Append(escapedTitle);</span>
<span class="lineNum">    3583 </span>            :   }
<span class="lineNum">    3584 </span>            : 
<span class="lineNum">    3585 </span>            :   return NS_OK;
<span class="lineNum">    3586 </span>            : }
<a name="3587"><span class="lineNum">    3587 </span>            : </a>
<span class="lineNum">    3588 </span>            : int64_t
<span class="lineNum">    3589 </span><span class="lineCov">          1 : nsNavHistory::GetTagsFolder()</span>
<span class="lineNum">    3590 </span>            : {
<span class="lineNum">    3591 </span>            :   // cache our tags folder
<span class="lineNum">    3592 </span>            :   // note, we can't do this in nsNavHistory::Init(),
<span class="lineNum">    3593 </span>            :   // as getting the bookmarks service would initialize it.
<span class="lineNum">    3594 </span><span class="lineCov">          1 :   if (mTagsFolder == -1) {</span>
<span class="lineNum">    3595 </span><span class="lineCov">          1 :     nsNavBookmarks *bookmarks = nsNavBookmarks::GetBookmarksService();</span>
<span class="lineNum">    3596 </span><span class="lineCov">          1 :     NS_ENSURE_TRUE(bookmarks, -1);</span>
<span class="lineNum">    3597 </span>            : 
<span class="lineNum">    3598 </span><span class="lineCov">          1 :     nsresult rv = bookmarks-&gt;GetTagsFolder(&amp;mTagsFolder);</span>
<span class="lineNum">    3599 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, -1);</span>
<span class="lineNum">    3600 </span>            :   }
<span class="lineNum">    3601 </span><span class="lineCov">          1 :   return mTagsFolder;</span>
<span class="lineNum">    3602 </span>            : }
<span class="lineNum">    3603 </span>            : 
<span class="lineNum">    3604 </span>            : // nsNavHistory::FilterResultSet
<span class="lineNum">    3605 </span>            : //
<span class="lineNum">    3606 </span>            : // This does some post-query-execution filtering:
<span class="lineNum">    3607 </span>            : //   - searching on title, url and tags
<span class="lineNum">    3608 </span>            : //   - limit count
<span class="lineNum">    3609 </span>            : //
<span class="lineNum">    3610 </span>            : // Note:  changes to filtering in FilterResultSet()
<span class="lineNum">    3611 </span>            : // may require changes to NeedToFilterResultSet()
<a name="3612"><span class="lineNum">    3612 </span>            : </a>
<span class="lineNum">    3613 </span>            : nsresult
<span class="lineNum">    3614 </span><span class="lineCov">          1 : nsNavHistory::FilterResultSet(nsNavHistoryQueryResultNode* aQueryNode,</span>
<span class="lineNum">    3615 </span>            :                               const nsCOMArray&lt;nsNavHistoryResultNode&gt;&amp; aSet,
<span class="lineNum">    3616 </span>            :                               nsCOMArray&lt;nsNavHistoryResultNode&gt;* aFiltered,
<span class="lineNum">    3617 </span>            :                               const nsCOMArray&lt;nsNavHistoryQuery&gt;&amp; aQueries,
<span class="lineNum">    3618 </span>            :                               nsNavHistoryQueryOptions *aOptions)
<span class="lineNum">    3619 </span>            : {
<span class="lineNum">    3620 </span>            :   // get the bookmarks service
<span class="lineNum">    3621 </span><span class="lineCov">          1 :   nsNavBookmarks *bookmarks = nsNavBookmarks::GetBookmarksService();</span>
<span class="lineNum">    3622 </span><span class="lineCov">          1 :   NS_ENSURE_TRUE(bookmarks, NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">    3623 </span>            : 
<span class="lineNum">    3624 </span>            :   // parse the search terms
<span class="lineNum">    3625 </span>            :   nsTArray&lt;nsTArray&lt;nsString&gt;*&gt; terms;
<span class="lineNum">    3626 </span><span class="lineCov">          1 :   ParseSearchTermsFromQueries(aQueries, &amp;terms);</span>
<span class="lineNum">    3627 </span>            : 
<span class="lineNum">    3628 </span><span class="lineCov">          1 :   uint16_t resultType = aOptions-&gt;ResultType();</span>
<span class="lineNum">    3629 </span><span class="lineCov">          1 :   for (int32_t nodeIndex = 0; nodeIndex &lt; aSet.Count(); nodeIndex++) {</span>
<span class="lineNum">    3630 </span>            :     // exclude-queries is implicit when searching, we're only looking at
<span class="lineNum">    3631 </span>            :     // plan URI nodes
<span class="lineNum">    3632 </span><span class="lineCov">          1 :     if (!aSet[nodeIndex]-&gt;IsURI())</span>
<span class="lineNum">    3633 </span>            :       continue;
<span class="lineNum">    3634 </span>            : 
<span class="lineNum">    3635 </span>            :     // RESULTS_AS_TAG_CONTENTS returns a set ordered by place_id and
<span class="lineNum">    3636 </span>            :     // lastModified. So, to remove duplicates, we can retain the first result
<span class="lineNum">    3637 </span>            :     // for each uri.
<span class="lineNum">    3638 </span><span class="lineCov">          1 :     if (resultType == nsINavHistoryQueryOptions::RESULTS_AS_TAG_CONTENTS &amp;&amp;</span>
<span class="lineNum">    3639 </span><span class="lineCov">          1 :         nodeIndex &gt; 0 &amp;&amp; aSet[nodeIndex]-&gt;mURI == aSet[nodeIndex-1]-&gt;mURI)</span>
<span class="lineNum">    3640 </span>            :       continue;
<span class="lineNum">    3641 </span>            : 
<span class="lineNum">    3642 </span><span class="lineCov">          1 :     if (aSet[nodeIndex]-&gt;mItemId != -1 &amp;&amp; aQueryNode &amp;&amp;</span>
<span class="lineNum">    3643 </span><span class="lineCov">          1 :         aQueryNode-&gt;mItemId == aSet[nodeIndex]-&gt;mItemId) {</span>
<span class="lineNum">    3644 </span>            :       continue;
<span class="lineNum">    3645 </span>            :     }
<span class="lineNum">    3646 </span>            : 
<span class="lineNum">    3647 </span>            :     // Append the node only if it matches one of the queries.
<span class="lineNum">    3648 </span>            :     bool appendNode = false;
<span class="lineNum">    3649 </span><span class="lineCov">          1 :     for (int32_t queryIndex = 0;</span>
<span class="lineNum">    3650 </span><span class="lineCov">          1 :          queryIndex &lt; aQueries.Count() &amp;&amp; !appendNode; queryIndex++) {</span>
<span class="lineNum">    3651 </span>            : 
<span class="lineNum">    3652 </span><span class="lineCov">          1 :       if (terms[queryIndex]-&gt;Length()) {</span>
<span class="lineNum">    3653 </span>            :         // Filter based on search terms.
<span class="lineNum">    3654 </span>            :         // Convert title and url for the current node to UTF16 strings.
<span class="lineNum">    3655 </span><span class="lineCov">          1 :         NS_ConvertUTF8toUTF16 nodeTitle(aSet[nodeIndex]-&gt;mTitle);</span>
<span class="lineNum">    3656 </span>            :         // Unescape the URL for search terms matching.
<span class="lineNum">    3657 </span><span class="lineCov">          1 :         nsAutoCString cNodeURL(aSet[nodeIndex]-&gt;mURI);</span>
<span class="lineNum">    3658 </span><span class="lineCov">          1 :         NS_ConvertUTF8toUTF16 nodeURL(NS_UnescapeURL(cNodeURL));</span>
<span class="lineNum">    3659 </span>            : 
<span class="lineNum">    3660 </span>            :         // Determine if every search term matches anywhere in the title, url or
<span class="lineNum">    3661 </span>            :         // tag.
<span class="lineNum">    3662 </span><span class="lineCov">          1 :         bool matchAll = true;</span>
<span class="lineNum">    3663 </span><span class="lineCov">          1 :         for (int32_t termIndex = terms[queryIndex]-&gt;Length() - 1;</span>
<span class="lineNum">    3664 </span><span class="lineCov">          1 :              termIndex &gt;= 0 &amp;&amp; matchAll;</span>
<span class="lineNum">    3665 </span>            :              termIndex--) {
<span class="lineNum">    3666 </span><span class="lineCov">          1 :           nsString&amp; term = terms[queryIndex]-&gt;ElementAt(termIndex);</span>
<span class="lineNum">    3667 </span>            : 
<span class="lineNum">    3668 </span>            :           // True if any of them match; false makes us quit the loop
<span class="lineNum">    3669 </span><span class="lineCov">          1 :           matchAll = CaseInsensitiveFindInReadable(term, nodeTitle) ||</span>
<span class="lineNum">    3670 </span><span class="lineCov">          1 :                      CaseInsensitiveFindInReadable(term, nodeURL) ||</span>
<span class="lineNum">    3671 </span><span class="lineCov">          1 :                      CaseInsensitiveFindInReadable(term, aSet[nodeIndex]-&gt;mTags);</span>
<span class="lineNum">    3672 </span>            :         }
<span class="lineNum">    3673 </span>            : 
<span class="lineNum">    3674 </span>            :         // Skip the node if we don't match all terms in the title, url or tag
<span class="lineNum">    3675 </span><span class="lineCov">          1 :         if (!matchAll)</span>
<span class="lineNum">    3676 </span>            :           continue;
<span class="lineNum">    3677 </span>            :       }
<span class="lineNum">    3678 </span>            : 
<span class="lineNum">    3679 </span>            :       // We passed all filters, so we can append the node to filtered results.
<span class="lineNum">    3680 </span>            :       appendNode = true;
<span class="lineNum">    3681 </span>            :     }
<span class="lineNum">    3682 </span>            : 
<span class="lineNum">    3683 </span><span class="lineCov">          1 :     if (appendNode)</span>
<span class="lineNum">    3684 </span><span class="lineCov">          1 :       aFiltered-&gt;AppendObject(aSet[nodeIndex]);</span>
<span class="lineNum">    3685 </span>            : 
<span class="lineNum">    3686 </span>            :     // Stop once we have reached max results.
<span class="lineNum">    3687 </span><span class="lineCov">          1 :     if (aOptions-&gt;MaxResults() &gt; 0 &amp;&amp;</span>
<span class="lineNum">    3688 </span><span class="lineNoCov">          0 :         (uint32_t)aFiltered-&gt;Count() &gt;= aOptions-&gt;MaxResults())</span>
<span class="lineNum">    3689 </span>            :       break;
<span class="lineNum">    3690 </span>            :   }
<span class="lineNum">    3691 </span>            : 
<span class="lineNum">    3692 </span>            :   // De-allocate the temporary matrixes.
<span class="lineNum">    3693 </span><span class="lineCov">          1 :   for (int32_t i = 0; i &lt; aQueries.Count(); i++) {</span>
<span class="lineNum">    3694 </span><span class="lineCov">          1 :     delete terms[i];</span>
<span class="lineNum">    3695 </span>            :   }
<span class="lineNum">    3696 </span>            : 
<span class="lineNum">    3697 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    3698 </span>            : }
<a name="3699"><span class="lineNum">    3699 </span>            : </a>
<span class="lineNum">    3700 </span>            : void
<span class="lineNum">    3701 </span><span class="lineCov">          1 : nsNavHistory::registerEmbedVisit(nsIURI* aURI,</span>
<span class="lineNum">    3702 </span>            :                                  int64_t aTime)
<span class="lineNum">    3703 </span>            : {
<span class="lineNum">    3704 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    3705 </span>            : 
<span class="lineNum">    3706 </span><span class="lineCov">          1 :   VisitHashKey* visit = mEmbedVisits.PutEntry(aURI);</span>
<span class="lineNum">    3707 </span><span class="lineCov">          1 :   if (!visit) {</span>
<span class="lineNum">    3708 </span>            :     NS_WARNING(&quot;Unable to register a EMBED visit.&quot;);
<span class="lineNum">    3709 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">    3710 </span>            :   }
<span class="lineNum">    3711 </span><span class="lineCov">          1 :   visit-&gt;visitTime = aTime;</span>
<span class="lineNum">    3712 </span>            : }
<a name="3713"><span class="lineNum">    3713 </span>            : </a>
<span class="lineNum">    3714 </span>            : bool
<span class="lineNum">    3715 </span><span class="lineCov">          1 : nsNavHistory::hasEmbedVisit(nsIURI* aURI) {</span>
<span class="lineNum">    3716 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    3717 </span>            : 
<span class="lineNum">    3718 </span><span class="lineCov">          1 :   return !!mEmbedVisits.GetEntry(aURI);</span>
<span class="lineNum">    3719 </span>            : }
<a name="3720"><span class="lineNum">    3720 </span>            : </a>
<span class="lineNum">    3721 </span>            : void
<span class="lineNum">    3722 </span><span class="lineNoCov">          0 : nsNavHistory::clearEmbedVisits() {</span>
<span class="lineNum">    3723 </span>            :   NS_ASSERTION(NS_IsMainThread(), &quot;This can only be called on the main thread&quot;);
<span class="lineNum">    3724 </span>            : 
<span class="lineNum">    3725 </span><span class="lineCov">          1 :   mEmbedVisits.Clear();</span>
<span class="lineNum">    3726 </span><span class="lineNoCov">          0 : }</span>
<a name="3727"><span class="lineNum">    3727 </span>            : </a>
<span class="lineNum">    3728 </span>            : NS_IMETHODIMP
<span class="lineNum">    3729 </span><span class="lineCov">          1 : nsNavHistory::ClearEmbedVisits() {</span>
<span class="lineNum">    3730 </span>            :   clearEmbedVisits();
<span class="lineNum">    3731 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    3732 </span>            : }
<a name="3733"><span class="lineNum">    3733 </span>            : </a>
<span class="lineNum">    3734 </span>            : NS_IMETHODIMP
<span class="lineNum">    3735 </span><span class="lineNoCov">          0 : nsNavHistory::MakeGuid(nsACString&amp; aGuid) {</span>
<span class="lineNum">    3736 </span><span class="lineNoCov">          0 :   if (NS_FAILED(GenerateGUID(aGuid))) {</span>
<span class="lineNum">    3737 </span>            :     MOZ_ASSERT(false, &quot;Shouldn't fail to create a guid!&quot;);
<span class="lineNum">    3738 </span><span class="lineNoCov">          0 :     aGuid.SetIsVoid(true);</span>
<span class="lineNum">    3739 </span>            :   }
<span class="lineNum">    3740 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    3741 </span>            : }
<span class="lineNum">    3742 </span>            : 
<span class="lineNum">    3743 </span>            : // nsNavHistory::CheckIsRecentEvent
<span class="lineNum">    3744 </span>            : //
<span class="lineNum">    3745 </span>            : //    Sees if this URL happened &quot;recently.&quot;
<span class="lineNum">    3746 </span>            : //
<span class="lineNum">    3747 </span>            : //    It is always removed from our recent list no matter what. It only counts
<span class="lineNum">    3748 </span>            : //    as &quot;recent&quot; if the event happened more recently than our event
<span class="lineNum">    3749 </span>            : //    threshold ago.
<a name="3750"><span class="lineNum">    3750 </span>            : </a>
<span class="lineNum">    3751 </span>            : bool
<span class="lineNum">    3752 </span><span class="lineCov">          1 : nsNavHistory::CheckIsRecentEvent(RecentEventHash* hashTable,</span>
<span class="lineNum">    3753 </span>            :                                  const nsACString&amp; url)
<span class="lineNum">    3754 </span>            : {
<span class="lineNum">    3755 </span>            :   PRTime eventTime;
<span class="lineNum">    3756 </span><span class="lineCov">          1 :   if (hashTable-&gt;Get(url, reinterpret_cast&lt;int64_t*&gt;(&amp;eventTime))) {</span>
<span class="lineNum">    3757 </span><span class="lineCov">          1 :     hashTable-&gt;Remove(url);</span>
<span class="lineNum">    3758 </span><span class="lineCov">          1 :     if (eventTime &gt; GetNow() - RECENT_EVENT_THRESHOLD)</span>
<span class="lineNum">    3759 </span>            :       return true;
<span class="lineNum">    3760 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">    3761 </span>            :   }
<span class="lineNum">    3762 </span>            :   return false;
<span class="lineNum">    3763 </span>            : }
<span class="lineNum">    3764 </span>            : 
<span class="lineNum">    3765 </span>            : 
<span class="lineNum">    3766 </span>            : // nsNavHistory::ExpireNonrecentEvents
<span class="lineNum">    3767 </span>            : //
<span class="lineNum">    3768 </span>            : //    This goes through our
<a name="3769"><span class="lineNum">    3769 </span>            : </a>
<span class="lineNum">    3770 </span>            : void
<span class="lineNum">    3771 </span><span class="lineNoCov">          0 : nsNavHistory::ExpireNonrecentEvents(RecentEventHash* hashTable)</span>
<span class="lineNum">    3772 </span>            : {
<span class="lineNum">    3773 </span><span class="lineNoCov">          0 :   int64_t threshold = GetNow() - RECENT_EVENT_THRESHOLD;</span>
<span class="lineNum">    3774 </span><span class="lineNoCov">          0 :   for (auto iter = hashTable-&gt;Iter(); !iter.Done(); iter.Next()) {</span>
<span class="lineNum">    3775 </span><span class="lineNoCov">          0 :     if (iter.Data() &lt; threshold) {</span>
<span class="lineNum">    3776 </span><span class="lineNoCov">          0 :       iter.Remove();</span>
<span class="lineNum">    3777 </span>            :     }
<span class="lineNum">    3778 </span>            :   }
<span class="lineNum">    3779 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3780 </span>            : 
<span class="lineNum">    3781 </span>            : 
<span class="lineNum">    3782 </span>            : // nsNavHistory::RowToResult
<span class="lineNum">    3783 </span>            : //
<span class="lineNum">    3784 </span>            : //    Here, we just have a generic row. It could be a query, URL, visit,
<span class="lineNum">    3785 </span>            : //    or full visit.
<a name="3786"><span class="lineNum">    3786 </span>            : </a>
<span class="lineNum">    3787 </span>            : nsresult
<span class="lineNum">    3788 </span><span class="lineCov">          1 : nsNavHistory::RowToResult(mozIStorageValueArray* aRow,</span>
<span class="lineNum">    3789 </span>            :                           nsNavHistoryQueryOptions* aOptions,
<span class="lineNum">    3790 </span>            :                           nsNavHistoryResultNode** aResult)
<span class="lineNum">    3791 </span>            : {
<span class="lineNum">    3792 </span>            :   NS_ASSERTION(aRow &amp;&amp; aOptions &amp;&amp; aResult, &quot;Null pointer in RowToResult&quot;);
<span class="lineNum">    3793 </span>            : 
<span class="lineNum">    3794 </span>            :   // URL
<span class="lineNum">    3795 </span><span class="lineCov">          1 :   nsAutoCString url;</span>
<span class="lineNum">    3796 </span><span class="lineCov">          1 :   nsresult rv = aRow-&gt;GetUTF8String(kGetInfoIndex_URL, url);</span>
<span class="lineNum">    3797 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3798 </span>            : 
<span class="lineNum">    3799 </span>            :   // title
<span class="lineNum">    3800 </span><span class="lineCov">          1 :   nsAutoCString title;</span>
<span class="lineNum">    3801 </span><span class="lineCov">          1 :   rv = aRow-&gt;GetUTF8String(kGetInfoIndex_Title, title);</span>
<span class="lineNum">    3802 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3803 </span>            : 
<span class="lineNum">    3804 </span><span class="lineCov">          1 :   uint32_t accessCount = aRow-&gt;AsInt32(kGetInfoIndex_VisitCount);</span>
<span class="lineNum">    3805 </span><span class="lineCov">          1 :   PRTime time = aRow-&gt;AsInt64(kGetInfoIndex_VisitDate);</span>
<span class="lineNum">    3806 </span>            : 
<span class="lineNum">    3807 </span>            :   // itemId
<span class="lineNum">    3808 </span><span class="lineCov">          1 :   int64_t itemId = aRow-&gt;AsInt64(kGetInfoIndex_ItemId);</span>
<span class="lineNum">    3809 </span><span class="lineCov">          1 :   int64_t parentId = -1;</span>
<span class="lineNum">    3810 </span><span class="lineCov">          1 :   if (itemId == 0) {</span>
<span class="lineNum">    3811 </span>            :     // This is not a bookmark.  For non-bookmarks we use a -1 itemId value.
<span class="lineNum">    3812 </span>            :     // Notice ids in sqlite tables start from 1, so itemId cannot ever be 0.
<span class="lineNum">    3813 </span>            :     itemId = -1;
<span class="lineNum">    3814 </span>            :   }
<span class="lineNum">    3815 </span>            :   else {
<span class="lineNum">    3816 </span>            :     // This is a bookmark, so it has a parent.
<span class="lineNum">    3817 </span><span class="lineCov">          1 :     int64_t itemParentId = aRow-&gt;AsInt64(kGetInfoIndex_ItemParentId);</span>
<span class="lineNum">    3818 </span><span class="lineCov">          1 :     if (itemParentId &gt; 0) {</span>
<span class="lineNum">    3819 </span>            :       // The Places root has parent == 0, but that item id does not really
<span class="lineNum">    3820 </span>            :       // exist. We want to set the parent only if it's a real one.
<span class="lineNum">    3821 </span><span class="lineCov">          1 :       parentId = itemParentId;</span>
<span class="lineNum">    3822 </span>            :     }
<span class="lineNum">    3823 </span>            :   }
<span class="lineNum">    3824 </span>            : 
<span class="lineNum">    3825 </span><span class="lineCov">          1 :   if (IsQueryURI(url)) {</span>
<span class="lineNum">    3826 </span>            :     // Special case &quot;place:&quot; URIs: turn them into containers.
<span class="lineNum">    3827 </span><span class="lineCov">          1 :     if (itemId != -1) {</span>
<span class="lineNum">    3828 </span>            :       // We should never expose the history title for query nodes if the
<span class="lineNum">    3829 </span>            :       // bookmark-item's title is set to null (the history title may be the
<span class="lineNum">    3830 </span>            :       // query string without the place: prefix). Thus we call getItemTitle
<span class="lineNum">    3831 </span>            :       // explicitly. Doing this in the SQL query would be less performant since
<span class="lineNum">    3832 </span>            :       // it should be done for all results rather than only for queries.
<span class="lineNum">    3833 </span><span class="lineCov">          1 :       nsNavBookmarks *bookmarks = nsNavBookmarks::GetBookmarksService();</span>
<span class="lineNum">    3834 </span><span class="lineCov">          1 :       NS_ENSURE_TRUE(bookmarks, NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">    3835 </span>            : 
<span class="lineNum">    3836 </span><span class="lineCov">          1 :       rv = bookmarks-&gt;GetItemTitle(itemId, title);</span>
<span class="lineNum">    3837 </span><span class="lineCov">          1 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3838 </span>            :     }
<span class="lineNum">    3839 </span>            : 
<span class="lineNum">    3840 </span><span class="lineCov">          1 :     nsAutoCString guid;</span>
<span class="lineNum">    3841 </span><span class="lineCov">          1 :     if (itemId != -1) {</span>
<span class="lineNum">    3842 </span><span class="lineCov">          1 :       rv = aRow-&gt;GetUTF8String(nsNavBookmarks::kGetChildrenIndex_Guid, guid);</span>
<span class="lineNum">    3843 </span><span class="lineCov">          1 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3844 </span>            :     }
<span class="lineNum">    3845 </span>            : 
<span class="lineNum">    3846 </span><span class="lineCov">          1 :     RefPtr&lt;nsNavHistoryResultNode&gt; resultNode;</span>
<span class="lineNum">    3847 </span>            :     rv = QueryRowToResult(itemId, guid, url, title, accessCount, time,
<span class="lineNum">    3848 </span><span class="lineCov">          1 :                           getter_AddRefs(resultNode));</span>
<span class="lineNum">    3849 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3850 </span>            : 
<span class="lineNum">    3851 </span><span class="lineCov">          1 :     if (itemId != -1 ||</span>
<span class="lineNum">    3852 </span><span class="lineCov">          1 :         aOptions-&gt;ResultType() == nsNavHistoryQueryOptions::RESULTS_AS_TAG_QUERY) {</span>
<span class="lineNum">    3853 </span>            :       // RESULTS_AS_TAG_QUERY has date columns
<span class="lineNum">    3854 </span><span class="lineCov">          1 :       resultNode-&gt;mDateAdded = aRow-&gt;AsInt64(kGetInfoIndex_ItemDateAdded);</span>
<span class="lineNum">    3855 </span><span class="lineCov">          1 :       resultNode-&gt;mLastModified = aRow-&gt;AsInt64(kGetInfoIndex_ItemLastModified);</span>
<span class="lineNum">    3856 </span><span class="lineCov">          1 :       if (resultNode-&gt;IsFolder()) {</span>
<span class="lineNum">    3857 </span>            :         // If it's a simple folder node (i.e. a shortcut to another folder), apply
<span class="lineNum">    3858 </span>            :         // our options for it. However, if the parent type was tag query, we do not
<span class="lineNum">    3859 </span>            :         // apply them, because it would not yield any results.
<span class="lineNum">    3860 </span><span class="lineCov">          1 :         resultNode-&gt;GetAsContainer()-&gt;mOptions = aOptions;</span>
<span class="lineNum">    3861 </span>            :       }
<span class="lineNum">    3862 </span>            :     }
<span class="lineNum">    3863 </span>            : 
<span class="lineNum">    3864 </span>            :     resultNode.forget(aResult);
<span class="lineNum">    3865 </span><span class="lineCov">          1 :     return rv;</span>
<span class="lineNum">    3866 </span><span class="lineCov">          1 :   } else if (aOptions-&gt;ResultType() == nsNavHistoryQueryOptions::RESULTS_AS_URI ||</span>
<span class="lineNum">    3867 </span><span class="lineCov">          1 :              aOptions-&gt;ResultType() == nsNavHistoryQueryOptions::RESULTS_AS_TAG_CONTENTS) {</span>
<span class="lineNum">    3868 </span>            :     RefPtr&lt;nsNavHistoryResultNode&gt; resultNode =
<span class="lineNum">    3869 </span><span class="lineCov">          1 :       new nsNavHistoryResultNode(url, title, accessCount, time);</span>
<span class="lineNum">    3870 </span>            : 
<span class="lineNum">    3871 </span><span class="lineCov">          1 :     if (itemId != -1) {</span>
<span class="lineNum">    3872 </span><span class="lineCov">          1 :       resultNode-&gt;mItemId = itemId;</span>
<span class="lineNum">    3873 </span><span class="lineCov">          1 :       resultNode-&gt;mFolderId = parentId;</span>
<span class="lineNum">    3874 </span><span class="lineCov">          1 :       resultNode-&gt;mDateAdded = aRow-&gt;AsInt64(kGetInfoIndex_ItemDateAdded);</span>
<span class="lineNum">    3875 </span><span class="lineCov">          1 :       resultNode-&gt;mLastModified = aRow-&gt;AsInt64(kGetInfoIndex_ItemLastModified);</span>
<span class="lineNum">    3876 </span>            : 
<span class="lineNum">    3877 </span>            :       rv = aRow-&gt;GetUTF8String(nsNavBookmarks::kGetChildrenIndex_Guid,
<span class="lineNum">    3878 </span><span class="lineCov">          1 :                                resultNode-&gt;mBookmarkGuid);</span>
<span class="lineNum">    3879 </span><span class="lineCov">          1 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3880 </span>            :     }
<span class="lineNum">    3881 </span>            : 
<span class="lineNum">    3882 </span><span class="lineCov">          1 :     resultNode-&gt;mFrecency = aRow-&gt;AsInt32(kGetInfoIndex_Frecency);</span>
<span class="lineNum">    3883 </span><span class="lineCov">          1 :     resultNode-&gt;mHidden = !!aRow-&gt;AsInt32(kGetInfoIndex_Hidden);</span>
<span class="lineNum">    3884 </span>            : 
<span class="lineNum">    3885 </span><span class="lineCov">          1 :     nsAutoString tags;</span>
<span class="lineNum">    3886 </span><span class="lineCov">          1 :     rv = aRow-&gt;GetString(kGetInfoIndex_ItemTags, tags);</span>
<span class="lineNum">    3887 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3888 </span><span class="lineCov">          1 :     if (!tags.IsVoid()) {</span>
<span class="lineNum">    3889 </span><span class="lineCov">          1 :       resultNode-&gt;mTags.Assign(tags);</span>
<span class="lineNum">    3890 </span>            :     }
<span class="lineNum">    3891 </span>            : 
<span class="lineNum">    3892 </span><span class="lineCov">          1 :     rv = aRow-&gt;GetUTF8String(kGetInfoIndex_Guid, resultNode-&gt;mPageGuid);</span>
<span class="lineNum">    3893 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3894 </span>            : 
<span class="lineNum">    3895 </span>            :     resultNode.forget(aResult);
<span class="lineNum">    3896 </span><span class="lineCov">          1 :     return NS_OK;</span>
<span class="lineNum">    3897 </span>            :   }
<span class="lineNum">    3898 </span>            : 
<span class="lineNum">    3899 </span><span class="lineNoCov">          0 :   if (aOptions-&gt;ResultType() == nsNavHistoryQueryOptions::RESULTS_AS_VISIT) {</span>
<span class="lineNum">    3900 </span>            :     RefPtr&lt;nsNavHistoryResultNode&gt; resultNode =
<span class="lineNum">    3901 </span><span class="lineNoCov">          0 :       new nsNavHistoryResultNode(url, title, accessCount, time);</span>
<span class="lineNum">    3902 </span>            : 
<span class="lineNum">    3903 </span><span class="lineNoCov">          0 :     nsAutoString tags;</span>
<span class="lineNum">    3904 </span><span class="lineNoCov">          0 :     rv = aRow-&gt;GetString(kGetInfoIndex_ItemTags, tags);</span>
<span class="lineNum">    3905 </span><span class="lineNoCov">          0 :     if (!tags.IsVoid())</span>
<span class="lineNum">    3906 </span><span class="lineNoCov">          0 :       resultNode-&gt;mTags.Assign(tags);</span>
<span class="lineNum">    3907 </span>            : 
<span class="lineNum">    3908 </span><span class="lineNoCov">          0 :     rv = aRow-&gt;GetUTF8String(kGetInfoIndex_Guid, resultNode-&gt;mPageGuid);</span>
<span class="lineNum">    3909 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3910 </span>            : 
<span class="lineNum">    3911 </span><span class="lineNoCov">          0 :     rv = aRow-&gt;GetInt64(kGetInfoIndex_VisitId, &amp;resultNode-&gt;mVisitId);</span>
<span class="lineNum">    3912 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3913 </span>            : 
<span class="lineNum">    3914 </span>            :     int64_t fromVisitId;
<span class="lineNum">    3915 </span><span class="lineNoCov">          0 :     rv = aRow-&gt;GetInt64(kGetInfoIndex_FromVisitId, &amp;fromVisitId);</span>
<span class="lineNum">    3916 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3917 </span>            : 
<span class="lineNum">    3918 </span><span class="lineNoCov">          0 :     if (fromVisitId &gt; 0) {</span>
<span class="lineNum">    3919 </span><span class="lineNoCov">          0 :       resultNode-&gt;mFromVisitId = fromVisitId;</span>
<span class="lineNum">    3920 </span>            :     }
<span class="lineNum">    3921 </span>            : 
<span class="lineNum">    3922 </span><span class="lineNoCov">          0 :     resultNode-&gt;mTransitionType = aRow-&gt;AsInt32(kGetInfoIndex_VisitType);</span>
<span class="lineNum">    3923 </span>            : 
<span class="lineNum">    3924 </span>            :     resultNode.forget(aResult);
<span class="lineNum">    3925 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">    3926 </span>            :   }
<span class="lineNum">    3927 </span>            : 
<span class="lineNum">    3928 </span>            :   return NS_ERROR_FAILURE;
<span class="lineNum">    3929 </span>            : }
<span class="lineNum">    3930 </span>            : 
<span class="lineNum">    3931 </span>            : 
<span class="lineNum">    3932 </span>            : // nsNavHistory::QueryRowToResult
<span class="lineNum">    3933 </span>            : //
<span class="lineNum">    3934 </span>            : //    Called by RowToResult when the URI is a place: URI to generate the proper
<span class="lineNum">    3935 </span>            : //    folder or query node.
<a name="3936"><span class="lineNum">    3936 </span>            : </a>
<span class="lineNum">    3937 </span>            : nsresult
<span class="lineNum">    3938 </span><span class="lineCov">          1 : nsNavHistory::QueryRowToResult(int64_t itemId,</span>
<span class="lineNum">    3939 </span>            :                                const nsACString&amp; aBookmarkGuid,
<span class="lineNum">    3940 </span>            :                                const nsACString&amp; aURI,
<span class="lineNum">    3941 </span>            :                                const nsACString&amp; aTitle,
<span class="lineNum">    3942 </span>            :                                uint32_t aAccessCount,
<span class="lineNum">    3943 </span>            :                                PRTime aTime,
<span class="lineNum">    3944 </span>            :                                nsNavHistoryResultNode** aNode)
<span class="lineNum">    3945 </span>            : {
<span class="lineNum">    3946 </span>            :   MOZ_ASSERT((itemId != -1 &amp;&amp; !aBookmarkGuid.IsEmpty()) ||
<span class="lineNum">    3947 </span>            :              (itemId == -1 &amp;&amp; aBookmarkGuid.IsEmpty()));
<span class="lineNum">    3948 </span>            : 
<span class="lineNum">    3949 </span>            :   nsCOMArray&lt;nsNavHistoryQuery&gt; queries;
<span class="lineNum">    3950 </span>            :   nsCOMPtr&lt;nsNavHistoryQueryOptions&gt; options;
<span class="lineNum">    3951 </span>            :   nsresult rv = QueryStringToQueryArray(aURI, &amp;queries,
<span class="lineNum">    3952 </span><span class="lineCov">          1 :                                         getter_AddRefs(options));</span>
<span class="lineNum">    3953 </span>            : 
<span class="lineNum">    3954 </span><span class="lineCov">          1 :   RefPtr&lt;nsNavHistoryResultNode&gt; resultNode;</span>
<span class="lineNum">    3955 </span>            :   // If this failed the query does not parse correctly, let the error pass and
<span class="lineNum">    3956 </span>            :   // handle it later.
<span class="lineNum">    3957 </span><span class="lineCov">          1 :   if (NS_SUCCEEDED(rv)) {</span>
<span class="lineNum">    3958 </span>            :     // Check if this is a folder shortcut, so we can take a faster path.
<span class="lineNum">    3959 </span><span class="lineCov">          1 :     int64_t targetFolderId = GetSimpleBookmarksQueryFolder(queries, options);</span>
<span class="lineNum">    3960 </span><span class="lineCov">          1 :     if (targetFolderId) {</span>
<span class="lineNum">    3961 </span><span class="lineCov">          1 :       nsNavBookmarks *bookmarks = nsNavBookmarks::GetBookmarksService();</span>
<span class="lineNum">    3962 </span><span class="lineCov">          1 :       NS_ENSURE_TRUE(bookmarks, NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">    3963 </span>            : 
<span class="lineNum">    3964 </span>            :       rv = bookmarks-&gt;ResultNodeForContainer(targetFolderId, options,
<span class="lineNum">    3965 </span><span class="lineCov">          1 :                                              getter_AddRefs(resultNode));</span>
<span class="lineNum">    3966 </span>            :       // If this failed the shortcut is pointing to nowhere, let the error pass
<span class="lineNum">    3967 </span>            :       // and handle it later.
<span class="lineNum">    3968 </span><span class="lineCov">          1 :       if (NS_SUCCEEDED(rv)) {</span>
<span class="lineNum">    3969 </span>            :         // At this point the node is set up like a regular folder node. Here
<span class="lineNum">    3970 </span>            :         // we make the necessary change to make it a folder shortcut.
<span class="lineNum">    3971 </span><span class="lineCov">          1 :         resultNode-&gt;GetAsFolder()-&gt;mTargetFolderItemId = targetFolderId;</span>
<span class="lineNum">    3972 </span><span class="lineCov">          1 :         resultNode-&gt;mItemId = itemId;</span>
<span class="lineNum">    3973 </span><span class="lineCov">          1 :         nsAutoCString targetFolderGuid(resultNode-&gt;GetAsFolder()-&gt;mBookmarkGuid);</span>
<span class="lineNum">    3974 </span><span class="lineCov">          1 :         resultNode-&gt;mBookmarkGuid = aBookmarkGuid;</span>
<span class="lineNum">    3975 </span><span class="lineCov">          1 :         resultNode-&gt;GetAsFolder()-&gt;mTargetFolderGuid = targetFolderGuid;</span>
<span class="lineNum">    3976 </span>            : 
<span class="lineNum">    3977 </span>            :         // Use the query item title, unless it's void (in that case use the
<span class="lineNum">    3978 </span>            :         // concrete folder title).
<span class="lineNum">    3979 </span><span class="lineCov">          1 :         if (!aTitle.IsVoid()) {</span>
<span class="lineNum">    3980 </span><span class="lineCov">          1 :           resultNode-&gt;mTitle = aTitle;</span>
<span class="lineNum">    3981 </span>            :         }
<span class="lineNum">    3982 </span>            :       }
<span class="lineNum">    3983 </span>            :     }
<span class="lineNum">    3984 </span>            :     else {
<span class="lineNum">    3985 </span>            :       // This is a regular query.
<span class="lineNum">    3986 </span><span class="lineCov">          1 :       resultNode = new nsNavHistoryQueryResultNode(aTitle, aTime, queries, options);</span>
<span class="lineNum">    3987 </span><span class="lineCov">          1 :       resultNode-&gt;mItemId = itemId;</span>
<span class="lineNum">    3988 </span>            :     }
<span class="lineNum">    3989 </span>            :   }
<span class="lineNum">    3990 </span>            : 
<span class="lineNum">    3991 </span><span class="lineCov">          1 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    3992 </span>            :     NS_WARNING(&quot;Generating a generic empty node for a broken query!&quot;);
<span class="lineNum">    3993 </span>            :     // This is a broken query, that either did not parse or points to not
<span class="lineNum">    3994 </span>            :     // existing data.  We don't want to return failure since that will kill the
<span class="lineNum">    3995 </span>            :     // whole result.  Instead make a generic empty query node.
<span class="lineNum">    3996 </span><span class="lineNoCov">          0 :     resultNode = new nsNavHistoryQueryResultNode(aTitle, aURI);</span>
<span class="lineNum">    3997 </span><span class="lineNoCov">          0 :     resultNode-&gt;mItemId = itemId;</span>
<span class="lineNum">    3998 </span>            :     // This is a perf hack to generate an empty query that skips filtering.
<span class="lineNum">    3999 </span><span class="lineNoCov">          0 :     resultNode-&gt;GetAsQuery()-&gt;Options()-&gt;SetExcludeItems(true);</span>
<span class="lineNum">    4000 </span>            :   }
<span class="lineNum">    4001 </span>            : 
<span class="lineNum">    4002 </span>            :   resultNode.forget(aNode);
<span class="lineNum">    4003 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    4004 </span>            : }
<span class="lineNum">    4005 </span>            : 
<span class="lineNum">    4006 </span>            : 
<span class="lineNum">    4007 </span>            : // nsNavHistory::VisitIdToResultNode
<span class="lineNum">    4008 </span>            : //
<span class="lineNum">    4009 </span>            : //    Used by the query results to create new nodes on the fly when
<span class="lineNum">    4010 </span>            : //    notifications come in. This just creates a node for the given visit ID.
<a name="4011"><span class="lineNum">    4011 </span>            : </a>
<span class="lineNum">    4012 </span>            : nsresult
<span class="lineNum">    4013 </span><span class="lineCov">          1 : nsNavHistory::VisitIdToResultNode(int64_t visitId,</span>
<span class="lineNum">    4014 </span>            :                                   nsNavHistoryQueryOptions* aOptions,
<span class="lineNum">    4015 </span>            :                                   nsNavHistoryResultNode** aResult)
<span class="lineNum">    4016 </span>            : {
<span class="lineNum">    4017 </span><span class="lineCov">          1 :   nsAutoCString tagsFragment;</span>
<span class="lineNum">    4018 </span>            :   GetTagsSqlFragment(GetTagsFolder(), NS_LITERAL_CSTRING(&quot;h.id&quot;),
<span class="lineNum">    4019 </span><span class="lineCov">          1 :                      true, tagsFragment);</span>
<span class="lineNum">    4020 </span>            : 
<span class="lineNum">    4021 </span>            :   nsCOMPtr&lt;mozIStorageStatement&gt; statement;
<span class="lineNum">    4022 </span><span class="lineCov">          1 :   switch (aOptions-&gt;ResultType())</span>
<span class="lineNum">    4023 </span>            :   {
<span class="lineNum">    4024 </span>            :     case nsNavHistoryQueryOptions::RESULTS_AS_VISIT:
<span class="lineNum">    4025 </span>            :     case nsNavHistoryQueryOptions::RESULTS_AS_FULL_VISIT:
<span class="lineNum">    4026 </span>            :       // visit query - want exact visit time
<span class="lineNum">    4027 </span>            :       // Should match kGetInfoIndex_* (see GetQueryResults)
<span class="lineNum">    4028 </span><span class="lineNoCov">          0 :       statement = mDB-&gt;GetStatement(NS_LITERAL_CSTRING(</span>
<span class="lineNum">    4029 </span>            :         &quot;SELECT h.id, h.url, h.title, h.rev_host, h.visit_count, &quot;
<span class="lineNum">    4030 </span>            :                &quot;v.visit_date, null, null, null, null, null, &quot;
<span class="lineNum">    4031 </span><span class="lineNoCov">          0 :                ) + tagsFragment + NS_LITERAL_CSTRING(&quot;, h.frecency, h.hidden, h.guid, &quot;</span>
<span class="lineNum">    4032 </span>            :               &quot;v.id, v.from_visit, v.visit_type &quot;
<span class="lineNum">    4033 </span>            :         &quot;FROM moz_places h &quot;
<span class="lineNum">    4034 </span>            :         &quot;JOIN moz_historyvisits v ON h.id = v.place_id &quot;
<span class="lineNum">    4035 </span>            :         &quot;WHERE v.id = :visit_id &quot;)
<span class="lineNum">    4036 </span><span class="lineNoCov">          0 :       );</span>
<span class="lineNum">    4037 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    4038 </span>            : 
<span class="lineNum">    4039 </span>            :     case nsNavHistoryQueryOptions::RESULTS_AS_URI:
<span class="lineNum">    4040 </span>            :       // URL results - want last visit time
<span class="lineNum">    4041 </span>            :       // Should match kGetInfoIndex_* (see GetQueryResults)
<span class="lineNum">    4042 </span><span class="lineCov">          1 :       statement = mDB-&gt;GetStatement(NS_LITERAL_CSTRING(</span>
<span class="lineNum">    4043 </span>            :         &quot;SELECT h.id, h.url, h.title, h.rev_host, h.visit_count, &quot;
<span class="lineNum">    4044 </span>            :                &quot;h.last_visit_date, null, null, null, null, null, &quot;
<span class="lineNum">    4045 </span><span class="lineCov">          1 :                ) + tagsFragment + NS_LITERAL_CSTRING(&quot;, h.frecency, h.hidden, h.guid, &quot;</span>
<span class="lineNum">    4046 </span>            :               &quot;null, null, null &quot;
<span class="lineNum">    4047 </span>            :         &quot;FROM moz_places h &quot;
<span class="lineNum">    4048 </span>            :         &quot;JOIN moz_historyvisits v ON h.id = v.place_id &quot;
<span class="lineNum">    4049 </span>            :         &quot;WHERE v.id = :visit_id &quot;)
<span class="lineNum">    4050 </span><span class="lineCov">          1 :       );</span>
<span class="lineNum">    4051 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    4052 </span>            : 
<span class="lineNum">    4053 </span>            :     default:
<span class="lineNum">    4054 </span>            :       // Query base types like RESULTS_AS_*_QUERY handle additions
<span class="lineNum">    4055 </span>            :       // by registering their own observers when they are expanded.
<span class="lineNum">    4056 </span>            :       return NS_OK;
<span class="lineNum">    4057 </span>            :   }
<span class="lineNum">    4058 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(statement);</span>
<span class="lineNum">    4059 </span><span class="lineCov">          1 :   mozStorageStatementScoper scoper(statement);</span>
<span class="lineNum">    4060 </span>            : 
<span class="lineNum">    4061 </span>            :   nsresult rv = statement-&gt;BindInt64ByName(NS_LITERAL_CSTRING(&quot;visit_id&quot;),
<span class="lineNum">    4062 </span><span class="lineCov">          1 :                                            visitId);</span>
<span class="lineNum">    4063 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4064 </span>            : 
<span class="lineNum">    4065 </span><span class="lineCov">          1 :   bool hasMore = false;</span>
<span class="lineNum">    4066 </span><span class="lineCov">          1 :   rv = statement-&gt;ExecuteStep(&amp;hasMore);</span>
<span class="lineNum">    4067 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4068 </span><span class="lineCov">          1 :   if (! hasMore) {</span>
<span class="lineNum">    4069 </span>            :     NS_NOTREACHED(&quot;Trying to get a result node for an invalid visit&quot;);
<span class="lineNum">    4070 </span>            :     return NS_ERROR_INVALID_ARG;
<span class="lineNum">    4071 </span>            :   }
<span class="lineNum">    4072 </span>            : 
<span class="lineNum">    4073 </span><span class="lineCov">          1 :   nsCOMPtr&lt;mozIStorageValueArray&gt; row = do_QueryInterface(statement, &amp;rv);</span>
<span class="lineNum">    4074 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4075 </span>            : 
<span class="lineNum">    4076 </span><span class="lineCov">          1 :   return RowToResult(row, aOptions, aResult);</span>
<span class="lineNum">    4077 </span>            : }
<a name="4078"><span class="lineNum">    4078 </span>            : </a>
<span class="lineNum">    4079 </span>            : nsresult
<span class="lineNum">    4080 </span><span class="lineCov">          1 : nsNavHistory::BookmarkIdToResultNode(int64_t aBookmarkId, nsNavHistoryQueryOptions* aOptions,</span>
<span class="lineNum">    4081 </span>            :                                      nsNavHistoryResultNode** aResult)
<span class="lineNum">    4082 </span>            : {
<span class="lineNum">    4083 </span><span class="lineCov">          1 :   nsAutoCString tagsFragment;</span>
<span class="lineNum">    4084 </span>            :   GetTagsSqlFragment(GetTagsFolder(), NS_LITERAL_CSTRING(&quot;h.id&quot;),
<span class="lineNum">    4085 </span><span class="lineCov">          1 :                      true, tagsFragment);</span>
<span class="lineNum">    4086 </span>            :   // Should match kGetInfoIndex_*
<span class="lineNum">    4087 </span>            :   nsCOMPtr&lt;mozIStorageStatement&gt; stmt = mDB-&gt;GetStatement(NS_LITERAL_CSTRING(
<span class="lineNum">    4088 </span>            :       &quot;SELECT b.fk, h.url, COALESCE(b.title, h.title), &quot;
<span class="lineNum">    4089 </span>            :              &quot;h.rev_host, h.visit_count, h.last_visit_date, null, b.id, &quot;
<span class="lineNum">    4090 </span>            :              &quot;b.dateAdded, b.lastModified, b.parent, &quot;
<span class="lineNum">    4091 </span><span class="lineCov">          1 :              ) + tagsFragment + NS_LITERAL_CSTRING(&quot;, h.frecency, h.hidden, h.guid, &quot;</span>
<span class="lineNum">    4092 </span>            :              &quot;null, null, null, b.guid, b.position, b.type, b.fk &quot;
<span class="lineNum">    4093 </span>            :       &quot;FROM moz_bookmarks b &quot;
<span class="lineNum">    4094 </span>            :       &quot;JOIN moz_places h ON b.fk = h.id &quot;
<span class="lineNum">    4095 </span>            :       &quot;WHERE b.id = :item_id &quot;)
<span class="lineNum">    4096 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    4097 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(stmt);</span>
<span class="lineNum">    4098 </span><span class="lineCov">          1 :   mozStorageStatementScoper scoper(stmt);</span>
<span class="lineNum">    4099 </span>            : 
<span class="lineNum">    4100 </span>            :   nsresult rv = stmt-&gt;BindInt64ByName(NS_LITERAL_CSTRING(&quot;item_id&quot;),
<span class="lineNum">    4101 </span><span class="lineCov">          1 :                                       aBookmarkId);</span>
<span class="lineNum">    4102 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4103 </span>            : 
<span class="lineNum">    4104 </span><span class="lineCov">          1 :   bool hasMore = false;</span>
<span class="lineNum">    4105 </span><span class="lineCov">          1 :   rv = stmt-&gt;ExecuteStep(&amp;hasMore);</span>
<span class="lineNum">    4106 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4107 </span><span class="lineCov">          1 :   if (!hasMore) {</span>
<span class="lineNum">    4108 </span>            :     NS_NOTREACHED(&quot;Trying to get a result node for an invalid bookmark identifier&quot;);
<span class="lineNum">    4109 </span>            :     return NS_ERROR_INVALID_ARG;
<span class="lineNum">    4110 </span>            :   }
<span class="lineNum">    4111 </span>            : 
<span class="lineNum">    4112 </span><span class="lineCov">          1 :   nsCOMPtr&lt;mozIStorageValueArray&gt; row = do_QueryInterface(stmt, &amp;rv);</span>
<span class="lineNum">    4113 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4114 </span>            : 
<span class="lineNum">    4115 </span><span class="lineCov">          1 :   return RowToResult(row, aOptions, aResult);</span>
<span class="lineNum">    4116 </span>            : }
<a name="4117"><span class="lineNum">    4117 </span>            : </a>
<span class="lineNum">    4118 </span>            : nsresult
<span class="lineNum">    4119 </span><span class="lineNoCov">          0 : nsNavHistory::URIToResultNode(nsIURI* aURI,</span>
<span class="lineNum">    4120 </span>            :                               nsNavHistoryQueryOptions* aOptions,
<span class="lineNum">    4121 </span>            :                               nsNavHistoryResultNode** aResult)
<span class="lineNum">    4122 </span>            : {
<span class="lineNum">    4123 </span><span class="lineNoCov">          0 :   nsAutoCString tagsFragment;</span>
<span class="lineNum">    4124 </span>            :   GetTagsSqlFragment(GetTagsFolder(), NS_LITERAL_CSTRING(&quot;h.id&quot;),
<span class="lineNum">    4125 </span><span class="lineNoCov">          0 :                      true, tagsFragment);</span>
<span class="lineNum">    4126 </span>            :   // Should match kGetInfoIndex_*
<span class="lineNum">    4127 </span>            :   nsCOMPtr&lt;mozIStorageStatement&gt; stmt = mDB-&gt;GetStatement(NS_LITERAL_CSTRING(
<span class="lineNum">    4128 </span>            :     &quot;SELECT h.id, :page_url, COALESCE(b.title, h.title), &quot;
<span class="lineNum">    4129 </span>            :            &quot;h.rev_host, h.visit_count, h.last_visit_date, null, &quot;
<span class="lineNum">    4130 </span>            :            &quot;b.id, b.dateAdded, b.lastModified, b.parent, &quot;
<span class="lineNum">    4131 </span><span class="lineNoCov">          0 :            ) + tagsFragment + NS_LITERAL_CSTRING(&quot;, h.frecency, h.hidden, h.guid, &quot;</span>
<span class="lineNum">    4132 </span>            :            &quot;null, null, null, b.guid, b.position, b.type, b.fk &quot;
<span class="lineNum">    4133 </span>            :     &quot;FROM moz_places h &quot;
<span class="lineNum">    4134 </span>            :     &quot;LEFT JOIN moz_bookmarks b ON b.fk = h.id &quot;
<span class="lineNum">    4135 </span>            :     &quot;WHERE h.url_hash = hash(:page_url) AND h.url = :page_url &quot;)
<span class="lineNum">    4136 </span><span class="lineNoCov">          0 :   );</span>
<span class="lineNum">    4137 </span><span class="lineNoCov">          0 :   NS_ENSURE_STATE(stmt);</span>
<span class="lineNum">    4138 </span><span class="lineNoCov">          0 :   mozStorageStatementScoper scoper(stmt);</span>
<span class="lineNum">    4139 </span>            : 
<span class="lineNum">    4140 </span><span class="lineNoCov">          0 :   nsresult rv = URIBinder::Bind(stmt, NS_LITERAL_CSTRING(&quot;page_url&quot;), aURI);</span>
<span class="lineNum">    4141 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4142 </span>            : 
<span class="lineNum">    4143 </span><span class="lineNoCov">          0 :   bool hasMore = false;</span>
<span class="lineNum">    4144 </span><span class="lineNoCov">          0 :   rv = stmt-&gt;ExecuteStep(&amp;hasMore);</span>
<span class="lineNum">    4145 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4146 </span><span class="lineNoCov">          0 :   if (!hasMore) {</span>
<span class="lineNum">    4147 </span>            :     NS_NOTREACHED(&quot;Trying to get a result node for an invalid url&quot;);
<span class="lineNum">    4148 </span>            :     return NS_ERROR_INVALID_ARG;
<span class="lineNum">    4149 </span>            :   }
<span class="lineNum">    4150 </span>            : 
<span class="lineNum">    4151 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;mozIStorageValueArray&gt; row = do_QueryInterface(stmt, &amp;rv);</span>
<span class="lineNum">    4152 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4153 </span>            : 
<span class="lineNum">    4154 </span><span class="lineNoCov">          0 :   return RowToResult(row, aOptions, aResult);</span>
<span class="lineNum">    4155 </span>            : }
<a name="4156"><span class="lineNum">    4156 </span>            : </a>
<span class="lineNum">    4157 </span>            : void
<span class="lineNum">    4158 </span><span class="lineCov">          1 : nsNavHistory::SendPageChangedNotification(nsIURI* aURI,</span>
<span class="lineNum">    4159 </span>            :                                           uint32_t aChangedAttribute,
<span class="lineNum">    4160 </span>            :                                           const nsAString&amp; aNewValue,
<span class="lineNum">    4161 </span>            :                                           const nsACString&amp; aGUID)
<span class="lineNum">    4162 </span>            : {
<span class="lineNum">    4163 </span>            :   MOZ_ASSERT(!aGUID.IsEmpty());
<span class="lineNum">    4164 </span><span class="lineCov">          1 :   NOTIFY_OBSERVERS(mCanNotify, mCacheObservers, mObservers,</span>
<span class="lineNum">    4165 </span>            :                    nsINavHistoryObserver,
<span class="lineNum">    4166 </span>            :                    OnPageChanged(aURI, aChangedAttribute, aNewValue, aGUID));
<span class="lineNum">    4167 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    4168 </span>            : 
<span class="lineNum">    4169 </span>            : // nsNavHistory::TitleForDomain
<span class="lineNum">    4170 </span>            : //
<span class="lineNum">    4171 </span>            : //    This computes the title for a given domain. Normally, this is just the
<span class="lineNum">    4172 </span>            : //    domain name, but we specially handle empty cases to give you a nice
<span class="lineNum">    4173 </span>            : //    localized string.
<a name="4174"><span class="lineNum">    4174 </span>            : </a>
<span class="lineNum">    4175 </span>            : void
<span class="lineNum">    4176 </span><span class="lineCov">          1 : nsNavHistory::TitleForDomain(const nsCString&amp; domain, nsACString&amp; aTitle)</span>
<span class="lineNum">    4177 </span>            : {
<span class="lineNum">    4178 </span><span class="lineCov">          1 :   if (! domain.IsEmpty()) {</span>
<span class="lineNum">    4179 </span><span class="lineNoCov">          0 :     aTitle = domain;</span>
<span class="lineNum">    4180 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">    4181 </span>            :   }
<span class="lineNum">    4182 </span>            : 
<span class="lineNum">    4183 </span>            :   // use the localized one instead
<span class="lineNum">    4184 </span><span class="lineCov">          1 :   GetStringFromName(u&quot;localhost&quot;, aTitle);</span>
<span class="lineNum">    4185 </span>            : }
<a name="4186"><span class="lineNum">    4186 </span>            : </a>
<span class="lineNum">    4187 </span>            : void
<span class="lineNum">    4188 </span><span class="lineCov">          1 : nsNavHistory::GetAgeInDaysString(int32_t aInt, const char16_t *aName,</span>
<span class="lineNum">    4189 </span>            :                                  nsACString&amp; aResult)
<span class="lineNum">    4190 </span>            : {
<span class="lineNum">    4191 </span><span class="lineCov">          1 :   nsIStringBundle *bundle = GetBundle();</span>
<span class="lineNum">    4192 </span><span class="lineCov">          1 :   if (bundle) {</span>
<span class="lineNum">    4193 </span><span class="lineCov">          1 :     nsAutoString intString;</span>
<span class="lineNum">    4194 </span><span class="lineCov">          1 :     intString.AppendInt(aInt);</span>
<span class="lineNum">    4195 </span><span class="lineCov">          1 :     const char16_t* strings[1] = { intString.get() };</span>
<span class="lineNum">    4196 </span><span class="lineCov">          1 :     nsXPIDLString value;</span>
<span class="lineNum">    4197 </span>            :     nsresult rv = bundle-&gt;FormatStringFromName(aName, strings,
<span class="lineNum">    4198 </span><span class="lineCov">          1 :                                                1, getter_Copies(value));</span>
<span class="lineNum">    4199 </span><span class="lineCov">          1 :     if (NS_SUCCEEDED(rv)) {</span>
<span class="lineNum">    4200 </span><span class="lineCov">          1 :       CopyUTF16toUTF8(value, aResult);</span>
<span class="lineNum">    4201 </span><span class="lineCov">          1 :       return;</span>
<span class="lineNum">    4202 </span>            :     }
<span class="lineNum">    4203 </span>            :   }
<span class="lineNum">    4204 </span><span class="lineNoCov">          0 :   CopyUTF16toUTF8(nsDependentString(aName), aResult);</span>
<span class="lineNum">    4205 </span>            : }
<a name="4206"><span class="lineNum">    4206 </span>            : </a>
<span class="lineNum">    4207 </span>            : void
<span class="lineNum">    4208 </span><span class="lineCov">          1 : nsNavHistory::GetStringFromName(const char16_t *aName, nsACString&amp; aResult)</span>
<span class="lineNum">    4209 </span>            : {
<span class="lineNum">    4210 </span><span class="lineCov">          1 :   nsIStringBundle *bundle = GetBundle();</span>
<span class="lineNum">    4211 </span><span class="lineCov">          1 :   if (bundle) {</span>
<span class="lineNum">    4212 </span><span class="lineCov">          1 :     nsXPIDLString value;</span>
<span class="lineNum">    4213 </span><span class="lineCov">          1 :     nsresult rv = bundle-&gt;GetStringFromName(aName, getter_Copies(value));</span>
<span class="lineNum">    4214 </span><span class="lineCov">          1 :     if (NS_SUCCEEDED(rv)) {</span>
<span class="lineNum">    4215 </span><span class="lineCov">          1 :       CopyUTF16toUTF8(value, aResult);</span>
<span class="lineNum">    4216 </span><span class="lineCov">          1 :       return;</span>
<span class="lineNum">    4217 </span>            :     }
<span class="lineNum">    4218 </span>            :   }
<span class="lineNum">    4219 </span><span class="lineNoCov">          0 :   CopyUTF16toUTF8(nsDependentString(aName), aResult);</span>
<span class="lineNum">    4220 </span>            : }
<span class="lineNum">    4221 </span>            : 
<a name="4222"><span class="lineNum">    4222 </span>            : // static</a>
<span class="lineNum">    4223 </span>            : void
<span class="lineNum">    4224 </span><span class="lineCov">          1 : nsNavHistory::GetMonthName(const PRExplodedTime&amp; aTime, nsACString&amp; aResult)</span>
<span class="lineNum">    4225 </span>            : {
<span class="lineNum">    4226 </span><span class="lineCov">          1 :   nsAutoString month;</span>
<span class="lineNum">    4227 </span>            :   nsresult rv = DateTimeFormat::FormatPRExplodedTime(kDateFormatMonthLong,
<span class="lineNum">    4228 </span>            :                                                      kTimeFormatNone,
<span class="lineNum">    4229 </span>            :                                                      &amp;aTime,
<span class="lineNum">    4230 </span><span class="lineCov">          1 :                                                      month);</span>
<span class="lineNum">    4231 </span><span class="lineCov">          1 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    4232 </span><span class="lineNoCov">          0 :     aResult = nsPrintfCString(&quot;[%d]&quot;, aTime.tm_month + 1);</span>
<span class="lineNum">    4233 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">    4234 </span>            :   }
<span class="lineNum">    4235 </span><span class="lineCov">          1 :   CopyUTF16toUTF8(month, aResult);</span>
<span class="lineNum">    4236 </span>            : }
<span class="lineNum">    4237 </span>            : 
<a name="4238"><span class="lineNum">    4238 </span>            : // static</a>
<span class="lineNum">    4239 </span>            : void
<span class="lineNum">    4240 </span><span class="lineNoCov">          0 : nsNavHistory::GetMonthYear(const PRExplodedTime&amp; aTime, nsACString&amp; aResult)</span>
<span class="lineNum">    4241 </span>            : {
<span class="lineNum">    4242 </span><span class="lineNoCov">          0 :   nsAutoString monthYear;</span>
<span class="lineNum">    4243 </span>            :   nsresult rv = DateTimeFormat::FormatPRExplodedTime(kDateFormatYearMonthLong,
<span class="lineNum">    4244 </span>            :                                                      kTimeFormatNone,
<span class="lineNum">    4245 </span>            :                                                      &amp;aTime,
<span class="lineNum">    4246 </span><span class="lineNoCov">          0 :                                                      monthYear);</span>
<span class="lineNum">    4247 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    4248 </span><span class="lineNoCov">          0 :     aResult = nsPrintfCString(&quot;[%d-%d]&quot;, aTime.tm_month + 1, aTime.tm_year);</span>
<span class="lineNum">    4249 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    4250 </span>            :   }
<span class="lineNum">    4251 </span><span class="lineNoCov">          0 :   CopyUTF16toUTF8(monthYear, aResult);</span>
<span class="lineNum">    4252 </span>            : }
<span class="lineNum">    4253 </span>            : 
<span class="lineNum">    4254 </span>            : 
<span class="lineNum">    4255 </span>            : namespace {
<span class="lineNum">    4256 </span>            : 
<span class="lineNum">    4257 </span>            : // GetSimpleBookmarksQueryFolder
<span class="lineNum">    4258 </span>            : //
<span class="lineNum">    4259 </span>            : //    Determines if this set of queries is a simple bookmarks query for a
<span class="lineNum">    4260 </span>            : //    folder with no other constraints. In these common cases, we can more
<span class="lineNum">    4261 </span>            : //    efficiently compute the results.
<span class="lineNum">    4262 </span>            : //
<span class="lineNum">    4263 </span>            : //    A simple bookmarks query will result in a hierarchical tree of
<span class="lineNum">    4264 </span>            : //    bookmark items, folders and separators.
<span class="lineNum">    4265 </span>            : //
<a name="4266"><span class="lineNum">    4266 </span>            : //    Returns the folder ID if it is a simple folder query, 0 if not.</a>
<span class="lineNum">    4267 </span>            : static int64_t
<span class="lineNum">    4268 </span><span class="lineCov">          1 : GetSimpleBookmarksQueryFolder(const nsCOMArray&lt;nsNavHistoryQuery&gt;&amp; aQueries,</span>
<span class="lineNum">    4269 </span>            :                               nsNavHistoryQueryOptions* aOptions)
<span class="lineNum">    4270 </span>            : {
<span class="lineNum">    4271 </span><span class="lineCov">          1 :   if (aQueries.Count() != 1)</span>
<span class="lineNum">    4272 </span>            :     return 0;
<span class="lineNum">    4273 </span>            : 
<span class="lineNum">    4274 </span><span class="lineCov">          1 :   nsNavHistoryQuery* query = aQueries[0];</span>
<span class="lineNum">    4275 </span><span class="lineCov">          1 :   if (query-&gt;Folders().Length() != 1)</span>
<span class="lineNum">    4276 </span>            :     return 0;
<span class="lineNum">    4277 </span>            : 
<span class="lineNum">    4278 </span>            :   bool hasIt;
<span class="lineNum">    4279 </span><span class="lineCov">          1 :   query-&gt;GetHasBeginTime(&amp;hasIt);</span>
<span class="lineNum">    4280 </span><span class="lineCov">          1 :   if (hasIt)</span>
<span class="lineNum">    4281 </span>            :     return 0;
<span class="lineNum">    4282 </span><span class="lineCov">          1 :   query-&gt;GetHasEndTime(&amp;hasIt);</span>
<span class="lineNum">    4283 </span><span class="lineCov">          1 :   if (hasIt)</span>
<span class="lineNum">    4284 </span>            :     return 0;
<span class="lineNum">    4285 </span>            :   query-&gt;GetHasDomain(&amp;hasIt);
<span class="lineNum">    4286 </span><span class="lineCov">          1 :   if (hasIt)</span>
<span class="lineNum">    4287 </span>            :     return 0;
<span class="lineNum">    4288 </span>            :   query-&gt;GetHasUri(&amp;hasIt);
<span class="lineNum">    4289 </span><span class="lineCov">          1 :   if (hasIt)</span>
<span class="lineNum">    4290 </span>            :     return 0;
<span class="lineNum">    4291 </span>            :   (void)query-&gt;GetHasSearchTerms(&amp;hasIt);
<span class="lineNum">    4292 </span><span class="lineCov">          1 :   if (hasIt)</span>
<span class="lineNum">    4293 </span>            :     return 0;
<span class="lineNum">    4294 </span><span class="lineCov">          1 :   if (query-&gt;Tags().Length() &gt; 0)</span>
<span class="lineNum">    4295 </span>            :     return 0;
<span class="lineNum">    4296 </span><span class="lineCov">          1 :   if (aOptions-&gt;MaxResults() &gt; 0)</span>
<span class="lineNum">    4297 </span>            :     return 0;
<span class="lineNum">    4298 </span>            : 
<span class="lineNum">    4299 </span>            :   // RESULTS_AS_TAG_CONTENTS is quite similar to a folder shortcut, but it must
<span class="lineNum">    4300 </span>            :   // not be treated like that, since it needs all query options.
<span class="lineNum">    4301 </span><span class="lineCov">          1 :   if(aOptions-&gt;ResultType() == nsINavHistoryQueryOptions::RESULTS_AS_TAG_CONTENTS)</span>
<span class="lineNum">    4302 </span>            :     return 0;
<span class="lineNum">    4303 </span>            : 
<span class="lineNum">    4304 </span>            :   // Don't care about onlyBookmarked flag, since specifying a bookmark
<span class="lineNum">    4305 </span>            :   // folder is inferring onlyBookmarked.
<span class="lineNum">    4306 </span>            : 
<span class="lineNum">    4307 </span><span class="lineCov">          1 :   return query-&gt;Folders()[0];</span>
<span class="lineNum">    4308 </span>            : }
<span class="lineNum">    4309 </span>            : 
<span class="lineNum">    4310 </span>            : 
<span class="lineNum">    4311 </span>            : // ParseSearchTermsFromQueries
<span class="lineNum">    4312 </span>            : //
<span class="lineNum">    4313 </span>            : //    Construct a matrix of search terms from the given queries array.
<span class="lineNum">    4314 </span>            : //    All of the query objects are ORed together. Within a query, all the terms
<span class="lineNum">    4315 </span>            : //    are ANDed together. See nsINavHistoryService.idl.
<span class="lineNum">    4316 </span>            : //
<span class="lineNum">    4317 </span>            : //    This just breaks the query up into words. We don't do anything fancy,
<span class="lineNum">    4318 </span>            : //    not even quoting. We do, however, strip quotes, because people might
<span class="lineNum">    4319 </span>            : //    try to input quotes expecting them to do something and get no results
<span class="lineNum">    4320 </span>            : //    back.
<span class="lineNum">    4321 </span>            : 
<span class="lineNum">    4322 </span>            : inline bool isQueryWhitespace(char16_t ch)
<span class="lineNum">    4323 </span>            : {
<span class="lineNum">    4324 </span>            :   return ch == ' ';
<a name="4325"><span class="lineNum">    4325 </span>            : }</a>
<span class="lineNum">    4326 </span>            : 
<span class="lineNum">    4327 </span><span class="lineCov">          1 : void ParseSearchTermsFromQueries(const nsCOMArray&lt;nsNavHistoryQuery&gt;&amp; aQueries,</span>
<span class="lineNum">    4328 </span>            :                                  nsTArray&lt;nsTArray&lt;nsString&gt;*&gt;* aTerms)
<span class="lineNum">    4329 </span>            : {
<span class="lineNum">    4330 </span><span class="lineCov">          1 :   int32_t lastBegin = -1;</span>
<span class="lineNum">    4331 </span><span class="lineCov">          1 :   for (int32_t i = 0; i &lt; aQueries.Count(); i++) {</span>
<span class="lineNum">    4332 </span><span class="lineCov">          1 :     nsTArray&lt;nsString&gt; *queryTerms = new nsTArray&lt;nsString&gt;();</span>
<span class="lineNum">    4333 </span>            :     bool hasSearchTerms;
<span class="lineNum">    4334 </span><span class="lineCov">          1 :     if (NS_SUCCEEDED(aQueries[i]-&gt;GetHasSearchTerms(&amp;hasSearchTerms)) &amp;&amp;</span>
<span class="lineNum">    4335 </span>            :         hasSearchTerms) {
<span class="lineNum">    4336 </span>            :       const nsString&amp; searchTerms = aQueries[i]-&gt;SearchTerms();
<span class="lineNum">    4337 </span><span class="lineCov">          1 :       for (uint32_t j = 0; j &lt; searchTerms.Length(); j++) {</span>
<span class="lineNum">    4338 </span><span class="lineCov">          1 :         if (isQueryWhitespace(searchTerms[j]) ||</span>
<span class="lineNum">    4339 </span>            :             searchTerms[j] == '&quot;') {
<span class="lineNum">    4340 </span><span class="lineNoCov">          0 :           if (lastBegin &gt;= 0) {</span>
<span class="lineNum">    4341 </span>            :             // found the end of a word
<span class="lineNum">    4342 </span>            :             queryTerms-&gt;AppendElement(Substring(searchTerms, lastBegin,
<span class="lineNum">    4343 </span><span class="lineNoCov">          0 :                                                j - lastBegin));</span>
<span class="lineNum">    4344 </span><span class="lineNoCov">          0 :             lastBegin = -1;</span>
<span class="lineNum">    4345 </span>            :           }
<span class="lineNum">    4346 </span>            :         } else {
<span class="lineNum">    4347 </span><span class="lineCov">          1 :           if (lastBegin &lt; 0) {</span>
<span class="lineNum">    4348 </span>            :             // found the beginning of a word
<span class="lineNum">    4349 </span><span class="lineCov">          1 :             lastBegin = j;</span>
<span class="lineNum">    4350 </span>            :           }
<span class="lineNum">    4351 </span>            :         }
<span class="lineNum">    4352 </span>            :       }
<span class="lineNum">    4353 </span>            :       // last word
<span class="lineNum">    4354 </span><span class="lineCov">          1 :       if (lastBegin &gt;= 0)</span>
<span class="lineNum">    4355 </span><span class="lineCov">          1 :         queryTerms-&gt;AppendElement(Substring(searchTerms, lastBegin));</span>
<span class="lineNum">    4356 </span>            :     }
<span class="lineNum">    4357 </span><span class="lineCov">          1 :     aTerms-&gt;AppendElement(queryTerms);</span>
<span class="lineNum">    4358 </span>            :   }
<span class="lineNum">    4359 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    4360 </span>            : 
<span class="lineNum">    4361 </span>            : } // namespace
<span class="lineNum">    4362 </span>            : 
<a name="4363"><span class="lineNum">    4363 </span>            : </a>
<span class="lineNum">    4364 </span>            : nsresult
<span class="lineNum">    4365 </span><span class="lineCov">          1 : nsNavHistory::UpdateFrecency(int64_t aPlaceId)</span>
<span class="lineNum">    4366 </span>            : {
<span class="lineNum">    4367 </span>            :   nsCOMPtr&lt;mozIStorageAsyncStatement&gt; updateFrecencyStmt = mDB-&gt;GetAsyncStatement(
<span class="lineNum">    4368 </span>            :     &quot;UPDATE moz_places &quot;
<span class="lineNum">    4369 </span>            :     &quot;SET frecency = NOTIFY_FRECENCY(&quot;
<span class="lineNum">    4370 </span>            :       &quot;CALCULATE_FRECENCY(:page_id), url, guid, hidden, last_visit_date&quot;
<span class="lineNum">    4371 </span>            :     &quot;) &quot;
<span class="lineNum">    4372 </span>            :     &quot;WHERE id = :page_id&quot;
<span class="lineNum">    4373 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    4374 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(updateFrecencyStmt);</span>
<span class="lineNum">    4375 </span>            :   nsresult rv = updateFrecencyStmt-&gt;BindInt64ByName(NS_LITERAL_CSTRING(&quot;page_id&quot;),
<span class="lineNum">    4376 </span><span class="lineCov">          1 :                                                     aPlaceId);</span>
<span class="lineNum">    4377 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4378 </span>            :   nsCOMPtr&lt;mozIStorageAsyncStatement&gt; updateHiddenStmt = mDB-&gt;GetAsyncStatement(
<span class="lineNum">    4379 </span>            :     &quot;UPDATE moz_places &quot;
<span class="lineNum">    4380 </span>            :     &quot;SET hidden = 0 &quot;
<span class="lineNum">    4381 </span>            :     &quot;WHERE id = :page_id AND frecency &lt;&gt; 0&quot;
<span class="lineNum">    4382 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    4383 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(updateHiddenStmt);</span>
<span class="lineNum">    4384 </span>            :   rv = updateHiddenStmt-&gt;BindInt64ByName(NS_LITERAL_CSTRING(&quot;page_id&quot;),
<span class="lineNum">    4385 </span><span class="lineCov">          1 :                                          aPlaceId);</span>
<span class="lineNum">    4386 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4387 </span>            : 
<span class="lineNum">    4388 </span>            :   mozIStorageBaseStatement *stmts[] = {
<span class="lineNum">    4389 </span>            :     updateFrecencyStmt.get()
<span class="lineNum">    4390 </span>            :   , updateHiddenStmt.get()
<span class="lineNum">    4391 </span><span class="lineCov">          1 :   };</span>
<span class="lineNum">    4392 </span>            : 
<span class="lineNum">    4393 </span>            :   RefPtr&lt;AsyncStatementCallbackNotifier&gt; cb =
<span class="lineNum">    4394 </span><span class="lineCov">          1 :     new AsyncStatementCallbackNotifier(TOPIC_FRECENCY_UPDATED);</span>
<span class="lineNum">    4395 </span>            :   nsCOMPtr&lt;mozIStoragePendingStatement&gt; ps;
<span class="lineNum">    4396 </span><span class="lineCov">          1 :   rv = mDB-&gt;MainConn()-&gt;ExecuteAsync(stmts, ArrayLength(stmts), cb,</span>
<span class="lineNum">    4397 </span><span class="lineCov">          1 :                                      getter_AddRefs(ps));</span>
<span class="lineNum">    4398 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4399 </span>            : 
<span class="lineNum">    4400 </span>            :   return NS_OK;
<span class="lineNum">    4401 </span>            : }
<span class="lineNum">    4402 </span>            : 
<span class="lineNum">    4403 </span>            : 
<a name="4404"><span class="lineNum">    4404 </span>            : namespace {</a>
<span class="lineNum">    4405 </span>            : 
<span class="lineNum">    4406 </span><span class="lineCov">          1 : class FixInvalidFrecenciesCallback : public AsyncStatementCallbackNotifier</span>
<a name="4407"><span class="lineNum">    4407 </span>            : {</a>
<span class="lineNum">    4408 </span>            : public:
<span class="lineNum">    4409 </span><span class="lineCov">          1 :   FixInvalidFrecenciesCallback()</span>
<span class="lineNum">    4410 </span><span class="lineCov">          1 :     : AsyncStatementCallbackNotifier(TOPIC_FRECENCY_UPDATED)</span>
<span class="lineNum">    4411 </span>            :   {
<a name="4412"><span class="lineNum">    4412 </span><span class="lineCov">          1 :   }</span></a>
<span class="lineNum">    4413 </span>            : 
<span class="lineNum">    4414 </span><span class="lineCov">          1 :   NS_IMETHOD HandleCompletion(uint16_t aReason)</span>
<span class="lineNum">    4415 </span>            :   {
<span class="lineNum">    4416 </span><span class="lineCov">          1 :     nsresult rv = AsyncStatementCallbackNotifier::HandleCompletion(aReason);</span>
<span class="lineNum">    4417 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4418 </span><span class="lineCov">          1 :     if (aReason == REASON_FINISHED) {</span>
<span class="lineNum">    4419 </span><span class="lineCov">          1 :       nsNavHistory *navHistory = nsNavHistory::GetHistoryService();</span>
<span class="lineNum">    4420 </span><span class="lineCov">          1 :       NS_ENSURE_STATE(navHistory);</span>
<span class="lineNum">    4421 </span><span class="lineCov">          1 :       navHistory-&gt;NotifyManyFrecenciesChanged();</span>
<span class="lineNum">    4422 </span>            :     }
<span class="lineNum">    4423 </span>            :     return NS_OK;
<span class="lineNum">    4424 </span>            :   }
<span class="lineNum">    4425 </span>            : };
<span class="lineNum">    4426 </span>            : 
<span class="lineNum">    4427 </span>            : } // namespace
<a name="4428"><span class="lineNum">    4428 </span>            : </a>
<span class="lineNum">    4429 </span>            : nsresult
<span class="lineNum">    4430 </span><span class="lineCov">          1 : nsNavHistory::FixInvalidFrecencies()</span>
<span class="lineNum">    4431 </span>            : {
<span class="lineNum">    4432 </span>            :   nsCOMPtr&lt;mozIStorageAsyncStatement&gt; stmt = mDB-&gt;GetAsyncStatement(
<span class="lineNum">    4433 </span>            :     &quot;UPDATE moz_places &quot;
<span class="lineNum">    4434 </span>            :     &quot;SET frecency = CALCULATE_FRECENCY(id) &quot;
<span class="lineNum">    4435 </span>            :     &quot;WHERE frecency &lt; 0&quot;
<span class="lineNum">    4436 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    4437 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(stmt);</span>
<span class="lineNum">    4438 </span>            : 
<span class="lineNum">    4439 </span>            :   RefPtr&lt;FixInvalidFrecenciesCallback&gt; callback =
<span class="lineNum">    4440 </span><span class="lineCov">          1 :     new FixInvalidFrecenciesCallback();</span>
<span class="lineNum">    4441 </span>            :   nsCOMPtr&lt;mozIStoragePendingStatement&gt; ps;
<span class="lineNum">    4442 </span><span class="lineCov">          1 :   (void)stmt-&gt;ExecuteAsync(callback, getter_AddRefs(ps));</span>
<span class="lineNum">    4443 </span>            : 
<span class="lineNum">    4444 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">    4445 </span>            : }
<span class="lineNum">    4446 </span>            : 
<span class="lineNum">    4447 </span>            : 
<span class="lineNum">    4448 </span>            : #ifdef MOZ_XUL
<a name="4449"><span class="lineNum">    4449 </span>            : </a>
<span class="lineNum">    4450 </span>            : nsresult
<span class="lineNum">    4451 </span><span class="lineCov">          1 : nsNavHistory::AutoCompleteFeedback(int32_t aIndex,</span>
<span class="lineNum">    4452 </span>            :                                    nsIAutoCompleteController *aController)
<span class="lineNum">    4453 </span>            : {
<span class="lineNum">    4454 </span>            :   nsCOMPtr&lt;mozIStorageAsyncStatement&gt; stmt = mDB-&gt;GetAsyncStatement(
<span class="lineNum">    4455 </span>            :     &quot;INSERT OR REPLACE INTO moz_inputhistory &quot;
<span class="lineNum">    4456 </span>            :     // use_count will asymptotically approach the max of 10.
<span class="lineNum">    4457 </span>            :     &quot;SELECT h.id, IFNULL(i.input, :input_text), IFNULL(i.use_count, 0) * .9 + 1 &quot;
<span class="lineNum">    4458 </span>            :     &quot;FROM moz_places h &quot;
<span class="lineNum">    4459 </span>            :     &quot;LEFT JOIN moz_inputhistory i ON i.place_id = h.id AND i.input = :input_text &quot;
<span class="lineNum">    4460 </span>            :     &quot;WHERE url_hash = hash(:page_url) AND url = :page_url &quot;
<span class="lineNum">    4461 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    4462 </span><span class="lineCov">          1 :   NS_ENSURE_STATE(stmt);</span>
<span class="lineNum">    4463 </span>            : 
<span class="lineNum">    4464 </span><span class="lineCov">          1 :   nsAutoString input;</span>
<span class="lineNum">    4465 </span><span class="lineCov">          1 :   nsresult rv = aController-&gt;GetSearchString(input);</span>
<span class="lineNum">    4466 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4467 </span><span class="lineCov">          1 :   rv = stmt-&gt;BindStringByName(NS_LITERAL_CSTRING(&quot;input_text&quot;), input);</span>
<span class="lineNum">    4468 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4469 </span>            : 
<span class="lineNum">    4470 </span><span class="lineCov">          1 :   nsAutoString url;</span>
<span class="lineNum">    4471 </span><span class="lineCov">          1 :   rv = aController-&gt;GetValueAt(aIndex, url);</span>
<span class="lineNum">    4472 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4473 </span>            :   rv = URIBinder::Bind(stmt, NS_LITERAL_CSTRING(&quot;page_url&quot;),
<span class="lineNum">    4474 </span><span class="lineCov">          1 :                        NS_ConvertUTF16toUTF8(url));</span>
<span class="lineNum">    4475 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4476 </span>            : 
<span class="lineNum">    4477 </span>            :   // We do the update asynchronously and we do not care about failures.
<span class="lineNum">    4478 </span>            :   RefPtr&lt;AsyncStatementCallbackNotifier&gt; callback =
<span class="lineNum">    4479 </span><span class="lineCov">          1 :     new AsyncStatementCallbackNotifier(TOPIC_AUTOCOMPLETE_FEEDBACK_UPDATED);</span>
<span class="lineNum">    4480 </span>            :   nsCOMPtr&lt;mozIStoragePendingStatement&gt; canceler;
<span class="lineNum">    4481 </span><span class="lineCov">          1 :   rv = stmt-&gt;ExecuteAsync(callback, getter_AddRefs(canceler));</span>
<span class="lineNum">    4482 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4483 </span>            : 
<span class="lineNum">    4484 </span>            :   return NS_OK;
<span class="lineNum">    4485 </span>            : }
<span class="lineNum">    4486 </span>            : 
<span class="lineNum">    4487 </span>            : #endif
<span class="lineNum">    4488 </span>            : 
<a name="4489"><span class="lineNum">    4489 </span>            : </a>
<span class="lineNum">    4490 </span>            : nsICollation *
<span class="lineNum">    4491 </span><span class="lineCov">          1 : nsNavHistory::GetCollation()</span>
<span class="lineNum">    4492 </span>            : {
<span class="lineNum">    4493 </span><span class="lineCov">          1 :   if (mCollation)</span>
<span class="lineNum">    4494 </span>            :     return mCollation;
<span class="lineNum">    4495 </span>            : 
<span class="lineNum">    4496 </span>            :   // collation
<span class="lineNum">    4497 </span>            :   nsCOMPtr&lt;nsICollationFactory&gt; cfact =
<span class="lineNum">    4498 </span><span class="lineCov">          1 :     do_CreateInstance(NS_COLLATIONFACTORY_CONTRACTID);</span>
<span class="lineNum">    4499 </span><span class="lineCov">          1 :   NS_ENSURE_TRUE(cfact, nullptr);</span>
<span class="lineNum">    4500 </span><span class="lineCov">          1 :   nsresult rv = cfact-&gt;CreateCollation(getter_AddRefs(mCollation));</span>
<span class="lineNum">    4501 </span><span class="lineCov">          1 :   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<span class="lineNum">    4502 </span>            : 
<span class="lineNum">    4503 </span><span class="lineCov">          1 :   return mCollation;</span>
<span class="lineNum">    4504 </span>            : }
<a name="4505"><span class="lineNum">    4505 </span>            : </a>
<span class="lineNum">    4506 </span>            : nsIStringBundle *
<span class="lineNum">    4507 </span><span class="lineCov">          1 : nsNavHistory::GetBundle()</span>
<span class="lineNum">    4508 </span>            : {
<span class="lineNum">    4509 </span><span class="lineCov">          1 :   if (!mBundle) {</span>
<span class="lineNum">    4510 </span>            :     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =
<span class="lineNum">    4511 </span><span class="lineCov">          1 :       services::GetStringBundleService();</span>
<span class="lineNum">    4512 </span><span class="lineCov">          1 :     NS_ENSURE_TRUE(bundleService, nullptr);</span>
<span class="lineNum">    4513 </span>            :     nsresult rv = bundleService-&gt;CreateBundle(
<span class="lineNum">    4514 </span>            :         &quot;chrome://places/locale/places.properties&quot;,
<span class="lineNum">    4515 </span><span class="lineCov">          1 :         getter_AddRefs(mBundle));</span>
<span class="lineNum">    4516 </span><span class="lineCov">          1 :     NS_ENSURE_SUCCESS(rv, nullptr);</span>
<span class="lineNum">    4517 </span>            :   }
<span class="lineNum">    4518 </span><span class="lineCov">          1 :   return mBundle;</span>
<span class="lineNum">    4519 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
