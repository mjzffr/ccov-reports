<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - security/nss/lib/freebl/jpake.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">security/nss/lib/freebl</a> - jpake.c<span style="font-size: 80%;"> (source / <a href="jpake.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">267</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21 12:59:10</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">7</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public</a>
<span class="lineNum">       2 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       3 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       4 </span>            : 
<span class="lineNum">       5 </span>            : #ifdef FREEBL_NO_DEPEND
<span class="lineNum">       6 </span>            : #include &quot;stubs.h&quot;
<span class="lineNum">       7 </span>            : #endif
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : #include &quot;blapi.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;secerr.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;secitem.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;secmpi.h&quot;
<span class="lineNum">      13 </span>            : 
<span class="lineNum">      14 </span>            : /* Hash an item's length and then its value. Only items smaller than 2^16 bytes
<span class="lineNum">      15 </span>            :  * are allowed. Lengths are hashed in network byte order. This is designed
<span class="lineNum">      16 </span>            :  * to match the OpenSSL J-PAKE implementation.
<a name="17"><span class="lineNum">      17 </span>            :  */</a>
<span class="lineNum">      18 </span>            : static mp_err
<span class="lineNum">      19 </span><span class="lineNoCov">          0 : hashSECItem(HASHContext *hash, const SECItem *it)</span>
<span class="lineNum">      20 </span>            : {
<span class="lineNum">      21 </span>            :     unsigned char length[2];
<span class="lineNum">      22 </span>            : 
<span class="lineNum">      23 </span><span class="lineNoCov">          0 :     if (it-&gt;len &gt; 0xffff)</span>
<span class="lineNum">      24 </span>            :         return MP_BADARG;
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span><span class="lineNoCov">          0 :     length[0] = (unsigned char)(it-&gt;len &gt;&gt; 8);</span>
<span class="lineNum">      27 </span><span class="lineNoCov">          0 :     length[1] = (unsigned char)(it-&gt;len);</span>
<span class="lineNum">      28 </span><span class="lineNoCov">          0 :     hash-&gt;hashobj-&gt;update(hash-&gt;hash_context, length, 2);</span>
<span class="lineNum">      29 </span><span class="lineNoCov">          0 :     hash-&gt;hashobj-&gt;update(hash-&gt;hash_context, it-&gt;data, it-&gt;len);</span>
<span class="lineNum">      30 </span><span class="lineNoCov">          0 :     return MP_OKAY;</span>
<span class="lineNum">      31 </span>            : }
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : /* Hash all public components of the signature, each prefixed with its
<a name="34"><span class="lineNum">      34 </span>            :    length, and then convert the hash to an mp_int. */</a>
<span class="lineNum">      35 </span>            : static mp_err
<span class="lineNum">      36 </span><span class="lineNoCov">          0 : hashPublicParams(HASH_HashType hashType, const SECItem *g,</span>
<span class="lineNum">      37 </span>            :                  const SECItem *gv, const SECItem *gx,
<span class="lineNum">      38 </span>            :                  const SECItem *signerID, mp_int *h)
<span class="lineNum">      39 </span>            : {
<span class="lineNum">      40 </span>            :     mp_err err;
<span class="lineNum">      41 </span>            :     unsigned char hBuf[HASH_LENGTH_MAX];
<span class="lineNum">      42 </span>            :     SECItem hItem;
<span class="lineNum">      43 </span>            :     HASHContext hash;
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span><span class="lineNoCov">          0 :     hash.hashobj = HASH_GetRawHashObject(hashType);</span>
<span class="lineNum">      46 </span><span class="lineNoCov">          0 :     if (hash.hashobj == NULL || hash.hashobj-&gt;length &gt; sizeof hBuf) {</span>
<span class="lineNum">      47 </span>            :         return MP_BADARG;
<span class="lineNum">      48 </span>            :     }
<span class="lineNum">      49 </span><span class="lineNoCov">          0 :     hash.hash_context = hash.hashobj-&gt;create();</span>
<span class="lineNum">      50 </span><span class="lineNoCov">          0 :     if (hash.hash_context == NULL) {</span>
<span class="lineNum">      51 </span>            :         return MP_MEM;
<span class="lineNum">      52 </span>            :     }
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :     hItem.data = hBuf;</span>
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :     hItem.len = hash.hashobj-&gt;length;</span>
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span><span class="lineNoCov">          0 :     hash.hashobj-&gt;begin(hash.hash_context);</span>
<span class="lineNum">      58 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(hashSECItem(&amp;hash, g));</span>
<span class="lineNum">      59 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(hashSECItem(&amp;hash, gv));</span>
<span class="lineNum">      60 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(hashSECItem(&amp;hash, gx));</span>
<span class="lineNum">      61 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(hashSECItem(&amp;hash, signerID));</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :     hash.hashobj-&gt;end(hash.hash_context, hItem.data, &amp;hItem.len,</span>
<span class="lineNum">      63 </span>            :                       sizeof hBuf);
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(hItem, h);</span>
<span class="lineNum">      65 </span>            : 
<span class="lineNum">      66 </span>            : cleanup:
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :     if (hash.hash_context != NULL) {</span>
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :         hash.hashobj-&gt;destroy(hash.hash_context, PR_TRUE);</span>
<span class="lineNum">      69 </span>            :     }
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span><span class="lineNoCov">          0 :     return err;</span>
<span class="lineNum">      72 </span>            : }
<span class="lineNum">      73 </span>            : 
<a name="74"><span class="lineNum">      74 </span>            : /* Generate a Schnorr signature for round 1 or round 2 */</a>
<span class="lineNum">      75 </span>            : SECStatus
<span class="lineNum">      76 </span><span class="lineNoCov">          0 : JPAKE_Sign(PLArenaPool *arena, const PQGParams *pqg, HASH_HashType hashType,</span>
<span class="lineNum">      77 </span>            :            const SECItem *signerID, const SECItem *x,
<span class="lineNum">      78 </span>            :            const SECItem *testRandom, const SECItem *gxIn, SECItem *gxOut,
<span class="lineNum">      79 </span>            :            SECItem *gv, SECItem *r)
<span class="lineNum">      80 </span>            : {
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :     SECStatus rv = SECSuccess;</span>
<span class="lineNum">      82 </span>            :     mp_err err;
<span class="lineNum">      83 </span>            :     mp_int p;
<span class="lineNum">      84 </span>            :     mp_int q;
<span class="lineNum">      85 </span>            :     mp_int g;
<span class="lineNum">      86 </span>            :     mp_int X;
<span class="lineNum">      87 </span>            :     mp_int GX;
<span class="lineNum">      88 </span>            :     mp_int V;
<span class="lineNum">      89 </span>            :     mp_int GV;
<span class="lineNum">      90 </span>            :     mp_int h;
<span class="lineNum">      91 </span>            :     mp_int tmp;
<span class="lineNum">      92 </span>            :     mp_int R;
<span class="lineNum">      93 </span>            :     SECItem v;
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :     if (!arena ||</span>
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :         !pqg || !pqg-&gt;prime.data || pqg-&gt;prime.len == 0 ||</span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :         !pqg-&gt;subPrime.data || pqg-&gt;subPrime.len == 0 ||</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :         !pqg-&gt;base.data || pqg-&gt;base.len == 0 ||</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :         !signerID || !signerID-&gt;data || signerID-&gt;len == 0 ||</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :         !x || !x-&gt;data || x-&gt;len == 0 ||</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :         (testRandom &amp;&amp; (!testRandom-&gt;data || testRandom-&gt;len == 0)) ||</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :         (gxIn == NULL &amp;&amp; (!gxOut || gxOut-&gt;data != NULL)) ||</span>
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :         (gxIn != NULL &amp;&amp; (!gxIn-&gt;data || gxIn-&gt;len == 0 || gxOut != NULL)) ||</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :         !gv || gv-&gt;data != NULL ||</span>
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :         !r || r-&gt;data != NULL) {</span>
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :         PORT_SetError(SEC_ERROR_INVALID_ARGS);</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :         return SECFailure;</span>
<span class="lineNum">     108 </span>            :     }
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;p) = 0;</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;q) = 0;</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;g) = 0;</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;X) = 0;</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;GX) = 0;</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;V) = 0;</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;GV) = 0;</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;h) = 0;</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;tmp) = 0;</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;R) = 0;</span>
<span class="lineNum">     120 </span>            : 
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;p));</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;q));</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;g));</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;X));</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;GX));</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;V));</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;GV));</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;h));</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;tmp));</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;R));</span>
<span class="lineNum">     131 </span>            : 
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(pqg-&gt;prime, &amp;p);</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(pqg-&gt;subPrime, &amp;q);</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(pqg-&gt;base, &amp;g);</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(*x, &amp;X);</span>
<span class="lineNum">     136 </span>            : 
<span class="lineNum">     137 </span>            :     /* gx = g^x */
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :     if (gxIn == NULL) {</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :         CHECK_MPI_OK(mp_exptmod(&amp;g, &amp;X, &amp;p, &amp;GX));</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :         MPINT_TO_SECITEM(&amp;GX, gxOut, arena);</span>
<span class="lineNum">     141 </span>            :         gxIn = gxOut;
<span class="lineNum">     142 </span>            :     } else {
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :         SECITEM_TO_MPINT(*gxIn, &amp;GX);</span>
<span class="lineNum">     144 </span>            :     }
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span>            :     /* v is a random value in the q subgroup */
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :     if (testRandom == NULL) {</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :         v.data = NULL;</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :         rv = DSA_NewRandom(arena, &amp;pqg-&gt;subPrime, &amp;v);</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :         if (rv != SECSuccess) {</span>
<span class="lineNum">     151 </span>            :             goto cleanup;
<span class="lineNum">     152 </span>            :         }
<span class="lineNum">     153 </span>            :     } else {
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :         v.data = testRandom-&gt;data;</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :         v.len = testRandom-&gt;len;</span>
<span class="lineNum">     156 </span>            :     }
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(v, &amp;V);</span>
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span>            :     /* gv = g^v (mod q), random v, 1 &lt;= v &lt; q */
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_exptmod(&amp;g, &amp;V, &amp;p, &amp;GV));</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :     MPINT_TO_SECITEM(&amp;GV, gv, arena);</span>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span>            :     /* h = H(g, gv, gx, signerID) */
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(hashPublicParams(hashType, &amp;pqg-&gt;base, gv, gxIn, signerID,</span>
<span class="lineNum">     165 </span>            :                                   &amp;h));
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span>            :     /* r = v - x*h (mod q) */
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_mulmod(&amp;X, &amp;h, &amp;q, &amp;tmp));</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_submod(&amp;V, &amp;tmp, &amp;q, &amp;R));</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :     MPINT_TO_SECITEM(&amp;R, r, arena);</span>
<span class="lineNum">     171 </span>            : 
<span class="lineNum">     172 </span>            : cleanup:
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :     mp_clear(&amp;p);</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :     mp_clear(&amp;q);</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     mp_clear(&amp;g);</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :     mp_clear(&amp;X);</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :     mp_clear(&amp;GX);</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :     mp_clear(&amp;V);</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :     mp_clear(&amp;GV);</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :     mp_clear(&amp;h);</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :     mp_clear(&amp;tmp);</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :     mp_clear(&amp;R);</span>
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :     if (rv == SECSuccess &amp;&amp; err != MP_OKAY) {</span>
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :         MP_TO_SEC_ERROR(err);</span>
<span class="lineNum">     186 </span>            :         rv = SECFailure;
<span class="lineNum">     187 </span>            :     }
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">     189 </span>            : }
<span class="lineNum">     190 </span>            : 
<a name="191"><span class="lineNum">     191 </span>            : /* Verify a Schnorr signature generated by the peer in round 1 or round 2. */</a>
<span class="lineNum">     192 </span>            : SECStatus
<span class="lineNum">     193 </span><span class="lineNoCov">          0 : JPAKE_Verify(PLArenaPool *arena, const PQGParams *pqg, HASH_HashType hashType,</span>
<span class="lineNum">     194 </span>            :              const SECItem *signerID, const SECItem *peerID,
<span class="lineNum">     195 </span>            :              const SECItem *gx, const SECItem *gv, const SECItem *r)
<span class="lineNum">     196 </span>            : {
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :     SECStatus rv = SECSuccess;</span>
<span class="lineNum">     198 </span>            :     mp_err err;
<span class="lineNum">     199 </span>            :     mp_int p;
<span class="lineNum">     200 </span>            :     mp_int q;
<span class="lineNum">     201 </span>            :     mp_int g;
<span class="lineNum">     202 </span>            :     mp_int p_minus_1;
<span class="lineNum">     203 </span>            :     mp_int GX;
<span class="lineNum">     204 </span>            :     mp_int h;
<span class="lineNum">     205 </span>            :     mp_int one;
<span class="lineNum">     206 </span>            :     mp_int R;
<span class="lineNum">     207 </span>            :     mp_int gr;
<span class="lineNum">     208 </span>            :     mp_int gxh;
<span class="lineNum">     209 </span>            :     mp_int gr_gxh;
<span class="lineNum">     210 </span>            :     SECItem calculated;
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :     if (!arena ||</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :         !pqg || !pqg-&gt;prime.data || pqg-&gt;prime.len == 0 ||</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :         !pqg-&gt;subPrime.data || pqg-&gt;subPrime.len == 0 ||</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :         !pqg-&gt;base.data || pqg-&gt;base.len == 0 ||</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :         !signerID || !signerID-&gt;data || signerID-&gt;len == 0 ||</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :         !peerID || !peerID-&gt;data || peerID-&gt;len == 0 ||</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :         !gx || !gx-&gt;data || gx-&gt;len == 0 ||</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :         !gv || !gv-&gt;data || gv-&gt;len == 0 ||</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :         !r || !r-&gt;data || r-&gt;len == 0 ||</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :         SECITEM_CompareItem(signerID, peerID) == SECEqual) {</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :         PORT_SetError(SEC_ERROR_INVALID_ARGS);</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :         return SECFailure;</span>
<span class="lineNum">     224 </span>            :     }
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;p) = 0;</span>
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;q) = 0;</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;g) = 0;</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;p_minus_1) = 0;</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;GX) = 0;</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;h) = 0;</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;one) = 0;</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;R) = 0;</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;gr) = 0;</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;gxh) = 0;</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;gr_gxh) = 0;</span>
<span class="lineNum">     237 </span><span class="lineNoCov">          0 :     calculated.data = NULL;</span>
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;p));</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;q));</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;g));</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;p_minus_1));</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;GX));</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;h));</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;one));</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;R));</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;gr));</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;gxh));</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;gr_gxh));</span>
<span class="lineNum">     250 </span>            : 
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(pqg-&gt;prime, &amp;p);</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(pqg-&gt;subPrime, &amp;q);</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(pqg-&gt;base, &amp;g);</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(*gx, &amp;GX);</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(*r, &amp;R);</span>
<span class="lineNum">     256 </span>            : 
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_sub_d(&amp;p, 1, &amp;p_minus_1));</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_exptmod(&amp;GX, &amp;q, &amp;p, &amp;one));</span>
<span class="lineNum">     259 </span>            :     /* Check g^x is in [1, p-2], R is in [0, q-1], and (g^x)^q mod p == 1 */
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :     if (!(mp_cmp_z(&amp;GX) &gt; 0 &amp;&amp;</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :           mp_cmp(&amp;GX, &amp;p_minus_1) &lt; 0 &amp;&amp;</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :           mp_cmp(&amp;R, &amp;q) &lt; 0 &amp;&amp;</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :           mp_cmp_d(&amp;one, 1) == 0)) {</span>
<span class="lineNum">     264 </span>            :         goto badSig;
<span class="lineNum">     265 </span>            :     }
<span class="lineNum">     266 </span>            : 
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(hashPublicParams(hashType, &amp;pqg-&gt;base, gv, gx, peerID,</span>
<span class="lineNum">     268 </span>            :                                   &amp;h));
<span class="lineNum">     269 </span>            : 
<span class="lineNum">     270 </span>            :     /* Calculate g^v = g^r * g^x^h */
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_exptmod(&amp;g, &amp;R, &amp;p, &amp;gr));</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_exptmod(&amp;GX, &amp;h, &amp;p, &amp;gxh));</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_mulmod(&amp;gr, &amp;gxh, &amp;p, &amp;gr_gxh));</span>
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span>            :     /* Compare calculated g^v to given g^v */
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :     MPINT_TO_SECITEM(&amp;gr_gxh, &amp;calculated, arena);</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :     if (calculated.len == gv-&gt;len &amp;&amp;</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :         NSS_SecureMemcmp(calculated.data, gv-&gt;data, calculated.len) == 0) {</span>
<span class="lineNum">     279 </span>            :         rv = SECSuccess;
<span class="lineNum">     280 </span>            :     } else {
<span class="lineNum">     281 </span>            :     badSig:
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :         PORT_SetError(SEC_ERROR_BAD_SIGNATURE);</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :         rv = SECFailure;</span>
<span class="lineNum">     284 </span>            :     }
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span>            : cleanup:
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :     mp_clear(&amp;p);</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :     mp_clear(&amp;q);</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :     mp_clear(&amp;g);</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :     mp_clear(&amp;p_minus_1);</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :     mp_clear(&amp;GX);</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :     mp_clear(&amp;h);</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :     mp_clear(&amp;one);</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :     mp_clear(&amp;R);</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :     mp_clear(&amp;gr);</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :     mp_clear(&amp;gxh);</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :     mp_clear(&amp;gr_gxh);</span>
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :     if (rv == SECSuccess &amp;&amp; err != MP_OKAY) {</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :         MP_TO_SEC_ERROR(err);</span>
<span class="lineNum">     301 </span>            :         rv = SECFailure;
<span class="lineNum">     302 </span>            :     }
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">     304 </span>            : }
<span class="lineNum">     305 </span>            : 
<a name="306"><span class="lineNum">     306 </span>            : /* Calculate base = gx1*gx3*gx4 (mod p), i.e. g^(x1+x3+x4) (mod p) */</a>
<span class="lineNum">     307 </span>            : static mp_err
<span class="lineNum">     308 </span><span class="lineNoCov">          0 : jpake_Round2Base(const SECItem *gx1, const SECItem *gx3,</span>
<span class="lineNum">     309 </span>            :                  const SECItem *gx4, const mp_int *p, mp_int *base)
<span class="lineNum">     310 </span>            : {
<span class="lineNum">     311 </span>            :     mp_err err;
<span class="lineNum">     312 </span>            :     mp_int GX1;
<span class="lineNum">     313 </span>            :     mp_int GX3;
<span class="lineNum">     314 </span>            :     mp_int GX4;
<span class="lineNum">     315 </span>            :     mp_int tmp;
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;GX1) = 0;</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;GX3) = 0;</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;GX4) = 0;</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;tmp) = 0;</span>
<span class="lineNum">     321 </span>            : 
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;GX1));</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;GX3));</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;GX4));</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;tmp));</span>
<span class="lineNum">     326 </span>            : 
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(*gx1, &amp;GX1);</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(*gx3, &amp;GX3);</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(*gx4, &amp;GX4);</span>
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span>            :     /* In round 2, the peer/attacker sends us g^x3 and g^x4 and the protocol
<span class="lineNum">     332 </span>            :        requires that these values are distinct. */
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :     if (mp_cmp(&amp;GX3, &amp;GX4) == 0) {</span>
<span class="lineNum">     334 </span>            :         return MP_BADARG;
<span class="lineNum">     335 </span>            :     }
<span class="lineNum">     336 </span>            : 
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_mul(&amp;GX1, &amp;GX3, &amp;tmp));</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_mul(&amp;tmp, &amp;GX4, &amp;tmp));</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_mod(&amp;tmp, p, base));</span>
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span>            : cleanup:
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :     mp_clear(&amp;GX1);</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :     mp_clear(&amp;GX3);</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :     mp_clear(&amp;GX4);</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :     mp_clear(&amp;tmp);</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :     return err;</span>
<span class="lineNum">     347 </span>            : }
<a name="348"><span class="lineNum">     348 </span>            : </a>
<span class="lineNum">     349 </span>            : SECStatus
<span class="lineNum">     350 </span><span class="lineNoCov">          0 : JPAKE_Round2(PLArenaPool *arena,</span>
<span class="lineNum">     351 </span>            :              const SECItem *p, const SECItem *q, const SECItem *gx1,
<span class="lineNum">     352 </span>            :              const SECItem *gx3, const SECItem *gx4, SECItem *base,
<span class="lineNum">     353 </span>            :              const SECItem *x2, const SECItem *s, SECItem *x2s)
<span class="lineNum">     354 </span>            : {
<span class="lineNum">     355 </span>            :     mp_err err;
<span class="lineNum">     356 </span>            :     mp_int P;
<span class="lineNum">     357 </span>            :     mp_int Q;
<span class="lineNum">     358 </span>            :     mp_int X2;
<span class="lineNum">     359 </span>            :     mp_int S;
<span class="lineNum">     360 </span>            :     mp_int result;
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :     if (!arena ||</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :         !p || !p-&gt;data || p-&gt;len == 0 ||</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :         !q || !q-&gt;data || q-&gt;len == 0 ||</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :         !gx1 || !gx1-&gt;data || gx1-&gt;len == 0 ||</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :         !gx3 || !gx3-&gt;data || gx3-&gt;len == 0 ||</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :         !gx4 || !gx4-&gt;data || gx4-&gt;len == 0 ||</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :         !base || base-&gt;data != NULL ||</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :         (x2s != NULL &amp;&amp; (x2s-&gt;data != NULL ||</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :                          !x2 || !x2-&gt;data || x2-&gt;len == 0 ||</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :                          !s || !s-&gt;data || s-&gt;len == 0))) {</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :         PORT_SetError(SEC_ERROR_INVALID_ARGS);</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :         return SECFailure;</span>
<span class="lineNum">     374 </span>            :     }
<span class="lineNum">     375 </span>            : 
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;P) = 0;</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;Q) = 0;</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;X2) = 0;</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;S) = 0;</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;result) = 0;</span>
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;P));</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;Q));</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;result));</span>
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :     if (x2s != NULL) {</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :         CHECK_MPI_OK(mp_init(&amp;X2));</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :         CHECK_MPI_OK(mp_init(&amp;S));</span>
<span class="lineNum">     389 </span>            : 
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :         SECITEM_TO_MPINT(*q, &amp;Q);</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :         SECITEM_TO_MPINT(*x2, &amp;X2);</span>
<span class="lineNum">     392 </span>            : 
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :         SECITEM_TO_MPINT(*s, &amp;S);</span>
<span class="lineNum">     394 </span>            :         /* S must be in [1, Q-1] */
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :         if (mp_cmp_z(&amp;S) &lt;= 0 || mp_cmp(&amp;S, &amp;Q) &gt;= 0) {</span>
<span class="lineNum">     396 </span>            :             err = MP_BADARG;
<span class="lineNum">     397 </span>            :             goto cleanup;
<span class="lineNum">     398 </span>            :         }
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :         CHECK_MPI_OK(mp_mulmod(&amp;X2, &amp;S, &amp;Q, &amp;result));</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :         MPINT_TO_SECITEM(&amp;result, x2s, arena);</span>
<span class="lineNum">     402 </span>            :     }
<span class="lineNum">     403 </span>            : 
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(*p, &amp;P);</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(jpake_Round2Base(gx1, gx3, gx4, &amp;P, &amp;result));</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :     MPINT_TO_SECITEM(&amp;result, base, arena);</span>
<span class="lineNum">     407 </span>            : 
<span class="lineNum">     408 </span>            : cleanup:
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :     mp_clear(&amp;P);</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :     mp_clear(&amp;Q);</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :     mp_clear(&amp;X2);</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :     mp_clear(&amp;S);</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :     mp_clear(&amp;result);</span>
<span class="lineNum">     414 </span>            : 
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :     if (err != MP_OKAY) {</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :         MP_TO_SEC_ERROR(err);</span>
<span class="lineNum">     417 </span>            :         return SECFailure;
<span class="lineNum">     418 </span>            :     }
<span class="lineNum">     419 </span>            :     return SECSuccess;
<span class="lineNum">     420 </span>            : }
<a name="421"><span class="lineNum">     421 </span>            : </a>
<span class="lineNum">     422 </span>            : SECStatus
<span class="lineNum">     423 </span><span class="lineNoCov">          0 : JPAKE_Final(PLArenaPool *arena, const SECItem *p, const SECItem *q,</span>
<span class="lineNum">     424 </span>            :             const SECItem *x2, const SECItem *gx4, const SECItem *x2s,
<span class="lineNum">     425 </span>            :             const SECItem *B, SECItem *K)
<span class="lineNum">     426 </span>            : {
<span class="lineNum">     427 </span>            :     mp_err err;
<span class="lineNum">     428 </span>            :     mp_int P;
<span class="lineNum">     429 </span>            :     mp_int Q;
<span class="lineNum">     430 </span>            :     mp_int tmp;
<span class="lineNum">     431 </span>            :     mp_int exponent;
<span class="lineNum">     432 </span>            :     mp_int divisor;
<span class="lineNum">     433 </span>            :     mp_int base;
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :     if (!arena ||</span>
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :         !p || !p-&gt;data || p-&gt;len == 0 ||</span>
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :         !q || !q-&gt;data || q-&gt;len == 0 ||</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :         !x2 || !x2-&gt;data || x2-&gt;len == 0 ||</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :         !gx4 || !gx4-&gt;data || gx4-&gt;len == 0 ||</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :         !x2s || !x2s-&gt;data || x2s-&gt;len == 0 ||</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :         !B || !B-&gt;data || B-&gt;len == 0 ||</span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :         !K || K-&gt;data != NULL) {</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :         PORT_SetError(SEC_ERROR_INVALID_ARGS);</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :         return SECFailure;</span>
<span class="lineNum">     445 </span>            :     }
<span class="lineNum">     446 </span>            : 
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;P) = 0;</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;Q) = 0;</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;tmp) = 0;</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;exponent) = 0;</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;divisor) = 0;</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :     MP_DIGITS(&amp;base) = 0;</span>
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;P));</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;Q));</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;tmp));</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;exponent));</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;divisor));</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_init(&amp;base));</span>
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span>            :     /* exponent = -x2s (mod q) */
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(*q, &amp;Q);</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(*x2s, &amp;tmp);</span>
<span class="lineNum">     464 </span>            :     /*  q == 0 (mod q), so q - x2s == -x2s (mod q) */
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_sub(&amp;Q, &amp;tmp, &amp;exponent));</span>
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span>            :     /* divisor = gx4^-x2s = 1/(gx4^x2s) (mod p) */
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(*p, &amp;P);</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(*gx4, &amp;tmp);</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_exptmod(&amp;tmp, &amp;exponent, &amp;P, &amp;divisor));</span>
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span>            :     /* base = B*divisor = B/(gx4^x2s) (mod p) */
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(*B, &amp;tmp);</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_mulmod(&amp;divisor, &amp;tmp, &amp;P, &amp;base));</span>
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span>            :     /* tmp = base^x2 (mod p) */
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :     SECITEM_TO_MPINT(*x2, &amp;exponent);</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :     CHECK_MPI_OK(mp_exptmod(&amp;base, &amp;exponent, &amp;P, &amp;tmp));</span>
<span class="lineNum">     479 </span>            : 
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :     MPINT_TO_SECITEM(&amp;tmp, K, arena);</span>
<span class="lineNum">     481 </span>            : 
<span class="lineNum">     482 </span>            : cleanup:
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :     mp_clear(&amp;P);</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :     mp_clear(&amp;Q);</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :     mp_clear(&amp;tmp);</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :     mp_clear(&amp;exponent);</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :     mp_clear(&amp;divisor);</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :     mp_clear(&amp;base);</span>
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :     if (err != MP_OKAY) {</span>
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :         MP_TO_SEC_ERROR(err);</span>
<span class="lineNum">     492 </span>            :         return SECFailure;
<span class="lineNum">     493 </span>            :     }
<span class="lineNum">     494 </span>            :     return SECSuccess;
<span class="lineNum">     495 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
