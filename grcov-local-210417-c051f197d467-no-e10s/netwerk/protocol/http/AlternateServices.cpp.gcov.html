<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - netwerk/protocol/http/AlternateServices.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../index.html">top level</a> - <a href="index.html">netwerk/protocol/http</a> - AlternateServices.cpp<span style="font-size: 80%;"> (source / <a href="AlternateServices.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">80</td>
            <td class="headerCovTableEntry">510</td>
            <td class="headerCovTableEntryLo">15.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21 12:59:10</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">11</td>
            <td class="headerCovTableEntry">52</td>
            <td class="headerCovTableEntryLo">21.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* vim: set sw=2 ts=8 et tw=80 : */
<span class="lineNum">       3 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       4 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       5 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            : #include &quot;HttpLog.h&quot;
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : #include &quot;AlternateServices.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;LoadInfo.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;nsEscape.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;nsHttpConnectionInfo.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;nsHttpChannel.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;nsHttpHandler.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;nsThreadUtils.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;nsHttpTransaction.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;NullHttpTransaction.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;nsISSLStatusProvider.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;nsISSLStatus.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;nsISSLSocketControl.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;nsIWellKnownOpportunisticUtils.h&quot;
<span class="lineNum">      22 </span>            : 
<span class="lineNum">      23 </span>            : /* RFC 7838 Alternative Services
<span class="lineNum">      24 </span>            :    http://httpwg.org/http-extensions/opsec.html
<span class="lineNum">      25 </span>            :     note that connections currently do not do mixed-scheme (the I attribute
<span class="lineNum">      26 </span>            :     in the ConnectionInfo prevents it) but could, do not honor tls-commit and should
<span class="lineNum">      27 </span>            :     not, and always require authentication
<span class="lineNum">      28 </span>            : */
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : namespace mozilla {
<span class="lineNum">      31 </span>            : namespace net {
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : // function places true in outIsHTTPS if scheme is https, false if
<span class="lineNum">      34 </span>            : // http, and returns an error if neither. originScheme passed into
<span class="lineNum">      35 </span>            : // alternate service should already be normalized to those lower case
<a name="36"><span class="lineNum">      36 </span>            : // strings by the URI parser (and so there is an assert)- this is an extra check.</a>
<span class="lineNum">      37 </span>            : static nsresult
<span class="lineNum">      38 </span><span class="lineCov">          1 : SchemeIsHTTPS(const nsACString &amp;originScheme, bool &amp;outIsHTTPS)</span>
<span class="lineNum">      39 </span>            : {
<span class="lineNum">      40 </span><span class="lineCov">          1 :   outIsHTTPS = originScheme.Equals(NS_LITERAL_CSTRING(&quot;https&quot;));</span>
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span><span class="lineCov">          1 :   if (!outIsHTTPS &amp;&amp; !originScheme.Equals(NS_LITERAL_CSTRING(&quot;http&quot;))) {</span>
<span class="lineNum">      43 </span>            :       MOZ_ASSERT(false, &quot;unexpected scheme&quot;);
<span class="lineNum">      44 </span>            :       return NS_ERROR_UNEXPECTED;
<span class="lineNum">      45 </span>            :   }
<span class="lineNum">      46 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">      47 </span>            : }
<a name="48"><span class="lineNum">      48 </span>            : </a>
<span class="lineNum">      49 </span>            : void
<span class="lineNum">      50 </span><span class="lineNoCov">          0 : AltSvcMapping::ProcessHeader(const nsCString &amp;buf, const nsCString &amp;originScheme,</span>
<span class="lineNum">      51 </span>            :                              const nsCString &amp;originHost, int32_t originPort,
<span class="lineNum">      52 </span>            :                              const nsACString &amp;username, bool privateBrowsing,
<span class="lineNum">      53 </span>            :                              nsIInterfaceRequestor *callbacks, nsProxyInfo *proxyInfo,
<span class="lineNum">      54 </span>            :                              uint32_t caps, const OriginAttributes &amp;originAttributes)
<span class="lineNum">      55 </span>            : {
<span class="lineNum">      56 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">      57 </span><span class="lineNoCov">          0 :   LOG((&quot;AltSvcMapping::ProcessHeader: %s\n&quot;, buf.get()));</span>
<span class="lineNum">      58 </span><span class="lineNoCov">          0 :   if (!callbacks) {</span>
<span class="lineNum">      59 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">      60 </span>            :   }
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :   if (proxyInfo &amp;&amp; !proxyInfo-&gt;IsDirect()) {</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcMapping::ProcessHeader ignoring due to proxy\n&quot;));</span>
<span class="lineNum">      64 </span>            :     return;
<span class="lineNum">      65 </span>            :   }
<span class="lineNum">      66 </span>            : 
<span class="lineNum">      67 </span>            :   bool isHTTPS;
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :   if (NS_FAILED(SchemeIsHTTPS(originScheme, isHTTPS))) {</span>
<span class="lineNum">      69 </span>            :     return;
<span class="lineNum">      70 </span>            :   }
<span class="lineNum">      71 </span><span class="lineNoCov">          0 :   if (!isHTTPS &amp;&amp; !gHttpHandler-&gt;AllowAltSvcOE()) {</span>
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :     LOG((&quot;Alt-Svc Response Header for http:// origin but OE disabled\n&quot;));</span>
<span class="lineNum">      73 </span>            :     return;
<span class="lineNum">      74 </span>            :   }
<span class="lineNum">      75 </span>            : 
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :   LOG((&quot;Alt-Svc Response Header %s\n&quot;, buf.get()));</span>
<span class="lineNum">      77 </span><span class="lineNoCov">          0 :   ParsedHeaderValueListList parsedAltSvc(buf);</span>
<span class="lineNum">      78 </span>            : 
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :   for (uint32_t index = 0; index &lt; parsedAltSvc.mValues.Length(); ++index) {</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :     uint32_t maxage = 86400; // default</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :     nsAutoCString hostname;</span>
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :     nsAutoCString npnToken;</span>
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :     int32_t portno = originPort;</span>
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :     bool clearEntry = false;</span>
<span class="lineNum">      85 </span>            : 
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :     for (uint32_t pairIndex = 0;</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :          pairIndex &lt; parsedAltSvc.mValues[index].mValues.Length();</span>
<span class="lineNum">      88 </span>            :          ++pairIndex) {
<span class="lineNum">      89 </span>            :       nsDependentCSubstring &amp;currentName =
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :         parsedAltSvc.mValues[index].mValues[pairIndex].mName;</span>
<span class="lineNum">      91 </span>            :       nsDependentCSubstring &amp;currentValue =
<span class="lineNum">      92 </span><span class="lineNoCov">          0 :         parsedAltSvc.mValues[index].mValues[pairIndex].mValue;</span>
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :       if (!pairIndex) {</span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :         if (currentName.Equals(NS_LITERAL_CSTRING(&quot;clear&quot;))) {</span>
<span class="lineNum">      96 </span>            :           clearEntry = true;
<span class="lineNum">      97 </span>            :           break;
<span class="lineNum">      98 </span>            :         }
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span>            :         // h2=[hostname]:443
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :         npnToken = currentName;</span>
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :         int32_t colonIndex = currentValue.FindChar(':');</span>
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :         if (colonIndex &gt;= 0) {</span>
<span class="lineNum">     104 </span>            :           portno =
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :             atoi(PromiseFlatCString(currentValue).get() + colonIndex + 1);</span>
<span class="lineNum">     106 </span>            :         } else {
<span class="lineNum">     107 </span>            :           colonIndex = 0;
<span class="lineNum">     108 </span>            :         }
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :         hostname.Assign(currentValue.BeginReading(), colonIndex);</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :       } else if (currentName.Equals(NS_LITERAL_CSTRING(&quot;ma&quot;))) {</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :         maxage = atoi(PromiseFlatCString(currentValue).get());</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     113 </span>            :       } else {
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :         LOG((&quot;Alt Svc ignoring parameter %s&quot;, currentName.BeginReading()));</span>
<span class="lineNum">     115 </span>            :       }
<span class="lineNum">     116 </span>            :     }
<span class="lineNum">     117 </span>            : 
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :     if (clearEntry) {</span>
<span class="lineNum">     119 </span>            :       nsCString suffix;
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :       originAttributes.CreateSuffix(suffix);</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :       LOG((&quot;Alt Svc clearing mapping for %s:%d:%s&quot;, originHost.get(),</span>
<span class="lineNum">     122 </span>            :            originPort, suffix.get()));
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :       gHttpHandler-&gt;ConnMgr()-&gt;ClearHostMapping(originHost, originPort, originAttributes);</span>
<span class="lineNum">     124 </span>            :       continue;
<span class="lineNum">     125 </span>            :     }
<span class="lineNum">     126 </span>            : 
<span class="lineNum">     127 </span>            :     // unescape modifies a c string in place, so afterwards
<span class="lineNum">     128 </span>            :     // update nsCString length
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :     nsUnescape(npnToken.BeginWriting());</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :     npnToken.SetLength(strlen(npnToken.BeginReading()));</span>
<span class="lineNum">     131 </span>            : 
<span class="lineNum">     132 </span>            :     uint32_t spdyIndex;
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :     SpdyInformation *spdyInfo = gHttpHandler-&gt;SpdyInfo();</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :     if (!(NS_SUCCEEDED(spdyInfo-&gt;GetNPNIndex(npnToken, &amp;spdyIndex)) &amp;&amp;</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :           spdyInfo-&gt;ProtocolEnabled(spdyIndex))) {</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :       LOG((&quot;Alt Svc unknown protocol %s, ignoring&quot;, npnToken.get()));</span>
<span class="lineNum">     137 </span>            :       continue;
<span class="lineNum">     138 </span>            :     }
<span class="lineNum">     139 </span>            : 
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :     RefPtr&lt;AltSvcMapping&gt; mapping = new AltSvcMapping(gHttpHandler-&gt;ConnMgr()-&gt;GetStoragePtr(),</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :                                                       gHttpHandler-&gt;ConnMgr()-&gt;StorageEpoch(),</span>
<span class="lineNum">     142 </span>            :                                                       originScheme,
<span class="lineNum">     143 </span>            :                                                       originHost, originPort,
<span class="lineNum">     144 </span>            :                                                       username, privateBrowsing,
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :                                                       NowInSeconds() + maxage,</span>
<span class="lineNum">     146 </span>            :                                                       hostname, portno, npnToken,
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :                                                       originAttributes);</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :     if (mapping-&gt;TTL() &lt;= 0) {</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :       LOG((&quot;Alt Svc invalid map&quot;));</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :       mapping = nullptr;</span>
<span class="lineNum">     151 </span>            :       // since this isn't a parse error, let's clear any existing mapping
<span class="lineNum">     152 </span>            :       // as that would have happened if we had accepted the parameters.
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :       gHttpHandler-&gt;ConnMgr()-&gt;ClearHostMapping(originHost, originPort, originAttributes);</span>
<span class="lineNum">     154 </span>            :     } else {
<span class="lineNum">     155 </span>            :       gHttpHandler-&gt;UpdateAltServiceMapping(mapping, proxyInfo, callbacks, caps,
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :                                             originAttributes);</span>
<span class="lineNum">     157 </span>            :     }
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :   }</span>
<a name="159"><span class="lineNum">     159 </span>            : }</a>
<span class="lineNum">     160 </span>            : 
<span class="lineNum">     161 </span><span class="lineNoCov">          0 : AltSvcMapping::AltSvcMapping(DataStorage *storage, int32_t epoch,</span>
<span class="lineNum">     162 </span>            :                              const nsACString &amp;originScheme,
<span class="lineNum">     163 </span>            :                              const nsACString &amp;originHost,
<span class="lineNum">     164 </span>            :                              int32_t originPort,
<span class="lineNum">     165 </span>            :                              const nsACString &amp;username,
<span class="lineNum">     166 </span>            :                              bool privateBrowsing,
<span class="lineNum">     167 </span>            :                              uint32_t expiresAt,
<span class="lineNum">     168 </span>            :                              const nsACString &amp;alternateHost,
<span class="lineNum">     169 </span>            :                              int32_t alternatePort,
<span class="lineNum">     170 </span>            :                              const nsACString &amp;npnToken,
<span class="lineNum">     171 </span>            :                              const OriginAttributes &amp;originAttributes)
<span class="lineNum">     172 </span>            :   : mStorage(storage)
<span class="lineNum">     173 </span>            :   , mStorageEpoch(epoch)
<span class="lineNum">     174 </span>            :   , mAlternateHost(alternateHost)
<span class="lineNum">     175 </span>            :   , mAlternatePort(alternatePort)
<span class="lineNum">     176 </span>            :   , mOriginHost(originHost)
<span class="lineNum">     177 </span>            :   , mOriginPort(originPort)
<span class="lineNum">     178 </span>            :   , mUsername(username)
<span class="lineNum">     179 </span>            :   , mPrivate(privateBrowsing)
<span class="lineNum">     180 </span>            :   , mExpiresAt(expiresAt)
<span class="lineNum">     181 </span>            :   , mValidated(false)
<span class="lineNum">     182 </span>            :   , mMixedScheme(false)
<span class="lineNum">     183 </span>            :   , mNPNToken(npnToken)
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :   , mOriginAttributes(originAttributes)</span>
<span class="lineNum">     185 </span>            : {
<span class="lineNum">     186 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     187 </span>            : 
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :   if (NS_FAILED(SchemeIsHTTPS(originScheme, mHttps))) {</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcMapping ctor %p invalid scheme\n&quot;, this));</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :     mExpiresAt = 0; // invalid</span>
<span class="lineNum">     191 </span>            :   }
<span class="lineNum">     192 </span>            : 
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :   if (mAlternatePort == -1) {</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :     mAlternatePort = mHttps ? NS_HTTPS_DEFAULT_PORT : NS_HTTP_DEFAULT_PORT;</span>
<span class="lineNum">     195 </span>            :   }
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :   if (mOriginPort == -1) {</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :     mOriginPort = mHttps ? NS_HTTPS_DEFAULT_PORT : NS_HTTP_DEFAULT_PORT;</span>
<span class="lineNum">     198 </span>            :   }
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :   LOG((&quot;AltSvcMapping ctor %p %s://%s:%d to %s:%d\n&quot;, this,</span>
<span class="lineNum">     201 </span>            :        nsCString(originScheme).get(), mOriginHost.get(), mOriginPort,
<span class="lineNum">     202 </span>            :        mAlternateHost.get(), mAlternatePort));
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :   if (mAlternateHost.IsEmpty()) {</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :     mAlternateHost = mOriginHost;</span>
<span class="lineNum">     206 </span>            :   }
<span class="lineNum">     207 </span>            : 
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :   if ((mAlternatePort == mOriginPort) &amp;&amp;</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :       mAlternateHost.EqualsIgnoreCase(mOriginHost.get())) {</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :     LOG((&quot;Alt Svc is also origin Svc - ignoring\n&quot;));</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :     mExpiresAt = 0; // invalid</span>
<span class="lineNum">     212 </span>            :   }
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :   if (mExpiresAt) {</span>
<span class="lineNum">     215 </span>            :     MakeHashKey(mHashKey, originScheme, mOriginHost, mOriginPort, mPrivate,
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :                 mOriginAttributes);</span>
<span class="lineNum">     217 </span>            :   }
<span class="lineNum">     218 </span><span class="lineNoCov">          0 : }</span>
<a name="219"><span class="lineNum">     219 </span>            : </a>
<span class="lineNum">     220 </span>            : void
<span class="lineNum">     221 </span><span class="lineCov">          1 : AltSvcMapping::MakeHashKey(nsCString &amp;outKey,</span>
<span class="lineNum">     222 </span>            :                            const nsACString &amp;originScheme,
<span class="lineNum">     223 </span>            :                            const nsACString &amp;originHost,
<span class="lineNum">     224 </span>            :                            int32_t originPort,
<span class="lineNum">     225 </span>            :                            bool privateBrowsing,
<span class="lineNum">     226 </span>            :                            const OriginAttributes &amp;originAttributes)
<span class="lineNum">     227 </span>            : {
<span class="lineNum">     228 </span><span class="lineCov">          1 :   outKey.Truncate();</span>
<span class="lineNum">     229 </span>            : 
<span class="lineNum">     230 </span><span class="lineCov">          1 :   if (originPort == -1) {</span>
<span class="lineNum">     231 </span><span class="lineCov">          1 :     bool isHttps = originScheme.Equals(&quot;https&quot;);</span>
<span class="lineNum">     232 </span><span class="lineCov">          1 :     originPort = isHttps ? NS_HTTPS_DEFAULT_PORT : NS_HTTP_DEFAULT_PORT;</span>
<span class="lineNum">     233 </span>            :   }
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span><span class="lineCov">          1 :   outKey.Append(originScheme);</span>
<span class="lineNum">     236 </span><span class="lineCov">          1 :   outKey.Append(':');</span>
<span class="lineNum">     237 </span><span class="lineCov">          1 :   outKey.Append(originHost);</span>
<span class="lineNum">     238 </span><span class="lineCov">          1 :   outKey.Append(':');</span>
<span class="lineNum">     239 </span><span class="lineCov">          1 :   outKey.AppendInt(originPort);</span>
<span class="lineNum">     240 </span><span class="lineCov">          1 :   outKey.Append(':');</span>
<span class="lineNum">     241 </span><span class="lineCov">          1 :   outKey.Append(privateBrowsing ? 'P' : '.');</span>
<span class="lineNum">     242 </span><span class="lineCov">          1 :   outKey.Append(':');</span>
<span class="lineNum">     243 </span><span class="lineCov">          1 :   nsAutoCString suffix;</span>
<span class="lineNum">     244 </span><span class="lineCov">          1 :   originAttributes.CreateSuffix(suffix);</span>
<span class="lineNum">     245 </span><span class="lineCov">          1 :   outKey.Append(suffix);</span>
<span class="lineNum">     246 </span><span class="lineCov">          1 : }</span>
<a name="247"><span class="lineNum">     247 </span>            : </a>
<span class="lineNum">     248 </span>            : int32_t
<span class="lineNum">     249 </span><span class="lineNoCov">          0 : AltSvcMapping::TTL()</span>
<span class="lineNum">     250 </span>            : {
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :   return mExpiresAt - NowInSeconds();</span>
<span class="lineNum">     252 </span>            : }
<a name="253"><span class="lineNum">     253 </span>            : </a>
<span class="lineNum">     254 </span>            : void
<span class="lineNum">     255 </span><span class="lineNoCov">          0 : AltSvcMapping::SyncString(const nsCString&amp; str)</span>
<span class="lineNum">     256 </span>            : {
<span class="lineNum">     257 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     258 </span>            :   mStorage-&gt;Put(HashKey(), str,
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :                 mPrivate ? DataStorage_Private : DataStorage_Persistent);</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 : }</span>
<a name="261"><span class="lineNum">     261 </span>            : </a>
<span class="lineNum">     262 </span>            : void
<span class="lineNum">     263 </span><span class="lineNoCov">          0 : AltSvcMapping::Sync()</span>
<span class="lineNum">     264 </span>            : {
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :   if (!mStorage) {</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     267 </span>            :   }
<span class="lineNum">     268 </span>            :   nsCString value;
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :   Serialize(value);</span>
<span class="lineNum">     270 </span>            : 
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :   if (!NS_IsMainThread()) {</span>
<span class="lineNum">     272 </span>            :     nsCOMPtr&lt;nsIRunnable&gt; r;
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :     r = NewRunnableMethod&lt;nsCString&gt;(this,</span>
<span class="lineNum">     274 </span>            :                                      &amp;AltSvcMapping::SyncString,
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :                                      value);</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :     NS_DispatchToMainThread(r, NS_DISPATCH_NORMAL);</span>
<span class="lineNum">     277 </span>            :     return;
<span class="lineNum">     278 </span>            :   }
<span class="lineNum">     279 </span>            : 
<span class="lineNum">     280 </span>            :   mStorage-&gt;Put(HashKey(), value,
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :                 mPrivate ? DataStorage_Private : DataStorage_Persistent);</span>
<span class="lineNum">     282 </span>            : }
<a name="283"><span class="lineNum">     283 </span>            : </a>
<span class="lineNum">     284 </span>            : void
<span class="lineNum">     285 </span><span class="lineNoCov">          0 : AltSvcMapping::SetValidated(bool val)</span>
<span class="lineNum">     286 </span>            : {
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :   mValidated = val;</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :   Sync();</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 : }</span>
<a name="290"><span class="lineNum">     290 </span>            : </a>
<span class="lineNum">     291 </span>            : void
<span class="lineNum">     292 </span><span class="lineNoCov">          0 : AltSvcMapping::SetMixedScheme(bool val)</span>
<span class="lineNum">     293 </span>            : {
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :   mMixedScheme = val;</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :   Sync();</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 : }</span>
<a name="297"><span class="lineNum">     297 </span>            : </a>
<span class="lineNum">     298 </span>            : void
<span class="lineNum">     299 </span><span class="lineNoCov">          0 : AltSvcMapping::SetExpiresAt(int32_t val)</span>
<span class="lineNum">     300 </span>            : {
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :   mExpiresAt = val;</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :   Sync();</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 : }</span>
<a name="304"><span class="lineNum">     304 </span>            : </a>
<span class="lineNum">     305 </span>            : void
<span class="lineNum">     306 </span><span class="lineNoCov">          0 : AltSvcMapping::SetExpired()</span>
<span class="lineNum">     307 </span>            : {
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :   LOG((&quot;AltSvcMapping SetExpired %p origin %s alternate %s\n&quot;, this,</span>
<span class="lineNum">     309 </span>            :        mOriginHost.get(), mAlternateHost.get()));
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :   mExpiresAt = NowInSeconds() - 1;</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :   Sync();</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 : }</span>
<a name="313"><span class="lineNum">     313 </span>            : </a>
<span class="lineNum">     314 </span>            : bool
<span class="lineNum">     315 </span><span class="lineNoCov">          0 : AltSvcMapping::RouteEquals(AltSvcMapping *map)</span>
<span class="lineNum">     316 </span>            : {
<span class="lineNum">     317 </span>            :   MOZ_ASSERT(map-&gt;mHashKey.Equals(mHashKey));
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :   return mAlternateHost.Equals(map-&gt;mAlternateHost) &amp;&amp;</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :     (mAlternatePort == map-&gt;mAlternatePort) &amp;&amp;</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :     mNPNToken.Equals(map-&gt;mNPNToken);</span>
<span class="lineNum">     321 </span>            : }
<a name="322"><span class="lineNum">     322 </span>            : </a>
<span class="lineNum">     323 </span>            : void
<span class="lineNum">     324 </span><span class="lineNoCov">          0 : AltSvcMapping::GetConnectionInfo(nsHttpConnectionInfo **outCI,</span>
<span class="lineNum">     325 </span>            :                                  nsProxyInfo *pi,
<span class="lineNum">     326 </span>            :                                  const OriginAttributes &amp;originAttributes)
<span class="lineNum">     327 </span>            : {
<span class="lineNum">     328 </span>            :   RefPtr&lt;nsHttpConnectionInfo&gt; ci =
<span class="lineNum">     329 </span>            :     new nsHttpConnectionInfo(mOriginHost, mOriginPort, mNPNToken,
<span class="lineNum">     330 </span>            :                              mUsername, pi, originAttributes,
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :                              mAlternateHost, mAlternatePort);</span>
<span class="lineNum">     332 </span>            : 
<span class="lineNum">     333 </span>            :   // http:// without the mixed-scheme attribute needs to be segmented in the
<span class="lineNum">     334 </span>            :   // connection manager connection information hash with this attribute
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :   if (!mHttps &amp;&amp; !mMixedScheme) {</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :     ci-&gt;SetInsecureScheme(true);</span>
<span class="lineNum">     337 </span>            :   }
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :   ci-&gt;SetPrivate(mPrivate);</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :   ci.forget(outCI);</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 : }</span>
<a name="341"><span class="lineNum">     341 </span>            : </a>
<span class="lineNum">     342 </span>            : void
<span class="lineNum">     343 </span><span class="lineNoCov">          0 : AltSvcMapping::Serialize(nsCString &amp;out)</span>
<span class="lineNum">     344 </span>            : {
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :   out = mHttps ? NS_LITERAL_CSTRING(&quot;https:&quot;) : NS_LITERAL_CSTRING(&quot;http:&quot;);</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :   out.Append(mOriginHost);</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :   out.Append(':');</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :   out.AppendInt(mOriginPort);</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :   out.Append(':');</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :   out.Append(mAlternateHost);</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :   out.Append(':');</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :   out.AppendInt(mAlternatePort);</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :   out.Append(':');</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :   out.Append(mUsername);</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :   out.Append(':');</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :   out.Append(mPrivate ? 'y' : 'n');</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :   out.Append(':');</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :   out.AppendInt(mExpiresAt);</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :   out.Append(':');</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :   out.Append(mNPNToken);</span>
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :   out.Append(':');</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :   out.Append(mValidated ? 'y' : 'n');</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :   out.Append(':');</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :   out.AppendInt(mStorageEpoch);</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :   out.Append(':');</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :   out.Append(mMixedScheme ? 'y' : 'n');</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :   out.Append(':');</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :   nsAutoCString suffix;</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :   mOriginAttributes.CreateSuffix(suffix);</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :   out.Append(suffix);</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :   out.Append(':');</span>
<a name="372"><span class="lineNum">     372 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     373 </span>            : 
<span class="lineNum">     374 </span><span class="lineNoCov">          0 : AltSvcMapping::AltSvcMapping(DataStorage *storage, int32_t epoch, const nsCString &amp;str)</span>
<span class="lineNum">     375 </span>            :   : mStorage(storage)
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :   , mStorageEpoch(epoch)</span>
<span class="lineNum">     377 </span>            : {
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :   mValidated = false;</span>
<span class="lineNum">     379 </span>            :   nsresult code;
<span class="lineNum">     380 </span>            : 
<span class="lineNum">     381 </span>            :   // The the do {} while(0) loop acts like try/catch(e){} with the break in _NS_NEXT_TOKEN
<span class="lineNum">     382 </span>            :   do {
<span class="lineNum">     383 </span>            : #ifdef _NS_NEXT_TOKEN
<span class="lineNum">     384 </span>            : COMPILER ERROR
<span class="lineNum">     385 </span>            : #endif
<span class="lineNum">     386 </span>            :     #define _NS_NEXT_TOKEN start = idx + 1; idx = str.FindChar(':', start); if (idx &lt; 0) break;
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :     int32_t start = 0;</span>
<span class="lineNum">     388 </span>            :     int32_t idx;
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :     idx = str.FindChar(':', start); if (idx &lt; 0) break;</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :     mHttps = Substring(str, start, idx - start).Equals(NS_LITERAL_CSTRING(&quot;https&quot;));</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     _NS_NEXT_TOKEN;</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :     mOriginHost = Substring(str, start, idx - start);</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :     _NS_NEXT_TOKEN;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :     mOriginPort = nsCString(Substring(str, start, idx - start)).ToInteger(&amp;code);</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :     _NS_NEXT_TOKEN;</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :     mAlternateHost = Substring(str, start, idx - start);</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :     _NS_NEXT_TOKEN;</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :     mAlternatePort = nsCString(Substring(str, start, idx - start)).ToInteger(&amp;code);</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :     _NS_NEXT_TOKEN;</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :     mUsername = Substring(str, start, idx - start);</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :     _NS_NEXT_TOKEN;</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :     mPrivate = Substring(str, start, idx - start).Equals(NS_LITERAL_CSTRING(&quot;y&quot;));</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :     _NS_NEXT_TOKEN;</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :     mExpiresAt = nsCString(Substring(str, start, idx - start)).ToInteger(&amp;code);</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :     _NS_NEXT_TOKEN;</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :     mNPNToken = Substring(str, start, idx - start);</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :     _NS_NEXT_TOKEN;</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :     mValidated = Substring(str, start, idx - start).Equals(NS_LITERAL_CSTRING(&quot;y&quot;));</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :     _NS_NEXT_TOKEN;</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :     mStorageEpoch = nsCString(Substring(str, start, idx - start)).ToInteger(&amp;code);</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :     _NS_NEXT_TOKEN;</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :     mMixedScheme = Substring(str, start, idx - start).Equals(NS_LITERAL_CSTRING(&quot;y&quot;));</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :     _NS_NEXT_TOKEN;</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :     Unused &lt;&lt; mOriginAttributes.PopulateFromSuffix(Substring(str, start, idx - start));</span>
<span class="lineNum">     415 </span>            :     #undef _NS_NEXT_TOKEN
<span class="lineNum">     416 </span>            : 
<span class="lineNum">     417 </span>            :     MakeHashKey(mHashKey, mHttps ? NS_LITERAL_CSTRING(&quot;https&quot;) : NS_LITERAL_CSTRING(&quot;http&quot;),
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :                 mOriginHost, mOriginPort, mPrivate, mOriginAttributes);</span>
<span class="lineNum">     419 </span>            :   } while (false);
<span class="lineNum">     420 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     421 </span>            : 
<span class="lineNum">     422 </span>            : // This is the asynchronous null transaction used to validate
<span class="lineNum">     423 </span>            : // an alt-svc advertisement only for https://
<span class="lineNum">     424 </span>            : class AltSvcTransaction final : public NullHttpTransaction
<a name="425"><span class="lineNum">     425 </span>            : {</a>
<span class="lineNum">     426 </span>            : public:
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :     AltSvcTransaction(AltSvcMapping *map,</span>
<span class="lineNum">     428 </span>            :                       nsHttpConnectionInfo *ci,
<span class="lineNum">     429 </span>            :                       nsIInterfaceRequestor *callbacks,
<span class="lineNum">     430 </span>            :                       uint32_t caps)
<span class="lineNum">     431 </span>            :     : NullHttpTransaction(ci, callbacks, caps &amp; ~NS_HTTP_ALLOW_KEEPALIVE)
<span class="lineNum">     432 </span>            :     , mMapping(map)
<span class="lineNum">     433 </span>            :     , mRunning(true)
<span class="lineNum">     434 </span>            :     , mTriedToValidate(false)
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :     , mTriedToWrite(false)</span>
<span class="lineNum">     436 </span>            :   {
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcTransaction ctor %p map %p [%s -&gt; %s]&quot;,</span>
<span class="lineNum">     438 </span>            :          this, map, map-&gt;OriginHost().get(), map-&gt;AlternateHost().get()));
<span class="lineNum">     439 </span>            :     MOZ_ASSERT(mMapping);
<span class="lineNum">     440 </span>            :     MOZ_ASSERT(mMapping-&gt;HTTPS());
<a name="441"><span class="lineNum">     441 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :   ~AltSvcTransaction() override</span>
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :   {</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcTransaction dtor %p map %p running %d&quot;,</span>
<span class="lineNum">     446 </span>            :          this, mMapping.get(), mRunning));
<span class="lineNum">     447 </span>            : 
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :     if (mRunning) {</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :       MaybeValidate(NS_OK);</span>
<span class="lineNum">     450 </span>            :     }
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :     if (!mMapping-&gt;Validated()) {</span>
<span class="lineNum">     452 </span>            :       // try again later
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :       mMapping-&gt;SetExpiresAt(NowInSeconds() + 2);</span>
<span class="lineNum">     454 </span>            :     }
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcTransaction dtor %p map %p validated %d [%s]&quot;,</span>
<span class="lineNum">     456 </span>            :          this, mMapping.get(), mMapping-&gt;Validated(),
<span class="lineNum">     457 </span>            :          mMapping-&gt;HashKey().get()));
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     459 </span>            : 
<span class="lineNum">     460 </span>            : private:
<a name="461"><span class="lineNum">     461 </span>            :   // check on alternate route.</a>
<span class="lineNum">     462 </span>            :   // also evaluate 'reasonable assurances' for opportunistic security
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :   void MaybeValidate(nsresult reason)</span>
<span class="lineNum">     464 </span>            :   {
<span class="lineNum">     465 </span>            :     MOZ_ASSERT(mMapping-&gt;HTTPS()); // http:// uses the .wk path
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :     if (mTriedToValidate) {</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     469 </span>            :     }
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :     mTriedToValidate = true;</span>
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcTransaction::MaybeValidate() %p reason=%&quot; PRIx32 &quot; running=%d conn=%p write=%d&quot;,</span>
<span class="lineNum">     473 </span>            :          this, static_cast&lt;uint32_t&gt;(reason), mRunning, mConnection.get(), mTriedToWrite));
<span class="lineNum">     474 </span>            : 
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :     if (mTriedToWrite &amp;&amp; reason == NS_BASE_STREAM_CLOSED) {</span>
<span class="lineNum">     476 </span>            :       // The normal course of events is to cause the transaction to fail with CLOSED
<span class="lineNum">     477 </span>            :       // on a write - so that's a success that means the HTTP/2 session is setup.
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :       reason = NS_OK;</span>
<span class="lineNum">     479 </span>            :     }
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :     if (NS_FAILED(reason) || !mRunning || !mConnection) {</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :       LOG((&quot;AltSvcTransaction::MaybeValidate %p Failed due to precondition&quot;, this));</span>
<span class="lineNum">     483 </span>            :       return;
<span class="lineNum">     484 </span>            :     }
<span class="lineNum">     485 </span>            : 
<span class="lineNum">     486 </span>            :     // insist on &gt;= http/2
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :     uint32_t version = mConnection-&gt;Version();</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcTransaction::MaybeValidate() %p version %d\n&quot;, this, version));</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :     if (version != HTTP_VERSION_2) {</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :       LOG((&quot;AltSvcTransaction::MaybeValidate %p Failed due to protocol version&quot;, this));</span>
<span class="lineNum">     491 </span>            :       return;
<span class="lineNum">     492 </span>            :     }
<span class="lineNum">     493 </span>            : 
<span class="lineNum">     494 </span>            :     nsCOMPtr&lt;nsISupports&gt; secInfo;
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :     mConnection-&gt;GetSecurityInfo(getter_AddRefs(secInfo));</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsISSLSocketControl&gt; socketControl = do_QueryInterface(secInfo);</span>
<span class="lineNum">     497 </span>            : 
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcTransaction::MaybeValidate() %p socketControl=%p\n&quot;,</span>
<span class="lineNum">     499 </span>            :          this, socketControl.get()));
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :     if (socketControl-&gt;GetFailedVerification()) {</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :       LOG((&quot;AltSvcTransaction::MaybeValidate() %p &quot;</span>
<span class="lineNum">     503 </span>            :            &quot;not validated due to auth error&quot;, this));
<span class="lineNum">     504 </span>            :       return;
<span class="lineNum">     505 </span>            :     }
<span class="lineNum">     506 </span>            : 
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcTransaction::MaybeValidate() %p &quot;</span>
<span class="lineNum">     508 </span>            :          &quot;validating alternate service with successful auth check&quot;, this));
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :     mMapping-&gt;SetValidated(true);</span>
<span class="lineNum">     510 </span>            :   }
<a name="511"><span class="lineNum">     511 </span>            : </a>
<span class="lineNum">     512 </span>            : public:
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :   void Close(nsresult reason) override</span>
<span class="lineNum">     514 </span>            :   {
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcTransaction::Close() %p reason=%&quot; PRIx32 &quot; running %d&quot;,</span>
<span class="lineNum">     516 </span>            :          this, static_cast&lt;uint32_t&gt;(reason), mRunning));
<span class="lineNum">     517 </span>            : 
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :     MaybeValidate(reason);</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :     if (!mMapping-&gt;Validated() &amp;&amp; mConnection) {</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :       mConnection-&gt;DontReuse();</span>
<span class="lineNum">     521 </span>            :     }
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :     NullHttpTransaction::Close(reason);</span>
<a name="523"><span class="lineNum">     523 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">     524 </span>            : 
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :   nsresult ReadSegments(nsAHttpSegmentReader *reader,</span>
<span class="lineNum">     526 </span>            :                         uint32_t count, uint32_t *countRead) override
<span class="lineNum">     527 </span>            :   {
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcTransaction::ReadSegements() %p\n&quot;, this));</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :     mTriedToWrite = true;</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :     return NullHttpTransaction::ReadSegments(reader, count, countRead);</span>
<span class="lineNum">     531 </span>            :   }
<span class="lineNum">     532 </span>            : 
<span class="lineNum">     533 </span>            : private:
<span class="lineNum">     534 </span>            :   RefPtr&lt;AltSvcMapping&gt;   mMapping;
<span class="lineNum">     535 </span>            :   uint32_t                mRunning : 1;
<span class="lineNum">     536 </span>            :   uint32_t                mTriedToValidate : 1;
<span class="lineNum">     537 </span>            :   uint32_t                mTriedToWrite : 1;
<span class="lineNum">     538 </span>            : };
<span class="lineNum">     539 </span>            : 
<span class="lineNum">     540 </span>            : class WellKnownChecker
<a name="541"><span class="lineNum">     541 </span>            : {</a>
<span class="lineNum">     542 </span>            : public:
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :   WellKnownChecker(nsIURI *uri, const nsCString &amp;origin, uint32_t caps, nsHttpConnectionInfo *ci, AltSvcMapping *mapping)</span>
<span class="lineNum">     544 </span>            :     : mWaiting(2) // waiting for 2 channels (default and alternate) to complete
<span class="lineNum">     545 </span>            :     , mOrigin(origin)
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :     , mAlternatePort(ci-&gt;RoutedPort())</span>
<span class="lineNum">     547 </span>            :     , mMapping(mapping)
<span class="lineNum">     548 </span>            :     , mCI(ci)
<span class="lineNum">     549 </span>            :     , mURI(uri)
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :     , mCaps(caps)</span>
<span class="lineNum">     551 </span>            :   {
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :     LOG((&quot;WellKnownChecker ctor %p\n&quot;, this));</span>
<span class="lineNum">     553 </span>            :     MOZ_ASSERT(!mMapping-&gt;HTTPS());
<a name="554"><span class="lineNum">     554 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :   nsresult Start()</span>
<span class="lineNum">     557 </span>            :   {
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :     LOG((&quot;WellKnownChecker::Start %p\n&quot;, this));</span>
<span class="lineNum">     559 </span>            :     nsCOMPtr&lt;nsILoadInfo&gt; loadInfo = new LoadInfo(nsContentUtils::GetSystemPrincipal(),
<span class="lineNum">     560 </span>            :                                                   nullptr, nullptr,
<span class="lineNum">     561 </span>            :                                                   nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :                                                   nsIContentPolicy::TYPE_OTHER);</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :     loadInfo-&gt;SetOriginAttributes(mCI-&gt;GetOriginAttributes());</span>
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :     RefPtr&lt;nsHttpChannel&gt; chan = new nsHttpChannel();</span>
<span class="lineNum">     566 </span>            :     nsresult rv;
<span class="lineNum">     567 </span>            : 
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :     mTransactionAlternate = new TransactionObserver(chan, this);</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :     RefPtr&lt;nsHttpConnectionInfo&gt; newCI = mCI-&gt;Clone();</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :     rv = MakeChannel(chan, mTransactionAlternate, newCI, mURI, mCaps, loadInfo);</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :     if (NS_FAILED(rv)) {</span>
<span class="lineNum">     572 </span>            :       return rv;
<span class="lineNum">     573 </span>            :     }
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :     chan = new nsHttpChannel();</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :     mTransactionOrigin = new TransactionObserver(chan, this);</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :     newCI = nullptr;</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :     return MakeChannel(chan, mTransactionOrigin, newCI, mURI, mCaps, loadInfo);</span>
<a name="578"><span class="lineNum">     578 </span>            :   }</a>
<span class="lineNum">     579 </span>            : 
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :   void Done(TransactionObserver *finished)</span>
<span class="lineNum">     581 </span>            :   {
<span class="lineNum">     582 </span>            :     MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :     LOG((&quot;WellKnownChecker::Done %p waiting for %d\n&quot;, this, mWaiting));</span>
<span class="lineNum">     584 </span>            : 
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :     mWaiting--; // another channel is complete</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :     if (!mWaiting) { // there are all complete!</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :       nsAutoCString mAlternateCT, mOriginCT;</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :       mTransactionOrigin-&gt;mChannel-&gt;GetContentType(mOriginCT);</span>
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :       mTransactionAlternate-&gt;mChannel-&gt;GetContentType(mAlternateCT);</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :       nsCOMPtr&lt;nsIWellKnownOpportunisticUtils&gt; uu = do_CreateInstance(NS_WELLKNOWNOPPORTUNISTICUTILS_CONTRACTID);</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :       bool accepted = false;</span>
<span class="lineNum">     592 </span>            : 
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :       if (!mTransactionOrigin-&gt;mStatusOK) {</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :         LOG((&quot;WellKnownChecker::Done %p origin was not 200 response code\n&quot;, this));</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :       } else if (!mTransactionAlternate-&gt;mAuthOK) {</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :         LOG((&quot;WellKnownChecker::Done %p alternate was not TLS authenticated\n&quot;, this));</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :       } else if (!mTransactionAlternate-&gt;mStatusOK) {</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :         LOG((&quot;WellKnownChecker::Done %p alternate was not 200 response code\n&quot;, this));</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :       } else if (!mTransactionAlternate-&gt;mVersionOK) {</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :         LOG((&quot;WellKnownChecker::Done %p alternate was not at least h2\n&quot;, this));</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :       } else if (!mTransactionAlternate-&gt;mWKResponse.Equals(mTransactionOrigin-&gt;mWKResponse)) {</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :         LOG((&quot;WellKnownChecker::Done %p alternate and origin &quot;</span>
<span class="lineNum">     603 </span>            :              &quot;.wk representations don't match\norigin: %s\alternate:%s\n&quot;, this,
<span class="lineNum">     604 </span>            :              mTransactionOrigin-&gt;mWKResponse.get(),
<span class="lineNum">     605 </span>            :              mTransactionAlternate-&gt;mWKResponse.get()));
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :       } else if (!mAlternateCT.Equals(mOriginCT)) {</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :         LOG((&quot;WellKnownChecker::Done %p alternate and origin content types dont match\n&quot;, this));</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :       } else if (!mAlternateCT.Equals(NS_LITERAL_CSTRING(&quot;application/json&quot;))) {</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :         LOG((&quot;WellKnownChecker::Done %p .wk content type is %s\n&quot;, this, mAlternateCT.get()));</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :       } else if (!uu) {</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :         LOG((&quot;WellKnownChecker::Done %p json parser service unavailable\n&quot;, this));</span>
<span class="lineNum">     612 </span>            :       } else {
<span class="lineNum">     613 </span>            :         accepted = true;
<span class="lineNum">     614 </span>            :       }
<span class="lineNum">     615 </span>            : 
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :       if (accepted) {</span>
<span class="lineNum">     617 </span>            :         MOZ_ASSERT(!mMapping-&gt;HTTPS()); // https:// does not use .wk
<span class="lineNum">     618 </span>            : 
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :         nsresult rv = uu-&gt;Verify(mTransactionAlternate-&gt;mWKResponse, mOrigin, mAlternatePort);</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :         if (NS_SUCCEEDED(rv)) {</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :           bool validWK = false;</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :           bool mixedScheme = false;</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :           int32_t lifetime = 0;</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :           Unused &lt;&lt; uu-&gt;GetValid(&amp;validWK);</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :           Unused &lt;&lt; uu-&gt;GetLifetime(&amp;lifetime);</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :           Unused &lt;&lt; uu-&gt;GetMixed(&amp;mixedScheme);</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :           if (!validWK) {</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :             LOG((&quot;WellKnownChecker::Done %p json parser declares invalid\n%s\n&quot;, this, mTransactionAlternate-&gt;mWKResponse.get()));</span>
<span class="lineNum">     629 </span>            :             accepted = false;
<span class="lineNum">     630 </span>            :           }
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :           if (accepted &amp;&amp; (lifetime &gt; 0)) {</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :             if (mMapping-&gt;TTL() &gt; lifetime) {</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :               LOG((&quot;WellKnownChecker::Done %p atl-svc lifetime reduced by .wk\n&quot;, this));</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :               mMapping-&gt;SetExpiresAt(NowInSeconds() + lifetime);</span>
<span class="lineNum">     635 </span>            :             } else {
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :               LOG((&quot;WellKnownChecker::Done %p .wk lifetime exceeded alt-svc ma so ignored\n&quot;, this));</span>
<span class="lineNum">     637 </span>            :             }
<span class="lineNum">     638 </span>            :           }
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :           if (accepted &amp;&amp; mixedScheme) {</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :             mMapping-&gt;SetMixedScheme(true);</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :             LOG((&quot;WellKnownChecker::Done %p atl-svc .wk allows mixed scheme\n&quot;, this));</span>
<span class="lineNum">     642 </span>            :           }
<span class="lineNum">     643 </span>            :         } else {
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :           LOG((&quot;WellKnownChecker::Done %p .wk jason eval failed to run\n&quot;, this));</span>
<span class="lineNum">     645 </span>            :           accepted = false;
<span class="lineNum">     646 </span>            :         }
<span class="lineNum">     647 </span>            :       }
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span>            :       MOZ_ASSERT(!mMapping-&gt;Validated());
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :       if (accepted) {</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :         LOG((&quot;WellKnownChecker::Done %p Alternate for %s ACCEPTED\n&quot;, this, mOrigin.get()));</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :         mMapping-&gt;SetValidated(true);</span>
<span class="lineNum">     653 </span>            :       } else {
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :         LOG((&quot;WellKnownChecker::Done %p Alternate for %s FAILED\n&quot;, this, mOrigin.get()));</span>
<span class="lineNum">     655 </span>            :         // try again soon
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :         mMapping-&gt;SetExpiresAt(NowInSeconds() + 2);</span>
<span class="lineNum">     657 </span>            :       }
<span class="lineNum">     658 </span>            : 
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :       delete this;</span>
<span class="lineNum">     660 </span>            :     }
<a name="661"><span class="lineNum">     661 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">     662 </span>            : 
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :   ~WellKnownChecker()</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :   {</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :     LOG((&quot;WellKnownChecker dtor %p\n&quot;, this));</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     667 </span>            : 
<a name="668"><span class="lineNum">     668 </span>            : private:</a>
<span class="lineNum">     669 </span>            :   nsresult
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :   MakeChannel(nsHttpChannel *chan, TransactionObserver *obs, nsHttpConnectionInfo *ci,</span>
<span class="lineNum">     671 </span>            :               nsIURI *uri, uint32_t caps, nsILoadInfo *loadInfo)
<span class="lineNum">     672 </span>            :   {
<span class="lineNum">     673 </span>            :     uint64_t channelId;
<span class="lineNum">     674 </span>            :     nsLoadFlags flags;
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :     if (NS_FAILED(gHttpHandler-&gt;NewChannelId(channelId)) ||</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :         NS_FAILED(chan-&gt;Init(uri, caps, nullptr, 0, nullptr, channelId)) ||</span>
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :         NS_FAILED(chan-&gt;SetAllowAltSvc(false)) ||</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :         NS_FAILED(chan-&gt;SetRedirectMode(nsIHttpChannelInternal::REDIRECT_MODE_ERROR)) ||</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :         NS_FAILED(chan-&gt;SetLoadInfo(loadInfo)) ||</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :         NS_FAILED(chan-&gt;GetLoadFlags(&amp;flags))) {</span>
<span class="lineNum">     681 </span>            :       return NS_ERROR_FAILURE;
<span class="lineNum">     682 </span>            :     }
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :     flags |= HttpBaseChannel::LOAD_BYPASS_CACHE;</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :     if (NS_FAILED(chan-&gt;SetLoadFlags(flags))) {</span>
<span class="lineNum">     685 </span>            :       return NS_ERROR_FAILURE;
<span class="lineNum">     686 </span>            :     }
<span class="lineNum">     687 </span>            :     chan-&gt;SetTransactionObserver(obs);
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :     chan-&gt;SetConnectionInfo(ci);</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :     return chan-&gt;AsyncOpen2(obs);</span>
<span class="lineNum">     690 </span>            :   }
<span class="lineNum">     691 </span>            : 
<span class="lineNum">     692 </span>            :   RefPtr&lt;TransactionObserver&gt;  mTransactionAlternate;
<span class="lineNum">     693 </span>            :   RefPtr&lt;TransactionObserver&gt;  mTransactionOrigin;
<span class="lineNum">     694 </span>            :   uint32_t                     mWaiting; // semaphore
<span class="lineNum">     695 </span>            :   nsCString                    mOrigin;
<span class="lineNum">     696 </span>            :   int32_t                      mAlternatePort;
<span class="lineNum">     697 </span>            :   RefPtr&lt;AltSvcMapping&gt;        mMapping;
<span class="lineNum">     698 </span>            :   RefPtr&lt;nsHttpConnectionInfo&gt; mCI;
<span class="lineNum">     699 </span>            :   nsCOMPtr&lt;nsIURI&gt;             mURI;
<span class="lineNum">     700 </span>            :   uint32_t                     mCaps;
<a name="701"><span class="lineNum">     701 </span>            : };</a>
<span class="lineNum">     702 </span>            : 
<a name="703"><span class="lineNum">     703 </span><span class="lineNoCov">          0 : NS_IMPL_ISUPPORTS(TransactionObserver, nsIStreamListener)</span></a>
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span><span class="lineNoCov">          0 : TransactionObserver::TransactionObserver(nsHttpChannel *channel, WellKnownChecker *checker)</span>
<span class="lineNum">     706 </span>            :   : mChannel(channel)
<span class="lineNum">     707 </span>            :   , mChecker(checker)
<span class="lineNum">     708 </span>            :   , mRanOnce(false)
<span class="lineNum">     709 </span>            :   , mAuthOK(false)
<span class="lineNum">     710 </span>            :   , mVersionOK(false)
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :   , mStatusOK(false)</span>
<span class="lineNum">     712 </span>            : {
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :   LOG((&quot;TransactionObserver ctor %p channel %p checker %p\n&quot;, this, channel, checker));</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :   mChannelRef = do_QueryInterface((nsIHttpChannel *)channel);</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 : }</span>
<a name="716"><span class="lineNum">     716 </span>            : </a>
<span class="lineNum">     717 </span>            : void
<span class="lineNum">     718 </span><span class="lineNoCov">          0 : TransactionObserver::Complete(nsHttpTransaction *aTrans, nsresult reason)</span>
<span class="lineNum">     719 </span>            : {
<span class="lineNum">     720 </span>            :   // socket thread
<span class="lineNum">     721 </span>            :   MOZ_ASSERT(!NS_IsMainThread());
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :   if (mRanOnce) {</span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     724 </span>            :   }
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :   mRanOnce = true;</span>
<span class="lineNum">     726 </span>            : 
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :   RefPtr&lt;nsAHttpConnection&gt; conn = aTrans-&gt;GetConnectionReference();</span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :   LOG((&quot;TransactionObserver::Complete %p aTrans %p reason %&quot; PRIx32 &quot; conn %p\n&quot;,</span>
<span class="lineNum">     729 </span>            :        this, aTrans, static_cast&lt;uint32_t&gt;(reason), conn.get()));
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :   if (!conn) {</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     732 </span>            :   }
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :   uint32_t version = conn-&gt;Version();</span>
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :   mVersionOK = (((reason == NS_BASE_STREAM_CLOSED) || (reason == NS_OK)) &amp;&amp;</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :                 conn-&gt;Version() == HTTP_VERSION_2);</span>
<span class="lineNum">     736 </span>            : 
<span class="lineNum">     737 </span>            :   nsCOMPtr&lt;nsISupports&gt; secInfo;
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :   conn-&gt;GetSecurityInfo(getter_AddRefs(secInfo));</span>
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsISSLSocketControl&gt; socketControl = do_QueryInterface(secInfo);</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :   LOG((&quot;TransactionObserver::Complete version %u socketControl %p\n&quot;,</span>
<span class="lineNum">     741 </span>            :        version, socketControl.get()));
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :   if (!socketControl) {</span>
<span class="lineNum">     743 </span>            :     return;
<span class="lineNum">     744 </span>            :   }
<span class="lineNum">     745 </span>            : 
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :   mAuthOK = !socketControl-&gt;GetFailedVerification();</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :   LOG((&quot;TransactionObserve::Complete %p trans %p authOK %d versionOK %d\n&quot;,</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :        this, aTrans, mAuthOK, mVersionOK));</span>
<span class="lineNum">     749 </span>            : }
<span class="lineNum">     750 </span>            : 
<span class="lineNum">     751 </span>            : #define MAX_WK 32768
<a name="752"><span class="lineNum">     752 </span>            : </a>
<span class="lineNum">     753 </span>            : NS_IMETHODIMP
<span class="lineNum">     754 </span><span class="lineNoCov">          0 : TransactionObserver::OnStartRequest(nsIRequest *aRequest, nsISupports *aContext)</span>
<span class="lineNum">     755 </span>            : {
<span class="lineNum">     756 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     757 </span>            :   // only consider the first 32KB.. because really.
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :   mWKResponse.SetCapacity(MAX_WK);</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     760 </span>            : }
<a name="761"><span class="lineNum">     761 </span>            : </a>
<span class="lineNum">     762 </span>            : NS_IMETHODIMP
<span class="lineNum">     763 </span><span class="lineNoCov">          0 : TransactionObserver::OnDataAvailable(nsIRequest *aRequest, nsISupports *aContext,</span>
<span class="lineNum">     764 </span>            :                                      nsIInputStream *aStream, uint64_t aOffset, uint32_t aCount)
<span class="lineNum">     765 </span>            : {
<span class="lineNum">     766 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :   uint64_t newLen = aCount + mWKResponse.Length();</span>
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :   if (newLen &lt; MAX_WK) {</span>
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :     char *startByte =  reinterpret_cast&lt;char *&gt;(mWKResponse.BeginWriting()) + mWKResponse.Length();</span>
<span class="lineNum">     770 </span>            :     uint32_t amtRead;
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :     if (NS_SUCCEEDED(aStream-&gt;Read(startByte, aCount, &amp;amtRead))) {</span>
<span class="lineNum">     772 </span>            :       MOZ_ASSERT(mWKResponse.Length() + amtRead &lt; MAX_WK);
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :       mWKResponse.SetLength(mWKResponse.Length() + amtRead);</span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :       LOG((&quot;TransactionObserver onDataAvailable %p read %d of .wk [%d]\n&quot;,</span>
<span class="lineNum">     775 </span>            :            this, amtRead, mWKResponse.Length()));
<span class="lineNum">     776 </span>            :     } else {
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :       LOG((&quot;TransactionObserver onDataAvailable %p read error\n&quot;, this));</span>
<span class="lineNum">     778 </span>            :     }
<span class="lineNum">     779 </span>            :   }
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     781 </span>            : }
<a name="782"><span class="lineNum">     782 </span>            : </a>
<span class="lineNum">     783 </span>            : NS_IMETHODIMP
<span class="lineNum">     784 </span><span class="lineNoCov">          0 : TransactionObserver::OnStopRequest(nsIRequest *aRequest, nsISupports *aContext, nsresult code)</span>
<span class="lineNum">     785 </span>            : {
<span class="lineNum">     786 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :   LOG((&quot;TransactionObserver onStopRequest %p code %&quot; PRIx32 &quot;\n&quot;,</span>
<span class="lineNum">     788 </span>            :        this, static_cast&lt;uint32_t&gt;(code)));
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :   if (NS_SUCCEEDED(code)) {</span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :     nsHttpResponseHead *hdrs = mChannel-&gt;GetResponseHead();</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :     LOG((&quot;TransactionObserver onStopRequest %p http resp %d\n&quot;,</span>
<span class="lineNum">     792 </span>            :          this, hdrs ? hdrs-&gt;Status() : -1));
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :     mStatusOK = hdrs &amp;&amp; (hdrs-&gt;Status() == 200);</span>
<span class="lineNum">     794 </span>            :   }
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :   if (mChecker) {</span>
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :     mChecker-&gt;Done(this);</span>
<span class="lineNum">     797 </span>            :   }
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     799 </span>            : }
<a name="800"><span class="lineNum">     800 </span>            : </a>
<span class="lineNum">     801 </span>            : already_AddRefed&lt;AltSvcMapping&gt;
<span class="lineNum">     802 </span><span class="lineCov">          1 : AltSvcCache::LookupMapping(const nsCString &amp;key, bool privateBrowsing)</span>
<span class="lineNum">     803 </span>            : {
<span class="lineNum">     804 </span><span class="lineCov">          1 :   LOG((&quot;AltSvcCache::LookupMapping %p %s\n&quot;, this, key.get()));</span>
<span class="lineNum">     805 </span><span class="lineCov">          1 :   if (!mStorage) {</span>
<span class="lineNum">     806 </span><span class="lineCov">          1 :     LOG((&quot;AltSvcCache::LookupMapping %p no backing store\n&quot;, this));</span>
<span class="lineNum">     807 </span><span class="lineCov">          1 :     return nullptr;</span>
<span class="lineNum">     808 </span>            :   }
<span class="lineNum">     809 </span>            :   nsCString val(mStorage-&gt;Get(key,
<span class="lineNum">     810 </span><span class="lineCov">          1 :                               privateBrowsing ? DataStorage_Private : DataStorage_Persistent));</span>
<span class="lineNum">     811 </span><span class="lineCov">          1 :   if (val.IsEmpty()) {</span>
<span class="lineNum">     812 </span><span class="lineCov">          1 :     LOG((&quot;AltSvcCache::LookupMapping %p MISS\n&quot;, this));</span>
<span class="lineNum">     813 </span><span class="lineCov">          1 :     return nullptr;</span>
<span class="lineNum">     814 </span>            :   }
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :   RefPtr&lt;AltSvcMapping&gt; rv = new AltSvcMapping(mStorage, mStorageEpoch, val);</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :   if (!rv-&gt;Validated() &amp;&amp; (rv-&gt;StorageEpoch() != mStorageEpoch)) {</span>
<span class="lineNum">     817 </span>            :     // this was an in progress validation abandoned in a different session
<span class="lineNum">     818 </span>            :     // rare edge case will not detect session change - that's ok as only impact
<span class="lineNum">     819 </span>            :     // will be loss of alt-svc to this origin for this session.
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcCache::LookupMapping %p invalid hit - MISS\n&quot;, this));</span>
<span class="lineNum">     821 </span>            :     mStorage-&gt;Remove(key,
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :                      rv-&gt;Private() ? DataStorage_Private : DataStorage_Persistent);</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     824 </span>            :   }
<span class="lineNum">     825 </span>            : 
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :   if (rv-&gt;TTL() &lt;= 0) {</span>
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcCache::LookupMapping %p expired hit - MISS\n&quot;, this));</span>
<span class="lineNum">     828 </span>            :     mStorage-&gt;Remove(key,
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :                      rv-&gt;Private() ? DataStorage_Private : DataStorage_Persistent);</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     831 </span>            :   }
<span class="lineNum">     832 </span>            : 
<span class="lineNum">     833 </span>            :   MOZ_ASSERT(rv-&gt;Private() == privateBrowsing);
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :   LOG((&quot;AltSvcCache::LookupMapping %p HIT %p\n&quot;, this, rv.get()));</span>
<span class="lineNum">     835 </span>            :   return rv.forget();
<span class="lineNum">     836 </span>            : }
<a name="837"><span class="lineNum">     837 </span>            : </a>
<span class="lineNum">     838 </span>            : void
<span class="lineNum">     839 </span><span class="lineNoCov">          0 : AltSvcCache::UpdateAltServiceMapping(AltSvcMapping *map, nsProxyInfo *pi,</span>
<span class="lineNum">     840 </span>            :                                      nsIInterfaceRequestor *aCallbacks,
<span class="lineNum">     841 </span>            :                                      uint32_t caps,
<span class="lineNum">     842 </span>            :                                      const OriginAttributes &amp;originAttributes)
<span class="lineNum">     843 </span>            : {
<span class="lineNum">     844 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :   if (!mStorage) {</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     847 </span>            :   }
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :   RefPtr&lt;AltSvcMapping&gt; existing = LookupMapping(map-&gt;HashKey(), map-&gt;Private());</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :   LOG((&quot;AltSvcCache::UpdateAltServiceMapping %p map %p existing %p %s validated=%d&quot;,</span>
<span class="lineNum">     850 </span>            :        this, map, existing.get(), map-&gt;AlternateHost().get(),
<span class="lineNum">     851 </span>            :        existing ? existing-&gt;Validated() : 0));
<span class="lineNum">     852 </span>            : 
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :   if (existing &amp;&amp; existing-&gt;Validated()) {</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :     if (existing-&gt;RouteEquals(map)){</span>
<span class="lineNum">     855 </span>            :       // update expires in storage
<span class="lineNum">     856 </span>            :       // if this is http:// then a ttl can only be extended via .wk, so ignore this
<span class="lineNum">     857 </span>            :       // header path unless it is making things shorter
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :       if (existing-&gt;HTTPS()) {</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :         LOG((&quot;AltSvcCache::UpdateAltServiceMapping %p map %p updates ttl of %p\n&quot;,</span>
<span class="lineNum">     860 </span>            :              this, map, existing.get()));
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :         existing-&gt;SetExpiresAt(map-&gt;GetExpiresAt());</span>
<span class="lineNum">     862 </span>            :       } else {
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :         if (map-&gt;GetExpiresAt() &lt; existing-&gt;GetExpiresAt()) {</span>
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :           LOG((&quot;AltSvcCache::UpdateAltServiceMapping %p map %p reduces ttl of %p\n&quot;,</span>
<span class="lineNum">     865 </span>            :                this, map, existing.get()));
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :           existing-&gt;SetExpiresAt(map-&gt;GetExpiresAt());</span>
<span class="lineNum">     867 </span>            :         } else {
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :           LOG((&quot;AltSvcCache::UpdateAltServiceMapping %p map %p tries to extend %p but&quot;</span>
<span class="lineNum">     869 </span>            :                &quot; cannot as without .wk\n&quot;,
<span class="lineNum">     870 </span>            :                this, map, existing.get()));
<span class="lineNum">     871 </span>            :         }
<span class="lineNum">     872 </span>            :       }
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     874 </span>            :     }
<span class="lineNum">     875 </span>            : 
<span class="lineNum">     876 </span>            :     // new alternate. remove old entry and start new validation
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcCache::UpdateAltServiceMapping %p map %p overwrites %p\n&quot;,</span>
<span class="lineNum">     878 </span>            :          this, map, existing.get()));
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :     existing = nullptr;</span>
<span class="lineNum">     880 </span>            :     mStorage-&gt;Remove(map-&gt;HashKey(),
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :                      map-&gt;Private() ? DataStorage_Private : DataStorage_Persistent);</span>
<span class="lineNum">     882 </span>            :   }
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :   if (existing &amp;&amp; !existing-&gt;Validated()) {</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcCache::UpdateAltServiceMapping %p map %p ignored because %p &quot;</span>
<span class="lineNum">     886 </span>            :          &quot;still in progress\n&quot;, this, map, existing.get()));
<span class="lineNum">     887 </span>            :     return;
<span class="lineNum">     888 </span>            :   }
<span class="lineNum">     889 </span>            : 
<span class="lineNum">     890 </span>            :   // start new validation
<span class="lineNum">     891 </span>            :   MOZ_ASSERT(!map-&gt;Validated());
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :   map-&gt;Sync();</span>
<span class="lineNum">     893 </span>            : 
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :   RefPtr&lt;nsHttpConnectionInfo&gt; ci;</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :   map-&gt;GetConnectionInfo(getter_AddRefs(ci), pi, originAttributes);</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :   caps |= ci-&gt;GetAnonymous() ? NS_HTTP_LOAD_ANONYMOUS : 0;</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :   caps |= NS_HTTP_ERROR_SOFTLY;</span>
<span class="lineNum">     898 </span>            : 
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :   if (map-&gt;HTTPS()) {</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :     LOG((&quot;AltSvcCache::UpdateAltServiceMapping %p validation via &quot;</span>
<span class="lineNum">     901 </span>            :          &quot;speculative connect started\n&quot;, this));
<span class="lineNum">     902 </span>            :     // for https resources we only establish a connection
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIInterfaceRequestor&gt; callbacks = new AltSvcOverride(aCallbacks);</span>
<span class="lineNum">     904 </span>            :     RefPtr&lt;AltSvcTransaction&gt; nullTransaction =
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :       new AltSvcTransaction(map, ci, aCallbacks, caps);</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :     nsresult rv = gHttpHandler-&gt;ConnMgr()-&gt;SpeculativeConnect(ci, callbacks, caps, nullTransaction);</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :     if (NS_FAILED(rv)) {</span>
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :       LOG((&quot;AltSvcCache::UpdateAltServiceMapping %p &quot;</span>
<span class="lineNum">     909 </span>            :            &quot;speculative connect failed with code %08x\n&quot;, this,
<span class="lineNum">     910 </span>            :            static_cast&lt;uint32_t&gt;(rv)));
<span class="lineNum">     911 </span>            :     }
<span class="lineNum">     912 </span>            :   } else {
<span class="lineNum">     913 </span>            :     // for http:// resources we fetch .well-known too
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :     nsAutoCString origin (NS_LITERAL_CSTRING(&quot;http://&quot;) + map-&gt;OriginHost());</span>
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :     if (map-&gt;OriginPort() != NS_HTTP_DEFAULT_PORT) {</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :       origin.Append(':');</span>
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :       origin.AppendInt(map-&gt;OriginPort());</span>
<span class="lineNum">     918 </span>            :     }
<span class="lineNum">     919 </span>            : 
<span class="lineNum">     920 </span>            :     nsCOMPtr&lt;nsIURI&gt; wellKnown;
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :     nsAutoCString uri(origin);</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :     uri.Append(NS_LITERAL_CSTRING(&quot;/.well-known/http-opportunistic&quot;));</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :     NS_NewURI(getter_AddRefs(wellKnown), uri);</span>
<span class="lineNum">     924 </span>            : 
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :     auto *checker = new WellKnownChecker(wellKnown, origin, caps, ci, map);</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :     if (NS_FAILED(checker-&gt;Start())) {</span>
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :       LOG((&quot;AltSvcCache::UpdateAltServiceMapping %p .wk checker failed to start\n&quot;, this));</span>
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :       map-&gt;SetExpired();</span>
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :       delete checker;</span>
<span class="lineNum">     930 </span>            :       checker = nullptr;
<span class="lineNum">     931 </span>            :     } else {
<span class="lineNum">     932 </span>            :       // object deletes itself when done if started
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :       LOG((&quot;AltSvcCache::UpdateAltServiceMapping %p .wk checker started %p\n&quot;, this, checker));</span>
<span class="lineNum">     934 </span>            :     }
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     936 </span>            : }
<a name="937"><span class="lineNum">     937 </span>            : </a>
<span class="lineNum">     938 </span>            : already_AddRefed&lt;AltSvcMapping&gt;
<span class="lineNum">     939 </span><span class="lineCov">          1 : AltSvcCache::GetAltServiceMapping(const nsACString &amp;scheme, const nsACString &amp;host,</span>
<span class="lineNum">     940 </span>            :                                   int32_t port, bool privateBrowsing,
<span class="lineNum">     941 </span>            :                                   const OriginAttributes &amp;originAttributes)
<span class="lineNum">     942 </span>            : {
<span class="lineNum">     943 </span>            :   bool isHTTPS;
<span class="lineNum">     944 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     945 </span><span class="lineCov">          1 :   if (!mStorage) {</span>
<span class="lineNum">     946 </span>            :     // DataStorage gives synchronous access to a memory based hash table
<span class="lineNum">     947 </span>            :     // that is backed by disk where those writes are done asynchronously
<span class="lineNum">     948 </span>            :     // on another thread
<span class="lineNum">     949 </span><span class="lineCov">          1 :     mStorage = DataStorage::Get(DataStorageClass::AlternateServices);</span>
<span class="lineNum">     950 </span><span class="lineCov">          1 :     if (mStorage) {</span>
<span class="lineNum">     951 </span><span class="lineCov">          1 :       bool storageWillPersist = false;</span>
<span class="lineNum">     952 </span><span class="lineCov">          1 :       if (NS_FAILED(mStorage-&gt;Init(storageWillPersist))) {</span>
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :         mStorage = nullptr;</span>
<span class="lineNum">     954 </span>            :       }
<span class="lineNum">     955 </span>            :     }
<span class="lineNum">     956 </span><span class="lineCov">          1 :     if (!mStorage) {</span>
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :       LOG((&quot;AltSvcCache::GetAltServiceMapping WARN NO STORAGE\n&quot;));</span>
<span class="lineNum">     958 </span>            :     }
<span class="lineNum">     959 </span><span class="lineCov">          1 :     mStorageEpoch = NowInSeconds();</span>
<span class="lineNum">     960 </span>            :   }
<span class="lineNum">     961 </span>            : 
<span class="lineNum">     962 </span><span class="lineCov">          1 :   if (NS_FAILED(SchemeIsHTTPS(scheme, isHTTPS))) {</span>
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     964 </span>            :   }
<span class="lineNum">     965 </span><span class="lineCov">          1 :   if (!gHttpHandler-&gt;AllowAltSvc()) {</span>
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     967 </span>            :   }
<span class="lineNum">     968 </span><span class="lineCov">          1 :   if (!gHttpHandler-&gt;AllowAltSvcOE() &amp;&amp; !isHTTPS) {</span>
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     970 </span>            :   }
<span class="lineNum">     971 </span>            : 
<span class="lineNum">     972 </span><span class="lineCov">          1 :   nsAutoCString key;</span>
<span class="lineNum">     973 </span><span class="lineCov">          1 :   AltSvcMapping::MakeHashKey(key, scheme, host, port, privateBrowsing, originAttributes);</span>
<span class="lineNum">     974 </span><span class="lineCov">          1 :   RefPtr&lt;AltSvcMapping&gt; existing = LookupMapping(key, privateBrowsing);</span>
<span class="lineNum">     975 </span><span class="lineCov">          1 :   LOG((&quot;AltSvcCache::GetAltServiceMapping %p key=%s &quot;</span>
<span class="lineNum">     976 </span>            :        &quot;existing=%p validated=%d ttl=%d&quot;,
<span class="lineNum">     977 </span>            :        this, key.get(), existing.get(), existing ? existing-&gt;Validated() : 0,
<span class="lineNum">     978 </span>            :        existing ? existing-&gt;TTL() : 0));
<span class="lineNum">     979 </span><span class="lineCov">          1 :   if (existing &amp;&amp; !existing-&gt;Validated()) {</span>
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :     existing = nullptr;</span>
<span class="lineNum">     981 </span>            :   }
<span class="lineNum">     982 </span>            :   return existing.forget();
<a name="983"><span class="lineNum">     983 </span>            : }</a>
<span class="lineNum">     984 </span>            : 
<a name="985"><span class="lineNum">     985 </span><span class="lineCov">          1 : class ProxyClearHostMapping : public Runnable {</span></a>
<span class="lineNum">     986 </span>            : public:
<span class="lineNum">     987 </span><span class="lineCov">          1 :   explicit ProxyClearHostMapping(const nsACString &amp;host, int32_t port,</span>
<span class="lineNum">     988 </span>            :                                  const OriginAttributes &amp;originAttributes)
<span class="lineNum">     989 </span>            :     : mHost(host)
<span class="lineNum">     990 </span>            :     , mPort(port)
<span class="lineNum">     991 </span><span class="lineCov">          1 :     , mOriginAttributes(originAttributes)</span>
<a name="992"><span class="lineNum">     992 </span><span class="lineCov">          1 :     {}</span></a>
<span class="lineNum">     993 </span>            : 
<span class="lineNum">     994 </span><span class="lineCov">          1 :     NS_IMETHOD Run() override</span>
<span class="lineNum">     995 </span>            :     {
<span class="lineNum">     996 </span>            :       MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     997 </span><span class="lineCov">          1 :       gHttpHandler-&gt;ConnMgr()-&gt;ClearHostMapping(mHost, mPort, mOriginAttributes);</span>
<span class="lineNum">     998 </span><span class="lineCov">          1 :       return NS_OK;</span>
<span class="lineNum">     999 </span>            :     }
<span class="lineNum">    1000 </span>            : private:
<span class="lineNum">    1001 </span>            :     nsCString mHost;
<span class="lineNum">    1002 </span>            :     int32_t mPort;
<span class="lineNum">    1003 </span>            :     OriginAttributes mOriginAttributes;
<span class="lineNum">    1004 </span>            : };
<a name="1005"><span class="lineNum">    1005 </span>            : </a>
<span class="lineNum">    1006 </span>            : void
<span class="lineNum">    1007 </span><span class="lineCov">          1 : AltSvcCache::ClearHostMapping(const nsACString &amp;host, int32_t port,</span>
<span class="lineNum">    1008 </span>            :                               const OriginAttributes &amp;originAttributes)
<span class="lineNum">    1009 </span>            : {
<span class="lineNum">    1010 </span><span class="lineCov">          1 :   if (!NS_IsMainThread()) {</span>
<span class="lineNum">    1011 </span><span class="lineCov">          1 :     nsCOMPtr&lt;nsIRunnable&gt; event = new ProxyClearHostMapping(host, port, originAttributes);</span>
<span class="lineNum">    1012 </span><span class="lineCov">          1 :     if (event) {</span>
<span class="lineNum">    1013 </span><span class="lineCov">          1 :       NS_DispatchToMainThread(event);</span>
<span class="lineNum">    1014 </span>            :     }
<span class="lineNum">    1015 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">    1016 </span>            :   }
<span class="lineNum">    1017 </span><span class="lineCov">          1 :   nsAutoCString key;</span>
<span class="lineNum">    1018 </span>            :   AltSvcMapping::MakeHashKey(key, NS_LITERAL_CSTRING(&quot;http&quot;), host, port, true,
<span class="lineNum">    1019 </span><span class="lineCov">          1 :                              originAttributes);</span>
<span class="lineNum">    1020 </span><span class="lineCov">          1 :   RefPtr&lt;AltSvcMapping&gt; existing = LookupMapping(key, true);</span>
<span class="lineNum">    1021 </span><span class="lineCov">          1 :   if (existing) {</span>
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :     existing-&gt;SetExpired();</span>
<span class="lineNum">    1023 </span>            :   }
<span class="lineNum">    1024 </span>            : 
<span class="lineNum">    1025 </span>            :   AltSvcMapping::MakeHashKey(key, NS_LITERAL_CSTRING(&quot;https&quot;), host, port, true,
<span class="lineNum">    1026 </span><span class="lineCov">          1 :                              originAttributes);</span>
<span class="lineNum">    1027 </span><span class="lineCov">          1 :   existing = LookupMapping(key, true);</span>
<span class="lineNum">    1028 </span><span class="lineCov">          1 :   if (existing) {</span>
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :     existing-&gt;SetExpired();</span>
<span class="lineNum">    1030 </span>            :   }
<span class="lineNum">    1031 </span>            : 
<span class="lineNum">    1032 </span>            :   AltSvcMapping::MakeHashKey(key, NS_LITERAL_CSTRING(&quot;http&quot;), host, port, false,
<span class="lineNum">    1033 </span><span class="lineCov">          1 :                              originAttributes);</span>
<span class="lineNum">    1034 </span><span class="lineCov">          1 :   existing = LookupMapping(key, false);</span>
<span class="lineNum">    1035 </span><span class="lineCov">          1 :   if (existing) {</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :     existing-&gt;SetExpired();</span>
<span class="lineNum">    1037 </span>            :   }
<span class="lineNum">    1038 </span>            : 
<span class="lineNum">    1039 </span>            :   AltSvcMapping::MakeHashKey(key, NS_LITERAL_CSTRING(&quot;https&quot;), host, port, false,
<span class="lineNum">    1040 </span><span class="lineCov">          1 :                              originAttributes);</span>
<span class="lineNum">    1041 </span><span class="lineCov">          1 :   existing = LookupMapping(key, false);</span>
<span class="lineNum">    1042 </span><span class="lineCov">          1 :   if (existing) {</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :     existing-&gt;SetExpired();</span>
<span class="lineNum">    1044 </span>            :   }
<span class="lineNum">    1045 </span>            : }
<a name="1046"><span class="lineNum">    1046 </span>            : </a>
<span class="lineNum">    1047 </span>            : void
<span class="lineNum">    1048 </span><span class="lineCov">          1 : AltSvcCache::ClearHostMapping(nsHttpConnectionInfo *ci)</span>
<span class="lineNum">    1049 </span>            : {
<span class="lineNum">    1050 </span><span class="lineCov">          1 :   if (!ci-&gt;GetOrigin().IsEmpty()) {</span>
<span class="lineNum">    1051 </span><span class="lineCov">          1 :     ClearHostMapping(ci-&gt;GetOrigin(), ci-&gt;OriginPort(), ci-&gt;GetOriginAttributes());</span>
<span class="lineNum">    1052 </span>            :   }
<span class="lineNum">    1053 </span><span class="lineCov">          1 : }</span>
<a name="1054"><span class="lineNum">    1054 </span>            : </a>
<span class="lineNum">    1055 </span>            : void
<span class="lineNum">    1056 </span><span class="lineCov">          1 : AltSvcCache::ClearAltServiceMappings()</span>
<span class="lineNum">    1057 </span>            : {
<span class="lineNum">    1058 </span>            :     MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    1059 </span><span class="lineCov">          1 :     if (mStorage) {</span>
<span class="lineNum">    1060 </span><span class="lineCov">          1 :       mStorage-&gt;Clear();</span>
<span class="lineNum">    1061 </span>            :     }
<span class="lineNum">    1062 </span><span class="lineCov">          1 : }</span>
<a name="1063"><span class="lineNum">    1063 </span>            : </a>
<span class="lineNum">    1064 </span>            : NS_IMETHODIMP
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 : AltSvcOverride::GetInterface(const nsIID &amp;iid, void **result)</span>
<span class="lineNum">    1066 </span>            : {
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :   if (NS_SUCCEEDED(QueryInterface(iid, result)) &amp;&amp; *result) {</span>
<span class="lineNum">    1068 </span>            :     return NS_OK;
<span class="lineNum">    1069 </span>            :   }
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :   return mCallbacks-&gt;GetInterface(iid, result);</span>
<span class="lineNum">    1071 </span>            : }
<a name="1072"><span class="lineNum">    1072 </span>            : </a>
<span class="lineNum">    1073 </span>            : NS_IMETHODIMP
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 : AltSvcOverride::GetIgnoreIdle(bool *ignoreIdle)</span>
<span class="lineNum">    1075 </span>            : {
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :   *ignoreIdle = true;</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1078 </span>            : }
<a name="1079"><span class="lineNum">    1079 </span>            : </a>
<span class="lineNum">    1080 </span>            : NS_IMETHODIMP
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 : AltSvcOverride::GetParallelSpeculativeConnectLimit(</span>
<span class="lineNum">    1082 </span>            :   uint32_t *parallelSpeculativeConnectLimit)
<span class="lineNum">    1083 </span>            : {
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :   *parallelSpeculativeConnectLimit = 32;</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1086 </span>            : }
<a name="1087"><span class="lineNum">    1087 </span>            : </a>
<span class="lineNum">    1088 </span>            : NS_IMETHODIMP
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 : AltSvcOverride::GetIsFromPredictor(bool *isFromPredictor)</span>
<span class="lineNum">    1090 </span>            : {
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :   *isFromPredictor = false;</span>
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1093 </span>            : }
<a name="1094"><span class="lineNum">    1094 </span>            : </a>
<span class="lineNum">    1095 </span>            : NS_IMETHODIMP
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 : AltSvcOverride::GetAllow1918(bool *allow)</span>
<span class="lineNum">    1097 </span>            : {
<span class="lineNum">    1098 </span>            :   // normally we don't do speculative connects to 1918.. and we use
<span class="lineNum">    1099 </span>            :   // speculative connects for the mapping validation, so override
<span class="lineNum">    1100 </span>            :   // that default here for alt-svc
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :   *allow = true;</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<a name="1103"><span class="lineNum">    1103 </span>            : }</a>
<span class="lineNum">    1104 </span>            : 
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 : NS_IMPL_ISUPPORTS(AltSvcOverride, nsIInterfaceRequestor, nsISpeculativeConnectionOverrider)</span>
<span class="lineNum">    1106 </span>            : 
<span class="lineNum">    1107 </span>            : } // namespace net
<span class="lineNum">    1108 </span>            : } // namespace mozilla
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
