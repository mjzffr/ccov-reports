<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - security/sandbox/linux/reporter/SandboxReporter.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">security/sandbox/linux/reporter</a> - SandboxReporter.cpp<span style="font-size: 80%;"> (source / <a href="SandboxReporter.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">45</td>
            <td class="headerCovTableEntry">88</td>
            <td class="headerCovTableEntryLo">51.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21 12:24:28</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">9</td>
            <td class="headerCovTableEntry">11</td>
            <td class="headerCovTableEntryMed">81.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* vim: set ts=8 sts=2 et sw=2 tw=80: */
<span class="lineNum">       3 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       4 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this file,
<span class="lineNum">       5 </span>            :  * You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            : #include &quot;SandboxReporter.h&quot;
<span class="lineNum">       8 </span>            : #include &quot;SandboxLogging.h&quot;
<span class="lineNum">       9 </span>            : 
<span class="lineNum">      10 </span>            : #include &lt;algorithm&gt;
<span class="lineNum">      11 </span>            : #include &lt;errno.h&gt;
<span class="lineNum">      12 </span>            : #include &lt;sys/socket.h&gt;
<span class="lineNum">      13 </span>            : #include &lt;sys/types.h&gt;
<span class="lineNum">      14 </span>            : #include &lt;time.h&gt; // for clockid_t
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : #include &quot;mozilla/Assertions.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;mozilla/ClearOnShutdown.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;mozilla/StaticMutex.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;mozilla/PodOperations.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;nsThreadUtils.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;mozilla/Telemetry.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;sandbox/linux/system_headers/linux_syscalls.h&quot;
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : // Distinguish architectures for the telemetry key.
<span class="lineNum">      25 </span>            : #if defined(__i386__)
<span class="lineNum">      26 </span>            : #define SANDBOX_ARCH_NAME &quot;x86&quot;
<span class="lineNum">      27 </span>            : #elif defined(__x86_64__)
<span class="lineNum">      28 </span>            : #define SANDBOX_ARCH_NAME &quot;amd64&quot;
<span class="lineNum">      29 </span>            : #else
<span class="lineNum">      30 </span>            : #error &quot;unrecognized architecture&quot;
<span class="lineNum">      31 </span>            : #endif
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : namespace mozilla {
<span class="lineNum">      34 </span>            : 
<a name="35"><span class="lineNum">      35 </span>            : StaticAutoPtr&lt;SandboxReporter&gt; SandboxReporter::sSingleton;</a>
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span><span class="lineCov">          1 : SandboxReporter::SandboxReporter()</span>
<span class="lineNum">      38 </span>            :   : mClientFd(-1)
<span class="lineNum">      39 </span>            :   , mServerFd(-1)
<span class="lineNum">      40 </span>            :   , mMutex(&quot;SandboxReporter&quot;)
<span class="lineNum">      41 </span>            :   , mBuffer(MakeUnique&lt;SandboxReport[]&gt;(kSandboxReporterBufferSize))
<span class="lineNum">      42 </span><span class="lineCov">          1 :   , mCount(0)</span>
<span class="lineNum">      43 </span>            : {
<span class="lineNum">      44 </span><span class="lineCov">          1 : }</span>
<a name="45"><span class="lineNum">      45 </span>            : </a>
<span class="lineNum">      46 </span>            : bool
<span class="lineNum">      47 </span><span class="lineCov">          1 : SandboxReporter::Init()</span>
<span class="lineNum">      48 </span>            : {
<span class="lineNum">      49 </span>            :   int fds[2];
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span><span class="lineCov">          1 :   if (0 != socketpair(AF_UNIX, SOCK_SEQPACKET, 0, fds)) {</span>
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :     SANDBOX_LOG_ERROR(&quot;SandboxReporter: socketpair failed: %s&quot;,</span>
<span class="lineNum">      53 </span>            :                       strerror(errno));
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">      55 </span>            :   }
<span class="lineNum">      56 </span><span class="lineCov">          1 :   mClientFd = fds[0];</span>
<span class="lineNum">      57 </span><span class="lineCov">          1 :   mServerFd = fds[1];</span>
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span><span class="lineCov">          1 :   if (!PlatformThread::Create(0, this, &amp;mThread)) {</span>
<span class="lineNum">      60 </span><span class="lineNoCov">          0 :     SANDBOX_LOG_ERROR(&quot;SandboxReporter: thread creation failed: %s&quot;,</span>
<span class="lineNum">      61 </span>            :                       strerror(errno));
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :     close(mClientFd);</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :     close(mServerFd);</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :     mClientFd = mServerFd = -1;</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">      66 </span>            :   }
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            :   return true;
<a name="69"><span class="lineNum">      69 </span>            : }</a>
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span><span class="lineCov">          1 : SandboxReporter::~SandboxReporter()</span>
<span class="lineNum">      72 </span>            : {
<span class="lineNum">      73 </span><span class="lineCov">          1 :   if (mServerFd &lt; 0) {</span>
<span class="lineNum">      74 </span>            :     return;
<span class="lineNum">      75 </span>            :   }
<span class="lineNum">      76 </span><span class="lineCov">          1 :   shutdown(mServerFd, SHUT_RD);</span>
<span class="lineNum">      77 </span><span class="lineCov">          1 :   PlatformThread::Join(mThread);</span>
<span class="lineNum">      78 </span><span class="lineCov">          1 :   close(mServerFd);</span>
<span class="lineNum">      79 </span><span class="lineCov">          1 :   close(mClientFd);</span>
<span class="lineNum">      80 </span><span class="lineCov">          1 : }</span>
<a name="81"><span class="lineNum">      81 </span>            : </a>
<span class="lineNum">      82 </span>            : /* static */ SandboxReporter*
<span class="lineNum">      83 </span><span class="lineCov">          1 : SandboxReporter::Singleton()</span>
<span class="lineNum">      84 </span>            : {
<span class="lineNum">      85 </span>            :   static StaticMutex sMutex;
<span class="lineNum">      86 </span>            :   StaticMutexAutoLock lock(sMutex);
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span><span class="lineCov">          1 :   if (sSingleton == nullptr) {</span>
<span class="lineNum">      89 </span><span class="lineCov">          1 :     sSingleton = new SandboxReporter();</span>
<span class="lineNum">      90 </span><span class="lineCov">          1 :     if (!sSingleton-&gt;Init()) {</span>
<span class="lineNum">      91 </span>            :       // If socketpair or thread creation failed, trying to continue
<span class="lineNum">      92 </span>            :       // with child process creation is unlikely to succeed; crash
<span class="lineNum">      93 </span>            :       // instead of trying to handle that case.
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :       MOZ_CRASH(&quot;SandboxRepoter::Singleton: initialization failed&quot;);</span>
<span class="lineNum">      95 </span>            :     }
<span class="lineNum">      96 </span>            :     // ClearOnShutdown must be called on the main thread and will
<span class="lineNum">      97 </span>            :     // destroy the object on the main thread.  That *should* be safe;
<span class="lineNum">      98 </span>            :     // the destructor will shut down the reporter's socket reader
<span class="lineNum">      99 </span>            :     // thread before freeing anything, IPC should already be shut down
<span class="lineNum">     100 </span>            :     // by that point (so it won't race by calling Singleton()), all
<a name="101"><span class="lineNum">     101 </span>            :     // non-main XPCOM threads will also be shut down, and currently</a>
<span class="lineNum">     102 </span>            :     // the only other user is the main-thread-only Troubleshoot.jsm.
<span class="lineNum">     103 </span><span class="lineCov">          1 :     NS_DispatchToMainThread(NS_NewRunnableFunction([] {</span>
<span class="lineNum">     104 </span><span class="lineCov">          1 :       ClearOnShutdown(&amp;sSingleton);</span>
<span class="lineNum">     105 </span><span class="lineCov">          1 :     }));</span>
<span class="lineNum">     106 </span>            :   }
<span class="lineNum">     107 </span><span class="lineCov">          1 :   return sSingleton.get();</span>
<span class="lineNum">     108 </span>            : }
<a name="109"><span class="lineNum">     109 </span>            : </a>
<span class="lineNum">     110 </span>            : void
<span class="lineNum">     111 </span><span class="lineCov">          1 : SandboxReporter::GetClientFileDescriptorMapping(int* aSrcFd, int* aDstFd) const</span>
<span class="lineNum">     112 </span>            : {
<span class="lineNum">     113 </span>            :   MOZ_ASSERT(mClientFd &gt;= 0);
<span class="lineNum">     114 </span><span class="lineCov">          1 :   *aSrcFd = mClientFd;</span>
<span class="lineNum">     115 </span><span class="lineCov">          1 :   *aDstFd = kSandboxReporterFileDesc;</span>
<span class="lineNum">     116 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     117 </span>            : 
<span class="lineNum">     118 </span>            : // This function is mentioned in Histograms.json; keep that in mind if
<a name="119"><span class="lineNum">     119 </span>            : // it's renamed or moved to a different file.</a>
<span class="lineNum">     120 </span>            : static void
<span class="lineNum">     121 </span><span class="lineNoCov">          0 : SubmitToTelemetry(const SandboxReport&amp; aReport)</span>
<span class="lineNum">     122 </span>            : {
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :   nsAutoCString key;</span>
<span class="lineNum">     124 </span>            :   // The key contains the process type, something that uniquely
<span class="lineNum">     125 </span>            :   // identifies the syscall, and in some cases arguments (see below
<span class="lineNum">     126 </span>            :   // for details).  Arbitrary formatting choice: fields in the key are
<span class="lineNum">     127 </span>            :   // separated by ':', except that (arch, syscall#) pairs are
<span class="lineNum">     128 </span>            :   // separated by '/'.
<span class="lineNum">     129 </span>            :   //
<span class="lineNum">     130 </span>            :   // Examples:
<span class="lineNum">     131 </span>            :   // * &quot;content:x86/64&quot;           (bug 1285768)
<span class="lineNum">     132 </span>            :   // * &quot;content:x86_64/110&quot;       (bug 1285768)
<span class="lineNum">     133 </span>            :   // * &quot;gmp:madvise:8&quot;            (bug 1303813)
<span class="lineNum">     134 </span>            :   // * &quot;content:clock_gettime:4&quot;  (bug 1334687)
<span class="lineNum">     135 </span>            : 
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :   switch (aReport.mProcType) {</span>
<span class="lineNum">     137 </span>            :   case SandboxReport::ProcType::CONTENT:
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :     key.AppendLiteral(&quot;content&quot;);</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     140 </span>            :   case SandboxReport::ProcType::MEDIA_PLUGIN:
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :     key.AppendLiteral(&quot;gmp&quot;);</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :     break;</span>
<span class="lineNum">     143 </span>            :   default:
<span class="lineNum">     144 </span>            :     MOZ_ASSERT(false);
<span class="lineNum">     145 </span>            :   }
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :   key.Append(':');</span>
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :   switch(aReport.mSyscall) {</span>
<span class="lineNum">     149 </span>            :     // Syscalls that are filtered by arguments in one or more of the
<span class="lineNum">     150 </span>            :     // policies in SandboxFilter.cpp should generally have those
<span class="lineNum">     151 </span>            :     // arguments included here, but don't include irrelevant
<span class="lineNum">     152 </span>            :     // information that would cause large numbers of distinct keys for
<span class="lineNum">     153 </span>            :     // the same issue -- for example, pids or pointers.  When in
<span class="lineNum">     154 </span>            :     // doubt, include arguments only if they would typically be
<span class="lineNum">     155 </span>            :     // constants (or asm immediates) in the code making the syscall.
<span class="lineNum">     156 </span>            :     //
<span class="lineNum">     157 </span>            :     // Also, keep in mind that this is opt-out data collection and
<span class="lineNum">     158 </span>            :     // privacy is critical.  While it's unlikely that information in
<span class="lineNum">     159 </span>            :     // the register values alone could personally identify a user
<span class="lineNum">     160 </span>            :     // (see also crash reports, where register contents are public),
<span class="lineNum">     161 </span>            :     // and the guidelines in the previous paragraph should rule out
<span class="lineNum">     162 </span>            :     // any value that's capable of holding PII, please be careful.
<span class="lineNum">     163 </span>            :     //
<span class="lineNum">     164 </span>            :     // When making changes here, please consult with a data steward
<span class="lineNum">     165 </span>            :     // (https://wiki.mozilla.org/Firefox/Data_Collection) and ask for
<span class="lineNum">     166 </span>            :     // a review if you are unsure about anything.
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span>            :     // This macro includes one argument as a decimal number; it should
<span class="lineNum">     169 </span>            :     // be enough for most cases.
<span class="lineNum">     170 </span>            : #define ARG_DECIMAL(name, idx)           \
<span class="lineNum">     171 </span>            :     case __NR_##name:                    \
<span class="lineNum">     172 </span>            :       key.AppendLiteral(#name &quot;:&quot;);      \
<span class="lineNum">     173 </span>            :       key.AppendInt(aReport.mArgs[idx]); \
<span class="lineNum">     174 </span>            :       break
<span class="lineNum">     175 </span>            : 
<span class="lineNum">     176 </span>            :     // This may be more convenient if the argument is a set of bit flags.
<span class="lineNum">     177 </span>            : #define ARG_HEX(name, idx)                    \
<span class="lineNum">     178 </span>            :     case __NR_##name:                         \
<span class="lineNum">     179 </span>            :       key.AppendLiteral(#name &quot;:0x&quot;);         \
<span class="lineNum">     180 </span>            :       key.AppendInt(aReport.mArgs[idx], 16);  \
<span class="lineNum">     181 </span>            :       break
<span class="lineNum">     182 </span>            : 
<span class="lineNum">     183 </span>            :     // clockid_t is annoying: there are a small set of fixed timers,
<span class="lineNum">     184 </span>            :     // but it can also encode a pid/tid (or a fd for a hardware clock
<span class="lineNum">     185 </span>            :     // device); in this case the value is negative.
<span class="lineNum">     186 </span>            : #define ARG_CLOCKID(name, idx)                              \
<span class="lineNum">     187 </span>            :     case __NR_##name:                                       \
<span class="lineNum">     188 </span>            :       key.AppendLiteral(#name &quot;:&quot;);                         \
<span class="lineNum">     189 </span>            :       if (static_cast&lt;clockid_t&gt;(aReport.mArgs[idx]) &lt; 0) { \
<span class="lineNum">     190 </span>            :         key.AppendLiteral(&quot;dynamic&quot;);                       \
<span class="lineNum">     191 </span>            :       } else {                                              \
<span class="lineNum">     192 </span>            :         key.AppendInt(aReport.mArgs[idx]);                  \
<span class="lineNum">     193 </span>            :       }                                                     \
<span class="lineNum">     194 </span>            :       break
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span>            :     // The syscalls handled specially:
<span class="lineNum">     197 </span>            : 
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :     ARG_HEX(clone, 0); // flags</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     ARG_DECIMAL(prctl, 0); // option</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :     ARG_DECIMAL(madvise, 2); // advice</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :     ARG_CLOCKID(clock_gettime, 0); // clk_id</span>
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span>            : #ifdef __NR_socketcall
<span class="lineNum">     204 </span>            :     ARG_DECIMAL(socketcall, 0); // call
<span class="lineNum">     205 </span>            : #endif
<span class="lineNum">     206 </span>            : #ifdef __NR_ipc
<span class="lineNum">     207 </span>            :     ARG_DECIMAL(ipc, 0); // call
<span class="lineNum">     208 </span>            : #endif
<span class="lineNum">     209 </span>            : 
<span class="lineNum">     210 </span>            : #undef ARG_DECIMAL
<span class="lineNum">     211 </span>            : #undef ARG_HEX
<span class="lineNum">     212 </span>            : #undef ARG_CLOCKID
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span>            :   default:
<span class="lineNum">     215 </span>            :     // Otherwise just use the number, with the arch name to disambiguate.
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :     key.Append(SANDBOX_ARCH_NAME &quot;/&quot;);</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :     key.AppendInt(aReport.mSyscall);</span>
<span class="lineNum">     218 </span>            :   }
<span class="lineNum">     219 </span>            : 
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :   Telemetry::Accumulate(Telemetry::SANDBOX_REJECTED_SYSCALLS, key);</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 : }</span>
<a name="222"><span class="lineNum">     222 </span>            : </a>
<span class="lineNum">     223 </span>            : void
<span class="lineNum">     224 </span><span class="lineNoCov">          0 : SandboxReporter::AddOne(const SandboxReport&amp; aReport)</span>
<span class="lineNum">     225 </span>            : {
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :   SubmitToTelemetry(aReport);</span>
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :   MutexAutoLock lock(mMutex);</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :   mBuffer[mCount % kSandboxReporterBufferSize] = aReport;</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :   ++mCount;</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 : }</span>
<a name="232"><span class="lineNum">     232 </span>            : </a>
<span class="lineNum">     233 </span>            : void
<span class="lineNum">     234 </span><span class="lineCov">          1 : SandboxReporter::ThreadMain(void)</span>
<span class="lineNum">     235 </span>            : {
<span class="lineNum">     236 </span>            :   for (;;) {
<span class="lineNum">     237 </span>            :     SandboxReport rep;
<span class="lineNum">     238 </span>            :     struct iovec iov;
<span class="lineNum">     239 </span>            :     struct msghdr msg;
<span class="lineNum">     240 </span>            : 
<span class="lineNum">     241 </span><span class="lineCov">          1 :     iov.iov_base = &amp;rep;</span>
<span class="lineNum">     242 </span><span class="lineCov">          1 :     iov.iov_len = sizeof(rep);</span>
<span class="lineNum">     243 </span>            :     PodZero(&amp;msg);
<span class="lineNum">     244 </span><span class="lineCov">          1 :     msg.msg_iov = &amp;iov;</span>
<span class="lineNum">     245 </span><span class="lineCov">          1 :     msg.msg_iovlen = 1;</span>
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span><span class="lineCov">          1 :     const auto recvd = recvmsg(mServerFd, &amp;msg, 0);</span>
<span class="lineNum">     248 </span><span class="lineCov">          1 :     if (recvd &lt; 0) {</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :       if (errno == EINTR) {</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     251 </span>            :       }
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :       SANDBOX_LOG_ERROR(&quot;SandboxReporter: recvmsg: %s&quot;, strerror(errno));</span>
<span class="lineNum">     253 </span>            :     }
<span class="lineNum">     254 </span><span class="lineCov">          1 :     if (recvd &lt;= 0) {</span>
<span class="lineNum">     255 </span>            :       break;
<span class="lineNum">     256 </span>            :     }
<span class="lineNum">     257 </span>            : 
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :     if (static_cast&lt;size_t&gt;(recvd) &lt; sizeof(rep)) {</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :       SANDBOX_LOG_ERROR(&quot;SandboxReporter: packet too short (%d &lt; %d)&quot;,</span>
<span class="lineNum">     260 </span>            :                         recvd, sizeof(rep));
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">     262 </span>            :     }
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :     if (msg.msg_flags &amp; MSG_TRUNC) {</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :       SANDBOX_LOG_ERROR(&quot;SandboxReporter: packet too long&quot;);</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">     266 </span>            :     }
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :     AddOne(rep);</span>
<span class="lineNum">     269 </span>            :   }
<span class="lineNum">     270 </span><span class="lineCov">          1 : }</span>
<a name="271"><span class="lineNum">     271 </span>            : </a>
<span class="lineNum">     272 </span>            : SandboxReporter::Snapshot
<span class="lineNum">     273 </span><span class="lineCov">          1 : SandboxReporter::GetSnapshot()</span>
<span class="lineNum">     274 </span>            : {
<span class="lineNum">     275 </span>            :   Snapshot snapshot;
<span class="lineNum">     276 </span><span class="lineCov">          1 :   MutexAutoLock lock(mMutex);</span>
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span><span class="lineCov">          1 :   const uint64_t bufSize = static_cast&lt;uint64_t&gt;(kSandboxReporterBufferSize);</span>
<span class="lineNum">     279 </span><span class="lineCov">          1 :   const uint64_t start = std::max(mCount, bufSize) - bufSize;</span>
<span class="lineNum">     280 </span><span class="lineCov">          1 :   snapshot.mOffset = start;</span>
<span class="lineNum">     281 </span><span class="lineCov">          1 :   snapshot.mReports.Clear();</span>
<span class="lineNum">     282 </span><span class="lineCov">          1 :   snapshot.mReports.SetCapacity(mCount - start);</span>
<span class="lineNum">     283 </span><span class="lineCov">          1 :   for (size_t i = start; i &lt; mCount; ++i) {</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     const SandboxReport* rep = &amp;mBuffer[i % kSandboxReporterBufferSize];</span>
<span class="lineNum">     285 </span>            :     MOZ_ASSERT(rep-&gt;IsValid());
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :     snapshot.mReports.AppendElement(*rep);</span>
<span class="lineNum">     287 </span>            :   }
<span class="lineNum">     288 </span>            :   // Named Return Value Optimization would apply here, but C++11
<span class="lineNum">     289 </span>            :   // doesn't require it; so, instead of possibly copying the entire
<span class="lineNum">     290 </span>            :   // array contents, invoke the move constructor and copy at most a
<span class="lineNum">     291 </span>            :   // few words.
<span class="lineNum">     292 </span><span class="lineCov">          1 :   return Move(snapshot);</span>
<span class="lineNum">     293 </span>            : }
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span>            : } // namespace mozilla
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
