<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - gfx/thebes/gfxFcPlatformFontList.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">gfx/thebes</a> - gfxFcPlatformFontList.cpp<span style="font-size: 80%;"> (source / <a href="gfxFcPlatformFontList.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">588</td>
            <td class="headerCovTableEntry">736</td>
            <td class="headerCovTableEntryMed">79.9 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21 12:24:28</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">53</td>
            <td class="headerCovTableEntry">58</td>
            <td class="headerCovTableEntryHi">91.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-</a>
<span class="lineNum">       2 </span>            :  * This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       3 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       4 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            : #include &quot;mozilla/Logging.h&quot;
<span class="lineNum">       7 </span>            : #include &quot;mozilla/SizePrintfMacros.h&quot;
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : #include &quot;gfxFcPlatformFontList.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;gfxFont.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;gfxFontConstants.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;gfxFontFamilyList.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;gfxFT2Utils.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;gfxPlatform.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;mozilla/ArrayUtils.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;mozilla/Preferences.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;mozilla/Sprintf.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;mozilla/TimeStamp.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;nsGkAtoms.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;nsILanguageAtomService.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;nsUnicodeProperties.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;nsUnicodeRange.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;nsDirectoryServiceUtils.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;nsDirectoryServiceDefs.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;nsAppDirectoryServiceDefs.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;nsCharSeparatedTokenizer.h&quot;
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : #include &quot;mozilla/gfx/HelpersCairo.h&quot;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : #include &lt;fontconfig/fcfreetype.h&gt;
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : #ifdef MOZ_WIDGET_GTK
<span class="lineNum">      33 </span>            : #include &lt;gdk/gdk.h&gt;
<span class="lineNum">      34 </span>            : #include &quot;gfxPlatformGtk.h&quot;
<span class="lineNum">      35 </span>            : #endif
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : #ifdef MOZ_X11
<span class="lineNum">      38 </span>            : #include &quot;mozilla/X11Util.h&quot;
<span class="lineNum">      39 </span>            : #endif
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : using namespace mozilla;
<span class="lineNum">      42 </span>            : using namespace mozilla::gfx;
<span class="lineNum">      43 </span>            : using namespace mozilla::unicode;
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span>            : #ifndef FC_POSTSCRIPT_NAME
<span class="lineNum">      46 </span>            : #define FC_POSTSCRIPT_NAME  &quot;postscriptname&quot;      /* String */
<span class="lineNum">      47 </span>            : #endif
<span class="lineNum">      48 </span>            : 
<span class="lineNum">      49 </span>            : #define PRINTING_FC_PROPERTY &quot;gfx.printing&quot;
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span>            : #define LOG_FONTLIST(args) MOZ_LOG(gfxPlatform::GetLog(eGfxLog_fontlist), \
<span class="lineNum">      52 </span>            :                                LogLevel::Debug, args)
<span class="lineNum">      53 </span>            : #define LOG_FONTLIST_ENABLED() MOZ_LOG_TEST( \
<span class="lineNum">      54 </span>            :                                    gfxPlatform::GetLog(eGfxLog_fontlist), \
<span class="lineNum">      55 </span>            :                                    LogLevel::Debug)
<span class="lineNum">      56 </span>            : #define LOG_CMAPDATA_ENABLED() MOZ_LOG_TEST( \
<span class="lineNum">      57 </span>            :                                    gfxPlatform::GetLog(eGfxLog_cmapdata), \
<span class="lineNum">      58 </span>            :                                    LogLevel::Debug)
<span class="lineNum">      59 </span>            : 
<span class="lineNum">      60 </span>            : static const FcChar8*
<span class="lineNum">      61 </span>            : ToFcChar8Ptr(const char* aStr)
<span class="lineNum">      62 </span>            : {
<span class="lineNum">      63 </span>            :     return reinterpret_cast&lt;const FcChar8*&gt;(aStr);
<span class="lineNum">      64 </span>            : }
<span class="lineNum">      65 </span>            : 
<span class="lineNum">      66 </span>            : static const char*
<span class="lineNum">      67 </span>            : ToCharPtr(const FcChar8 *aStr)
<span class="lineNum">      68 </span>            : {
<span class="lineNum">      69 </span>            :     return reinterpret_cast&lt;const char*&gt;(aStr);
<span class="lineNum">      70 </span>            : }
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span>            : FT_Library gfxFcPlatformFontList::sCairoFTLibrary = nullptr;
<span class="lineNum">      73 </span>            : 
<span class="lineNum">      74 </span>            : static cairo_user_data_key_t sFcFontlistUserFontDataKey;
<span class="lineNum">      75 </span>            : 
<span class="lineNum">      76 </span>            : // canonical name ==&gt; first en name or first name if no en name
<a name="77"><span class="lineNum">      77 </span>            : // This is the required logic for fullname lookups as per CSS3 Fonts spec.</a>
<span class="lineNum">      78 </span>            : static uint32_t
<span class="lineNum">      79 </span><span class="lineCov">          1 : FindCanonicalNameIndex(FcPattern* aFont, const char* aLangField)</span>
<span class="lineNum">      80 </span>            : {
<span class="lineNum">      81 </span><span class="lineCov">          1 :     uint32_t n = 0, en = 0;</span>
<span class="lineNum">      82 </span>            :     FcChar8* lang;
<span class="lineNum">      83 </span><span class="lineCov">          1 :     while (FcPatternGetString(aFont, aLangField, n, &amp;lang) == FcResultMatch) {</span>
<span class="lineNum">      84 </span>            :         // look for 'en' or variants, en-US, en-JP etc.
<span class="lineNum">      85 </span><span class="lineCov">          1 :         uint32_t len = strlen(ToCharPtr(lang));</span>
<span class="lineNum">      86 </span><span class="lineCov">          1 :         bool enPrefix = (strncmp(ToCharPtr(lang), &quot;en&quot;, 2) == 0);</span>
<span class="lineNum">      87 </span><span class="lineCov">          1 :         if (enPrefix &amp;&amp; (len == 2 || (len &gt; 2 &amp;&amp; aLangField[2] == '-'))) {</span>
<span class="lineNum">      88 </span><span class="lineCov">          1 :             en = n;</span>
<span class="lineNum">      89 </span><span class="lineCov">          1 :             break;</span>
<span class="lineNum">      90 </span>            :         }
<span class="lineNum">      91 </span><span class="lineCov">          1 :         n++;</span>
<span class="lineNum">      92 </span>            :     }
<span class="lineNum">      93 </span><span class="lineCov">          1 :     return en;</span>
<span class="lineNum">      94 </span>            : }
<a name="95"><span class="lineNum">      95 </span>            : </a>
<span class="lineNum">      96 </span>            : static void
<span class="lineNum">      97 </span><span class="lineCov">          1 : GetFaceNames(FcPattern* aFont, const nsAString&amp; aFamilyName,</span>
<span class="lineNum">      98 </span>            :              nsAString&amp; aPostscriptName, nsAString&amp; aFullname)
<span class="lineNum">      99 </span>            : {
<span class="lineNum">     100 </span>            :     // get the Postscript name
<span class="lineNum">     101 </span>            :     FcChar8* psname;
<span class="lineNum">     102 </span><span class="lineCov">          1 :     if (FcPatternGetString(aFont, FC_POSTSCRIPT_NAME, 0, &amp;psname) == FcResultMatch) {</span>
<span class="lineNum">     103 </span><span class="lineCov">          1 :         AppendUTF8toUTF16(ToCharPtr(psname), aPostscriptName);</span>
<span class="lineNum">     104 </span>            :     }
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span>            :     // get the canonical fullname (i.e. en name or first name)
<span class="lineNum">     107 </span><span class="lineCov">          1 :     uint32_t en = FindCanonicalNameIndex(aFont, FC_FULLNAMELANG);</span>
<span class="lineNum">     108 </span>            :     FcChar8* fullname;
<span class="lineNum">     109 </span><span class="lineCov">          1 :     if (FcPatternGetString(aFont, FC_FULLNAME, en, &amp;fullname) == FcResultMatch) {</span>
<span class="lineNum">     110 </span><span class="lineCov">          1 :         AppendUTF8toUTF16(ToCharPtr(fullname), aFullname);</span>
<span class="lineNum">     111 </span>            :     }
<span class="lineNum">     112 </span>            : 
<span class="lineNum">     113 </span>            :     // if have fullname, done
<span class="lineNum">     114 </span><span class="lineCov">          1 :     if (!aFullname.IsEmpty()) {</span>
<span class="lineNum">     115 </span><span class="lineCov">          1 :         return;</span>
<span class="lineNum">     116 </span>            :     }
<span class="lineNum">     117 </span>            : 
<span class="lineNum">     118 </span>            :     // otherwise, set the fullname to family + style name [en] and use that
<span class="lineNum">     119 </span><span class="lineCov">          1 :     aFullname.Append(aFamilyName);</span>
<span class="lineNum">     120 </span>            : 
<span class="lineNum">     121 </span>            :     // figure out the en style name
<span class="lineNum">     122 </span><span class="lineCov">          1 :     en = FindCanonicalNameIndex(aFont, FC_STYLELANG);</span>
<span class="lineNum">     123 </span><span class="lineCov">          1 :     nsAutoString style;</span>
<span class="lineNum">     124 </span><span class="lineCov">          1 :     FcChar8* stylename = nullptr;</span>
<span class="lineNum">     125 </span><span class="lineCov">          1 :     FcPatternGetString(aFont, FC_STYLE, en, &amp;stylename);</span>
<span class="lineNum">     126 </span><span class="lineCov">          1 :     if (stylename) {</span>
<span class="lineNum">     127 </span><span class="lineCov">          1 :         AppendUTF8toUTF16(ToCharPtr(stylename), style);</span>
<span class="lineNum">     128 </span>            :     }
<span class="lineNum">     129 </span>            : 
<span class="lineNum">     130 </span><span class="lineCov">          1 :     if (!style.IsEmpty() &amp;&amp; !style.EqualsLiteral(&quot;Regular&quot;)) {</span>
<span class="lineNum">     131 </span><span class="lineCov">          1 :         aFullname.Append(' ');</span>
<span class="lineNum">     132 </span><span class="lineCov">          1 :         aFullname.Append(style);</span>
<span class="lineNum">     133 </span>            :     }
<span class="lineNum">     134 </span>            : }
<a name="135"><span class="lineNum">     135 </span>            : </a>
<span class="lineNum">     136 </span>            : static uint16_t
<span class="lineNum">     137 </span><span class="lineCov">          1 : MapFcWeight(int aFcWeight)</span>
<span class="lineNum">     138 </span>            : {
<span class="lineNum">     139 </span><span class="lineCov">          1 :   if (aFcWeight &lt;= (FC_WEIGHT_THIN + FC_WEIGHT_EXTRALIGHT) / 2) {</span>
<span class="lineNum">     140 </span>            :     return 100;
<span class="lineNum">     141 </span>            :   }
<span class="lineNum">     142 </span><span class="lineCov">          1 :   if (aFcWeight &lt;= (FC_WEIGHT_EXTRALIGHT + FC_WEIGHT_LIGHT) / 2) {</span>
<span class="lineNum">     143 </span>            :     return 200;
<span class="lineNum">     144 </span>            :   }
<span class="lineNum">     145 </span><span class="lineCov">          1 :   if (aFcWeight &lt;= (FC_WEIGHT_LIGHT + FC_WEIGHT_BOOK) / 2) {</span>
<span class="lineNum">     146 </span>            :     return 300;
<span class="lineNum">     147 </span>            :   }
<span class="lineNum">     148 </span><span class="lineCov">          1 :   if (aFcWeight &lt;= (FC_WEIGHT_REGULAR + FC_WEIGHT_MEDIUM) / 2) {</span>
<span class="lineNum">     149 </span>            :     // This includes FC_WEIGHT_BOOK
<span class="lineNum">     150 </span>            :     return 400;
<span class="lineNum">     151 </span>            :   }
<span class="lineNum">     152 </span><span class="lineCov">          1 :   if (aFcWeight &lt;= (FC_WEIGHT_MEDIUM + FC_WEIGHT_DEMIBOLD) / 2) {</span>
<span class="lineNum">     153 </span>            :     return 500;
<span class="lineNum">     154 </span>            :   }
<span class="lineNum">     155 </span><span class="lineCov">          1 :   if (aFcWeight &lt;= (FC_WEIGHT_DEMIBOLD + FC_WEIGHT_BOLD) / 2) {</span>
<span class="lineNum">     156 </span>            :     return 600;
<span class="lineNum">     157 </span>            :   }
<span class="lineNum">     158 </span><span class="lineCov">          1 :   if (aFcWeight &lt;= (FC_WEIGHT_BOLD + FC_WEIGHT_EXTRABOLD) / 2) {</span>
<span class="lineNum">     159 </span>            :     return 700;
<span class="lineNum">     160 </span>            :   }
<span class="lineNum">     161 </span><span class="lineCov">          1 :   if (aFcWeight &lt;= (FC_WEIGHT_EXTRABOLD + FC_WEIGHT_BLACK) / 2) {</span>
<span class="lineNum">     162 </span>            :     return 800;
<span class="lineNum">     163 </span>            :   }
<span class="lineNum">     164 </span><span class="lineCov">          1 :   if (aFcWeight &lt;= FC_WEIGHT_BLACK) {</span>
<span class="lineNum">     165 </span>            :     return 900;
<span class="lineNum">     166 </span>            :   }
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span>            :   // including FC_WEIGHT_EXTRABLACK
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :   return 901;</span>
<span class="lineNum">     170 </span>            : }
<a name="171"><span class="lineNum">     171 </span>            : </a>
<span class="lineNum">     172 </span>            : static int16_t
<span class="lineNum">     173 </span><span class="lineCov">          1 : MapFcWidth(int aFcWidth)</span>
<span class="lineNum">     174 </span>            : {
<span class="lineNum">     175 </span><span class="lineCov">          1 :     if (aFcWidth &lt;= (FC_WIDTH_ULTRACONDENSED + FC_WIDTH_EXTRACONDENSED) / 2) {</span>
<span class="lineNum">     176 </span>            :         return NS_FONT_STRETCH_ULTRA_CONDENSED;
<span class="lineNum">     177 </span>            :     }
<span class="lineNum">     178 </span><span class="lineCov">          1 :     if (aFcWidth &lt;= (FC_WIDTH_EXTRACONDENSED + FC_WIDTH_CONDENSED) / 2) {</span>
<span class="lineNum">     179 </span>            :         return NS_FONT_STRETCH_EXTRA_CONDENSED;
<span class="lineNum">     180 </span>            :     }
<span class="lineNum">     181 </span><span class="lineCov">          1 :     if (aFcWidth &lt;= (FC_WIDTH_CONDENSED + FC_WIDTH_SEMICONDENSED) / 2) {</span>
<span class="lineNum">     182 </span>            :         return NS_FONT_STRETCH_CONDENSED;
<span class="lineNum">     183 </span>            :     }
<span class="lineNum">     184 </span><span class="lineCov">          1 :     if (aFcWidth &lt;= (FC_WIDTH_SEMICONDENSED + FC_WIDTH_NORMAL) / 2) {</span>
<span class="lineNum">     185 </span>            :         return NS_FONT_STRETCH_SEMI_CONDENSED;
<span class="lineNum">     186 </span>            :     }
<span class="lineNum">     187 </span><span class="lineCov">          1 :     if (aFcWidth &lt;= (FC_WIDTH_NORMAL + FC_WIDTH_SEMIEXPANDED) / 2) {</span>
<span class="lineNum">     188 </span>            :         return NS_FONT_STRETCH_NORMAL;
<span class="lineNum">     189 </span>            :     }
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :     if (aFcWidth &lt;= (FC_WIDTH_SEMIEXPANDED + FC_WIDTH_EXPANDED) / 2) {</span>
<span class="lineNum">     191 </span>            :         return NS_FONT_STRETCH_SEMI_EXPANDED;
<span class="lineNum">     192 </span>            :     }
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :     if (aFcWidth &lt;= (FC_WIDTH_EXPANDED + FC_WIDTH_EXTRAEXPANDED) / 2) {</span>
<span class="lineNum">     194 </span>            :         return NS_FONT_STRETCH_EXPANDED;
<span class="lineNum">     195 </span>            :     }
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :     if (aFcWidth &lt;= (FC_WIDTH_EXTRAEXPANDED + FC_WIDTH_ULTRAEXPANDED) / 2) {</span>
<span class="lineNum">     197 </span>            :         return NS_FONT_STRETCH_EXTRA_EXPANDED;
<span class="lineNum">     198 </span>            :     }
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     return NS_FONT_STRETCH_ULTRA_EXPANDED;</span>
<a name="200"><span class="lineNum">     200 </span>            : }</a>
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::gfxFontconfigFontEntry(const nsAString&amp; aFaceName,</span>
<span class="lineNum">     203 </span>            :                                                FcPattern* aFontPattern,
<span class="lineNum">     204 </span>            :                                                bool aIgnoreFcCharmap)
<span class="lineNum">     205 </span>            :         : gfxFontEntry(aFaceName), mFontPattern(aFontPattern),
<span class="lineNum">     206 </span>            :           mFTFace(nullptr), mFTFaceInitialized(false),
<span class="lineNum">     207 </span>            :           mIgnoreFcCharmap(aIgnoreFcCharmap),
<span class="lineNum">     208 </span><span class="lineCov">          1 :           mAspect(0.0), mFontData(nullptr)</span>
<span class="lineNum">     209 </span>            : {
<span class="lineNum">     210 </span>            :     // italic
<span class="lineNum">     211 </span>            :     int slant;
<span class="lineNum">     212 </span><span class="lineCov">          1 :     if (FcPatternGetInteger(aFontPattern, FC_SLANT, 0, &amp;slant) != FcResultMatch) {</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :         slant = FC_SLANT_ROMAN;</span>
<span class="lineNum">     214 </span>            :     }
<span class="lineNum">     215 </span><span class="lineCov">          1 :     if (slant == FC_SLANT_OBLIQUE) {</span>
<span class="lineNum">     216 </span><span class="lineCov">          1 :         mStyle = NS_FONT_STYLE_OBLIQUE;</span>
<span class="lineNum">     217 </span><span class="lineCov">          1 :     } else if (slant &gt; 0) {</span>
<span class="lineNum">     218 </span><span class="lineCov">          1 :         mStyle = NS_FONT_STYLE_ITALIC;</span>
<span class="lineNum">     219 </span>            :     }
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span>            :     // weight
<span class="lineNum">     222 </span>            :     int weight;
<span class="lineNum">     223 </span><span class="lineCov">          1 :     if (FcPatternGetInteger(aFontPattern, FC_WEIGHT, 0, &amp;weight) != FcResultMatch) {</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :         weight = FC_WEIGHT_REGULAR;</span>
<span class="lineNum">     225 </span>            :     }
<span class="lineNum">     226 </span><span class="lineCov">          1 :     mWeight = MapFcWeight(weight);</span>
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span>            :     // width
<span class="lineNum">     229 </span>            :     int width;
<span class="lineNum">     230 </span><span class="lineCov">          1 :     if (FcPatternGetInteger(aFontPattern, FC_WIDTH, 0, &amp;width) != FcResultMatch) {</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :         width = FC_WIDTH_NORMAL;</span>
<span class="lineNum">     232 </span>            :     }
<span class="lineNum">     233 </span><span class="lineCov">          1 :     mStretch = MapFcWidth(width);</span>
<a name="234"><span class="lineNum">     234 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::gfxFontconfigFontEntry(const nsAString&amp; aFaceName,</span>
<span class="lineNum">     237 </span>            :                                                uint16_t aWeight,
<span class="lineNum">     238 </span>            :                                                int16_t aStretch,
<span class="lineNum">     239 </span>            :                                                uint8_t aStyle,
<span class="lineNum">     240 </span>            :                                                const uint8_t *aData,
<span class="lineNum">     241 </span>            :                                                FT_Face aFace)
<span class="lineNum">     242 </span>            :     : gfxFontEntry(aFaceName),
<span class="lineNum">     243 </span>            :       mFTFace(aFace), mFTFaceInitialized(true),
<span class="lineNum">     244 </span>            :       mIgnoreFcCharmap(true),
<span class="lineNum">     245 </span><span class="lineCov">          1 :       mAspect(0.0), mFontData(aData)</span>
<span class="lineNum">     246 </span>            : {
<span class="lineNum">     247 </span><span class="lineCov">          1 :     mWeight = aWeight;</span>
<span class="lineNum">     248 </span><span class="lineCov">          1 :     mStyle = aStyle;</span>
<span class="lineNum">     249 </span><span class="lineCov">          1 :     mStretch = aStretch;</span>
<span class="lineNum">     250 </span><span class="lineCov">          1 :     mIsDataUserFont = true;</span>
<span class="lineNum">     251 </span>            : 
<span class="lineNum">     252 </span>            :     // Use fontconfig to fill out the pattern from the FTFace.
<span class="lineNum">     253 </span>            :     // The &quot;file&quot; argument cannot be nullptr (in fontconfig-2.6.0 at
<span class="lineNum">     254 </span>            :     // least). The dummy file passed here is removed below.
<span class="lineNum">     255 </span>            :     //
<span class="lineNum">     256 </span>            :     // When fontconfig scans the system fonts, FcConfigGetBlanks(nullptr)
<span class="lineNum">     257 </span>            :     // is passed as the &quot;blanks&quot; argument, which provides that unexpectedly
<span class="lineNum">     258 </span>            :     // blank glyphs are elided.  Here, however, we pass nullptr for
<span class="lineNum">     259 </span>            :     // &quot;blanks&quot;, effectively assuming that, if the font has a blank glyph,
<span class="lineNum">     260 </span>            :     // then the author intends any associated character to be rendered
<span class="lineNum">     261 </span>            :     // blank.
<span class="lineNum">     262 </span><span class="lineCov">          1 :     mFontPattern = FcFreeTypeQueryFace(mFTFace, ToFcChar8Ptr(&quot;&quot;), 0, nullptr);</span>
<span class="lineNum">     263 </span>            :     // given that we have a FT_Face, not really sure this is possible...
<span class="lineNum">     264 </span><span class="lineCov">          1 :     if (!mFontPattern) {</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :         mFontPattern = FcPatternCreate();</span>
<span class="lineNum">     266 </span>            :     }
<span class="lineNum">     267 </span><span class="lineCov">          1 :     FcPatternDel(mFontPattern, FC_FILE);</span>
<span class="lineNum">     268 </span><span class="lineCov">          1 :     FcPatternDel(mFontPattern, FC_INDEX);</span>
<span class="lineNum">     269 </span>            : 
<span class="lineNum">     270 </span>            :     // Make a new pattern and store the face in it so that cairo uses
<span class="lineNum">     271 </span>            :     // that when creating a cairo font face.
<span class="lineNum">     272 </span><span class="lineCov">          1 :     FcPatternAddFTFace(mFontPattern, FC_FT_FACE, mFTFace);</span>
<span class="lineNum">     273 </span>            : 
<span class="lineNum">     274 </span><span class="lineCov">          1 :     mUserFontData = new FTUserFontData(mFTFace, mFontData);</span>
<a name="275"><span class="lineNum">     275 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     276 </span>            : 
<span class="lineNum">     277 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::gfxFontconfigFontEntry(const nsAString&amp; aFaceName,</span>
<span class="lineNum">     278 </span>            :                                                FcPattern* aFontPattern,
<span class="lineNum">     279 </span>            :                                                uint16_t aWeight,
<span class="lineNum">     280 </span>            :                                                int16_t aStretch,
<span class="lineNum">     281 </span>            :                                                uint8_t aStyle)
<span class="lineNum">     282 </span>            :         : gfxFontEntry(aFaceName), mFontPattern(aFontPattern),
<span class="lineNum">     283 </span>            :           mFTFace(nullptr), mFTFaceInitialized(false),
<span class="lineNum">     284 </span><span class="lineCov">          1 :           mAspect(0.0), mFontData(nullptr)</span>
<span class="lineNum">     285 </span>            : {
<span class="lineNum">     286 </span><span class="lineCov">          1 :     mWeight = aWeight;</span>
<span class="lineNum">     287 </span><span class="lineCov">          1 :     mStyle = aStyle;</span>
<span class="lineNum">     288 </span><span class="lineCov">          1 :     mStretch = aStretch;</span>
<span class="lineNum">     289 </span><span class="lineCov">          1 :     mIsLocalUserFont = true;</span>
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span>            :     // The proper setting of mIgnoreFcCharmap is tricky for fonts loaded
<span class="lineNum">     292 </span>            :     // via src:local()...
<span class="lineNum">     293 </span>            :     // If the local font happens to come from the application fontset,
<span class="lineNum">     294 </span>            :     // we want to set it to true so that color/svg fonts will work even
<span class="lineNum">     295 </span>            :     // if the default glyphs are blank; but if the local font is a non-
<span class="lineNum">     296 </span>            :     // sfnt face (e.g. legacy type 1) then we need to set it to false
<span class="lineNum">     297 </span>            :     // because our cmap-reading code will fail and we depend on FT+Fc to
<span class="lineNum">     298 </span>            :     // determine the coverage.
<span class="lineNum">     299 </span>            :     // We set the flag here, but may flip it the first time TestCharacterMap
<span class="lineNum">     300 </span>            :     // is called, at which point we'll look to see whether a 'cmap' is
<span class="lineNum">     301 </span>            :     // actually present in the font.
<span class="lineNum">     302 </span><span class="lineCov">          1 :     mIgnoreFcCharmap = true;</span>
<a name="303"><span class="lineNum">     303 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     304 </span>            : 
<span class="lineNum">     305 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::~gfxFontconfigFontEntry()</span>
<span class="lineNum">     306 </span>            : {
<span class="lineNum">     307 </span><span class="lineCov">          1 : }</span>
<a name="308"><span class="lineNum">     308 </span>            : </a>
<span class="lineNum">     309 </span>            : static bool
<span class="lineNum">     310 </span><span class="lineCov">          1 : PatternHasLang(const FcPattern *aPattern, const FcChar8 *aLang)</span>
<span class="lineNum">     311 </span>            : {
<span class="lineNum">     312 </span>            :     FcLangSet *langset;
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span><span class="lineCov">          1 :     if (FcPatternGetLangSet(aPattern, FC_LANG, 0, &amp;langset) != FcResultMatch) {</span>
<span class="lineNum">     315 </span>            :         return false;
<span class="lineNum">     316 </span>            :     }
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span><span class="lineCov">          1 :     if (FcLangSetHasLang(langset, aLang) != FcLangDifferentLang) {</span>
<span class="lineNum">     319 </span>            :         return true;
<span class="lineNum">     320 </span>            :     }
<span class="lineNum">     321 </span><span class="lineCov">          1 :     return false;</span>
<span class="lineNum">     322 </span>            : }
<a name="323"><span class="lineNum">     323 </span>            : </a>
<span class="lineNum">     324 </span>            : bool
<span class="lineNum">     325 </span><span class="lineNoCov">          0 : gfxFontconfigFontEntry::SupportsLangGroup(nsIAtom *aLangGroup) const</span>
<span class="lineNum">     326 </span>            : {
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :     if (!aLangGroup || aLangGroup == nsGkAtoms::Unicode) {</span>
<span class="lineNum">     328 </span>            :         return true;
<span class="lineNum">     329 </span>            :     }
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :     nsAutoCString fcLang;</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :     gfxFcPlatformFontList* pfl = gfxFcPlatformFontList::PlatformFontList();</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :     pfl-&gt;GetSampleLangForGroup(aLangGroup, fcLang);</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :     if (fcLang.IsEmpty()) {</span>
<span class="lineNum">     335 </span>            :         return true;
<span class="lineNum">     336 </span>            :     }
<span class="lineNum">     337 </span>            : 
<span class="lineNum">     338 </span>            :     // is lang included in the underlying pattern?
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :     return PatternHasLang(mFontPattern, ToFcChar8Ptr(fcLang.get()));</span>
<span class="lineNum">     340 </span>            : }
<a name="341"><span class="lineNum">     341 </span>            : </a>
<span class="lineNum">     342 </span>            : nsresult
<span class="lineNum">     343 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::ReadCMAP(FontInfoData *aFontInfoData)</span>
<span class="lineNum">     344 </span>            : {
<span class="lineNum">     345 </span>            :     // attempt this once, if errors occur leave a blank cmap
<span class="lineNum">     346 </span><span class="lineCov">          1 :     if (mCharacterMap) {</span>
<span class="lineNum">     347 </span>            :         return NS_OK;
<span class="lineNum">     348 </span>            :     }
<span class="lineNum">     349 </span>            : 
<span class="lineNum">     350 </span>            :     RefPtr&lt;gfxCharacterMap&gt; charmap;
<span class="lineNum">     351 </span>            :     nsresult rv;
<span class="lineNum">     352 </span><span class="lineCov">          1 :     bool symbolFont = false; // currently ignored</span>
<span class="lineNum">     353 </span>            : 
<span class="lineNum">     354 </span><span class="lineCov">          1 :     if (aFontInfoData &amp;&amp; (charmap = GetCMAPFromFontInfo(aFontInfoData,</span>
<span class="lineNum">     355 </span>            :                                                         mUVSOffset,
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :                                                         symbolFont))) {</span>
<span class="lineNum">     357 </span>            :         rv = NS_OK;
<span class="lineNum">     358 </span>            :     } else {
<span class="lineNum">     359 </span><span class="lineCov">          1 :         uint32_t kCMAP = TRUETYPE_TAG('c','m','a','p');</span>
<span class="lineNum">     360 </span><span class="lineCov">          1 :         charmap = new gfxCharacterMap();</span>
<span class="lineNum">     361 </span><span class="lineCov">          1 :         AutoTable cmapTable(this, kCMAP);</span>
<span class="lineNum">     362 </span>            : 
<span class="lineNum">     363 </span><span class="lineCov">          1 :         if (cmapTable) {</span>
<span class="lineNum">     364 </span><span class="lineCov">          1 :             bool unicodeFont = false; // currently ignored</span>
<span class="lineNum">     365 </span>            :             uint32_t cmapLen;
<span class="lineNum">     366 </span>            :             const uint8_t* cmapData =
<span class="lineNum">     367 </span>            :                 reinterpret_cast&lt;const uint8_t*&gt;(hb_blob_get_data(cmapTable,
<span class="lineNum">     368 </span><span class="lineCov">          1 :                                                                   &amp;cmapLen));</span>
<span class="lineNum">     369 </span>            :             rv = gfxFontUtils::ReadCMAP(cmapData, cmapLen,
<span class="lineNum">     370 </span>            :                                         *charmap, mUVSOffset,
<span class="lineNum">     371 </span><span class="lineCov">          1 :                                         unicodeFont, symbolFont);</span>
<span class="lineNum">     372 </span>            :         } else {
<span class="lineNum">     373 </span>            :             rv = NS_ERROR_NOT_AVAILABLE;
<span class="lineNum">     374 </span><span class="lineCov">          1 :         }</span>
<span class="lineNum">     375 </span>            :     }
<span class="lineNum">     376 </span>            : 
<span class="lineNum">     377 </span><span class="lineCov">          1 :     mHasCmapTable = NS_SUCCEEDED(rv);</span>
<span class="lineNum">     378 </span><span class="lineCov">          1 :     if (mHasCmapTable) {</span>
<span class="lineNum">     379 </span><span class="lineCov">          1 :         gfxPlatformFontList *pfl = gfxPlatformFontList::PlatformFontList();</span>
<span class="lineNum">     380 </span><span class="lineCov">          1 :         mCharacterMap = pfl-&gt;FindCharMap(charmap);</span>
<span class="lineNum">     381 </span>            :     } else {
<span class="lineNum">     382 </span>            :         // if error occurred, initialize to null cmap
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :         mCharacterMap = new gfxCharacterMap();</span>
<span class="lineNum">     384 </span>            :     }
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span><span class="lineCov">          1 :     LOG_FONTLIST((&quot;(fontlist-cmap) name: %s, size: %&quot; PRIuSIZE &quot; hash: %8.8x%s\n&quot;,</span>
<span class="lineNum">     387 </span>            :                   NS_ConvertUTF16toUTF8(mName).get(),
<span class="lineNum">     388 </span>            :                   charmap-&gt;SizeOfIncludingThis(moz_malloc_size_of),
<span class="lineNum">     389 </span>            :                   charmap-&gt;mHash, mCharacterMap == charmap ? &quot; new&quot; : &quot;&quot;));
<span class="lineNum">     390 </span><span class="lineCov">          1 :     if (LOG_CMAPDATA_ENABLED()) {</span>
<span class="lineNum">     391 </span>            :         char prefix[256];
<span class="lineNum">     392 </span>            :         SprintfLiteral(prefix, &quot;(cmapdata) name: %.220s&quot;,
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :                        NS_ConvertUTF16toUTF8(mName).get());</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :         charmap-&gt;Dump(prefix, eGfxLog_cmapdata);</span>
<span class="lineNum">     395 </span>            :     }
<span class="lineNum">     396 </span>            : 
<span class="lineNum">     397 </span><span class="lineCov">          1 :     return rv;</span>
<span class="lineNum">     398 </span>            : }
<a name="399"><span class="lineNum">     399 </span>            : </a>
<span class="lineNum">     400 </span>            : static bool
<span class="lineNum">     401 </span><span class="lineCov">          1 : HasChar(FcPattern *aFont, FcChar32 aCh)</span>
<span class="lineNum">     402 </span>            : {
<span class="lineNum">     403 </span><span class="lineCov">          1 :     FcCharSet *charset = nullptr;</span>
<span class="lineNum">     404 </span><span class="lineCov">          1 :     FcPatternGetCharSet(aFont, FC_CHARSET, 0, &amp;charset);</span>
<span class="lineNum">     405 </span><span class="lineCov">          1 :     return charset &amp;&amp; FcCharSetHasChar(charset, aCh);</span>
<span class="lineNum">     406 </span>            : }
<a name="407"><span class="lineNum">     407 </span>            : </a>
<span class="lineNum">     408 </span>            : bool
<span class="lineNum">     409 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::TestCharacterMap(uint32_t aCh)</span>
<span class="lineNum">     410 </span>            : {
<span class="lineNum">     411 </span>            :     // For user fonts, or for fonts bundled with the app (which might include
<span class="lineNum">     412 </span>            :     // color/svg glyphs where the default glyphs may be blank, and thus confuse
<span class="lineNum">     413 </span>            :     // fontconfig/freetype's char map checking), we instead check the cmap
<span class="lineNum">     414 </span>            :     // directly for character coverage.
<span class="lineNum">     415 </span><span class="lineCov">          1 :     if (mIgnoreFcCharmap) {</span>
<span class="lineNum">     416 </span>            :         // If it does not actually have a cmap, switch our strategy to use
<span class="lineNum">     417 </span>            :         // fontconfig's charmap after all (except for data fonts, which must
<span class="lineNum">     418 </span>            :         // always have a cmap to have passed OTS validation).
<span class="lineNum">     419 </span><span class="lineCov">          1 :         if (!mIsDataUserFont &amp;&amp; !HasFontTable(TRUETYPE_TAG('c','m','a','p'))) {</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :             mIgnoreFcCharmap = false;</span>
<span class="lineNum">     421 </span>            :             // ...and continue with HasChar() below.
<span class="lineNum">     422 </span>            :         } else {
<span class="lineNum">     423 </span><span class="lineCov">          1 :             return gfxFontEntry::TestCharacterMap(aCh);</span>
<span class="lineNum">     424 </span>            :         }
<span class="lineNum">     425 </span>            :     }
<span class="lineNum">     426 </span>            :     // otherwise (for system fonts), use the charmap in the pattern
<span class="lineNum">     427 </span><span class="lineCov">          1 :     return HasChar(mFontPattern, aCh);</span>
<span class="lineNum">     428 </span>            : }
<a name="429"><span class="lineNum">     429 </span>            : </a>
<span class="lineNum">     430 </span>            : hb_blob_t*
<span class="lineNum">     431 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::GetFontTable(uint32_t aTableTag)</span>
<span class="lineNum">     432 </span>            : {
<span class="lineNum">     433 </span>            :     // for data fonts, read directly from the font data
<span class="lineNum">     434 </span><span class="lineCov">          1 :     if (mFontData) {</span>
<span class="lineNum">     435 </span><span class="lineCov">          1 :         return gfxFontUtils::GetTableFromFontData(mFontData, aTableTag);</span>
<span class="lineNum">     436 </span>            :     }
<span class="lineNum">     437 </span>            : 
<span class="lineNum">     438 </span><span class="lineCov">          1 :     return gfxFontEntry::GetFontTable(aTableTag);</span>
<span class="lineNum">     439 </span>            : }
<a name="440"><span class="lineNum">     440 </span>            : </a>
<span class="lineNum">     441 </span>            : void
<span class="lineNum">     442 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::MaybeReleaseFTFace()</span>
<span class="lineNum">     443 </span>            : {
<span class="lineNum">     444 </span>            :     // don't release if either HB or Gr face still exists
<span class="lineNum">     445 </span><span class="lineCov">          1 :     if (mHBFace || mGrFace) {</span>
<span class="lineNum">     446 </span><span class="lineCov">          1 :         return;</span>
<span class="lineNum">     447 </span>            :     }
<span class="lineNum">     448 </span>            :     // only close out FT_Face for system fonts, not for data fonts
<span class="lineNum">     449 </span><span class="lineCov">          1 :     if (!mIsDataUserFont) {</span>
<span class="lineNum">     450 </span><span class="lineCov">          1 :         if (mFTFace) {</span>
<span class="lineNum">     451 </span><span class="lineCov">          1 :             FT_Done_Face(mFTFace);</span>
<span class="lineNum">     452 </span><span class="lineCov">          1 :             mFTFace = nullptr;</span>
<span class="lineNum">     453 </span>            :         }
<span class="lineNum">     454 </span><span class="lineCov">          1 :         mFTFaceInitialized = false;</span>
<span class="lineNum">     455 </span>            :     }
<span class="lineNum">     456 </span>            : }
<a name="457"><span class="lineNum">     457 </span>            : </a>
<span class="lineNum">     458 </span>            : void
<span class="lineNum">     459 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::ForgetHBFace()</span>
<span class="lineNum">     460 </span>            : {
<span class="lineNum">     461 </span><span class="lineCov">          1 :     gfxFontEntry::ForgetHBFace();</span>
<span class="lineNum">     462 </span><span class="lineCov">          1 :     MaybeReleaseFTFace();</span>
<span class="lineNum">     463 </span><span class="lineCov">          1 : }</span>
<a name="464"><span class="lineNum">     464 </span>            : </a>
<span class="lineNum">     465 </span>            : void
<span class="lineNum">     466 </span><span class="lineNoCov">          0 : gfxFontconfigFontEntry::ReleaseGrFace(gr_face* aFace)</span>
<span class="lineNum">     467 </span>            : {
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :     gfxFontEntry::ReleaseGrFace(aFace);</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :     MaybeReleaseFTFace();</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 : }</span>
<a name="471"><span class="lineNum">     471 </span>            : </a>
<span class="lineNum">     472 </span>            : double
<span class="lineNum">     473 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::GetAspect()</span>
<span class="lineNum">     474 </span>            : {
<span class="lineNum">     475 </span><span class="lineCov">          1 :     if (mAspect == 0.0) {</span>
<span class="lineNum">     476 </span>            :         // default to aspect = 0.5
<span class="lineNum">     477 </span><span class="lineCov">          1 :         mAspect = 0.5;</span>
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span>            :         // create a font to calculate x-height / em-height
<span class="lineNum">     480 </span><span class="lineCov">          1 :         gfxFontStyle s;</span>
<span class="lineNum">     481 </span><span class="lineCov">          1 :         s.size = 100.0; // pick large size to avoid possible hinting artifacts</span>
<span class="lineNum">     482 </span><span class="lineCov">          1 :         RefPtr&lt;gfxFont&gt; font = FindOrMakeFont(&amp;s, false);</span>
<span class="lineNum">     483 </span><span class="lineCov">          1 :         if (font) {</span>
<span class="lineNum">     484 </span>            :             const gfxFont::Metrics&amp; metrics =
<span class="lineNum">     485 </span><span class="lineCov">          1 :                 font-&gt;GetMetrics(gfxFont::eHorizontal);</span>
<span class="lineNum">     486 </span>            : 
<span class="lineNum">     487 </span>            :             // The factor of 0.1 ensures that xHeight is sane so fonts don't
<span class="lineNum">     488 </span>            :             // become huge.  Strictly &quot;&gt;&quot; ensures that xHeight and emHeight are
<span class="lineNum">     489 </span>            :             // not both zero.
<span class="lineNum">     490 </span><span class="lineCov">          1 :             if (metrics.xHeight &gt; 0.1 * metrics.emHeight) {</span>
<span class="lineNum">     491 </span><span class="lineCov">          1 :                 mAspect = metrics.xHeight / metrics.emHeight;</span>
<span class="lineNum">     492 </span>            :             }
<span class="lineNum">     493 </span><span class="lineCov">          1 :         }</span>
<span class="lineNum">     494 </span>            :     }
<span class="lineNum">     495 </span><span class="lineCov">          1 :     return mAspect;</span>
<span class="lineNum">     496 </span>            : }
<a name="497"><span class="lineNum">     497 </span>            : </a>
<span class="lineNum">     498 </span>            : static void
<span class="lineNum">     499 </span><span class="lineCov">          1 : PrepareFontOptions(FcPattern* aPattern,</span>
<span class="lineNum">     500 </span>            :                    cairo_font_options_t* aFontOptions)
<span class="lineNum">     501 </span>            : {
<span class="lineNum">     502 </span>            :     NS_ASSERTION(aFontOptions, &quot;null font options passed to PrepareFontOptions&quot;);
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span>            :     // xxx - taken from the gfxFontconfigFonts code, needs to be reviewed
<span class="lineNum">     505 </span>            : 
<span class="lineNum">     506 </span>            :     FcBool printing;
<span class="lineNum">     507 </span><span class="lineCov">          1 :     if (FcPatternGetBool(aPattern, PRINTING_FC_PROPERTY, 0, &amp;printing) !=</span>
<span class="lineNum">     508 </span>            :             FcResultMatch) {
<span class="lineNum">     509 </span><span class="lineCov">          1 :         printing = FcFalse;</span>
<span class="lineNum">     510 </span>            :     }
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span>            :     // Font options are set explicitly here to improve cairo's caching
<span class="lineNum">     513 </span>            :     // behavior and to record the relevant parts of the pattern for
<span class="lineNum">     514 </span>            :     // SetupCairoFont (so that the pattern can be released).
<span class="lineNum">     515 </span>            :     //
<span class="lineNum">     516 </span>            :     // Most font_options have already been set as defaults on the FcPattern
<span class="lineNum">     517 </span>            :     // with cairo_ft_font_options_substitute(), then user and system
<span class="lineNum">     518 </span>            :     // fontconfig configurations were applied.  The resulting font_options
<span class="lineNum">     519 </span>            :     // have been recorded on the face during
<span class="lineNum">     520 </span>            :     // cairo_ft_font_face_create_for_pattern().
<span class="lineNum">     521 </span>            :     //
<span class="lineNum">     522 </span>            :     // None of the settings here cause this scaled_font to behave any
<span class="lineNum">     523 </span>            :     // differently from how it would behave if it were created from the same
<span class="lineNum">     524 </span>            :     // face with default font_options.
<span class="lineNum">     525 </span>            :     //
<span class="lineNum">     526 </span>            :     // We set options explicitly so that the same scaled_font will be found in
<span class="lineNum">     527 </span>            :     // the cairo_scaled_font_map when cairo loads glyphs from a context with
<span class="lineNum">     528 </span>            :     // the same font_face, font_matrix, ctm, and surface font_options.
<span class="lineNum">     529 </span>            :     //
<span class="lineNum">     530 </span>            :     // Unfortunately, _cairo_scaled_font_keys_equal doesn't know about the
<span class="lineNum">     531 </span>            :     // font_options on the cairo_ft_font_face, and doesn't consider default
<span class="lineNum">     532 </span>            :     // option values to not match any explicit values.
<span class="lineNum">     533 </span>            :     //
<span class="lineNum">     534 </span>            :     // Even after cairo_set_scaled_font is used to set font_options for the
<span class="lineNum">     535 </span>            :     // cairo context, when cairo looks for a scaled_font for the context, it
<span class="lineNum">     536 </span>            :     // will look for a font with some option values from the target surface if
<span class="lineNum">     537 </span>            :     // any values are left default on the context font_options.  If this
<span class="lineNum">     538 </span>            :     // scaled_font is created with default font_options, cairo will not find
<span class="lineNum">     539 </span>            :     // it.
<span class="lineNum">     540 </span>            :     //
<span class="lineNum">     541 </span>            :     // The one option not recorded in the pattern is hint_metrics, which will
<span class="lineNum">     542 </span>            :     // affect glyph metrics.  The default behaves as CAIRO_HINT_METRICS_ON.
<span class="lineNum">     543 </span>            :     // We should be considering the font_options of the surface on which this
<span class="lineNum">     544 </span>            :     // font will be used, but currently we don't have different gfxFonts for
<span class="lineNum">     545 </span>            :     // different surface font_options, so we'll create a font suitable for the
<span class="lineNum">     546 </span>            :     // Screen. Image and xlib surfaces default to CAIRO_HINT_METRICS_ON.
<span class="lineNum">     547 </span><span class="lineCov">          1 :     if (printing) {</span>
<span class="lineNum">     548 </span><span class="lineCov">          1 :         cairo_font_options_set_hint_metrics(aFontOptions, CAIRO_HINT_METRICS_OFF);</span>
<span class="lineNum">     549 </span>            :     } else {
<span class="lineNum">     550 </span><span class="lineCov">          1 :         cairo_font_options_set_hint_metrics(aFontOptions, CAIRO_HINT_METRICS_ON);</span>
<span class="lineNum">     551 </span>            :     }
<span class="lineNum">     552 </span>            : 
<span class="lineNum">     553 </span>            :     // The remaining options have been recorded on the pattern and the face.
<span class="lineNum">     554 </span>            :     // _cairo_ft_options_merge has some logic to decide which options from the
<span class="lineNum">     555 </span>            :     // scaled_font or from the cairo_ft_font_face take priority in the way the
<span class="lineNum">     556 </span>            :     // font behaves.
<span class="lineNum">     557 </span>            :     //
<span class="lineNum">     558 </span>            :     // In the majority of cases, _cairo_ft_options_merge uses the options from
<span class="lineNum">     559 </span>            :     // the cairo_ft_font_face, so sometimes it is not so important which
<span class="lineNum">     560 </span>            :     // values are set here so long as they are not defaults, but we'll set
<span class="lineNum">     561 </span>            :     // them to the exact values that we expect from the font, to be consistent
<span class="lineNum">     562 </span>            :     // and to protect against changes in cairo.
<span class="lineNum">     563 </span>            :     //
<span class="lineNum">     564 </span>            :     // In some cases, _cairo_ft_options_merge uses some options from the
<span class="lineNum">     565 </span>            :     // scaled_font's font_options rather than options on the
<span class="lineNum">     566 </span>            :     // cairo_ft_font_face (from fontconfig).
<span class="lineNum">     567 </span>            :     // https://bugs.freedesktop.org/show_bug.cgi?id=11838
<span class="lineNum">     568 </span>            :     //
<span class="lineNum">     569 </span>            :     // Surface font options were set on the pattern in
<span class="lineNum">     570 </span>            :     // cairo_ft_font_options_substitute.  If fontconfig has changed the
<span class="lineNum">     571 </span>            :     // hint_style then that is what the user (or distribution) wants, so we
<span class="lineNum">     572 </span>            :     // use the setting from the FcPattern.
<span class="lineNum">     573 </span>            :     //
<span class="lineNum">     574 </span>            :     // Fallback values here mirror treatment of defaults in cairo-ft-font.c.
<span class="lineNum">     575 </span><span class="lineCov">          1 :     FcBool hinting = FcFalse;</span>
<span class="lineNum">     576 </span><span class="lineCov">          1 :     if (FcPatternGetBool(aPattern, FC_HINTING, 0, &amp;hinting) != FcResultMatch) {</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :         hinting = FcTrue;</span>
<span class="lineNum">     578 </span>            :     }
<span class="lineNum">     579 </span>            : 
<span class="lineNum">     580 </span>            :     cairo_hint_style_t hint_style;
<span class="lineNum">     581 </span><span class="lineCov">          1 :     if (printing || !hinting) {</span>
<span class="lineNum">     582 </span>            :         hint_style = CAIRO_HINT_STYLE_NONE;
<span class="lineNum">     583 </span>            :     } else {
<span class="lineNum">     584 </span>            :         int fc_hintstyle;
<span class="lineNum">     585 </span><span class="lineCov">          1 :         if (FcPatternGetInteger(aPattern, FC_HINT_STYLE,</span>
<span class="lineNum">     586 </span><span class="lineCov">          1 :                                 0, &amp;fc_hintstyle) != FcResultMatch) {</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :             fc_hintstyle = FC_HINT_FULL;</span>
<span class="lineNum">     588 </span>            :         }
<span class="lineNum">     589 </span><span class="lineCov">          1 :         switch (fc_hintstyle) {</span>
<span class="lineNum">     590 </span>            :             case FC_HINT_NONE:
<span class="lineNum">     591 </span>            :                 hint_style = CAIRO_HINT_STYLE_NONE;
<span class="lineNum">     592 </span>            :                 break;
<span class="lineNum">     593 </span>            :             case FC_HINT_SLIGHT:
<span class="lineNum">     594 </span>            :                 hint_style = CAIRO_HINT_STYLE_SLIGHT;
<span class="lineNum">     595 </span>            :                 break;
<span class="lineNum">     596 </span>            :             case FC_HINT_MEDIUM:
<span class="lineNum">     597 </span>            :             default: // This fallback mirrors _get_pattern_ft_options in cairo.
<span class="lineNum">     598 </span>            :                 hint_style = CAIRO_HINT_STYLE_MEDIUM;
<span class="lineNum">     599 </span>            :                 break;
<span class="lineNum">     600 </span>            :             case FC_HINT_FULL:
<span class="lineNum">     601 </span>            :                 hint_style = CAIRO_HINT_STYLE_FULL;
<span class="lineNum">     602 </span>            :                 break;
<span class="lineNum">     603 </span>            :         }
<span class="lineNum">     604 </span>            :     }
<span class="lineNum">     605 </span><span class="lineCov">          1 :     cairo_font_options_set_hint_style(aFontOptions, hint_style);</span>
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span>            :     int rgba;
<span class="lineNum">     608 </span><span class="lineCov">          1 :     if (FcPatternGetInteger(aPattern,</span>
<span class="lineNum">     609 </span><span class="lineCov">          1 :                             FC_RGBA, 0, &amp;rgba) != FcResultMatch) {</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :         rgba = FC_RGBA_UNKNOWN;</span>
<span class="lineNum">     611 </span>            :     }
<span class="lineNum">     612 </span><span class="lineCov">          1 :     cairo_subpixel_order_t subpixel_order = CAIRO_SUBPIXEL_ORDER_DEFAULT;</span>
<span class="lineNum">     613 </span><span class="lineCov">          1 :     switch (rgba) {</span>
<span class="lineNum">     614 </span>            :         case FC_RGBA_UNKNOWN:
<span class="lineNum">     615 </span>            :         case FC_RGBA_NONE:
<span class="lineNum">     616 </span>            :         default:
<span class="lineNum">     617 </span>            :             // There is no CAIRO_SUBPIXEL_ORDER_NONE.  Subpixel antialiasing
<span class="lineNum">     618 </span>            :             // is disabled through cairo_antialias_t.
<span class="lineNum">     619 </span><span class="lineCov">          1 :             rgba = FC_RGBA_NONE;</span>
<span class="lineNum">     620 </span>            :             // subpixel_order won't be used by the font as we won't use
<span class="lineNum">     621 </span>            :             // CAIRO_ANTIALIAS_SUBPIXEL, but don't leave it at default for
<span class="lineNum">     622 </span>            :             // caching reasons described above.  Fall through:
<span class="lineNum">     623 </span>            :             MOZ_FALLTHROUGH;
<span class="lineNum">     624 </span>            :         case FC_RGBA_RGB:
<span class="lineNum">     625 </span>            :             subpixel_order = CAIRO_SUBPIXEL_ORDER_RGB;
<span class="lineNum">     626 </span>            :             break;
<span class="lineNum">     627 </span>            :         case FC_RGBA_BGR:
<span class="lineNum">     628 </span>            :             subpixel_order = CAIRO_SUBPIXEL_ORDER_BGR;
<span class="lineNum">     629 </span>            :             break;
<span class="lineNum">     630 </span>            :         case FC_RGBA_VRGB:
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :             subpixel_order = CAIRO_SUBPIXEL_ORDER_VRGB;</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     633 </span>            :         case FC_RGBA_VBGR:
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :             subpixel_order = CAIRO_SUBPIXEL_ORDER_VBGR;</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     636 </span>            :     }
<span class="lineNum">     637 </span><span class="lineCov">          1 :     cairo_font_options_set_subpixel_order(aFontOptions, subpixel_order);</span>
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span>            :     FcBool fc_antialias;
<span class="lineNum">     640 </span><span class="lineCov">          1 :     if (FcPatternGetBool(aPattern,</span>
<span class="lineNum">     641 </span><span class="lineCov">          1 :                          FC_ANTIALIAS, 0, &amp;fc_antialias) != FcResultMatch) {</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :         fc_antialias = FcTrue;</span>
<span class="lineNum">     643 </span>            :     }
<span class="lineNum">     644 </span>            :     cairo_antialias_t antialias;
<span class="lineNum">     645 </span><span class="lineCov">          1 :     if (!fc_antialias) {</span>
<span class="lineNum">     646 </span>            :         antialias = CAIRO_ANTIALIAS_NONE;
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :     } else if (rgba == FC_RGBA_NONE) {</span>
<span class="lineNum">     648 </span>            :         antialias = CAIRO_ANTIALIAS_GRAY;
<span class="lineNum">     649 </span>            :     } else {
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :         antialias = CAIRO_ANTIALIAS_SUBPIXEL;</span>
<span class="lineNum">     651 </span>            :     }
<span class="lineNum">     652 </span><span class="lineCov">          1 :     cairo_font_options_set_antialias(aFontOptions, antialias);</span>
<span class="lineNum">     653 </span><span class="lineCov">          1 : }</span>
<a name="654"><span class="lineNum">     654 </span>            : </a>
<span class="lineNum">     655 </span>            : cairo_scaled_font_t*
<span class="lineNum">     656 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::CreateScaledFont(FcPattern* aRenderPattern,</span>
<span class="lineNum">     657 </span>            :                                          gfxFloat aAdjustedSize,
<span class="lineNum">     658 </span>            :                                          const gfxFontStyle *aStyle,
<span class="lineNum">     659 </span>            :                                          bool aNeedsBold)
<span class="lineNum">     660 </span>            : {
<span class="lineNum">     661 </span><span class="lineCov">          1 :     if (aNeedsBold) {</span>
<span class="lineNum">     662 </span><span class="lineCov">          1 :         FcPatternAddBool(aRenderPattern, FC_EMBOLDEN, FcTrue);</span>
<span class="lineNum">     663 </span>            :     }
<span class="lineNum">     664 </span>            : 
<span class="lineNum">     665 </span>            :     // synthetic oblique by skewing via the font matrix
<span class="lineNum">     666 </span><span class="lineCov">          1 :     bool needsOblique = IsUpright() &amp;&amp;</span>
<span class="lineNum">     667 </span><span class="lineCov">          1 :                         aStyle-&gt;style != NS_FONT_STYLE_NORMAL &amp;&amp;</span>
<span class="lineNum">     668 </span><span class="lineCov">          1 :                         aStyle-&gt;allowSyntheticStyle;</span>
<span class="lineNum">     669 </span>            : 
<span class="lineNum">     670 </span><span class="lineCov">          1 :     if (needsOblique) {</span>
<span class="lineNum">     671 </span>            :         // disable embedded bitmaps (mimics behavior in 90-synthetic.conf)
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :         FcPatternDel(aRenderPattern, FC_EMBEDDED_BITMAP);</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :         FcPatternAddBool(aRenderPattern, FC_EMBEDDED_BITMAP, FcFalse);</span>
<span class="lineNum">     674 </span>            :     }
<span class="lineNum">     675 </span>            : 
<span class="lineNum">     676 </span>            :     cairo_font_face_t *face =
<span class="lineNum">     677 </span><span class="lineCov">          1 :         cairo_ft_font_face_create_for_pattern(aRenderPattern);</span>
<span class="lineNum">     678 </span>            : 
<span class="lineNum">     679 </span><span class="lineCov">          1 :     if (mFontData) {</span>
<span class="lineNum">     680 </span>            :         // for data fonts, add the face/data pointer to the cairo font face
<span class="lineNum">     681 </span>            :         // so that it gets deleted whenever cairo decides
<span class="lineNum">     682 </span>            :         NS_ASSERTION(mFTFace, &quot;FT_Face is null when setting user data&quot;);
<span class="lineNum">     683 </span>            :         NS_ASSERTION(mUserFontData, &quot;user font data is null when setting user data&quot;);
<span class="lineNum">     684 </span>            :         cairo_font_face_set_user_data(face,
<span class="lineNum">     685 </span>            :                                       &amp;sFcFontlistUserFontDataKey,
<span class="lineNum">     686 </span><span class="lineCov">          1 :                                       new FTUserFontDataRef(mUserFontData),</span>
<span class="lineNum">     687 </span><span class="lineCov">          1 :                                       FTUserFontDataRef::Destroy);</span>
<span class="lineNum">     688 </span>            :     }
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span><span class="lineCov">          1 :     cairo_scaled_font_t *scaledFont = nullptr;</span>
<span class="lineNum">     691 </span>            : 
<span class="lineNum">     692 </span>            :     cairo_matrix_t sizeMatrix;
<span class="lineNum">     693 </span>            :     cairo_matrix_t identityMatrix;
<span class="lineNum">     694 </span>            : 
<span class="lineNum">     695 </span><span class="lineCov">          1 :     cairo_matrix_init_scale(&amp;sizeMatrix, aAdjustedSize, aAdjustedSize);</span>
<span class="lineNum">     696 </span><span class="lineCov">          1 :     cairo_matrix_init_identity(&amp;identityMatrix);</span>
<span class="lineNum">     697 </span>            : 
<span class="lineNum">     698 </span><span class="lineCov">          1 :     if (needsOblique) {</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :         const double kSkewFactor = OBLIQUE_SKEW_FACTOR;</span>
<span class="lineNum">     700 </span>            : 
<span class="lineNum">     701 </span>            :         cairo_matrix_t style;
<span class="lineNum">     702 </span>            :         cairo_matrix_init(&amp;style,
<span class="lineNum">     703 </span>            :                           1,                //xx
<span class="lineNum">     704 </span>            :                           0,                //yx
<span class="lineNum">     705 </span>            :                           -1 * kSkewFactor,  //xy
<span class="lineNum">     706 </span>            :                           1,                //yy
<span class="lineNum">     707 </span>            :                           0,                //x0
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :                           0);               //y0</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :         cairo_matrix_multiply(&amp;sizeMatrix, &amp;sizeMatrix, &amp;style);</span>
<span class="lineNum">     710 </span>            :     }
<span class="lineNum">     711 </span>            : 
<span class="lineNum">     712 </span><span class="lineCov">          1 :     cairo_font_options_t *fontOptions = cairo_font_options_create();</span>
<span class="lineNum">     713 </span><span class="lineCov">          1 :     PrepareFontOptions(aRenderPattern, fontOptions);</span>
<span class="lineNum">     714 </span>            : 
<span class="lineNum">     715 </span>            :     scaledFont = cairo_scaled_font_create(face, &amp;sizeMatrix,
<span class="lineNum">     716 </span><span class="lineCov">          1 :                                           &amp;identityMatrix, fontOptions);</span>
<span class="lineNum">     717 </span><span class="lineCov">          1 :     cairo_font_options_destroy(fontOptions);</span>
<span class="lineNum">     718 </span>            : 
<span class="lineNum">     719 </span>            :     NS_ASSERTION(cairo_scaled_font_status(scaledFont) == CAIRO_STATUS_SUCCESS,
<span class="lineNum">     720 </span>            :                  &quot;Failed to make scaled font&quot;);
<span class="lineNum">     721 </span>            : 
<span class="lineNum">     722 </span><span class="lineCov">          1 :     cairo_font_face_destroy(face);</span>
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span><span class="lineCov">          1 :     return scaledFont;</span>
<span class="lineNum">     725 </span>            : }
<span class="lineNum">     726 </span>            : 
<span class="lineNum">     727 </span>            : #ifdef MOZ_WIDGET_GTK
<span class="lineNum">     728 </span>            : // defintion included below
<span class="lineNum">     729 </span>            : static void ApplyGdkScreenFontOptions(FcPattern *aPattern);
<span class="lineNum">     730 </span>            : #endif
<span class="lineNum">     731 </span>            : 
<a name="732"><span class="lineNum">     732 </span>            : #ifdef MOZ_X11</a>
<span class="lineNum">     733 </span>            : static bool
<span class="lineNum">     734 </span><span class="lineCov">          1 : GetXftInt(Display* aDisplay, const char* aName, int* aResult)</span>
<span class="lineNum">     735 </span>            : {
<span class="lineNum">     736 </span><span class="lineCov">          1 :     if (!aDisplay) {</span>
<span class="lineNum">     737 </span>            :         return false;
<span class="lineNum">     738 </span>            :     }
<span class="lineNum">     739 </span><span class="lineCov">          1 :     char* value = XGetDefault(aDisplay, &quot;Xft&quot;, aName);</span>
<span class="lineNum">     740 </span><span class="lineCov">          1 :     if (!value) {</span>
<span class="lineNum">     741 </span>            :         return false;
<span class="lineNum">     742 </span>            :     }
<span class="lineNum">     743 </span><span class="lineCov">          1 :     if (FcNameConstant(const_cast&lt;FcChar8*&gt;(ToFcChar8Ptr(value)), aResult)) {</span>
<span class="lineNum">     744 </span>            :         return true;
<span class="lineNum">     745 </span>            :     }
<span class="lineNum">     746 </span>            :     char* end;
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :     *aResult = strtol(value, &amp;end, 0);</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :     if (end != value) {</span>
<span class="lineNum">     749 </span>            :         return true;
<span class="lineNum">     750 </span>            :     }
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">     752 </span>            : }
<span class="lineNum">     753 </span>            : #endif
<a name="754"><span class="lineNum">     754 </span>            : </a>
<span class="lineNum">     755 </span>            : static void
<span class="lineNum">     756 </span><span class="lineCov">          1 : PreparePattern(FcPattern* aPattern, bool aIsPrinterFont)</span>
<span class="lineNum">     757 </span>            : {
<span class="lineNum">     758 </span><span class="lineCov">          1 :     FcConfigSubstitute(nullptr, aPattern, FcMatchPattern);</span>
<span class="lineNum">     759 </span>            : 
<span class="lineNum">     760 </span>            :     // This gets cairo_font_options_t for the Screen.  We should have
<span class="lineNum">     761 </span>            :     // different font options for printing (no hinting) but we are not told
<span class="lineNum">     762 </span>            :     // what we are measuring for.
<span class="lineNum">     763 </span>            :     //
<span class="lineNum">     764 </span>            :     // If cairo adds support for lcd_filter, gdk will not provide the default
<span class="lineNum">     765 </span>            :     // setting for that option.  We could get the default setting by creating
<span class="lineNum">     766 </span>            :     // an xlib surface once, recording its font_options, and then merging the
<span class="lineNum">     767 </span>            :     // gdk options.
<span class="lineNum">     768 </span>            :     //
<span class="lineNum">     769 </span>            :     // Using an xlib surface would also be an option to get Screen font
<span class="lineNum">     770 </span>            :     // options for non-GTK X11 toolkits, but less efficient than using GDK to
<span class="lineNum">     771 </span>            :     // pick up dynamic changes.
<span class="lineNum">     772 </span><span class="lineCov">          1 :     if(aIsPrinterFont) {</span>
<span class="lineNum">     773 </span><span class="lineCov">          1 :        cairo_font_options_t *options = cairo_font_options_create();</span>
<span class="lineNum">     774 </span><span class="lineCov">          1 :        cairo_font_options_set_hint_style (options, CAIRO_HINT_STYLE_NONE);</span>
<span class="lineNum">     775 </span><span class="lineCov">          1 :        cairo_font_options_set_antialias (options, CAIRO_ANTIALIAS_GRAY);</span>
<span class="lineNum">     776 </span><span class="lineCov">          1 :        cairo_ft_font_options_substitute(options, aPattern);</span>
<span class="lineNum">     777 </span><span class="lineCov">          1 :        cairo_font_options_destroy(options);</span>
<span class="lineNum">     778 </span><span class="lineCov">          1 :        FcPatternAddBool(aPattern, PRINTING_FC_PROPERTY, FcTrue);</span>
<span class="lineNum">     779 </span><span class="lineCov">          1 :     } else if (!gfxPlatform::IsHeadless()) {</span>
<span class="lineNum">     780 </span>            : #ifdef MOZ_WIDGET_GTK
<span class="lineNum">     781 </span><span class="lineCov">          1 :         ApplyGdkScreenFontOptions(aPattern);</span>
<span class="lineNum">     782 </span>            : 
<span class="lineNum">     783 </span>            : #ifdef MOZ_X11
<span class="lineNum">     784 </span>            :         FcValue value;
<span class="lineNum">     785 </span>            :         int lcdfilter;
<span class="lineNum">     786 </span><span class="lineCov">          1 :         if (FcPatternGet(aPattern, FC_LCD_FILTER, 0, &amp;value) == FcResultNoMatch) {</span>
<span class="lineNum">     787 </span><span class="lineCov">          1 :             GdkDisplay* dpy = gdk_display_get_default();</span>
<span class="lineNum">     788 </span><span class="lineCov">          1 :             if (GDK_IS_X11_DISPLAY(dpy) &amp;&amp;</span>
<span class="lineNum">     789 </span><span class="lineCov">          1 :                 GetXftInt(GDK_DISPLAY_XDISPLAY(dpy), &quot;lcdfilter&quot;, &amp;lcdfilter)) {</span>
<span class="lineNum">     790 </span><span class="lineCov">          1 :                 FcPatternAddInteger(aPattern, FC_LCD_FILTER, lcdfilter);</span>
<span class="lineNum">     791 </span>            :             }
<span class="lineNum">     792 </span>            :         }
<span class="lineNum">     793 </span>            : #endif // MOZ_X11
<span class="lineNum">     794 </span>            : #endif // MOZ_WIDGET_GTK
<span class="lineNum">     795 </span>            :     }
<span class="lineNum">     796 </span>            : 
<span class="lineNum">     797 </span><span class="lineCov">          1 :     FcDefaultSubstitute(aPattern);</span>
<span class="lineNum">     798 </span><span class="lineCov">          1 : }</span>
<a name="799"><span class="lineNum">     799 </span>            : </a>
<span class="lineNum">     800 </span>            : void
<span class="lineNum">     801 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::UnscaledFontCache::MoveToFront(size_t aIndex) {</span>
<span class="lineNum">     802 </span><span class="lineCov">          1 :     if (aIndex &gt; 0) {</span>
<span class="lineNum">     803 </span>            :         WeakPtr&lt;UnscaledFont&gt; front =
<span class="lineNum">     804 </span><span class="lineCov">          1 :             Move(mUnscaledFonts[aIndex]);</span>
<span class="lineNum">     805 </span><span class="lineCov">          1 :         for (size_t i = aIndex; i &gt; 0; i--) {</span>
<span class="lineNum">     806 </span><span class="lineCov">          1 :             mUnscaledFonts[i] = Move(mUnscaledFonts[i-1]);</span>
<span class="lineNum">     807 </span>            :         }
<span class="lineNum">     808 </span><span class="lineCov">          1 :         mUnscaledFonts[0] = Move(front);</span>
<span class="lineNum">     809 </span>            :     }
<span class="lineNum">     810 </span><span class="lineCov">          1 : }</span>
<a name="811"><span class="lineNum">     811 </span>            : </a>
<span class="lineNum">     812 </span>            : already_AddRefed&lt;UnscaledFontFontconfig&gt;
<span class="lineNum">     813 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::UnscaledFontCache::Lookup(const char* aFile, uint32_t aIndex) {</span>
<span class="lineNum">     814 </span><span class="lineCov">          1 :     for (size_t i = 0; i &lt; kNumEntries; i++) {</span>
<span class="lineNum">     815 </span>            :         UnscaledFontFontconfig* entry =
<span class="lineNum">     816 </span><span class="lineCov">          1 :             static_cast&lt;UnscaledFontFontconfig*&gt;(mUnscaledFonts[i].get());</span>
<span class="lineNum">     817 </span><span class="lineCov">          1 :         if (entry &amp;&amp;</span>
<span class="lineNum">     818 </span><span class="lineCov">          1 :             !strcmp(entry-&gt;GetFile(), aFile) &amp;&amp;</span>
<span class="lineNum">     819 </span><span class="lineCov">          1 :             entry-&gt;GetIndex() == aIndex) {</span>
<span class="lineNum">     820 </span><span class="lineCov">          1 :             MoveToFront(i);</span>
<span class="lineNum">     821 </span><span class="lineCov">          1 :             return do_AddRef(entry);</span>
<span class="lineNum">     822 </span>            :         }
<span class="lineNum">     823 </span>            :     }
<span class="lineNum">     824 </span><span class="lineCov">          1 :     return nullptr;</span>
<span class="lineNum">     825 </span>            : }
<a name="826"><span class="lineNum">     826 </span>            : </a>
<span class="lineNum">     827 </span>            : static inline gfxFloat
<span class="lineNum">     828 </span><span class="lineCov">          1 : SizeForStyle(gfxFontconfigFontEntry* aEntry, const gfxFontStyle&amp; aStyle)</span>
<span class="lineNum">     829 </span>            : {
<span class="lineNum">     830 </span><span class="lineCov">          1 :     return aStyle.sizeAdjust &gt;= 0.0 ?</span>
<span class="lineNum">     831 </span><span class="lineCov">          1 :                 aStyle.GetAdjustedSize(aEntry-&gt;GetAspect()) :</span>
<span class="lineNum">     832 </span><span class="lineCov">          1 :                 aStyle.size;</span>
<span class="lineNum">     833 </span>            : }
<a name="834"><span class="lineNum">     834 </span>            : </a>
<span class="lineNum">     835 </span>            : static double
<span class="lineNum">     836 </span><span class="lineCov">          1 : ChooseFontSize(gfxFontconfigFontEntry* aEntry,</span>
<span class="lineNum">     837 </span>            :                const gfxFontStyle&amp; aStyle)
<span class="lineNum">     838 </span>            : {
<span class="lineNum">     839 </span><span class="lineCov">          1 :     double requestedSize = SizeForStyle(aEntry, aStyle);</span>
<span class="lineNum">     840 </span><span class="lineCov">          1 :     double bestDist = -1.0;</span>
<span class="lineNum">     841 </span><span class="lineCov">          1 :     double bestSize = requestedSize;</span>
<span class="lineNum">     842 </span>            :     double size;
<span class="lineNum">     843 </span><span class="lineCov">          1 :     int v = 0;</span>
<span class="lineNum">     844 </span><span class="lineCov">          1 :     while (FcPatternGetDouble(aEntry-&gt;GetPattern(),</span>
<span class="lineNum">     845 </span><span class="lineCov">          1 :                               FC_PIXEL_SIZE, v, &amp;size) == FcResultMatch) {</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :         ++v;</span>
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :         double dist = fabs(size - requestedSize);</span>
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :         if (bestDist &lt; 0.0 || dist &lt; bestDist) {</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :             bestDist = dist;</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :             bestSize = size;</span>
<span class="lineNum">     851 </span>            :         }
<span class="lineNum">     852 </span>            :     }
<span class="lineNum">     853 </span><span class="lineCov">          1 :     return bestSize;</span>
<span class="lineNum">     854 </span>            : }
<a name="855"><span class="lineNum">     855 </span>            : </a>
<span class="lineNum">     856 </span>            : gfxFont*
<span class="lineNum">     857 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::CreateFontInstance(const gfxFontStyle *aFontStyle,</span>
<span class="lineNum">     858 </span>            :                                            bool aNeedsBold)
<span class="lineNum">     859 </span>            : {
<span class="lineNum">     860 </span><span class="lineCov">          1 :     nsAutoRef&lt;FcPattern&gt; pattern(FcPatternCreate());</span>
<span class="lineNum">     861 </span><span class="lineCov">          1 :     if (!pattern) {</span>
<span class="lineNum">     862 </span>            :         NS_WARNING(&quot;Failed to create Fontconfig pattern for font instance&quot;);
<span class="lineNum">     863 </span>            :         return nullptr;
<span class="lineNum">     864 </span>            :     }
<span class="lineNum">     865 </span>            : 
<span class="lineNum">     866 </span><span class="lineCov">          1 :     double size = ChooseFontSize(this, *aFontStyle);</span>
<span class="lineNum">     867 </span><span class="lineCov">          1 :     FcPatternAddDouble(pattern, FC_PIXEL_SIZE, size);</span>
<span class="lineNum">     868 </span>            : 
<span class="lineNum">     869 </span><span class="lineCov">          1 :     PreparePattern(pattern, aFontStyle-&gt;printerFont);</span>
<span class="lineNum">     870 </span>            :     nsAutoRef&lt;FcPattern&gt; renderPattern
<span class="lineNum">     871 </span><span class="lineCov">          1 :         (FcFontRenderPrepare(nullptr, pattern, mFontPattern));</span>
<span class="lineNum">     872 </span><span class="lineCov">          1 :     if (!renderPattern) {</span>
<span class="lineNum">     873 </span>            :         NS_WARNING(&quot;Failed to prepare Fontconfig pattern for font instance&quot;);
<span class="lineNum">     874 </span>            :         return nullptr;
<span class="lineNum">     875 </span>            :     }
<span class="lineNum">     876 </span>            : 
<span class="lineNum">     877 </span>            :     cairo_scaled_font_t* scaledFont =
<span class="lineNum">     878 </span><span class="lineCov">          1 :         CreateScaledFont(renderPattern, size, aFontStyle, aNeedsBold);</span>
<span class="lineNum">     879 </span>            : 
<span class="lineNum">     880 </span><span class="lineCov">          1 :     const FcChar8* file = ToFcChar8Ptr(&quot;&quot;);</span>
<span class="lineNum">     881 </span><span class="lineCov">          1 :     int index = 0;</span>
<span class="lineNum">     882 </span><span class="lineCov">          1 :     if (!mFontData) {</span>
<span class="lineNum">     883 </span><span class="lineCov">          1 :         if (FcPatternGetString(renderPattern, FC_FILE, 0,</span>
<span class="lineNum">     884 </span><span class="lineCov">          1 :                                const_cast&lt;FcChar8**&gt;(&amp;file)) != FcResultMatch ||</span>
<span class="lineNum">     885 </span><span class="lineCov">          1 :             FcPatternGetInteger(renderPattern, FC_INDEX, 0, &amp;index) != FcResultMatch) {</span>
<span class="lineNum">     886 </span>            :             NS_WARNING(&quot;No file in Fontconfig pattern for font instance&quot;);
<span class="lineNum">     887 </span>            :             return nullptr;
<span class="lineNum">     888 </span>            :         }
<span class="lineNum">     889 </span>            :     }
<span class="lineNum">     890 </span>            : 
<span class="lineNum">     891 </span>            :     RefPtr&lt;UnscaledFontFontconfig&gt; unscaledFont =
<span class="lineNum">     892 </span><span class="lineCov">          1 :         mUnscaledFontCache.Lookup(ToCharPtr(file), index);</span>
<span class="lineNum">     893 </span><span class="lineCov">          1 :     if (!unscaledFont) {</span>
<span class="lineNum">     894 </span><span class="lineCov">          1 :         unscaledFont =</span>
<span class="lineNum">     895 </span>            :             mFontData ?
<span class="lineNum">     896 </span><span class="lineCov">          1 :                 new UnscaledFontFontconfig(mFTFace) :</span>
<span class="lineNum">     897 </span><span class="lineCov">          1 :                 new UnscaledFontFontconfig(ToCharPtr(file), index);</span>
<span class="lineNum">     898 </span><span class="lineCov">          1 :         mUnscaledFontCache.Add(unscaledFont);</span>
<span class="lineNum">     899 </span>            :     }
<span class="lineNum">     900 </span>            : 
<span class="lineNum">     901 </span>            :     gfxFont* newFont =
<span class="lineNum">     902 </span>            :         new gfxFontconfigFont(unscaledFont, scaledFont,
<span class="lineNum">     903 </span>            :                               renderPattern, size,
<span class="lineNum">     904 </span><span class="lineCov">          1 :                               this, aFontStyle, aNeedsBold);</span>
<span class="lineNum">     905 </span><span class="lineCov">          1 :     cairo_scaled_font_destroy(scaledFont);</span>
<span class="lineNum">     906 </span>            : 
<span class="lineNum">     907 </span>            :     return newFont;
<span class="lineNum">     908 </span>            : }
<a name="909"><span class="lineNum">     909 </span>            : </a>
<span class="lineNum">     910 </span>            : nsresult
<span class="lineNum">     911 </span><span class="lineCov">          1 : gfxFontconfigFontEntry::CopyFontTable(uint32_t aTableTag,</span>
<span class="lineNum">     912 </span>            :                                       nsTArray&lt;uint8_t&gt;&amp; aBuffer)
<span class="lineNum">     913 </span>            : {
<span class="lineNum">     914 </span>            :     NS_ASSERTION(!mIsDataUserFont,
<span class="lineNum">     915 </span>            :                  &quot;data fonts should be reading tables directly from memory&quot;);
<span class="lineNum">     916 </span>            : 
<span class="lineNum">     917 </span><span class="lineCov">          1 :     if (!mFTFaceInitialized) {</span>
<span class="lineNum">     918 </span><span class="lineCov">          1 :         mFTFaceInitialized = true;</span>
<span class="lineNum">     919 </span>            :         FcChar8 *filename;
<span class="lineNum">     920 </span><span class="lineCov">          1 :         if (FcPatternGetString(mFontPattern, FC_FILE, 0, &amp;filename) != FcResultMatch) {</span>
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :             return NS_ERROR_FAILURE;</span>
<span class="lineNum">     922 </span>            :         }
<span class="lineNum">     923 </span>            :         int index;
<span class="lineNum">     924 </span><span class="lineCov">          1 :         if (FcPatternGetInteger(mFontPattern, FC_INDEX, 0, &amp;index) != FcResultMatch) {</span>
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :             index = 0; // default to 0 if not found in pattern</span>
<span class="lineNum">     926 </span>            :         }
<span class="lineNum">     927 </span><span class="lineCov">          1 :         if (FT_New_Face(gfxFcPlatformFontList::GetFTLibrary(),</span>
<span class="lineNum">     928 </span><span class="lineCov">          1 :                         (const char*)filename, index, &amp;mFTFace) != 0) {</span>
<span class="lineNum">     929 </span>            :             return NS_ERROR_FAILURE;
<span class="lineNum">     930 </span>            :         }
<span class="lineNum">     931 </span>            :     }
<span class="lineNum">     932 </span>            : 
<span class="lineNum">     933 </span><span class="lineCov">          1 :     if (!mFTFace) {</span>
<span class="lineNum">     934 </span>            :         return NS_ERROR_NOT_AVAILABLE;
<span class="lineNum">     935 </span>            :     }
<span class="lineNum">     936 </span>            : 
<span class="lineNum">     937 </span><span class="lineCov">          1 :     FT_ULong length = 0;</span>
<span class="lineNum">     938 </span><span class="lineCov">          1 :     if (FT_Load_Sfnt_Table(mFTFace, aTableTag, 0, nullptr, &amp;length) != 0) {</span>
<span class="lineNum">     939 </span>            :         return NS_ERROR_NOT_AVAILABLE;
<span class="lineNum">     940 </span>            :     }
<span class="lineNum">     941 </span><span class="lineCov">          1 :     if (!aBuffer.SetLength(length, fallible)) {</span>
<span class="lineNum">     942 </span>            :         return NS_ERROR_OUT_OF_MEMORY;
<span class="lineNum">     943 </span>            :     }
<span class="lineNum">     944 </span><span class="lineCov">          1 :     if (FT_Load_Sfnt_Table(mFTFace, aTableTag, 0, aBuffer.Elements(), &amp;length) != 0) {</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :         aBuffer.Clear();</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :         return NS_ERROR_FAILURE;</span>
<span class="lineNum">     947 </span>            :     }
<span class="lineNum">     948 </span>            : 
<span class="lineNum">     949 </span>            :     return NS_OK;
<span class="lineNum">     950 </span>            : }
<a name="951"><span class="lineNum">     951 </span>            : </a>
<span class="lineNum">     952 </span>            : void
<span class="lineNum">     953 </span><span class="lineCov">          1 : gfxFontconfigFontFamily::FindStyleVariations(FontInfoData *aFontInfoData)</span>
<span class="lineNum">     954 </span>            : {
<span class="lineNum">     955 </span><span class="lineCov">          1 :     if (mHasStyles) {</span>
<span class="lineNum">     956 </span><span class="lineCov">          1 :         return;</span>
<span class="lineNum">     957 </span>            :     }
<span class="lineNum">     958 </span>            : 
<span class="lineNum">     959 </span>            :     // add font entries for each of the faces
<span class="lineNum">     960 </span><span class="lineCov">          1 :     uint32_t numFonts = mFontPatterns.Length();</span>
<span class="lineNum">     961 </span>            :     NS_ASSERTION(numFonts, &quot;font family containing no faces!!&quot;);
<span class="lineNum">     962 </span><span class="lineCov">          1 :     uint32_t numRegularFaces = 0;</span>
<span class="lineNum">     963 </span><span class="lineCov">          1 :     for (uint32_t i = 0; i &lt; numFonts; i++) {</span>
<span class="lineNum">     964 </span><span class="lineCov">          1 :         FcPattern* face = mFontPatterns[i];</span>
<span class="lineNum">     965 </span>            : 
<span class="lineNum">     966 </span>            :         // figure out the psname/fullname and choose which to use as the facename
<span class="lineNum">     967 </span><span class="lineCov">          1 :         nsAutoString psname, fullname;</span>
<span class="lineNum">     968 </span><span class="lineCov">          1 :         GetFaceNames(face, mName, psname, fullname);</span>
<span class="lineNum">     969 </span><span class="lineCov">          1 :         const nsAutoString&amp; faceName = !psname.IsEmpty() ? psname : fullname;</span>
<span class="lineNum">     970 </span>            : 
<span class="lineNum">     971 </span>            :         gfxFontconfigFontEntry *fontEntry =
<span class="lineNum">     972 </span><span class="lineCov">          1 :             new gfxFontconfigFontEntry(faceName, face, mContainsAppFonts);</span>
<span class="lineNum">     973 </span><span class="lineCov">          1 :         AddFontEntry(fontEntry);</span>
<span class="lineNum">     974 </span>            : 
<span class="lineNum">     975 </span><span class="lineCov">          1 :         if (fontEntry-&gt;IsUpright() &amp;&amp;</span>
<span class="lineNum">     976 </span><span class="lineCov">          1 :             fontEntry-&gt;Weight() == NS_FONT_WEIGHT_NORMAL &amp;&amp;</span>
<span class="lineNum">     977 </span><span class="lineCov">          1 :             fontEntry-&gt;Stretch() == NS_FONT_STRETCH_NORMAL) {</span>
<span class="lineNum">     978 </span><span class="lineCov">          1 :             numRegularFaces++;</span>
<span class="lineNum">     979 </span>            :         }
<span class="lineNum">     980 </span>            : 
<span class="lineNum">     981 </span><span class="lineCov">          1 :         if (LOG_FONTLIST_ENABLED()) {</span>
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :             LOG_FONTLIST((&quot;(fontlist) added (%s) to family (%s)&quot;</span>
<span class="lineNum">     983 </span>            :                  &quot; with style: %s weight: %d stretch: %d&quot;
<span class="lineNum">     984 </span>            :                  &quot; psname: %s fullname: %s&quot;,
<span class="lineNum">     985 </span>            :                  NS_ConvertUTF16toUTF8(fontEntry-&gt;Name()).get(),
<span class="lineNum">     986 </span>            :                  NS_ConvertUTF16toUTF8(Name()).get(),
<span class="lineNum">     987 </span>            :                  (fontEntry-&gt;IsItalic()) ?
<span class="lineNum">     988 </span>            :                   &quot;italic&quot; : (fontEntry-&gt;IsOblique() ? &quot;oblique&quot; : &quot;normal&quot;),
<span class="lineNum">     989 </span>            :                  fontEntry-&gt;Weight(), fontEntry-&gt;Stretch(),
<span class="lineNum">     990 </span>            :                  NS_ConvertUTF16toUTF8(psname).get(),
<span class="lineNum">     991 </span>            :                  NS_ConvertUTF16toUTF8(fullname).get()));
<span class="lineNum">     992 </span>            :         }
<span class="lineNum">     993 </span>            :     }
<span class="lineNum">     994 </span>            : 
<span class="lineNum">     995 </span>            :     // somewhat arbitrary, but define a family with two or more regular
<span class="lineNum">     996 </span>            :     // faces as a family for which intra-family fallback should be used
<span class="lineNum">     997 </span><span class="lineCov">          1 :     if (numRegularFaces &gt; 1) {</span>
<span class="lineNum">     998 </span><span class="lineCov">          1 :         mCheckForFallbackFaces = true;</span>
<span class="lineNum">     999 </span>            :     }
<span class="lineNum">    1000 </span><span class="lineCov">          1 :     mFaceNamesInitialized = true;</span>
<span class="lineNum">    1001 </span><span class="lineCov">          1 :     mFontPatterns.Clear();</span>
<span class="lineNum">    1002 </span><span class="lineCov">          1 :     SetHasStyles(true);</span>
<span class="lineNum">    1003 </span>            : }
<a name="1004"><span class="lineNum">    1004 </span>            : </a>
<span class="lineNum">    1005 </span>            : void
<span class="lineNum">    1006 </span><span class="lineCov">          1 : gfxFontconfigFontFamily::AddFontPattern(FcPattern* aFontPattern)</span>
<span class="lineNum">    1007 </span>            : {
<span class="lineNum">    1008 </span>            :     NS_ASSERTION(!mHasStyles,
<span class="lineNum">    1009 </span>            :                  &quot;font patterns must not be added to already enumerated families&quot;);
<span class="lineNum">    1010 </span>            : 
<span class="lineNum">    1011 </span>            :     FcBool scalable;
<span class="lineNum">    1012 </span><span class="lineCov">          1 :     if (FcPatternGetBool(aFontPattern, FC_SCALABLE, 0, &amp;scalable) != FcResultMatch ||</span>
<span class="lineNum">    1013 </span><span class="lineCov">          1 :         !scalable) {</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :         mHasNonScalableFaces = true;</span>
<span class="lineNum">    1015 </span>            :     }
<span class="lineNum">    1016 </span>            : 
<span class="lineNum">    1017 </span>            :     nsCountedRef&lt;FcPattern&gt; pattern(aFontPattern);
<span class="lineNum">    1018 </span><span class="lineCov">          1 :     mFontPatterns.AppendElement(pattern);</span>
<span class="lineNum">    1019 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    1020 </span>            : 
<span class="lineNum">    1021 </span>            : static const double kRejectDistance = 10000.0;
<span class="lineNum">    1022 </span>            : 
<span class="lineNum">    1023 </span>            : // Calculate a distance score representing the size disparity between the
<a name="1024"><span class="lineNum">    1024 </span>            : // requested style's size and the font entry's size.</a>
<span class="lineNum">    1025 </span>            : static double
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 : SizeDistance(gfxFontconfigFontEntry* aEntry, const gfxFontStyle&amp; aStyle)</span>
<span class="lineNum">    1027 </span>            : {
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :     double requestedSize = SizeForStyle(aEntry, aStyle);</span>
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :     double bestDist = -1.0;</span>
<span class="lineNum">    1030 </span>            :     double size;
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :     int v = 0;</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :     while (FcPatternGetDouble(aEntry-&gt;GetPattern(),</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :                               FC_PIXEL_SIZE, v, &amp;size) == FcResultMatch) {</span>
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :         ++v;</span>
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :         double dist = fabs(size - requestedSize);</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :         if (bestDist &lt; 0.0 || dist &lt; bestDist) {</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :             bestDist = dist;</span>
<span class="lineNum">    1038 </span>            :         }
<span class="lineNum">    1039 </span>            :     }
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :     if (bestDist &lt; 0.0) {</span>
<span class="lineNum">    1041 </span>            :         // No size means scalable
<span class="lineNum">    1042 </span>            :         return -1.0;
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :     } else if (5.0 * bestDist &lt; requestedSize) {</span>
<span class="lineNum">    1044 </span>            :         // fontconfig prefers a matching family or lang to pixelsize of bitmap
<span class="lineNum">    1045 </span>            :         // fonts. CSS suggests a tolerance of 20% on pixelsize.
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :         return bestDist;</span>
<span class="lineNum">    1047 </span>            :     } else {
<span class="lineNum">    1048 </span>            :         // Reject any non-scalable fonts that are not within tolerance.
<span class="lineNum">    1049 </span>            :         return kRejectDistance;
<span class="lineNum">    1050 </span>            :     }
<span class="lineNum">    1051 </span>            : }
<a name="1052"><span class="lineNum">    1052 </span>            : </a>
<span class="lineNum">    1053 </span>            : void
<span class="lineNum">    1054 </span><span class="lineCov">          1 : gfxFontconfigFontFamily::FindAllFontsForStyle(const gfxFontStyle&amp; aFontStyle,</span>
<span class="lineNum">    1055 </span>            :                                               nsTArray&lt;gfxFontEntry*&gt;&amp; aFontEntryList,
<span class="lineNum">    1056 </span>            :                                               bool&amp; aNeedsSyntheticBold)
<span class="lineNum">    1057 </span>            : {
<span class="lineNum">    1058 </span>            :     gfxFontFamily::FindAllFontsForStyle(aFontStyle,
<span class="lineNum">    1059 </span>            :                                         aFontEntryList,
<span class="lineNum">    1060 </span><span class="lineCov">          1 :                                         aNeedsSyntheticBold);</span>
<span class="lineNum">    1061 </span>            : 
<span class="lineNum">    1062 </span><span class="lineCov">          1 :     if (!mHasNonScalableFaces) {</span>
<span class="lineNum">    1063 </span><span class="lineCov">          1 :         return;</span>
<span class="lineNum">    1064 </span>            :     }
<span class="lineNum">    1065 </span>            : 
<span class="lineNum">    1066 </span>            :     // Iterate over the the available fonts while compacting any groups
<span class="lineNum">    1067 </span>            :     // of unscalable fonts with matching styles into a single entry
<span class="lineNum">    1068 </span>            :     // corresponding to the closest available size. If the closest
<span class="lineNum">    1069 </span>            :     // available size is rejected for being outside tolernace, then the
<span class="lineNum">    1070 </span>            :     // entire group will be skipped.
<span class="lineNum">    1071 </span>            :     size_t skipped = 0;
<span class="lineNum">    1072 </span>            :     gfxFontconfigFontEntry* bestEntry = nullptr;
<span class="lineNum">    1073 </span>            :     double bestDist = -1.0;
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :     for (size_t i = 0; i &lt; aFontEntryList.Length(); i++) {</span>
<span class="lineNum">    1075 </span>            :         gfxFontconfigFontEntry* entry =
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :             static_cast&lt;gfxFontconfigFontEntry*&gt;(aFontEntryList[i]);</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :         double dist = SizeDistance(entry, aFontStyle);</span>
<span class="lineNum">    1078 </span>            :         // If the entry is scalable or has a style that does not match
<span class="lineNum">    1079 </span>            :         // the group of unscalable fonts, then start a new group.
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :         if (dist &lt; 0.0 ||</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :             !bestEntry ||</span>
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :             bestEntry-&gt;Stretch() != entry-&gt;Stretch() ||</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :             bestEntry-&gt;Weight() != entry-&gt;Weight() ||</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :             bestEntry-&gt;mStyle != entry-&gt;mStyle) {</span>
<span class="lineNum">    1085 </span>            :             // If the best entry in this group is still outside the tolerance,
<span class="lineNum">    1086 </span>            :             // then skip the entire group.
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :             if (bestDist &gt;= kRejectDistance) {</span>
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :                 skipped++;</span>
<span class="lineNum">    1089 </span>            :             }
<span class="lineNum">    1090 </span>            :             // Remove any compacted entries from the previous group.
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :             if (skipped) {</span>
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :                 i -= skipped;</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :                 aFontEntryList.RemoveElementsAt(i, skipped);</span>
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :                 skipped = 0;</span>
<span class="lineNum">    1095 </span>            :             }
<span class="lineNum">    1096 </span>            :             // Mark the start of the new group.
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :             bestEntry = entry;</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :             bestDist = dist;</span>
<span class="lineNum">    1099 </span>            :         } else {
<span class="lineNum">    1100 </span>            :             // If this entry more closely matches the requested size than the
<span class="lineNum">    1101 </span>            :             // current best in the group, then take this entry instead.
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :             if (dist &lt; bestDist) {</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :                 aFontEntryList[i-1-skipped] = entry;</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :                 bestEntry = entry;</span>
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :                 bestDist = dist;</span>
<span class="lineNum">    1106 </span>            :             }
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :             skipped++;</span>
<span class="lineNum">    1108 </span>            :         }
<span class="lineNum">    1109 </span>            :     }
<span class="lineNum">    1110 </span>            :     // If the best entry in this group is still outside the tolerance,
<span class="lineNum">    1111 </span>            :     // then skip the entire group.
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :     if (bestDist &gt;= kRejectDistance) {</span>
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :         skipped++;</span>
<span class="lineNum">    1114 </span>            :     }
<span class="lineNum">    1115 </span>            :     // Remove any compacted entries from the current group.
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :     if (skipped) {</span>
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :         aFontEntryList.TruncateLength(aFontEntryList.Length() - skipped);</span>
<span class="lineNum">    1118 </span>            :     }
<span class="lineNum">    1119 </span>            : }
<a name="1120"><span class="lineNum">    1120 </span>            : </a>
<span class="lineNum">    1121 </span>            : /* virtual */
<span class="lineNum">    1122 </span><span class="lineCov">          1 : gfxFontconfigFontFamily::~gfxFontconfigFontFamily()</span>
<span class="lineNum">    1123 </span>            :  {
<span class="lineNum">    1124 </span>            :     // Should not be dropped by stylo
<span class="lineNum">    1125 </span>            :     MOZ_ASSERT(NS_IsMainThread());
<a name="1126"><span class="lineNum">    1126 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    1127 </span>            : 
<span class="lineNum">    1128 </span><span class="lineNoCov">          0 : gfxFontconfigFont::gfxFontconfigFont(const RefPtr&lt;UnscaledFontFontconfig&gt;&amp; aUnscaledFont,</span>
<span class="lineNum">    1129 </span>            :                                      cairo_scaled_font_t *aScaledFont,
<span class="lineNum">    1130 </span>            :                                      FcPattern *aPattern,
<span class="lineNum">    1131 </span>            :                                      gfxFloat aAdjustedSize,
<span class="lineNum">    1132 </span>            :                                      gfxFontEntry *aFontEntry,
<span class="lineNum">    1133 </span>            :                                      const gfxFontStyle *aFontStyle,
<span class="lineNum">    1134 </span>            :                                      bool aNeedsBold) :
<span class="lineNum">    1135 </span><span class="lineCov">          1 :     gfxFontconfigFontBase(aUnscaledFont, aScaledFont, aPattern, aFontEntry, aFontStyle)</span>
<span class="lineNum">    1136 </span>            : {
<span class="lineNum">    1137 </span><span class="lineCov">          1 :     mAdjustedSize = aAdjustedSize;</span>
<a name="1138"><span class="lineNum">    1138 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1139 </span>            : 
<span class="lineNum">    1140 </span><span class="lineCov">          1 : gfxFontconfigFont::~gfxFontconfigFont()</span>
<span class="lineNum">    1141 </span>            : {
<a name="1142"><span class="lineNum">    1142 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    1143 </span>            : 
<span class="lineNum">    1144 </span><span class="lineCov">          1 : gfxFcPlatformFontList::gfxFcPlatformFontList()</span>
<span class="lineNum">    1145 </span>            :     : mLocalNames(64)
<span class="lineNum">    1146 </span>            :     , mGenericMappings(32)
<span class="lineNum">    1147 </span>            :     , mFcSubstituteCache(64)
<span class="lineNum">    1148 </span>            :     , mLastConfig(nullptr)
<span class="lineNum">    1149 </span><span class="lineCov">          1 :     , mAlwaysUseFontconfigGenerics(true)</span>
<span class="lineNum">    1150 </span>            : {
<span class="lineNum">    1151 </span>            :     // if the rescan interval is set, start the timer
<span class="lineNum">    1152 </span><span class="lineCov">          1 :     int rescanInterval = FcConfigGetRescanInterval(nullptr);</span>
<span class="lineNum">    1153 </span><span class="lineCov">          1 :     if (rescanInterval) {</span>
<span class="lineNum">    1154 </span><span class="lineCov">          1 :         mLastConfig = FcConfigGetCurrent();</span>
<span class="lineNum">    1155 </span><span class="lineCov">          1 :         mCheckFontUpdatesTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;);</span>
<span class="lineNum">    1156 </span><span class="lineCov">          1 :         if (mCheckFontUpdatesTimer) {</span>
<span class="lineNum">    1157 </span><span class="lineCov">          1 :             mCheckFontUpdatesTimer-&gt;</span>
<span class="lineNum">    1158 </span>            :                 InitWithFuncCallback(CheckFontUpdates, this,
<span class="lineNum">    1159 </span><span class="lineCov">          1 :                                      (rescanInterval + 1) * 1000,</span>
<span class="lineNum">    1160 </span><span class="lineCov">          1 :                                      nsITimer::TYPE_REPEATING_SLACK);</span>
<span class="lineNum">    1161 </span>            :         } else {
<span class="lineNum">    1162 </span>            :             NS_WARNING(&quot;Failure to create font updates timer&quot;);
<span class="lineNum">    1163 </span>            :         }
<span class="lineNum">    1164 </span>            :     }
<span class="lineNum">    1165 </span>            : 
<span class="lineNum">    1166 </span>            : #ifdef MOZ_BUNDLED_FONTS
<span class="lineNum">    1167 </span><span class="lineCov">          1 :     mBundledFontsInitialized = false;</span>
<span class="lineNum">    1168 </span>            : #endif
<a name="1169"><span class="lineNum">    1169 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    1170 </span>            : 
<span class="lineNum">    1171 </span><span class="lineCov">          1 : gfxFcPlatformFontList::~gfxFcPlatformFontList()</span>
<span class="lineNum">    1172 </span>            : {
<span class="lineNum">    1173 </span><span class="lineCov">          1 :     if (mCheckFontUpdatesTimer) {</span>
<span class="lineNum">    1174 </span><span class="lineCov">          1 :         mCheckFontUpdatesTimer-&gt;Cancel();</span>
<span class="lineNum">    1175 </span><span class="lineCov">          1 :         mCheckFontUpdatesTimer = nullptr;</span>
<span class="lineNum">    1176 </span>            :     }
<span class="lineNum">    1177 </span><span class="lineCov">          1 : }</span>
<a name="1178"><span class="lineNum">    1178 </span>            : </a>
<span class="lineNum">    1179 </span>            : void
<span class="lineNum">    1180 </span><span class="lineCov">          1 : gfxFcPlatformFontList::AddFontSetFamilies(FcFontSet* aFontSet, bool aAppFonts)</span>
<span class="lineNum">    1181 </span>            : {
<span class="lineNum">    1182 </span>            :     // This iterates over the fonts in a font set and adds in gfxFontFamily
<span class="lineNum">    1183 </span>            :     // objects for each family. The patterns for individual fonts are not
<span class="lineNum">    1184 </span>            :     // copied here. When a family is actually used, the fonts in the family
<span class="lineNum">    1185 </span>            :     // are enumerated and the patterns copied. Note that we're explicitly
<span class="lineNum">    1186 </span>            :     // excluding non-scalable fonts such as X11 bitmap fonts, which
<span class="lineNum">    1187 </span>            :     // Chrome Skia/Webkit code does also.
<span class="lineNum">    1188 </span>            : 
<span class="lineNum">    1189 </span><span class="lineCov">          1 :     if (!aFontSet) {</span>
<span class="lineNum">    1190 </span>            :         NS_WARNING(&quot;AddFontSetFamilies called with a null font set.&quot;);
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1192 </span>            :     }
<span class="lineNum">    1193 </span>            : 
<span class="lineNum">    1194 </span><span class="lineCov">          1 :     FcChar8* lastFamilyName = (FcChar8*)&quot;&quot;;</span>
<span class="lineNum">    1195 </span>            :     RefPtr&lt;gfxFontconfigFontFamily&gt; fontFamily;
<span class="lineNum">    1196 </span><span class="lineCov">          1 :     nsAutoString familyName;</span>
<span class="lineNum">    1197 </span><span class="lineCov">          1 :     for (int f = 0; f &lt; aFontSet-&gt;nfont; f++) {</span>
<span class="lineNum">    1198 </span><span class="lineCov">          1 :         FcPattern* font = aFontSet-&gt;fonts[f];</span>
<span class="lineNum">    1199 </span>            : 
<span class="lineNum">    1200 </span>            :         // get canonical name
<span class="lineNum">    1201 </span><span class="lineCov">          1 :         uint32_t cIndex = FindCanonicalNameIndex(font, FC_FAMILYLANG);</span>
<span class="lineNum">    1202 </span><span class="lineCov">          1 :         FcChar8* canonical = nullptr;</span>
<span class="lineNum">    1203 </span><span class="lineCov">          1 :         FcPatternGetString(font, FC_FAMILY, cIndex, &amp;canonical);</span>
<span class="lineNum">    1204 </span><span class="lineCov">          1 :         if (!canonical) {</span>
<span class="lineNum">    1205 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    1206 </span>            :         }
<span class="lineNum">    1207 </span>            : 
<span class="lineNum">    1208 </span>            :         // same as the last one? no need to add a new family, skip
<span class="lineNum">    1209 </span><span class="lineCov">          1 :         if (FcStrCmp(canonical, lastFamilyName) != 0) {</span>
<span class="lineNum">    1210 </span><span class="lineCov">          1 :             lastFamilyName = canonical;</span>
<span class="lineNum">    1211 </span>            : 
<span class="lineNum">    1212 </span>            :             // add new family if one doesn't already exist
<span class="lineNum">    1213 </span>            :             familyName.Truncate();
<span class="lineNum">    1214 </span><span class="lineCov">          1 :             AppendUTF8toUTF16(ToCharPtr(canonical), familyName);</span>
<span class="lineNum">    1215 </span><span class="lineCov">          1 :             nsAutoString keyName(familyName);</span>
<span class="lineNum">    1216 </span><span class="lineCov">          1 :             ToLowerCase(keyName);</span>
<span class="lineNum">    1217 </span>            : 
<span class="lineNum">    1218 </span>            :             fontFamily = static_cast&lt;gfxFontconfigFontFamily*&gt;
<span class="lineNum">    1219 </span><span class="lineCov">          1 :                              (mFontFamilies.GetWeak(keyName));</span>
<span class="lineNum">    1220 </span><span class="lineCov">          1 :             if (!fontFamily) {</span>
<span class="lineNum">    1221 </span><span class="lineCov">          1 :                 fontFamily = new gfxFontconfigFontFamily(familyName);</span>
<span class="lineNum">    1222 </span><span class="lineCov">          1 :                 mFontFamilies.Put(keyName, fontFamily);</span>
<span class="lineNum">    1223 </span>            :             }
<span class="lineNum">    1224 </span>            :             // Record if the family contains fonts from the app font set
<span class="lineNum">    1225 </span>            :             // (in which case we won't rely on fontconfig's charmap, due to
<span class="lineNum">    1226 </span>            :             // bug 1276594).
<span class="lineNum">    1227 </span><span class="lineCov">          1 :             if (aAppFonts) {</span>
<span class="lineNum">    1228 </span><span class="lineCov">          1 :                 fontFamily-&gt;SetFamilyContainsAppFonts(true);</span>
<span class="lineNum">    1229 </span>            :             }
<span class="lineNum">    1230 </span>            : 
<span class="lineNum">    1231 </span>            :             // Add pointers to other localized family names. Most fonts
<span class="lineNum">    1232 </span>            :             // only have a single name, so the first call to GetString
<span class="lineNum">    1233 </span>            :             // will usually not match
<span class="lineNum">    1234 </span>            :             FcChar8* otherName;
<span class="lineNum">    1235 </span><span class="lineCov">          1 :             int n = (cIndex == 0 ? 1 : 0);</span>
<span class="lineNum">    1236 </span><span class="lineCov">          1 :             while (FcPatternGetString(font, FC_FAMILY, n, &amp;otherName) == FcResultMatch) {</span>
<span class="lineNum">    1237 </span><span class="lineCov">          1 :                 NS_ConvertUTF8toUTF16 otherFamilyName(ToCharPtr(otherName));</span>
<span class="lineNum">    1238 </span><span class="lineCov">          1 :                 AddOtherFamilyName(fontFamily, otherFamilyName);</span>
<span class="lineNum">    1239 </span><span class="lineCov">          1 :                 n++;</span>
<span class="lineNum">    1240 </span><span class="lineCov">          1 :                 if (n == int(cIndex)) {</span>
<span class="lineNum">    1241 </span><span class="lineCov">          1 :                     n++; // skip over canonical name</span>
<span class="lineNum">    1242 </span>            :                 }
<span class="lineNum">    1243 </span>            :             }
<span class="lineNum">    1244 </span>            :         }
<span class="lineNum">    1245 </span>            : 
<span class="lineNum">    1246 </span>            :         NS_ASSERTION(fontFamily, &quot;font must belong to a font family&quot;);
<span class="lineNum">    1247 </span><span class="lineCov">          1 :         fontFamily-&gt;AddFontPattern(font);</span>
<span class="lineNum">    1248 </span>            : 
<span class="lineNum">    1249 </span>            :         // map the psname, fullname ==&gt; font family for local font lookups
<span class="lineNum">    1250 </span><span class="lineCov">          1 :         nsAutoString psname, fullname;</span>
<span class="lineNum">    1251 </span><span class="lineCov">          1 :         GetFaceNames(font, familyName, psname, fullname);</span>
<span class="lineNum">    1252 </span><span class="lineCov">          1 :         if (!psname.IsEmpty()) {</span>
<span class="lineNum">    1253 </span><span class="lineCov">          1 :             ToLowerCase(psname);</span>
<span class="lineNum">    1254 </span><span class="lineCov">          1 :             mLocalNames.Put(psname, font);</span>
<span class="lineNum">    1255 </span>            :         }
<span class="lineNum">    1256 </span><span class="lineCov">          1 :         if (!fullname.IsEmpty()) {</span>
<span class="lineNum">    1257 </span><span class="lineCov">          1 :             ToLowerCase(fullname);</span>
<span class="lineNum">    1258 </span><span class="lineCov">          1 :             mLocalNames.Put(fullname, font);</span>
<span class="lineNum">    1259 </span>            :         }
<span class="lineNum">    1260 </span><span class="lineCov">          1 :     }</span>
<span class="lineNum">    1261 </span>            : }
<a name="1262"><span class="lineNum">    1262 </span>            : </a>
<span class="lineNum">    1263 </span>            : nsresult
<span class="lineNum">    1264 </span><span class="lineCov">          1 : gfxFcPlatformFontList::InitFontListForPlatform()</span>
<span class="lineNum">    1265 </span>            : {
<span class="lineNum">    1266 </span><span class="lineCov">          1 :     mLastConfig = FcConfigGetCurrent();</span>
<span class="lineNum">    1267 </span>            : 
<span class="lineNum">    1268 </span><span class="lineCov">          1 :     mLocalNames.Clear();</span>
<span class="lineNum">    1269 </span><span class="lineCov">          1 :     mFcSubstituteCache.Clear();</span>
<span class="lineNum">    1270 </span>            : 
<span class="lineNum">    1271 </span>            :     // iterate over available fonts
<span class="lineNum">    1272 </span><span class="lineCov">          1 :     FcFontSet* systemFonts = FcConfigGetFonts(nullptr, FcSetSystem);</span>
<span class="lineNum">    1273 </span><span class="lineCov">          1 :     AddFontSetFamilies(systemFonts, /* aAppFonts = */ false);</span>
<span class="lineNum">    1274 </span><span class="lineCov">          1 :     mAlwaysUseFontconfigGenerics = PrefFontListsUseOnlyGenerics();</span>
<span class="lineNum">    1275 </span>            : 
<span class="lineNum">    1276 </span>            : #ifdef MOZ_BUNDLED_FONTS
<span class="lineNum">    1277 </span><span class="lineCov">          1 :     ActivateBundledFonts();</span>
<span class="lineNum">    1278 </span><span class="lineCov">          1 :     FcFontSet* appFonts = FcConfigGetFonts(nullptr, FcSetApplication);</span>
<span class="lineNum">    1279 </span><span class="lineCov">          1 :     AddFontSetFamilies(appFonts, /* aAppFonts = */ true);</span>
<span class="lineNum">    1280 </span>            : #endif
<span class="lineNum">    1281 </span>            : 
<span class="lineNum">    1282 </span><span class="lineCov">          1 :     mOtherFamilyNamesInitialized = true;</span>
<span class="lineNum">    1283 </span>            : 
<span class="lineNum">    1284 </span><span class="lineCov">          1 :     return NS_OK;</span>
<span class="lineNum">    1285 </span>            : }
<span class="lineNum">    1286 </span>            : 
<span class="lineNum">    1287 </span>            : // For displaying the fontlist in UI, use explicit call to FcFontList. Using
<span class="lineNum">    1288 </span>            : // FcFontList results in the list containing the localized names as dictated
<a name="1289"><span class="lineNum">    1289 </span>            : // by system defaults.</a>
<span class="lineNum">    1290 </span>            : static void
<span class="lineNum">    1291 </span><span class="lineCov">          1 : GetSystemFontList(nsTArray&lt;nsString&gt;&amp; aListOfFonts, nsIAtom *aLangGroup)</span>
<span class="lineNum">    1292 </span>            : {
<span class="lineNum">    1293 </span><span class="lineCov">          1 :     aListOfFonts.Clear();</span>
<span class="lineNum">    1294 </span>            : 
<span class="lineNum">    1295 </span><span class="lineCov">          1 :     nsAutoRef&lt;FcPattern&gt; pat(FcPatternCreate());</span>
<span class="lineNum">    1296 </span><span class="lineCov">          1 :     if (!pat) {</span>
<span class="lineNum">    1297 </span>            :         return;
<span class="lineNum">    1298 </span>            :     }
<span class="lineNum">    1299 </span>            : 
<span class="lineNum">    1300 </span><span class="lineCov">          1 :     nsAutoRef&lt;FcObjectSet&gt; os(FcObjectSetBuild(FC_FAMILY, nullptr));</span>
<span class="lineNum">    1301 </span><span class="lineCov">          1 :     if (!os) {</span>
<span class="lineNum">    1302 </span>            :         return;
<span class="lineNum">    1303 </span>            :     }
<span class="lineNum">    1304 </span>            : 
<span class="lineNum">    1305 </span>            :     // add the lang to the pattern
<span class="lineNum">    1306 </span><span class="lineCov">          1 :     nsAutoCString fcLang;</span>
<span class="lineNum">    1307 </span><span class="lineCov">          1 :     gfxFcPlatformFontList* pfl = gfxFcPlatformFontList::PlatformFontList();</span>
<span class="lineNum">    1308 </span><span class="lineCov">          1 :     pfl-&gt;GetSampleLangForGroup(aLangGroup, fcLang);</span>
<span class="lineNum">    1309 </span><span class="lineCov">          1 :     if (!fcLang.IsEmpty()) {</span>
<span class="lineNum">    1310 </span><span class="lineCov">          1 :         FcPatternAddString(pat, FC_LANG, ToFcChar8Ptr(fcLang.get()));</span>
<span class="lineNum">    1311 </span>            :     }
<span class="lineNum">    1312 </span>            : 
<span class="lineNum">    1313 </span><span class="lineCov">          1 :     nsAutoRef&lt;FcFontSet&gt; fs(FcFontList(nullptr, pat, os));</span>
<span class="lineNum">    1314 </span><span class="lineCov">          1 :     if (!fs) {</span>
<span class="lineNum">    1315 </span>            :         return;
<span class="lineNum">    1316 </span>            :     }
<span class="lineNum">    1317 </span>            : 
<span class="lineNum">    1318 </span><span class="lineCov">          1 :     for (int i = 0; i &lt; fs-&gt;nfont; i++) {</span>
<span class="lineNum">    1319 </span>            :         char *family;
<span class="lineNum">    1320 </span>            : 
<span class="lineNum">    1321 </span><span class="lineCov">          1 :         if (FcPatternGetString(fs-&gt;fonts[i], FC_FAMILY, 0,</span>
<span class="lineNum">    1322 </span><span class="lineCov">          1 :                                (FcChar8 **) &amp;family) != FcResultMatch)</span>
<span class="lineNum">    1323 </span>            :         {
<span class="lineNum">    1324 </span><span class="lineCov">          1 :             continue;</span>
<span class="lineNum">    1325 </span>            :         }
<span class="lineNum">    1326 </span>            : 
<span class="lineNum">    1327 </span>            :         // Remove duplicates...
<span class="lineNum">    1328 </span><span class="lineCov">          1 :         nsAutoString strFamily;</span>
<span class="lineNum">    1329 </span><span class="lineCov">          1 :         AppendUTF8toUTF16(family, strFamily);</span>
<span class="lineNum">    1330 </span><span class="lineCov">          1 :         if (aListOfFonts.Contains(strFamily)) {</span>
<span class="lineNum">    1331 </span>            :             continue;
<span class="lineNum">    1332 </span>            :         }
<span class="lineNum">    1333 </span>            : 
<span class="lineNum">    1334 </span><span class="lineCov">          1 :         aListOfFonts.AppendElement(strFamily);</span>
<span class="lineNum">    1335 </span>            :     }
<span class="lineNum">    1336 </span>            : 
<span class="lineNum">    1337 </span><span class="lineCov">          1 :     aListOfFonts.Sort();</span>
<span class="lineNum">    1338 </span>            : }
<a name="1339"><span class="lineNum">    1339 </span>            : </a>
<span class="lineNum">    1340 </span>            : void
<span class="lineNum">    1341 </span><span class="lineCov">          1 : gfxFcPlatformFontList::GetFontList(nsIAtom *aLangGroup,</span>
<span class="lineNum">    1342 </span>            :                                    const nsACString&amp; aGenericFamily,
<span class="lineNum">    1343 </span>            :                                    nsTArray&lt;nsString&gt;&amp; aListOfFonts)
<span class="lineNum">    1344 </span>            : {
<span class="lineNum">    1345 </span>            :     // Get the list of font family names using fontconfig
<span class="lineNum">    1346 </span><span class="lineCov">          1 :     GetSystemFontList(aListOfFonts, aLangGroup);</span>
<span class="lineNum">    1347 </span>            : 
<span class="lineNum">    1348 </span>            :     // Under Linux, the generics &quot;serif&quot;, &quot;sans-serif&quot; and &quot;monospace&quot;
<span class="lineNum">    1349 </span>            :     // are included in the pref fontlist. These map to whatever fontconfig
<span class="lineNum">    1350 </span>            :     // decides they should be for a given language, rather than one of the
<span class="lineNum">    1351 </span>            :     // fonts listed in the prefs font lists (e.g. font.name.*, font.name-list.*)
<span class="lineNum">    1352 </span><span class="lineCov">          1 :     bool serif = false, sansSerif = false, monospace = false;</span>
<span class="lineNum">    1353 </span><span class="lineCov">          1 :     if (aGenericFamily.IsEmpty())</span>
<span class="lineNum">    1354 </span>            :         serif = sansSerif = monospace = true;
<span class="lineNum">    1355 </span><span class="lineCov">          1 :     else if (aGenericFamily.LowerCaseEqualsLiteral(&quot;serif&quot;))</span>
<span class="lineNum">    1356 </span>            :         serif = true;
<span class="lineNum">    1357 </span><span class="lineCov">          1 :     else if (aGenericFamily.LowerCaseEqualsLiteral(&quot;sans-serif&quot;))</span>
<span class="lineNum">    1358 </span>            :         sansSerif = true;
<span class="lineNum">    1359 </span><span class="lineCov">          1 :     else if (aGenericFamily.LowerCaseEqualsLiteral(&quot;monospace&quot;))</span>
<span class="lineNum">    1360 </span>            :         monospace = true;
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :     else if (aGenericFamily.LowerCaseEqualsLiteral(&quot;cursive&quot;) ||</span>
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :              aGenericFamily.LowerCaseEqualsLiteral(&quot;fantasy&quot;))</span>
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 :         serif = sansSerif = true;</span>
<span class="lineNum">    1364 </span>            :     else
<span class="lineNum">    1365 </span>            :         NS_NOTREACHED(&quot;unexpected CSS generic font family&quot;);
<span class="lineNum">    1366 </span>            : 
<span class="lineNum">    1367 </span>            :     // The first in the list becomes the default in
<span class="lineNum">    1368 </span>            :     // FontBuilder.readFontSelection() if the preference-selected font is not
<span class="lineNum">    1369 </span>            :     // available, so put system configured defaults first.
<span class="lineNum">    1370 </span><span class="lineCov">          1 :     if (monospace)</span>
<span class="lineNum">    1371 </span><span class="lineCov">          1 :         aListOfFonts.InsertElementAt(0, NS_LITERAL_STRING(&quot;monospace&quot;));</span>
<span class="lineNum">    1372 </span><span class="lineCov">          1 :     if (sansSerif)</span>
<span class="lineNum">    1373 </span><span class="lineCov">          1 :         aListOfFonts.InsertElementAt(0, NS_LITERAL_STRING(&quot;sans-serif&quot;));</span>
<span class="lineNum">    1374 </span><span class="lineCov">          1 :     if (serif)</span>
<span class="lineNum">    1375 </span><span class="lineCov">          1 :         aListOfFonts.InsertElementAt(0, NS_LITERAL_STRING(&quot;serif&quot;));</span>
<span class="lineNum">    1376 </span><span class="lineCov">          1 : }</span>
<a name="1377"><span class="lineNum">    1377 </span>            : </a>
<span class="lineNum">    1378 </span>            : gfxFontFamily*
<span class="lineNum">    1379 </span><span class="lineCov">          1 : gfxFcPlatformFontList::GetDefaultFontForPlatform(const gfxFontStyle* aStyle)</span>
<span class="lineNum">    1380 </span>            : {
<span class="lineNum">    1381 </span>            :     // Get the default font by using a fake name to retrieve the first
<span class="lineNum">    1382 </span>            :     // scalable font that fontconfig suggests for the given language.
<span class="lineNum">    1383 </span>            :     PrefFontList* prefFonts =
<span class="lineNum">    1384 </span><span class="lineCov">          1 :         FindGenericFamilies(NS_LITERAL_STRING(&quot;-moz-default&quot;), aStyle-&gt;language);</span>
<span class="lineNum">    1385 </span>            :     NS_ASSERTION(prefFonts, &quot;null list of generic fonts&quot;);
<span class="lineNum">    1386 </span><span class="lineCov">          1 :     if (prefFonts &amp;&amp; !prefFonts-&gt;IsEmpty()) {</span>
<span class="lineNum">    1387 </span><span class="lineCov">          1 :         return (*prefFonts)[0];</span>
<span class="lineNum">    1388 </span>            :     }
<span class="lineNum">    1389 </span>            :     return nullptr;
<span class="lineNum">    1390 </span>            : }
<a name="1391"><span class="lineNum">    1391 </span>            : </a>
<span class="lineNum">    1392 </span>            : gfxFontEntry*
<span class="lineNum">    1393 </span><span class="lineCov">          1 : gfxFcPlatformFontList::LookupLocalFont(const nsAString&amp; aFontName,</span>
<span class="lineNum">    1394 </span>            :                                        uint16_t aWeight,
<span class="lineNum">    1395 </span>            :                                        int16_t aStretch,
<span class="lineNum">    1396 </span>            :                                        uint8_t aStyle)
<span class="lineNum">    1397 </span>            : {
<span class="lineNum">    1398 </span><span class="lineCov">          1 :     nsAutoString keyName(aFontName);</span>
<span class="lineNum">    1399 </span><span class="lineCov">          1 :     ToLowerCase(keyName);</span>
<span class="lineNum">    1400 </span>            : 
<span class="lineNum">    1401 </span>            :     // if name is not in the global list, done
<span class="lineNum">    1402 </span><span class="lineCov">          1 :     FcPattern* fontPattern = mLocalNames.Get(keyName);</span>
<span class="lineNum">    1403 </span><span class="lineCov">          1 :     if (!fontPattern) {</span>
<span class="lineNum">    1404 </span>            :         return nullptr;
<span class="lineNum">    1405 </span>            :     }
<span class="lineNum">    1406 </span>            : 
<span class="lineNum">    1407 </span>            :     return new gfxFontconfigFontEntry(aFontName, fontPattern,
<span class="lineNum">    1408 </span><span class="lineCov">          1 :                                       aWeight, aStretch, aStyle);</span>
<span class="lineNum">    1409 </span>            : }
<a name="1410"><span class="lineNum">    1410 </span>            : </a>
<span class="lineNum">    1411 </span>            : gfxFontEntry*
<span class="lineNum">    1412 </span><span class="lineCov">          1 : gfxFcPlatformFontList::MakePlatformFont(const nsAString&amp; aFontName,</span>
<span class="lineNum">    1413 </span>            :                                         uint16_t aWeight,
<span class="lineNum">    1414 </span>            :                                         int16_t aStretch,
<span class="lineNum">    1415 </span>            :                                         uint8_t aStyle,
<span class="lineNum">    1416 </span>            :                                         const uint8_t* aFontData,
<span class="lineNum">    1417 </span>            :                                         uint32_t aLength)
<span class="lineNum">    1418 </span>            : {
<span class="lineNum">    1419 </span>            :     FT_Face face;
<span class="lineNum">    1420 </span>            :     FT_Error error =
<span class="lineNum">    1421 </span>            :         FT_New_Memory_Face(gfxFcPlatformFontList::GetFTLibrary(),
<span class="lineNum">    1422 </span><span class="lineCov">          1 :                            aFontData, aLength, 0, &amp;face);</span>
<span class="lineNum">    1423 </span><span class="lineCov">          1 :     if (error != FT_Err_Ok) {</span>
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :         NS_Free((void*)aFontData);</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :         return nullptr;</span>
<span class="lineNum">    1426 </span>            :     }
<span class="lineNum">    1427 </span><span class="lineCov">          1 :     if (FT_Err_Ok != FT_Select_Charmap(face, FT_ENCODING_UNICODE)) {</span>
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :         FT_Done_Face(face);</span>
<span class="lineNum">    1429 </span><span class="lineNoCov">          0 :         NS_Free((void*)aFontData);</span>
<span class="lineNum">    1430 </span><span class="lineNoCov">          0 :         return nullptr;</span>
<span class="lineNum">    1431 </span>            :     }
<span class="lineNum">    1432 </span>            : 
<span class="lineNum">    1433 </span>            :     return new gfxFontconfigFontEntry(aFontName, aWeight, aStretch,
<span class="lineNum">    1434 </span><span class="lineCov">          1 :                                       aStyle, aFontData, face);</span>
<span class="lineNum">    1435 </span>            : }
<a name="1436"><span class="lineNum">    1436 </span>            : </a>
<span class="lineNum">    1437 </span>            : bool
<span class="lineNum">    1438 </span><span class="lineCov">          1 : gfxFcPlatformFontList::FindAndAddFamilies(const nsAString&amp; aFamily,</span>
<span class="lineNum">    1439 </span>            :                                           nsTArray&lt;gfxFontFamily*&gt;* aOutput,
<span class="lineNum">    1440 </span>            :                                           gfxFontStyle* aStyle,
<span class="lineNum">    1441 </span>            :                                           gfxFloat aDevToCssSize)
<span class="lineNum">    1442 </span>            : {
<span class="lineNum">    1443 </span><span class="lineCov">          1 :     nsAutoString familyName(aFamily);</span>
<span class="lineNum">    1444 </span><span class="lineCov">          1 :     ToLowerCase(familyName);</span>
<span class="lineNum">    1445 </span><span class="lineCov">          1 :     nsIAtom* language = (aStyle ? aStyle-&gt;language.get() : nullptr);</span>
<span class="lineNum">    1446 </span>            : 
<span class="lineNum">    1447 </span>            :     // deprecated generic names are explicitly converted to standard generics
<span class="lineNum">    1448 </span><span class="lineCov">          1 :     bool isDeprecatedGeneric = false;</span>
<span class="lineNum">    1449 </span><span class="lineCov">          1 :     if (familyName.EqualsLiteral(&quot;sans&quot;) ||</span>
<span class="lineNum">    1450 </span><span class="lineCov">          1 :         familyName.EqualsLiteral(&quot;sans serif&quot;)) {</span>
<span class="lineNum">    1451 </span><span class="lineCov">          1 :         familyName.AssignLiteral(&quot;sans-serif&quot;);</span>
<span class="lineNum">    1452 </span><span class="lineCov">          1 :         isDeprecatedGeneric = true;</span>
<span class="lineNum">    1453 </span><span class="lineCov">          1 :     } else if (familyName.EqualsLiteral(&quot;mono&quot;)) {</span>
<span class="lineNum">    1454 </span><span class="lineNoCov">          0 :         familyName.AssignLiteral(&quot;monospace&quot;);</span>
<span class="lineNum">    1455 </span><span class="lineNoCov">          0 :         isDeprecatedGeneric = true;</span>
<span class="lineNum">    1456 </span>            :     }
<span class="lineNum">    1457 </span>            : 
<span class="lineNum">    1458 </span>            :     // fontconfig generics? use fontconfig to determine the family for lang
<span class="lineNum">    1459 </span><span class="lineCov">          1 :     if (isDeprecatedGeneric ||</span>
<span class="lineNum">    1460 </span><span class="lineCov">          1 :         mozilla::FontFamilyName::Convert(familyName).IsGeneric()) {</span>
<span class="lineNum">    1461 </span><span class="lineCov">          1 :         PrefFontList* prefFonts = FindGenericFamilies(familyName, language);</span>
<span class="lineNum">    1462 </span><span class="lineCov">          1 :         if (prefFonts &amp;&amp; !prefFonts-&gt;IsEmpty()) {</span>
<span class="lineNum">    1463 </span><span class="lineCov">          1 :             aOutput-&gt;AppendElements(*prefFonts);</span>
<span class="lineNum">    1464 </span><span class="lineCov">          1 :             return true;</span>
<span class="lineNum">    1465 </span>            :         }
<span class="lineNum">    1466 </span>            :         return false;
<span class="lineNum">    1467 </span>            :     }
<span class="lineNum">    1468 </span>            : 
<span class="lineNum">    1469 </span>            :     // fontconfig allows conditional substitutions in such a way that it's
<span class="lineNum">    1470 </span>            :     // difficult to distinguish an explicit substitution from other suggested
<span class="lineNum">    1471 </span>            :     // choices. To sniff out explicit substitutions, compare the substitutions
<span class="lineNum">    1472 </span>            :     // for &quot;font, -moz-sentinel&quot; to &quot;-moz-sentinel&quot; to sniff out the
<span class="lineNum">    1473 </span>            :     // substitutions
<span class="lineNum">    1474 </span>            :     //
<span class="lineNum">    1475 </span>            :     // Example:
<span class="lineNum">    1476 </span>            :     //
<span class="lineNum">    1477 </span>            :     //   serif ==&gt; DejaVu Serif, ...
<span class="lineNum">    1478 </span>            :     //   Helvetica, serif ==&gt; Helvetica, TeX Gyre Heros, Nimbus Sans L, DejaVu Serif
<span class="lineNum">    1479 </span>            :     //
<span class="lineNum">    1480 </span>            :     // In this case fontconfig is including Tex Gyre Heros and
<span class="lineNum">    1481 </span>            :     // Nimbus Sans L as alternatives for Helvetica.
<span class="lineNum">    1482 </span>            : 
<span class="lineNum">    1483 </span>            :     // Because the FcConfigSubstitute call is quite expensive, we cache the
<span class="lineNum">    1484 </span>            :     // actual font families found via this process. So check the cache first:
<span class="lineNum">    1485 </span><span class="lineCov">          1 :     NS_ConvertUTF16toUTF8 familyToFind(familyName);</span>
<span class="lineNum">    1486 </span><span class="lineCov">          1 :     AutoTArray&lt;gfxFontFamily*,10&gt; cachedFamilies;</span>
<span class="lineNum">    1487 </span><span class="lineCov">          1 :     if (mFcSubstituteCache.Get(familyToFind, &amp;cachedFamilies)) {</span>
<span class="lineNum">    1488 </span><span class="lineCov">          1 :         if (cachedFamilies.IsEmpty()) {</span>
<span class="lineNum">    1489 </span>            :             return false;
<span class="lineNum">    1490 </span>            :         }
<span class="lineNum">    1491 </span><span class="lineCov">          1 :         aOutput-&gt;AppendElements(cachedFamilies);</span>
<span class="lineNum">    1492 </span><span class="lineCov">          1 :         return true;</span>
<span class="lineNum">    1493 </span>            :     }
<span class="lineNum">    1494 </span>            : 
<span class="lineNum">    1495 </span>            :     // It wasn't in the cache, so we need to ask fontconfig...
<span class="lineNum">    1496 </span><span class="lineCov">          1 :     const FcChar8* kSentinelName = ToFcChar8Ptr(&quot;-moz-sentinel&quot;);</span>
<span class="lineNum">    1497 </span><span class="lineCov">          1 :     FcChar8* sentinelFirstFamily = nullptr;</span>
<span class="lineNum">    1498 </span><span class="lineCov">          1 :     nsAutoRef&lt;FcPattern&gt; sentinelSubst(FcPatternCreate());</span>
<span class="lineNum">    1499 </span><span class="lineCov">          1 :     FcPatternAddString(sentinelSubst, FC_FAMILY, kSentinelName);</span>
<span class="lineNum">    1500 </span><span class="lineCov">          1 :     FcConfigSubstitute(nullptr, sentinelSubst, FcMatchPattern);</span>
<span class="lineNum">    1501 </span><span class="lineCov">          1 :     FcPatternGetString(sentinelSubst, FC_FAMILY, 0, &amp;sentinelFirstFamily);</span>
<span class="lineNum">    1502 </span>            : 
<span class="lineNum">    1503 </span>            :     // substitutions for font, -moz-sentinel pattern
<span class="lineNum">    1504 </span><span class="lineCov">          1 :     nsAutoRef&lt;FcPattern&gt; fontWithSentinel(FcPatternCreate());</span>
<span class="lineNum">    1505 </span>            :     FcPatternAddString(fontWithSentinel, FC_FAMILY,
<span class="lineNum">    1506 </span><span class="lineCov">          1 :                        ToFcChar8Ptr(familyToFind.get()));</span>
<span class="lineNum">    1507 </span><span class="lineCov">          1 :     FcPatternAddString(fontWithSentinel, FC_FAMILY, kSentinelName);</span>
<span class="lineNum">    1508 </span><span class="lineCov">          1 :     FcConfigSubstitute(nullptr, fontWithSentinel, FcMatchPattern);</span>
<span class="lineNum">    1509 </span>            : 
<span class="lineNum">    1510 </span>            :     // Add all font family matches until reaching the sentinel.
<span class="lineNum">    1511 </span><span class="lineCov">          1 :     FcChar8* substName = nullptr;</span>
<span class="lineNum">    1512 </span><span class="lineCov">          1 :     for (int i = 0;</span>
<span class="lineNum">    1513 </span>            :          FcPatternGetString(fontWithSentinel, FC_FAMILY,
<span class="lineNum">    1514 </span><span class="lineCov">          1 :                             i, &amp;substName) == FcResultMatch;</span>
<span class="lineNum">    1515 </span>            :          i++)
<span class="lineNum">    1516 </span>            :     {
<span class="lineNum">    1517 </span><span class="lineCov">          1 :         NS_ConvertUTF8toUTF16 subst(ToCharPtr(substName));</span>
<span class="lineNum">    1518 </span><span class="lineCov">          1 :         if (sentinelFirstFamily &amp;&amp;</span>
<span class="lineNum">    1519 </span><span class="lineCov">          1 :             FcStrCmp(substName, sentinelFirstFamily) == 0) {</span>
<span class="lineNum">    1520 </span>            :             break;
<span class="lineNum">    1521 </span>            :         }
<span class="lineNum">    1522 </span><span class="lineCov">          1 :         gfxPlatformFontList::FindAndAddFamilies(subst, &amp;cachedFamilies);</span>
<span class="lineNum">    1523 </span>            :     }
<span class="lineNum">    1524 </span>            : 
<span class="lineNum">    1525 </span>            :     // Cache the resulting list, so we don't have to do this again.
<span class="lineNum">    1526 </span><span class="lineCov">          1 :     mFcSubstituteCache.Put(familyToFind, cachedFamilies);</span>
<span class="lineNum">    1527 </span>            : 
<span class="lineNum">    1528 </span><span class="lineCov">          1 :     if (cachedFamilies.IsEmpty()) {</span>
<span class="lineNum">    1529 </span>            :         return false;
<span class="lineNum">    1530 </span>            :     }
<span class="lineNum">    1531 </span><span class="lineCov">          1 :     aOutput-&gt;AppendElements(cachedFamilies);</span>
<span class="lineNum">    1532 </span><span class="lineCov">          1 :     return true;</span>
<span class="lineNum">    1533 </span>            : }
<a name="1534"><span class="lineNum">    1534 </span>            : </a>
<span class="lineNum">    1535 </span>            : bool
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 : gfxFcPlatformFontList::GetStandardFamilyName(const nsAString&amp; aFontName,</span>
<span class="lineNum">    1537 </span>            :                                              nsAString&amp; aFamilyName)
<span class="lineNum">    1538 </span>            : {
<span class="lineNum">    1539 </span>            :     aFamilyName.Truncate();
<span class="lineNum">    1540 </span>            : 
<span class="lineNum">    1541 </span>            :     // The fontconfig list of fonts includes generic family names in the
<span class="lineNum">    1542 </span>            :     // font list. For these, just use the generic name.
<span class="lineNum">    1543 </span><span class="lineNoCov">          0 :     if (aFontName.EqualsLiteral(&quot;serif&quot;) ||</span>
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :         aFontName.EqualsLiteral(&quot;sans-serif&quot;) ||</span>
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :         aFontName.EqualsLiteral(&quot;monospace&quot;)) {</span>
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 :         aFamilyName.Assign(aFontName);</span>
<span class="lineNum">    1547 </span><span class="lineNoCov">          0 :         return true;</span>
<span class="lineNum">    1548 </span>            :     }
<span class="lineNum">    1549 </span>            : 
<span class="lineNum">    1550 </span><span class="lineNoCov">          0 :     nsAutoRef&lt;FcPattern&gt; pat(FcPatternCreate());</span>
<span class="lineNum">    1551 </span><span class="lineNoCov">          0 :     if (!pat) {</span>
<span class="lineNum">    1552 </span>            :         return true;
<span class="lineNum">    1553 </span>            :     }
<span class="lineNum">    1554 </span>            : 
<span class="lineNum">    1555 </span><span class="lineNoCov">          0 :     nsAutoRef&lt;FcObjectSet&gt; os(FcObjectSetBuild(FC_FAMILY, nullptr));</span>
<span class="lineNum">    1556 </span><span class="lineNoCov">          0 :     if (!os) {</span>
<span class="lineNum">    1557 </span>            :         return true;
<span class="lineNum">    1558 </span>            :     }
<span class="lineNum">    1559 </span>            : 
<span class="lineNum">    1560 </span>            :     // add the family name to the pattern
<span class="lineNum">    1561 </span><span class="lineNoCov">          0 :     NS_ConvertUTF16toUTF8 familyName(aFontName);</span>
<span class="lineNum">    1562 </span><span class="lineNoCov">          0 :     FcPatternAddString(pat, FC_FAMILY, ToFcChar8Ptr(familyName.get()));</span>
<span class="lineNum">    1563 </span>            : 
<span class="lineNum">    1564 </span><span class="lineNoCov">          0 :     nsAutoRef&lt;FcFontSet&gt; givenFS(FcFontList(nullptr, pat, os));</span>
<span class="lineNum">    1565 </span><span class="lineNoCov">          0 :     if (!givenFS) {</span>
<span class="lineNum">    1566 </span>            :         return true;
<span class="lineNum">    1567 </span>            :     }
<span class="lineNum">    1568 </span>            : 
<span class="lineNum">    1569 </span>            :     // See if there is a font face with first family equal to the given family
<span class="lineNum">    1570 </span>            :     // (needs to be in sync with names coming from GetFontList())
<span class="lineNum">    1571 </span>            :     nsTArray&lt;nsCString&gt; candidates;
<span class="lineNum">    1572 </span><span class="lineNoCov">          0 :     for (int i = 0; i &lt; givenFS-&gt;nfont; i++) {</span>
<span class="lineNum">    1573 </span>            :         char* firstFamily;
<span class="lineNum">    1574 </span>            : 
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 :         if (FcPatternGetString(givenFS-&gt;fonts[i], FC_FAMILY, 0,</span>
<span class="lineNum">    1576 </span><span class="lineNoCov">          0 :                                (FcChar8 **) &amp;firstFamily) != FcResultMatch)</span>
<span class="lineNum">    1577 </span>            :         {
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    1579 </span>            :         }
<span class="lineNum">    1580 </span>            : 
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :         nsDependentCString first(firstFamily);</span>
<span class="lineNum">    1582 </span><span class="lineNoCov">          0 :         if (!candidates.Contains(first)) {</span>
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :             candidates.AppendElement(first);</span>
<span class="lineNum">    1584 </span>            : 
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 :             if (familyName.Equals(first)) {</span>
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :                 aFamilyName.Assign(aFontName);</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :                 return true;</span>
<span class="lineNum">    1588 </span>            :             }
<span class="lineNum">    1589 </span>            :         }
<span class="lineNum">    1590 </span>            :     }
<span class="lineNum">    1591 </span>            : 
<span class="lineNum">    1592 </span>            :     // Because fontconfig conflates different family name types, need to
<span class="lineNum">    1593 </span>            :     // double check that the candidate name is not simply a different
<span class="lineNum">    1594 </span>            :     // name type. For example, if a font with nameID=16 &quot;Minion Pro&quot; and
<span class="lineNum">    1595 </span>            :     // nameID=21 &quot;Minion Pro Caption&quot; exists, calling FcFontList with
<span class="lineNum">    1596 </span>            :     // family=&quot;Minion Pro&quot; will return a set of patterns some of which
<span class="lineNum">    1597 </span>            :     // will have a first family of &quot;Minion Pro Caption&quot;. Ignore these
<span class="lineNum">    1598 </span>            :     // patterns and use the first candidate that maps to a font set with
<span class="lineNum">    1599 </span>            :     // the same number of faces and an identical set of patterns.
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 :     for (uint32_t j = 0; j &lt; candidates.Length(); ++j) {</span>
<span class="lineNum">    1601 </span><span class="lineNoCov">          0 :         FcPatternDel(pat, FC_FAMILY);</span>
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :         FcPatternAddString(pat, FC_FAMILY, (FcChar8 *)candidates[j].get());</span>
<span class="lineNum">    1603 </span>            : 
<span class="lineNum">    1604 </span><span class="lineNoCov">          0 :         nsAutoRef&lt;FcFontSet&gt; candidateFS(FcFontList(nullptr, pat, os));</span>
<span class="lineNum">    1605 </span><span class="lineNoCov">          0 :         if (!candidateFS) {</span>
<span class="lineNum">    1606 </span>            :             return true;
<span class="lineNum">    1607 </span>            :         }
<span class="lineNum">    1608 </span>            : 
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :         if (candidateFS-&gt;nfont != givenFS-&gt;nfont) {</span>
<span class="lineNum">    1610 </span>            :             continue;
<span class="lineNum">    1611 </span>            :         }
<span class="lineNum">    1612 </span>            : 
<span class="lineNum">    1613 </span>            :         bool equal = true;
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :         for (int i = 0; i &lt; givenFS-&gt;nfont; ++i) {</span>
<span class="lineNum">    1615 </span><span class="lineNoCov">          0 :             if (!FcPatternEqual(candidateFS-&gt;fonts[i], givenFS-&gt;fonts[i])) {</span>
<span class="lineNum">    1616 </span>            :                 equal = false;
<span class="lineNum">    1617 </span>            :                 break;
<span class="lineNum">    1618 </span>            :             }
<span class="lineNum">    1619 </span>            :         }
<span class="lineNum">    1620 </span><span class="lineNoCov">          0 :         if (equal) {</span>
<span class="lineNum">    1621 </span><span class="lineNoCov">          0 :             AppendUTF8toUTF16(candidates[j], aFamilyName);</span>
<span class="lineNum">    1622 </span><span class="lineNoCov">          0 :             return true;</span>
<span class="lineNum">    1623 </span>            :         }
<span class="lineNum">    1624 </span>            :     }
<span class="lineNum">    1625 </span>            : 
<span class="lineNum">    1626 </span>            :     // didn't find localized name, leave family name blank
<span class="lineNum">    1627 </span>            :     return true;
<span class="lineNum">    1628 </span>            : }
<a name="1629"><span class="lineNum">    1629 </span>            : </a>
<span class="lineNum">    1630 </span>            : void
<span class="lineNum">    1631 </span><span class="lineCov">          1 : gfxFcPlatformFontList::AddGenericFonts(mozilla::FontFamilyType aGenericType,</span>
<span class="lineNum">    1632 </span>            :                                        nsIAtom* aLanguage,
<span class="lineNum">    1633 </span>            :                                        nsTArray&lt;gfxFontFamily*&gt;&amp; aFamilyList)
<span class="lineNum">    1634 </span>            : {
<span class="lineNum">    1635 </span><span class="lineCov">          1 :     bool usePrefFontList = false;</span>
<span class="lineNum">    1636 </span>            : 
<span class="lineNum">    1637 </span>            :     // treat -moz-fixed as monospace
<span class="lineNum">    1638 </span><span class="lineCov">          1 :     if (aGenericType == eFamily_moz_fixed) {</span>
<span class="lineNum">    1639 </span><span class="lineNoCov">          0 :         aGenericType = eFamily_monospace;</span>
<span class="lineNum">    1640 </span>            :     }
<span class="lineNum">    1641 </span>            : 
<span class="lineNum">    1642 </span><span class="lineCov">          1 :     const char* generic = GetGenericName(aGenericType);</span>
<span class="lineNum">    1643 </span>            :     NS_ASSERTION(generic, &quot;weird generic font type&quot;);
<span class="lineNum">    1644 </span><span class="lineCov">          1 :     if (!generic) {</span>
<span class="lineNum">    1645 </span><span class="lineCov">          1 :         return;</span>
<span class="lineNum">    1646 </span>            :     }
<span class="lineNum">    1647 </span>            : 
<span class="lineNum">    1648 </span>            :     // By default, most font prefs on Linux map to &quot;use fontconfig&quot;
<span class="lineNum">    1649 </span>            :     // keywords. So only need to explicitly lookup font pref if
<span class="lineNum">    1650 </span>            :     // non-default settings exist
<span class="lineNum">    1651 </span><span class="lineCov">          1 :     NS_ConvertASCIItoUTF16 genericToLookup(generic);</span>
<span class="lineNum">    1652 </span><span class="lineCov">          1 :     if ((!mAlwaysUseFontconfigGenerics &amp;&amp; aLanguage) ||</span>
<span class="lineNum">    1653 </span><span class="lineNoCov">          0 :         aLanguage == nsGkAtoms::x_math) {</span>
<span class="lineNum">    1654 </span><span class="lineCov">          1 :         nsIAtom* langGroup = GetLangGroup(aLanguage);</span>
<span class="lineNum">    1655 </span>            :         nsAdoptingString fontlistValue =
<span class="lineNum">    1656 </span><span class="lineCov">          1 :             Preferences::GetString(NamePref(generic, langGroup).get());</span>
<span class="lineNum">    1657 </span><span class="lineCov">          1 :         if (fontlistValue.IsEmpty()) {</span>
<span class="lineNum">    1658 </span>            :             // The font name list may have two or more family names as comma
<span class="lineNum">    1659 </span>            :             // separated list.  In such case, not matching with generic font
<span class="lineNum">    1660 </span>            :             // name is fine because if the list prefers specific font, we
<span class="lineNum">    1661 </span>            :             // should try to use the pref with complicated path.
<span class="lineNum">    1662 </span><span class="lineCov">          1 :             fontlistValue =</span>
<span class="lineNum">    1663 </span><span class="lineCov">          1 :                  Preferences::GetString(NameListPref(generic, langGroup).get());</span>
<span class="lineNum">    1664 </span>            :         }
<span class="lineNum">    1665 </span><span class="lineCov">          1 :         if (fontlistValue) {</span>
<span class="lineNum">    1666 </span><span class="lineCov">          1 :             if (!fontlistValue.EqualsLiteral(&quot;serif&quot;) &amp;&amp;</span>
<span class="lineNum">    1667 </span><span class="lineCov">          1 :                 !fontlistValue.EqualsLiteral(&quot;sans-serif&quot;) &amp;&amp;</span>
<span class="lineNum">    1668 </span><span class="lineCov">          1 :                 !fontlistValue.EqualsLiteral(&quot;monospace&quot;)) {</span>
<span class="lineNum">    1669 </span>            :                 usePrefFontList = true;
<span class="lineNum">    1670 </span>            :             } else {
<span class="lineNum">    1671 </span>            :                 // serif, sans-serif or monospace was specified
<span class="lineNum">    1672 </span><span class="lineCov">          1 :                 genericToLookup.Assign(fontlistValue);</span>
<span class="lineNum">    1673 </span>            :             }
<span class="lineNum">    1674 </span>            :         }
<span class="lineNum">    1675 </span>            :     }
<span class="lineNum">    1676 </span>            : 
<span class="lineNum">    1677 </span>            :     // when pref fonts exist, use standard pref font lookup
<span class="lineNum">    1678 </span><span class="lineCov">          1 :     if (usePrefFontList) {</span>
<span class="lineNum">    1679 </span>            :         return gfxPlatformFontList::AddGenericFonts(aGenericType,
<span class="lineNum">    1680 </span>            :                                                     aLanguage,
<span class="lineNum">    1681 </span><span class="lineCov">          1 :                                                     aFamilyList);</span>
<span class="lineNum">    1682 </span>            :     }
<span class="lineNum">    1683 </span>            : 
<span class="lineNum">    1684 </span><span class="lineCov">          1 :     PrefFontList* prefFonts = FindGenericFamilies(genericToLookup, aLanguage);</span>
<span class="lineNum">    1685 </span>            :     NS_ASSERTION(prefFonts, &quot;null generic font list&quot;);
<span class="lineNum">    1686 </span><span class="lineCov">          1 :     aFamilyList.AppendElements(*prefFonts);</span>
<span class="lineNum">    1687 </span>            : }
<a name="1688"><span class="lineNum">    1688 </span>            : </a>
<span class="lineNum">    1689 </span>            : void
<span class="lineNum">    1690 </span><span class="lineCov">          1 : gfxFcPlatformFontList::ClearLangGroupPrefFonts()</span>
<span class="lineNum">    1691 </span>            : {
<span class="lineNum">    1692 </span>            :     ClearGenericMappings();
<span class="lineNum">    1693 </span><span class="lineCov">          1 :     gfxPlatformFontList::ClearLangGroupPrefFonts();</span>
<span class="lineNum">    1694 </span><span class="lineCov">          1 :     mAlwaysUseFontconfigGenerics = PrefFontListsUseOnlyGenerics();</span>
<span class="lineNum">    1695 </span><span class="lineCov">          1 : }</span>
<a name="1696"><span class="lineNum">    1696 </span>            : </a>
<span class="lineNum">    1697 </span>            : /* static */ FT_Library
<span class="lineNum">    1698 </span><span class="lineCov">          1 : gfxFcPlatformFontList::GetFTLibrary()</span>
<span class="lineNum">    1699 </span>            : {
<span class="lineNum">    1700 </span><span class="lineCov">          1 :     if (!sCairoFTLibrary) {</span>
<span class="lineNum">    1701 </span>            :         // Use cairo's FT_Library so that cairo takes care of shutdown of the
<span class="lineNum">    1702 </span>            :         // FT_Library after it has destroyed its font_faces, and FT_Done_Face
<span class="lineNum">    1703 </span>            :         // has been called on each FT_Face, at least until this bug is fixed:
<span class="lineNum">    1704 </span>            :         // https://bugs.freedesktop.org/show_bug.cgi?id=18857
<span class="lineNum">    1705 </span>            :         //
<span class="lineNum">    1706 </span>            :         // Cairo keeps it's own FT_Library object for creating FT_Face
<span class="lineNum">    1707 </span>            :         // instances, so use that. There's no simple API for accessing this
<span class="lineNum">    1708 </span>            :         // so use the hacky method below of making a font and extracting
<span class="lineNum">    1709 </span>            :         // the library pointer from that.
<span class="lineNum">    1710 </span>            : 
<span class="lineNum">    1711 </span>            :         bool needsBold;
<span class="lineNum">    1712 </span><span class="lineCov">          1 :         gfxFontStyle style;</span>
<span class="lineNum">    1713 </span><span class="lineCov">          1 :         gfxPlatformFontList* pfl = gfxPlatformFontList::PlatformFontList();</span>
<span class="lineNum">    1714 </span><span class="lineCov">          1 :         gfxFontFamily* family = pfl-&gt;GetDefaultFont(&amp;style);</span>
<span class="lineNum">    1715 </span>            :         NS_ASSERTION(family, &quot;couldn't find a default font family&quot;);
<span class="lineNum">    1716 </span><span class="lineCov">          1 :         gfxFontEntry* fe = family-&gt;FindFontForStyle(style, needsBold);</span>
<span class="lineNum">    1717 </span><span class="lineCov">          1 :         if (!fe) {</span>
<span class="lineNum">    1718 </span><span class="lineNoCov">          0 :             return nullptr;</span>
<span class="lineNum">    1719 </span>            :         }
<span class="lineNum">    1720 </span><span class="lineCov">          1 :         RefPtr&lt;gfxFont&gt; font = fe-&gt;FindOrMakeFont(&amp;style, false);</span>
<span class="lineNum">    1721 </span><span class="lineCov">          1 :         if (!font) {</span>
<span class="lineNum">    1722 </span><span class="lineNoCov">          0 :             return nullptr;</span>
<span class="lineNum">    1723 </span>            :         }
<span class="lineNum">    1724 </span>            : 
<span class="lineNum">    1725 </span><span class="lineCov">          1 :         gfxFT2FontBase* ft2Font = reinterpret_cast&lt;gfxFT2FontBase*&gt;(font.get());</span>
<span class="lineNum">    1726 </span><span class="lineCov">          1 :         gfxFT2LockedFace face(ft2Font);</span>
<span class="lineNum">    1727 </span><span class="lineCov">          1 :         if (!face.get()) {</span>
<span class="lineNum">    1728 </span><span class="lineNoCov">          0 :             return nullptr;</span>
<span class="lineNum">    1729 </span>            :         }
<span class="lineNum">    1730 </span>            : 
<span class="lineNum">    1731 </span><span class="lineCov">          1 :         sCairoFTLibrary = face.get()-&gt;glyph-&gt;library;</span>
<span class="lineNum">    1732 </span>            :     }
<span class="lineNum">    1733 </span>            : 
<span class="lineNum">    1734 </span><span class="lineCov">          1 :     return sCairoFTLibrary;</span>
<span class="lineNum">    1735 </span>            : }
<a name="1736"><span class="lineNum">    1736 </span>            : </a>
<span class="lineNum">    1737 </span>            : gfxPlatformFontList::PrefFontList*
<span class="lineNum">    1738 </span><span class="lineCov">          1 : gfxFcPlatformFontList::FindGenericFamilies(const nsAString&amp; aGeneric,</span>
<span class="lineNum">    1739 </span>            :                                            nsIAtom* aLanguage)
<span class="lineNum">    1740 </span>            : {
<span class="lineNum">    1741 </span>            :     // set up name
<span class="lineNum">    1742 </span><span class="lineCov">          1 :     NS_ConvertUTF16toUTF8 generic(aGeneric);</span>
<span class="lineNum">    1743 </span>            : 
<span class="lineNum">    1744 </span><span class="lineCov">          1 :     nsAutoCString fcLang;</span>
<span class="lineNum">    1745 </span><span class="lineCov">          1 :     GetSampleLangForGroup(aLanguage, fcLang);</span>
<span class="lineNum">    1746 </span><span class="lineCov">          1 :     ToLowerCase(fcLang);</span>
<span class="lineNum">    1747 </span>            : 
<span class="lineNum">    1748 </span><span class="lineCov">          1 :     nsAutoCString genericLang(generic);</span>
<span class="lineNum">    1749 </span><span class="lineCov">          1 :     if (fcLang.Length() &gt; 0) {</span>
<span class="lineNum">    1750 </span><span class="lineCov">          1 :         genericLang.Append('-');</span>
<span class="lineNum">    1751 </span>            :     }
<span class="lineNum">    1752 </span><span class="lineCov">          1 :     genericLang.Append(fcLang);</span>
<span class="lineNum">    1753 </span>            : 
<span class="lineNum">    1754 </span>            :     // try to get the family from the cache
<span class="lineNum">    1755 </span><span class="lineCov">          1 :     PrefFontList* prefFonts = mGenericMappings.Get(genericLang);</span>
<span class="lineNum">    1756 </span><span class="lineCov">          1 :     if (prefFonts) {</span>
<span class="lineNum">    1757 </span>            :         return prefFonts;
<span class="lineNum">    1758 </span>            :     }
<span class="lineNum">    1759 </span>            : 
<span class="lineNum">    1760 </span>            :     // if not found, ask fontconfig to pick the appropriate font
<span class="lineNum">    1761 </span><span class="lineCov">          1 :     nsAutoRef&lt;FcPattern&gt; genericPattern(FcPatternCreate());</span>
<span class="lineNum">    1762 </span>            :     FcPatternAddString(genericPattern, FC_FAMILY,
<span class="lineNum">    1763 </span><span class="lineCov">          1 :                        ToFcChar8Ptr(generic.get()));</span>
<span class="lineNum">    1764 </span>            : 
<span class="lineNum">    1765 </span>            :     // -- prefer scalable fonts
<span class="lineNum">    1766 </span><span class="lineCov">          1 :     FcPatternAddBool(genericPattern, FC_SCALABLE, FcTrue);</span>
<span class="lineNum">    1767 </span>            : 
<span class="lineNum">    1768 </span>            :     // -- add the lang to the pattern
<span class="lineNum">    1769 </span><span class="lineCov">          1 :     if (!fcLang.IsEmpty()) {</span>
<span class="lineNum">    1770 </span>            :         FcPatternAddString(genericPattern, FC_LANG,
<span class="lineNum">    1771 </span><span class="lineCov">          1 :                            ToFcChar8Ptr(fcLang.get()));</span>
<span class="lineNum">    1772 </span>            :     }
<span class="lineNum">    1773 </span>            : 
<span class="lineNum">    1774 </span>            :     // -- perform substitutions
<span class="lineNum">    1775 </span><span class="lineCov">          1 :     FcConfigSubstitute(nullptr, genericPattern, FcMatchPattern);</span>
<span class="lineNum">    1776 </span><span class="lineCov">          1 :     FcDefaultSubstitute(genericPattern);</span>
<span class="lineNum">    1777 </span>            : 
<span class="lineNum">    1778 </span>            :     // -- sort to get the closest matches
<span class="lineNum">    1779 </span>            :     FcResult result;
<span class="lineNum">    1780 </span>            :     nsAutoRef&lt;FcFontSet&gt; faces(FcFontSort(nullptr, genericPattern, FcFalse,
<span class="lineNum">    1781 </span><span class="lineCov">          1 :                                           nullptr, &amp;result));</span>
<span class="lineNum">    1782 </span>            : 
<span class="lineNum">    1783 </span><span class="lineCov">          1 :     if (!faces) {</span>
<span class="lineNum">    1784 </span>            :       return nullptr;
<span class="lineNum">    1785 </span>            :     }
<span class="lineNum">    1786 </span>            : 
<span class="lineNum">    1787 </span>            :     // -- select the fonts to be used for the generic
<span class="lineNum">    1788 </span><span class="lineCov">          1 :     prefFonts = new PrefFontList; // can be empty but in practice won't happen</span>
<span class="lineNum">    1789 </span><span class="lineCov">          1 :     uint32_t limit = gfxPlatformGtk::GetPlatform()-&gt;MaxGenericSubstitions();</span>
<span class="lineNum">    1790 </span><span class="lineCov">          1 :     bool foundFontWithLang = false;</span>
<span class="lineNum">    1791 </span><span class="lineCov">          1 :     for (int i = 0; i &lt; faces-&gt;nfont; i++) {</span>
<span class="lineNum">    1792 </span><span class="lineCov">          1 :         FcPattern* font = faces-&gt;fonts[i];</span>
<span class="lineNum">    1793 </span><span class="lineCov">          1 :         FcChar8* mappedGeneric = nullptr;</span>
<span class="lineNum">    1794 </span>            : 
<span class="lineNum">    1795 </span><span class="lineCov">          1 :         FcPatternGetString(font, FC_FAMILY, 0, &amp;mappedGeneric);</span>
<span class="lineNum">    1796 </span><span class="lineCov">          1 :         if (mappedGeneric) {</span>
<span class="lineNum">    1797 </span><span class="lineCov">          1 :             NS_ConvertUTF8toUTF16 mappedGenericName(ToCharPtr(mappedGeneric));</span>
<span class="lineNum">    1798 </span><span class="lineCov">          1 :             AutoTArray&lt;gfxFontFamily*,1&gt; genericFamilies;</span>
<span class="lineNum">    1799 </span><span class="lineCov">          1 :             if (gfxPlatformFontList::FindAndAddFamilies(mappedGenericName,</span>
<span class="lineNum">    1800 </span>            :                                                         &amp;genericFamilies)) {
<span class="lineNum">    1801 </span>            :                 MOZ_ASSERT(genericFamilies.Length() == 1,
<span class="lineNum">    1802 </span>            :                            &quot;expected a single family&quot;);
<span class="lineNum">    1803 </span><span class="lineCov">          1 :                 if (!prefFonts-&gt;Contains(genericFamilies[0])) {</span>
<span class="lineNum">    1804 </span><span class="lineCov">          1 :                     prefFonts-&gt;AppendElement(genericFamilies[0]);</span>
<span class="lineNum">    1805 </span>            :                     bool foundLang =
<span class="lineNum">    1806 </span><span class="lineCov">          1 :                         !fcLang.IsEmpty() &amp;&amp;</span>
<span class="lineNum">    1807 </span><span class="lineCov">          1 :                         PatternHasLang(font, ToFcChar8Ptr(fcLang.get()));</span>
<span class="lineNum">    1808 </span><span class="lineCov">          1 :                     foundFontWithLang = foundFontWithLang || foundLang;</span>
<span class="lineNum">    1809 </span>            :                     // check to see if the list is full
<span class="lineNum">    1810 </span><span class="lineCov">          1 :                     if (prefFonts-&gt;Length() &gt;= limit) {</span>
<span class="lineNum">    1811 </span>            :                         break;
<span class="lineNum">    1812 </span>            :                     }
<span class="lineNum">    1813 </span>            :                 }
<span class="lineNum">    1814 </span>            :             }
<span class="lineNum">    1815 </span>            :         }
<span class="lineNum">    1816 </span>            :     }
<span class="lineNum">    1817 </span>            : 
<span class="lineNum">    1818 </span>            :     // if no font in the list matches the lang, trim all but the first one
<span class="lineNum">    1819 </span><span class="lineCov">          1 :     if (!prefFonts-&gt;IsEmpty() &amp;&amp; !foundFontWithLang) {</span>
<span class="lineNum">    1820 </span><span class="lineCov">          1 :         prefFonts-&gt;TruncateLength(1);</span>
<span class="lineNum">    1821 </span>            :     }
<span class="lineNum">    1822 </span>            : 
<span class="lineNum">    1823 </span><span class="lineCov">          1 :     mGenericMappings.Put(genericLang, prefFonts);</span>
<span class="lineNum">    1824 </span><span class="lineCov">          1 :     return prefFonts;</span>
<span class="lineNum">    1825 </span>            : }
<a name="1826"><span class="lineNum">    1826 </span>            : </a>
<span class="lineNum">    1827 </span>            : bool
<span class="lineNum">    1828 </span><span class="lineCov">          1 : gfxFcPlatformFontList::PrefFontListsUseOnlyGenerics()</span>
<span class="lineNum">    1829 </span>            : {
<span class="lineNum">    1830 </span>            :     static const char kFontNamePrefix[] = &quot;font.name.&quot;;
<span class="lineNum">    1831 </span>            : 
<span class="lineNum">    1832 </span><span class="lineCov">          1 :     bool prefFontsUseOnlyGenerics = true;</span>
<span class="lineNum">    1833 </span>            :     uint32_t count;
<span class="lineNum">    1834 </span>            :     char** names;
<span class="lineNum">    1835 </span><span class="lineCov">          1 :     nsresult rv = Preferences::GetRootBranch()-&gt;</span>
<span class="lineNum">    1836 </span><span class="lineCov">          1 :         GetChildList(kFontNamePrefix, &amp;count, &amp;names);</span>
<span class="lineNum">    1837 </span><span class="lineCov">          1 :     if (NS_SUCCEEDED(rv) &amp;&amp; count) {</span>
<span class="lineNum">    1838 </span><span class="lineCov">          1 :         for (size_t i = 0; i &lt; count; i++) {</span>
<span class="lineNum">    1839 </span>            :             // Check whether all font.name prefs map to generic keywords
<span class="lineNum">    1840 </span>            :             // and that the pref name and keyword match.
<span class="lineNum">    1841 </span>            :             //   Ex: font.name.serif.ar ==&gt; &quot;serif&quot; (ok)
<span class="lineNum">    1842 </span>            :             //   Ex: font.name.serif.ar ==&gt; &quot;monospace&quot; (return false)
<span class="lineNum">    1843 </span>            :             //   Ex: font.name.serif.ar ==&gt; &quot;DejaVu Serif&quot; (return false)
<span class="lineNum">    1844 </span>            :             //   Ex: font.name.serif.ar ==&gt; &quot;&quot; and
<span class="lineNum">    1845 </span>            :             //       font.name-list.serif.ar ==&gt; &quot;serif&quot; (ok)
<span class="lineNum">    1846 </span>            :             //   Ex: font.name.serif.ar ==&gt; &quot;&quot; and
<span class="lineNum">    1847 </span>            :             //       font.name-list.serif.ar ==&gt; &quot;Something, serif&quot;
<span class="lineNum">    1848 </span>            :             //                                           (return false)
<span class="lineNum">    1849 </span>            : 
<span class="lineNum">    1850 </span><span class="lineCov">          1 :             nsDependentCString prefName(names[i] +</span>
<span class="lineNum">    1851 </span><span class="lineCov">          1 :                                         ArrayLength(kFontNamePrefix) - 1);</span>
<span class="lineNum">    1852 </span>            :             nsCCharSeparatedTokenizer tokenizer(prefName, '.');
<span class="lineNum">    1853 </span><span class="lineCov">          1 :             const nsDependentCSubstring&amp; generic = tokenizer.nextToken();</span>
<span class="lineNum">    1854 </span><span class="lineCov">          1 :             const nsDependentCSubstring&amp; langGroup = tokenizer.nextToken();</span>
<span class="lineNum">    1855 </span><span class="lineCov">          1 :             nsAdoptingCString fontPrefValue = Preferences::GetCString(names[i]);</span>
<span class="lineNum">    1856 </span><span class="lineCov">          1 :             if (fontPrefValue.IsEmpty()) {</span>
<span class="lineNum">    1857 </span>            :                 // The font name list may have two or more family names as comma
<span class="lineNum">    1858 </span>            :                 // separated list.  In such case, not matching with generic font
<span class="lineNum">    1859 </span>            :                 // name is fine because if the list prefers specific font, this
<span class="lineNum">    1860 </span>            :                 // should return false.
<span class="lineNum">    1861 </span><span class="lineCov">          1 :                 fontPrefValue =</span>
<span class="lineNum">    1862 </span>            :                     Preferences::GetCString(NameListPref(generic,
<span class="lineNum">    1863 </span><span class="lineCov">          1 :                                                          langGroup).get());</span>
<span class="lineNum">    1864 </span>            :             }
<span class="lineNum">    1865 </span>            : 
<span class="lineNum">    1866 </span><span class="lineCov">          1 :             if (!langGroup.EqualsLiteral(&quot;x-math&quot;) &amp;&amp;</span>
<span class="lineNum">    1867 </span><span class="lineCov">          1 :                 !generic.Equals(fontPrefValue)) {</span>
<span class="lineNum">    1868 </span><span class="lineCov">          1 :                 prefFontsUseOnlyGenerics = false;</span>
<span class="lineNum">    1869 </span>            :                 break;
<span class="lineNum">    1870 </span>            :             }
<span class="lineNum">    1871 </span>            :         }
<span class="lineNum">    1872 </span><span class="lineCov">          1 :         NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(count, names);</span>
<span class="lineNum">    1873 </span>            :     }
<span class="lineNum">    1874 </span><span class="lineCov">          1 :     return prefFontsUseOnlyGenerics;</span>
<span class="lineNum">    1875 </span>            : }
<a name="1876"><span class="lineNum">    1876 </span>            : </a>
<span class="lineNum">    1877 </span>            : /* static */ void
<span class="lineNum">    1878 </span><span class="lineCov">          1 : gfxFcPlatformFontList::CheckFontUpdates(nsITimer *aTimer, void *aThis)</span>
<span class="lineNum">    1879 </span>            : {
<span class="lineNum">    1880 </span>            :     // check for font updates
<span class="lineNum">    1881 </span><span class="lineCov">          1 :     FcInitBringUptoDate();</span>
<span class="lineNum">    1882 </span>            : 
<span class="lineNum">    1883 </span>            :     // update fontlist if current config changed
<span class="lineNum">    1884 </span><span class="lineCov">          1 :     gfxFcPlatformFontList *pfl = static_cast&lt;gfxFcPlatformFontList*&gt;(aThis);</span>
<span class="lineNum">    1885 </span><span class="lineCov">          1 :     FcConfig* current = FcConfigGetCurrent();</span>
<span class="lineNum">    1886 </span><span class="lineCov">          1 :     if (current != pfl-&gt;GetLastConfig()) {</span>
<span class="lineNum">    1887 </span><span class="lineNoCov">          0 :         pfl-&gt;UpdateFontList();</span>
<span class="lineNum">    1888 </span><span class="lineNoCov">          0 :         pfl-&gt;ForceGlobalReflow();</span>
<span class="lineNum">    1889 </span>            :     }
<span class="lineNum">    1890 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    1891 </span>            : 
<a name="1892"><span class="lineNum">    1892 </span>            : #ifdef MOZ_BUNDLED_FONTS</a>
<span class="lineNum">    1893 </span>            : void
<span class="lineNum">    1894 </span><span class="lineCov">          1 : gfxFcPlatformFontList::ActivateBundledFonts()</span>
<span class="lineNum">    1895 </span>            : {
<span class="lineNum">    1896 </span><span class="lineCov">          1 :     if (!mBundledFontsInitialized) {</span>
<span class="lineNum">    1897 </span><span class="lineCov">          1 :         mBundledFontsInitialized = true;</span>
<span class="lineNum">    1898 </span>            :         nsCOMPtr&lt;nsIFile&gt; localDir;
<span class="lineNum">    1899 </span><span class="lineCov">          1 :         nsresult rv = NS_GetSpecialDirectory(NS_GRE_DIR, getter_AddRefs(localDir));</span>
<span class="lineNum">    1900 </span><span class="lineCov">          1 :         if (NS_FAILED(rv)) {</span>
<span class="lineNum">    1901 </span>            :             return;
<span class="lineNum">    1902 </span>            :         }
<span class="lineNum">    1903 </span><span class="lineCov">          1 :         if (NS_FAILED(localDir-&gt;Append(NS_LITERAL_STRING(&quot;fonts&quot;)))) {</span>
<span class="lineNum">    1904 </span>            :             return;
<span class="lineNum">    1905 </span>            :         }
<span class="lineNum">    1906 </span>            :         bool isDir;
<span class="lineNum">    1907 </span><span class="lineCov">          1 :         if (NS_FAILED(localDir-&gt;IsDirectory(&amp;isDir)) || !isDir) {</span>
<span class="lineNum">    1908 </span>            :             return;
<span class="lineNum">    1909 </span>            :         }
<span class="lineNum">    1910 </span><span class="lineCov">          1 :         if (NS_FAILED(localDir-&gt;GetNativePath(mBundledFontsPath))) {</span>
<span class="lineNum">    1911 </span>            :             return;
<span class="lineNum">    1912 </span>            :         }
<span class="lineNum">    1913 </span>            :     }
<span class="lineNum">    1914 </span><span class="lineCov">          1 :     if (!mBundledFontsPath.IsEmpty()) {</span>
<span class="lineNum">    1915 </span><span class="lineCov">          1 :         FcConfigAppFontAddDir(nullptr, ToFcChar8Ptr(mBundledFontsPath.get()));</span>
<span class="lineNum">    1916 </span>            :     }
<span class="lineNum">    1917 </span>            : }
<span class="lineNum">    1918 </span>            : #endif
<span class="lineNum">    1919 </span>            : 
<span class="lineNum">    1920 </span>            : #ifdef MOZ_WIDGET_GTK
<span class="lineNum">    1921 </span>            : /***************************************************************************
<span class="lineNum">    1922 </span>            :  *
<span class="lineNum">    1923 </span>            :  * This function must be last in the file because it uses the system cairo
<span class="lineNum">    1924 </span>            :  * library.  Above this point the cairo library used is the tree cairo if
<span class="lineNum">    1925 </span>            :  * MOZ_TREE_CAIRO.
<span class="lineNum">    1926 </span>            :  */
<span class="lineNum">    1927 </span>            : 
<span class="lineNum">    1928 </span>            : #if MOZ_TREE_CAIRO
<span class="lineNum">    1929 </span>            : // Tree cairo symbols have different names.  Disable their activation through
<span class="lineNum">    1930 </span>            : // preprocessor macros.
<span class="lineNum">    1931 </span>            : #undef cairo_ft_font_options_substitute
<span class="lineNum">    1932 </span>            : 
<span class="lineNum">    1933 </span>            : // The system cairo functions are not declared because the include paths cause
<span class="lineNum">    1934 </span>            : // the gdk headers to pick up the tree cairo.h.
<span class="lineNum">    1935 </span>            : extern &quot;C&quot; {
<span class="lineNum">    1936 </span>            : NS_VISIBILITY_DEFAULT void
<span class="lineNum">    1937 </span>            : cairo_ft_font_options_substitute (const cairo_font_options_t *options,
<span class="lineNum">    1938 </span>            :                                   FcPattern                  *pattern);
<span class="lineNum">    1939 </span>            : }
<span class="lineNum">    1940 </span>            : #endif
<a name="1941"><span class="lineNum">    1941 </span>            : </a>
<span class="lineNum">    1942 </span>            : static void
<span class="lineNum">    1943 </span><span class="lineCov">          1 : ApplyGdkScreenFontOptions(FcPattern *aPattern)</span>
<span class="lineNum">    1944 </span>            : {
<span class="lineNum">    1945 </span>            :     const cairo_font_options_t *options =
<span class="lineNum">    1946 </span><span class="lineCov">          1 :         gdk_screen_get_font_options(gdk_screen_get_default());</span>
<span class="lineNum">    1947 </span>            : 
<span class="lineNum">    1948 </span><span class="lineCov">          1 :     cairo_ft_font_options_substitute(options, aPattern);</span>
<span class="lineNum">    1949 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    1950 </span>            : 
<span class="lineNum">    1951 </span>            : #endif // MOZ_WIDGET_GTK
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
