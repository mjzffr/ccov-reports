<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - netwerk/base/nsIncrementalDownload.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">netwerk/base</a> - nsIncrementalDownload.cpp<span style="font-size: 80%;"> (source / <a href="nsIncrementalDownload.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">190</td>
            <td class="headerCovTableEntry">347</td>
            <td class="headerCovTableEntryLo">54.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21 12:24:28</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">27</td>
            <td class="headerCovTableEntry">41</td>
            <td class="headerCovTableEntryLo">65.9 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* vim:set ts=2 sw=2 sts=2 et cindent: */
<span class="lineNum">       3 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       4 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       5 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            : #include &quot;mozilla/Attributes.h&quot;
<span class="lineNum">       8 </span>            : #include &quot;mozilla/UniquePtrExtensions.h&quot;
<span class="lineNum">       9 </span>            : #include &quot;mozilla/UniquePtr.h&quot;
<span class="lineNum">      10 </span>            : 
<span class="lineNum">      11 </span>            : #include &quot;nsIIncrementalDownload.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;nsIRequestObserver.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;nsIProgressEventSink.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;nsIChannelEventSink.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;nsIAsyncVerifyRedirectCallback.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;nsIInterfaceRequestor.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;nsIObserverService.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;nsIObserver.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;nsIStreamListener.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;nsIFile.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;nsITimer.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;nsIURI.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;nsIInputStream.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;nsNetUtil.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;nsWeakReference.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;prio.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;prprf.h&quot;
<span class="lineNum">      28 </span>            : #include &lt;algorithm&gt;
<span class="lineNum">      29 </span>            : #include &quot;nsIContentPolicy.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;nsContentUtils.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;mozilla/UniquePtr.h&quot;
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : // Default values used to initialize a nsIncrementalDownload object.
<span class="lineNum">      34 </span>            : #define DEFAULT_CHUNK_SIZE (4096 * 16)  // bytes
<span class="lineNum">      35 </span>            : #define DEFAULT_INTERVAL    60          // seconds
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : #define UPDATE_PROGRESS_INTERVAL PRTime(500 * PR_USEC_PER_MSEC) // 500ms
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            : // Number of times to retry a failed byte-range request.
<span class="lineNum">      40 </span>            : #define MAX_RETRY_COUNT 20
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span>            : using namespace mozilla;
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            : //-----------------------------------------------------------------------------
<a name="45"><span class="lineNum">      45 </span>            : </a>
<span class="lineNum">      46 </span>            : static nsresult
<span class="lineNum">      47 </span><span class="lineCov">          1 : WriteToFile(nsIFile *lf, const char *data, uint32_t len, int32_t flags)</span>
<span class="lineNum">      48 </span>            : {
<span class="lineNum">      49 </span>            :   PRFileDesc *fd;
<span class="lineNum">      50 </span><span class="lineCov">          1 :   int32_t mode = 0600;</span>
<span class="lineNum">      51 </span>            :   nsresult rv;
<span class="lineNum">      52 </span>            : #if defined(MOZ_WIDGET_GONK)
<span class="lineNum">      53 </span>            :   // The sdcard on a B2G phone looks like:
<span class="lineNum">      54 </span>            :   // d---rwx--- system   sdcard_rw          1970-01-01 01:00:00 sdcard
<span class="lineNum">      55 </span>            :   // On the emulator, xpcshell fails when using 0600 mode to open the file,
<span class="lineNum">      56 </span>            :   // and 0660 works.
<span class="lineNum">      57 </span>            :   nsCOMPtr&lt;nsIFile&gt; parent;
<span class="lineNum">      58 </span>            :   rv = lf-&gt;GetParent(getter_AddRefs(parent));
<span class="lineNum">      59 </span>            :   if (NS_FAILED(rv)) {
<span class="lineNum">      60 </span>            :     return rv;
<span class="lineNum">      61 </span>            :   }
<span class="lineNum">      62 </span>            :   uint32_t  parentPerm;
<span class="lineNum">      63 </span>            :   rv = parent-&gt;GetPermissions(&amp;parentPerm);
<span class="lineNum">      64 </span>            :   if (NS_FAILED(rv)) {
<span class="lineNum">      65 </span>            :     return rv;
<span class="lineNum">      66 </span>            :   }
<span class="lineNum">      67 </span>            :   if ((parentPerm &amp; 0700) == 0) {
<span class="lineNum">      68 </span>            :     // Parent directory has no owner-write, so try to use group permissions
<span class="lineNum">      69 </span>            :     // instead of owner permissions.
<span class="lineNum">      70 </span>            :     mode = 0660;
<span class="lineNum">      71 </span>            :   }
<span class="lineNum">      72 </span>            : #endif
<span class="lineNum">      73 </span><span class="lineCov">          1 :   rv = lf-&gt;OpenNSPRFileDesc(flags, mode, &amp;fd);</span>
<span class="lineNum">      74 </span><span class="lineCov">          1 :   if (NS_FAILED(rv))</span>
<span class="lineNum">      75 </span>            :     return rv;
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span><span class="lineCov">          1 :   if (len)</span>
<span class="lineNum">      78 </span><span class="lineCov">          1 :     rv = PR_Write(fd, data, len) == int32_t(len) ? NS_OK : NS_ERROR_FAILURE;</span>
<span class="lineNum">      79 </span>            : 
<span class="lineNum">      80 </span><span class="lineCov">          1 :   PR_Close(fd);</span>
<span class="lineNum">      81 </span><span class="lineCov">          1 :   return rv;</span>
<span class="lineNum">      82 </span>            : }
<a name="83"><span class="lineNum">      83 </span>            : </a>
<span class="lineNum">      84 </span>            : static nsresult
<span class="lineNum">      85 </span><span class="lineCov">          1 : AppendToFile(nsIFile *lf, const char *data, uint32_t len)</span>
<span class="lineNum">      86 </span>            : {
<span class="lineNum">      87 </span><span class="lineCov">          1 :   int32_t flags = PR_WRONLY | PR_CREATE_FILE | PR_APPEND;</span>
<span class="lineNum">      88 </span><span class="lineCov">          1 :   return WriteToFile(lf, data, len, flags);</span>
<span class="lineNum">      89 </span>            : }
<span class="lineNum">      90 </span>            : 
<a name="91"><span class="lineNum">      91 </span>            : // maxSize may be -1 if unknown</a>
<span class="lineNum">      92 </span>            : static void
<span class="lineNum">      93 </span><span class="lineNoCov">          0 : MakeRangeSpec(const int64_t &amp;size, const int64_t &amp;maxSize, int32_t chunkSize,</span>
<span class="lineNum">      94 </span>            :               bool fetchRemaining, nsCString &amp;rangeSpec)
<span class="lineNum">      95 </span>            : {
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :   rangeSpec.AssignLiteral(&quot;bytes=&quot;);</span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :   rangeSpec.AppendInt(int64_t(size));</span>
<span class="lineNum">      98 </span><span class="lineNoCov">          0 :   rangeSpec.Append('-');</span>
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :   if (fetchRemaining)</span>
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     102 </span>            : 
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :   int64_t end = size + int64_t(chunkSize);</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :   if (maxSize != int64_t(-1) &amp;&amp; end &gt; maxSize)</span>
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :     end = maxSize;</span>
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :   end -= 1;</span>
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :   rangeSpec.AppendInt(int64_t(end));</span>
<span class="lineNum">     109 </span>            : }
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span>            : //-----------------------------------------------------------------------------
<span class="lineNum">     112 </span>            : 
<span class="lineNum">     113 </span>            : class nsIncrementalDownload final
<span class="lineNum">     114 </span>            :   : public nsIIncrementalDownload
<span class="lineNum">     115 </span>            :   , public nsIStreamListener
<span class="lineNum">     116 </span>            :   , public nsIObserver
<span class="lineNum">     117 </span>            :   , public nsIInterfaceRequestor
<span class="lineNum">     118 </span>            :   , public nsIChannelEventSink
<span class="lineNum">     119 </span>            :   , public nsSupportsWeakReference
<span class="lineNum">     120 </span>            :   , public nsIAsyncVerifyRedirectCallback
<span class="lineNum">     121 </span>            : {
<span class="lineNum">     122 </span>            : public:
<span class="lineNum">     123 </span>            :   NS_DECL_ISUPPORTS
<span class="lineNum">     124 </span>            :   NS_DECL_NSIREQUEST
<span class="lineNum">     125 </span>            :   NS_DECL_NSIINCREMENTALDOWNLOAD
<span class="lineNum">     126 </span>            :   NS_DECL_NSIREQUESTOBSERVER
<span class="lineNum">     127 </span>            :   NS_DECL_NSISTREAMLISTENER
<span class="lineNum">     128 </span>            :   NS_DECL_NSIOBSERVER
<span class="lineNum">     129 </span>            :   NS_DECL_NSIINTERFACEREQUESTOR
<span class="lineNum">     130 </span>            :   NS_DECL_NSICHANNELEVENTSINK
<span class="lineNum">     131 </span>            :   NS_DECL_NSIASYNCVERIFYREDIRECTCALLBACK
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span>            :   nsIncrementalDownload();
<a name="134"><span class="lineNum">     134 </span>            : </a>
<span class="lineNum">     135 </span>            : private:
<span class="lineNum">     136 </span><span class="lineCov">          1 :   ~nsIncrementalDownload() {}</span>
<span class="lineNum">     137 </span>            :   nsresult FlushChunk();
<span class="lineNum">     138 </span>            :   void     UpdateProgress();
<span class="lineNum">     139 </span>            :   nsresult CallOnStartRequest();
<span class="lineNum">     140 </span>            :   void     CallOnStopRequest();
<span class="lineNum">     141 </span>            :   nsresult StartTimer(int32_t interval);
<span class="lineNum">     142 </span>            :   nsresult ProcessTimeout();
<span class="lineNum">     143 </span>            :   nsresult ReadCurrentSize();
<span class="lineNum">     144 </span>            :   nsresult ClearRequestHeader(nsIHttpChannel *channel);
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span>            :   nsCOMPtr&lt;nsIRequestObserver&gt;             mObserver;
<span class="lineNum">     147 </span>            :   nsCOMPtr&lt;nsISupports&gt;                    mObserverContext;
<span class="lineNum">     148 </span>            :   nsCOMPtr&lt;nsIProgressEventSink&gt;           mProgressSink;
<span class="lineNum">     149 </span>            :   nsCOMPtr&lt;nsIURI&gt;                         mURI;
<span class="lineNum">     150 </span>            :   nsCOMPtr&lt;nsIURI&gt;                         mFinalURI;
<span class="lineNum">     151 </span>            :   nsCOMPtr&lt;nsIFile&gt;                        mDest;
<span class="lineNum">     152 </span>            :   nsCOMPtr&lt;nsIChannel&gt;                     mChannel;
<span class="lineNum">     153 </span>            :   nsCOMPtr&lt;nsITimer&gt;                       mTimer;
<span class="lineNum">     154 </span>            :   mozilla::UniquePtr&lt;char[]&gt;               mChunk;
<span class="lineNum">     155 </span>            :   int32_t                                  mChunkLen;
<span class="lineNum">     156 </span>            :   int32_t                                  mChunkSize;
<span class="lineNum">     157 </span>            :   int32_t                                  mInterval;
<span class="lineNum">     158 </span>            :   int64_t                                  mTotalSize;
<span class="lineNum">     159 </span>            :   int64_t                                  mCurrentSize;
<span class="lineNum">     160 </span>            :   uint32_t                                 mLoadFlags;
<span class="lineNum">     161 </span>            :   int32_t                                  mNonPartialCount;
<span class="lineNum">     162 </span>            :   nsresult                                 mStatus;
<span class="lineNum">     163 </span>            :   bool                                     mIsPending;
<span class="lineNum">     164 </span>            :   bool                                     mDidOnStartRequest;
<span class="lineNum">     165 </span>            :   PRTime                                   mLastProgressUpdate;
<span class="lineNum">     166 </span>            :   nsCOMPtr&lt;nsIAsyncVerifyRedirectCallback&gt; mRedirectCallback;
<span class="lineNum">     167 </span>            :   nsCOMPtr&lt;nsIChannel&gt;                     mNewRedirectChannel;
<span class="lineNum">     168 </span>            :   nsCString                                mPartialValidator;
<span class="lineNum">     169 </span>            :   bool                                     mCacheBust;
<a name="170"><span class="lineNum">     170 </span>            : };</a>
<span class="lineNum">     171 </span>            : 
<span class="lineNum">     172 </span><span class="lineCov">          1 : nsIncrementalDownload::nsIncrementalDownload()</span>
<span class="lineNum">     173 </span>            :   : mChunkLen(0)
<span class="lineNum">     174 </span>            :   , mChunkSize(DEFAULT_CHUNK_SIZE)
<span class="lineNum">     175 </span>            :   , mInterval(DEFAULT_INTERVAL)
<span class="lineNum">     176 </span>            :   , mTotalSize(-1)
<span class="lineNum">     177 </span>            :   , mCurrentSize(-1)
<span class="lineNum">     178 </span>            :   , mLoadFlags(LOAD_NORMAL)
<span class="lineNum">     179 </span>            :   , mNonPartialCount(0)
<span class="lineNum">     180 </span>            :   , mStatus(NS_OK)
<span class="lineNum">     181 </span>            :   , mIsPending(false)
<span class="lineNum">     182 </span>            :   , mDidOnStartRequest(false)
<span class="lineNum">     183 </span>            :   , mLastProgressUpdate(0)
<span class="lineNum">     184 </span>            :   , mRedirectCallback(nullptr)
<span class="lineNum">     185 </span>            :   , mNewRedirectChannel(nullptr)
<span class="lineNum">     186 </span><span class="lineCov">          1 :   , mCacheBust(false)  </span>
<span class="lineNum">     187 </span>            : {
<span class="lineNum">     188 </span><span class="lineCov">          1 : }</span>
<a name="189"><span class="lineNum">     189 </span>            : </a>
<span class="lineNum">     190 </span>            : nsresult
<span class="lineNum">     191 </span><span class="lineCov">          1 : nsIncrementalDownload::FlushChunk()</span>
<span class="lineNum">     192 </span>            : {
<span class="lineNum">     193 </span>            :   NS_ASSERTION(mTotalSize != int64_t(-1), &quot;total size should be known&quot;);
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span><span class="lineCov">          1 :   if (mChunkLen == 0)</span>
<span class="lineNum">     196 </span>            :     return NS_OK;
<span class="lineNum">     197 </span>            : 
<span class="lineNum">     198 </span><span class="lineCov">          1 :   nsresult rv = AppendToFile(mDest, mChunk.get(), mChunkLen);</span>
<span class="lineNum">     199 </span><span class="lineCov">          1 :   if (NS_FAILED(rv))</span>
<span class="lineNum">     200 </span>            :     return rv;
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span><span class="lineCov">          1 :   mCurrentSize += int64_t(mChunkLen);</span>
<span class="lineNum">     203 </span><span class="lineCov">          1 :   mChunkLen = 0;</span>
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">     206 </span>            : }
<a name="207"><span class="lineNum">     207 </span>            : </a>
<span class="lineNum">     208 </span>            : void
<span class="lineNum">     209 </span><span class="lineCov">          1 : nsIncrementalDownload::UpdateProgress()</span>
<span class="lineNum">     210 </span>            : {
<span class="lineNum">     211 </span><span class="lineCov">          1 :   mLastProgressUpdate = PR_Now();</span>
<span class="lineNum">     212 </span>            : 
<span class="lineNum">     213 </span><span class="lineCov">          1 :   if (mProgressSink)</span>
<span class="lineNum">     214 </span><span class="lineCov">          1 :     mProgressSink-&gt;OnProgress(this, mObserverContext,</span>
<span class="lineNum">     215 </span>            :                               mCurrentSize + mChunkLen,
<span class="lineNum">     216 </span><span class="lineCov">          1 :                               mTotalSize);</span>
<span class="lineNum">     217 </span><span class="lineCov">          1 : }</span>
<a name="218"><span class="lineNum">     218 </span>            : </a>
<span class="lineNum">     219 </span>            : nsresult
<span class="lineNum">     220 </span><span class="lineCov">          1 : nsIncrementalDownload::CallOnStartRequest()</span>
<span class="lineNum">     221 </span>            : {
<span class="lineNum">     222 </span><span class="lineCov">          1 :   if (!mObserver || mDidOnStartRequest)</span>
<span class="lineNum">     223 </span>            :     return NS_OK;
<span class="lineNum">     224 </span>            : 
<span class="lineNum">     225 </span><span class="lineCov">          1 :   mDidOnStartRequest = true;</span>
<span class="lineNum">     226 </span><span class="lineCov">          1 :   return mObserver-&gt;OnStartRequest(this, mObserverContext);</span>
<span class="lineNum">     227 </span>            : }
<a name="228"><span class="lineNum">     228 </span>            : </a>
<span class="lineNum">     229 </span>            : void
<span class="lineNum">     230 </span><span class="lineCov">          1 : nsIncrementalDownload::CallOnStopRequest()</span>
<span class="lineNum">     231 </span>            : {
<span class="lineNum">     232 </span><span class="lineCov">          1 :   if (!mObserver)</span>
<span class="lineNum">     233 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span>            :   // Ensure that OnStartRequest is always called once before OnStopRequest.
<span class="lineNum">     236 </span><span class="lineCov">          1 :   nsresult rv = CallOnStartRequest();</span>
<span class="lineNum">     237 </span><span class="lineCov">          1 :   if (NS_SUCCEEDED(mStatus))</span>
<span class="lineNum">     238 </span><span class="lineCov">          1 :     mStatus = rv;</span>
<span class="lineNum">     239 </span>            : 
<span class="lineNum">     240 </span><span class="lineCov">          1 :   mIsPending = false;</span>
<span class="lineNum">     241 </span>            : 
<span class="lineNum">     242 </span><span class="lineCov">          1 :   mObserver-&gt;OnStopRequest(this, mObserverContext, mStatus);</span>
<span class="lineNum">     243 </span><span class="lineCov">          1 :   mObserver = nullptr;</span>
<span class="lineNum">     244 </span><span class="lineCov">          1 :   mObserverContext = nullptr;</span>
<span class="lineNum">     245 </span>            : }
<a name="246"><span class="lineNum">     246 </span>            : </a>
<span class="lineNum">     247 </span>            : nsresult
<span class="lineNum">     248 </span><span class="lineCov">          1 : nsIncrementalDownload::StartTimer(int32_t interval)</span>
<span class="lineNum">     249 </span>            : {
<span class="lineNum">     250 </span>            :   nsresult rv;
<span class="lineNum">     251 </span><span class="lineCov">          1 :   mTimer = do_CreateInstance(NS_TIMER_CONTRACTID, &amp;rv);</span>
<span class="lineNum">     252 </span><span class="lineCov">          1 :   if (NS_FAILED(rv))</span>
<span class="lineNum">     253 </span>            :     return rv;
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span><span class="lineCov">          1 :   return mTimer-&gt;Init(this, interval * 1000, nsITimer::TYPE_ONE_SHOT);</span>
<span class="lineNum">     256 </span>            : }
<a name="257"><span class="lineNum">     257 </span>            : </a>
<span class="lineNum">     258 </span>            : nsresult
<span class="lineNum">     259 </span><span class="lineCov">          1 : nsIncrementalDownload::ProcessTimeout()</span>
<span class="lineNum">     260 </span>            : {
<span class="lineNum">     261 </span>            :   NS_ASSERTION(!mChannel, &quot;how can we have a channel?&quot;);
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span>            :   // Handle existing error conditions
<span class="lineNum">     264 </span><span class="lineCov">          1 :   if (NS_FAILED(mStatus)) {</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :     CallOnStopRequest();</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">     267 </span>            :   }
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span>            :   // Fetch next chunk
<span class="lineNum">     270 </span>            :   
<span class="lineNum">     271 </span>            :   nsCOMPtr&lt;nsIChannel&gt; channel;
<span class="lineNum">     272 </span>            :   nsresult rv = NS_NewChannel(getter_AddRefs(channel),
<span class="lineNum">     273 </span>            :                               mFinalURI,
<span class="lineNum">     274 </span>            :                               nsContentUtils::GetSystemPrincipal(),
<span class="lineNum">     275 </span>            :                               nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,
<span class="lineNum">     276 </span>            :                               nsIContentPolicy::TYPE_OTHER,
<span class="lineNum">     277 </span>            :                               nullptr,   // loadGroup
<span class="lineNum">     278 </span>            :                               this,      // aCallbacks
<span class="lineNum">     279 </span><span class="lineCov">          1 :                               mLoadFlags);</span>
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span><span class="lineCov">          1 :   if (NS_FAILED(rv))</span>
<span class="lineNum">     282 </span>            :     return rv;
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span><span class="lineCov">          1 :   nsCOMPtr&lt;nsIHttpChannel&gt; http = do_QueryInterface(channel, &amp;rv);</span>
<span class="lineNum">     285 </span><span class="lineCov">          1 :   if (NS_FAILED(rv))</span>
<span class="lineNum">     286 </span>            :     return rv;
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span>            :   NS_ASSERTION(mCurrentSize != int64_t(-1),
<span class="lineNum">     289 </span>            :       &quot;we should know the current file size by now&quot;);
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span><span class="lineCov">          1 :   rv = ClearRequestHeader(http);</span>
<span class="lineNum">     292 </span><span class="lineCov">          1 :   if (NS_FAILED(rv))</span>
<span class="lineNum">     293 </span>            :     return rv;
<span class="lineNum">     294 </span>            : 
<span class="lineNum">     295 </span>            :   // Don't bother making a range request if we are just going to fetch the
<span class="lineNum">     296 </span>            :   // entire document.
<span class="lineNum">     297 </span><span class="lineCov">          1 :   if (mInterval || mCurrentSize != int64_t(0)) {</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :     nsAutoCString range;</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :     MakeRangeSpec(mCurrentSize, mTotalSize, mChunkSize, mInterval == 0, range);</span>
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :     rv = http-&gt;SetRequestHeader(NS_LITERAL_CSTRING(&quot;Range&quot;), range, false);</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :     if (NS_FAILED(rv))</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :       return rv;</span>
<span class="lineNum">     304 </span>            : 
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :     if (!mPartialValidator.IsEmpty()) {</span>
<span class="lineNum">     306 </span>            :       rv = http-&gt;SetRequestHeader(NS_LITERAL_CSTRING(&quot;If-Range&quot;),
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :                                   mPartialValidator, false);</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :       if (NS_FAILED(rv)) {</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :         LOG((&quot;nsIncrementalDownload::ProcessTimeout\n&quot;</span>
<span class="lineNum">     310 </span>            :              &quot;    failed to set request header: If-Range\n&quot;));
<span class="lineNum">     311 </span>            :       }
<span class="lineNum">     312 </span>            :     }
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :     if (mCacheBust) {</span>
<span class="lineNum">     315 </span>            :       rv = http-&gt;SetRequestHeader(NS_LITERAL_CSTRING(&quot;Cache-Control&quot;),
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :                                   NS_LITERAL_CSTRING(&quot;no-cache&quot;), false);</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :       if (NS_FAILED(rv)) {</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :         LOG((&quot;nsIncrementalDownload::ProcessTimeout\n&quot;</span>
<span class="lineNum">     319 </span>            :              &quot;    failed to set request header: If-Range\n&quot;));
<span class="lineNum">     320 </span>            :       }
<span class="lineNum">     321 </span>            :       rv = http-&gt;SetRequestHeader(NS_LITERAL_CSTRING(&quot;Pragma&quot;),
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :                                   NS_LITERAL_CSTRING(&quot;no-cache&quot;), false);</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :       if (NS_FAILED(rv)) {</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :         LOG((&quot;nsIncrementalDownload::ProcessTimeout\n&quot;</span>
<span class="lineNum">     325 </span>            :              &quot;    failed to set request header: If-Range\n&quot;));
<span class="lineNum">     326 </span>            :       }
<span class="lineNum">     327 </span>            :     }
<span class="lineNum">     328 </span>            :   }
<span class="lineNum">     329 </span>            : 
<span class="lineNum">     330 </span><span class="lineCov">          1 :   rv = channel-&gt;AsyncOpen2(this);</span>
<span class="lineNum">     331 </span><span class="lineCov">          1 :   if (NS_FAILED(rv))</span>
<span class="lineNum">     332 </span>            :     return rv;
<span class="lineNum">     333 </span>            : 
<span class="lineNum">     334 </span>            :   // Wait to assign mChannel when we know we are going to succeed.  This is
<span class="lineNum">     335 </span>            :   // important because we don't want to introduce a reference cycle between
<span class="lineNum">     336 </span>            :   // mChannel and this until we know for a fact that AsyncOpen has succeeded,
<span class="lineNum">     337 </span>            :   // thus ensuring that our stream listener methods will be invoked.
<span class="lineNum">     338 </span><span class="lineCov">          1 :   mChannel = channel;</span>
<span class="lineNum">     339 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">     340 </span>            : }
<span class="lineNum">     341 </span>            : 
<a name="342"><span class="lineNum">     342 </span>            : // Reads the current file size and validates it.</a>
<span class="lineNum">     343 </span>            : nsresult
<span class="lineNum">     344 </span><span class="lineCov">          1 : nsIncrementalDownload::ReadCurrentSize()</span>
<span class="lineNum">     345 </span>            : {
<span class="lineNum">     346 </span>            :   int64_t size;
<span class="lineNum">     347 </span><span class="lineCov">          1 :   nsresult rv = mDest-&gt;GetFileSize((int64_t *) &amp;size);</span>
<span class="lineNum">     348 </span><span class="lineCov">          1 :   if (rv == NS_ERROR_FILE_NOT_FOUND ||</span>
<span class="lineNum">     349 </span><span class="lineCov">          1 :       rv == NS_ERROR_FILE_TARGET_DOES_NOT_EXIST) {</span>
<span class="lineNum">     350 </span><span class="lineCov">          1 :     mCurrentSize = 0;</span>
<span class="lineNum">     351 </span><span class="lineCov">          1 :     return NS_OK;</span>
<span class="lineNum">     352 </span>            :   }
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv))</span>
<span class="lineNum">     354 </span>            :     return rv;
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :   mCurrentSize = size; </span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     358 </span>            : }
<span class="lineNum">     359 </span>            : 
<a name="360"><span class="lineNum">     360 </span>            : // nsISupports</a>
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span><span class="lineCov">          1 : NS_IMPL_ISUPPORTS(nsIncrementalDownload,</span>
<span class="lineNum">     363 </span>            :                   nsIIncrementalDownload,
<span class="lineNum">     364 </span>            :                   nsIRequest,
<span class="lineNum">     365 </span>            :                   nsIStreamListener,
<span class="lineNum">     366 </span>            :                   nsIRequestObserver,
<span class="lineNum">     367 </span>            :                   nsIObserver,
<span class="lineNum">     368 </span>            :                   nsIInterfaceRequestor,
<span class="lineNum">     369 </span>            :                   nsIChannelEventSink,
<span class="lineNum">     370 </span>            :                   nsISupportsWeakReference,
<span class="lineNum">     371 </span>            :                   nsIAsyncVerifyRedirectCallback)
<span class="lineNum">     372 </span>            : 
<span class="lineNum">     373 </span>            : // nsIRequest
<a name="374"><span class="lineNum">     374 </span>            : </a>
<span class="lineNum">     375 </span>            : NS_IMETHODIMP
<span class="lineNum">     376 </span><span class="lineNoCov">          0 : nsIncrementalDownload::GetName(nsACString &amp;name)</span>
<span class="lineNum">     377 </span>            : {
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(mURI, NS_ERROR_NOT_INITIALIZED);</span>
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :   return mURI-&gt;GetSpec(name);</span>
<span class="lineNum">     381 </span>            : }
<a name="382"><span class="lineNum">     382 </span>            : </a>
<span class="lineNum">     383 </span>            : NS_IMETHODIMP
<span class="lineNum">     384 </span><span class="lineNoCov">          0 : nsIncrementalDownload::IsPending(bool *isPending)</span>
<span class="lineNum">     385 </span>            : {
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :   *isPending = mIsPending;</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     388 </span>            : }
<a name="389"><span class="lineNum">     389 </span>            : </a>
<span class="lineNum">     390 </span>            : NS_IMETHODIMP
<span class="lineNum">     391 </span><span class="lineNoCov">          0 : nsIncrementalDownload::GetStatus(nsresult *status)</span>
<span class="lineNum">     392 </span>            : {
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :   *status = mStatus;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     395 </span>            : }
<a name="396"><span class="lineNum">     396 </span>            : </a>
<span class="lineNum">     397 </span>            : NS_IMETHODIMP
<span class="lineNum">     398 </span><span class="lineCov">          1 : nsIncrementalDownload::Cancel(nsresult status)</span>
<span class="lineNum">     399 </span>            : {
<span class="lineNum">     400 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(NS_FAILED(status));</span>
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span>            :   // Ignore this cancelation if we're already canceled.
<span class="lineNum">     403 </span><span class="lineCov">          1 :   if (NS_FAILED(mStatus))</span>
<span class="lineNum">     404 </span>            :     return NS_OK;
<span class="lineNum">     405 </span>            : 
<span class="lineNum">     406 </span><span class="lineCov">          1 :   mStatus = status;</span>
<span class="lineNum">     407 </span>            : 
<span class="lineNum">     408 </span>            :   // Nothing more to do if callbacks aren't pending.
<span class="lineNum">     409 </span><span class="lineCov">          1 :   if (!mIsPending)</span>
<span class="lineNum">     410 </span>            :     return NS_OK;
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span><span class="lineCov">          1 :   if (mChannel) {</span>
<span class="lineNum">     413 </span><span class="lineCov">          1 :     mChannel-&gt;Cancel(mStatus);</span>
<span class="lineNum">     414 </span>            :     NS_ASSERTION(!mTimer, &quot;what is this timer object doing here?&quot;);
<span class="lineNum">     415 </span>            :   }
<span class="lineNum">     416 </span>            :   else {
<span class="lineNum">     417 </span>            :     // dispatch a timer callback event to drive invoking our listener's
<span class="lineNum">     418 </span>            :     // OnStopRequest.
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :     if (mTimer)</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :       mTimer-&gt;Cancel();</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :     StartTimer(0);</span>
<span class="lineNum">     422 </span>            :   }
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span>            :   return NS_OK;
<span class="lineNum">     425 </span>            : }
<a name="426"><span class="lineNum">     426 </span>            : </a>
<span class="lineNum">     427 </span>            : NS_IMETHODIMP
<span class="lineNum">     428 </span><span class="lineNoCov">          0 : nsIncrementalDownload::Suspend()</span>
<span class="lineNum">     429 </span>            : {
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :   return NS_ERROR_NOT_IMPLEMENTED;</span>
<span class="lineNum">     431 </span>            : }
<a name="432"><span class="lineNum">     432 </span>            : </a>
<span class="lineNum">     433 </span>            : NS_IMETHODIMP
<span class="lineNum">     434 </span><span class="lineNoCov">          0 : nsIncrementalDownload::Resume()</span>
<span class="lineNum">     435 </span>            : {
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :   return NS_ERROR_NOT_IMPLEMENTED;</span>
<span class="lineNum">     437 </span>            : }
<a name="438"><span class="lineNum">     438 </span>            : </a>
<span class="lineNum">     439 </span>            : NS_IMETHODIMP
<span class="lineNum">     440 </span><span class="lineNoCov">          0 : nsIncrementalDownload::GetLoadFlags(nsLoadFlags *loadFlags)</span>
<span class="lineNum">     441 </span>            : {
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :   *loadFlags = mLoadFlags;</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     444 </span>            : }
<a name="445"><span class="lineNum">     445 </span>            : </a>
<span class="lineNum">     446 </span>            : NS_IMETHODIMP
<span class="lineNum">     447 </span><span class="lineNoCov">          0 : nsIncrementalDownload::SetLoadFlags(nsLoadFlags loadFlags)</span>
<span class="lineNum">     448 </span>            : {
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :   mLoadFlags = loadFlags;</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     451 </span>            : }
<a name="452"><span class="lineNum">     452 </span>            : </a>
<span class="lineNum">     453 </span>            : NS_IMETHODIMP
<span class="lineNum">     454 </span><span class="lineNoCov">          0 : nsIncrementalDownload::GetLoadGroup(nsILoadGroup **loadGroup)</span>
<span class="lineNum">     455 </span>            : {
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :   return NS_ERROR_NOT_IMPLEMENTED;</span>
<span class="lineNum">     457 </span>            : }
<a name="458"><span class="lineNum">     458 </span>            : </a>
<span class="lineNum">     459 </span>            : NS_IMETHODIMP
<span class="lineNum">     460 </span><span class="lineNoCov">          0 : nsIncrementalDownload::SetLoadGroup(nsILoadGroup *loadGroup)</span>
<span class="lineNum">     461 </span>            : {
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :   return NS_ERROR_NOT_IMPLEMENTED;</span>
<span class="lineNum">     463 </span>            : }
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span>            : // nsIIncrementalDownload
<a name="466"><span class="lineNum">     466 </span>            : </a>
<span class="lineNum">     467 </span>            : NS_IMETHODIMP
<span class="lineNum">     468 </span><span class="lineCov">          1 : nsIncrementalDownload::Init(nsIURI *uri, nsIFile *dest,</span>
<span class="lineNum">     469 </span>            :                             int32_t chunkSize, int32_t interval)
<span class="lineNum">     470 </span>            : {
<span class="lineNum">     471 </span>            :   // Keep it simple: only allow initialization once
<span class="lineNum">     472 </span><span class="lineCov">          1 :   NS_ENSURE_FALSE(mURI, NS_ERROR_ALREADY_INITIALIZED);</span>
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span><span class="lineCov">          1 :   mDest = do_QueryInterface(dest);</span>
<span class="lineNum">     475 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(mDest);</span>
<span class="lineNum">     476 </span>            : 
<span class="lineNum">     477 </span><span class="lineCov">          1 :   mURI = uri;</span>
<span class="lineNum">     478 </span><span class="lineCov">          1 :   mFinalURI = uri;</span>
<span class="lineNum">     479 </span>            : 
<span class="lineNum">     480 </span><span class="lineCov">          1 :   if (chunkSize &gt; 0)</span>
<span class="lineNum">     481 </span><span class="lineCov">          1 :     mChunkSize = chunkSize;</span>
<span class="lineNum">     482 </span><span class="lineCov">          1 :   if (interval &gt;= 0)</span>
<span class="lineNum">     483 </span><span class="lineCov">          1 :     mInterval = interval;</span>
<span class="lineNum">     484 </span>            :   return NS_OK;
<span class="lineNum">     485 </span>            : }
<a name="486"><span class="lineNum">     486 </span>            : </a>
<span class="lineNum">     487 </span>            : NS_IMETHODIMP
<span class="lineNum">     488 </span><span class="lineCov">          1 : nsIncrementalDownload::GetURI(nsIURI **result)</span>
<span class="lineNum">     489 </span>            : {
<span class="lineNum">     490 </span><span class="lineCov">          1 :   NS_IF_ADDREF(*result = mURI);</span>
<span class="lineNum">     491 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">     492 </span>            : }
<a name="493"><span class="lineNum">     493 </span>            : </a>
<span class="lineNum">     494 </span>            : NS_IMETHODIMP
<span class="lineNum">     495 </span><span class="lineCov">          1 : nsIncrementalDownload::GetFinalURI(nsIURI **result)</span>
<span class="lineNum">     496 </span>            : {
<span class="lineNum">     497 </span><span class="lineCov">          1 :   NS_IF_ADDREF(*result = mFinalURI);</span>
<span class="lineNum">     498 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">     499 </span>            : }
<a name="500"><span class="lineNum">     500 </span>            : </a>
<span class="lineNum">     501 </span>            : NS_IMETHODIMP
<span class="lineNum">     502 </span><span class="lineCov">          1 : nsIncrementalDownload::GetDestination(nsIFile **result)</span>
<span class="lineNum">     503 </span>            : {
<span class="lineNum">     504 </span><span class="lineCov">          1 :   if (!mDest) {</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :     *result = nullptr;</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">     507 </span>            :   }
<span class="lineNum">     508 </span>            :   // Return a clone of mDest so that callers may modify the resulting nsIFile
<span class="lineNum">     509 </span>            :   // without corrupting our internal object.  This also works around the fact
<span class="lineNum">     510 </span>            :   // that some nsIFile impls may cache the result of stat'ing the filesystem.
<span class="lineNum">     511 </span><span class="lineCov">          1 :   return mDest-&gt;Clone(result);</span>
<span class="lineNum">     512 </span>            : }
<a name="513"><span class="lineNum">     513 </span>            : </a>
<span class="lineNum">     514 </span>            : NS_IMETHODIMP
<span class="lineNum">     515 </span><span class="lineNoCov">          0 : nsIncrementalDownload::GetTotalSize(int64_t *result)</span>
<span class="lineNum">     516 </span>            : {
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :   *result = mTotalSize;</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     519 </span>            : }
<a name="520"><span class="lineNum">     520 </span>            : </a>
<span class="lineNum">     521 </span>            : NS_IMETHODIMP
<span class="lineNum">     522 </span><span class="lineNoCov">          0 : nsIncrementalDownload::GetCurrentSize(int64_t *result)</span>
<span class="lineNum">     523 </span>            : {
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :   *result = mCurrentSize;</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     526 </span>            : }
<a name="527"><span class="lineNum">     527 </span>            : </a>
<span class="lineNum">     528 </span>            : NS_IMETHODIMP
<span class="lineNum">     529 </span><span class="lineCov">          1 : nsIncrementalDownload::Start(nsIRequestObserver *observer,</span>
<span class="lineNum">     530 </span>            :                              nsISupports *context)
<span class="lineNum">     531 </span>            : {
<span class="lineNum">     532 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(observer);</span>
<span class="lineNum">     533 </span><span class="lineCov">          1 :   NS_ENSURE_FALSE(mIsPending, NS_ERROR_IN_PROGRESS);</span>
<span class="lineNum">     534 </span>            : 
<span class="lineNum">     535 </span>            :   // Observe system shutdown so we can be sure to release any reference held
<span class="lineNum">     536 </span>            :   // between ourselves and the timer.  We have the observer service hold a weak
<span class="lineNum">     537 </span>            :   // reference to us, so that we don't have to worry about calling
<span class="lineNum">     538 </span>            :   // RemoveObserver.  XXX(darin): The timer code should do this for us.
<span class="lineNum">     539 </span><span class="lineCov">          1 :   nsCOMPtr&lt;nsIObserverService&gt; obs = mozilla::services::GetObserverService();</span>
<span class="lineNum">     540 </span><span class="lineCov">          1 :   if (obs)</span>
<span class="lineNum">     541 </span><span class="lineCov">          1 :     obs-&gt;AddObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID, true);</span>
<span class="lineNum">     542 </span>            : 
<span class="lineNum">     543 </span><span class="lineCov">          1 :   nsresult rv = ReadCurrentSize();</span>
<span class="lineNum">     544 </span><span class="lineCov">          1 :   if (NS_FAILED(rv))</span>
<span class="lineNum">     545 </span>            :     return rv;
<span class="lineNum">     546 </span>            : 
<span class="lineNum">     547 </span><span class="lineCov">          1 :   rv = StartTimer(0);</span>
<span class="lineNum">     548 </span><span class="lineCov">          1 :   if (NS_FAILED(rv))</span>
<span class="lineNum">     549 </span>            :     return rv;
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span><span class="lineCov">          1 :   mObserver = observer;</span>
<span class="lineNum">     552 </span><span class="lineCov">          1 :   mObserverContext = context;</span>
<span class="lineNum">     553 </span><span class="lineCov">          1 :   mProgressSink = do_QueryInterface(observer);  // ok if null</span>
<span class="lineNum">     554 </span>            : 
<span class="lineNum">     555 </span><span class="lineCov">          1 :   mIsPending = true;</span>
<span class="lineNum">     556 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">     557 </span>            : }
<span class="lineNum">     558 </span>            : 
<span class="lineNum">     559 </span>            : // nsIRequestObserver
<a name="560"><span class="lineNum">     560 </span>            : </a>
<span class="lineNum">     561 </span>            : NS_IMETHODIMP
<span class="lineNum">     562 </span><span class="lineCov">          1 : nsIncrementalDownload::OnStartRequest(nsIRequest *request,</span>
<span class="lineNum">     563 </span>            :                                       nsISupports *context)
<span class="lineNum">     564 </span>            : {
<span class="lineNum">     565 </span>            :   nsresult rv;
<span class="lineNum">     566 </span>            : 
<span class="lineNum">     567 </span><span class="lineCov">          1 :   nsCOMPtr&lt;nsIHttpChannel&gt; http = do_QueryInterface(request, &amp;rv);</span>
<span class="lineNum">     568 </span><span class="lineCov">          1 :   if (NS_FAILED(rv))</span>
<span class="lineNum">     569 </span>            :     return rv;
<span class="lineNum">     570 </span>            : 
<span class="lineNum">     571 </span>            :   // Ensure that we are receiving a 206 response.
<span class="lineNum">     572 </span>            :   uint32_t code;
<span class="lineNum">     573 </span><span class="lineCov">          1 :   rv = http-&gt;GetResponseStatus(&amp;code);</span>
<span class="lineNum">     574 </span><span class="lineCov">          1 :   if (NS_FAILED(rv))</span>
<span class="lineNum">     575 </span>            :     return rv;
<span class="lineNum">     576 </span><span class="lineCov">          1 :   if (code != 206) {</span>
<span class="lineNum">     577 </span>            :     // We may already have the entire file downloaded, in which case
<span class="lineNum">     578 </span>            :     // our request for a range beyond the end of the file would have
<span class="lineNum">     579 </span>            :     // been met with an error response code.
<span class="lineNum">     580 </span><span class="lineCov">          1 :     if (code == 416 &amp;&amp; mTotalSize == int64_t(-1)) {</span>
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :       mTotalSize = mCurrentSize;</span>
<span class="lineNum">     582 </span>            :       // Return an error code here to suppress OnDataAvailable.
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :       return NS_ERROR_DOWNLOAD_COMPLETE;</span>
<span class="lineNum">     584 </span>            :     }
<span class="lineNum">     585 </span>            :     // The server may have decided to give us all of the data in one chunk.  If
<span class="lineNum">     586 </span>            :     // we requested a partial range, then we don't want to download all of the
<span class="lineNum">     587 </span>            :     // data at once.  So, we'll just try again, but if this keeps happening then
<span class="lineNum">     588 </span>            :     // we'll eventually give up.
<span class="lineNum">     589 </span><span class="lineCov">          1 :     if (code == 200) {</span>
<span class="lineNum">     590 </span><span class="lineCov">          1 :       if (mInterval) {</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :         mChannel = nullptr;</span>
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :         if (++mNonPartialCount &gt; MAX_RETRY_COUNT) {</span>
<span class="lineNum">     593 </span>            :           NS_WARNING(&quot;unable to fetch a byte range; giving up&quot;);
<span class="lineNum">     594 </span>            :           return NS_ERROR_FAILURE;
<span class="lineNum">     595 </span>            :         }
<span class="lineNum">     596 </span>            :         // Increase delay with each failure.
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :         StartTimer(mInterval * mNonPartialCount);</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :         return NS_ERROR_DOWNLOAD_NOT_PARTIAL;</span>
<span class="lineNum">     599 </span>            :       }
<span class="lineNum">     600 </span>            :       // Since we have been asked to download the rest of the file, we can deal
<span class="lineNum">     601 </span>            :       // with a 200 response.  This may result in downloading the beginning of
<span class="lineNum">     602 </span>            :       // the file again, but that can't really be helped.
<span class="lineNum">     603 </span>            :     } else {
<span class="lineNum">     604 </span>            :       NS_WARNING(&quot;server response was unexpected&quot;);
<span class="lineNum">     605 </span>            :       return NS_ERROR_UNEXPECTED;
<span class="lineNum">     606 </span>            :     }
<span class="lineNum">     607 </span>            :   } else {
<span class="lineNum">     608 </span>            :     // We got a partial response, so clear this counter in case the next chunk
<span class="lineNum">     609 </span>            :     // results in a 200 response.
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :     mNonPartialCount = 0;</span>
<span class="lineNum">     611 </span>            : 
<span class="lineNum">     612 </span>            :     // confirm that the content-range response header is consistent with
<span class="lineNum">     613 </span>            :     // expectations on each 206. If it is not then drop this response and
<span class="lineNum">     614 </span>            :     // retry with no-cache set.
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :     if (!mCacheBust) {</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :       nsAutoCString buf;</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :       int64_t startByte = 0;</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :       bool confirmedOK = false;</span>
<span class="lineNum">     619 </span>            : 
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :       rv = http-&gt;GetResponseHeader(NS_LITERAL_CSTRING(&quot;Content-Range&quot;), buf);</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :       if (NS_FAILED(rv))</span>
<span class="lineNum">     622 </span>            :         return rv; // it isn't a useful 206 without a CONTENT-RANGE of some sort
<span class="lineNum">     623 </span>            : 
<span class="lineNum">     624 </span>            :       // Content-Range: bytes 0-299999/25604694
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :       int32_t p = buf.Find(&quot;bytes &quot;);</span>
<span class="lineNum">     626 </span>            : 
<span class="lineNum">     627 </span>            :       // first look for the starting point of the content-range
<span class="lineNum">     628 </span>            :       // to make sure it is what we expect
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :       if (p != -1) {</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :         char *endptr = nullptr;</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :         const char *s = buf.get() + p + 6;</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :         while (*s &amp;&amp; *s == ' ')</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :           s++;</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :         startByte = strtol(s, &amp;endptr, 10);</span>
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :         if (*s &amp;&amp; endptr &amp;&amp; (endptr != s) &amp;&amp;</span>
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :             (mCurrentSize == startByte)) {</span>
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span>            :           // ok the starting point is confirmed. We still need to check the
<span class="lineNum">     640 </span>            :           // total size of the range for consistency if this isn't
<span class="lineNum">     641 </span>            :           // the first chunk
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :           if (mTotalSize == int64_t(-1)) {</span>
<span class="lineNum">     643 </span>            :             // first chunk
<span class="lineNum">     644 </span>            :             confirmedOK = true;
<span class="lineNum">     645 </span>            :           } else {
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :             int32_t slash = buf.FindChar('/');</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :             int64_t rangeSize = 0;</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :             if (slash != kNotFound &amp;&amp;</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :                 (PR_sscanf(buf.get() + slash + 1, &quot;%lld&quot;, (int64_t *) &amp;rangeSize) == 1) &amp;&amp;</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :                 rangeSize == mTotalSize) {</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :               confirmedOK = true;</span>
<span class="lineNum">     652 </span>            :             }
<span class="lineNum">     653 </span>            :           }
<span class="lineNum">     654 </span>            :         }
<span class="lineNum">     655 </span>            :       }
<span class="lineNum">     656 </span>            : 
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :       if (!confirmedOK) {</span>
<span class="lineNum">     658 </span>            :         NS_WARNING(&quot;unexpected content-range&quot;);
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :         mCacheBust = true;</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :         mChannel = nullptr;</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :         if (++mNonPartialCount &gt; MAX_RETRY_COUNT) {</span>
<span class="lineNum">     662 </span>            :           NS_WARNING(&quot;unable to fetch a byte range; giving up&quot;);
<span class="lineNum">     663 </span>            :           return NS_ERROR_FAILURE;
<span class="lineNum">     664 </span>            :         }
<span class="lineNum">     665 </span>            :         // Increase delay with each failure.
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :         StartTimer(mInterval * mNonPartialCount);</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :         return NS_ERROR_DOWNLOAD_NOT_PARTIAL;</span>
<span class="lineNum">     668 </span>            :       }
<span class="lineNum">     669 </span>            :     }
<span class="lineNum">     670 </span>            :   }
<span class="lineNum">     671 </span>            : 
<span class="lineNum">     672 </span>            :   // Do special processing after the first response.
<span class="lineNum">     673 </span><span class="lineCov">          1 :   if (mTotalSize == int64_t(-1)) {</span>
<span class="lineNum">     674 </span>            :     // Update knowledge of mFinalURI
<span class="lineNum">     675 </span><span class="lineCov">          1 :     rv = http-&gt;GetURI(getter_AddRefs(mFinalURI));</span>
<span class="lineNum">     676 </span><span class="lineCov">          1 :     if (NS_FAILED(rv))</span>
<span class="lineNum">     677 </span>            :       return rv;
<span class="lineNum">     678 </span><span class="lineCov">          1 :     Unused &lt;&lt; http-&gt;GetResponseHeader(NS_LITERAL_CSTRING(&quot;Etag&quot;), mPartialValidator);</span>
<span class="lineNum">     679 </span><span class="lineCov">          1 :     if (StringBeginsWith(mPartialValidator, NS_LITERAL_CSTRING(&quot;W/&quot;)))</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :       mPartialValidator.Truncate(); // don't use weak validators</span>
<span class="lineNum">     681 </span><span class="lineCov">          1 :     if (mPartialValidator.IsEmpty()) {</span>
<span class="lineNum">     682 </span><span class="lineCov">          1 :       rv = http-&gt;GetResponseHeader(NS_LITERAL_CSTRING(&quot;Last-Modified&quot;), mPartialValidator);</span>
<span class="lineNum">     683 </span><span class="lineCov">          1 :       if (NS_FAILED(rv)) {</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :         LOG((&quot;nsIncrementalDownload::OnStartRequest\n&quot;</span>
<span class="lineNum">     685 </span>            :              &quot;    empty validator\n&quot;));
<span class="lineNum">     686 </span>            :       }
<span class="lineNum">     687 </span>            :     }
<span class="lineNum">     688 </span>            : 
<span class="lineNum">     689 </span><span class="lineCov">          1 :     if (code == 206) {</span>
<span class="lineNum">     690 </span>            :       // OK, read the Content-Range header to determine the total size of this
<span class="lineNum">     691 </span>            :       // download file.
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :       nsAutoCString buf;</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :       rv = http-&gt;GetResponseHeader(NS_LITERAL_CSTRING(&quot;Content-Range&quot;), buf);</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :       if (NS_FAILED(rv))</span>
<span class="lineNum">     695 </span>            :         return rv;
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :       int32_t slash = buf.FindChar('/');</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :       if (slash == kNotFound) {</span>
<span class="lineNum">     698 </span>            :         NS_WARNING(&quot;server returned invalid Content-Range header!&quot;);
<span class="lineNum">     699 </span>            :         return NS_ERROR_UNEXPECTED;
<span class="lineNum">     700 </span>            :       }
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :       if (PR_sscanf(buf.get() + slash + 1, &quot;%lld&quot;, (int64_t *) &amp;mTotalSize) != 1)</span>
<span class="lineNum">     702 </span>            :         return NS_ERROR_UNEXPECTED;
<span class="lineNum">     703 </span>            :     } else {
<span class="lineNum">     704 </span><span class="lineCov">          1 :       rv = http-&gt;GetContentLength(&amp;mTotalSize);</span>
<span class="lineNum">     705 </span><span class="lineCov">          1 :       if (NS_FAILED(rv))</span>
<span class="lineNum">     706 </span>            :         return rv;
<span class="lineNum">     707 </span>            :       // We need to know the total size of the thing we're trying to download.
<span class="lineNum">     708 </span><span class="lineCov">          1 :       if (mTotalSize == int64_t(-1)) {</span>
<span class="lineNum">     709 </span>            :         NS_WARNING(&quot;server returned no content-length header!&quot;);
<span class="lineNum">     710 </span>            :         return NS_ERROR_UNEXPECTED;
<span class="lineNum">     711 </span>            :       }
<span class="lineNum">     712 </span>            :       // Need to truncate (or create, if it doesn't exist) the file since we
<span class="lineNum">     713 </span>            :       // are downloading the whole thing.
<span class="lineNum">     714 </span><span class="lineCov">          1 :       WriteToFile(mDest, nullptr, 0, PR_WRONLY | PR_CREATE_FILE | PR_TRUNCATE);</span>
<span class="lineNum">     715 </span><span class="lineCov">          1 :       mCurrentSize = 0;</span>
<span class="lineNum">     716 </span>            :     }
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span>            :     // Notify observer that we are starting...
<span class="lineNum">     719 </span><span class="lineCov">          1 :     rv = CallOnStartRequest();</span>
<span class="lineNum">     720 </span><span class="lineCov">          1 :     if (NS_FAILED(rv))</span>
<span class="lineNum">     721 </span>            :       return rv;
<span class="lineNum">     722 </span>            :   }
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span>            :   // Adjust mChunkSize accordingly if mCurrentSize is close to mTotalSize.
<span class="lineNum">     725 </span><span class="lineCov">          1 :   int64_t diff = mTotalSize - mCurrentSize;</span>
<span class="lineNum">     726 </span><span class="lineCov">          1 :   if (diff &lt;= int64_t(0)) {</span>
<span class="lineNum">     727 </span>            :     NS_WARNING(&quot;about to set a bogus chunk size; giving up&quot;);
<span class="lineNum">     728 </span>            :     return NS_ERROR_UNEXPECTED;
<span class="lineNum">     729 </span>            :   }
<span class="lineNum">     730 </span>            : 
<span class="lineNum">     731 </span><span class="lineCov">          1 :   if (diff &lt; int64_t(mChunkSize))</span>
<span class="lineNum">     732 </span><span class="lineCov">          1 :     mChunkSize = uint32_t(diff);</span>
<span class="lineNum">     733 </span>            : 
<span class="lineNum">     734 </span><span class="lineCov">          1 :   mChunk = mozilla::MakeUniqueFallible&lt;char[]&gt;(mChunkSize);</span>
<span class="lineNum">     735 </span><span class="lineCov">          1 :   if (!mChunk)</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :     rv = NS_ERROR_OUT_OF_MEMORY;</span>
<span class="lineNum">     737 </span>            : 
<span class="lineNum">     738 </span><span class="lineCov">          1 :   return rv;</span>
<span class="lineNum">     739 </span>            : }
<a name="740"><span class="lineNum">     740 </span>            : </a>
<span class="lineNum">     741 </span>            : NS_IMETHODIMP
<span class="lineNum">     742 </span><span class="lineCov">          1 : nsIncrementalDownload::OnStopRequest(nsIRequest *request,</span>
<span class="lineNum">     743 </span>            :                                      nsISupports *context,
<span class="lineNum">     744 </span>            :                                      nsresult status)
<span class="lineNum">     745 </span>            : {
<span class="lineNum">     746 </span>            :   // Not a real error; just a trick to kill off the channel without our
<span class="lineNum">     747 </span>            :   // listener having to care.
<span class="lineNum">     748 </span><span class="lineCov">          1 :   if (status == NS_ERROR_DOWNLOAD_NOT_PARTIAL)</span>
<span class="lineNum">     749 </span>            :     return NS_OK;
<span class="lineNum">     750 </span>            : 
<span class="lineNum">     751 </span>            :   // Not a real error; just a trick used to suppress OnDataAvailable calls.
<span class="lineNum">     752 </span><span class="lineCov">          1 :   if (status == NS_ERROR_DOWNLOAD_COMPLETE)</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :     status = NS_OK;</span>
<span class="lineNum">     754 </span>            : 
<span class="lineNum">     755 </span><span class="lineCov">          1 :   if (NS_SUCCEEDED(mStatus))</span>
<span class="lineNum">     756 </span><span class="lineCov">          1 :     mStatus = status;</span>
<span class="lineNum">     757 </span>            : 
<span class="lineNum">     758 </span><span class="lineCov">          1 :   if (mChunk) {</span>
<span class="lineNum">     759 </span><span class="lineCov">          1 :     if (NS_SUCCEEDED(mStatus))</span>
<span class="lineNum">     760 </span><span class="lineCov">          1 :       mStatus = FlushChunk();</span>
<span class="lineNum">     761 </span>            : 
<span class="lineNum">     762 </span><span class="lineCov">          1 :     mChunk = nullptr;  // deletes memory</span>
<span class="lineNum">     763 </span><span class="lineCov">          1 :     mChunkLen = 0;</span>
<span class="lineNum">     764 </span><span class="lineCov">          1 :     UpdateProgress();</span>
<span class="lineNum">     765 </span>            :   }
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span><span class="lineCov">          1 :   mChannel = nullptr;</span>
<span class="lineNum">     768 </span>            : 
<span class="lineNum">     769 </span>            :   // Notify listener if we hit an error or finished
<span class="lineNum">     770 </span><span class="lineCov">          1 :   if (NS_FAILED(mStatus) || mCurrentSize == mTotalSize) {</span>
<span class="lineNum">     771 </span><span class="lineCov">          1 :     CallOnStopRequest();</span>
<span class="lineNum">     772 </span><span class="lineCov">          1 :     return NS_OK;</span>
<span class="lineNum">     773 </span>            :   }
<span class="lineNum">     774 </span>            : 
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :   return StartTimer(mInterval);  // Do next chunk</span>
<span class="lineNum">     776 </span>            : }
<span class="lineNum">     777 </span>            : 
<span class="lineNum">     778 </span>            : // nsIStreamListener
<a name="779"><span class="lineNum">     779 </span>            : </a>
<span class="lineNum">     780 </span>            : NS_IMETHODIMP
<span class="lineNum">     781 </span><span class="lineCov">          1 : nsIncrementalDownload::OnDataAvailable(nsIRequest *request,</span>
<span class="lineNum">     782 </span>            :                                        nsISupports *context,
<span class="lineNum">     783 </span>            :                                        nsIInputStream *input,
<span class="lineNum">     784 </span>            :                                        uint64_t offset,
<span class="lineNum">     785 </span>            :                                        uint32_t count)
<span class="lineNum">     786 </span>            : {
<span class="lineNum">     787 </span><span class="lineCov">          1 :   while (count) {</span>
<span class="lineNum">     788 </span><span class="lineCov">          1 :     uint32_t space = mChunkSize - mChunkLen;</span>
<span class="lineNum">     789 </span><span class="lineCov">          1 :     uint32_t n, len = std::min(space, count);</span>
<span class="lineNum">     790 </span>            : 
<span class="lineNum">     791 </span><span class="lineCov">          1 :     nsresult rv = input-&gt;Read(&amp;mChunk[mChunkLen], len, &amp;n);</span>
<span class="lineNum">     792 </span><span class="lineCov">          1 :     if (NS_FAILED(rv))</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :       return rv;</span>
<span class="lineNum">     794 </span><span class="lineCov">          1 :     if (n != len)</span>
<span class="lineNum">     795 </span>            :       return NS_ERROR_UNEXPECTED;
<span class="lineNum">     796 </span>            : 
<span class="lineNum">     797 </span><span class="lineCov">          1 :     count -= n;</span>
<span class="lineNum">     798 </span><span class="lineCov">          1 :     mChunkLen += n;</span>
<span class="lineNum">     799 </span>            : 
<span class="lineNum">     800 </span><span class="lineCov">          1 :     if (mChunkLen == mChunkSize) {</span>
<span class="lineNum">     801 </span><span class="lineCov">          1 :       rv = FlushChunk();</span>
<span class="lineNum">     802 </span><span class="lineCov">          1 :       if (NS_FAILED(rv))</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :         return rv;</span>
<span class="lineNum">     804 </span>            :     }
<span class="lineNum">     805 </span>            :   }
<span class="lineNum">     806 </span>            : 
<span class="lineNum">     807 </span><span class="lineCov">          1 :   if (PR_Now() &gt; mLastProgressUpdate + UPDATE_PROGRESS_INTERVAL)</span>
<span class="lineNum">     808 </span><span class="lineCov">          1 :     UpdateProgress();</span>
<span class="lineNum">     809 </span>            : 
<span class="lineNum">     810 </span>            :   return NS_OK;
<span class="lineNum">     811 </span>            : }
<span class="lineNum">     812 </span>            : 
<span class="lineNum">     813 </span>            : // nsIObserver
<a name="814"><span class="lineNum">     814 </span>            : </a>
<span class="lineNum">     815 </span>            : NS_IMETHODIMP
<span class="lineNum">     816 </span><span class="lineCov">          1 : nsIncrementalDownload::Observe(nsISupports *subject, const char *topic,</span>
<span class="lineNum">     817 </span>            :                                const char16_t *data)
<span class="lineNum">     818 </span>            : {
<span class="lineNum">     819 </span><span class="lineCov">          1 :   if (strcmp(topic, NS_XPCOM_SHUTDOWN_OBSERVER_ID) == 0) {</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :     Cancel(NS_ERROR_ABORT);</span>
<span class="lineNum">     821 </span>            : 
<span class="lineNum">     822 </span>            :     // Since the app is shutting down, we need to go ahead and notify our
<span class="lineNum">     823 </span>            :     // observer here.  Otherwise, we would notify them after XPCOM has been
<span class="lineNum">     824 </span>            :     // shutdown or not at all.
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :     CallOnStopRequest();</span>
<span class="lineNum">     826 </span>            :   }
<span class="lineNum">     827 </span><span class="lineCov">          1 :   else if (strcmp(topic, NS_TIMER_CALLBACK_TOPIC) == 0) {</span>
<span class="lineNum">     828 </span><span class="lineCov">          1 :     mTimer = nullptr;</span>
<span class="lineNum">     829 </span><span class="lineCov">          1 :     nsresult rv = ProcessTimeout();</span>
<span class="lineNum">     830 </span><span class="lineCov">          1 :     if (NS_FAILED(rv))</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :       Cancel(rv);</span>
<span class="lineNum">     832 </span>            :   }
<span class="lineNum">     833 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">     834 </span>            : }
<span class="lineNum">     835 </span>            : 
<span class="lineNum">     836 </span>            : // nsIInterfaceRequestor
<a name="837"><span class="lineNum">     837 </span>            : </a>
<span class="lineNum">     838 </span>            : NS_IMETHODIMP
<span class="lineNum">     839 </span><span class="lineCov">          1 : nsIncrementalDownload::GetInterface(const nsIID &amp;iid, void **result)</span>
<span class="lineNum">     840 </span>            : {
<span class="lineNum">     841 </span><span class="lineCov">          1 :   if (iid.Equals(NS_GET_IID(nsIChannelEventSink))) {</span>
<span class="lineNum">     842 </span>            :     NS_ADDREF_THIS();
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :     *result = static_cast&lt;nsIChannelEventSink *&gt;(this);</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">     845 </span>            :   }
<span class="lineNum">     846 </span>            : 
<span class="lineNum">     847 </span><span class="lineCov">          1 :   nsCOMPtr&lt;nsIInterfaceRequestor&gt; ir = do_QueryInterface(mObserver);</span>
<span class="lineNum">     848 </span><span class="lineCov">          1 :   if (ir)</span>
<span class="lineNum">     849 </span><span class="lineCov">          1 :     return ir-&gt;GetInterface(iid, result);</span>
<span class="lineNum">     850 </span>            : 
<span class="lineNum">     851 </span>            :   return NS_ERROR_NO_INTERFACE;
<span class="lineNum">     852 </span>            : }
<a name="853"><span class="lineNum">     853 </span>            : </a>
<span class="lineNum">     854 </span>            : nsresult 
<span class="lineNum">     855 </span><span class="lineCov">          1 : nsIncrementalDownload::ClearRequestHeader(nsIHttpChannel *channel)</span>
<span class="lineNum">     856 </span>            : {
<span class="lineNum">     857 </span><span class="lineCov">          1 :   NS_ENSURE_ARG(channel);</span>
<span class="lineNum">     858 </span>            :   
<span class="lineNum">     859 </span>            :   // We don't support encodings -- they make the Content-Length not equal
<span class="lineNum">     860 </span>            :   // to the actual size of the data. 
<span class="lineNum">     861 </span>            :   return channel-&gt;SetRequestHeader(NS_LITERAL_CSTRING(&quot;Accept-Encoding&quot;),
<span class="lineNum">     862 </span><span class="lineCov">          1 :                                    NS_LITERAL_CSTRING(&quot;&quot;), false);</span>
<span class="lineNum">     863 </span>            : }
<span class="lineNum">     864 </span>            : 
<span class="lineNum">     865 </span>            : // nsIChannelEventSink
<a name="866"><span class="lineNum">     866 </span>            : </a>
<span class="lineNum">     867 </span>            : NS_IMETHODIMP
<span class="lineNum">     868 </span><span class="lineNoCov">          0 : nsIncrementalDownload::AsyncOnChannelRedirect(nsIChannel *oldChannel,</span>
<span class="lineNum">     869 </span>            :                                               nsIChannel *newChannel,
<span class="lineNum">     870 </span>            :                                               uint32_t flags,
<span class="lineNum">     871 </span>            :                                               nsIAsyncVerifyRedirectCallback *cb)
<span class="lineNum">     872 </span>            : {
<span class="lineNum">     873 </span>            :   // In response to a redirect, we need to propagate the Range header.  See bug
<span class="lineNum">     874 </span>            :   // 311595.  Any failure code returned from this function aborts the redirect.
<span class="lineNum">     875 </span>            :  
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIHttpChannel&gt; http = do_QueryInterface(oldChannel);</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :   NS_ENSURE_STATE(http);</span>
<span class="lineNum">     878 </span>            : 
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIHttpChannel&gt; newHttpChannel = do_QueryInterface(newChannel);</span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :   NS_ENSURE_STATE(newHttpChannel);</span>
<span class="lineNum">     881 </span>            : 
<span class="lineNum">     882 </span>            :   NS_NAMED_LITERAL_CSTRING(rangeHdr, &quot;Range&quot;);
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :   nsresult rv = ClearRequestHeader(newHttpChannel);</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv))</span>
<span class="lineNum">     886 </span>            :     return rv;
<span class="lineNum">     887 </span>            : 
<span class="lineNum">     888 </span>            :   // If we didn't have a Range header, then we must be doing a full download.
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :   nsAutoCString rangeVal;</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :   Unused &lt;&lt; http-&gt;GetRequestHeader(rangeHdr, rangeVal);</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :   if (!rangeVal.IsEmpty()) {</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :     rv = newHttpChannel-&gt;SetRequestHeader(rangeHdr, rangeVal, false);</span>
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     894 </span>            :   }
<span class="lineNum">     895 </span>            : 
<span class="lineNum">     896 </span>            :   // A redirection changes the validator
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :   mPartialValidator.Truncate();</span>
<span class="lineNum">     898 </span>            : 
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :   if (mCacheBust) {</span>
<span class="lineNum">     900 </span>            :     rv = newHttpChannel-&gt;SetRequestHeader(NS_LITERAL_CSTRING(&quot;Cache-Control&quot;),
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :                                           NS_LITERAL_CSTRING(&quot;no-cache&quot;), false);</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :     if (NS_FAILED(rv)) {</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :       LOG((&quot;nsIncrementalDownload::AsyncOnChannelRedirect\n&quot;</span>
<span class="lineNum">     904 </span>            :            &quot;    failed to set request header: Cache-Control\n&quot;));
<span class="lineNum">     905 </span>            :     }
<span class="lineNum">     906 </span>            :     rv = newHttpChannel-&gt;SetRequestHeader(NS_LITERAL_CSTRING(&quot;Pragma&quot;),
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :                                           NS_LITERAL_CSTRING(&quot;no-cache&quot;), false);</span>
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :     if (NS_FAILED(rv)) {</span>
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :       LOG((&quot;nsIncrementalDownload::AsyncOnChannelRedirect\n&quot;</span>
<span class="lineNum">     910 </span>            :            &quot;    failed to set request header: Pragma\n&quot;));
<span class="lineNum">     911 </span>            :     }
<span class="lineNum">     912 </span>            :   }
<span class="lineNum">     913 </span>            : 
<span class="lineNum">     914 </span>            :   // Prepare to receive callback
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :   mRedirectCallback = cb;</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :   mNewRedirectChannel = newChannel;</span>
<span class="lineNum">     917 </span>            : 
<span class="lineNum">     918 </span>            :   // Give the observer a chance to see this redirect notification.
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIChannelEventSink&gt; sink = do_GetInterface(mObserver);</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :   if (sink) {</span>
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :     rv = sink-&gt;AsyncOnChannelRedirect(oldChannel, newChannel, flags, this);</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :     if (NS_FAILED(rv)) {</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :         mRedirectCallback = nullptr;</span>
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :         mNewRedirectChannel = nullptr;</span>
<span class="lineNum">     925 </span>            :     }
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">     927 </span>            :   }
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :   (void) OnRedirectVerifyCallback(NS_OK);</span>
<span class="lineNum">     929 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     930 </span>            : }
<a name="931"><span class="lineNum">     931 </span>            : </a>
<span class="lineNum">     932 </span>            : NS_IMETHODIMP
<span class="lineNum">     933 </span><span class="lineNoCov">          0 : nsIncrementalDownload::OnRedirectVerifyCallback(nsresult result)</span>
<span class="lineNum">     934 </span>            : {
<span class="lineNum">     935 </span>            :   NS_ASSERTION(mRedirectCallback, &quot;mRedirectCallback not set in callback&quot;);
<span class="lineNum">     936 </span>            :   NS_ASSERTION(mNewRedirectChannel, &quot;mNewRedirectChannel not set in callback&quot;);
<span class="lineNum">     937 </span>            : 
<span class="lineNum">     938 </span>            :   // Update mChannel, so we can Cancel the new channel.
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :   if (NS_SUCCEEDED(result))</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :     mChannel = mNewRedirectChannel;</span>
<span class="lineNum">     941 </span>            : 
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :   mRedirectCallback-&gt;OnRedirectVerifyCallback(result);</span>
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :   mRedirectCallback = nullptr;</span>
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :   mNewRedirectChannel = nullptr;</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     946 </span>            : }
<a name="947"><span class="lineNum">     947 </span>            : </a>
<span class="lineNum">     948 </span>            : extern nsresult
<span class="lineNum">     949 </span><span class="lineCov">          1 : net_NewIncrementalDownload(nsISupports *outer, const nsIID &amp;iid, void **result)</span>
<span class="lineNum">     950 </span>            : {
<span class="lineNum">     951 </span><span class="lineCov">          1 :   if (outer)</span>
<span class="lineNum">     952 </span>            :     return NS_ERROR_NO_AGGREGATION;
<span class="lineNum">     953 </span>            : 
<span class="lineNum">     954 </span><span class="lineCov">          1 :   nsIncrementalDownload *d = new nsIncrementalDownload();</span>
<span class="lineNum">     955 </span><span class="lineCov">          1 :   if (!d)</span>
<span class="lineNum">     956 </span>            :     return NS_ERROR_OUT_OF_MEMORY;
<span class="lineNum">     957 </span>            :   
<span class="lineNum">     958 </span>            :   NS_ADDREF(d);
<span class="lineNum">     959 </span><span class="lineCov">          1 :   nsresult rv = d-&gt;QueryInterface(iid, result);</span>
<span class="lineNum">     960 </span><span class="lineCov">          1 :   NS_RELEASE(d);</span>
<span class="lineNum">     961 </span><span class="lineCov">          1 :   return rv;</span>
<span class="lineNum">     962 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
