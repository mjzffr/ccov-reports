<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - layout/base/MobileViewportManager.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">layout/base</a> - MobileViewportManager.cpp<span style="font-size: 80%;"> (source / <a href="MobileViewportManager.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">72</td>
            <td class="headerCovTableEntry">150</td>
            <td class="headerCovTableEntryLo">48.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21 12:24:28</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">11</td>
            <td class="headerCovTableEntry">19</td>
            <td class="headerCovTableEntryLo">57.9 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       3 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       4 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            : #include &quot;MobileViewportManager.h&quot;
<span class="lineNum">       7 </span>            : 
<span class="lineNum">       8 </span>            : #include &quot;gfxPrefs.h&quot;
<span class="lineNum">       9 </span>            : #include &quot;LayersLogging.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;mozilla/PresShell.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;nsIDOMEvent.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;nsIFrame.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;nsLayoutUtils.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;nsViewManager.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;nsViewportInfo.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;UnitTransforms.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;nsIDocument.h&quot;
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : #define MVM_LOG(...)
<a name="20"><span class="lineNum">      20 </span>            : // #define MVM_LOG(...) printf_stderr(&quot;MVM: &quot; __VA_ARGS__)</a>
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span><span class="lineCov">          1 : NS_IMPL_ISUPPORTS(MobileViewportManager, nsIDOMEventListener, nsIObserver)</span>
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : static const nsLiteralString DOM_META_ADDED = NS_LITERAL_STRING(&quot;DOMMetaAdded&quot;);
<span class="lineNum">      25 </span>            : static const nsLiteralString DOM_META_CHANGED = NS_LITERAL_STRING(&quot;DOMMetaChanged&quot;);
<span class="lineNum">      26 </span>            : static const nsLiteralString FULL_ZOOM_CHANGE = NS_LITERAL_STRING(&quot;FullZoomChange&quot;);
<span class="lineNum">      27 </span>            : static const nsLiteralString LOAD = NS_LITERAL_STRING(&quot;load&quot;);
<span class="lineNum">      28 </span>            : static const nsLiteralCString BEFORE_FIRST_PAINT = NS_LITERAL_CSTRING(&quot;before-first-paint&quot;);
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : using namespace mozilla;
<a name="31"><span class="lineNum">      31 </span>            : using namespace mozilla::layers;</a>
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span><span class="lineCov">          1 : MobileViewportManager::MobileViewportManager(nsIPresShell* aPresShell,</span>
<span class="lineNum">      34 </span>            :                                              nsIDocument* aDocument)
<span class="lineNum">      35 </span>            :   : mDocument(aDocument)
<span class="lineNum">      36 </span>            :   , mPresShell(aPresShell)
<span class="lineNum">      37 </span>            :   , mIsFirstPaint(false)
<span class="lineNum">      38 </span><span class="lineCov">          1 :   , mPainted(false)</span>
<span class="lineNum">      39 </span>            : {
<span class="lineNum">      40 </span>            :   MOZ_ASSERT(mPresShell);
<span class="lineNum">      41 </span>            :   MOZ_ASSERT(mDocument);
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            :   MVM_LOG(&quot;%p: creating with presShell %p document %p\n&quot;, this, mPresShell, aDocument);
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span><span class="lineCov">          1 :   if (nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = mDocument-&gt;GetWindow()) {</span>
<span class="lineNum">      46 </span><span class="lineCov">          1 :     mEventTarget = window-&gt;GetChromeEventHandler();</span>
<span class="lineNum">      47 </span>            :   }
<span class="lineNum">      48 </span><span class="lineCov">          1 :   if (mEventTarget) {</span>
<span class="lineNum">      49 </span><span class="lineCov">          1 :     mEventTarget-&gt;AddEventListener(DOM_META_ADDED, this, false);</span>
<span class="lineNum">      50 </span><span class="lineCov">          1 :     mEventTarget-&gt;AddEventListener(DOM_META_CHANGED, this, false);</span>
<span class="lineNum">      51 </span><span class="lineCov">          1 :     mEventTarget-&gt;AddEventListener(FULL_ZOOM_CHANGE, this, false);</span>
<span class="lineNum">      52 </span><span class="lineCov">          1 :     mEventTarget-&gt;AddEventListener(LOAD, this, true);</span>
<span class="lineNum">      53 </span>            :   }
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span><span class="lineCov">          1 :   nsCOMPtr&lt;nsIObserverService&gt; observerService = mozilla::services::GetObserverService();</span>
<span class="lineNum">      56 </span><span class="lineCov">          1 :   if (observerService) {</span>
<span class="lineNum">      57 </span><span class="lineCov">          1 :     observerService-&gt;AddObserver(this, BEFORE_FIRST_PAINT.Data(), false);</span>
<span class="lineNum">      58 </span>            :   }
<a name="59"><span class="lineNum">      59 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span><span class="lineCov">          1 : MobileViewportManager::~MobileViewportManager()</span>
<span class="lineNum">      62 </span>            : {
<span class="lineNum">      63 </span><span class="lineCov">          1 : }</span>
<a name="64"><span class="lineNum">      64 </span>            : </a>
<span class="lineNum">      65 </span>            : void
<span class="lineNum">      66 </span><span class="lineCov">          1 : MobileViewportManager::Destroy()</span>
<span class="lineNum">      67 </span>            : {
<span class="lineNum">      68 </span>            :   MVM_LOG(&quot;%p: destroying\n&quot;, this);
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span><span class="lineCov">          1 :   if (mEventTarget) {</span>
<span class="lineNum">      71 </span><span class="lineCov">          1 :     mEventTarget-&gt;RemoveEventListener(DOM_META_ADDED, this, false);</span>
<span class="lineNum">      72 </span><span class="lineCov">          1 :     mEventTarget-&gt;RemoveEventListener(DOM_META_CHANGED, this, false);</span>
<span class="lineNum">      73 </span><span class="lineCov">          1 :     mEventTarget-&gt;RemoveEventListener(FULL_ZOOM_CHANGE, this, false);</span>
<span class="lineNum">      74 </span><span class="lineCov">          1 :     mEventTarget-&gt;RemoveEventListener(LOAD, this, true);</span>
<span class="lineNum">      75 </span><span class="lineCov">          1 :     mEventTarget = nullptr;</span>
<span class="lineNum">      76 </span>            :   }
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span><span class="lineCov">          1 :   nsCOMPtr&lt;nsIObserverService&gt; observerService = mozilla::services::GetObserverService();</span>
<span class="lineNum">      79 </span><span class="lineCov">          1 :   if (observerService) {</span>
<span class="lineNum">      80 </span><span class="lineCov">          1 :     observerService-&gt;RemoveObserver(this, BEFORE_FIRST_PAINT.Data());</span>
<span class="lineNum">      81 </span>            :   }
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span><span class="lineCov">          1 :   mDocument = nullptr;</span>
<span class="lineNum">      84 </span><span class="lineCov">          1 :   mPresShell = nullptr;</span>
<span class="lineNum">      85 </span><span class="lineCov">          1 : }</span>
<a name="86"><span class="lineNum">      86 </span>            : </a>
<span class="lineNum">      87 </span>            : void
<span class="lineNum">      88 </span><span class="lineNoCov">          0 : MobileViewportManager::SetRestoreResolution(float aResolution,</span>
<span class="lineNum">      89 </span>            :                                             LayoutDeviceIntSize aDisplaySize)
<span class="lineNum">      90 </span>            : {
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :   mRestoreResolution = Some(aResolution);</span>
<span class="lineNum">      92 </span>            :   ScreenIntSize restoreDisplaySize = ViewAs&lt;ScreenPixel&gt;(aDisplaySize,
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :     PixelCastJustification::LayoutDeviceIsScreenForBounds);</span>
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :   mRestoreDisplaySize = Some(restoreDisplaySize);</span>
<span class="lineNum">      95 </span><span class="lineNoCov">          0 : }</span>
<a name="96"><span class="lineNum">      96 </span>            : </a>
<span class="lineNum">      97 </span>            : void
<span class="lineNum">      98 </span><span class="lineCov">          1 : MobileViewportManager::RequestReflow()</span>
<span class="lineNum">      99 </span>            : {
<span class="lineNum">     100 </span>            :   MVM_LOG(&quot;%p: got a reflow request\n&quot;, this);
<span class="lineNum">     101 </span><span class="lineCov">          1 :   RefreshViewportSize(false);</span>
<span class="lineNum">     102 </span><span class="lineCov">          1 : }</span>
<a name="103"><span class="lineNum">     103 </span>            : </a>
<span class="lineNum">     104 </span>            : void
<span class="lineNum">     105 </span><span class="lineNoCov">          0 : MobileViewportManager::ResolutionUpdated()</span>
<span class="lineNum">     106 </span>            : {
<span class="lineNum">     107 </span>            :   MVM_LOG(&quot;%p: resolution updated\n&quot;, this);
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :   RefreshSPCSPS();</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 : }</span>
<a name="110"><span class="lineNum">     110 </span>            : </a>
<span class="lineNum">     111 </span>            : NS_IMETHODIMP
<span class="lineNum">     112 </span><span class="lineCov">          1 : MobileViewportManager::HandleEvent(nsIDOMEvent* event)</span>
<span class="lineNum">     113 </span>            : {
<span class="lineNum">     114 </span><span class="lineCov">          1 :   nsAutoString type;</span>
<span class="lineNum">     115 </span><span class="lineCov">          1 :   event-&gt;GetType(type);</span>
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span><span class="lineCov">          1 :   if (type.Equals(DOM_META_ADDED)) {</span>
<span class="lineNum">     118 </span>            :     MVM_LOG(&quot;%p: got a dom-meta-added event\n&quot;, this);
<span class="lineNum">     119 </span><span class="lineCov">          1 :     RefreshViewportSize(mPainted);</span>
<span class="lineNum">     120 </span><span class="lineCov">          1 :   } else if (type.Equals(DOM_META_CHANGED)) {</span>
<span class="lineNum">     121 </span>            :     MVM_LOG(&quot;%p: got a dom-meta-changed event\n&quot;, this);
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :     RefreshViewportSize(mPainted);</span>
<span class="lineNum">     123 </span><span class="lineCov">          1 :   } else if (type.Equals(FULL_ZOOM_CHANGE)) {</span>
<span class="lineNum">     124 </span>            :     MVM_LOG(&quot;%p: got a full-zoom-change event\n&quot;, this);
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     RefreshViewportSize(false);</span>
<span class="lineNum">     126 </span><span class="lineCov">          1 :   } else if (type.Equals(LOAD)) {</span>
<span class="lineNum">     127 </span>            :     MVM_LOG(&quot;%p: got a load event\n&quot;, this);
<span class="lineNum">     128 </span><span class="lineCov">          1 :     if (!mPainted) {</span>
<span class="lineNum">     129 </span>            :       // Load event got fired before the before-first-paint message
<span class="lineNum">     130 </span><span class="lineCov">          1 :       SetInitialViewport();</span>
<span class="lineNum">     131 </span>            :     }
<span class="lineNum">     132 </span>            :   }
<span class="lineNum">     133 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">     134 </span>            : }
<a name="135"><span class="lineNum">     135 </span>            : </a>
<span class="lineNum">     136 </span>            : NS_IMETHODIMP
<span class="lineNum">     137 </span><span class="lineCov">          1 : MobileViewportManager::Observe(nsISupports* aSubject, const char* aTopic, const char16_t* aData)</span>
<span class="lineNum">     138 </span>            : {
<span class="lineNum">     139 </span><span class="lineCov">          1 :   if (SameCOMIdentity(aSubject, mDocument) &amp;&amp; BEFORE_FIRST_PAINT.EqualsASCII(aTopic)) {</span>
<span class="lineNum">     140 </span>            :     MVM_LOG(&quot;%p: got a before-first-paint event\n&quot;, this);
<span class="lineNum">     141 </span><span class="lineCov">          1 :     if (!mPainted) {</span>
<span class="lineNum">     142 </span>            :       // before-first-paint message arrived before load event
<span class="lineNum">     143 </span><span class="lineCov">          1 :       SetInitialViewport();</span>
<span class="lineNum">     144 </span>            :     }
<span class="lineNum">     145 </span>            :   }
<span class="lineNum">     146 </span><span class="lineCov">          1 :   return NS_OK;</span>
<span class="lineNum">     147 </span>            : }
<a name="148"><span class="lineNum">     148 </span>            : </a>
<span class="lineNum">     149 </span>            : void
<span class="lineNum">     150 </span><span class="lineCov">          1 : MobileViewportManager::SetInitialViewport()</span>
<span class="lineNum">     151 </span>            : {
<span class="lineNum">     152 </span>            :   MVM_LOG(&quot;%p: setting initial viewport\n&quot;, this);
<span class="lineNum">     153 </span><span class="lineCov">          1 :   mIsFirstPaint = true;</span>
<span class="lineNum">     154 </span><span class="lineCov">          1 :   mPainted = true;</span>
<span class="lineNum">     155 </span><span class="lineCov">          1 :   RefreshViewportSize(false);</span>
<span class="lineNum">     156 </span><span class="lineCov">          1 : }</span>
<a name="157"><span class="lineNum">     157 </span>            : </a>
<span class="lineNum">     158 </span>            : CSSToScreenScale
<span class="lineNum">     159 </span><span class="lineNoCov">          0 : MobileViewportManager::ClampZoom(const CSSToScreenScale&amp; aZoom,</span>
<span class="lineNum">     160 </span>            :                                  const nsViewportInfo&amp; aViewportInfo)
<span class="lineNum">     161 </span>            : {
<span class="lineNum">     162 </span>            :   CSSToScreenScale zoom = aZoom;
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :   if (zoom &lt; aViewportInfo.GetMinZoom()) {</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :     zoom = aViewportInfo.GetMinZoom();</span>
<span class="lineNum">     165 </span>            :     MVM_LOG(&quot;%p: Clamped to %f\n&quot;, this, zoom.scale);
<span class="lineNum">     166 </span>            :   }
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :   if (zoom &gt; aViewportInfo.GetMaxZoom()) {</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :     zoom = aViewportInfo.GetMaxZoom();</span>
<span class="lineNum">     169 </span>            :     MVM_LOG(&quot;%p: Clamped to %f\n&quot;, this, zoom.scale);
<span class="lineNum">     170 </span>            :   }
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :   return zoom;</span>
<span class="lineNum">     172 </span>            : }
<a name="173"><span class="lineNum">     173 </span>            : </a>
<span class="lineNum">     174 </span>            : LayoutDeviceToLayerScale
<span class="lineNum">     175 </span><span class="lineNoCov">          0 : MobileViewportManager::ScaleResolutionWithDisplayWidth(const LayoutDeviceToLayerScale&amp; aRes,</span>
<span class="lineNum">     176 </span>            :                                                        const float&amp; aDisplayWidthChangeRatio,
<span class="lineNum">     177 </span>            :                                                        const CSSSize&amp; aNewViewport,
<span class="lineNum">     178 </span>            :                                                        const CSSSize&amp; aOldViewport)
<span class="lineNum">     179 </span>            : {
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :   float cssViewportChangeRatio = (aOldViewport.width == 0)</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :      ? 1.0f : aNewViewport.width / aOldViewport.width;</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :   LayoutDeviceToLayerScale newRes(aRes.scale * aDisplayWidthChangeRatio</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :     / cssViewportChangeRatio);</span>
<span class="lineNum">     184 </span>            :   MVM_LOG(&quot;%p: Old resolution was %f, changed by %f/%f to %f\n&quot;, this, aRes.scale,
<span class="lineNum">     185 </span>            :     aDisplayWidthChangeRatio, cssViewportChangeRatio, newRes.scale);
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :   return newRes;</span>
<span class="lineNum">     187 </span>            : }
<a name="188"><span class="lineNum">     188 </span>            : </a>
<span class="lineNum">     189 </span>            : CSSToScreenScale
<span class="lineNum">     190 </span><span class="lineNoCov">          0 : MobileViewportManager::UpdateResolution(const nsViewportInfo&amp; aViewportInfo,</span>
<span class="lineNum">     191 </span>            :                                         const ScreenIntSize&amp; aDisplaySize,
<span class="lineNum">     192 </span>            :                                         const CSSSize&amp; aViewport,
<span class="lineNum">     193 </span>            :                                         const Maybe&lt;float&gt;&amp; aDisplayWidthChangeRatio)
<span class="lineNum">     194 </span>            : {
<span class="lineNum">     195 </span>            :   CSSToLayoutDeviceScale cssToDev =
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :       mPresShell-&gt;GetPresContext()-&gt;CSSToDevPixelScale();</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :   LayoutDeviceToLayerScale res(mPresShell-&gt;GetResolution());</span>
<span class="lineNum">     198 </span>            : 
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :   if (mIsFirstPaint) {</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :     CSSToScreenScale defaultZoom;</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :     if (mRestoreResolution) {</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :     LayoutDeviceToLayerScale restoreResolution(mRestoreResolution.value());</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :       if (mRestoreDisplaySize) {</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :         CSSSize prevViewport = mDocument-&gt;GetViewportInfo(mRestoreDisplaySize.value()).GetSize();</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :         float restoreDisplayWidthChangeRatio = (mRestoreDisplaySize.value().width &gt; 0)</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :           ? (float)aDisplaySize.width / (float)mRestoreDisplaySize.value().width : 1.0f;</span>
<span class="lineNum">     207 </span>            : 
<span class="lineNum">     208 </span>            :         restoreResolution =
<span class="lineNum">     209 </span>            :           ScaleResolutionWithDisplayWidth(restoreResolution,
<span class="lineNum">     210 </span>            :                                           restoreDisplayWidthChangeRatio,
<span class="lineNum">     211 </span>            :                                           aViewport,
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :                                           prevViewport);</span>
<span class="lineNum">     213 </span>            :       }
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :       defaultZoom = CSSToScreenScale(restoreResolution.scale * cssToDev.scale);</span>
<span class="lineNum">     215 </span>            :       MVM_LOG(&quot;%p: restored zoom is %f\n&quot;, this, defaultZoom.scale);
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :       defaultZoom = ClampZoom(defaultZoom, aViewportInfo);</span>
<span class="lineNum">     217 </span>            :     } else {
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :       defaultZoom = aViewportInfo.GetDefaultZoom();</span>
<span class="lineNum">     219 </span>            :       MVM_LOG(&quot;%p: default zoom from viewport is %f\n&quot;, this, defaultZoom.scale);
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :       if (!aViewportInfo.IsDefaultZoomValid()) {</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :         defaultZoom = MaxScaleRatio(ScreenSize(aDisplaySize), aViewport);</span>
<span class="lineNum">     222 </span>            :         MVM_LOG(&quot;%p: Intrinsic computed zoom is %f\n&quot;, this, defaultZoom.scale);
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :         defaultZoom = ClampZoom(defaultZoom, aViewportInfo);</span>
<span class="lineNum">     224 </span>            :       }
<span class="lineNum">     225 </span>            :     }
<span class="lineNum">     226 </span>            :     MOZ_ASSERT(aViewportInfo.GetMinZoom() &lt;= defaultZoom &amp;&amp;
<span class="lineNum">     227 </span>            :       defaultZoom &lt;= aViewportInfo.GetMaxZoom());
<span class="lineNum">     228 </span>            : 
<span class="lineNum">     229 </span>            :     CSSToParentLayerScale zoom = ViewTargetAs&lt;ParentLayerPixel&gt;(defaultZoom,
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :       PixelCastJustification::ScreenIsParentLayerForRoot);</span>
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span>            :     LayoutDeviceToLayerScale resolution = zoom / cssToDev * ParentLayerToLayerScale(1);
<span class="lineNum">     233 </span>            :     MVM_LOG(&quot;%p: setting resolution %f\n&quot;, this, resolution.scale);
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :     mPresShell-&gt;SetResolutionAndScaleTo(resolution.scale);</span>
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span>            :     return defaultZoom;
<span class="lineNum">     237 </span>            :   }
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span>            :   // If this is not a first paint, then in some cases we want to update the pre-
<span class="lineNum">     240 </span>            :   // existing resolution so as to maintain how much actual content is visible
<span class="lineNum">     241 </span>            :   // within the display width. Note that &quot;actual content&quot; may be different with
<span class="lineNum">     242 </span>            :   // respect to CSS pixels because of the CSS viewport size changing.
<span class="lineNum">     243 </span>            :   //
<span class="lineNum">     244 </span>            :   // aDisplayWidthChangeRatio is non-empty if:
<span class="lineNum">     245 </span>            :   // (a) The meta-viewport tag information changes, and so the CSS viewport
<span class="lineNum">     246 </span>            :   //     might change as a result. If this happens after the content has been
<span class="lineNum">     247 </span>            :   //     painted, we want to adjust the zoom to compensate. OR
<span class="lineNum">     248 </span>            :   // (b) The display size changed from a nonzero value to another nonzero value.
<span class="lineNum">     249 </span>            :   //     This covers the case where e.g. the device was rotated, and again we
<span class="lineNum">     250 </span>            :   //     want to adjust the zoom to compensate.
<span class="lineNum">     251 </span>            :   // Note in particular that aDisplayWidthChangeRatio will be None if all that
<span class="lineNum">     252 </span>            :   // happened was a change in the full-zoom. In this case, we still want to
<span class="lineNum">     253 </span>            :   // compute a new CSS viewport, but we don't want to update the resolution.
<span class="lineNum">     254 </span>            :   //
<span class="lineNum">     255 </span>            :   // Given the above, the algorithm below accounts for all types of changes I
<span class="lineNum">     256 </span>            :   // can conceive of:
<span class="lineNum">     257 </span>            :   // 1. screen size changes, CSS viewport does not (pages with no meta viewport
<span class="lineNum">     258 </span>            :   //    or a fixed size viewport)
<span class="lineNum">     259 </span>            :   // 2. screen size changes, CSS viewport also does (pages with a device-width
<span class="lineNum">     260 </span>            :   //    viewport)
<span class="lineNum">     261 </span>            :   // 3. screen size remains constant, but CSS viewport changes (meta viewport
<span class="lineNum">     262 </span>            :   //    tag is added or removed)
<span class="lineNum">     263 </span>            :   // 4. neither screen size nor CSS viewport changes
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :   if (aDisplayWidthChangeRatio) {</span>
<span class="lineNum">     265 </span>            :     res = ScaleResolutionWithDisplayWidth(res, aDisplayWidthChangeRatio.value(),
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :       aViewport, mMobileViewportSize);</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :     mPresShell-&gt;SetResolutionAndScaleTo(res.scale);</span>
<span class="lineNum">     268 </span>            :   }
<span class="lineNum">     269 </span>            : 
<span class="lineNum">     270 </span>            :   return ViewTargetAs&lt;ScreenPixel&gt;(cssToDev * res / ParentLayerToLayerScale(1),
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :     PixelCastJustification::ScreenIsParentLayerForRoot);</span>
<span class="lineNum">     272 </span>            : }
<a name="273"><span class="lineNum">     273 </span>            : </a>
<span class="lineNum">     274 </span>            : void
<span class="lineNum">     275 </span><span class="lineNoCov">          0 : MobileViewportManager::UpdateSPCSPS(const ScreenIntSize&amp; aDisplaySize,</span>
<span class="lineNum">     276 </span>            :                                     const CSSToScreenScale&amp; aZoom)
<span class="lineNum">     277 </span>            : {
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :   ScreenSize compositionSize(aDisplaySize);</span>
<span class="lineNum">     279 </span>            :   ScreenMargin scrollbars =
<span class="lineNum">     280 </span>            :     LayoutDeviceMargin::FromAppUnits(
<span class="lineNum">     281 </span>            :       nsLayoutUtils::ScrollbarAreaToExcludeFromCompositionBoundsFor(
<span class="lineNum">     282 </span>            :         mPresShell-&gt;GetRootScrollFrame()),
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :       mPresShell-&gt;GetPresContext()-&gt;AppUnitsPerDevPixel())</span>
<span class="lineNum">     284 </span>            :     // Scrollbars are not subject to resolution scaling, so LD pixels =
<span class="lineNum">     285 </span>            :     // Screen pixels for them.
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :     * LayoutDeviceToScreenScale(1.0f);</span>
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :   compositionSize.width -= scrollbars.LeftRight();</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :   compositionSize.height -= scrollbars.TopBottom();</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :   CSSSize compSize = compositionSize / aZoom;</span>
<span class="lineNum">     291 </span>            :   MVM_LOG(&quot;%p: Setting SPCSPS %s\n&quot;, this, Stringify(compSize).c_str());
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :   nsLayoutUtils::SetScrollPositionClampingScrollPortSize(mPresShell, compSize);</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 : }</span>
<a name="294"><span class="lineNum">     294 </span>            : </a>
<span class="lineNum">     295 </span>            : void
<span class="lineNum">     296 </span><span class="lineNoCov">          0 : MobileViewportManager::UpdateDisplayPortMargins()</span>
<span class="lineNum">     297 </span>            : {
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :   if (nsIFrame* root = mPresShell-&gt;GetRootScrollFrame()) {</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :     bool hasDisplayPort = nsLayoutUtils::HasDisplayPort(root-&gt;GetContent());</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :     bool hasResolution = mPresShell-&gt;ScaleToResolution() &amp;&amp;</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :         mPresShell-&gt;GetResolution() != 1.0f;</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :     if (!hasDisplayPort &amp;&amp; !hasResolution) {</span>
<span class="lineNum">     303 </span>            :       // We only want to update the displayport if there is one already, or
<span class="lineNum">     304 </span>            :       // add one if there's a resolution on the document (see bug 1225508
<span class="lineNum">     305 </span>            :       // comment 1).
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     307 </span>            :     }
<span class="lineNum">     308 </span>            :     nsRect displayportBase =
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :       nsRect(nsPoint(0, 0), nsLayoutUtils::CalculateCompositionSizeForFrame(root));</span>
<span class="lineNum">     310 </span>            :     // We only create MobileViewportManager for root content documents. If that ever changes
<span class="lineNum">     311 </span>            :     // we'd need to limit the size of this displayport base rect because non-toplevel documents
<span class="lineNum">     312 </span>            :     // have no limit on their size.
<span class="lineNum">     313 </span>            :     MOZ_ASSERT(mPresShell-&gt;GetPresContext()-&gt;IsRootContentDocument());
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :     nsLayoutUtils::SetDisplayPortBaseIfNotSet(root-&gt;GetContent(), displayportBase);</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :     nsIScrollableFrame* scrollable = do_QueryFrame(root);</span>
<span class="lineNum">     316 </span>            :     nsLayoutUtils::CalculateAndSetDisplayPortMargins(scrollable,
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :       nsLayoutUtils::RepaintMode::DoNotRepaint);</span>
<span class="lineNum">     318 </span>            :   }
<span class="lineNum">     319 </span>            : }
<a name="320"><span class="lineNum">     320 </span>            : </a>
<span class="lineNum">     321 </span>            : void
<span class="lineNum">     322 </span><span class="lineNoCov">          0 : MobileViewportManager::RefreshSPCSPS()</span>
<span class="lineNum">     323 </span>            : {
<span class="lineNum">     324 </span>            :   // This function is a subset of RefreshViewportSize, and only updates the
<span class="lineNum">     325 </span>            :   // SPCSPS.
<span class="lineNum">     326 </span>            : 
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :   if (!gfxPrefs::APZAllowZooming()) {</span>
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     329 </span>            :   }
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span>            :   ScreenIntSize displaySize = ViewAs&lt;ScreenPixel&gt;(
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :     mDisplaySize, PixelCastJustification::LayoutDeviceIsScreenForBounds);</span>
<span class="lineNum">     333 </span>            : 
<span class="lineNum">     334 </span>            :   CSSToLayoutDeviceScale cssToDev =
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :       mPresShell-&gt;GetPresContext()-&gt;CSSToDevPixelScale();</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :   LayoutDeviceToLayerScale res(mPresShell-&gt;GetResolution());</span>
<span class="lineNum">     337 </span>            :   CSSToScreenScale zoom = ViewTargetAs&lt;ScreenPixel&gt;(cssToDev * res / ParentLayerToLayerScale(1),
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :     PixelCastJustification::ScreenIsParentLayerForRoot);</span>
<span class="lineNum">     339 </span>            : 
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :   UpdateSPCSPS(displaySize, zoom);</span>
<span class="lineNum">     341 </span>            : }
<a name="342"><span class="lineNum">     342 </span>            : </a>
<span class="lineNum">     343 </span>            : void
<span class="lineNum">     344 </span><span class="lineCov">          1 : MobileViewportManager::RefreshViewportSize(bool aForceAdjustResolution)</span>
<span class="lineNum">     345 </span>            : {
<span class="lineNum">     346 </span>            :   // This function gets called by the various triggers that may result in a
<span class="lineNum">     347 </span>            :   // change of the CSS viewport. In some of these cases (e.g. the meta-viewport
<span class="lineNum">     348 </span>            :   // tag changes) we want to update the resolution and in others (e.g. the full
<span class="lineNum">     349 </span>            :   // zoom changing) we don't want to update the resolution. See the comment in
<span class="lineNum">     350 </span>            :   // UpdateResolution for some more detail on this. An important assumption we
<span class="lineNum">     351 </span>            :   // make here is that this RefreshViewportSize function will be called
<span class="lineNum">     352 </span>            :   // separately for each trigger that changes. For instance it should never get
<span class="lineNum">     353 </span>            :   // called such that both the full zoom and the meta-viewport tag have changed;
<span class="lineNum">     354 </span>            :   // instead it would get called twice - once after each trigger changes. This
<span class="lineNum">     355 </span>            :   // assumption is what allows the aForceAdjustResolution parameter to work as
<span class="lineNum">     356 </span>            :   // intended; if this assumption is violated then we will need to add extra
<span class="lineNum">     357 </span>            :   // complicated logic in UpdateResolution to ensure we only do the resolution
<span class="lineNum">     358 </span>            :   // update in the right scenarios.
<span class="lineNum">     359 </span>            : 
<span class="lineNum">     360 </span>            :   Maybe&lt;float&gt; displayWidthChangeRatio;
<span class="lineNum">     361 </span><span class="lineCov">          1 :   LayoutDeviceIntSize newDisplaySize;</span>
<span class="lineNum">     362 </span><span class="lineCov">          1 :   if (nsLayoutUtils::GetContentViewerSize(mPresShell-&gt;GetPresContext(), newDisplaySize)) {</span>
<span class="lineNum">     363 </span>            :     // See the comment in UpdateResolution for why we're doing this.
<span class="lineNum">     364 </span><span class="lineCov">          1 :     if (mDisplaySize.width &gt; 0) {</span>
<span class="lineNum">     365 </span><span class="lineCov">          1 :       if (aForceAdjustResolution || mDisplaySize.width != newDisplaySize.width) {</span>
<span class="lineNum">     366 </span><span class="lineCov">          1 :         displayWidthChangeRatio = Some((float)newDisplaySize.width / (float)mDisplaySize.width);</span>
<span class="lineNum">     367 </span>            :       }
<span class="lineNum">     368 </span><span class="lineCov">          1 :     } else if (aForceAdjustResolution) {</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :       displayWidthChangeRatio = Some(1.0f);</span>
<span class="lineNum">     370 </span>            :     }
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span>            :     MVM_LOG(&quot;%p: Display width change ratio is %f\n&quot;, this, displayWidthChangeRatio.valueOr(0.0f));
<span class="lineNum">     373 </span><span class="lineCov">          1 :     mDisplaySize = newDisplaySize;</span>
<span class="lineNum">     374 </span>            :   }
<span class="lineNum">     375 </span>            : 
<span class="lineNum">     376 </span>            :   MVM_LOG(&quot;%p: Computing CSS viewport using %d,%d\n&quot;, this,
<span class="lineNum">     377 </span>            :     mDisplaySize.width, mDisplaySize.height);
<span class="lineNum">     378 </span><span class="lineCov">          1 :   if (mDisplaySize.width == 0 || mDisplaySize.height == 0) {</span>
<span class="lineNum">     379 </span>            :     // We can't do anything useful here, we should just bail out
<span class="lineNum">     380 </span>            :     return;
<span class="lineNum">     381 </span>            :   }
<span class="lineNum">     382 </span>            : 
<span class="lineNum">     383 </span>            :   ScreenIntSize displaySize = ViewAs&lt;ScreenPixel&gt;(
<span class="lineNum">     384 </span><span class="lineCov">          1 :     mDisplaySize, PixelCastJustification::LayoutDeviceIsScreenForBounds);</span>
<span class="lineNum">     385 </span><span class="lineCov">          1 :   nsViewportInfo viewportInfo = mDocument-&gt;GetViewportInfo(displaySize);</span>
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span><span class="lineCov">          1 :   CSSSize viewport = viewportInfo.GetSize();</span>
<span class="lineNum">     388 </span>            :   MVM_LOG(&quot;%p: Computed CSS viewport %s\n&quot;, this, Stringify(viewport).c_str());
<span class="lineNum">     389 </span>            : 
<span class="lineNum">     390 </span><span class="lineCov">          1 :   if (!mIsFirstPaint &amp;&amp; mMobileViewportSize == viewport) {</span>
<span class="lineNum">     391 </span>            :     // Nothing changed, so no need to do a reflow
<span class="lineNum">     392 </span>            :     return;
<span class="lineNum">     393 </span>            :   }
<span class="lineNum">     394 </span>            : 
<span class="lineNum">     395 </span>            :   // If it's the first-paint or the viewport changed, we need to update
<span class="lineNum">     396 </span>            :   // various APZ properties (the zoom and some things that might depend on it)
<span class="lineNum">     397 </span>            :   MVM_LOG(&quot;%p: Updating properties because %d || %d\n&quot;, this,
<span class="lineNum">     398 </span>            :     mIsFirstPaint, mMobileViewportSize != viewport);
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span><span class="lineCov">          1 :   if (gfxPrefs::APZAllowZooming()) {</span>
<span class="lineNum">     401 </span>            :     CSSToScreenScale zoom = UpdateResolution(viewportInfo, displaySize, viewport,
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :       displayWidthChangeRatio);</span>
<span class="lineNum">     403 </span>            :     MVM_LOG(&quot;%p: New zoom is %f\n&quot;, this, zoom.scale);
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :     UpdateSPCSPS(displaySize, zoom);</span>
<span class="lineNum">     405 </span>            :   }
<span class="lineNum">     406 </span><span class="lineCov">          1 :   if (gfxPlatform::AsyncPanZoomEnabled()) {</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :     UpdateDisplayPortMargins();</span>
<span class="lineNum">     408 </span>            :   }
<span class="lineNum">     409 </span>            : 
<span class="lineNum">     410 </span><span class="lineCov">          1 :   CSSSize oldSize = mMobileViewportSize;</span>
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span>            :   // Update internal state.
<span class="lineNum">     413 </span><span class="lineCov">          1 :   mIsFirstPaint = false;</span>
<span class="lineNum">     414 </span><span class="lineCov">          1 :   mMobileViewportSize = viewport;</span>
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span>            :   // Kick off a reflow.
<span class="lineNum">     417 </span>            :   mPresShell-&gt;ResizeReflowIgnoreOverride(
<span class="lineNum">     418 </span>            :     nsPresContext::CSSPixelsToAppUnits(viewport.width),
<span class="lineNum">     419 </span>            :     nsPresContext::CSSPixelsToAppUnits(viewport.height),
<span class="lineNum">     420 </span>            :     nsPresContext::CSSPixelsToAppUnits(oldSize.width),
<span class="lineNum">     421 </span><span class="lineCov">          1 :     nsPresContext::CSSPixelsToAppUnits(oldSize.height));</span>
<span class="lineNum">     422 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
