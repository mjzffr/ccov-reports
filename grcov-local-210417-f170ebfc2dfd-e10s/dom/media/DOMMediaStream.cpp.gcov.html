<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - dom/media/DOMMediaStream.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">dom/media</a> - DOMMediaStream.cpp<span style="font-size: 80%;"> (source / <a href="DOMMediaStream.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">529</td>
            <td class="headerCovTableEntry">636</td>
            <td class="headerCovTableEntryMed">83.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21 12:24:28</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">124</td>
            <td class="headerCovTableEntry">146</td>
            <td class="headerCovTableEntryMed">84.9 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-*/</a>
<span class="lineNum">       2 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       3 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this file,
<span class="lineNum">       4 </span>            :  * You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            : #include &quot;DOMMediaStream.h&quot;
<span class="lineNum">       7 </span>            : #include &quot;nsContentUtils.h&quot;
<span class="lineNum">       8 </span>            : #include &quot;nsServiceManagerUtils.h&quot;
<span class="lineNum">       9 </span>            : #include &quot;nsIScriptError.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;nsIUUIDGenerator.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;nsPIDOMWindow.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;mozilla/dom/DocGroup.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;mozilla/dom/MediaStreamBinding.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;mozilla/dom/MediaStreamTrackEvent.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;mozilla/dom/LocalMediaStreamBinding.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;mozilla/dom/AudioNode.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;AudioChannelAgent.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;mozilla/dom/AudioTrack.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;mozilla/dom/AudioTrackList.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;mozilla/dom/VideoTrack.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;mozilla/dom/VideoTrackList.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;mozilla/dom/HTMLCanvasElement.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;mozilla/media/MediaUtils.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;MediaStreamGraph.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;AudioStreamTrack.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;VideoStreamTrack.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;Layers.h&quot;
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : // GetCurrentTime is defined in winbase.h as zero argument macro forwarding to
<span class="lineNum">      30 </span>            : // GetTickCount() and conflicts with NS_DECL_NSIDOMMEDIASTREAM, containing
<span class="lineNum">      31 </span>            : // currentTime getter.
<span class="lineNum">      32 </span>            : #ifdef GetCurrentTime
<span class="lineNum">      33 </span>            : #undef GetCurrentTime
<span class="lineNum">      34 </span>            : #endif
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            : #ifdef LOG
<span class="lineNum">      37 </span>            : #undef LOG
<span class="lineNum">      38 </span>            : #endif
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : // GetCurrentTime is defined in winbase.h as zero argument macro forwarding to
<span class="lineNum">      41 </span>            : // GetTickCount() and conflicts with MediaStream::GetCurrentTime.
<span class="lineNum">      42 </span>            : #ifdef GetCurrentTime
<span class="lineNum">      43 </span>            : #undef GetCurrentTime
<span class="lineNum">      44 </span>            : #endif
<span class="lineNum">      45 </span>            : 
<span class="lineNum">      46 </span>            : using namespace mozilla;
<span class="lineNum">      47 </span>            : using namespace mozilla::dom;
<span class="lineNum">      48 </span>            : using namespace mozilla::layers;
<span class="lineNum">      49 </span>            : using namespace mozilla::media;
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span>            : static LazyLogModule gMediaStreamLog(&quot;MediaStream&quot;);
<span class="lineNum">      52 </span>            : #define LOG(type, msg) MOZ_LOG(gMediaStreamLog, type, msg)
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span>            : const TrackID TRACK_VIDEO_PRIMARY = 1;
<a name="55"><span class="lineNum">      55 </span>            : </a>
<span class="lineNum">      56 </span>            : static bool
<span class="lineNum">      57 </span><span class="lineCov">          1 : ContainsLiveTracks(nsTArray&lt;RefPtr&lt;DOMMediaStream::TrackPort&gt;&gt;&amp; aTracks)</span>
<span class="lineNum">      58 </span>            : {
<span class="lineNum">      59 </span><span class="lineCov">          1 :   for (auto&amp; port : aTracks) {</span>
<span class="lineNum">      60 </span><span class="lineCov">          1 :     if (port-&gt;GetTrack()-&gt;ReadyState() == MediaStreamTrackState::Live) {</span>
<span class="lineNum">      61 </span><span class="lineCov">          1 :       return true;</span>
<span class="lineNum">      62 </span>            :     }
<span class="lineNum">      63 </span>            :   }
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span><span class="lineCov">          1 :   return false;</span>
<a name="66"><span class="lineNum">      66 </span>            : }</a>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span><span class="lineCov">          1 : DOMMediaStream::TrackPort::TrackPort(MediaInputPort* aInputPort,</span>
<span class="lineNum">      69 </span>            :                                      MediaStreamTrack* aTrack,
<span class="lineNum">      70 </span>            :                                      const InputPortOwnership aOwnership)
<span class="lineNum">      71 </span>            :   : mInputPort(aInputPort)
<span class="lineNum">      72 </span>            :   , mTrack(aTrack)
<span class="lineNum">      73 </span><span class="lineCov">          1 :   , mOwnership(aOwnership)</span>
<span class="lineNum">      74 </span>            : {
<span class="lineNum">      75 </span>            :   MOZ_ASSERT(mInputPort);
<span class="lineNum">      76 </span>            :   MOZ_ASSERT(mTrack);
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span>            :   MOZ_COUNT_CTOR(TrackPort);
<a name="79"><span class="lineNum">      79 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">      80 </span>            : 
<span class="lineNum">      81 </span><span class="lineCov">          1 : DOMMediaStream::TrackPort::~TrackPort()</span>
<span class="lineNum">      82 </span>            : {
<span class="lineNum">      83 </span>            :   MOZ_COUNT_DTOR(TrackPort);
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span><span class="lineCov">          1 :   if (mOwnership == InputPortOwnership::OWNED) {</span>
<span class="lineNum">      86 </span><span class="lineCov">          1 :     DestroyInputPort();</span>
<span class="lineNum">      87 </span>            :   }
<span class="lineNum">      88 </span><span class="lineCov">          1 : }</span>
<a name="89"><span class="lineNum">      89 </span>            : </a>
<span class="lineNum">      90 </span>            : void
<span class="lineNum">      91 </span><span class="lineCov">          1 : DOMMediaStream::TrackPort::DestroyInputPort()</span>
<span class="lineNum">      92 </span>            : {
<span class="lineNum">      93 </span><span class="lineCov">          1 :   if (mInputPort) {</span>
<span class="lineNum">      94 </span><span class="lineCov">          1 :     mInputPort-&gt;Destroy();</span>
<span class="lineNum">      95 </span><span class="lineCov">          1 :     mInputPort = nullptr;</span>
<span class="lineNum">      96 </span>            :   }
<span class="lineNum">      97 </span><span class="lineCov">          1 : }</span>
<a name="98"><span class="lineNum">      98 </span>            : </a>
<span class="lineNum">      99 </span>            : MediaStream*
<span class="lineNum">     100 </span><span class="lineNoCov">          0 : DOMMediaStream::TrackPort::GetSource() const</span>
<span class="lineNum">     101 </span>            : {
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :   return mInputPort ? mInputPort-&gt;GetSource() : nullptr;</span>
<span class="lineNum">     103 </span>            : }
<a name="104"><span class="lineNum">     104 </span>            : </a>
<span class="lineNum">     105 </span>            : TrackID
<span class="lineNum">     106 </span><span class="lineNoCov">          0 : DOMMediaStream::TrackPort::GetSourceTrackId() const</span>
<span class="lineNum">     107 </span>            : {
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :   return mInputPort ? mInputPort-&gt;GetSourceTrackId() : TRACK_INVALID;</span>
<span class="lineNum">     109 </span>            : }
<a name="110"><span class="lineNum">     110 </span>            : </a>
<span class="lineNum">     111 </span>            : already_AddRefed&lt;Pledge&lt;bool&gt;&gt;
<span class="lineNum">     112 </span><span class="lineCov">          1 : DOMMediaStream::TrackPort::BlockSourceTrackId(TrackID aTrackId, BlockingMode aBlockingMode)</span>
<span class="lineNum">     113 </span>            : {
<span class="lineNum">     114 </span><span class="lineCov">          1 :   if (mInputPort) {</span>
<span class="lineNum">     115 </span><span class="lineCov">          1 :     return mInputPort-&gt;BlockSourceTrackId(aTrackId, aBlockingMode);</span>
<span class="lineNum">     116 </span>            :   }
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :   RefPtr&lt;Pledge&lt;bool&gt;&gt; rejected = new Pledge&lt;bool&gt;();</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :   rejected-&gt;Reject(NS_ERROR_FAILURE);</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :   return rejected.forget();</span>
<a name="120"><span class="lineNum">     120 </span>            : }</a>
<a name="121"><span class="lineNum">     121 </span>            : </a>
<a name="122"><span class="lineNum">     122 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION(DOMMediaStream::TrackPort, mTrack)</span></a>
<span class="lineNum">     123 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_ROOT_NATIVE(DOMMediaStream::TrackPort, AddRef)</span>
<a name="124"><span class="lineNum">     124 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_UNROOT_NATIVE(DOMMediaStream::TrackPort, Release)</span></a>
<a name="125"><span class="lineNum">     125 </span>            : </a>
<a name="126"><span class="lineNum">     126 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTING_ADDREF(MediaStreamTrackSourceGetter)</span></a>
<span class="lineNum">     127 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTING_RELEASE(MediaStreamTrackSourceGetter)</span>
<span class="lineNum">     128 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(MediaStreamTrackSourceGetter)</span>
<a name="129"><span class="lineNum">     129 </span><span class="lineNoCov">          0 :   NS_INTERFACE_MAP_ENTRY(nsISupports)</span></a>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 : NS_INTERFACE_MAP_END</span>
<span class="lineNum">     131 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_0(MediaStreamTrackSourceGetter)</span>
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span>            : /**
<span class="lineNum">     134 </span>            :  * Listener registered on the Owned stream to detect added and ended owned
<span class="lineNum">     135 </span>            :  * tracks for keeping the list of MediaStreamTracks in sync with the tracks
<a name="136"><span class="lineNum">     136 </span>            :  * added and ended directly at the source.</a>
<span class="lineNum">     137 </span>            :  */
<a name="138"><span class="lineNum">     138 </span><span class="lineCov">          1 : class DOMMediaStream::OwnedStreamListener : public MediaStreamListener {</span></a>
<span class="lineNum">     139 </span>            : public:
<span class="lineNum">     140 </span><span class="lineCov">          1 :   explicit OwnedStreamListener(DOMMediaStream* aStream)</span>
<span class="lineNum">     141 </span>            :     : mStream(aStream)
<span class="lineNum">     142 </span><span class="lineCov">          1 :     , mAbstractMainThread(aStream-&gt;mAbstractMainThread)</span>
<span class="lineNum">     143 </span><span class="lineCov">          1 :   {}</span>
<span class="lineNum">     144 </span>            : 
<a name="145"><span class="lineNum">     145 </span><span class="lineCov">          1 :   void Forget() { mStream = nullptr; }</span></a>
<span class="lineNum">     146 </span>            : 
<span class="lineNum">     147 </span><span class="lineCov">          1 :   void DoNotifyTrackCreated(TrackID aTrackID, MediaSegment::Type aType,</span>
<span class="lineNum">     148 </span>            :                             MediaStream* aInputStream, TrackID aInputTrackID)
<span class="lineNum">     149 </span>            :   {
<span class="lineNum">     150 </span>            :     MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span><span class="lineCov">          1 :     if (!mStream) {</span>
<span class="lineNum">     153 </span><span class="lineCov">          1 :       return;</span>
<span class="lineNum">     154 </span>            :     }
<span class="lineNum">     155 </span>            : 
<span class="lineNum">     156 </span>            :     MediaStreamTrack* track =
<span class="lineNum">     157 </span><span class="lineCov">          1 :       mStream-&gt;FindOwnedDOMTrack(aInputStream, aInputTrackID, aTrackID);</span>
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span><span class="lineCov">          1 :     if (track) {</span>
<span class="lineNum">     160 </span><span class="lineCov">          1 :       LOG(LogLevel::Debug, (&quot;DOMMediaStream %p Track %d from owned stream %p &quot;</span>
<span class="lineNum">     161 </span>            :                             &quot;bound to MediaStreamTrack %p.&quot;,
<span class="lineNum">     162 </span>            :                             mStream, aTrackID, aInputStream, track));
<span class="lineNum">     163 </span>            :       return;
<span class="lineNum">     164 </span>            :     }
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span>            :     // Track had not been created on main thread before, create it now.
<span class="lineNum">     167 </span>            :     NS_WARNING_ASSERTION(
<span class="lineNum">     168 </span>            :       !mStream-&gt;mTracks.IsEmpty(),
<span class="lineNum">     169 </span>            :       &quot;A new track was detected on the input stream; creating a corresponding &quot;
<span class="lineNum">     170 </span>            :       &quot;MediaStreamTrack. Initial tracks should be added manually to &quot;
<span class="lineNum">     171 </span>            :       &quot;immediately and synchronously be available to JS.&quot;);
<span class="lineNum">     172 </span>            :     RefPtr&lt;MediaStreamTrackSource&gt; source;
<span class="lineNum">     173 </span><span class="lineCov">          1 :     if (mStream-&gt;mTrackSourceGetter) {</span>
<span class="lineNum">     174 </span><span class="lineCov">          1 :       source = mStream-&gt;mTrackSourceGetter-&gt;GetMediaStreamTrackSource(aTrackID);</span>
<span class="lineNum">     175 </span>            :     }
<span class="lineNum">     176 </span><span class="lineCov">          1 :     if (!source) {</span>
<span class="lineNum">     177 </span>            :       NS_ASSERTION(false, &quot;Dynamic track created without an explicit TrackSource&quot;);
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :       nsPIDOMWindowInner* window = mStream-&gt;GetParentObject();</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :       nsIDocument* doc = window ? window-&gt;GetExtantDoc() : nullptr;</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :       nsIPrincipal* principal = doc ? doc-&gt;NodePrincipal() : nullptr;</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :       source = new BasicTrackSource(principal);</span>
<span class="lineNum">     182 </span>            :     }
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span>            :     RefPtr&lt;MediaStreamTrack&gt; newTrack =
<span class="lineNum">     185 </span><span class="lineCov">          1 :       mStream-&gt;CreateDOMTrack(aTrackID, aType, source);</span>
<span class="lineNum">     186 </span>            :     NS_DispatchToMainThread(NewRunnableMethod&lt;RefPtr&lt;MediaStreamTrack&gt;&gt;(
<span class="lineNum">     187 </span><span class="lineCov">          1 :         mStream, &amp;DOMMediaStream::AddTrackInternal, newTrack));</span>
<a name="188"><span class="lineNum">     188 </span>            :   }</a>
<span class="lineNum">     189 </span>            : 
<span class="lineNum">     190 </span><span class="lineCov">          1 :   void DoNotifyTrackEnded(MediaStream* aInputStream, TrackID aInputTrackID,</span>
<span class="lineNum">     191 </span>            :                           TrackID aTrackID)
<span class="lineNum">     192 </span>            :   {
<span class="lineNum">     193 </span>            :     MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span><span class="lineCov">          1 :     if (!mStream) {</span>
<span class="lineNum">     196 </span><span class="lineCov">          1 :       return;</span>
<span class="lineNum">     197 </span>            :     }
<span class="lineNum">     198 </span>            : 
<span class="lineNum">     199 </span>            :     RefPtr&lt;MediaStreamTrack&gt; track =
<span class="lineNum">     200 </span><span class="lineCov">          1 :       mStream-&gt;FindOwnedDOMTrack(aInputStream, aInputTrackID, aTrackID);</span>
<span class="lineNum">     201 </span>            :     NS_ASSERTION(track, &quot;Owned MediaStreamTracks must be known by the DOMMediaStream&quot;);
<span class="lineNum">     202 </span><span class="lineCov">          1 :     if (track) {</span>
<span class="lineNum">     203 </span><span class="lineCov">          1 :       LOG(LogLevel::Debug, (&quot;DOMMediaStream %p MediaStreamTrack %p ended at the source. Marking it ended.&quot;,</span>
<span class="lineNum">     204 </span>            :                             mStream, track.get()));
<span class="lineNum">     205 </span>            :       NS_DispatchToMainThread(NewRunnableMethod(
<span class="lineNum">     206 </span><span class="lineCov">          1 :         track, &amp;MediaStreamTrack::OverrideEnded));</span>
<span class="lineNum">     207 </span><span class="lineCov">          1 :     }</span>
<a name="208"><span class="lineNum">     208 </span>            :   }</a>
<span class="lineNum">     209 </span>            : 
<span class="lineNum">     210 </span><span class="lineCov">          1 :   void NotifyQueuedTrackChanges(MediaStreamGraph* aGraph, TrackID aID,</span>
<span class="lineNum">     211 </span>            :                                 StreamTime aTrackOffset, TrackEventCommand aTrackEvents,
<span class="lineNum">     212 </span>            :                                 const MediaSegment&amp; aQueuedMedia,
<span class="lineNum">     213 </span>            :                                 MediaStream* aInputStream,
<span class="lineNum">     214 </span>            :                                 TrackID aInputTrackID) override
<span class="lineNum">     215 </span>            :   {
<span class="lineNum">     216 </span><span class="lineCov">          1 :     if (aTrackEvents &amp; TrackEventCommand::TRACK_EVENT_CREATED) {</span>
<span class="lineNum">     217 </span>            :       aGraph-&gt;DispatchToMainThreadAfterStreamStateUpdate(
<span class="lineNum">     218 </span>            :         mAbstractMainThread,
<span class="lineNum">     219 </span>            :         NewRunnableMethod&lt;TrackID, MediaSegment::Type, RefPtr&lt;MediaStream&gt;, TrackID&gt;(
<span class="lineNum">     220 </span>            :           this, &amp;OwnedStreamListener::DoNotifyTrackCreated,
<span class="lineNum">     221 </span><span class="lineCov">          1 :           aID, aQueuedMedia.GetType(), aInputStream, aInputTrackID));</span>
<span class="lineNum">     222 </span><span class="lineCov">          1 :     } else if (aTrackEvents &amp; TrackEventCommand::TRACK_EVENT_ENDED) {</span>
<span class="lineNum">     223 </span>            :       aGraph-&gt;DispatchToMainThreadAfterStreamStateUpdate(
<span class="lineNum">     224 </span>            :         mAbstractMainThread,
<span class="lineNum">     225 </span>            :         NewRunnableMethod&lt;RefPtr&lt;MediaStream&gt;, TrackID, TrackID&gt;(
<span class="lineNum">     226 </span>            :           this, &amp;OwnedStreamListener::DoNotifyTrackEnded,
<span class="lineNum">     227 </span><span class="lineCov">          1 :           aInputStream, aInputTrackID, aID));</span>
<span class="lineNum">     228 </span>            :     }
<span class="lineNum">     229 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     230 </span>            : 
<span class="lineNum">     231 </span>            : private:
<span class="lineNum">     232 </span>            :   // These fields may only be accessed on the main thread
<span class="lineNum">     233 </span>            :   DOMMediaStream* mStream;
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span>            :   const RefPtr&lt;AbstractThread&gt; mAbstractMainThread;
<span class="lineNum">     236 </span>            : };
<span class="lineNum">     237 </span>            : 
<span class="lineNum">     238 </span>            : /**
<span class="lineNum">     239 </span>            :  * Listener registered on the Playback stream to detect when tracks end and when
<span class="lineNum">     240 </span>            :  * all new tracks this iteration have been created - for when several tracks are
<a name="241"><span class="lineNum">     241 </span>            :  * queued by the source and committed all at once.</a>
<span class="lineNum">     242 </span>            :  */
<a name="243"><span class="lineNum">     243 </span><span class="lineCov">          1 : class DOMMediaStream::PlaybackStreamListener : public MediaStreamListener {</span></a>
<span class="lineNum">     244 </span>            : public:
<span class="lineNum">     245 </span><span class="lineCov">          1 :   explicit PlaybackStreamListener(DOMMediaStream* aStream)</span>
<span class="lineNum">     246 </span>            :     : mStream(aStream)
<span class="lineNum">     247 </span><span class="lineCov">          1 :     , mAbstractMainThread(aStream-&gt;mAbstractMainThread)</span>
<span class="lineNum">     248 </span><span class="lineCov">          1 :   {}</span>
<span class="lineNum">     249 </span>            : 
<span class="lineNum">     250 </span>            :   void Forget()
<span class="lineNum">     251 </span>            :   {
<span class="lineNum">     252 </span>            :     MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     253 </span><span class="lineCov">          1 :     mStream = nullptr;</span>
<a name="254"><span class="lineNum">     254 </span>            :   }</a>
<span class="lineNum">     255 </span>            : 
<span class="lineNum">     256 </span><span class="lineCov">          1 :   void DoNotifyFinishedTrackCreation()</span>
<span class="lineNum">     257 </span>            :   {
<span class="lineNum">     258 </span>            :     MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     259 </span>            : 
<span class="lineNum">     260 </span><span class="lineCov">          1 :     if (!mStream) {</span>
<span class="lineNum">     261 </span><span class="lineCov">          1 :       return;</span>
<span class="lineNum">     262 </span>            :     }
<span class="lineNum">     263 </span>            : 
<span class="lineNum">     264 </span>            :     // The owned stream listener adds its tracks after another main thread
<span class="lineNum">     265 </span>            :     // dispatch. We have to do the same to notify of created tracks to stay
<span class="lineNum">     266 </span>            :     // in sync. (Or NotifyTracksCreated is called before tracks are added).
<span class="lineNum">     267 </span>            :     NS_DispatchToMainThread(
<span class="lineNum">     268 </span><span class="lineCov">          1 :         NewRunnableMethod(mStream, &amp;DOMMediaStream::NotifyTracksCreated));</span>
<a name="269"><span class="lineNum">     269 </span>            :   }</a>
<span class="lineNum">     270 </span>            : 
<span class="lineNum">     271 </span><span class="lineCov">          1 :   void DoNotifyFinished()</span>
<span class="lineNum">     272 </span>            :   {
<span class="lineNum">     273 </span>            :     MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span><span class="lineCov">          1 :     if (!mStream) {</span>
<span class="lineNum">     276 </span><span class="lineCov">          1 :       return;</span>
<span class="lineNum">     277 </span>            :     }
<span class="lineNum">     278 </span>            : 
<span class="lineNum">     279 </span>            :     NS_DispatchToMainThread(NewRunnableMethod(
<span class="lineNum">     280 </span><span class="lineCov">          1 :       mStream, &amp;DOMMediaStream::NotifyFinished));</span>
<span class="lineNum">     281 </span>            :   }
<span class="lineNum">     282 </span>            : 
<a name="283"><span class="lineNum">     283 </span>            :   // The methods below are called on the MediaStreamGraph thread.</a>
<span class="lineNum">     284 </span>            : 
<span class="lineNum">     285 </span><span class="lineCov">          1 :   void NotifyFinishedTrackCreation(MediaStreamGraph* aGraph) override</span>
<span class="lineNum">     286 </span>            :   {
<span class="lineNum">     287 </span>            :     aGraph-&gt;DispatchToMainThreadAfterStreamStateUpdate(
<span class="lineNum">     288 </span>            :       mAbstractMainThread,
<span class="lineNum">     289 </span><span class="lineCov">          1 :       NewRunnableMethod(this, &amp;PlaybackStreamListener::DoNotifyFinishedTrackCreation));</span>
<span class="lineNum">     290 </span><span class="lineCov">          1 :   }</span>
<a name="291"><span class="lineNum">     291 </span>            : </a>
<span class="lineNum">     292 </span>            : 
<span class="lineNum">     293 </span><span class="lineCov">          1 :   void NotifyEvent(MediaStreamGraph* aGraph,</span>
<span class="lineNum">     294 </span>            :                    MediaStreamGraphEvent event) override
<span class="lineNum">     295 </span>            :   {
<span class="lineNum">     296 </span><span class="lineCov">          1 :     if (event == MediaStreamGraphEvent::EVENT_FINISHED) {</span>
<span class="lineNum">     297 </span>            :       aGraph-&gt;DispatchToMainThreadAfterStreamStateUpdate(
<span class="lineNum">     298 </span>            :         mAbstractMainThread,
<span class="lineNum">     299 </span><span class="lineCov">          1 :         NewRunnableMethod(this, &amp;PlaybackStreamListener::DoNotifyFinished));</span>
<span class="lineNum">     300 </span>            :     }
<span class="lineNum">     301 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span>            : private:
<span class="lineNum">     304 </span>            :   // These fields may only be accessed on the main thread
<span class="lineNum">     305 </span>            :   DOMMediaStream* mStream;
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span>            :   const RefPtr&lt;AbstractThread&gt; mAbstractMainThread;
<span class="lineNum">     308 </span>            : };
<span class="lineNum">     309 </span>            : 
<span class="lineNum">     310 </span>            : class DOMMediaStream::PlaybackTrackListener : public MediaStreamTrackConsumer
<a name="311"><span class="lineNum">     311 </span>            : {</a>
<span class="lineNum">     312 </span>            : public:
<span class="lineNum">     313 </span><span class="lineCov">          1 :   explicit PlaybackTrackListener(DOMMediaStream* aStream) :</span>
<span class="lineNum">     314 </span><span class="lineCov">          1 :     mStream(aStream) {}</span>
<a name="315"><span class="lineNum">     315 </span>            : </a>
<span class="lineNum">     316 </span>            :   NS_DECL_ISUPPORTS_INHERITED
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :   NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED(PlaybackTrackListener,</span>
<a name="318"><span class="lineNum">     318 </span>            :                                            MediaStreamTrackConsumer)</a>
<span class="lineNum">     319 </span>            : 
<span class="lineNum">     320 </span><span class="lineCov">          1 :   void NotifyEnded(MediaStreamTrack* aTrack) override</span>
<span class="lineNum">     321 </span>            :   {
<span class="lineNum">     322 </span><span class="lineCov">          1 :     if (!mStream) {</span>
<span class="lineNum">     323 </span>            :       MOZ_ASSERT(false);
<span class="lineNum">     324 </span>            :       return;
<span class="lineNum">     325 </span>            :     }
<span class="lineNum">     326 </span>            : 
<span class="lineNum">     327 </span><span class="lineCov">          1 :     if (!aTrack) {</span>
<span class="lineNum">     328 </span>            :       MOZ_ASSERT(false);
<span class="lineNum">     329 </span>            :       return;
<span class="lineNum">     330 </span>            :     }
<span class="lineNum">     331 </span>            : 
<span class="lineNum">     332 </span>            :     MOZ_ASSERT(mStream-&gt;HasTrack(*aTrack));
<span class="lineNum">     333 </span><span class="lineCov">          1 :     mStream-&gt;NotifyTrackRemoved(aTrack);</span>
<span class="lineNum">     334 </span>            :   }
<a name="335"><span class="lineNum">     335 </span>            : </a>
<span class="lineNum">     336 </span>            : protected:
<span class="lineNum">     337 </span><span class="lineCov">          1 :   virtual ~PlaybackTrackListener() {}</span>
<span class="lineNum">     338 </span>            : 
<span class="lineNum">     339 </span>            :   RefPtr&lt;DOMMediaStream&gt; mStream;
<a name="340"><span class="lineNum">     340 </span>            : };</a>
<span class="lineNum">     341 </span>            : 
<a name="342"><span class="lineNum">     342 </span><span class="lineCov">          1 : NS_IMPL_ADDREF_INHERITED(DOMMediaStream::PlaybackTrackListener,</span></a>
<span class="lineNum">     343 </span>            :                          MediaStreamTrackConsumer)
<a name="344"><span class="lineNum">     344 </span><span class="lineCov">          1 : NS_IMPL_RELEASE_INHERITED(DOMMediaStream::PlaybackTrackListener,</span></a>
<span class="lineNum">     345 </span>            :                           MediaStreamTrackConsumer)
<a name="346"><span class="lineNum">     346 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION_INHERITED(DOMMediaStream::PlaybackTrackListener)</span></a>
<span class="lineNum">     347 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_END_INHERITING(MediaStreamTrackConsumer)</span>
<span class="lineNum">     348 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_INHERITED(DOMMediaStream::PlaybackTrackListener,</span>
<span class="lineNum">     349 </span>            :                                    MediaStreamTrackConsumer,
<span class="lineNum">     350 </span>            :                                    mStream)
<span class="lineNum">     351 </span>            : 
<a name="352"><span class="lineNum">     352 </span>            : NS_IMPL_CYCLE_COLLECTION_CLASS(DOMMediaStream)</a>
<span class="lineNum">     353 </span>            : 
<span class="lineNum">     354 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN_INHERITED(DOMMediaStream,</span>
<span class="lineNum">     355 </span>            :                                                 DOMEventTargetHelper)
<span class="lineNum">     356 </span><span class="lineCov">          1 :   tmp-&gt;Destroy();</span>
<span class="lineNum">     357 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mWindow)</span>
<span class="lineNum">     358 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mOwnedTracks)</span>
<span class="lineNum">     359 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mTracks)</span>
<span class="lineNum">     360 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mConsumersToKeepAlive)</span>
<span class="lineNum">     361 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mTrackSourceGetter)</span>
<span class="lineNum">     362 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mPlaybackTrackListener)</span>
<span class="lineNum">     363 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mPrincipal)</span>
<span class="lineNum">     364 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mVideoPrincipal)</span>
<a name="365"><span class="lineNum">     365 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_UNLINK_END</span></a>
<span class="lineNum">     366 </span>            : 
<span class="lineNum">     367 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_INHERITED(DOMMediaStream,</span>
<span class="lineNum">     368 </span>            :                                                   DOMEventTargetHelper)
<span class="lineNum">     369 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mWindow)</span>
<span class="lineNum">     370 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mOwnedTracks)</span>
<span class="lineNum">     371 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mTracks)</span>
<span class="lineNum">     372 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mConsumersToKeepAlive)</span>
<span class="lineNum">     373 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mTrackSourceGetter)</span>
<span class="lineNum">     374 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mPlaybackTrackListener)</span>
<span class="lineNum">     375 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mPrincipal)</span>
<span class="lineNum">     376 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mVideoPrincipal)</span>
<a name="377"><span class="lineNum">     377 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END</span></a>
<a name="378"><span class="lineNum">     378 </span>            : </a>
<span class="lineNum">     379 </span><span class="lineCov">          1 : NS_IMPL_ADDREF_INHERITED(DOMMediaStream, DOMEventTargetHelper)</span>
<a name="380"><span class="lineNum">     380 </span><span class="lineCov">          1 : NS_IMPL_RELEASE_INHERITED(DOMMediaStream, DOMEventTargetHelper)</span></a>
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION_INHERITED(DOMMediaStream)</span>
<span class="lineNum">     383 </span><span class="lineCov">          1 :   NS_INTERFACE_MAP_ENTRY(DOMMediaStream)</span>
<a name="384"><span class="lineNum">     384 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_END_INHERITING(DOMEventTargetHelper)</span></a>
<a name="385"><span class="lineNum">     385 </span>            : </a>
<span class="lineNum">     386 </span><span class="lineCov">          1 : NS_IMPL_ADDREF_INHERITED(DOMLocalMediaStream, DOMMediaStream)</span>
<a name="387"><span class="lineNum">     387 </span><span class="lineCov">          1 : NS_IMPL_RELEASE_INHERITED(DOMLocalMediaStream, DOMMediaStream)</span></a>
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_BEGIN(DOMLocalMediaStream)</span>
<span class="lineNum">     390 </span><span class="lineCov">          1 :   NS_INTERFACE_MAP_ENTRY(DOMLocalMediaStream)</span>
<a name="391"><span class="lineNum">     391 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_END_INHERITING(DOMMediaStream)</span></a>
<span class="lineNum">     392 </span>            : 
<span class="lineNum">     393 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_INHERITED(DOMAudioNodeMediaStream, DOMMediaStream,</span>
<a name="394"><span class="lineNum">     394 </span>            :                                    mStreamNode)</a>
<a name="395"><span class="lineNum">     395 </span>            : </a>
<span class="lineNum">     396 </span><span class="lineCov">          1 : NS_IMPL_ADDREF_INHERITED(DOMAudioNodeMediaStream, DOMMediaStream)</span>
<a name="397"><span class="lineNum">     397 </span><span class="lineCov">          1 : NS_IMPL_RELEASE_INHERITED(DOMAudioNodeMediaStream, DOMMediaStream)</span></a>
<span class="lineNum">     398 </span>            : 
<span class="lineNum">     399 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION_INHERITED(DOMAudioNodeMediaStream)</span>
<a name="400"><span class="lineNum">     400 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_END_INHERITING(DOMMediaStream)</span></a>
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span><span class="lineCov">          1 : DOMMediaStream::DOMMediaStream(nsPIDOMWindowInner* aWindow,</span>
<span class="lineNum">     403 </span>            :                                MediaStreamTrackSourceGetter* aTrackSourceGetter)
<span class="lineNum">     404 </span>            :   : mLogicalStreamStartTime(0), mWindow(aWindow),
<span class="lineNum">     405 </span>            :     mInputStream(nullptr), mOwnedStream(nullptr), mPlaybackStream(nullptr),
<span class="lineNum">     406 </span>            :     mTracksPendingRemoval(0), mTrackSourceGetter(aTrackSourceGetter),
<span class="lineNum">     407 </span>            :     mPlaybackTrackListener(MakeAndAddRef&lt;PlaybackTrackListener&gt;(this)),
<span class="lineNum">     408 </span>            :     mTracksCreated(false), mNotifiedOfMediaStreamGraphShutdown(false),
<span class="lineNum">     409 </span>            :     mActive(false), mSetInactiveOnFinish(false),
<span class="lineNum">     410 </span><span class="lineCov">          1 :     mAbstractMainThread(aWindow-&gt;GetDocGroup()-&gt;AbstractMainThreadFor(TaskCategory::Other))</span>
<span class="lineNum">     411 </span>            : {
<span class="lineNum">     412 </span>            :   nsresult rv;
<span class="lineNum">     413 </span>            :   nsCOMPtr&lt;nsIUUIDGenerator&gt; uuidgen =
<span class="lineNum">     414 </span><span class="lineCov">          1 :     do_GetService(&quot;@mozilla.org/uuid-generator;1&quot;, &amp;rv);</span>
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span><span class="lineCov">          1 :   if (NS_SUCCEEDED(rv) &amp;&amp; uuidgen) {</span>
<span class="lineNum">     417 </span>            :     nsID uuid;
<span class="lineNum">     418 </span><span class="lineCov">          1 :     memset(&amp;uuid, 0, sizeof(uuid));</span>
<span class="lineNum">     419 </span><span class="lineCov">          1 :     rv = uuidgen-&gt;GenerateUUIDInPlace(&amp;uuid);</span>
<span class="lineNum">     420 </span><span class="lineCov">          1 :     if (NS_SUCCEEDED(rv)) {</span>
<span class="lineNum">     421 </span>            :       char buffer[NSID_LENGTH];
<span class="lineNum">     422 </span><span class="lineCov">          1 :       uuid.ToProvidedString(buffer);</span>
<span class="lineNum">     423 </span><span class="lineCov">          1 :       mID = NS_ConvertASCIItoUTF16(buffer);</span>
<span class="lineNum">     424 </span>            :     }
<span class="lineNum">     425 </span>            :   }
<a name="426"><span class="lineNum">     426 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     427 </span>            : 
<span class="lineNum">     428 </span><span class="lineCov">          1 : DOMMediaStream::~DOMMediaStream()</span>
<span class="lineNum">     429 </span>            : {
<span class="lineNum">     430 </span><span class="lineCov">          1 :   Destroy();</span>
<span class="lineNum">     431 </span><span class="lineCov">          1 : }</span>
<a name="432"><span class="lineNum">     432 </span>            : </a>
<span class="lineNum">     433 </span>            : void
<span class="lineNum">     434 </span><span class="lineCov">          1 : DOMMediaStream::Destroy()</span>
<span class="lineNum">     435 </span>            : {
<span class="lineNum">     436 </span><span class="lineCov">          1 :   LOG(LogLevel::Debug, (&quot;DOMMediaStream %p Being destroyed.&quot;, this));</span>
<span class="lineNum">     437 </span><span class="lineCov">          1 :   if (mOwnedListener) {</span>
<span class="lineNum">     438 </span><span class="lineCov">          1 :     mOwnedListener-&gt;Forget();</span>
<span class="lineNum">     439 </span><span class="lineCov">          1 :     mOwnedListener = nullptr;</span>
<span class="lineNum">     440 </span>            :   }
<span class="lineNum">     441 </span><span class="lineCov">          1 :   if (mPlaybackListener) {</span>
<span class="lineNum">     442 </span><span class="lineCov">          1 :     mPlaybackListener-&gt;Forget();</span>
<span class="lineNum">     443 </span><span class="lineCov">          1 :     mPlaybackListener = nullptr;</span>
<span class="lineNum">     444 </span>            :   }
<span class="lineNum">     445 </span><span class="lineCov">          1 :   for (const RefPtr&lt;TrackPort&gt;&amp; info : mTracks) {</span>
<span class="lineNum">     446 </span>            :     // We must remove ourselves from each track's principal change observer list
<span class="lineNum">     447 </span>            :     // before we die. CC may have cleared info-&gt;mTrack so guard against it.
<span class="lineNum">     448 </span><span class="lineCov">          1 :     MediaStreamTrack* track = info-&gt;GetTrack();</span>
<span class="lineNum">     449 </span><span class="lineCov">          1 :     if (track) {</span>
<span class="lineNum">     450 </span><span class="lineCov">          1 :       track-&gt;RemovePrincipalChangeObserver(this);</span>
<span class="lineNum">     451 </span><span class="lineCov">          1 :       if (!track-&gt;Ended()) {</span>
<span class="lineNum">     452 </span><span class="lineCov">          1 :         track-&gt;RemoveConsumer(mPlaybackTrackListener);</span>
<span class="lineNum">     453 </span>            :       }
<span class="lineNum">     454 </span>            :     }
<span class="lineNum">     455 </span>            :   }
<span class="lineNum">     456 </span><span class="lineCov">          1 :   if (mPlaybackPort) {</span>
<span class="lineNum">     457 </span><span class="lineCov">          1 :     mPlaybackPort-&gt;Destroy();</span>
<span class="lineNum">     458 </span><span class="lineCov">          1 :     mPlaybackPort = nullptr;</span>
<span class="lineNum">     459 </span>            :   }
<span class="lineNum">     460 </span><span class="lineCov">          1 :   if (mOwnedPort) {</span>
<span class="lineNum">     461 </span><span class="lineCov">          1 :     mOwnedPort-&gt;Destroy();</span>
<span class="lineNum">     462 </span><span class="lineCov">          1 :     mOwnedPort = nullptr;</span>
<span class="lineNum">     463 </span>            :   }
<span class="lineNum">     464 </span><span class="lineCov">          1 :   if (mPlaybackStream) {</span>
<span class="lineNum">     465 </span><span class="lineCov">          1 :     mPlaybackStream-&gt;UnregisterUser();</span>
<span class="lineNum">     466 </span><span class="lineCov">          1 :     mPlaybackStream = nullptr;</span>
<span class="lineNum">     467 </span>            :   }
<span class="lineNum">     468 </span><span class="lineCov">          1 :   if (mOwnedStream) {</span>
<span class="lineNum">     469 </span><span class="lineCov">          1 :     mOwnedStream-&gt;UnregisterUser();</span>
<span class="lineNum">     470 </span><span class="lineCov">          1 :     mOwnedStream = nullptr;</span>
<span class="lineNum">     471 </span>            :   }
<span class="lineNum">     472 </span><span class="lineCov">          1 :   if (mInputStream) {</span>
<span class="lineNum">     473 </span><span class="lineCov">          1 :     mInputStream-&gt;UnregisterUser();</span>
<span class="lineNum">     474 </span><span class="lineCov">          1 :     mInputStream = nullptr;</span>
<span class="lineNum">     475 </span>            :   }
<span class="lineNum">     476 </span><span class="lineCov">          1 :   mRunOnTracksAvailable.Clear();</span>
<span class="lineNum">     477 </span><span class="lineCov">          1 :   mTrackListeners.Clear();</span>
<span class="lineNum">     478 </span><span class="lineCov">          1 : }</span>
<a name="479"><span class="lineNum">     479 </span>            : </a>
<span class="lineNum">     480 </span>            : JSObject*
<span class="lineNum">     481 </span><span class="lineCov">          1 : DOMMediaStream::WrapObject(JSContext* aCx, JS::Handle&lt;JSObject*&gt; aGivenProto)</span>
<span class="lineNum">     482 </span>            : {
<span class="lineNum">     483 </span><span class="lineCov">          1 :   return dom::MediaStreamBinding::Wrap(aCx, this, aGivenProto);</span>
<span class="lineNum">     484 </span>            : }
<a name="485"><span class="lineNum">     485 </span>            : </a>
<span class="lineNum">     486 </span>            : /* static */ already_AddRefed&lt;DOMMediaStream&gt;
<span class="lineNum">     487 </span><span class="lineCov">          1 : DOMMediaStream::Constructor(const GlobalObject&amp; aGlobal,</span>
<span class="lineNum">     488 </span>            :                             ErrorResult&amp; aRv)
<span class="lineNum">     489 </span>            : {
<span class="lineNum">     490 </span>            :   Sequence&lt;OwningNonNull&lt;MediaStreamTrack&gt;&gt; emptyTrackSeq;
<span class="lineNum">     491 </span><span class="lineCov">          1 :   return Constructor(aGlobal, emptyTrackSeq, aRv);</span>
<span class="lineNum">     492 </span>            : }
<a name="493"><span class="lineNum">     493 </span>            : </a>
<span class="lineNum">     494 </span>            : /* static */ already_AddRefed&lt;DOMMediaStream&gt;
<span class="lineNum">     495 </span><span class="lineCov">          1 : DOMMediaStream::Constructor(const GlobalObject&amp; aGlobal,</span>
<span class="lineNum">     496 </span>            :                             const DOMMediaStream&amp; aStream,
<span class="lineNum">     497 </span>            :                             ErrorResult&amp; aRv)
<span class="lineNum">     498 </span>            : {
<span class="lineNum">     499 </span>            :   nsTArray&lt;RefPtr&lt;MediaStreamTrack&gt;&gt; tracks;
<span class="lineNum">     500 </span><span class="lineCov">          1 :   aStream.GetTracks(tracks);</span>
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span>            :   Sequence&lt;OwningNonNull&lt;MediaStreamTrack&gt;&gt; nonNullTrackSeq;
<span class="lineNum">     503 </span><span class="lineCov">          1 :   if (!nonNullTrackSeq.SetLength(tracks.Length(), fallible)) {</span>
<span class="lineNum">     504 </span>            :     MOZ_ASSERT(false);
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :     aRv.Throw(NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     507 </span>            :   }
<span class="lineNum">     508 </span>            : 
<span class="lineNum">     509 </span><span class="lineCov">          1 :   for (size_t i = 0; i &lt; tracks.Length(); ++i) {</span>
<span class="lineNum">     510 </span><span class="lineCov">          1 :     nonNullTrackSeq[i] = tracks[i];</span>
<span class="lineNum">     511 </span>            :   }
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span><span class="lineCov">          1 :   return Constructor(aGlobal, nonNullTrackSeq, aRv);</span>
<span class="lineNum">     514 </span>            : }
<a name="515"><span class="lineNum">     515 </span>            : </a>
<span class="lineNum">     516 </span>            : /* static */ already_AddRefed&lt;DOMMediaStream&gt;
<span class="lineNum">     517 </span><span class="lineCov">          1 : DOMMediaStream::Constructor(const GlobalObject&amp; aGlobal,</span>
<span class="lineNum">     518 </span>            :                             const Sequence&lt;OwningNonNull&lt;MediaStreamTrack&gt;&gt;&amp; aTracks,
<span class="lineNum">     519 </span>            :                             ErrorResult&amp; aRv)
<span class="lineNum">     520 </span>            : {
<span class="lineNum">     521 </span><span class="lineCov">          1 :   nsCOMPtr&lt;nsPIDOMWindowInner&gt; ownerWindow = do_QueryInterface(aGlobal.GetAsSupports());</span>
<span class="lineNum">     522 </span><span class="lineCov">          1 :   if (!ownerWindow) {</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :     aRv.Throw(NS_ERROR_FAILURE);</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     525 </span>            :   }
<span class="lineNum">     526 </span>            : 
<span class="lineNum">     527 </span>            :   // Streams created from JS cannot have dynamically created tracks.
<span class="lineNum">     528 </span><span class="lineCov">          1 :   MediaStreamTrackSourceGetter* getter = nullptr;</span>
<span class="lineNum">     529 </span><span class="lineCov">          1 :   RefPtr&lt;DOMMediaStream&gt; newStream = new DOMMediaStream(ownerWindow, getter);</span>
<span class="lineNum">     530 </span>            : 
<span class="lineNum">     531 </span><span class="lineCov">          1 :   for (MediaStreamTrack&amp; track : aTracks) {</span>
<span class="lineNum">     532 </span><span class="lineCov">          1 :     if (!newStream-&gt;GetPlaybackStream()) {</span>
<span class="lineNum">     533 </span><span class="lineCov">          1 :       MOZ_RELEASE_ASSERT(track.Graph());</span>
<span class="lineNum">     534 </span><span class="lineCov">          1 :       newStream-&gt;InitPlaybackStreamCommon(track.Graph());</span>
<span class="lineNum">     535 </span>            :     }
<span class="lineNum">     536 </span><span class="lineCov">          1 :     newStream-&gt;AddTrack(track);</span>
<span class="lineNum">     537 </span>            :   }
<span class="lineNum">     538 </span>            : 
<span class="lineNum">     539 </span><span class="lineCov">          1 :   if (!newStream-&gt;GetPlaybackStream()) {</span>
<span class="lineNum">     540 </span>            :     MOZ_ASSERT(aTracks.IsEmpty());
<span class="lineNum">     541 </span>            :     MediaStreamGraph* graph =
<span class="lineNum">     542 </span>            :       MediaStreamGraph::GetInstance(MediaStreamGraph::SYSTEM_THREAD_DRIVER,
<span class="lineNum">     543 </span><span class="lineCov">          1 :                                     AudioChannel::Normal);</span>
<span class="lineNum">     544 </span><span class="lineCov">          1 :     newStream-&gt;InitPlaybackStreamCommon(graph);</span>
<span class="lineNum">     545 </span>            :   }
<span class="lineNum">     546 </span>            : 
<span class="lineNum">     547 </span>            :   return newStream.forget();
<span class="lineNum">     548 </span>            : }
<a name="549"><span class="lineNum">     549 </span>            : </a>
<span class="lineNum">     550 </span>            : double
<span class="lineNum">     551 </span><span class="lineCov">          1 : DOMMediaStream::CurrentTime()</span>
<span class="lineNum">     552 </span>            : {
<span class="lineNum">     553 </span><span class="lineCov">          1 :   if (!mPlaybackStream) {</span>
<span class="lineNum">     554 </span>            :     return 0.0;
<span class="lineNum">     555 </span>            :   }
<span class="lineNum">     556 </span>            :   return mPlaybackStream-&gt;
<span class="lineNum">     557 </span><span class="lineCov">          1 :     StreamTimeToSeconds(mPlaybackStream-&gt;GetCurrentTime() - mLogicalStreamStartTime);</span>
<span class="lineNum">     558 </span>            : }
<a name="559"><span class="lineNum">     559 </span>            : </a>
<span class="lineNum">     560 </span>            : void
<span class="lineNum">     561 </span><span class="lineCov">          1 : DOMMediaStream::GetId(nsAString&amp; aID) const</span>
<span class="lineNum">     562 </span>            : {
<span class="lineNum">     563 </span><span class="lineCov">          1 :   aID = mID;</span>
<span class="lineNum">     564 </span><span class="lineCov">          1 : }</span>
<a name="565"><span class="lineNum">     565 </span>            : </a>
<span class="lineNum">     566 </span>            : void
<span class="lineNum">     567 </span><span class="lineCov">          1 : DOMMediaStream::GetAudioTracks(nsTArray&lt;RefPtr&lt;AudioStreamTrack&gt; &gt;&amp; aTracks) const</span>
<span class="lineNum">     568 </span>            : {
<span class="lineNum">     569 </span><span class="lineCov">          1 :   for (const RefPtr&lt;TrackPort&gt;&amp; info : mTracks) {</span>
<span class="lineNum">     570 </span><span class="lineCov">          1 :     AudioStreamTrack* t = info-&gt;GetTrack()-&gt;AsAudioStreamTrack();</span>
<span class="lineNum">     571 </span><span class="lineCov">          1 :     if (t) {</span>
<span class="lineNum">     572 </span><span class="lineCov">          1 :       aTracks.AppendElement(t);</span>
<span class="lineNum">     573 </span>            :     }
<span class="lineNum">     574 </span>            :   }
<span class="lineNum">     575 </span><span class="lineCov">          1 : }</span>
<a name="576"><span class="lineNum">     576 </span>            : </a>
<span class="lineNum">     577 </span>            : void
<span class="lineNum">     578 </span><span class="lineCov">          1 : DOMMediaStream::GetVideoTracks(nsTArray&lt;RefPtr&lt;VideoStreamTrack&gt; &gt;&amp; aTracks) const</span>
<span class="lineNum">     579 </span>            : {
<span class="lineNum">     580 </span><span class="lineCov">          1 :   for (const RefPtr&lt;TrackPort&gt;&amp; info : mTracks) {</span>
<span class="lineNum">     581 </span><span class="lineCov">          1 :     VideoStreamTrack* t = info-&gt;GetTrack()-&gt;AsVideoStreamTrack();</span>
<span class="lineNum">     582 </span><span class="lineCov">          1 :     if (t) {</span>
<span class="lineNum">     583 </span><span class="lineCov">          1 :       aTracks.AppendElement(t);</span>
<span class="lineNum">     584 </span>            :     }
<span class="lineNum">     585 </span>            :   }
<span class="lineNum">     586 </span><span class="lineCov">          1 : }</span>
<a name="587"><span class="lineNum">     587 </span>            : </a>
<span class="lineNum">     588 </span>            : void
<span class="lineNum">     589 </span><span class="lineCov">          1 : DOMMediaStream::GetTracks(nsTArray&lt;RefPtr&lt;MediaStreamTrack&gt; &gt;&amp; aTracks) const</span>
<span class="lineNum">     590 </span>            : {
<span class="lineNum">     591 </span><span class="lineCov">          1 :   for (const RefPtr&lt;TrackPort&gt;&amp; info : mTracks) {</span>
<span class="lineNum">     592 </span><span class="lineCov">          1 :     aTracks.AppendElement(info-&gt;GetTrack());</span>
<span class="lineNum">     593 </span>            :   }
<span class="lineNum">     594 </span><span class="lineCov">          1 : }</span>
<a name="595"><span class="lineNum">     595 </span>            : </a>
<span class="lineNum">     596 </span>            : void
<span class="lineNum">     597 </span><span class="lineCov">          1 : DOMMediaStream::AddTrack(MediaStreamTrack&amp; aTrack)</span>
<span class="lineNum">     598 </span>            : {
<span class="lineNum">     599 </span><span class="lineCov">          1 :   MOZ_RELEASE_ASSERT(mPlaybackStream);</span>
<span class="lineNum">     600 </span>            : 
<span class="lineNum">     601 </span><span class="lineCov">          1 :   RefPtr&lt;ProcessedMediaStream&gt; dest = mPlaybackStream-&gt;AsProcessedStream();</span>
<span class="lineNum">     602 </span>            :   MOZ_ASSERT(dest);
<span class="lineNum">     603 </span><span class="lineCov">          1 :   if (!dest) {</span>
<span class="lineNum">     604 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">     605 </span>            :   }
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span><span class="lineCov">          1 :   LOG(LogLevel::Info, (&quot;DOMMediaStream %p Adding track %p (from stream %p with ID %d)&quot;,</span>
<span class="lineNum">     608 </span>            :                        this, &amp;aTrack, aTrack.mOwningStream.get(), aTrack.mTrackID));
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span><span class="lineCov">          1 :   if (mPlaybackStream-&gt;Graph() != aTrack.Graph()) {</span>
<span class="lineNum">     611 </span>            :     NS_ASSERTION(false, &quot;Cannot combine tracks from different MediaStreamGraphs&quot;);
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :     LOG(LogLevel::Error, (&quot;DOMMediaStream %p Own MSG %p != aTrack's MSG %p&quot;,</span>
<span class="lineNum">     613 </span>            :                          this, mPlaybackStream-&gt;Graph(), aTrack.Graph()));
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :     nsAutoString trackId;</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :     aTrack.GetId(trackId);</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :     const char16_t* params[] = { trackId.get() };</span>
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsPIDOMWindowInner&gt; pWindow = GetParentObject();</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :     nsIDocument* document = pWindow ? pWindow-&gt;GetExtantDoc() : nullptr;</span>
<span class="lineNum">     620 </span>            :     nsContentUtils::ReportToConsole(nsIScriptError::errorFlag,
<span class="lineNum">     621 </span>            :                                     NS_LITERAL_CSTRING(&quot;Media&quot;),
<span class="lineNum">     622 </span>            :                                     document,
<span class="lineNum">     623 </span>            :                                     nsContentUtils::eDOM_PROPERTIES,
<span class="lineNum">     624 </span>            :                                     &quot;MediaStreamAddTrackDifferentAudioChannel&quot;,
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :                                     params, ArrayLength(params));</span>
<span class="lineNum">     626 </span>            :     return;
<span class="lineNum">     627 </span>            :   }
<span class="lineNum">     628 </span>            : 
<span class="lineNum">     629 </span><span class="lineCov">          1 :   if (HasTrack(aTrack)) {</span>
<span class="lineNum">     630 </span><span class="lineCov">          1 :     LOG(LogLevel::Debug, (&quot;DOMMediaStream %p already contains track %p&quot;, this, &amp;aTrack));</span>
<span class="lineNum">     631 </span>            :     return;
<span class="lineNum">     632 </span>            :   }
<span class="lineNum">     633 </span>            : 
<span class="lineNum">     634 </span>            :   // Hook up the underlying track with our underlying playback stream.
<span class="lineNum">     635 </span>            :   RefPtr&lt;MediaInputPort&gt; inputPort =
<span class="lineNum">     636 </span><span class="lineCov">          1 :     GetPlaybackStream()-&gt;AllocateInputPort(aTrack.GetOwnedStream(),</span>
<span class="lineNum">     637 </span><span class="lineCov">          1 :                                            aTrack.mTrackID);</span>
<span class="lineNum">     638 </span>            :   RefPtr&lt;TrackPort&gt; trackPort =
<span class="lineNum">     639 </span><span class="lineCov">          1 :     new TrackPort(inputPort, &amp;aTrack, TrackPort::InputPortOwnership::OWNED);</span>
<span class="lineNum">     640 </span><span class="lineCov">          1 :   mTracks.AppendElement(trackPort.forget());</span>
<span class="lineNum">     641 </span><span class="lineCov">          1 :   NotifyTrackAdded(&amp;aTrack);</span>
<span class="lineNum">     642 </span>            : 
<span class="lineNum">     643 </span><span class="lineCov">          1 :   LOG(LogLevel::Debug, (&quot;DOMMediaStream %p Added track %p&quot;, this, &amp;aTrack));</span>
<span class="lineNum">     644 </span>            : }
<a name="645"><span class="lineNum">     645 </span>            : </a>
<span class="lineNum">     646 </span>            : void
<span class="lineNum">     647 </span><span class="lineCov">          1 : DOMMediaStream::RemoveTrack(MediaStreamTrack&amp; aTrack)</span>
<span class="lineNum">     648 </span>            : {
<span class="lineNum">     649 </span><span class="lineCov">          1 :   LOG(LogLevel::Info, (&quot;DOMMediaStream %p Removing track %p (from stream %p with ID %d)&quot;,</span>
<span class="lineNum">     650 </span>            :                        this, &amp;aTrack, aTrack.mOwningStream.get(), aTrack.mTrackID));
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span><span class="lineCov">          1 :   RefPtr&lt;TrackPort&gt; toRemove = FindPlaybackTrackPort(aTrack);</span>
<span class="lineNum">     653 </span><span class="lineCov">          1 :   if (!toRemove) {</span>
<span class="lineNum">     654 </span><span class="lineCov">          1 :     LOG(LogLevel::Debug, (&quot;DOMMediaStream %p does not contain track %p&quot;, this, &amp;aTrack));</span>
<span class="lineNum">     655 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">     656 </span>            :   }
<span class="lineNum">     657 </span>            : 
<span class="lineNum">     658 </span><span class="lineCov">          1 :   DebugOnly&lt;bool&gt; removed = mTracks.RemoveElement(toRemove);</span>
<span class="lineNum">     659 </span>            :   NS_ASSERTION(removed, &quot;If there's a track port we should be able to remove it&quot;);
<span class="lineNum">     660 </span>            : 
<span class="lineNum">     661 </span>            :   // If the track comes from a TRACK_ANY input port (i.e., mOwnedPort), we need
<span class="lineNum">     662 </span>            :   // to block it in the port. Doing this for a locked track is still OK as it
<span class="lineNum">     663 </span>            :   // will first block the track, then destroy the port. Both cause the track to
<span class="lineNum">     664 </span>            :   // end.
<span class="lineNum">     665 </span>            :   // If the track has already ended, it's input port might be gone, so in those
<span class="lineNum">     666 </span>            :   // cases blocking the underlying track should be avoided.
<span class="lineNum">     667 </span><span class="lineCov">          1 :   if (!aTrack.Ended()) {</span>
<span class="lineNum">     668 </span><span class="lineCov">          1 :     BlockPlaybackTrack(toRemove);</span>
<span class="lineNum">     669 </span><span class="lineCov">          1 :     NotifyTrackRemoved(&amp;aTrack);</span>
<span class="lineNum">     670 </span>            :   }
<span class="lineNum">     671 </span>            : 
<span class="lineNum">     672 </span><span class="lineCov">          1 :   LOG(LogLevel::Debug, (&quot;DOMMediaStream %p Removed track %p&quot;, this, &amp;aTrack));</span>
<span class="lineNum">     673 </span>            : }
<span class="lineNum">     674 </span>            : 
<span class="lineNum">     675 </span>            : class ClonedStreamSourceGetter :
<span class="lineNum">     676 </span>            :   public MediaStreamTrackSourceGetter
<span class="lineNum">     677 </span>            : {
<a name="678"><span class="lineNum">     678 </span>            : public:</a>
<span class="lineNum">     679 </span>            :   NS_DECL_ISUPPORTS_INHERITED
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :   NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED(ClonedStreamSourceGetter,</span>
<a name="681"><span class="lineNum">     681 </span>            :                                            MediaStreamTrackSourceGetter)</a>
<span class="lineNum">     682 </span>            : 
<span class="lineNum">     683 </span><span class="lineCov">          1 :   explicit ClonedStreamSourceGetter(DOMMediaStream* aStream)</span>
<span class="lineNum">     684 </span><span class="lineCov">          1 :     : mStream(aStream) {}</span>
<a name="685"><span class="lineNum">     685 </span>            : </a>
<span class="lineNum">     686 </span>            :   already_AddRefed&lt;MediaStreamTrackSource&gt;
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :   GetMediaStreamTrackSource(TrackID aInputTrackID) override</span>
<span class="lineNum">     688 </span>            :   {
<span class="lineNum">     689 </span>            :     MediaStreamTrack* sourceTrack =
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :       mStream-&gt;FindOwnedDOMTrack(mStream-&gt;GetOwnedStream(), aInputTrackID);</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :     MOZ_RELEASE_ASSERT(sourceTrack);</span>
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :     return do_AddRef(&amp;sourceTrack-&gt;GetSource());</span>
<span class="lineNum">     694 </span>            :   }
<a name="695"><span class="lineNum">     695 </span>            : </a>
<span class="lineNum">     696 </span>            : protected:
<span class="lineNum">     697 </span><span class="lineCov">          1 :   virtual ~ClonedStreamSourceGetter() {}</span>
<span class="lineNum">     698 </span>            : 
<span class="lineNum">     699 </span>            :   RefPtr&lt;DOMMediaStream&gt; mStream;
<a name="700"><span class="lineNum">     700 </span>            : };</a>
<span class="lineNum">     701 </span>            : 
<a name="702"><span class="lineNum">     702 </span><span class="lineCov">          1 : NS_IMPL_ADDREF_INHERITED(ClonedStreamSourceGetter,</span></a>
<span class="lineNum">     703 </span>            :                          MediaStreamTrackSourceGetter)
<a name="704"><span class="lineNum">     704 </span><span class="lineCov">          1 : NS_IMPL_RELEASE_INHERITED(ClonedStreamSourceGetter,</span></a>
<span class="lineNum">     705 </span>            :                           MediaStreamTrackSourceGetter)
<a name="706"><span class="lineNum">     706 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION_INHERITED(ClonedStreamSourceGetter)</span></a>
<span class="lineNum">     707 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_END_INHERITING(MediaStreamTrackSourceGetter)</span>
<span class="lineNum">     708 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_INHERITED(ClonedStreamSourceGetter,</span>
<span class="lineNum">     709 </span>            :                                    MediaStreamTrackSourceGetter,
<span class="lineNum">     710 </span>            :                                    mStream)
<a name="711"><span class="lineNum">     711 </span>            : </a>
<span class="lineNum">     712 </span>            : already_AddRefed&lt;DOMMediaStream&gt;
<span class="lineNum">     713 </span><span class="lineCov">          1 : DOMMediaStream::Clone()</span>
<span class="lineNum">     714 </span>            : {
<span class="lineNum">     715 </span><span class="lineCov">          1 :   return CloneInternal(TrackForwardingOption::CURRENT);</span>
<span class="lineNum">     716 </span>            : }
<a name="717"><span class="lineNum">     717 </span>            : </a>
<span class="lineNum">     718 </span>            : already_AddRefed&lt;DOMMediaStream&gt;
<span class="lineNum">     719 </span><span class="lineCov">          1 : DOMMediaStream::CloneInternal(TrackForwardingOption aForwarding)</span>
<span class="lineNum">     720 </span>            : {
<span class="lineNum">     721 </span>            :   RefPtr&lt;DOMMediaStream&gt; newStream =
<span class="lineNum">     722 </span><span class="lineCov">          1 :     new DOMMediaStream(GetParentObject(), new ClonedStreamSourceGetter(this));</span>
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span><span class="lineCov">          1 :   LOG(LogLevel::Info, (&quot;DOMMediaStream %p created clone %p, forwarding %s tracks&quot;,</span>
<span class="lineNum">     725 </span>            :                        this, newStream.get(),
<span class="lineNum">     726 </span>            :                        aForwarding == TrackForwardingOption::ALL
<span class="lineNum">     727 </span>            :                        ? &quot;all&quot; : &quot;current&quot;));
<span class="lineNum">     728 </span>            : 
<span class="lineNum">     729 </span><span class="lineCov">          1 :   MOZ_RELEASE_ASSERT(mPlaybackStream);</span>
<span class="lineNum">     730 </span><span class="lineCov">          1 :   MOZ_RELEASE_ASSERT(mPlaybackStream-&gt;Graph());</span>
<span class="lineNum">     731 </span><span class="lineCov">          1 :   MediaStreamGraph* graph = mPlaybackStream-&gt;Graph();</span>
<span class="lineNum">     732 </span>            : 
<span class="lineNum">     733 </span>            :   // We initiate the owned and playback streams first, since we need to create
<span class="lineNum">     734 </span>            :   // all existing DOM tracks before we add the generic input port from
<span class="lineNum">     735 </span>            :   // mInputStream to mOwnedStream (see AllocateInputPort wrt. destination
<span class="lineNum">     736 </span>            :   // TrackID as to why).
<span class="lineNum">     737 </span><span class="lineCov">          1 :   newStream-&gt;InitOwnedStreamCommon(graph);</span>
<span class="lineNum">     738 </span><span class="lineCov">          1 :   newStream-&gt;InitPlaybackStreamCommon(graph);</span>
<span class="lineNum">     739 </span>            : 
<span class="lineNum">     740 </span>            :   // Set up existing DOM tracks.
<span class="lineNum">     741 </span><span class="lineCov">          1 :   TrackID allocatedTrackID = 1;</span>
<span class="lineNum">     742 </span><span class="lineCov">          1 :   for (const RefPtr&lt;TrackPort&gt;&amp; info : mTracks) {</span>
<span class="lineNum">     743 </span><span class="lineCov">          1 :     MediaStreamTrack&amp; track = *info-&gt;GetTrack();</span>
<span class="lineNum">     744 </span>            : 
<span class="lineNum">     745 </span><span class="lineCov">          1 :     LOG(LogLevel::Debug, (&quot;DOMMediaStream %p forwarding external track %p to clone %p&quot;,</span>
<span class="lineNum">     746 </span>            :                           this, &amp;track, newStream.get()));
<span class="lineNum">     747 </span>            :     RefPtr&lt;MediaStreamTrack&gt; trackClone =
<span class="lineNum">     748 </span><span class="lineCov">          1 :       newStream-&gt;CloneDOMTrack(track, allocatedTrackID++);</span>
<span class="lineNum">     749 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     750 </span>            : 
<span class="lineNum">     751 </span><span class="lineCov">          1 :   if (aForwarding == TrackForwardingOption::ALL) {</span>
<span class="lineNum">     752 </span>            :     // Set up an input port from our input stream to the new DOM stream's owned
<span class="lineNum">     753 </span>            :     // stream, to allow for dynamically added tracks at the source to appear in
<span class="lineNum">     754 </span>            :     // the clone. The clone may treat mInputStream as its own mInputStream but
<span class="lineNum">     755 </span>            :     // ownership remains with us.
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :     newStream-&gt;mInputStream = mInputStream;</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :     if (mInputStream) {</span>
<span class="lineNum">     758 </span>            :       // We have already set up track-locked input ports for all existing DOM
<span class="lineNum">     759 </span>            :       // tracks, so now we need to block those in the generic input port to
<span class="lineNum">     760 </span>            :       // avoid ending up with double instances of them.
<span class="lineNum">     761 </span>            :       nsTArray&lt;TrackID&gt; tracksToBlock;
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :       for (const RefPtr&lt;TrackPort&gt;&amp; info : mOwnedTracks) {</span>
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :         tracksToBlock.AppendElement(info-&gt;GetTrack()-&gt;mTrackID);</span>
<span class="lineNum">     764 </span>            :       }
<span class="lineNum">     765 </span>            : 
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :       newStream-&gt;mInputStream-&gt;RegisterUser();</span>
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :       newStream-&gt;mOwnedPort =</span>
<span class="lineNum">     768 </span>            :         newStream-&gt;mOwnedStream-&gt;AllocateInputPort(mInputStream,
<span class="lineNum">     769 </span>            :                                                    TRACK_ANY, TRACK_ANY, 0, 0,
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :                                                    &amp;tracksToBlock);</span>
<span class="lineNum">     771 </span>            :     }
<span class="lineNum">     772 </span>            :   }
<span class="lineNum">     773 </span>            : 
<span class="lineNum">     774 </span><span class="lineCov">          1 :   return newStream.forget();</span>
<span class="lineNum">     775 </span>            : }
<a name="776"><span class="lineNum">     776 </span>            : </a>
<span class="lineNum">     777 </span>            : bool
<span class="lineNum">     778 </span><span class="lineCov">          1 : DOMMediaStream::Active() const</span>
<span class="lineNum">     779 </span>            : {
<span class="lineNum">     780 </span><span class="lineCov">          1 :   return mActive;</span>
<span class="lineNum">     781 </span>            : }
<a name="782"><span class="lineNum">     782 </span>            : </a>
<span class="lineNum">     783 </span>            : MediaStreamTrack*
<span class="lineNum">     784 </span><span class="lineCov">          1 : DOMMediaStream::GetTrackById(const nsAString&amp; aId) const</span>
<span class="lineNum">     785 </span>            : {
<span class="lineNum">     786 </span><span class="lineCov">          1 :   for (const RefPtr&lt;TrackPort&gt;&amp; info : mTracks) {</span>
<span class="lineNum">     787 </span>            :     nsString id;
<span class="lineNum">     788 </span><span class="lineCov">          1 :     info-&gt;GetTrack()-&gt;GetId(id);</span>
<span class="lineNum">     789 </span><span class="lineCov">          1 :     if (id == aId) {</span>
<span class="lineNum">     790 </span><span class="lineCov">          1 :       return info-&gt;GetTrack();</span>
<span class="lineNum">     791 </span>            :     }
<span class="lineNum">     792 </span>            :   }
<span class="lineNum">     793 </span><span class="lineCov">          1 :   return nullptr;</span>
<span class="lineNum">     794 </span>            : }
<a name="795"><span class="lineNum">     795 </span>            : </a>
<span class="lineNum">     796 </span>            : MediaStreamTrack*
<span class="lineNum">     797 </span><span class="lineNoCov">          0 : DOMMediaStream::GetOwnedTrackById(const nsAString&amp; aId)</span>
<span class="lineNum">     798 </span>            : {
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :   for (const RefPtr&lt;TrackPort&gt;&amp; info : mOwnedTracks) {</span>
<span class="lineNum">     800 </span>            :     nsString id;
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :     info-&gt;GetTrack()-&gt;GetId(id);</span>
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :     if (id == aId) {</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :       return info-&gt;GetTrack();</span>
<span class="lineNum">     804 </span>            :     }
<span class="lineNum">     805 </span>            :   }
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :   return nullptr;</span>
<span class="lineNum">     807 </span>            : }
<a name="808"><span class="lineNum">     808 </span>            : </a>
<span class="lineNum">     809 </span>            : bool
<span class="lineNum">     810 </span><span class="lineCov">          1 : DOMMediaStream::HasTrack(const MediaStreamTrack&amp; aTrack) const</span>
<span class="lineNum">     811 </span>            : {
<span class="lineNum">     812 </span><span class="lineCov">          1 :   return !!FindPlaybackTrackPort(aTrack);</span>
<span class="lineNum">     813 </span>            : }
<a name="814"><span class="lineNum">     814 </span>            : </a>
<span class="lineNum">     815 </span>            : bool
<span class="lineNum">     816 </span><span class="lineNoCov">          0 : DOMMediaStream::OwnsTrack(const MediaStreamTrack&amp; aTrack) const</span>
<span class="lineNum">     817 </span>            : {
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :   return !!FindOwnedTrackPort(aTrack);</span>
<span class="lineNum">     819 </span>            : }
<a name="820"><span class="lineNum">     820 </span>            : </a>
<span class="lineNum">     821 </span>            : bool
<span class="lineNum">     822 </span><span class="lineNoCov">          0 : DOMMediaStream::AddDirectListener(DirectMediaStreamListener* aListener)</span>
<span class="lineNum">     823 </span>            : {
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :   if (GetInputStream() &amp;&amp; GetInputStream()-&gt;AsSourceStream()) {</span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :     GetInputStream()-&gt;AsSourceStream()-&gt;AddDirectListener(aListener);</span>
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :     return true; // application should ignore NotifyQueuedTrackData</span>
<span class="lineNum">     827 </span>            :   }
<span class="lineNum">     828 </span>            :   return false;
<span class="lineNum">     829 </span>            : }
<a name="830"><span class="lineNum">     830 </span>            : </a>
<span class="lineNum">     831 </span>            : void
<span class="lineNum">     832 </span><span class="lineNoCov">          0 : DOMMediaStream::RemoveDirectListener(DirectMediaStreamListener* aListener)</span>
<span class="lineNum">     833 </span>            : {
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :   if (GetInputStream() &amp;&amp; GetInputStream()-&gt;AsSourceStream()) {</span>
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :     GetInputStream()-&gt;AsSourceStream()-&gt;RemoveDirectListener(aListener);</span>
<span class="lineNum">     836 </span>            :   }
<span class="lineNum">     837 </span><span class="lineNoCov">          0 : }</span>
<a name="838"><span class="lineNum">     838 </span>            : </a>
<span class="lineNum">     839 </span>            : bool
<span class="lineNum">     840 </span><span class="lineCov">          1 : DOMMediaStream::IsFinished() const</span>
<span class="lineNum">     841 </span>            : {
<span class="lineNum">     842 </span><span class="lineCov">          1 :   return !mPlaybackStream || mPlaybackStream-&gt;IsFinished();</span>
<span class="lineNum">     843 </span>            : }
<a name="844"><span class="lineNum">     844 </span>            : </a>
<span class="lineNum">     845 </span>            : void
<span class="lineNum">     846 </span><span class="lineCov">          1 : DOMMediaStream::SetInactiveOnFinish()</span>
<span class="lineNum">     847 </span>            : {
<span class="lineNum">     848 </span><span class="lineCov">          1 :   mSetInactiveOnFinish = true;</span>
<span class="lineNum">     849 </span><span class="lineCov">          1 : }</span>
<a name="850"><span class="lineNum">     850 </span>            : </a>
<span class="lineNum">     851 </span>            : void
<span class="lineNum">     852 </span><span class="lineCov">          1 : DOMMediaStream::InitSourceStream(MediaStreamGraph* aGraph)</span>
<span class="lineNum">     853 </span>            : {
<span class="lineNum">     854 </span><span class="lineCov">          1 :   InitInputStreamCommon(aGraph-&gt;CreateSourceStream(mAbstractMainThread), aGraph);</span>
<span class="lineNum">     855 </span><span class="lineCov">          1 :   InitOwnedStreamCommon(aGraph);</span>
<span class="lineNum">     856 </span><span class="lineCov">          1 :   InitPlaybackStreamCommon(aGraph);</span>
<span class="lineNum">     857 </span><span class="lineCov">          1 : }</span>
<a name="858"><span class="lineNum">     858 </span>            : </a>
<span class="lineNum">     859 </span>            : void
<span class="lineNum">     860 </span><span class="lineCov">          1 : DOMMediaStream::InitTrackUnionStream(MediaStreamGraph* aGraph)</span>
<span class="lineNum">     861 </span>            : {
<span class="lineNum">     862 </span><span class="lineCov">          1 :   InitInputStreamCommon(aGraph-&gt;CreateTrackUnionStream(mAbstractMainThread), aGraph);</span>
<span class="lineNum">     863 </span><span class="lineCov">          1 :   InitOwnedStreamCommon(aGraph);</span>
<span class="lineNum">     864 </span><span class="lineCov">          1 :   InitPlaybackStreamCommon(aGraph);</span>
<span class="lineNum">     865 </span><span class="lineCov">          1 : }</span>
<a name="866"><span class="lineNum">     866 </span>            : </a>
<span class="lineNum">     867 </span>            : void
<span class="lineNum">     868 </span><span class="lineCov">          1 : DOMMediaStream::InitAudioCaptureStream(nsIPrincipal* aPrincipal, MediaStreamGraph* aGraph)</span>
<span class="lineNum">     869 </span>            : {
<span class="lineNum">     870 </span><span class="lineCov">          1 :   const TrackID AUDIO_TRACK = 1;</span>
<span class="lineNum">     871 </span>            : 
<span class="lineNum">     872 </span>            :   RefPtr&lt;BasicTrackSource&gt; audioCaptureSource =
<span class="lineNum">     873 </span><span class="lineCov">          1 :     new BasicTrackSource(aPrincipal, MediaSourceEnum::AudioCapture);</span>
<span class="lineNum">     874 </span>            : 
<span class="lineNum">     875 </span>            :   AudioCaptureStream* audioCaptureStream =
<span class="lineNum">     876 </span><span class="lineCov">          1 :     static_cast&lt;AudioCaptureStream*&gt;(aGraph-&gt;CreateAudioCaptureStream(AUDIO_TRACK, mAbstractMainThread));</span>
<span class="lineNum">     877 </span>            :   InitInputStreamCommon(audioCaptureStream, aGraph);
<span class="lineNum">     878 </span><span class="lineCov">          1 :   InitOwnedStreamCommon(aGraph);</span>
<span class="lineNum">     879 </span><span class="lineCov">          1 :   InitPlaybackStreamCommon(aGraph);</span>
<span class="lineNum">     880 </span>            :   RefPtr&lt;MediaStreamTrack&gt; track =
<span class="lineNum">     881 </span><span class="lineCov">          1 :     CreateDOMTrack(AUDIO_TRACK, MediaSegment::AUDIO, audioCaptureSource);</span>
<span class="lineNum">     882 </span><span class="lineCov">          1 :   AddTrackInternal(track);</span>
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span><span class="lineCov">          1 :   audioCaptureStream-&gt;Start();</span>
<span class="lineNum">     885 </span><span class="lineCov">          1 : }</span>
<a name="886"><span class="lineNum">     886 </span>            : </a>
<span class="lineNum">     887 </span>            : void
<span class="lineNum">     888 </span><span class="lineNoCov">          0 : DOMMediaStream::InitInputStreamCommon(MediaStream* aStream,</span>
<span class="lineNum">     889 </span>            :                                       MediaStreamGraph* aGraph)
<span class="lineNum">     890 </span>            : {
<span class="lineNum">     891 </span>            :   MOZ_ASSERT(!mOwnedStream, &quot;Input stream must be initialized before owned stream&quot;);
<span class="lineNum">     892 </span>            : 
<span class="lineNum">     893 </span><span class="lineCov">          1 :   mInputStream = aStream;</span>
<span class="lineNum">     894 </span><span class="lineCov">          1 :   mInputStream-&gt;RegisterUser();</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 : }</span>
<a name="896"><span class="lineNum">     896 </span>            : </a>
<span class="lineNum">     897 </span>            : void
<span class="lineNum">     898 </span><span class="lineCov">          1 : DOMMediaStream::InitOwnedStreamCommon(MediaStreamGraph* aGraph)</span>
<span class="lineNum">     899 </span>            : {
<span class="lineNum">     900 </span>            :   MOZ_ASSERT(!mPlaybackStream, &quot;Owned stream must be initialized before playback stream&quot;);
<span class="lineNum">     901 </span>            : 
<span class="lineNum">     902 </span><span class="lineCov">          1 :   mOwnedStream = aGraph-&gt;CreateTrackUnionStream(mAbstractMainThread);</span>
<span class="lineNum">     903 </span><span class="lineCov">          1 :   mOwnedStream-&gt;SetAutofinish(true);</span>
<span class="lineNum">     904 </span><span class="lineCov">          1 :   mOwnedStream-&gt;RegisterUser();</span>
<span class="lineNum">     905 </span><span class="lineCov">          1 :   if (mInputStream) {</span>
<span class="lineNum">     906 </span><span class="lineCov">          1 :     mOwnedPort = mOwnedStream-&gt;AllocateInputPort(mInputStream);</span>
<span class="lineNum">     907 </span>            :   }
<span class="lineNum">     908 </span>            : 
<span class="lineNum">     909 </span>            :   // Setup track listeners
<span class="lineNum">     910 </span><span class="lineCov">          1 :   mOwnedListener = new OwnedStreamListener(this);</span>
<span class="lineNum">     911 </span><span class="lineCov">          1 :   mOwnedStream-&gt;AddListener(mOwnedListener);</span>
<span class="lineNum">     912 </span><span class="lineCov">          1 : }</span>
<a name="913"><span class="lineNum">     913 </span>            : </a>
<span class="lineNum">     914 </span>            : void
<span class="lineNum">     915 </span><span class="lineCov">          1 : DOMMediaStream::InitPlaybackStreamCommon(MediaStreamGraph* aGraph)</span>
<span class="lineNum">     916 </span>            : {
<span class="lineNum">     917 </span><span class="lineCov">          1 :   mPlaybackStream = aGraph-&gt;CreateTrackUnionStream(mAbstractMainThread);</span>
<span class="lineNum">     918 </span><span class="lineCov">          1 :   mPlaybackStream-&gt;SetAutofinish(true);</span>
<span class="lineNum">     919 </span><span class="lineCov">          1 :   mPlaybackStream-&gt;RegisterUser();</span>
<span class="lineNum">     920 </span><span class="lineCov">          1 :   if (mOwnedStream) {</span>
<span class="lineNum">     921 </span><span class="lineCov">          1 :     mPlaybackPort = mPlaybackStream-&gt;AllocateInputPort(mOwnedStream);</span>
<span class="lineNum">     922 </span>            :   }
<span class="lineNum">     923 </span>            : 
<span class="lineNum">     924 </span><span class="lineCov">          1 :   mPlaybackListener = new PlaybackStreamListener(this);</span>
<span class="lineNum">     925 </span><span class="lineCov">          1 :   mPlaybackStream-&gt;AddListener(mPlaybackListener);</span>
<span class="lineNum">     926 </span>            : 
<span class="lineNum">     927 </span><span class="lineCov">          1 :   LOG(LogLevel::Debug, (&quot;DOMMediaStream %p Initiated with mInputStream=%p, mOwnedStream=%p, mPlaybackStream=%p&quot;,</span>
<span class="lineNum">     928 </span>            :                         this, mInputStream, mOwnedStream, mPlaybackStream));
<span class="lineNum">     929 </span><span class="lineCov">          1 : }</span>
<a name="930"><span class="lineNum">     930 </span>            : </a>
<span class="lineNum">     931 </span>            : already_AddRefed&lt;DOMMediaStream&gt;
<span class="lineNum">     932 </span><span class="lineCov">          1 : DOMMediaStream::CreateSourceStreamAsInput(nsPIDOMWindowInner* aWindow,</span>
<span class="lineNum">     933 </span>            :                                           MediaStreamGraph* aGraph,
<span class="lineNum">     934 </span>            :                                           MediaStreamTrackSourceGetter* aTrackSourceGetter)
<span class="lineNum">     935 </span>            : {
<span class="lineNum">     936 </span><span class="lineCov">          1 :   RefPtr&lt;DOMMediaStream&gt; stream = new DOMMediaStream(aWindow, aTrackSourceGetter);</span>
<span class="lineNum">     937 </span><span class="lineCov">          1 :   stream-&gt;InitSourceStream(aGraph);</span>
<span class="lineNum">     938 </span><span class="lineCov">          1 :   return stream.forget();</span>
<span class="lineNum">     939 </span>            : }
<a name="940"><span class="lineNum">     940 </span>            : </a>
<span class="lineNum">     941 </span>            : already_AddRefed&lt;DOMMediaStream&gt;
<span class="lineNum">     942 </span><span class="lineCov">          1 : DOMMediaStream::CreateTrackUnionStreamAsInput(nsPIDOMWindowInner* aWindow,</span>
<span class="lineNum">     943 </span>            :                                               MediaStreamGraph* aGraph,
<span class="lineNum">     944 </span>            :                                               MediaStreamTrackSourceGetter* aTrackSourceGetter)
<span class="lineNum">     945 </span>            : {
<span class="lineNum">     946 </span><span class="lineCov">          1 :   RefPtr&lt;DOMMediaStream&gt; stream = new DOMMediaStream(aWindow, aTrackSourceGetter);</span>
<span class="lineNum">     947 </span><span class="lineCov">          1 :   stream-&gt;InitTrackUnionStream(aGraph);</span>
<span class="lineNum">     948 </span><span class="lineCov">          1 :   return stream.forget();</span>
<span class="lineNum">     949 </span>            : }
<a name="950"><span class="lineNum">     950 </span>            : </a>
<span class="lineNum">     951 </span>            : already_AddRefed&lt;DOMMediaStream&gt;
<span class="lineNum">     952 </span><span class="lineCov">          1 : DOMMediaStream::CreateAudioCaptureStreamAsInput(nsPIDOMWindowInner* aWindow,</span>
<span class="lineNum">     953 </span>            :                                                 nsIPrincipal* aPrincipal,
<span class="lineNum">     954 </span>            :                                                 MediaStreamGraph* aGraph)
<span class="lineNum">     955 </span>            : {
<span class="lineNum">     956 </span>            :   // Audio capture doesn't create tracks dynamically
<span class="lineNum">     957 </span><span class="lineCov">          1 :   MediaStreamTrackSourceGetter* getter = nullptr;</span>
<span class="lineNum">     958 </span><span class="lineCov">          1 :   RefPtr&lt;DOMMediaStream&gt; stream = new DOMMediaStream(aWindow, getter);</span>
<span class="lineNum">     959 </span><span class="lineCov">          1 :   stream-&gt;InitAudioCaptureStream(aPrincipal, aGraph);</span>
<span class="lineNum">     960 </span><span class="lineCov">          1 :   return stream.forget();</span>
<span class="lineNum">     961 </span>            : }
<a name="962"><span class="lineNum">     962 </span>            : </a>
<span class="lineNum">     963 </span>            : void
<span class="lineNum">     964 </span><span class="lineCov">          1 : DOMMediaStream::PrincipalChanged(MediaStreamTrack* aTrack)</span>
<span class="lineNum">     965 </span>            : {
<span class="lineNum">     966 </span>            :   MOZ_ASSERT(aTrack);
<span class="lineNum">     967 </span>            :   NS_ASSERTION(HasTrack(*aTrack), &quot;Principal changed for an unknown track&quot;);
<span class="lineNum">     968 </span><span class="lineCov">          1 :   LOG(LogLevel::Info, (&quot;DOMMediaStream %p Principal changed for track %p&quot;,</span>
<span class="lineNum">     969 </span>            :                        this, aTrack));
<span class="lineNum">     970 </span><span class="lineCov">          1 :   RecomputePrincipal();</span>
<span class="lineNum">     971 </span><span class="lineCov">          1 : }</span>
<a name="972"><span class="lineNum">     972 </span>            : </a>
<span class="lineNum">     973 </span>            : void
<span class="lineNum">     974 </span><span class="lineCov">          1 : DOMMediaStream::RecomputePrincipal()</span>
<span class="lineNum">     975 </span>            : {
<span class="lineNum">     976 </span><span class="lineCov">          1 :   nsCOMPtr&lt;nsIPrincipal&gt; previousPrincipal = mPrincipal.forget();</span>
<span class="lineNum">     977 </span><span class="lineCov">          1 :   nsCOMPtr&lt;nsIPrincipal&gt; previousVideoPrincipal = mVideoPrincipal.forget();</span>
<span class="lineNum">     978 </span>            : 
<span class="lineNum">     979 </span><span class="lineCov">          1 :   if (mTracksPendingRemoval &gt; 0) {</span>
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :     LOG(LogLevel::Info, (&quot;DOMMediaStream %p RecomputePrincipal() Cannot &quot;</span>
<span class="lineNum">     981 </span>            :                          &quot;recompute stream principal with tracks pending &quot;
<span class="lineNum">     982 </span>            :                          &quot;removal.&quot;, this));
<span class="lineNum">     983 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">     984 </span>            :   }
<span class="lineNum">     985 </span>            : 
<span class="lineNum">     986 </span><span class="lineCov">          1 :   LOG(LogLevel::Debug, (&quot;DOMMediaStream %p Recomputing principal. &quot;</span>
<span class="lineNum">     987 </span>            :                         &quot;Old principal was %p.&quot;, this, previousPrincipal.get()));
<span class="lineNum">     988 </span>            : 
<span class="lineNum">     989 </span>            :   // mPrincipal is recomputed based on all current tracks, and tracks that have
<span class="lineNum">     990 </span>            :   // not ended in our playback stream.
<span class="lineNum">     991 </span><span class="lineCov">          1 :   for (const RefPtr&lt;TrackPort&gt;&amp; info : mTracks) {</span>
<span class="lineNum">     992 </span><span class="lineCov">          1 :     if (info-&gt;GetTrack()-&gt;Ended()) {</span>
<span class="lineNum">     993 </span>            :       continue;
<span class="lineNum">     994 </span>            :     }
<span class="lineNum">     995 </span><span class="lineCov">          1 :     LOG(LogLevel::Debug, (&quot;DOMMediaStream %p Taking live track %p with &quot;</span>
<span class="lineNum">     996 </span>            :                           &quot;principal %p into account.&quot;, this,
<span class="lineNum">     997 </span>            :                           info-&gt;GetTrack(), info-&gt;GetTrack()-&gt;GetPrincipal()));
<span class="lineNum">     998 </span>            :     nsContentUtils::CombineResourcePrincipals(&amp;mPrincipal,
<span class="lineNum">     999 </span><span class="lineCov">          1 :                                               info-&gt;GetTrack()-&gt;GetPrincipal());</span>
<span class="lineNum">    1000 </span><span class="lineCov">          1 :     if (info-&gt;GetTrack()-&gt;AsVideoStreamTrack()) {</span>
<span class="lineNum">    1001 </span>            :       nsContentUtils::CombineResourcePrincipals(&amp;mVideoPrincipal,
<span class="lineNum">    1002 </span><span class="lineCov">          1 :                                                 info-&gt;GetTrack()-&gt;GetPrincipal());</span>
<span class="lineNum">    1003 </span>            :     }
<span class="lineNum">    1004 </span>            :   }
<span class="lineNum">    1005 </span>            : 
<span class="lineNum">    1006 </span><span class="lineCov">          1 :   LOG(LogLevel::Debug, (&quot;DOMMediaStream %p new principal is %p.&quot;,</span>
<span class="lineNum">    1007 </span>            :                         this, mPrincipal.get()));
<span class="lineNum">    1008 </span>            : 
<span class="lineNum">    1009 </span><span class="lineCov">          1 :   if (previousPrincipal != mPrincipal ||</span>
<span class="lineNum">    1010 </span><span class="lineCov">          1 :       previousVideoPrincipal != mVideoPrincipal) {</span>
<span class="lineNum">    1011 </span><span class="lineCov">          1 :     NotifyPrincipalChanged();</span>
<span class="lineNum">    1012 </span>            :   }
<span class="lineNum">    1013 </span>            : }
<a name="1014"><span class="lineNum">    1014 </span>            : </a>
<span class="lineNum">    1015 </span>            : void
<span class="lineNum">    1016 </span><span class="lineCov">          1 : DOMMediaStream::NotifyPrincipalChanged()</span>
<span class="lineNum">    1017 </span>            : {
<span class="lineNum">    1018 </span><span class="lineCov">          1 :   if (!mPrincipal) {</span>
<span class="lineNum">    1019 </span>            :     // When all tracks are removed, mPrincipal will change to nullptr.
<span class="lineNum">    1020 </span><span class="lineCov">          1 :     LOG(LogLevel::Info, (&quot;DOMMediaStream %p Principal changed to nothing.&quot;,</span>
<span class="lineNum">    1021 </span>            :                          this));
<span class="lineNum">    1022 </span>            :   } else {
<span class="lineNum">    1023 </span><span class="lineCov">          1 :     LOG(LogLevel::Info, (&quot;DOMMediaStream %p Principal changed. Now: &quot;</span>
<span class="lineNum">    1024 </span>            :                          &quot;null=%d, codebase=%d, expanded=%d, system=%d&quot;, this,
<span class="lineNum">    1025 </span>            :                           mPrincipal-&gt;GetIsNullPrincipal(),
<span class="lineNum">    1026 </span>            :                           mPrincipal-&gt;GetIsCodebasePrincipal(),
<span class="lineNum">    1027 </span>            :                           mPrincipal-&gt;GetIsExpandedPrincipal(),
<span class="lineNum">    1028 </span>            :                           mPrincipal-&gt;GetIsSystemPrincipal()));
<span class="lineNum">    1029 </span>            :   }
<span class="lineNum">    1030 </span>            : 
<span class="lineNum">    1031 </span><span class="lineCov">          1 :   for (uint32_t i = 0; i &lt; mPrincipalChangeObservers.Length(); ++i) {</span>
<span class="lineNum">    1032 </span><span class="lineCov">          1 :     mPrincipalChangeObservers[i]-&gt;PrincipalChanged(this);</span>
<span class="lineNum">    1033 </span>            :   }
<span class="lineNum">    1034 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    1035 </span>            : 
<a name="1036"><span class="lineNum">    1036 </span>            : </a>
<span class="lineNum">    1037 </span>            : bool
<span class="lineNum">    1038 </span><span class="lineCov">          1 : DOMMediaStream::AddPrincipalChangeObserver(</span>
<span class="lineNum">    1039 </span>            :   PrincipalChangeObserver&lt;DOMMediaStream&gt;* aObserver)
<span class="lineNum">    1040 </span>            : {
<span class="lineNum">    1041 </span><span class="lineCov">          1 :   return mPrincipalChangeObservers.AppendElement(aObserver) != nullptr;</span>
<span class="lineNum">    1042 </span>            : }
<a name="1043"><span class="lineNum">    1043 </span>            : </a>
<span class="lineNum">    1044 </span>            : bool
<span class="lineNum">    1045 </span><span class="lineCov">          1 : DOMMediaStream::RemovePrincipalChangeObserver(</span>
<span class="lineNum">    1046 </span>            :   PrincipalChangeObserver&lt;DOMMediaStream&gt;* aObserver)
<span class="lineNum">    1047 </span>            : {
<span class="lineNum">    1048 </span><span class="lineCov">          1 :   return mPrincipalChangeObservers.RemoveElement(aObserver);</span>
<span class="lineNum">    1049 </span>            : }
<a name="1050"><span class="lineNum">    1050 </span>            : </a>
<span class="lineNum">    1051 </span>            : void
<span class="lineNum">    1052 </span><span class="lineCov">          1 : DOMMediaStream::AddTrackInternal(MediaStreamTrack* aTrack)</span>
<span class="lineNum">    1053 </span>            : {
<span class="lineNum">    1054 </span>            :   MOZ_ASSERT(aTrack-&gt;mOwningStream == this);
<span class="lineNum">    1055 </span>            :   MOZ_ASSERT(FindOwnedDOMTrack(aTrack-&gt;GetInputStream(),
<span class="lineNum">    1056 </span>            :                                aTrack-&gt;mInputTrackID,
<span class="lineNum">    1057 </span>            :                                aTrack-&gt;mTrackID));
<span class="lineNum">    1058 </span>            :   MOZ_ASSERT(!FindPlaybackDOMTrack(aTrack-&gt;GetOwnedStream(),
<span class="lineNum">    1059 </span>            :                                    aTrack-&gt;mTrackID));
<span class="lineNum">    1060 </span>            : 
<span class="lineNum">    1061 </span><span class="lineCov">          1 :   LOG(LogLevel::Debug, (&quot;DOMMediaStream %p Adding owned track %p&quot;, this, aTrack));</span>
<span class="lineNum">    1062 </span>            : 
<span class="lineNum">    1063 </span>            :   mTracks.AppendElement(
<span class="lineNum">    1064 </span><span class="lineCov">          1 :     new TrackPort(mPlaybackPort, aTrack, TrackPort::InputPortOwnership::EXTERNAL));</span>
<span class="lineNum">    1065 </span>            : 
<span class="lineNum">    1066 </span><span class="lineCov">          1 :   NotifyTrackAdded(aTrack);</span>
<span class="lineNum">    1067 </span>            : 
<span class="lineNum">    1068 </span><span class="lineCov">          1 :   DispatchTrackEvent(NS_LITERAL_STRING(&quot;addtrack&quot;), aTrack);</span>
<span class="lineNum">    1069 </span><span class="lineCov">          1 : }</span>
<a name="1070"><span class="lineNum">    1070 </span>            : </a>
<span class="lineNum">    1071 </span>            : already_AddRefed&lt;MediaStreamTrack&gt;
<span class="lineNum">    1072 </span><span class="lineCov">          1 : DOMMediaStream::CreateDOMTrack(TrackID aTrackID, MediaSegment::Type aType,</span>
<span class="lineNum">    1073 </span>            :                                MediaStreamTrackSource* aSource,
<span class="lineNum">    1074 </span>            :                                const MediaTrackConstraints&amp; aConstraints)
<span class="lineNum">    1075 </span>            : {
<span class="lineNum">    1076 </span><span class="lineCov">          1 :   MOZ_RELEASE_ASSERT(mInputStream);</span>
<span class="lineNum">    1077 </span><span class="lineCov">          1 :   MOZ_RELEASE_ASSERT(mOwnedStream);</span>
<span class="lineNum">    1078 </span>            : 
<span class="lineNum">    1079 </span>            :   MOZ_ASSERT(FindOwnedDOMTrack(GetInputStream(), aTrackID) == nullptr);
<span class="lineNum">    1080 </span>            : 
<span class="lineNum">    1081 </span>            :   RefPtr&lt;MediaStreamTrack&gt; track;
<span class="lineNum">    1082 </span><span class="lineCov">          1 :   switch (aType) {</span>
<span class="lineNum">    1083 </span>            :   case MediaSegment::AUDIO:
<span class="lineNum">    1084 </span><span class="lineCov">          1 :     track = new AudioStreamTrack(this, aTrackID, aTrackID, aSource, aConstraints);</span>
<span class="lineNum">    1085 </span>            :     break;
<span class="lineNum">    1086 </span>            :   case MediaSegment::VIDEO:
<span class="lineNum">    1087 </span><span class="lineCov">          1 :     track = new VideoStreamTrack(this, aTrackID, aTrackID, aSource, aConstraints);</span>
<span class="lineNum">    1088 </span>            :     break;
<span class="lineNum">    1089 </span>            :   default:
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :     MOZ_CRASH(&quot;Unhandled track type&quot;);</span>
<span class="lineNum">    1091 </span>            :   }
<span class="lineNum">    1092 </span>            : 
<span class="lineNum">    1093 </span><span class="lineCov">          1 :   LOG(LogLevel::Debug, (&quot;DOMMediaStream %p Created new track %p with ID %u&quot;,</span>
<span class="lineNum">    1094 </span>            :                         this, track.get(), aTrackID));
<span class="lineNum">    1095 </span>            : 
<span class="lineNum">    1096 </span>            :   mOwnedTracks.AppendElement(
<span class="lineNum">    1097 </span><span class="lineCov">          1 :     new TrackPort(mOwnedPort, track, TrackPort::InputPortOwnership::EXTERNAL));</span>
<span class="lineNum">    1098 </span>            : 
<span class="lineNum">    1099 </span><span class="lineCov">          1 :   return track.forget();</span>
<span class="lineNum">    1100 </span>            : }
<a name="1101"><span class="lineNum">    1101 </span>            : </a>
<span class="lineNum">    1102 </span>            : already_AddRefed&lt;MediaStreamTrack&gt;
<span class="lineNum">    1103 </span><span class="lineCov">          1 : DOMMediaStream::CloneDOMTrack(MediaStreamTrack&amp; aTrack,</span>
<span class="lineNum">    1104 </span>            :                               TrackID aCloneTrackID)
<span class="lineNum">    1105 </span>            : {
<span class="lineNum">    1106 </span><span class="lineCov">          1 :   MOZ_RELEASE_ASSERT(mOwnedStream);</span>
<span class="lineNum">    1107 </span><span class="lineCov">          1 :   MOZ_RELEASE_ASSERT(mPlaybackStream);</span>
<span class="lineNum">    1108 </span><span class="lineCov">          1 :   MOZ_RELEASE_ASSERT(IsTrackIDExplicit(aCloneTrackID));</span>
<span class="lineNum">    1109 </span>            : 
<span class="lineNum">    1110 </span><span class="lineCov">          1 :   TrackID inputTrackID = aTrack.mInputTrackID;</span>
<span class="lineNum">    1111 </span><span class="lineCov">          1 :   MediaStream* inputStream = aTrack.GetInputStream();</span>
<span class="lineNum">    1112 </span>            : 
<span class="lineNum">    1113 </span><span class="lineCov">          1 :   RefPtr&lt;MediaStreamTrack&gt; newTrack = aTrack.CloneInternal(this, aCloneTrackID);</span>
<span class="lineNum">    1114 </span>            : 
<span class="lineNum">    1115 </span><span class="lineCov">          1 :   newTrack-&gt;mOriginalTrack =</span>
<span class="lineNum">    1116 </span><span class="lineCov">          1 :     aTrack.mOriginalTrack ? aTrack.mOriginalTrack.get() : &amp;aTrack;</span>
<span class="lineNum">    1117 </span>            : 
<span class="lineNum">    1118 </span><span class="lineCov">          1 :   LOG(LogLevel::Debug, (&quot;DOMMediaStream %p Created new track %p cloned from stream %p track %d&quot;,</span>
<span class="lineNum">    1119 </span>            :                         this, newTrack.get(), inputStream, inputTrackID));
<span class="lineNum">    1120 </span>            : 
<span class="lineNum">    1121 </span>            :   RefPtr&lt;MediaInputPort&gt; inputPort =
<span class="lineNum">    1122 </span><span class="lineCov">          1 :     mOwnedStream-&gt;AllocateInputPort(inputStream, inputTrackID, aCloneTrackID);</span>
<span class="lineNum">    1123 </span>            : 
<span class="lineNum">    1124 </span>            :   mOwnedTracks.AppendElement(
<span class="lineNum">    1125 </span><span class="lineCov">          1 :     new TrackPort(inputPort, newTrack, TrackPort::InputPortOwnership::OWNED));</span>
<span class="lineNum">    1126 </span>            : 
<span class="lineNum">    1127 </span>            :   mTracks.AppendElement(
<span class="lineNum">    1128 </span><span class="lineCov">          1 :     new TrackPort(mPlaybackPort, newTrack, TrackPort::InputPortOwnership::EXTERNAL));</span>
<span class="lineNum">    1129 </span>            : 
<span class="lineNum">    1130 </span><span class="lineCov">          1 :   NotifyTrackAdded(newTrack);</span>
<span class="lineNum">    1131 </span>            : 
<span class="lineNum">    1132 </span><span class="lineCov">          1 :   newTrack-&gt;SetEnabled(aTrack.Enabled());</span>
<span class="lineNum">    1133 </span><span class="lineCov">          1 :   newTrack-&gt;SetReadyState(aTrack.ReadyState());</span>
<span class="lineNum">    1134 </span>            : 
<span class="lineNum">    1135 </span><span class="lineCov">          1 :   if (aTrack.Ended()) {</span>
<span class="lineNum">    1136 </span>            :     // For extra suspenders, make sure that we don't forward data by mistake
<span class="lineNum">    1137 </span>            :     // to the clone when the original has already ended.
<span class="lineNum">    1138 </span>            :     // We only block END_EXISTING to allow any pending clones to end.
<span class="lineNum">    1139 </span>            :     RefPtr&lt;Pledge&lt;bool, nsresult&gt;&gt; blockingPledge =
<span class="lineNum">    1140 </span>            :       inputPort-&gt;BlockSourceTrackId(inputTrackID,
<span class="lineNum">    1141 </span><span class="lineCov">          1 :                                     BlockingMode::END_EXISTING);</span>
<span class="lineNum">    1142 </span><span class="lineCov">          1 :     Unused &lt;&lt; blockingPledge;</span>
<span class="lineNum">    1143 </span>            :   }
<span class="lineNum">    1144 </span>            : 
<span class="lineNum">    1145 </span><span class="lineCov">          1 :   return newTrack.forget();</span>
<span class="lineNum">    1146 </span>            : }
<a name="1147"><span class="lineNum">    1147 </span>            : </a>
<span class="lineNum">    1148 </span>            : static DOMMediaStream::TrackPort*
<span class="lineNum">    1149 </span><span class="lineCov">          1 : FindTrackPortAmongTracks(const MediaStreamTrack&amp; aTrack,</span>
<span class="lineNum">    1150 </span>            :                          const nsTArray&lt;RefPtr&lt;DOMMediaStream::TrackPort&gt;&gt;&amp; aTracks)
<span class="lineNum">    1151 </span>            : {
<span class="lineNum">    1152 </span><span class="lineCov">          1 :   for (const RefPtr&lt;DOMMediaStream::TrackPort&gt;&amp; info : aTracks) {</span>
<span class="lineNum">    1153 </span><span class="lineCov">          1 :     if (info-&gt;GetTrack() == &amp;aTrack) {</span>
<span class="lineNum">    1154 </span><span class="lineCov">          1 :       return info;</span>
<span class="lineNum">    1155 </span>            :     }
<span class="lineNum">    1156 </span>            :   }
<span class="lineNum">    1157 </span><span class="lineCov">          1 :   return nullptr;</span>
<span class="lineNum">    1158 </span>            : }
<a name="1159"><span class="lineNum">    1159 </span>            : </a>
<span class="lineNum">    1160 </span>            : MediaStreamTrack*
<span class="lineNum">    1161 </span><span class="lineCov">          1 : DOMMediaStream::FindOwnedDOMTrack(MediaStream* aInputStream,</span>
<span class="lineNum">    1162 </span>            :                                   TrackID aInputTrackID,
<span class="lineNum">    1163 </span>            :                                   TrackID aTrackID) const
<span class="lineNum">    1164 </span>            : {
<span class="lineNum">    1165 </span><span class="lineCov">          1 :   MOZ_RELEASE_ASSERT(mOwnedStream);</span>
<span class="lineNum">    1166 </span>            : 
<span class="lineNum">    1167 </span><span class="lineCov">          1 :   for (const RefPtr&lt;TrackPort&gt;&amp; info : mOwnedTracks) {</span>
<span class="lineNum">    1168 </span><span class="lineCov">          1 :     if (info-&gt;GetInputPort() &amp;&amp;</span>
<span class="lineNum">    1169 </span><span class="lineCov">          1 :         info-&gt;GetInputPort()-&gt;GetSource() == aInputStream &amp;&amp;</span>
<span class="lineNum">    1170 </span><span class="lineCov">          1 :         info-&gt;GetTrack()-&gt;mInputTrackID == aInputTrackID &amp;&amp;</span>
<span class="lineNum">    1171 </span><span class="lineCov">          1 :         (aTrackID == TRACK_ANY || info-&gt;GetTrack()-&gt;mTrackID == aTrackID)) {</span>
<span class="lineNum">    1172 </span>            :       // This track is owned externally but in our playback stream.
<span class="lineNum">    1173 </span><span class="lineCov">          1 :       return info-&gt;GetTrack();</span>
<span class="lineNum">    1174 </span>            :     }
<span class="lineNum">    1175 </span>            :   }
<span class="lineNum">    1176 </span><span class="lineCov">          1 :   return nullptr;</span>
<span class="lineNum">    1177 </span>            : }
<a name="1178"><span class="lineNum">    1178 </span>            : </a>
<span class="lineNum">    1179 </span>            : DOMMediaStream::TrackPort*
<span class="lineNum">    1180 </span><span class="lineCov">          1 : DOMMediaStream::FindOwnedTrackPort(const MediaStreamTrack&amp; aTrack) const</span>
<span class="lineNum">    1181 </span>            : {
<span class="lineNum">    1182 </span><span class="lineCov">          1 :   return FindTrackPortAmongTracks(aTrack, mOwnedTracks);</span>
<span class="lineNum">    1183 </span>            : }
<span class="lineNum">    1184 </span>            : 
<a name="1185"><span class="lineNum">    1185 </span>            : </a>
<span class="lineNum">    1186 </span>            : MediaStreamTrack*
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 : DOMMediaStream::FindPlaybackDOMTrack(MediaStream* aInputStream, TrackID aInputTrackID) const</span>
<span class="lineNum">    1188 </span>            : {
<span class="lineNum">    1189 </span><span class="lineNoCov">          0 :   if (!mPlaybackStream) {</span>
<span class="lineNum">    1190 </span>            :     // One would think we can assert mPlaybackStream here, but track clones have
<span class="lineNum">    1191 </span>            :     // a dummy DOMMediaStream that doesn't have a playback stream, so we can't.
<span class="lineNum">    1192 </span>            :     return nullptr;
<span class="lineNum">    1193 </span>            :   }
<span class="lineNum">    1194 </span>            : 
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :   for (const RefPtr&lt;TrackPort&gt;&amp; info : mTracks) {</span>
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :     if (info-&gt;GetInputPort() == mPlaybackPort &amp;&amp;</span>
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :         aInputStream == mOwnedStream &amp;&amp;</span>
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :         info-&gt;GetTrack()-&gt;mInputTrackID == aInputTrackID) {</span>
<span class="lineNum">    1199 </span>            :       // This track is in our owned and playback streams.
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :       return info-&gt;GetTrack();</span>
<span class="lineNum">    1201 </span>            :     }
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :     if (info-&gt;GetInputPort() &amp;&amp;</span>
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :         info-&gt;GetInputPort()-&gt;GetSource() == aInputStream &amp;&amp;</span>
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 :         info-&gt;GetSourceTrackId() == aInputTrackID) {</span>
<span class="lineNum">    1205 </span>            :       // This track is owned externally but in our playback stream.
<span class="lineNum">    1206 </span>            :       MOZ_ASSERT(IsTrackIDExplicit(aInputTrackID));
<span class="lineNum">    1207 </span><span class="lineNoCov">          0 :       return info-&gt;GetTrack();</span>
<span class="lineNum">    1208 </span>            :     }
<span class="lineNum">    1209 </span>            :   }
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :   return nullptr;</span>
<span class="lineNum">    1211 </span>            : }
<a name="1212"><span class="lineNum">    1212 </span>            : </a>
<span class="lineNum">    1213 </span>            : DOMMediaStream::TrackPort*
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 : DOMMediaStream::FindPlaybackTrackPort(const MediaStreamTrack&amp; aTrack) const</span>
<span class="lineNum">    1215 </span>            : {
<span class="lineNum">    1216 </span><span class="lineCov">          1 :   return FindTrackPortAmongTracks(aTrack, mTracks);</span>
<span class="lineNum">    1217 </span>            : }
<a name="1218"><span class="lineNum">    1218 </span>            : </a>
<span class="lineNum">    1219 </span>            : void
<span class="lineNum">    1220 </span><span class="lineCov">          1 : DOMMediaStream::OnTracksAvailable(OnTracksAvailableCallback* aRunnable)</span>
<span class="lineNum">    1221 </span>            : {
<span class="lineNum">    1222 </span><span class="lineCov">          1 :   if (mNotifiedOfMediaStreamGraphShutdown) {</span>
<span class="lineNum">    1223 </span>            :     // No more tracks will ever be added, so just delete the callback now.
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :     delete aRunnable;</span>
<span class="lineNum">    1225 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">    1226 </span>            :   }
<span class="lineNum">    1227 </span><span class="lineCov">          1 :   mRunOnTracksAvailable.AppendElement(aRunnable);</span>
<span class="lineNum">    1228 </span><span class="lineCov">          1 :   CheckTracksAvailable();</span>
<span class="lineNum">    1229 </span>            : }
<a name="1230"><span class="lineNum">    1230 </span>            : </a>
<span class="lineNum">    1231 </span>            : void
<span class="lineNum">    1232 </span><span class="lineCov">          1 : DOMMediaStream::NotifyTracksCreated()</span>
<span class="lineNum">    1233 </span>            : {
<span class="lineNum">    1234 </span><span class="lineCov">          1 :   mTracksCreated = true;</span>
<span class="lineNum">    1235 </span><span class="lineCov">          1 :   CheckTracksAvailable();</span>
<span class="lineNum">    1236 </span><span class="lineCov">          1 : }</span>
<a name="1237"><span class="lineNum">    1237 </span>            : </a>
<span class="lineNum">    1238 </span>            : void
<span class="lineNum">    1239 </span><span class="lineCov">          1 : DOMMediaStream::NotifyFinished()</span>
<span class="lineNum">    1240 </span>            : {
<span class="lineNum">    1241 </span><span class="lineCov">          1 :   if (!mSetInactiveOnFinish) {</span>
<span class="lineNum">    1242 </span>            :     return;
<span class="lineNum">    1243 </span>            :   }
<span class="lineNum">    1244 </span>            : 
<span class="lineNum">    1245 </span><span class="lineCov">          1 :   if (!mActive) {</span>
<span class="lineNum">    1246 </span>            :     // This can happen if the stream never became active.
<span class="lineNum">    1247 </span>            :     return;
<span class="lineNum">    1248 </span>            :   }
<span class="lineNum">    1249 </span>            : 
<span class="lineNum">    1250 </span>            :   MOZ_ASSERT(!ContainsLiveTracks(mTracks));
<span class="lineNum">    1251 </span><span class="lineCov">          1 :   mActive = false;</span>
<span class="lineNum">    1252 </span><span class="lineCov">          1 :   NotifyInactive();</span>
<span class="lineNum">    1253 </span>            : }
<a name="1254"><span class="lineNum">    1254 </span>            : </a>
<span class="lineNum">    1255 </span>            : void
<span class="lineNum">    1256 </span><span class="lineCov">          1 : DOMMediaStream::NotifyActive()</span>
<span class="lineNum">    1257 </span>            : {
<span class="lineNum">    1258 </span><span class="lineCov">          1 :   LOG(LogLevel::Info, (&quot;DOMMediaStream %p NotifyActive(). &quot;, this));</span>
<span class="lineNum">    1259 </span>            : 
<span class="lineNum">    1260 </span>            :   MOZ_ASSERT(mActive);
<span class="lineNum">    1261 </span><span class="lineCov">          1 :   for (int32_t i = mTrackListeners.Length() - 1; i &gt;= 0; --i) {</span>
<span class="lineNum">    1262 </span><span class="lineCov">          1 :     mTrackListeners[i]-&gt;NotifyActive();</span>
<span class="lineNum">    1263 </span>            :   }
<span class="lineNum">    1264 </span><span class="lineCov">          1 : }</span>
<a name="1265"><span class="lineNum">    1265 </span>            : </a>
<span class="lineNum">    1266 </span>            : void
<span class="lineNum">    1267 </span><span class="lineCov">          1 : DOMMediaStream::NotifyInactive()</span>
<span class="lineNum">    1268 </span>            : {
<span class="lineNum">    1269 </span><span class="lineCov">          1 :   LOG(LogLevel::Info, (&quot;DOMMediaStream %p NotifyInactive(). &quot;, this));</span>
<span class="lineNum">    1270 </span>            : 
<span class="lineNum">    1271 </span>            :   MOZ_ASSERT(!mActive);
<span class="lineNum">    1272 </span><span class="lineCov">          1 :   for (int32_t i = mTrackListeners.Length() - 1; i &gt;= 0; --i) {</span>
<span class="lineNum">    1273 </span><span class="lineCov">          1 :     mTrackListeners[i]-&gt;NotifyInactive();</span>
<span class="lineNum">    1274 </span>            :   }
<span class="lineNum">    1275 </span><span class="lineCov">          1 : }</span>
<a name="1276"><span class="lineNum">    1276 </span>            : </a>
<span class="lineNum">    1277 </span>            : void
<span class="lineNum">    1278 </span><span class="lineCov">          1 : DOMMediaStream::CheckTracksAvailable()</span>
<span class="lineNum">    1279 </span>            : {
<span class="lineNum">    1280 </span><span class="lineCov">          1 :   if (!mTracksCreated) {</span>
<span class="lineNum">    1281 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">    1282 </span>            :   }
<span class="lineNum">    1283 </span>            :   nsTArray&lt;nsAutoPtr&lt;OnTracksAvailableCallback&gt; &gt; callbacks;
<span class="lineNum">    1284 </span><span class="lineCov">          1 :   callbacks.SwapElements(mRunOnTracksAvailable);</span>
<span class="lineNum">    1285 </span>            : 
<span class="lineNum">    1286 </span><span class="lineCov">          1 :   for (uint32_t i = 0; i &lt; callbacks.Length(); ++i) {</span>
<span class="lineNum">    1287 </span><span class="lineCov">          1 :     callbacks[i]-&gt;NotifyTracksAvailable(this);</span>
<span class="lineNum">    1288 </span>            :   }
<span class="lineNum">    1289 </span>            : }
<a name="1290"><span class="lineNum">    1290 </span>            : </a>
<span class="lineNum">    1291 </span>            : void
<span class="lineNum">    1292 </span><span class="lineCov">          1 : DOMMediaStream::RegisterTrackListener(TrackListener* aListener)</span>
<span class="lineNum">    1293 </span>            : {
<span class="lineNum">    1294 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    1295 </span>            : 
<span class="lineNum">    1296 </span><span class="lineCov">          1 :   if (mNotifiedOfMediaStreamGraphShutdown) {</span>
<span class="lineNum">    1297 </span>            :     // No more tracks will ever be added, so just do nothing.
<span class="lineNum">    1298 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">    1299 </span>            :   }
<span class="lineNum">    1300 </span><span class="lineCov">          1 :   mTrackListeners.AppendElement(aListener);</span>
<span class="lineNum">    1301 </span>            : }
<a name="1302"><span class="lineNum">    1302 </span>            : </a>
<span class="lineNum">    1303 </span>            : void
<span class="lineNum">    1304 </span><span class="lineCov">          1 : DOMMediaStream::UnregisterTrackListener(TrackListener* aListener)</span>
<span class="lineNum">    1305 </span>            : {
<span class="lineNum">    1306 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    1307 </span><span class="lineCov">          1 :   mTrackListeners.RemoveElement(aListener);</span>
<span class="lineNum">    1308 </span><span class="lineCov">          1 : }</span>
<a name="1309"><span class="lineNum">    1309 </span>            : </a>
<span class="lineNum">    1310 </span>            : void
<span class="lineNum">    1311 </span><span class="lineCov">          1 : DOMMediaStream::NotifyTrackAdded(const RefPtr&lt;MediaStreamTrack&gt;&amp; aTrack)</span>
<span class="lineNum">    1312 </span>            : {
<span class="lineNum">    1313 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    1314 </span>            : 
<span class="lineNum">    1315 </span><span class="lineCov">          1 :   if (mTracksPendingRemoval &gt; 0) {</span>
<span class="lineNum">    1316 </span>            :     // If there are tracks pending removal we may not degrade the current
<span class="lineNum">    1317 </span>            :     // principals until those tracks have been confirmed removed from the
<span class="lineNum">    1318 </span>            :     // playback stream. Instead combine with the new track and the (potentially)
<span class="lineNum">    1319 </span>            :     // degraded principal will be calculated when it's safe.
<span class="lineNum">    1320 </span>            :     nsContentUtils::CombineResourcePrincipals(&amp;mPrincipal,
<span class="lineNum">    1321 </span><span class="lineCov">          1 :                                               aTrack-&gt;GetPrincipal());</span>
<span class="lineNum">    1322 </span><span class="lineCov">          1 :     LOG(LogLevel::Debug, (&quot;DOMMediaStream %p saw a track get added. Combining &quot;</span>
<span class="lineNum">    1323 </span>            :                           &quot;its principal %p into our while waiting for pending &quot;
<span class="lineNum">    1324 </span>            :                           &quot;tracks to be removed. New principal is %p.&quot;,
<span class="lineNum">    1325 </span>            :                           this, aTrack-&gt;GetPrincipal(), mPrincipal.get()));
<span class="lineNum">    1326 </span><span class="lineCov">          1 :     if (aTrack-&gt;AsVideoStreamTrack()) {</span>
<span class="lineNum">    1327 </span>            :       nsContentUtils::CombineResourcePrincipals(&amp;mVideoPrincipal,
<span class="lineNum">    1328 </span><span class="lineCov">          1 :                                                 aTrack-&gt;GetPrincipal());</span>
<span class="lineNum">    1329 </span>            :     }
<span class="lineNum">    1330 </span>            :   } else {
<span class="lineNum">    1331 </span><span class="lineCov">          1 :     LOG(LogLevel::Debug, (&quot;DOMMediaStream %p saw a track get added. &quot;</span>
<span class="lineNum">    1332 </span>            :                           &quot;Recomputing principal.&quot;, this));
<span class="lineNum">    1333 </span><span class="lineCov">          1 :     RecomputePrincipal();</span>
<span class="lineNum">    1334 </span>            :   }
<span class="lineNum">    1335 </span>            : 
<span class="lineNum">    1336 </span><span class="lineCov">          1 :   aTrack-&gt;AddPrincipalChangeObserver(this);</span>
<span class="lineNum">    1337 </span><span class="lineCov">          1 :   aTrack-&gt;AddConsumer(mPlaybackTrackListener);</span>
<span class="lineNum">    1338 </span>            : 
<span class="lineNum">    1339 </span><span class="lineCov">          1 :   for (int32_t i = mTrackListeners.Length() - 1; i &gt;= 0; --i) {</span>
<span class="lineNum">    1340 </span><span class="lineCov">          1 :     mTrackListeners[i]-&gt;NotifyTrackAdded(aTrack);</span>
<span class="lineNum">    1341 </span>            :   }
<span class="lineNum">    1342 </span>            : 
<span class="lineNum">    1343 </span><span class="lineCov">          1 :   if (mActive) {</span>
<span class="lineNum">    1344 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">    1345 </span>            :   }
<span class="lineNum">    1346 </span>            : 
<span class="lineNum">    1347 </span>            :   // Check if we became active.
<span class="lineNum">    1348 </span><span class="lineCov">          1 :   if (ContainsLiveTracks(mTracks)) {</span>
<span class="lineNum">    1349 </span><span class="lineCov">          1 :     mActive = true;</span>
<span class="lineNum">    1350 </span><span class="lineCov">          1 :     NotifyActive();</span>
<span class="lineNum">    1351 </span>            :   }
<span class="lineNum">    1352 </span>            : }
<a name="1353"><span class="lineNum">    1353 </span>            : </a>
<span class="lineNum">    1354 </span>            : void
<span class="lineNum">    1355 </span><span class="lineCov">          1 : DOMMediaStream::NotifyTrackRemoved(const RefPtr&lt;MediaStreamTrack&gt;&amp; aTrack)</span>
<span class="lineNum">    1356 </span>            : {
<span class="lineNum">    1357 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    1358 </span>            : 
<span class="lineNum">    1359 </span><span class="lineCov">          1 :   aTrack-&gt;RemoveConsumer(mPlaybackTrackListener);</span>
<span class="lineNum">    1360 </span><span class="lineCov">          1 :   aTrack-&gt;RemovePrincipalChangeObserver(this);</span>
<span class="lineNum">    1361 </span>            : 
<span class="lineNum">    1362 </span><span class="lineCov">          1 :   for (int32_t i = mTrackListeners.Length() - 1; i &gt;= 0; --i) {</span>
<span class="lineNum">    1363 </span><span class="lineCov">          1 :     mTrackListeners[i]-&gt;NotifyTrackRemoved(aTrack);</span>
<span class="lineNum">    1364 </span>            : 
<span class="lineNum">    1365 </span>            :   }
<span class="lineNum">    1366 </span>            : 
<span class="lineNum">    1367 </span>            :   // Don't call RecomputePrincipal here as the track may still exist in the
<span class="lineNum">    1368 </span>            :   // playback stream in the MediaStreamGraph. It will instead be called when the
<span class="lineNum">    1369 </span>            :   // track has been confirmed removed by the graph. See BlockPlaybackTrack().
<span class="lineNum">    1370 </span>            : 
<span class="lineNum">    1371 </span><span class="lineCov">          1 :   if (!mActive) {</span>
<span class="lineNum">    1372 </span>            :     NS_ASSERTION(false, &quot;Shouldn't remove a live track if already inactive&quot;);
<span class="lineNum">    1373 </span>            :     return;
<span class="lineNum">    1374 </span>            :   }
<span class="lineNum">    1375 </span>            : 
<span class="lineNum">    1376 </span><span class="lineCov">          1 :   if (mSetInactiveOnFinish) {</span>
<span class="lineNum">    1377 </span>            :     // For compatibility with mozCaptureStream we in some cases do not go
<span class="lineNum">    1378 </span>            :     // inactive until the playback stream finishes.
<span class="lineNum">    1379 </span>            :     return;
<span class="lineNum">    1380 </span>            :   }
<span class="lineNum">    1381 </span>            : 
<span class="lineNum">    1382 </span>            :   // Check if we became inactive.
<span class="lineNum">    1383 </span><span class="lineCov">          1 :   if (!ContainsLiveTracks(mTracks)) {</span>
<span class="lineNum">    1384 </span><span class="lineCov">          1 :     mActive = false;</span>
<span class="lineNum">    1385 </span><span class="lineCov">          1 :     NotifyInactive();</span>
<span class="lineNum">    1386 </span>            :   }
<span class="lineNum">    1387 </span>            : }
<a name="1388"><span class="lineNum">    1388 </span>            : </a>
<span class="lineNum">    1389 </span>            : nsresult
<span class="lineNum">    1390 </span><span class="lineCov">          1 : DOMMediaStream::DispatchTrackEvent(const nsAString&amp; aName,</span>
<span class="lineNum">    1391 </span>            :                                    const RefPtr&lt;MediaStreamTrack&gt;&amp; aTrack)
<span class="lineNum">    1392 </span>            : {
<span class="lineNum">    1393 </span>            :   MOZ_ASSERT(aName == NS_LITERAL_STRING(&quot;addtrack&quot;),
<span class="lineNum">    1394 </span>            :              &quot;Only 'addtrack' is supported at this time&quot;);
<span class="lineNum">    1395 </span>            : 
<span class="lineNum">    1396 </span><span class="lineCov">          1 :   MediaStreamTrackEventInit init;</span>
<span class="lineNum">    1397 </span><span class="lineCov">          1 :   init.mTrack = aTrack;</span>
<span class="lineNum">    1398 </span>            : 
<span class="lineNum">    1399 </span>            :   RefPtr&lt;MediaStreamTrackEvent&gt; event =
<span class="lineNum">    1400 </span><span class="lineCov">          1 :     MediaStreamTrackEvent::Constructor(this, aName, init);</span>
<span class="lineNum">    1401 </span>            : 
<span class="lineNum">    1402 </span><span class="lineCov">          1 :   return DispatchTrustedEvent(event);</span>
<span class="lineNum">    1403 </span>            : }
<a name="1404"><span class="lineNum">    1404 </span>            : </a>
<span class="lineNum">    1405 </span>            : void
<span class="lineNum">    1406 </span><span class="lineCov">          1 : DOMMediaStream::BlockPlaybackTrack(TrackPort* aTrack)</span>
<span class="lineNum">    1407 </span>            : {
<span class="lineNum">    1408 </span>            :   MOZ_ASSERT(aTrack);
<span class="lineNum">    1409 </span><span class="lineCov">          1 :   ++mTracksPendingRemoval;</span>
<span class="lineNum">    1410 </span>            :   RefPtr&lt;Pledge&lt;bool&gt;&gt; p =
<span class="lineNum">    1411 </span>            :     aTrack-&gt;BlockSourceTrackId(aTrack-&gt;GetTrack()-&gt;mTrackID,
<a name="1412"><span class="lineNum">    1412 </span><span class="lineCov">          1 :                                BlockingMode::CREATION);</span></a>
<span class="lineNum">    1413 </span><span class="lineCov">          1 :   RefPtr&lt;DOMMediaStream&gt; self = this;</span>
<span class="lineNum">    1414 </span><span class="lineCov">          1 :   p-&gt;Then([self] (const bool&amp; aIgnore) { self-&gt;NotifyPlaybackTrackBlocked(); },</span>
<span class="lineNum">    1415 </span>            :           [] (const nsresult&amp; aIgnore) { NS_ERROR(&quot;Could not remove track from MSG&quot;); }
<span class="lineNum">    1416 </span><span class="lineCov">          1 :   );</span>
<span class="lineNum">    1417 </span><span class="lineCov">          1 : }</span>
<a name="1418"><span class="lineNum">    1418 </span>            : </a>
<span class="lineNum">    1419 </span>            : void
<span class="lineNum">    1420 </span><span class="lineCov">          1 : DOMMediaStream::NotifyPlaybackTrackBlocked()</span>
<span class="lineNum">    1421 </span>            : {
<span class="lineNum">    1422 </span>            :   MOZ_ASSERT(mTracksPendingRemoval &gt; 0,
<span class="lineNum">    1423 </span>            :              &quot;A track reported finished blocking more times than we asked for&quot;);
<span class="lineNum">    1424 </span><span class="lineCov">          1 :   if (--mTracksPendingRemoval == 0) {</span>
<span class="lineNum">    1425 </span>            :     // The MediaStreamGraph has reported a track was blocked and we are not
<span class="lineNum">    1426 </span>            :     // waiting for any further tracks to get blocked. It is now safe to
<span class="lineNum">    1427 </span>            :     // recompute the principal based on our main thread track set state.
<span class="lineNum">    1428 </span><span class="lineCov">          1 :     LOG(LogLevel::Debug, (&quot;DOMMediaStream %p saw all tracks pending removal &quot;</span>
<span class="lineNum">    1429 </span>            :                           &quot;finish. Recomputing principal.&quot;, this));
<span class="lineNum">    1430 </span><span class="lineCov">          1 :     RecomputePrincipal();</span>
<span class="lineNum">    1431 </span>            :   }
<a name="1432"><span class="lineNum">    1432 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    1433 </span>            : 
<span class="lineNum">    1434 </span><span class="lineCov">          1 : DOMLocalMediaStream::~DOMLocalMediaStream()</span>
<span class="lineNum">    1435 </span>            : {
<span class="lineNum">    1436 </span><span class="lineCov">          1 :   if (mInputStream) {</span>
<span class="lineNum">    1437 </span>            :     // Make sure Listeners of this stream know it's going away
<span class="lineNum">    1438 </span><span class="lineNoCov">          0 :     StopImpl();</span>
<span class="lineNum">    1439 </span>            :   }
<span class="lineNum">    1440 </span><span class="lineCov">          1 : }</span>
<a name="1441"><span class="lineNum">    1441 </span>            : </a>
<span class="lineNum">    1442 </span>            : JSObject*
<span class="lineNum">    1443 </span><span class="lineCov">          1 : DOMLocalMediaStream::WrapObject(JSContext* aCx, JS::Handle&lt;JSObject*&gt; aGivenProto)</span>
<span class="lineNum">    1444 </span>            : {
<span class="lineNum">    1445 </span><span class="lineCov">          1 :   return dom::LocalMediaStreamBinding::Wrap(aCx, this, aGivenProto);</span>
<span class="lineNum">    1446 </span>            : }
<a name="1447"><span class="lineNum">    1447 </span>            : </a>
<span class="lineNum">    1448 </span>            : void
<span class="lineNum">    1449 </span><span class="lineCov">          1 : DOMLocalMediaStream::Stop()</span>
<span class="lineNum">    1450 </span>            : {
<span class="lineNum">    1451 </span><span class="lineCov">          1 :   LOG(LogLevel::Debug, (&quot;DOMMediaStream %p Stop()&quot;, this));</span>
<span class="lineNum">    1452 </span><span class="lineCov">          1 :   nsCOMPtr&lt;nsPIDOMWindowInner&gt; pWindow = GetParentObject();</span>
<span class="lineNum">    1453 </span><span class="lineCov">          1 :   nsIDocument* document = pWindow ? pWindow-&gt;GetExtantDoc() : nullptr;</span>
<span class="lineNum">    1454 </span>            :   nsContentUtils::ReportToConsole(nsIScriptError::warningFlag,
<span class="lineNum">    1455 </span>            :                                   NS_LITERAL_CSTRING(&quot;Media&quot;),
<span class="lineNum">    1456 </span>            :                                   document,
<span class="lineNum">    1457 </span>            :                                   nsContentUtils::eDOM_PROPERTIES,
<span class="lineNum">    1458 </span><span class="lineCov">          1 :                                   &quot;MediaStreamStopDeprecatedWarning&quot;);</span>
<span class="lineNum">    1459 </span>            : 
<span class="lineNum">    1460 </span><span class="lineCov">          1 :   StopImpl();</span>
<span class="lineNum">    1461 </span><span class="lineCov">          1 : }</span>
<a name="1462"><span class="lineNum">    1462 </span>            : </a>
<span class="lineNum">    1463 </span>            : void
<span class="lineNum">    1464 </span><span class="lineCov">          1 : DOMLocalMediaStream::StopImpl()</span>
<span class="lineNum">    1465 </span>            : {
<span class="lineNum">    1466 </span><span class="lineCov">          1 :   if (mInputStream &amp;&amp; mInputStream-&gt;AsSourceStream()) {</span>
<span class="lineNum">    1467 </span><span class="lineCov">          1 :     mInputStream-&gt;AsSourceStream()-&gt;EndAllTrackAndFinish();</span>
<span class="lineNum">    1468 </span>            :   }
<span class="lineNum">    1469 </span><span class="lineCov">          1 : }</span>
<a name="1470"><span class="lineNum">    1470 </span>            : </a>
<span class="lineNum">    1471 </span>            : already_AddRefed&lt;DOMLocalMediaStream&gt;
<span class="lineNum">    1472 </span><span class="lineCov">          1 : DOMLocalMediaStream::CreateSourceStreamAsInput(nsPIDOMWindowInner* aWindow,</span>
<span class="lineNum">    1473 </span>            :                                                MediaStreamGraph* aGraph,
<span class="lineNum">    1474 </span>            :                                                MediaStreamTrackSourceGetter* aTrackSourceGetter)
<span class="lineNum">    1475 </span>            : {
<span class="lineNum">    1476 </span>            :   RefPtr&lt;DOMLocalMediaStream&gt; stream =
<span class="lineNum">    1477 </span><span class="lineCov">          1 :     new DOMLocalMediaStream(aWindow, aTrackSourceGetter);</span>
<span class="lineNum">    1478 </span><span class="lineCov">          1 :   stream-&gt;InitSourceStream(aGraph);</span>
<span class="lineNum">    1479 </span><span class="lineCov">          1 :   return stream.forget();</span>
<span class="lineNum">    1480 </span>            : }
<a name="1481"><span class="lineNum">    1481 </span>            : </a>
<span class="lineNum">    1482 </span>            : already_AddRefed&lt;DOMLocalMediaStream&gt;
<span class="lineNum">    1483 </span><span class="lineNoCov">          0 : DOMLocalMediaStream::CreateTrackUnionStreamAsInput(nsPIDOMWindowInner* aWindow,</span>
<span class="lineNum">    1484 </span>            :                                                    MediaStreamGraph* aGraph,
<span class="lineNum">    1485 </span>            :                                                    MediaStreamTrackSourceGetter* aTrackSourceGetter)
<span class="lineNum">    1486 </span>            : {
<span class="lineNum">    1487 </span>            :   RefPtr&lt;DOMLocalMediaStream&gt; stream =
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :     new DOMLocalMediaStream(aWindow, aTrackSourceGetter);</span>
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :   stream-&gt;InitTrackUnionStream(aGraph);</span>
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 :   return stream.forget();</span>
<a name="1491"><span class="lineNum">    1491 </span>            : }</a>
<span class="lineNum">    1492 </span>            : 
<span class="lineNum">    1493 </span><span class="lineCov">          1 : DOMAudioNodeMediaStream::DOMAudioNodeMediaStream(nsPIDOMWindowInner* aWindow, AudioNode* aNode)</span>
<span class="lineNum">    1494 </span>            :   : DOMMediaStream(aWindow, nullptr),
<span class="lineNum">    1495 </span><span class="lineCov">          1 :     mStreamNode(aNode)</span>
<span class="lineNum">    1496 </span>            : {
<a name="1497"><span class="lineNum">    1497 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    1498 </span>            : 
<span class="lineNum">    1499 </span><span class="lineCov">          1 : DOMAudioNodeMediaStream::~DOMAudioNodeMediaStream()</span>
<span class="lineNum">    1500 </span>            : {
<span class="lineNum">    1501 </span><span class="lineCov">          1 : }</span>
<a name="1502"><span class="lineNum">    1502 </span>            : </a>
<span class="lineNum">    1503 </span>            : already_AddRefed&lt;DOMAudioNodeMediaStream&gt;
<span class="lineNum">    1504 </span><span class="lineCov">          1 : DOMAudioNodeMediaStream::CreateTrackUnionStreamAsInput(nsPIDOMWindowInner* aWindow,</span>
<span class="lineNum">    1505 </span>            :                                                        AudioNode* aNode,
<span class="lineNum">    1506 </span>            :                                                        MediaStreamGraph* aGraph)
<span class="lineNum">    1507 </span>            : {
<span class="lineNum">    1508 </span><span class="lineCov">          1 :   RefPtr&lt;DOMAudioNodeMediaStream&gt; stream = new DOMAudioNodeMediaStream(aWindow, aNode);</span>
<span class="lineNum">    1509 </span><span class="lineCov">          1 :   stream-&gt;InitTrackUnionStream(aGraph);</span>
<span class="lineNum">    1510 </span><span class="lineCov">          1 :   return stream.forget();</span>
<a name="1511"><span class="lineNum">    1511 </span>            : }</a>
<span class="lineNum">    1512 </span>            : 
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 : DOMHwMediaStream::DOMHwMediaStream(nsPIDOMWindowInner* aWindow)</span>
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :   : DOMLocalMediaStream(aWindow, nullptr)</span>
<span class="lineNum">    1515 </span>            : {
<span class="lineNum">    1516 </span>            : #ifdef MOZ_WIDGET_GONK
<span class="lineNum">    1517 </span>            :   if (!mWindow) {
<span class="lineNum">    1518 </span>            :     NS_ERROR(&quot;Expected window here.&quot;);
<span class="lineNum">    1519 </span>            :     mPrincipalHandle = PRINCIPAL_HANDLE_NONE;
<span class="lineNum">    1520 </span>            :     return;
<span class="lineNum">    1521 </span>            :   }
<span class="lineNum">    1522 </span>            :   nsIDocument* doc = mWindow-&gt;GetExtantDoc();
<span class="lineNum">    1523 </span>            :   if (!doc) {
<span class="lineNum">    1524 </span>            :     NS_ERROR(&quot;Expected document here.&quot;);
<span class="lineNum">    1525 </span>            :     mPrincipalHandle = PRINCIPAL_HANDLE_NONE;
<span class="lineNum">    1526 </span>            :     return;
<span class="lineNum">    1527 </span>            :   }
<span class="lineNum">    1528 </span>            :   mPrincipalHandle = MakePrincipalHandle(doc-&gt;NodePrincipal());
<span class="lineNum">    1529 </span>            : #endif
<a name="1530"><span class="lineNum">    1530 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1531 </span>            : 
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 : DOMHwMediaStream::~DOMHwMediaStream()</span>
<span class="lineNum">    1533 </span>            : {
<span class="lineNum">    1534 </span><span class="lineNoCov">          0 : }</span>
<a name="1535"><span class="lineNum">    1535 </span>            : </a>
<span class="lineNum">    1536 </span>            : already_AddRefed&lt;DOMHwMediaStream&gt;
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 : DOMHwMediaStream::CreateHwStream(nsPIDOMWindowInner* aWindow,</span>
<span class="lineNum">    1538 </span>            :                                  OverlayImage* aImage)
<span class="lineNum">    1539 </span>            : {
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :   RefPtr&lt;DOMHwMediaStream&gt; stream = new DOMHwMediaStream(aWindow);</span>
<span class="lineNum">    1541 </span>            : 
<span class="lineNum">    1542 </span>            :   MediaStreamGraph* graph =
<span class="lineNum">    1543 </span>            :     MediaStreamGraph::GetInstance(MediaStreamGraph::SYSTEM_THREAD_DRIVER,
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :                                   AudioChannel::Normal);</span>
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :   stream-&gt;InitSourceStream(graph);</span>
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 :   stream-&gt;Init(stream-&gt;GetInputStream(), aImage);</span>
<span class="lineNum">    1547 </span>            : 
<span class="lineNum">    1548 </span><span class="lineNoCov">          0 :   return stream.forget();</span>
<span class="lineNum">    1549 </span>            : }
<a name="1550"><span class="lineNum">    1550 </span>            : </a>
<span class="lineNum">    1551 </span>            : void
<span class="lineNum">    1552 </span><span class="lineNoCov">          0 : DOMHwMediaStream::Init(MediaStream* stream, OverlayImage* aImage)</span>
<span class="lineNum">    1553 </span>            : {
<span class="lineNum">    1554 </span><span class="lineNoCov">          0 :   SourceMediaStream* srcStream = stream-&gt;AsSourceStream();</span>
<span class="lineNum">    1555 </span>            : 
<span class="lineNum">    1556 </span>            : #ifdef MOZ_WIDGET_GONK
<span class="lineNum">    1557 </span>            :   if (aImage) {
<span class="lineNum">    1558 </span>            :     mOverlayImage = aImage;
<span class="lineNum">    1559 </span>            :   } else {
<span class="lineNum">    1560 </span>            :     Data imageData;
<span class="lineNum">    1561 </span>            :     imageData.mOverlayId = DEFAULT_IMAGE_ID;
<span class="lineNum">    1562 </span>            :     imageData.mSize.width = DEFAULT_IMAGE_WIDTH;
<span class="lineNum">    1563 </span>            :     imageData.mSize.height = DEFAULT_IMAGE_HEIGHT;
<span class="lineNum">    1564 </span>            : 
<span class="lineNum">    1565 </span>            :     mOverlayImage = new OverlayImage();
<span class="lineNum">    1566 </span>            :     mOverlayImage-&gt;SetData(imageData);
<span class="lineNum">    1567 </span>            :   }
<span class="lineNum">    1568 </span>            : #endif
<span class="lineNum">    1569 </span>            : 
<span class="lineNum">    1570 </span><span class="lineNoCov">          0 :   if (srcStream) {</span>
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :     VideoSegment segment;</span>
<span class="lineNum">    1572 </span>            : #ifdef MOZ_WIDGET_GONK
<span class="lineNum">    1573 </span>            :     const StreamTime delta = STREAM_TIME_MAX; // Because MediaStreamGraph will run out frames in non-autoplay mode,
<span class="lineNum">    1574 </span>            :                                               // we must give it bigger frame length to cover this situation.
<span class="lineNum">    1575 </span>            : 
<span class="lineNum">    1576 </span>            :     RefPtr&lt;Image&gt; image = static_cast&lt;Image*&gt;(mOverlayImage.get());
<span class="lineNum">    1577 </span>            :     mozilla::gfx::IntSize size = image-&gt;GetSize();
<span class="lineNum">    1578 </span>            : 
<span class="lineNum">    1579 </span>            :     segment.AppendFrame(image.forget(), delta, size, mPrincipalHandle);
<span class="lineNum">    1580 </span>            : #endif
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :     srcStream-&gt;AddTrack(TRACK_VIDEO_PRIMARY, 0, new VideoSegment());</span>
<span class="lineNum">    1582 </span><span class="lineNoCov">          0 :     srcStream-&gt;AppendToTrack(TRACK_VIDEO_PRIMARY, &amp;segment);</span>
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :     srcStream-&gt;AdvanceKnownTracksTime(STREAM_TIME_MAX);</span>
<span class="lineNum">    1584 </span>            :   }
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 : }</span>
<a name="1586"><span class="lineNum">    1586 </span>            : </a>
<span class="lineNum">    1587 </span>            : int32_t
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 : DOMHwMediaStream::RequestOverlayId()</span>
<span class="lineNum">    1589 </span>            : {
<span class="lineNum">    1590 </span>            : #ifdef MOZ_WIDGET_GONK
<span class="lineNum">    1591 </span>            :   return mOverlayImage-&gt;GetOverlayId();
<span class="lineNum">    1592 </span>            : #else
<span class="lineNum">    1593 </span><span class="lineNoCov">          0 :   return -1;</span>
<span class="lineNum">    1594 </span>            : #endif
<span class="lineNum">    1595 </span>            : }
<a name="1596"><span class="lineNum">    1596 </span>            : </a>
<span class="lineNum">    1597 </span>            : void
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 : DOMHwMediaStream::SetImageSize(uint32_t width, uint32_t height)</span>
<span class="lineNum">    1599 </span>            : {
<span class="lineNum">    1600 </span>            : #ifdef MOZ_WIDGET_GONK
<span class="lineNum">    1601 </span>            :   if (mOverlayImage-&gt;GetSidebandStream().IsValid()) {
<span class="lineNum">    1602 </span>            :     OverlayImage::SidebandStreamData imgData;
<span class="lineNum">    1603 </span>            :     imgData.mStream = mOverlayImage-&gt;GetSidebandStream();
<span class="lineNum">    1604 </span>            :     imgData.mSize = IntSize(width, height);
<span class="lineNum">    1605 </span>            :     mOverlayImage-&gt;SetData(imgData);
<span class="lineNum">    1606 </span>            :   } else {
<span class="lineNum">    1607 </span>            :     OverlayImage::Data imgData;
<span class="lineNum">    1608 </span>            :     imgData.mOverlayId = mOverlayImage-&gt;GetOverlayId();
<span class="lineNum">    1609 </span>            :     imgData.mSize = IntSize(width, height);
<span class="lineNum">    1610 </span>            :     mOverlayImage-&gt;SetData(imgData);
<span class="lineNum">    1611 </span>            :   }
<span class="lineNum">    1612 </span>            : #endif
<span class="lineNum">    1613 </span>            : 
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :   SourceMediaStream* srcStream = GetInputStream()-&gt;AsSourceStream();</span>
<span class="lineNum">    1615 </span><span class="lineNoCov">          0 :   StreamTracks::Track* track = srcStream-&gt;FindTrack(TRACK_VIDEO_PRIMARY);</span>
<span class="lineNum">    1616 </span>            : 
<span class="lineNum">    1617 </span>            :   if (!track || !track-&gt;GetSegment()) {
<span class="lineNum">    1618 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    1619 </span>            :   }
<span class="lineNum">    1620 </span>            : 
<span class="lineNum">    1621 </span>            : #ifdef MOZ_WIDGET_GONK
<span class="lineNum">    1622 </span>            :   // Clear the old segment.
<span class="lineNum">    1623 </span>            :   // Changing the existing content of segment is a Very BAD thing, and this way will
<span class="lineNum">    1624 </span>            :   // confuse consumers of MediaStreams.
<span class="lineNum">    1625 </span>            :   // It is only acceptable for DOMHwMediaStream
<span class="lineNum">    1626 </span>            :   // because DOMHwMediaStream doesn't have consumers of TV streams currently.
<span class="lineNum">    1627 </span>            :   track-&gt;GetSegment()-&gt;Clear();
<span class="lineNum">    1628 </span>            : 
<span class="lineNum">    1629 </span>            :   // Change the image size.
<span class="lineNum">    1630 </span>            :   const StreamTime delta = STREAM_TIME_MAX;
<span class="lineNum">    1631 </span>            :   RefPtr&lt;Image&gt; image = static_cast&lt;Image*&gt;(mOverlayImage.get());
<span class="lineNum">    1632 </span>            :   mozilla::gfx::IntSize size = image-&gt;GetSize();
<span class="lineNum">    1633 </span>            :   VideoSegment segment;
<span class="lineNum">    1634 </span>            : 
<span class="lineNum">    1635 </span>            :   segment.AppendFrame(image.forget(), delta, size, mPrincipalHandle);
<span class="lineNum">    1636 </span>            :   srcStream-&gt;AppendToTrack(TRACK_VIDEO_PRIMARY, &amp;segment);
<span class="lineNum">    1637 </span>            : #endif
<span class="lineNum">    1638 </span>            : }
<a name="1639"><span class="lineNum">    1639 </span>            : </a>
<span class="lineNum">    1640 </span>            : void
<span class="lineNum">    1641 </span><span class="lineNoCov">          0 : DOMHwMediaStream::SetOverlayImage(OverlayImage* aImage)</span>
<span class="lineNum">    1642 </span>            : {
<span class="lineNum">    1643 </span><span class="lineNoCov">          0 :   if (!aImage) {</span>
<span class="lineNum">    1644 </span>            :     return;
<span class="lineNum">    1645 </span>            :   }
<span class="lineNum">    1646 </span>            : #ifdef MOZ_WIDGET_GONK
<span class="lineNum">    1647 </span>            :   mOverlayImage = aImage;
<span class="lineNum">    1648 </span>            : #endif
<span class="lineNum">    1649 </span>            : 
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :   SourceMediaStream* srcStream = GetInputStream()-&gt;AsSourceStream();</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :   StreamTracks::Track* track = srcStream-&gt;FindTrack(TRACK_VIDEO_PRIMARY);</span>
<span class="lineNum">    1652 </span>            : 
<span class="lineNum">    1653 </span>            :   if (!track || !track-&gt;GetSegment()) {
<span class="lineNum">    1654 </span>            :     return;
<span class="lineNum">    1655 </span>            :   }
<span class="lineNum">    1656 </span>            : 
<span class="lineNum">    1657 </span>            : #ifdef MOZ_WIDGET_GONK
<span class="lineNum">    1658 </span>            :   // Clear the old segment.
<span class="lineNum">    1659 </span>            :   // Changing the existing content of segment is a Very BAD thing, and this way will
<span class="lineNum">    1660 </span>            :   // confuse consumers of MediaStreams.
<span class="lineNum">    1661 </span>            :   // It is only acceptable for DOMHwMediaStream
<span class="lineNum">    1662 </span>            :   // because DOMHwMediaStream doesn't have consumers of TV streams currently.
<span class="lineNum">    1663 </span>            :   track-&gt;GetSegment()-&gt;Clear();
<span class="lineNum">    1664 </span>            : 
<span class="lineNum">    1665 </span>            :   // Change the image size.
<span class="lineNum">    1666 </span>            :   const StreamTime delta = STREAM_TIME_MAX;
<span class="lineNum">    1667 </span>            :   RefPtr&lt;Image&gt; image = static_cast&lt;Image*&gt;(mOverlayImage.get());
<span class="lineNum">    1668 </span>            :   mozilla::gfx::IntSize size = image-&gt;GetSize();
<span class="lineNum">    1669 </span>            :   VideoSegment segment;
<span class="lineNum">    1670 </span>            : 
<span class="lineNum">    1671 </span>            :   segment.AppendFrame(image.forget(), delta, size, mPrincipalHandle);
<span class="lineNum">    1672 </span>            :   srcStream-&gt;AppendToTrack(TRACK_VIDEO_PRIMARY, &amp;segment);
<span class="lineNum">    1673 </span>            : #endif
<span class="lineNum">    1674 </span>            : }
<a name="1675"><span class="lineNum">    1675 </span>            : </a>
<span class="lineNum">    1676 </span>            : void
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 : DOMHwMediaStream::SetOverlayId(int32_t aOverlayId)</span>
<span class="lineNum">    1678 </span>            : {
<span class="lineNum">    1679 </span>            : #ifdef MOZ_WIDGET_GONK
<span class="lineNum">    1680 </span>            :   OverlayImage::Data imgData;
<span class="lineNum">    1681 </span>            : 
<span class="lineNum">    1682 </span>            :   imgData.mOverlayId = aOverlayId;
<span class="lineNum">    1683 </span>            :   imgData.mSize = mOverlayImage-&gt;GetSize();
<span class="lineNum">    1684 </span>            : 
<span class="lineNum">    1685 </span>            :   mOverlayImage-&gt;SetData(imgData);
<span class="lineNum">    1686 </span>            : #endif
<span class="lineNum">    1687 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
