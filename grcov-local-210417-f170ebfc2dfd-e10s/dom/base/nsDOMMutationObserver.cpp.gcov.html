<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - dom/base/nsDOMMutationObserver.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">dom/base</a> - nsDOMMutationObserver.cpp<span style="font-size: 80%;"> (source / <a href="nsDOMMutationObserver.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">476</td>
            <td class="headerCovTableEntry">563</td>
            <td class="headerCovTableEntryMed">84.5 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21 12:24:28</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">54</td>
            <td class="headerCovTableEntry">62</td>
            <td class="headerCovTableEntryMed">87.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* vim: set ts=8 sts=2 et sw=2 tw=80: */
<span class="lineNum">       3 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       4 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this file,
<span class="lineNum">       5 </span>            :  * You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            : #include &quot;nsDOMMutationObserver.h&quot;
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : #include &quot;mozilla/AnimationTarget.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;mozilla/Maybe.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;mozilla/OwningNonNull.h&quot;
<span class="lineNum">      12 </span>            : 
<span class="lineNum">      13 </span>            : #include &quot;mozilla/dom/Animation.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;mozilla/dom/KeyframeEffectReadOnly.h&quot;
<span class="lineNum">      15 </span>            : 
<span class="lineNum">      16 </span>            : #include &quot;nsContentUtils.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;nsCSSPseudoElements.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;nsError.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;nsIDOMMutationEvent.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;nsIScriptGlobalObject.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;nsServiceManagerUtils.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;nsTextFragment.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;nsThreadUtils.h&quot;
<span class="lineNum">      24 </span>            : 
<span class="lineNum">      25 </span>            : using mozilla::Maybe;
<span class="lineNum">      26 </span>            : using mozilla::Move;
<span class="lineNum">      27 </span>            : using mozilla::NonOwningAnimationTarget;
<span class="lineNum">      28 </span>            : using mozilla::dom::TreeOrderComparator;
<span class="lineNum">      29 </span>            : using mozilla::dom::Animation;
<span class="lineNum">      30 </span>            : using mozilla::dom::Element;
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : AutoTArray&lt;RefPtr&lt;nsDOMMutationObserver&gt;, 4&gt;*
<span class="lineNum">      33 </span>            :   nsDOMMutationObserver::sScheduledMutationObservers = nullptr;
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : nsDOMMutationObserver* nsDOMMutationObserver::sCurrentObserver = nullptr;
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : uint32_t nsDOMMutationObserver::sMutationLevel = 0;
<span class="lineNum">      38 </span>            : uint64_t nsDOMMutationObserver::sCount = 0;
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : AutoTArray&lt;AutoTArray&lt;RefPtr&lt;nsDOMMutationObserver&gt;, 4&gt;, 4&gt;*
<span class="lineNum">      41 </span>            : nsDOMMutationObserver::sCurrentlyHandlingObservers = nullptr;
<a name="42"><span class="lineNum">      42 </span>            : </a>
<span class="lineNum">      43 </span>            : nsINodeList*
<span class="lineNum">      44 </span><span class="lineCov">          1 : nsDOMMutationRecord::AddedNodes()</span>
<span class="lineNum">      45 </span>            : {
<span class="lineNum">      46 </span><span class="lineCov">          1 :   if (!mAddedNodes) {</span>
<span class="lineNum">      47 </span><span class="lineCov">          1 :     mAddedNodes = new nsSimpleContentList(mTarget);</span>
<span class="lineNum">      48 </span>            :   }
<span class="lineNum">      49 </span><span class="lineCov">          1 :   return mAddedNodes;</span>
<span class="lineNum">      50 </span>            : }
<a name="51"><span class="lineNum">      51 </span>            : </a>
<span class="lineNum">      52 </span>            : nsINodeList*
<span class="lineNum">      53 </span><span class="lineCov">          1 : nsDOMMutationRecord::RemovedNodes()</span>
<span class="lineNum">      54 </span>            : {
<span class="lineNum">      55 </span><span class="lineCov">          1 :   if (!mRemovedNodes) {</span>
<span class="lineNum">      56 </span><span class="lineCov">          1 :     mRemovedNodes = new nsSimpleContentList(mTarget);</span>
<span class="lineNum">      57 </span>            :   }
<span class="lineNum">      58 </span><span class="lineCov">          1 :   return mRemovedNodes;</span>
<a name="59"><span class="lineNum">      59 </span>            : }</a>
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(nsDOMMutationRecord)</span>
<span class="lineNum">      62 </span><span class="lineCov">          1 :   NS_WRAPPERCACHE_INTERFACE_MAP_ENTRY</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :   NS_INTERFACE_MAP_ENTRY(nsISupports)</span>
<a name="64"><span class="lineNum">      64 </span><span class="lineNoCov">          0 : NS_INTERFACE_MAP_END</span></a>
<a name="65"><span class="lineNum">      65 </span>            : </a>
<span class="lineNum">      66 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTING_ADDREF(nsDOMMutationRecord)</span>
<a name="67"><span class="lineNum">      67 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTING_RELEASE(nsDOMMutationRecord)</span></a>
<span class="lineNum">      68 </span>            : 
<span class="lineNum">      69 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_WRAPPERCACHE(nsDOMMutationRecord,</span>
<span class="lineNum">      70 </span>            :                                       mTarget,
<span class="lineNum">      71 </span>            :                                       mPreviousSibling, mNextSibling,
<span class="lineNum">      72 </span>            :                                       mAddedNodes, mRemovedNodes,
<span class="lineNum">      73 </span>            :                                       mAddedAnimations, mRemovedAnimations,
<span class="lineNum">      74 </span>            :                                       mChangedAnimations,
<span class="lineNum">      75 </span>            :                                       mNext, mOwner)
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            : // Observer
<a name="78"><span class="lineNum">      78 </span>            : </a>
<span class="lineNum">      79 </span>            : bool
<span class="lineNum">      80 </span><span class="lineCov">          1 : nsMutationReceiverBase::IsObservable(nsIContent* aContent)</span>
<span class="lineNum">      81 </span>            : {
<span class="lineNum">      82 </span><span class="lineCov">          1 :   return !aContent-&gt;ChromeOnlyAccess() &amp;&amp;</span>
<span class="lineNum">      83 </span><span class="lineCov">          1 :     (Observer()-&gt;IsChrome() || !aContent-&gt;IsInAnonymousSubtree());</span>
<a name="84"><span class="lineNum">      84 </span>            : }</a>
<a name="85"><span class="lineNum">      85 </span>            : </a>
<span class="lineNum">      86 </span><span class="lineCov">          1 : NS_IMPL_ADDREF(nsMutationReceiver)</span>
<a name="87"><span class="lineNum">      87 </span><span class="lineCov">          1 : NS_IMPL_RELEASE(nsMutationReceiver)</span></a>
<span class="lineNum">      88 </span>            : 
<span class="lineNum">      89 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_BEGIN(nsMutationReceiver)</span>
<span class="lineNum">      90 </span><span class="lineCov">          1 :   NS_INTERFACE_MAP_ENTRY(nsISupports)</span>
<span class="lineNum">      91 </span><span class="lineCov">          1 :   NS_INTERFACE_MAP_ENTRY(nsIMutationObserver)</span>
<a name="92"><span class="lineNum">      92 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_END</span></a>
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span><span class="lineCov">          1 : nsMutationReceiver::nsMutationReceiver(nsINode* aTarget,</span>
<span class="lineNum">      95 </span>            :                                        nsDOMMutationObserver* aObserver)
<span class="lineNum">      96 </span><span class="lineCov">          1 : : nsMutationReceiverBase(aTarget, aObserver)</span>
<span class="lineNum">      97 </span>            : {
<span class="lineNum">      98 </span><span class="lineCov">          1 :   mTarget-&gt;BindObject(aObserver);</span>
<span class="lineNum">      99 </span><span class="lineCov">          1 : }</span>
<a name="100"><span class="lineNum">     100 </span>            : </a>
<span class="lineNum">     101 </span>            : void
<span class="lineNum">     102 </span><span class="lineCov">          1 : nsMutationReceiver::Disconnect(bool aRemoveFromObserver)</span>
<span class="lineNum">     103 </span>            : {
<span class="lineNum">     104 </span><span class="lineCov">          1 :   if (mRegisterTarget) {</span>
<span class="lineNum">     105 </span><span class="lineCov">          1 :     mRegisterTarget-&gt;RemoveMutationObserver(this);</span>
<span class="lineNum">     106 </span><span class="lineCov">          1 :     mRegisterTarget = nullptr;</span>
<span class="lineNum">     107 </span>            :   }
<span class="lineNum">     108 </span>            : 
<span class="lineNum">     109 </span><span class="lineCov">          1 :   mParent = nullptr;</span>
<span class="lineNum">     110 </span><span class="lineCov">          1 :   nsINode* target = mTarget;</span>
<span class="lineNum">     111 </span><span class="lineCov">          1 :   mTarget = nullptr;</span>
<span class="lineNum">     112 </span><span class="lineCov">          1 :   nsDOMMutationObserver* observer = mObserver;</span>
<span class="lineNum">     113 </span><span class="lineCov">          1 :   mObserver = nullptr;</span>
<span class="lineNum">     114 </span><span class="lineCov">          1 :   RemoveClones();</span>
<span class="lineNum">     115 </span>            : 
<span class="lineNum">     116 </span><span class="lineCov">          1 :   if (target &amp;&amp; observer) {</span>
<span class="lineNum">     117 </span><span class="lineCov">          1 :     if (aRemoveFromObserver) {</span>
<span class="lineNum">     118 </span>            :       static_cast&lt;nsDOMMutationObserver*&gt;(observer)-&gt;RemoveReceiver(this);
<span class="lineNum">     119 </span>            :     }
<span class="lineNum">     120 </span>            :     // UnbindObject may delete 'this'!
<span class="lineNum">     121 </span><span class="lineCov">          1 :     target-&gt;UnbindObject(observer);</span>
<span class="lineNum">     122 </span>            :   }
<span class="lineNum">     123 </span><span class="lineCov">          1 : }</span>
<a name="124"><span class="lineNum">     124 </span>            : </a>
<span class="lineNum">     125 </span>            : void
<span class="lineNum">     126 </span><span class="lineCov">          1 : nsMutationReceiver::NativeAnonymousChildListChange(nsIDocument* aDocument,</span>
<span class="lineNum">     127 </span>            :                                                    nsIContent* aContent,
<span class="lineNum">     128 </span>            :                                                    bool aIsRemove) {
<span class="lineNum">     129 </span><span class="lineCov">          1 :   if (!NativeAnonymousChildList()) {</span>
<span class="lineNum">     130 </span>            :     return;
<span class="lineNum">     131 </span>            :   }
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span><span class="lineCov">          1 :   nsINode* parent = aContent-&gt;GetParentNode();</span>
<span class="lineNum">     134 </span><span class="lineCov">          1 :   if (!parent ||</span>
<span class="lineNum">     135 </span><span class="lineCov">          1 :       (!Subtree() &amp;&amp; Target() != parent) ||</span>
<span class="lineNum">     136 </span><span class="lineCov">          1 :       (Subtree() &amp;&amp; RegisterTarget()-&gt;SubtreeRoot() != parent-&gt;SubtreeRoot())) {</span>
<span class="lineNum">     137 </span>            :     return;
<span class="lineNum">     138 </span>            :   }
<span class="lineNum">     139 </span>            : 
<span class="lineNum">     140 </span>            :   nsDOMMutationRecord* m =
<span class="lineNum">     141 </span><span class="lineCov">          1 :     Observer()-&gt;CurrentRecord(nsGkAtoms::nativeAnonymousChildList);</span>
<span class="lineNum">     142 </span>            : 
<span class="lineNum">     143 </span><span class="lineCov">          1 :   if (m-&gt;mTarget) {</span>
<span class="lineNum">     144 </span>            :     return;
<span class="lineNum">     145 </span>            :   }
<span class="lineNum">     146 </span><span class="lineCov">          1 :   m-&gt;mTarget = parent;</span>
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span><span class="lineCov">          1 :   if (aIsRemove) {</span>
<span class="lineNum">     149 </span><span class="lineCov">          1 :     m-&gt;mRemovedNodes = new nsSimpleContentList(parent);</span>
<span class="lineNum">     150 </span><span class="lineCov">          1 :     m-&gt;mRemovedNodes-&gt;AppendElement(aContent);</span>
<span class="lineNum">     151 </span>            :   } else {
<span class="lineNum">     152 </span><span class="lineCov">          1 :     m-&gt;mAddedNodes = new nsSimpleContentList(parent);</span>
<span class="lineNum">     153 </span><span class="lineCov">          1 :     m-&gt;mAddedNodes-&gt;AppendElement(aContent);</span>
<span class="lineNum">     154 </span>            :   }
<span class="lineNum">     155 </span>            : }
<a name="156"><span class="lineNum">     156 </span>            : </a>
<span class="lineNum">     157 </span>            : void
<span class="lineNum">     158 </span><span class="lineCov">          1 : nsMutationReceiver::AttributeWillChange(nsIDocument* aDocument,</span>
<span class="lineNum">     159 </span>            :                                         mozilla::dom::Element* aElement,
<span class="lineNum">     160 </span>            :                                         int32_t aNameSpaceID,
<span class="lineNum">     161 </span>            :                                         nsIAtom* aAttribute,
<span class="lineNum">     162 </span>            :                                         int32_t aModType,
<span class="lineNum">     163 </span>            :                                         const nsAttrValue* aNewValue)
<span class="lineNum">     164 </span>            : {
<span class="lineNum">     165 </span><span class="lineCov">          1 :   if (nsAutoMutationBatch::IsBatching() ||</span>
<span class="lineNum">     166 </span><span class="lineCov">          1 :       !ObservesAttr(RegisterTarget(), aElement, aNameSpaceID, aAttribute)) {</span>
<span class="lineNum">     167 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">     168 </span>            :   }
<span class="lineNum">     169 </span>            : 
<span class="lineNum">     170 </span>            :   nsDOMMutationRecord* m =
<span class="lineNum">     171 </span><span class="lineCov">          1 :     Observer()-&gt;CurrentRecord(nsGkAtoms::attributes);</span>
<span class="lineNum">     172 </span>            : 
<span class="lineNum">     173 </span>            :   NS_ASSERTION(!m-&gt;mTarget || m-&gt;mTarget == aElement,
<span class="lineNum">     174 </span>            :                &quot;Wrong target!&quot;);
<span class="lineNum">     175 </span>            :   NS_ASSERTION(!m-&gt;mAttrName || m-&gt;mAttrName == aAttribute,
<span class="lineNum">     176 </span>            :                &quot;Wrong attribute!&quot;);
<span class="lineNum">     177 </span><span class="lineCov">          1 :   if (!m-&gt;mTarget) {</span>
<span class="lineNum">     178 </span><span class="lineCov">          1 :     m-&gt;mTarget = aElement;</span>
<span class="lineNum">     179 </span><span class="lineCov">          1 :     m-&gt;mAttrName = aAttribute;</span>
<span class="lineNum">     180 </span><span class="lineCov">          1 :     if (aNameSpaceID == kNameSpaceID_None) {</span>
<span class="lineNum">     181 </span><span class="lineCov">          1 :       m-&gt;mAttrNamespace.SetIsVoid(true);</span>
<span class="lineNum">     182 </span>            :     } else {
<span class="lineNum">     183 </span>            :       nsContentUtils::NameSpaceManager()-&gt;GetNameSpaceURI(aNameSpaceID,
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :                                                           m-&gt;mAttrNamespace);</span>
<span class="lineNum">     185 </span>            :     }
<span class="lineNum">     186 </span>            :   }
<span class="lineNum">     187 </span>            : 
<span class="lineNum">     188 </span><span class="lineCov">          1 :   if (AttributeOldValue() &amp;&amp; m-&gt;mPrevValue.IsVoid()) {</span>
<span class="lineNum">     189 </span><span class="lineCov">          1 :     if (!aElement-&gt;GetAttr(aNameSpaceID, aAttribute, m-&gt;mPrevValue)) {</span>
<span class="lineNum">     190 </span><span class="lineCov">          1 :       m-&gt;mPrevValue.SetIsVoid(true);</span>
<span class="lineNum">     191 </span>            :     }
<span class="lineNum">     192 </span>            :   }
<span class="lineNum">     193 </span>            : }
<a name="194"><span class="lineNum">     194 </span>            : </a>
<span class="lineNum">     195 </span>            : void
<span class="lineNum">     196 </span><span class="lineCov">          1 : nsMutationReceiver::CharacterDataWillChange(nsIDocument *aDocument,</span>
<span class="lineNum">     197 </span>            :                                             nsIContent* aContent,
<span class="lineNum">     198 </span>            :                                             CharacterDataChangeInfo* aInfo)
<span class="lineNum">     199 </span>            : {
<span class="lineNum">     200 </span><span class="lineCov">          1 :   if (nsAutoMutationBatch::IsBatching() ||</span>
<span class="lineNum">     201 </span><span class="lineCov">          1 :       !CharacterData() ||</span>
<span class="lineNum">     202 </span><span class="lineCov">          1 :       (!Subtree() &amp;&amp; aContent != Target()) ||</span>
<span class="lineNum">     203 </span><span class="lineCov">          1 :       (Subtree() &amp;&amp; RegisterTarget()-&gt;SubtreeRoot() != aContent-&gt;SubtreeRoot()) ||</span>
<span class="lineNum">     204 </span><span class="lineCov">          1 :       !IsObservable(aContent)) {</span>
<span class="lineNum">     205 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">     206 </span>            :   }
<span class="lineNum">     207 </span>            : 
<span class="lineNum">     208 </span>            :   nsDOMMutationRecord* m =
<span class="lineNum">     209 </span><span class="lineCov">          1 :     Observer()-&gt;CurrentRecord(nsGkAtoms::characterData);</span>
<span class="lineNum">     210 </span>            : 
<span class="lineNum">     211 </span>            :   NS_ASSERTION(!m-&gt;mTarget || m-&gt;mTarget == aContent,
<span class="lineNum">     212 </span>            :                &quot;Wrong target!&quot;);
<span class="lineNum">     213 </span>            : 
<span class="lineNum">     214 </span><span class="lineCov">          1 :   if (!m-&gt;mTarget) {</span>
<span class="lineNum">     215 </span><span class="lineCov">          1 :     m-&gt;mTarget = aContent;</span>
<span class="lineNum">     216 </span>            :   }
<span class="lineNum">     217 </span><span class="lineCov">          1 :   if (CharacterDataOldValue() &amp;&amp; m-&gt;mPrevValue.IsVoid()) { </span>
<span class="lineNum">     218 </span><span class="lineCov">          1 :     aContent-&gt;GetText()-&gt;AppendTo(m-&gt;mPrevValue);</span>
<span class="lineNum">     219 </span>            :   }
<span class="lineNum">     220 </span>            : }
<a name="221"><span class="lineNum">     221 </span>            : </a>
<span class="lineNum">     222 </span>            : void
<span class="lineNum">     223 </span><span class="lineCov">          1 : nsMutationReceiver::ContentAppended(nsIDocument* aDocument,</span>
<span class="lineNum">     224 </span>            :                                     nsIContent* aContainer,
<span class="lineNum">     225 </span>            :                                     nsIContent* aFirstNewContent,
<span class="lineNum">     226 </span>            :                                     int32_t aNewIndexInContainer)
<span class="lineNum">     227 </span>            : {
<span class="lineNum">     228 </span><span class="lineCov">          1 :   nsINode* parent = NODE_FROM(aContainer, aDocument);</span>
<span class="lineNum">     229 </span>            :   bool wantsChildList =
<span class="lineNum">     230 </span><span class="lineCov">          1 :     ChildList() &amp;&amp;</span>
<span class="lineNum">     231 </span><span class="lineCov">          1 :     ((Subtree() &amp;&amp; RegisterTarget()-&gt;SubtreeRoot() == parent-&gt;SubtreeRoot()) ||</span>
<span class="lineNum">     232 </span><span class="lineCov">          1 :      parent == Target());</span>
<span class="lineNum">     233 </span><span class="lineCov">          1 :   if (!wantsChildList || !IsObservable(aFirstNewContent)) {</span>
<span class="lineNum">     234 </span>            :     return;
<span class="lineNum">     235 </span>            :   }
<span class="lineNum">     236 </span>            : 
<span class="lineNum">     237 </span><span class="lineCov">          1 :   if (nsAutoMutationBatch::IsBatching()) {</span>
<span class="lineNum">     238 </span><span class="lineCov">          1 :     if (parent == nsAutoMutationBatch::GetBatchTarget()) {</span>
<span class="lineNum">     239 </span><span class="lineCov">          1 :       nsAutoMutationBatch::UpdateObserver(Observer(), wantsChildList);</span>
<span class="lineNum">     240 </span>            :     }
<span class="lineNum">     241 </span>            :     return;
<span class="lineNum">     242 </span>            :   }
<span class="lineNum">     243 </span>            : 
<span class="lineNum">     244 </span>            :   nsDOMMutationRecord* m =
<span class="lineNum">     245 </span><span class="lineCov">          1 :     Observer()-&gt;CurrentRecord(nsGkAtoms::childList);</span>
<span class="lineNum">     246 </span>            :   NS_ASSERTION(!m-&gt;mTarget || m-&gt;mTarget == parent,
<span class="lineNum">     247 </span>            :                &quot;Wrong target!&quot;);
<span class="lineNum">     248 </span><span class="lineCov">          1 :   if (m-&gt;mTarget) {</span>
<span class="lineNum">     249 </span>            :     // Already handled case.
<span class="lineNum">     250 </span>            :     return;
<span class="lineNum">     251 </span>            :   }
<span class="lineNum">     252 </span><span class="lineCov">          1 :   m-&gt;mTarget = parent;</span>
<span class="lineNum">     253 </span><span class="lineCov">          1 :   m-&gt;mAddedNodes = new nsSimpleContentList(parent);</span>
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span><span class="lineCov">          1 :   nsINode* n = aFirstNewContent;</span>
<span class="lineNum">     256 </span><span class="lineCov">          1 :   while (n) {</span>
<span class="lineNum">     257 </span><span class="lineCov">          1 :     m-&gt;mAddedNodes-&gt;AppendElement(static_cast&lt;nsIContent*&gt;(n));</span>
<span class="lineNum">     258 </span><span class="lineCov">          1 :     n = n-&gt;GetNextSibling();</span>
<span class="lineNum">     259 </span>            :   }
<span class="lineNum">     260 </span><span class="lineCov">          1 :   m-&gt;mPreviousSibling = aFirstNewContent-&gt;GetPreviousSibling();</span>
<span class="lineNum">     261 </span>            : }
<a name="262"><span class="lineNum">     262 </span>            : </a>
<span class="lineNum">     263 </span>            : void
<span class="lineNum">     264 </span><span class="lineCov">          1 : nsMutationReceiver::ContentInserted(nsIDocument* aDocument,</span>
<span class="lineNum">     265 </span>            :                                     nsIContent* aContainer,
<span class="lineNum">     266 </span>            :                                     nsIContent* aChild,
<span class="lineNum">     267 </span>            :                                     int32_t aIndexInContainer)
<span class="lineNum">     268 </span>            : {
<span class="lineNum">     269 </span><span class="lineCov">          1 :   nsINode* parent = NODE_FROM(aContainer, aDocument);</span>
<span class="lineNum">     270 </span>            :   bool wantsChildList =
<span class="lineNum">     271 </span><span class="lineCov">          1 :     ChildList() &amp;&amp;</span>
<span class="lineNum">     272 </span><span class="lineCov">          1 :     ((Subtree() &amp;&amp; RegisterTarget()-&gt;SubtreeRoot() == parent-&gt;SubtreeRoot()) ||</span>
<span class="lineNum">     273 </span><span class="lineCov">          1 :      parent == Target());</span>
<span class="lineNum">     274 </span><span class="lineCov">          1 :   if (!wantsChildList || !IsObservable(aChild)) {</span>
<span class="lineNum">     275 </span>            :     return;
<span class="lineNum">     276 </span>            :   }
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span><span class="lineCov">          1 :   if (nsAutoMutationBatch::IsBatching()) {</span>
<span class="lineNum">     279 </span><span class="lineCov">          1 :     if (parent == nsAutoMutationBatch::GetBatchTarget()) {</span>
<span class="lineNum">     280 </span><span class="lineCov">          1 :       nsAutoMutationBatch::UpdateObserver(Observer(), wantsChildList);</span>
<span class="lineNum">     281 </span>            :     }
<span class="lineNum">     282 </span>            :     return;
<span class="lineNum">     283 </span>            :   }
<span class="lineNum">     284 </span>            : 
<span class="lineNum">     285 </span>            :   nsDOMMutationRecord* m =
<span class="lineNum">     286 </span><span class="lineCov">          1 :     Observer()-&gt;CurrentRecord(nsGkAtoms::childList);</span>
<span class="lineNum">     287 </span><span class="lineCov">          1 :   if (m-&gt;mTarget) {</span>
<span class="lineNum">     288 </span>            :     // Already handled case.
<span class="lineNum">     289 </span>            :     return;  
<span class="lineNum">     290 </span>            :   }
<span class="lineNum">     291 </span><span class="lineCov">          1 :   m-&gt;mTarget = parent;</span>
<span class="lineNum">     292 </span><span class="lineCov">          1 :   m-&gt;mAddedNodes = new nsSimpleContentList(parent);</span>
<span class="lineNum">     293 </span><span class="lineCov">          1 :   m-&gt;mAddedNodes-&gt;AppendElement(aChild);</span>
<span class="lineNum">     294 </span><span class="lineCov">          1 :   m-&gt;mPreviousSibling = aChild-&gt;GetPreviousSibling();</span>
<span class="lineNum">     295 </span><span class="lineCov">          1 :   m-&gt;mNextSibling = aChild-&gt;GetNextSibling();</span>
<span class="lineNum">     296 </span>            : }
<a name="297"><span class="lineNum">     297 </span>            : </a>
<span class="lineNum">     298 </span>            : void
<span class="lineNum">     299 </span><span class="lineCov">          1 : nsMutationReceiver::ContentRemoved(nsIDocument* aDocument,</span>
<span class="lineNum">     300 </span>            :                                    nsIContent* aContainer,
<span class="lineNum">     301 </span>            :                                    nsIContent* aChild,
<span class="lineNum">     302 </span>            :                                    int32_t aIndexInContainer,
<span class="lineNum">     303 </span>            :                                    nsIContent* aPreviousSibling)
<span class="lineNum">     304 </span>            : {
<span class="lineNum">     305 </span><span class="lineCov">          1 :   if (!IsObservable(aChild)) {</span>
<span class="lineNum">     306 </span>            :     return;
<span class="lineNum">     307 </span>            :   }
<span class="lineNum">     308 </span>            : 
<span class="lineNum">     309 </span><span class="lineCov">          1 :   nsINode* parent = NODE_FROM(aContainer, aDocument);</span>
<span class="lineNum">     310 </span><span class="lineCov">          1 :   if (Subtree() &amp;&amp; parent-&gt;SubtreeRoot() != RegisterTarget()-&gt;SubtreeRoot()) {</span>
<span class="lineNum">     311 </span>            :     return;
<span class="lineNum">     312 </span>            :   }
<span class="lineNum">     313 </span><span class="lineCov">          1 :   if (nsAutoMutationBatch::IsBatching()) {</span>
<span class="lineNum">     314 </span><span class="lineCov">          1 :     if (nsAutoMutationBatch::IsRemovalDone()) {</span>
<span class="lineNum">     315 </span>            :       // This can happen for example if HTML parser parses to
<span class="lineNum">     316 </span>            :       // context node, but needs to move elements around.
<span class="lineNum">     317 </span>            :       return;
<span class="lineNum">     318 </span>            :     }
<span class="lineNum">     319 </span><span class="lineCov">          1 :     if (nsAutoMutationBatch::GetBatchTarget() != parent) {</span>
<span class="lineNum">     320 </span>            :       return;
<span class="lineNum">     321 </span>            :     }
<span class="lineNum">     322 </span>            : 
<span class="lineNum">     323 </span><span class="lineCov">          1 :     bool wantsChildList = ChildList() &amp;&amp; (Subtree() || parent == Target());</span>
<span class="lineNum">     324 </span><span class="lineCov">          1 :     if (wantsChildList || Subtree()) {</span>
<span class="lineNum">     325 </span><span class="lineCov">          1 :       nsAutoMutationBatch::NodeRemoved(aChild);</span>
<span class="lineNum">     326 </span><span class="lineCov">          1 :       nsAutoMutationBatch::UpdateObserver(Observer(), wantsChildList);</span>
<span class="lineNum">     327 </span>            :     }
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span>            :     return;
<span class="lineNum">     330 </span>            :   }
<span class="lineNum">     331 </span>            : 
<span class="lineNum">     332 </span><span class="lineCov">          1 :   if (Subtree()) {</span>
<span class="lineNum">     333 </span>            :     // Try to avoid creating transient observer if the node
<span class="lineNum">     334 </span>            :     // already has an observer observing the same set of nodes.
<span class="lineNum">     335 </span><span class="lineCov">          1 :     nsMutationReceiver* orig = GetParent() ? GetParent() : this;</span>
<span class="lineNum">     336 </span><span class="lineCov">          1 :     if (Observer()-&gt;GetReceiverFor(aChild, false, false) != orig) {</span>
<span class="lineNum">     337 </span><span class="lineCov">          1 :       bool transientExists = false;</span>
<span class="lineNum">     338 </span><span class="lineCov">          1 :       nsCOMArray&lt;nsMutationReceiver&gt;* transientReceivers = nullptr;</span>
<span class="lineNum">     339 </span><span class="lineCov">          1 :       Observer()-&gt;mTransientReceivers.Get(aChild, &amp;transientReceivers);</span>
<span class="lineNum">     340 </span><span class="lineCov">          1 :       if (!transientReceivers) {</span>
<span class="lineNum">     341 </span><span class="lineCov">          1 :         transientReceivers = new nsCOMArray&lt;nsMutationReceiver&gt;();</span>
<span class="lineNum">     342 </span><span class="lineCov">          1 :         Observer()-&gt;mTransientReceivers.Put(aChild, transientReceivers);</span>
<span class="lineNum">     343 </span>            :       } else {
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :         for (int32_t i = 0; i &lt; transientReceivers-&gt;Count(); ++i) {</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :           nsMutationReceiver* r = transientReceivers-&gt;ObjectAt(i);</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :           if (r-&gt;GetParent() == orig) {</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :             transientExists = true;</span>
<span class="lineNum">     348 </span>            :           }
<span class="lineNum">     349 </span>            :         }
<span class="lineNum">     350 </span>            :       }
<span class="lineNum">     351 </span><span class="lineCov">          1 :       if (!transientExists) {</span>
<span class="lineNum">     352 </span>            :         // Make sure the elements which are removed from the
<span class="lineNum">     353 </span>            :         // subtree are kept in the same observation set.
<span class="lineNum">     354 </span>            :         nsMutationReceiver* tr;
<span class="lineNum">     355 </span><span class="lineCov">          1 :         if (orig-&gt;Animations()) {</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :           tr = nsAnimationReceiver::Create(aChild, orig);</span>
<span class="lineNum">     357 </span>            :         } else {
<span class="lineNum">     358 </span><span class="lineCov">          1 :           tr = nsMutationReceiver::Create(aChild, orig);</span>
<span class="lineNum">     359 </span>            :         }
<span class="lineNum">     360 </span><span class="lineCov">          1 :         transientReceivers-&gt;AppendObject(tr);</span>
<span class="lineNum">     361 </span>            :       }
<span class="lineNum">     362 </span>            :     }
<span class="lineNum">     363 </span>            :   }
<span class="lineNum">     364 </span>            : 
<span class="lineNum">     365 </span><span class="lineCov">          1 :   if (ChildList() &amp;&amp; (Subtree() || parent == Target())) {</span>
<span class="lineNum">     366 </span>            :     nsDOMMutationRecord* m =
<span class="lineNum">     367 </span><span class="lineCov">          1 :       Observer()-&gt;CurrentRecord(nsGkAtoms::childList);</span>
<span class="lineNum">     368 </span><span class="lineCov">          1 :     if (m-&gt;mTarget) {</span>
<span class="lineNum">     369 </span>            :       // Already handled case.
<span class="lineNum">     370 </span>            :       return;
<span class="lineNum">     371 </span>            :     }
<span class="lineNum">     372 </span><span class="lineCov">          1 :     m-&gt;mTarget = parent;</span>
<span class="lineNum">     373 </span><span class="lineCov">          1 :     m-&gt;mRemovedNodes = new nsSimpleContentList(parent);</span>
<span class="lineNum">     374 </span><span class="lineCov">          1 :     m-&gt;mRemovedNodes-&gt;AppendElement(aChild);</span>
<span class="lineNum">     375 </span><span class="lineCov">          1 :     m-&gt;mPreviousSibling = aPreviousSibling;</span>
<span class="lineNum">     376 </span><span class="lineCov">          1 :     m-&gt;mNextSibling = parent-&gt;GetChildAt(aIndexInContainer);</span>
<span class="lineNum">     377 </span>            :   }
<span class="lineNum">     378 </span>            :   // We need to schedule always, so that after microtask mTransientReceivers
<span class="lineNum">     379 </span>            :   // can be cleared correctly.
<span class="lineNum">     380 </span><span class="lineCov">          1 :   Observer()-&gt;ScheduleForRun();</span>
<a name="381"><span class="lineNum">     381 </span>            : }</a>
<span class="lineNum">     382 </span>            : 
<span class="lineNum">     383 </span><span class="lineNoCov">          0 : void nsMutationReceiver::NodeWillBeDestroyed(const nsINode *aNode)</span>
<span class="lineNum">     384 </span>            : {
<span class="lineNum">     385 </span>            :   NS_ASSERTION(!mParent, &quot;Shouldn't have mParent here!&quot;);
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :   Disconnect(true);</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 : }</span>
<a name="388"><span class="lineNum">     388 </span>            : </a>
<span class="lineNum">     389 </span>            : void
<span class="lineNum">     390 </span><span class="lineCov">          1 : nsAnimationReceiver::RecordAnimationMutation(Animation* aAnimation,</span>
<span class="lineNum">     391 </span>            :                                              AnimationMutation aMutationType)
<span class="lineNum">     392 </span>            : {
<span class="lineNum">     393 </span><span class="lineCov">          1 :   mozilla::dom::AnimationEffectReadOnly* effect = aAnimation-&gt;GetEffect();</span>
<span class="lineNum">     394 </span><span class="lineCov">          1 :   if (!effect) {</span>
<span class="lineNum">     395 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">     396 </span>            :   }
<span class="lineNum">     397 </span>            : 
<span class="lineNum">     398 </span>            :   mozilla::dom::KeyframeEffectReadOnly* keyframeEffect =
<span class="lineNum">     399 </span><span class="lineCov">          1 :     effect-&gt;AsKeyframeEffect();</span>
<span class="lineNum">     400 </span><span class="lineCov">          1 :   if (!keyframeEffect) {</span>
<span class="lineNum">     401 </span>            :     return;
<span class="lineNum">     402 </span>            :   }
<span class="lineNum">     403 </span>            : 
<span class="lineNum">     404 </span><span class="lineCov">          1 :   Maybe&lt;NonOwningAnimationTarget&gt; animationTarget = keyframeEffect-&gt;GetTarget();</span>
<span class="lineNum">     405 </span><span class="lineCov">          1 :   if (!animationTarget) {</span>
<span class="lineNum">     406 </span>            :     return;
<span class="lineNum">     407 </span>            :   }
<span class="lineNum">     408 </span>            : 
<span class="lineNum">     409 </span><span class="lineCov">          1 :   Element* elem = animationTarget-&gt;mElement;</span>
<span class="lineNum">     410 </span><span class="lineCov">          1 :   if (!Animations() || !(Subtree() || elem == Target()) ||</span>
<span class="lineNum">     411 </span><span class="lineCov">          1 :       elem-&gt;ChromeOnlyAccess()) {</span>
<span class="lineNum">     412 </span>            :     return;
<span class="lineNum">     413 </span>            :   }
<span class="lineNum">     414 </span>            : 
<span class="lineNum">     415 </span>            :   // Record animations targeting to a pseudo element only when subtree is true.
<span class="lineNum">     416 </span><span class="lineCov">          1 :   if (animationTarget-&gt;mPseudoType != mozilla::CSSPseudoElementType::NotPseudo &amp;&amp;</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :       !Subtree()) {</span>
<span class="lineNum">     418 </span>            :     return;
<span class="lineNum">     419 </span>            :   }
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineCov">          1 :   if (nsAutoAnimationMutationBatch::IsBatching()) {</span>
<span class="lineNum">     422 </span><span class="lineCov">          1 :     switch (aMutationType) {</span>
<span class="lineNum">     423 </span>            :       case eAnimationMutation_Added:
<span class="lineNum">     424 </span><span class="lineCov">          1 :         nsAutoAnimationMutationBatch::AnimationAdded(aAnimation, elem);</span>
<span class="lineNum">     425 </span><span class="lineCov">          1 :         break;</span>
<span class="lineNum">     426 </span>            :       case eAnimationMutation_Changed:
<span class="lineNum">     427 </span><span class="lineCov">          1 :         nsAutoAnimationMutationBatch::AnimationChanged(aAnimation, elem);</span>
<span class="lineNum">     428 </span><span class="lineCov">          1 :         break;</span>
<span class="lineNum">     429 </span>            :       case eAnimationMutation_Removed:
<span class="lineNum">     430 </span><span class="lineCov">          1 :         nsAutoAnimationMutationBatch::AnimationRemoved(aAnimation, elem);</span>
<span class="lineNum">     431 </span><span class="lineCov">          1 :         break;</span>
<span class="lineNum">     432 </span>            :     }
<span class="lineNum">     433 </span>            : 
<span class="lineNum">     434 </span><span class="lineCov">          1 :     nsAutoAnimationMutationBatch::AddObserver(Observer());</span>
<span class="lineNum">     435 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">     436 </span>            :   }
<span class="lineNum">     437 </span>            : 
<span class="lineNum">     438 </span>            :   nsDOMMutationRecord* m =
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :     Observer()-&gt;CurrentRecord(nsGkAtoms::animations);</span>
<span class="lineNum">     440 </span>            : 
<span class="lineNum">     441 </span>            :   NS_ASSERTION(!m-&gt;mTarget, &quot;Wrong target!&quot;);
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :   m-&gt;mTarget = elem;</span>
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :   switch (aMutationType) {</span>
<span class="lineNum">     446 </span>            :     case eAnimationMutation_Added:
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :       m-&gt;mAddedAnimations.AppendElement(aAnimation);</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">     449 </span>            :     case eAnimationMutation_Changed:
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :       m-&gt;mChangedAnimations.AppendElement(aAnimation);</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">     452 </span>            :     case eAnimationMutation_Removed:
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :       m-&gt;mRemovedAnimations.AppendElement(aAnimation);</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">     455 </span>            :   }
<span class="lineNum">     456 </span>            : }
<a name="457"><span class="lineNum">     457 </span>            : </a>
<span class="lineNum">     458 </span>            : void
<span class="lineNum">     459 </span><span class="lineCov">          1 : nsAnimationReceiver::AnimationAdded(Animation* aAnimation)</span>
<span class="lineNum">     460 </span>            : {
<span class="lineNum">     461 </span><span class="lineCov">          1 :   RecordAnimationMutation(aAnimation, eAnimationMutation_Added);</span>
<span class="lineNum">     462 </span><span class="lineCov">          1 : }</span>
<a name="463"><span class="lineNum">     463 </span>            : </a>
<span class="lineNum">     464 </span>            : void
<span class="lineNum">     465 </span><span class="lineCov">          1 : nsAnimationReceiver::AnimationChanged(Animation* aAnimation)</span>
<span class="lineNum">     466 </span>            : {
<span class="lineNum">     467 </span><span class="lineCov">          1 :   RecordAnimationMutation(aAnimation, eAnimationMutation_Changed);</span>
<span class="lineNum">     468 </span><span class="lineCov">          1 : }</span>
<a name="469"><span class="lineNum">     469 </span>            : </a>
<span class="lineNum">     470 </span>            : void
<span class="lineNum">     471 </span><span class="lineCov">          1 : nsAnimationReceiver::AnimationRemoved(Animation* aAnimation)</span>
<span class="lineNum">     472 </span>            : {
<span class="lineNum">     473 </span><span class="lineCov">          1 :   RecordAnimationMutation(aAnimation, eAnimationMutation_Removed);</span>
<a name="474"><span class="lineNum">     474 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span><span class="lineCov">          1 : NS_IMPL_ISUPPORTS_INHERITED(nsAnimationReceiver, nsMutationReceiver,</span>
<span class="lineNum">     477 </span>            :                             nsIAnimationObserver)
<span class="lineNum">     478 </span>            : 
<a name="479"><span class="lineNum">     479 </span>            : // Observer</a>
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(nsDOMMutationObserver)</span>
<span class="lineNum">     482 </span><span class="lineCov">          1 :   NS_WRAPPERCACHE_INTERFACE_MAP_ENTRY</span>
<span class="lineNum">     483 </span><span class="lineCov">          1 :   NS_INTERFACE_MAP_ENTRY(nsISupports)</span>
<span class="lineNum">     484 </span><span class="lineCov">          1 :   NS_INTERFACE_MAP_ENTRY(nsDOMMutationObserver)</span>
<a name="485"><span class="lineNum">     485 </span><span class="lineCov">          1 : NS_INTERFACE_MAP_END</span></a>
<a name="486"><span class="lineNum">     486 </span>            : </a>
<span class="lineNum">     487 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTING_ADDREF(nsDOMMutationObserver)</span>
<span class="lineNum">     488 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTING_RELEASE(nsDOMMutationObserver)</span>
<span class="lineNum">     489 </span>            : 
<a name="490"><span class="lineNum">     490 </span>            : NS_IMPL_CYCLE_COLLECTION_CLASS(nsDOMMutationObserver)</a>
<span class="lineNum">     491 </span>            : 
<span class="lineNum">     492 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_TRACE_BEGIN(nsDOMMutationObserver)</span>
<span class="lineNum">     493 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRACE_PRESERVED_WRAPPER</span>
<a name="494"><span class="lineNum">     494 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_TRACE_END</span></a>
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(nsDOMMutationObserver)</span>
<span class="lineNum">     497 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK_PRESERVED_WRAPPER</span>
<span class="lineNum">     498 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mOwner)</span>
<span class="lineNum">     499 </span><span class="lineCov">          1 :   for (int32_t i = 0; i &lt; tmp-&gt;mReceivers.Count(); ++i) {</span>
<span class="lineNum">     500 </span><span class="lineCov">          1 :     tmp-&gt;mReceivers[i]-&gt;Disconnect(false);</span>
<span class="lineNum">     501 </span>            :   }
<span class="lineNum">     502 </span><span class="lineCov">          1 :   tmp-&gt;mReceivers.Clear();</span>
<span class="lineNum">     503 </span><span class="lineCov">          1 :   tmp-&gt;ClearPendingRecords();</span>
<span class="lineNum">     504 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK(mCallback)</span>
<span class="lineNum">     505 </span>            :   // No need to handle mTransientReceivers
<a name="506"><span class="lineNum">     506 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_UNLINK_END</span></a>
<span class="lineNum">     507 </span>            : 
<span class="lineNum">     508 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(nsDOMMutationObserver)</span>
<span class="lineNum">     509 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mOwner)</span>
<span class="lineNum">     510 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mReceivers)</span>
<span class="lineNum">     511 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mFirstPendingMutation)</span>
<span class="lineNum">     512 </span><span class="lineCov">          1 :   NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mCallback)</span>
<span class="lineNum">     513 </span>            :   // No need to handle mTransientReceivers
<span class="lineNum">     514 </span><span class="lineCov">          1 : NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END</span>
<a name="515"><span class="lineNum">     515 </span>            : </a>
<span class="lineNum">     516 </span>            : nsMutationReceiver*
<span class="lineNum">     517 </span><span class="lineCov">          1 : nsDOMMutationObserver::GetReceiverFor(nsINode* aNode, bool aMayCreate,</span>
<span class="lineNum">     518 </span>            :                                       bool aWantsAnimations)
<span class="lineNum">     519 </span>            : {
<span class="lineNum">     520 </span>            :   MOZ_ASSERT(aMayCreate || !aWantsAnimations,
<span class="lineNum">     521 </span>            :              &quot;the value of aWantsAnimations doesn't matter when aMayCreate is &quot;
<span class="lineNum">     522 </span>            :              &quot;false, so just pass in false for it&quot;);
<span class="lineNum">     523 </span>            : 
<span class="lineNum">     524 </span><span class="lineCov">          1 :   if (!aMayCreate &amp;&amp; !aNode-&gt;MayHaveDOMMutationObserver()) {</span>
<span class="lineNum">     525 </span>            :     return nullptr;
<span class="lineNum">     526 </span>            :   }
<span class="lineNum">     527 </span>            : 
<span class="lineNum">     528 </span><span class="lineCov">          1 :   for (int32_t i = 0; i &lt; mReceivers.Count(); ++i) {</span>
<span class="lineNum">     529 </span><span class="lineCov">          1 :     if (mReceivers[i]-&gt;Target() == aNode) {</span>
<span class="lineNum">     530 </span><span class="lineCov">          1 :       return mReceivers[i];</span>
<span class="lineNum">     531 </span>            :     }
<span class="lineNum">     532 </span>            :   }
<span class="lineNum">     533 </span><span class="lineCov">          1 :   if (!aMayCreate) {</span>
<span class="lineNum">     534 </span>            :     return nullptr;
<span class="lineNum">     535 </span>            :   }
<span class="lineNum">     536 </span>            : 
<span class="lineNum">     537 </span>            :   nsMutationReceiver* r;
<span class="lineNum">     538 </span><span class="lineCov">          1 :   if (aWantsAnimations) {</span>
<span class="lineNum">     539 </span><span class="lineCov">          1 :     r = nsAnimationReceiver::Create(aNode, this);</span>
<span class="lineNum">     540 </span>            :   } else {
<span class="lineNum">     541 </span><span class="lineCov">          1 :     r = nsMutationReceiver::Create(aNode, this);</span>
<span class="lineNum">     542 </span>            :   }
<span class="lineNum">     543 </span><span class="lineCov">          1 :   mReceivers.AppendObject(r);</span>
<span class="lineNum">     544 </span><span class="lineCov">          1 :   return r;</span>
<span class="lineNum">     545 </span>            : }
<a name="546"><span class="lineNum">     546 </span>            : </a>
<span class="lineNum">     547 </span>            : void
<span class="lineNum">     548 </span><span class="lineNoCov">          0 : nsDOMMutationObserver::RemoveReceiver(nsMutationReceiver* aReceiver)</span>
<span class="lineNum">     549 </span>            : {
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :   mReceivers.RemoveObject(aReceiver);</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 : }</span>
<a name="552"><span class="lineNum">     552 </span>            : </a>
<span class="lineNum">     553 </span>            : void
<span class="lineNum">     554 </span><span class="lineCov">          1 : nsDOMMutationObserver::GetAllSubtreeObserversFor(nsINode* aNode,</span>
<span class="lineNum">     555 </span>            :                                                  nsTArray&lt;nsMutationReceiver*&gt;&amp;
<span class="lineNum">     556 </span>            :                                                    aReceivers)
<span class="lineNum">     557 </span>            : {
<span class="lineNum">     558 </span><span class="lineCov">          1 :   nsINode* n = aNode;</span>
<span class="lineNum">     559 </span><span class="lineCov">          1 :   while (n) {</span>
<span class="lineNum">     560 </span><span class="lineCov">          1 :     if (n-&gt;MayHaveDOMMutationObserver()) {</span>
<span class="lineNum">     561 </span><span class="lineCov">          1 :       nsMutationReceiver* r = GetReceiverFor(n, false, false);</span>
<span class="lineNum">     562 </span><span class="lineCov">          1 :       if (r &amp;&amp; r-&gt;Subtree() &amp;&amp; !aReceivers.Contains(r)) {</span>
<span class="lineNum">     563 </span><span class="lineCov">          1 :         aReceivers.AppendElement(r);</span>
<span class="lineNum">     564 </span>            :         // If we've found all the receivers the observer has,
<span class="lineNum">     565 </span>            :         // no need to search for more.
<span class="lineNum">     566 </span><span class="lineCov">          1 :         if (mReceivers.Count() == int32_t(aReceivers.Length())) {</span>
<span class="lineNum">     567 </span><span class="lineCov">          1 :           return;</span>
<span class="lineNum">     568 </span>            :         }
<span class="lineNum">     569 </span>            :       }                                            
<span class="lineNum">     570 </span><span class="lineCov">          1 :       nsCOMArray&lt;nsMutationReceiver&gt;* transientReceivers = nullptr;</span>
<span class="lineNum">     571 </span><span class="lineCov">          1 :       if (mTransientReceivers.Get(n, &amp;transientReceivers) &amp;&amp; transientReceivers) {</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :         for (int32_t i = 0; i &lt; transientReceivers-&gt;Count(); ++i) {</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :           nsMutationReceiver* r = transientReceivers-&gt;ObjectAt(i);</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :           nsMutationReceiver* parent = r-&gt;GetParent();</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :           if (r-&gt;Subtree() &amp;&amp; parent &amp;&amp; !aReceivers.Contains(parent)) {</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :             aReceivers.AppendElement(parent);</span>
<span class="lineNum">     577 </span>            :           }
<span class="lineNum">     578 </span>            :         }
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :         if (mReceivers.Count() == int32_t(aReceivers.Length())) {</span>
<span class="lineNum">     580 </span>            :           return;
<span class="lineNum">     581 </span>            :         }
<span class="lineNum">     582 </span>            :       }
<span class="lineNum">     583 </span>            :     }
<span class="lineNum">     584 </span><span class="lineCov">          1 :     n = n-&gt;GetParentNode();</span>
<span class="lineNum">     585 </span>            :   }
<span class="lineNum">     586 </span>            : }
<a name="587"><span class="lineNum">     587 </span>            : </a>
<span class="lineNum">     588 </span>            : void
<span class="lineNum">     589 </span><span class="lineCov">          1 : nsDOMMutationObserver::ScheduleForRun()</span>
<span class="lineNum">     590 </span>            : {
<span class="lineNum">     591 </span><span class="lineCov">          1 :   nsDOMMutationObserver::AddCurrentlyHandlingObserver(this, sMutationLevel);</span>
<span class="lineNum">     592 </span>            : 
<span class="lineNum">     593 </span><span class="lineCov">          1 :   if (mWaitingForRun) {</span>
<span class="lineNum">     594 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">     595 </span>            :   }
<span class="lineNum">     596 </span><span class="lineCov">          1 :   mWaitingForRun = true;</span>
<span class="lineNum">     597 </span><span class="lineCov">          1 :   RescheduleForRun();</span>
<span class="lineNum">     598 </span>            : }
<a name="599"><span class="lineNum">     599 </span>            : </a>
<span class="lineNum">     600 </span>            : void
<span class="lineNum">     601 </span><span class="lineCov">          1 : nsDOMMutationObserver::RescheduleForRun()</span>
<span class="lineNum">     602 </span>            : {
<span class="lineNum">     603 </span><span class="lineCov">          1 :   if (!sScheduledMutationObservers) {</span>
<span class="lineNum">     604 </span><span class="lineCov">          1 :     sScheduledMutationObservers = new AutoTArray&lt;RefPtr&lt;nsDOMMutationObserver&gt;, 4&gt;;</span>
<span class="lineNum">     605 </span>            :   }
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span><span class="lineCov">          1 :   bool didInsert = false;</span>
<span class="lineNum">     608 </span><span class="lineCov">          1 :   for (uint32_t i = 0; i &lt; sScheduledMutationObservers-&gt;Length(); ++i) {</span>
<span class="lineNum">     609 </span><span class="lineCov">          1 :     if (static_cast&lt;nsDOMMutationObserver*&gt;((*sScheduledMutationObservers)[i])</span>
<span class="lineNum">     610 </span><span class="lineCov">          1 :           -&gt;mId &gt; mId) {</span>
<span class="lineNum">     611 </span><span class="lineCov">          1 :       sScheduledMutationObservers-&gt;InsertElementAt(i, this);</span>
<span class="lineNum">     612 </span><span class="lineCov">          1 :       didInsert = true;</span>
<span class="lineNum">     613 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">     614 </span>            :     }
<span class="lineNum">     615 </span>            :   }
<span class="lineNum">     616 </span><span class="lineCov">          1 :   if (!didInsert) {</span>
<span class="lineNum">     617 </span><span class="lineCov">          1 :     sScheduledMutationObservers-&gt;AppendElement(this);</span>
<span class="lineNum">     618 </span>            :   }
<span class="lineNum">     619 </span><span class="lineCov">          1 : }</span>
<a name="620"><span class="lineNum">     620 </span>            : </a>
<span class="lineNum">     621 </span>            : void
<span class="lineNum">     622 </span><span class="lineCov">          1 : nsDOMMutationObserver::Observe(nsINode&amp; aTarget,</span>
<span class="lineNum">     623 </span>            :                                const mozilla::dom::MutationObserverInit&amp; aOptions,
<span class="lineNum">     624 </span>            :                                mozilla::ErrorResult&amp; aRv)
<span class="lineNum">     625 </span>            : {
<span class="lineNum">     626 </span>            : 
<span class="lineNum">     627 </span><span class="lineCov">          1 :   bool childList = aOptions.mChildList;</span>
<span class="lineNum">     628 </span>            :   bool attributes =
<span class="lineNum">     629 </span><span class="lineCov">          1 :     aOptions.mAttributes.WasPassed() &amp;&amp;</span>
<span class="lineNum">     630 </span><span class="lineCov">          1 :     aOptions.mAttributes.Value();</span>
<span class="lineNum">     631 </span>            :   bool characterData =
<span class="lineNum">     632 </span><span class="lineCov">          1 :     aOptions.mCharacterData.WasPassed() &amp;&amp;</span>
<span class="lineNum">     633 </span><span class="lineCov">          1 :     aOptions.mCharacterData.Value();</span>
<span class="lineNum">     634 </span><span class="lineCov">          1 :   bool subtree = aOptions.mSubtree;</span>
<span class="lineNum">     635 </span>            :   bool attributeOldValue =
<span class="lineNum">     636 </span><span class="lineCov">          1 :     aOptions.mAttributeOldValue.WasPassed() &amp;&amp;</span>
<span class="lineNum">     637 </span><span class="lineCov">          1 :     aOptions.mAttributeOldValue.Value();</span>
<span class="lineNum">     638 </span><span class="lineCov">          1 :   bool nativeAnonymousChildList = aOptions.mNativeAnonymousChildList;</span>
<span class="lineNum">     639 </span>            :   bool characterDataOldValue =
<span class="lineNum">     640 </span><span class="lineCov">          1 :     aOptions.mCharacterDataOldValue.WasPassed() &amp;&amp;</span>
<span class="lineNum">     641 </span><span class="lineCov">          1 :     aOptions.mCharacterDataOldValue.Value();</span>
<span class="lineNum">     642 </span><span class="lineCov">          1 :   bool animations = aOptions.mAnimations;</span>
<span class="lineNum">     643 </span>            : 
<span class="lineNum">     644 </span><span class="lineCov">          1 :   if (!aOptions.mAttributes.WasPassed() &amp;&amp;</span>
<span class="lineNum">     645 </span><span class="lineCov">          1 :       (aOptions.mAttributeOldValue.WasPassed() ||</span>
<span class="lineNum">     646 </span><span class="lineCov">          1 :        aOptions.mAttributeFilter.WasPassed())) {</span>
<span class="lineNum">     647 </span><span class="lineCov">          1 :     attributes = true;</span>
<span class="lineNum">     648 </span>            :   }
<span class="lineNum">     649 </span>            : 
<span class="lineNum">     650 </span><span class="lineCov">          1 :   if (!aOptions.mCharacterData.WasPassed() &amp;&amp;</span>
<span class="lineNum">     651 </span><span class="lineCov">          1 :       aOptions.mCharacterDataOldValue.WasPassed()) {</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :     characterData = true;</span>
<span class="lineNum">     653 </span>            :   }
<span class="lineNum">     654 </span>            : 
<span class="lineNum">     655 </span><span class="lineCov">          1 :   if (!(childList || attributes || characterData || animations ||</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :         nativeAnonymousChildList)) {</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :     aRv.Throw(NS_ERROR_DOM_TYPE_ERR);</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     659 </span>            :   }
<span class="lineNum">     660 </span>            : 
<span class="lineNum">     661 </span><span class="lineCov">          1 :   if (aOptions.mAttributeOldValue.WasPassed() &amp;&amp;</span>
<span class="lineNum">     662 </span><span class="lineCov">          1 :       aOptions.mAttributeOldValue.Value() &amp;&amp;</span>
<span class="lineNum">     663 </span><span class="lineCov">          1 :       aOptions.mAttributes.WasPassed() &amp;&amp;</span>
<span class="lineNum">     664 </span><span class="lineCov">          1 :       !aOptions.mAttributes.Value()) {</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :     aRv.Throw(NS_ERROR_DOM_TYPE_ERR);</span>
<span class="lineNum">     666 </span>            :     return;
<span class="lineNum">     667 </span>            :   }
<span class="lineNum">     668 </span>            : 
<span class="lineNum">     669 </span><span class="lineCov">          1 :   if (aOptions.mAttributeFilter.WasPassed() &amp;&amp;</span>
<span class="lineNum">     670 </span><span class="lineCov">          1 :       aOptions.mAttributes.WasPassed() &amp;&amp;</span>
<span class="lineNum">     671 </span><span class="lineCov">          1 :       !aOptions.mAttributes.Value()) {</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :     aRv.Throw(NS_ERROR_DOM_TYPE_ERR);</span>
<span class="lineNum">     673 </span>            :     return;
<span class="lineNum">     674 </span>            :   }
<span class="lineNum">     675 </span>            : 
<span class="lineNum">     676 </span><span class="lineCov">          1 :   if (aOptions.mCharacterDataOldValue.WasPassed() &amp;&amp;</span>
<span class="lineNum">     677 </span><span class="lineCov">          1 :       aOptions.mCharacterDataOldValue.Value() &amp;&amp;</span>
<span class="lineNum">     678 </span><span class="lineCov">          1 :       aOptions.mCharacterData.WasPassed() &amp;&amp;</span>
<span class="lineNum">     679 </span><span class="lineCov">          1 :       !aOptions.mCharacterData.Value()) {</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :     aRv.Throw(NS_ERROR_DOM_TYPE_ERR);</span>
<span class="lineNum">     681 </span>            :     return;
<span class="lineNum">     682 </span>            :   }
<span class="lineNum">     683 </span>            : 
<span class="lineNum">     684 </span>            :   nsCOMArray&lt;nsIAtom&gt; filters;
<span class="lineNum">     685 </span><span class="lineCov">          1 :   bool allAttrs = true;</span>
<span class="lineNum">     686 </span><span class="lineCov">          1 :   if (aOptions.mAttributeFilter.WasPassed()) {</span>
<span class="lineNum">     687 </span><span class="lineCov">          1 :     allAttrs = false;</span>
<span class="lineNum">     688 </span>            :     const mozilla::dom::Sequence&lt;nsString&gt;&amp; filtersAsString =
<span class="lineNum">     689 </span><span class="lineCov">          1 :       aOptions.mAttributeFilter.Value();</span>
<span class="lineNum">     690 </span><span class="lineCov">          1 :     uint32_t len = filtersAsString.Length();</span>
<span class="lineNum">     691 </span>            :     filters.SetCapacity(len);
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span><span class="lineCov">          1 :     for (uint32_t i = 0; i &lt; len; ++i) {</span>
<span class="lineNum">     694 </span><span class="lineCov">          1 :       filters.AppendElement(NS_Atomize(filtersAsString[i]));</span>
<span class="lineNum">     695 </span>            :     }
<span class="lineNum">     696 </span>            :   }
<span class="lineNum">     697 </span>            : 
<span class="lineNum">     698 </span><span class="lineCov">          1 :   nsMutationReceiver* r = GetReceiverFor(&amp;aTarget, true, animations);</span>
<span class="lineNum">     699 </span><span class="lineCov">          1 :   r-&gt;SetChildList(childList);</span>
<span class="lineNum">     700 </span><span class="lineCov">          1 :   r-&gt;SetAttributes(attributes);</span>
<span class="lineNum">     701 </span><span class="lineCov">          1 :   r-&gt;SetCharacterData(characterData);</span>
<span class="lineNum">     702 </span><span class="lineCov">          1 :   r-&gt;SetSubtree(subtree);</span>
<span class="lineNum">     703 </span><span class="lineCov">          1 :   r-&gt;SetAttributeOldValue(attributeOldValue);</span>
<span class="lineNum">     704 </span><span class="lineCov">          1 :   r-&gt;SetCharacterDataOldValue(characterDataOldValue);</span>
<span class="lineNum">     705 </span><span class="lineCov">          1 :   r-&gt;SetNativeAnonymousChildList(nativeAnonymousChildList);</span>
<span class="lineNum">     706 </span><span class="lineCov">          1 :   r-&gt;SetAttributeFilter(Move(filters));</span>
<span class="lineNum">     707 </span><span class="lineCov">          1 :   r-&gt;SetAllAttributes(allAttrs);</span>
<span class="lineNum">     708 </span><span class="lineCov">          1 :   r-&gt;SetAnimations(animations);</span>
<span class="lineNum">     709 </span><span class="lineCov">          1 :   r-&gt;RemoveClones();</span>
<span class="lineNum">     710 </span>            : 
<span class="lineNum">     711 </span>            : #ifdef DEBUG
<span class="lineNum">     712 </span>            :   for (int32_t i = 0; i &lt; mReceivers.Count(); ++i) {
<span class="lineNum">     713 </span>            :     NS_WARNING_ASSERTION(mReceivers[i]-&gt;Target(),
<span class="lineNum">     714 </span>            :                          &quot;All the receivers should have a target!&quot;);
<span class="lineNum">     715 </span>            :   }
<span class="lineNum">     716 </span>            : #endif
<span class="lineNum">     717 </span>            : }
<a name="718"><span class="lineNum">     718 </span>            : </a>
<span class="lineNum">     719 </span>            : void
<span class="lineNum">     720 </span><span class="lineCov">          1 : nsDOMMutationObserver::Disconnect()</span>
<span class="lineNum">     721 </span>            : {
<span class="lineNum">     722 </span><span class="lineCov">          1 :   for (int32_t i = 0; i &lt; mReceivers.Count(); ++i) {</span>
<span class="lineNum">     723 </span><span class="lineCov">          1 :     mReceivers[i]-&gt;Disconnect(false);</span>
<span class="lineNum">     724 </span>            :   }
<span class="lineNum">     725 </span><span class="lineCov">          1 :   mReceivers.Clear();</span>
<span class="lineNum">     726 </span><span class="lineCov">          1 :   mCurrentMutations.Clear();</span>
<span class="lineNum">     727 </span><span class="lineCov">          1 :   ClearPendingRecords();</span>
<span class="lineNum">     728 </span><span class="lineCov">          1 : }</span>
<a name="729"><span class="lineNum">     729 </span>            : </a>
<span class="lineNum">     730 </span>            : void
<span class="lineNum">     731 </span><span class="lineCov">          1 : nsDOMMutationObserver::TakeRecords(</span>
<span class="lineNum">     732 </span>            :                          nsTArray&lt;RefPtr&lt;nsDOMMutationRecord&gt; &gt;&amp; aRetVal)
<span class="lineNum">     733 </span>            : {
<span class="lineNum">     734 </span><span class="lineCov">          1 :   aRetVal.Clear();</span>
<span class="lineNum">     735 </span><span class="lineCov">          1 :   aRetVal.SetCapacity(mPendingMutationCount);</span>
<span class="lineNum">     736 </span>            :   RefPtr&lt;nsDOMMutationRecord&gt; current;
<span class="lineNum">     737 </span><span class="lineCov">          1 :   current.swap(mFirstPendingMutation);</span>
<span class="lineNum">     738 </span><span class="lineCov">          1 :   for (uint32_t i = 0; i &lt; mPendingMutationCount; ++i) {</span>
<span class="lineNum">     739 </span>            :     RefPtr&lt;nsDOMMutationRecord&gt; next;
<span class="lineNum">     740 </span><span class="lineCov">          1 :     current-&gt;mNext.swap(next);</span>
<span class="lineNum">     741 </span><span class="lineCov">          1 :     if (!mMergeAttributeRecords ||</span>
<span class="lineNum">     742 </span><span class="lineCov">          1 :         !MergeableAttributeRecord(aRetVal.SafeLastElement(nullptr),</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :                                   current)) {</span>
<span class="lineNum">     744 </span><span class="lineCov">          1 :       *aRetVal.AppendElement() = current.forget();</span>
<span class="lineNum">     745 </span>            :     }
<span class="lineNum">     746 </span>            :     current.swap(next);
<span class="lineNum">     747 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     748 </span><span class="lineCov">          1 :   ClearPendingRecords();</span>
<span class="lineNum">     749 </span><span class="lineCov">          1 : }</span>
<a name="750"><span class="lineNum">     750 </span>            : </a>
<span class="lineNum">     751 </span>            : void
<span class="lineNum">     752 </span><span class="lineNoCov">          0 : nsDOMMutationObserver::GetObservingInfo(</span>
<span class="lineNum">     753 </span>            :                          nsTArray&lt;Nullable&lt;MutationObservingInfo&gt;&gt;&amp; aResult,
<span class="lineNum">     754 </span>            :                          mozilla::ErrorResult&amp; aRv)
<span class="lineNum">     755 </span>            : {
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :   aResult.SetCapacity(mReceivers.Count());</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :   for (int32_t i = 0; i &lt; mReceivers.Count(); ++i) {</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :     MutationObservingInfo&amp; info = aResult.AppendElement()-&gt;SetValue();</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :     nsMutationReceiver* mr = mReceivers[i];</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :     info.mChildList = mr-&gt;ChildList();</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :     info.mAttributes.Construct(mr-&gt;Attributes());</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :     info.mCharacterData.Construct(mr-&gt;CharacterData());</span>
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :     info.mSubtree = mr-&gt;Subtree();</span>
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :     info.mAttributeOldValue.Construct(mr-&gt;AttributeOldValue());</span>
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :     info.mCharacterDataOldValue.Construct(mr-&gt;CharacterDataOldValue());</span>
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :     info.mNativeAnonymousChildList = mr-&gt;NativeAnonymousChildList();</span>
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :     info.mAnimations = mr-&gt;Animations();</span>
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :     nsCOMArray&lt;nsIAtom&gt;&amp; filters = mr-&gt;AttributeFilter();</span>
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :     if (filters.Count()) {</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :       info.mAttributeFilter.Construct();</span>
<span class="lineNum">     771 </span>            :       mozilla::dom::Sequence&lt;nsString&gt;&amp; filtersAsStrings =
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :         info.mAttributeFilter.Value();</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :       nsString* strings = filtersAsStrings.AppendElements(filters.Count(),</span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :                                                           mozilla::fallible);</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :       if (!strings) {</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :         aRv.Throw(NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     778 </span>            :       }
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :       for (int32_t j = 0; j &lt; filters.Count(); ++j) {</span>
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :         filters[j]-&gt;ToString(strings[j]);</span>
<span class="lineNum">     781 </span>            :       }
<span class="lineNum">     782 </span>            :     }
<span class="lineNum">     783 </span><span class="lineNoCov">          0 :     info.mObservedNode = mr-&gt;Target();</span>
<span class="lineNum">     784 </span>            :   }
<span class="lineNum">     785 </span>            : }
<span class="lineNum">     786 </span>            : 
<a name="787"><span class="lineNum">     787 </span>            : // static</a>
<span class="lineNum">     788 </span>            : already_AddRefed&lt;nsDOMMutationObserver&gt;
<span class="lineNum">     789 </span><span class="lineCov">          1 : nsDOMMutationObserver::Constructor(const mozilla::dom::GlobalObject&amp; aGlobal,</span>
<span class="lineNum">     790 </span>            :                                    mozilla::dom::MutationCallback&amp; aCb,
<span class="lineNum">     791 </span>            :                                    mozilla::ErrorResult&amp; aRv)
<span class="lineNum">     792 </span>            : {
<span class="lineNum">     793 </span><span class="lineCov">          1 :   nsCOMPtr&lt;nsPIDOMWindowInner&gt; window = do_QueryInterface(aGlobal.GetAsSupports());</span>
<span class="lineNum">     794 </span><span class="lineCov">          1 :   if (!window) {</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :     aRv.Throw(NS_ERROR_FAILURE);</span>
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">     797 </span>            :   }
<span class="lineNum">     798 </span>            :   MOZ_ASSERT(window-&gt;IsInnerWindow());
<span class="lineNum">     799 </span><span class="lineCov">          1 :   bool isChrome = nsContentUtils::IsChromeDoc(window-&gt;GetExtantDoc());</span>
<span class="lineNum">     800 </span>            :   RefPtr&lt;nsDOMMutationObserver&gt; observer =
<span class="lineNum">     801 </span><span class="lineCov">          1 :     new nsDOMMutationObserver(window.forget(), aCb, isChrome);</span>
<span class="lineNum">     802 </span>            :   return observer.forget();
<span class="lineNum">     803 </span>            : }
<span class="lineNum">     804 </span>            : 
<a name="805"><span class="lineNum">     805 </span>            : </a>
<span class="lineNum">     806 </span>            : bool
<span class="lineNum">     807 </span><span class="lineCov">          1 : nsDOMMutationObserver::MergeableAttributeRecord(nsDOMMutationRecord* aOldRecord,</span>
<span class="lineNum">     808 </span>            :                                                 nsDOMMutationRecord* aRecord)
<span class="lineNum">     809 </span>            : {
<span class="lineNum">     810 </span>            :   MOZ_ASSERT(mMergeAttributeRecords);
<span class="lineNum">     811 </span>            :   return
<span class="lineNum">     812 </span><span class="lineCov">          1 :     aOldRecord &amp;&amp;</span>
<span class="lineNum">     813 </span><span class="lineCov">          1 :     aOldRecord-&gt;mType == nsGkAtoms::attributes &amp;&amp;</span>
<span class="lineNum">     814 </span><span class="lineCov">          1 :     aOldRecord-&gt;mType == aRecord-&gt;mType &amp;&amp;</span>
<span class="lineNum">     815 </span><span class="lineCov">          1 :     aOldRecord-&gt;mTarget == aRecord-&gt;mTarget &amp;&amp;</span>
<span class="lineNum">     816 </span><span class="lineCov">          1 :     aOldRecord-&gt;mAttrName == aRecord-&gt;mAttrName &amp;&amp;</span>
<span class="lineNum">     817 </span><span class="lineCov">          1 :     aOldRecord-&gt;mAttrNamespace.Equals(aRecord-&gt;mAttrNamespace);</span>
<span class="lineNum">     818 </span>            : }
<a name="819"><span class="lineNum">     819 </span>            : </a>
<span class="lineNum">     820 </span>            : void
<span class="lineNum">     821 </span><span class="lineCov">          1 : nsDOMMutationObserver::HandleMutation()</span>
<span class="lineNum">     822 </span>            : {
<span class="lineNum">     823 </span>            :   NS_ASSERTION(nsContentUtils::IsSafeToRunScript(), &quot;Whaat!&quot;);
<span class="lineNum">     824 </span>            :   NS_ASSERTION(mCurrentMutations.IsEmpty(),
<span class="lineNum">     825 </span>            :                &quot;Still generating MutationRecords?&quot;);
<span class="lineNum">     826 </span>            : 
<span class="lineNum">     827 </span><span class="lineCov">          1 :   mWaitingForRun = false;</span>
<span class="lineNum">     828 </span>            : 
<span class="lineNum">     829 </span><span class="lineCov">          1 :   for (int32_t i = 0; i &lt; mReceivers.Count(); ++i) {</span>
<span class="lineNum">     830 </span><span class="lineCov">          1 :     mReceivers[i]-&gt;RemoveClones();</span>
<span class="lineNum">     831 </span>            :   }
<span class="lineNum">     832 </span><span class="lineCov">          1 :   mTransientReceivers.Clear();</span>
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span><span class="lineCov">          1 :   nsPIDOMWindowOuter* outer = mOwner-&gt;GetOuterWindow();</span>
<span class="lineNum">     835 </span><span class="lineCov">          1 :   if (!mPendingMutationCount || !outer ||</span>
<span class="lineNum">     836 </span><span class="lineCov">          1 :       outer-&gt;GetCurrentInnerWindow() != mOwner) {</span>
<span class="lineNum">     837 </span><span class="lineCov">          1 :     ClearPendingRecords();</span>
<span class="lineNum">     838 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">     839 </span>            :   }
<span class="lineNum">     840 </span>            : 
<span class="lineNum">     841 </span>            :   mozilla::dom::Sequence&lt;mozilla::OwningNonNull&lt;nsDOMMutationRecord&gt; &gt;
<span class="lineNum">     842 </span>            :     mutations;
<span class="lineNum">     843 </span><span class="lineCov">          1 :   if (mutations.SetCapacity(mPendingMutationCount, mozilla::fallible)) {</span>
<span class="lineNum">     844 </span>            :     // We can't use TakeRecords easily here, because it deals with a
<span class="lineNum">     845 </span>            :     // different type of array, and we want to optimize out any extra copying.
<span class="lineNum">     846 </span>            :     RefPtr&lt;nsDOMMutationRecord&gt; current;
<span class="lineNum">     847 </span><span class="lineCov">          1 :     current.swap(mFirstPendingMutation);</span>
<span class="lineNum">     848 </span><span class="lineCov">          1 :     for (uint32_t i = 0; i &lt; mPendingMutationCount; ++i) {</span>
<span class="lineNum">     849 </span>            :       RefPtr&lt;nsDOMMutationRecord&gt; next;
<span class="lineNum">     850 </span><span class="lineCov">          1 :       current-&gt;mNext.swap(next);</span>
<span class="lineNum">     851 </span><span class="lineCov">          1 :       if (!mMergeAttributeRecords ||</span>
<span class="lineNum">     852 </span>            :           !MergeableAttributeRecord(mutations.Length() ?
<span class="lineNum">     853 </span><span class="lineCov">          1 :                                       mutations.LastElement().get() : nullptr,</span>
<span class="lineNum">     854 </span><span class="lineCov">          1 :                                     current)) {</span>
<span class="lineNum">     855 </span><span class="lineCov">          1 :         *mutations.AppendElement(mozilla::fallible) = current;</span>
<span class="lineNum">     856 </span>            :       }
<span class="lineNum">     857 </span>            :       current.swap(next);
<span class="lineNum">     858 </span><span class="lineCov">          1 :     }</span>
<span class="lineNum">     859 </span>            :   }
<span class="lineNum">     860 </span><span class="lineCov">          1 :   ClearPendingRecords();</span>
<span class="lineNum">     861 </span>            : 
<span class="lineNum">     862 </span><span class="lineCov">          1 :   mCallback-&gt;Call(this, mutations, *this);</span>
<a name="863"><span class="lineNum">     863 </span>            : }</a>
<span class="lineNum">     864 </span>            : 
<span class="lineNum">     865 </span><span class="lineNoCov">          0 : class AsyncMutationHandler : public mozilla::Runnable</span>
<a name="866"><span class="lineNum">     866 </span>            : {</a>
<span class="lineNum">     867 </span>            : public:
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :   NS_IMETHOD Run() override</span>
<span class="lineNum">     869 </span>            :   {
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :     nsDOMMutationObserver::HandleMutations();</span>
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">     872 </span>            :   }
<span class="lineNum">     873 </span>            : };
<a name="874"><span class="lineNum">     874 </span>            : </a>
<span class="lineNum">     875 </span>            : void
<span class="lineNum">     876 </span><span class="lineCov">          1 : nsDOMMutationObserver::HandleMutationsInternal()</span>
<span class="lineNum">     877 </span>            : {
<span class="lineNum">     878 </span><span class="lineCov">          1 :   if (!nsContentUtils::IsSafeToRunScript()) {</span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :     nsContentUtils::AddScriptRunner(new AsyncMutationHandler());</span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     881 </span>            :   }
<span class="lineNum">     882 </span><span class="lineCov">          1 :   static RefPtr&lt;nsDOMMutationObserver&gt; sCurrentObserver;</span>
<span class="lineNum">     883 </span><span class="lineCov">          1 :   if (sCurrentObserver &amp;&amp; !sCurrentObserver-&gt;Suppressed()) {</span>
<span class="lineNum">     884 </span>            :     // In normal cases sScheduledMutationObservers will be handled
<span class="lineNum">     885 </span>            :     // after previous mutations are handled. But in case some
<span class="lineNum">     886 </span>            :     // callback calls a sync API, which spins the eventloop, we need to still
<span class="lineNum">     887 </span>            :     // process other mutations happening during that sync call.
<span class="lineNum">     888 </span>            :     // This does *not* catch all cases, but should work for stuff running
<span class="lineNum">     889 </span>            :     // in separate tabs.
<span class="lineNum">     890 </span>            :     return;
<span class="lineNum">     891 </span>            :   }
<span class="lineNum">     892 </span>            : 
<span class="lineNum">     893 </span><span class="lineCov">          1 :   mozilla::AutoSlowOperation aso;</span>
<span class="lineNum">     894 </span>            : 
<span class="lineNum">     895 </span><span class="lineCov">          1 :   nsTArray&lt;RefPtr&lt;nsDOMMutationObserver&gt; &gt;* suppressedObservers = nullptr;</span>
<span class="lineNum">     896 </span>            : 
<span class="lineNum">     897 </span><span class="lineCov">          1 :   while (sScheduledMutationObservers) {</span>
<span class="lineNum">     898 </span>            :     AutoTArray&lt;RefPtr&lt;nsDOMMutationObserver&gt;, 4&gt;* observers =
<span class="lineNum">     899 </span><span class="lineCov">          1 :       sScheduledMutationObservers;</span>
<span class="lineNum">     900 </span><span class="lineCov">          1 :     sScheduledMutationObservers = nullptr;</span>
<span class="lineNum">     901 </span><span class="lineCov">          1 :     for (uint32_t i = 0; i &lt; observers-&gt;Length(); ++i) {</span>
<span class="lineNum">     902 </span><span class="lineCov">          1 :       sCurrentObserver = static_cast&lt;nsDOMMutationObserver*&gt;((*observers)[i]);</span>
<span class="lineNum">     903 </span><span class="lineCov">          1 :       if (!sCurrentObserver-&gt;Suppressed()) {</span>
<span class="lineNum">     904 </span><span class="lineCov">          1 :         sCurrentObserver-&gt;HandleMutation();</span>
<span class="lineNum">     905 </span>            :       } else {
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :         if (!suppressedObservers) {</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :           suppressedObservers = new nsTArray&lt;RefPtr&lt;nsDOMMutationObserver&gt; &gt;;</span>
<span class="lineNum">     908 </span>            :         }
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :         if (!suppressedObservers-&gt;Contains(sCurrentObserver)) {</span>
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :           suppressedObservers-&gt;AppendElement(sCurrentObserver);</span>
<span class="lineNum">     911 </span>            :         }
<span class="lineNum">     912 </span>            :       }
<span class="lineNum">     913 </span>            :     }
<span class="lineNum">     914 </span><span class="lineCov">          1 :     delete observers;</span>
<span class="lineNum">     915 </span><span class="lineCov">          1 :     aso.CheckForInterrupt();</span>
<span class="lineNum">     916 </span>            :   }
<span class="lineNum">     917 </span>            : 
<span class="lineNum">     918 </span><span class="lineCov">          1 :   if (suppressedObservers) {</span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :     for (uint32_t i = 0; i &lt; suppressedObservers-&gt;Length(); ++i) {</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :       static_cast&lt;nsDOMMutationObserver*&gt;(suppressedObservers-&gt;ElementAt(i))-&gt;</span>
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :         RescheduleForRun();</span>
<span class="lineNum">     922 </span>            :     }
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :     delete suppressedObservers;</span>
<span class="lineNum">     924 </span>            :     suppressedObservers = nullptr;
<span class="lineNum">     925 </span>            :   }
<span class="lineNum">     926 </span><span class="lineCov">          1 :   sCurrentObserver = nullptr;</span>
<span class="lineNum">     927 </span>            : }
<a name="928"><span class="lineNum">     928 </span>            : </a>
<span class="lineNum">     929 </span>            : nsDOMMutationRecord*
<span class="lineNum">     930 </span><span class="lineCov">          1 : nsDOMMutationObserver::CurrentRecord(nsIAtom* aType)</span>
<span class="lineNum">     931 </span>            : {
<span class="lineNum">     932 </span>            :   NS_ASSERTION(sMutationLevel &gt; 0, &quot;Unexpected mutation level!&quot;);
<span class="lineNum">     933 </span>            : 
<span class="lineNum">     934 </span><span class="lineCov">          1 :   while (mCurrentMutations.Length() &lt; sMutationLevel) {</span>
<span class="lineNum">     935 </span><span class="lineCov">          1 :     mCurrentMutations.AppendElement(static_cast&lt;nsDOMMutationRecord*&gt;(nullptr));</span>
<span class="lineNum">     936 </span>            :   }
<span class="lineNum">     937 </span>            : 
<span class="lineNum">     938 </span><span class="lineCov">          1 :   uint32_t last = sMutationLevel - 1;</span>
<span class="lineNum">     939 </span><span class="lineCov">          1 :   if (!mCurrentMutations[last]) {</span>
<span class="lineNum">     940 </span><span class="lineCov">          1 :     RefPtr&lt;nsDOMMutationRecord&gt; r = new nsDOMMutationRecord(aType, GetParentObject());</span>
<span class="lineNum">     941 </span><span class="lineCov">          1 :     mCurrentMutations[last] = r;</span>
<span class="lineNum">     942 </span><span class="lineCov">          1 :     AppendMutationRecord(r.forget());</span>
<span class="lineNum">     943 </span><span class="lineCov">          1 :     ScheduleForRun();</span>
<span class="lineNum">     944 </span>            :   }
<span class="lineNum">     945 </span>            : 
<span class="lineNum">     946 </span>            : #ifdef DEBUG
<span class="lineNum">     947 </span>            :   MOZ_ASSERT(sCurrentlyHandlingObservers-&gt;Length() == sMutationLevel);
<span class="lineNum">     948 </span>            :   for (size_t i = 0; i &lt; sCurrentlyHandlingObservers-&gt;Length(); ++i) {
<span class="lineNum">     949 </span>            :     MOZ_ASSERT(sCurrentlyHandlingObservers-&gt;ElementAt(i).Contains(this),
<span class="lineNum">     950 </span>            :                &quot;MutationObserver should be added as an observer of all the &quot;
<span class="lineNum">     951 </span>            :                &quot;nested mutations!&quot;);
<span class="lineNum">     952 </span>            :   }
<span class="lineNum">     953 </span>            : #endif
<span class="lineNum">     954 </span>            : 
<span class="lineNum">     955 </span>            :   NS_ASSERTION(mCurrentMutations[last]-&gt;mType == aType,
<span class="lineNum">     956 </span>            :                &quot;Unexpected MutationRecord type!&quot;);
<span class="lineNum">     957 </span>            : 
<span class="lineNum">     958 </span><span class="lineCov">          1 :   return mCurrentMutations[last];</span>
<a name="959"><span class="lineNum">     959 </span>            : }</a>
<span class="lineNum">     960 </span>            : 
<span class="lineNum">     961 </span><span class="lineCov">          1 : nsDOMMutationObserver::~nsDOMMutationObserver()</span>
<span class="lineNum">     962 </span>            : {
<span class="lineNum">     963 </span><span class="lineCov">          1 :   for (int32_t i = 0; i &lt; mReceivers.Count(); ++i) {</span>
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :     mReceivers[i]-&gt;RemoveClones();</span>
<span class="lineNum">     965 </span>            :   }
<span class="lineNum">     966 </span><span class="lineCov">          1 : }</span>
<a name="967"><span class="lineNum">     967 </span>            : </a>
<span class="lineNum">     968 </span>            : void
<span class="lineNum">     969 </span><span class="lineCov">          1 : nsDOMMutationObserver::EnterMutationHandling()</span>
<span class="lineNum">     970 </span>            : {
<span class="lineNum">     971 </span><span class="lineCov">          1 :   ++sMutationLevel;</span>
<span class="lineNum">     972 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     973 </span>            : 
<span class="lineNum">     974 </span>            : // Leave the current mutation level (there can be several levels if in case
<span class="lineNum">     975 </span>            : // of nested calls to the nsIMutationObserver methods).
<span class="lineNum">     976 </span>            : // The most recent mutation record is removed from mCurrentMutations, so
<a name="977"><span class="lineNum">     977 </span>            : // that is doesn't get modified anymore by receivers.</a>
<span class="lineNum">     978 </span>            : void
<span class="lineNum">     979 </span><span class="lineCov">          1 : nsDOMMutationObserver::LeaveMutationHandling()</span>
<span class="lineNum">     980 </span>            : {
<span class="lineNum">     981 </span><span class="lineCov">          1 :   if (sCurrentlyHandlingObservers &amp;&amp;</span>
<span class="lineNum">     982 </span><span class="lineCov">          1 :       sCurrentlyHandlingObservers-&gt;Length() == sMutationLevel) {</span>
<span class="lineNum">     983 </span>            :     nsTArray&lt;RefPtr&lt;nsDOMMutationObserver&gt; &gt;&amp; obs =
<span class="lineNum">     984 </span><span class="lineCov">          1 :       sCurrentlyHandlingObservers-&gt;ElementAt(sMutationLevel - 1);</span>
<span class="lineNum">     985 </span><span class="lineCov">          1 :     for (uint32_t i = 0; i &lt; obs.Length(); ++i) {</span>
<span class="lineNum">     986 </span>            :       nsDOMMutationObserver* o =
<span class="lineNum">     987 </span><span class="lineCov">          1 :         static_cast&lt;nsDOMMutationObserver*&gt;(obs[i]);</span>
<span class="lineNum">     988 </span><span class="lineCov">          1 :       if (o-&gt;mCurrentMutations.Length() == sMutationLevel) {</span>
<span class="lineNum">     989 </span>            :         // It is already in pending mutations.
<span class="lineNum">     990 </span><span class="lineCov">          1 :         o-&gt;mCurrentMutations.RemoveElementAt(sMutationLevel - 1);</span>
<span class="lineNum">     991 </span>            :       }
<span class="lineNum">     992 </span>            :     }
<span class="lineNum">     993 </span><span class="lineCov">          1 :     sCurrentlyHandlingObservers-&gt;RemoveElementAt(sMutationLevel - 1);</span>
<span class="lineNum">     994 </span>            :   }
<span class="lineNum">     995 </span><span class="lineCov">          1 :   --sMutationLevel;</span>
<span class="lineNum">     996 </span><span class="lineCov">          1 : }</span>
<a name="997"><span class="lineNum">     997 </span>            : </a>
<span class="lineNum">     998 </span>            : void
<span class="lineNum">     999 </span><span class="lineCov">          1 : nsDOMMutationObserver::AddCurrentlyHandlingObserver(nsDOMMutationObserver* aObserver,</span>
<span class="lineNum">    1000 </span>            :                                                     uint32_t aMutationLevel)
<span class="lineNum">    1001 </span>            : {
<span class="lineNum">    1002 </span>            :   NS_ASSERTION(aMutationLevel &gt; 0, &quot;Unexpected mutation level!&quot;);
<span class="lineNum">    1003 </span>            : 
<span class="lineNum">    1004 </span><span class="lineCov">          1 :   if (aMutationLevel &gt; 1) {</span>
<span class="lineNum">    1005 </span>            :     // MutationObserver must be in the currently handling observer list
<span class="lineNum">    1006 </span>            :     // in all the nested levels.
<span class="lineNum">    1007 </span><span class="lineCov">          1 :     AddCurrentlyHandlingObserver(aObserver, aMutationLevel - 1);</span>
<span class="lineNum">    1008 </span>            :   }
<span class="lineNum">    1009 </span>            : 
<span class="lineNum">    1010 </span><span class="lineCov">          1 :   if (!sCurrentlyHandlingObservers) {</span>
<span class="lineNum">    1011 </span>            :     sCurrentlyHandlingObservers =
<span class="lineNum">    1012 </span><span class="lineCov">          1 :       new AutoTArray&lt;AutoTArray&lt;RefPtr&lt;nsDOMMutationObserver&gt;, 4&gt;, 4&gt;;</span>
<span class="lineNum">    1013 </span>            :   }
<span class="lineNum">    1014 </span>            : 
<span class="lineNum">    1015 </span><span class="lineCov">          1 :   while (sCurrentlyHandlingObservers-&gt;Length() &lt; aMutationLevel) {</span>
<span class="lineNum">    1016 </span>            :     sCurrentlyHandlingObservers-&gt;InsertElementAt(
<span class="lineNum">    1017 </span><span class="lineCov">          1 :       sCurrentlyHandlingObservers-&gt;Length());</span>
<span class="lineNum">    1018 </span>            :   }
<span class="lineNum">    1019 </span>            : 
<span class="lineNum">    1020 </span><span class="lineCov">          1 :   uint32_t index = aMutationLevel - 1;</span>
<span class="lineNum">    1021 </span><span class="lineCov">          1 :   if (!sCurrentlyHandlingObservers-&gt;ElementAt(index).Contains(aObserver)) {</span>
<span class="lineNum">    1022 </span><span class="lineCov">          1 :     sCurrentlyHandlingObservers-&gt;ElementAt(index).AppendElement(aObserver);</span>
<span class="lineNum">    1023 </span>            :   }
<span class="lineNum">    1024 </span><span class="lineCov">          1 : }</span>
<a name="1025"><span class="lineNum">    1025 </span>            : </a>
<span class="lineNum">    1026 </span>            : void
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 : nsDOMMutationObserver::Shutdown()</span>
<span class="lineNum">    1028 </span>            : {
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :   delete sCurrentlyHandlingObservers;</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :   sCurrentlyHandlingObservers = nullptr;</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :   delete sScheduledMutationObservers;</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :   sScheduledMutationObservers = nullptr;</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1034 </span>            : 
<span class="lineNum">    1035 </span>            : nsAutoMutationBatch*
<span class="lineNum">    1036 </span>            : nsAutoMutationBatch::sCurrentBatch = nullptr;
<a name="1037"><span class="lineNum">    1037 </span>            : </a>
<span class="lineNum">    1038 </span>            : void
<span class="lineNum">    1039 </span><span class="lineCov">          1 : nsAutoMutationBatch::Done()</span>
<span class="lineNum">    1040 </span>            : {
<span class="lineNum">    1041 </span><span class="lineCov">          1 :   if (sCurrentBatch != this) {</span>
<span class="lineNum">    1042 </span>            :     return;
<span class="lineNum">    1043 </span>            :   }
<span class="lineNum">    1044 </span>            : 
<span class="lineNum">    1045 </span><span class="lineCov">          1 :   sCurrentBatch = mPreviousBatch;</span>
<span class="lineNum">    1046 </span><span class="lineCov">          1 :   if (mObservers.IsEmpty()) {</span>
<span class="lineNum">    1047 </span><span class="lineCov">          1 :     nsDOMMutationObserver::LeaveMutationHandling();</span>
<span class="lineNum">    1048 </span>            :     // Nothing to do.
<span class="lineNum">    1049 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">    1050 </span>            :   }
<span class="lineNum">    1051 </span>            : 
<span class="lineNum">    1052 </span>            :   uint32_t len = mObservers.Length();
<span class="lineNum">    1053 </span><span class="lineCov">          1 :   for (uint32_t i = 0; i &lt; len; ++i) {</span>
<span class="lineNum">    1054 </span><span class="lineCov">          1 :     nsDOMMutationObserver* ob = mObservers[i].mObserver;</span>
<span class="lineNum">    1055 </span><span class="lineCov">          1 :     bool wantsChildList = mObservers[i].mWantsChildList;</span>
<span class="lineNum">    1056 </span>            : 
<span class="lineNum">    1057 </span>            :     RefPtr&lt;nsSimpleContentList&gt; removedList;
<span class="lineNum">    1058 </span><span class="lineCov">          1 :     if (wantsChildList) {</span>
<span class="lineNum">    1059 </span><span class="lineCov">          1 :       removedList = new nsSimpleContentList(mBatchTarget);</span>
<span class="lineNum">    1060 </span>            :     }
<span class="lineNum">    1061 </span>            : 
<span class="lineNum">    1062 </span>            :     nsTArray&lt;nsMutationReceiver*&gt; allObservers;
<span class="lineNum">    1063 </span><span class="lineCov">          1 :     ob-&gt;GetAllSubtreeObserversFor(mBatchTarget, allObservers);</span>
<span class="lineNum">    1064 </span>            : 
<span class="lineNum">    1065 </span><span class="lineCov">          1 :     int32_t j = mFromFirstToLast ? 0 : mRemovedNodes.Length() - 1;</span>
<span class="lineNum">    1066 </span><span class="lineCov">          1 :     int32_t end = mFromFirstToLast ? mRemovedNodes.Length() : -1;</span>
<span class="lineNum">    1067 </span><span class="lineCov">          1 :     for (; j != end; mFromFirstToLast ? ++j : --j) {</span>
<span class="lineNum">    1068 </span><span class="lineCov">          1 :       nsCOMPtr&lt;nsIContent&gt; removed = mRemovedNodes[j];</span>
<span class="lineNum">    1069 </span><span class="lineCov">          1 :       if (removedList) {</span>
<span class="lineNum">    1070 </span><span class="lineCov">          1 :         removedList-&gt;AppendElement(removed);</span>
<span class="lineNum">    1071 </span>            :       }
<span class="lineNum">    1072 </span>            : 
<span class="lineNum">    1073 </span><span class="lineCov">          1 :       if (allObservers.Length()) {</span>
<span class="lineNum">    1074 </span><span class="lineCov">          1 :         nsCOMArray&lt;nsMutationReceiver&gt;* transientReceivers = nullptr;</span>
<span class="lineNum">    1075 </span><span class="lineCov">          1 :         ob-&gt;mTransientReceivers.Get(removed, &amp;transientReceivers);</span>
<span class="lineNum">    1076 </span><span class="lineCov">          1 :         if (!transientReceivers) {</span>
<span class="lineNum">    1077 </span><span class="lineCov">          1 :           transientReceivers = new nsCOMArray&lt;nsMutationReceiver&gt;();</span>
<span class="lineNum">    1078 </span><span class="lineCov">          1 :           ob-&gt;mTransientReceivers.Put(removed, transientReceivers);</span>
<span class="lineNum">    1079 </span>            :         }
<span class="lineNum">    1080 </span><span class="lineCov">          1 :         for (uint32_t k = 0; k &lt; allObservers.Length(); ++k) {</span>
<span class="lineNum">    1081 </span><span class="lineCov">          1 :           nsMutationReceiver* r = allObservers[k];</span>
<span class="lineNum">    1082 </span><span class="lineCov">          1 :           nsMutationReceiver* orig = r-&gt;GetParent() ? r-&gt;GetParent() : r;</span>
<span class="lineNum">    1083 </span><span class="lineCov">          1 :           if (ob-&gt;GetReceiverFor(removed, false, false) != orig) {</span>
<span class="lineNum">    1084 </span>            :             // Make sure the elements which are removed from the
<span class="lineNum">    1085 </span>            :             // subtree are kept in the same observation set.
<span class="lineNum">    1086 </span>            :             nsMutationReceiver* tr;
<span class="lineNum">    1087 </span><span class="lineCov">          1 :             if (orig-&gt;Animations()) {</span>
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :               tr = nsAnimationReceiver::Create(removed, orig);</span>
<span class="lineNum">    1089 </span>            :             } else {
<span class="lineNum">    1090 </span><span class="lineCov">          1 :               tr = nsMutationReceiver::Create(removed, orig);</span>
<span class="lineNum">    1091 </span>            :             }
<span class="lineNum">    1092 </span><span class="lineCov">          1 :             transientReceivers-&gt;AppendObject(tr);</span>
<span class="lineNum">    1093 </span>            :           }
<span class="lineNum">    1094 </span>            :         }
<span class="lineNum">    1095 </span>            :       }
<span class="lineNum">    1096 </span>            :     }
<span class="lineNum">    1097 </span><span class="lineCov">          1 :     if (wantsChildList &amp;&amp; (mRemovedNodes.Length() || mAddedNodes.Length())) {</span>
<span class="lineNum">    1098 </span>            :       RefPtr&lt;nsSimpleContentList&gt; addedList =
<span class="lineNum">    1099 </span><span class="lineCov">          1 :         new nsSimpleContentList(mBatchTarget);</span>
<span class="lineNum">    1100 </span><span class="lineCov">          1 :       for (uint32_t i = 0; i &lt; mAddedNodes.Length(); ++i) {</span>
<span class="lineNum">    1101 </span><span class="lineCov">          1 :         addedList-&gt;AppendElement(mAddedNodes[i]);</span>
<span class="lineNum">    1102 </span>            :       }
<span class="lineNum">    1103 </span>            :       RefPtr&lt;nsDOMMutationRecord&gt; m =
<span class="lineNum">    1104 </span>            :         new nsDOMMutationRecord(nsGkAtoms::childList,
<span class="lineNum">    1105 </span><span class="lineCov">          1 :                                 ob-&gt;GetParentObject());</span>
<span class="lineNum">    1106 </span><span class="lineCov">          1 :       m-&gt;mTarget = mBatchTarget;</span>
<span class="lineNum">    1107 </span><span class="lineCov">          1 :       m-&gt;mRemovedNodes = removedList;</span>
<span class="lineNum">    1108 </span><span class="lineCov">          1 :       m-&gt;mAddedNodes = addedList;</span>
<span class="lineNum">    1109 </span><span class="lineCov">          1 :       m-&gt;mPreviousSibling = mPrevSibling;</span>
<span class="lineNum">    1110 </span><span class="lineCov">          1 :       m-&gt;mNextSibling = mNextSibling;</span>
<span class="lineNum">    1111 </span><span class="lineCov">          1 :       ob-&gt;AppendMutationRecord(m.forget());</span>
<span class="lineNum">    1112 </span>            :     }
<span class="lineNum">    1113 </span>            :     // Always schedule the observer so that transient receivers are
<span class="lineNum">    1114 </span>            :     // removed correctly.
<span class="lineNum">    1115 </span><span class="lineCov">          1 :     ob-&gt;ScheduleForRun();</span>
<span class="lineNum">    1116 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">    1117 </span><span class="lineCov">          1 :   nsDOMMutationObserver::LeaveMutationHandling();</span>
<span class="lineNum">    1118 </span>            : }
<span class="lineNum">    1119 </span>            : 
<span class="lineNum">    1120 </span>            : nsAutoAnimationMutationBatch*
<span class="lineNum">    1121 </span>            : nsAutoAnimationMutationBatch::sCurrentBatch = nullptr;
<a name="1122"><span class="lineNum">    1122 </span>            : </a>
<span class="lineNum">    1123 </span>            : void
<span class="lineNum">    1124 </span><span class="lineCov">          1 : nsAutoAnimationMutationBatch::Done()</span>
<span class="lineNum">    1125 </span>            : {
<span class="lineNum">    1126 </span><span class="lineCov">          1 :   if (sCurrentBatch != this) {</span>
<span class="lineNum">    1127 </span>            :     return;
<span class="lineNum">    1128 </span>            :   }
<span class="lineNum">    1129 </span>            : 
<span class="lineNum">    1130 </span><span class="lineCov">          1 :   sCurrentBatch = nullptr;</span>
<span class="lineNum">    1131 </span><span class="lineCov">          1 :   if (mObservers.IsEmpty()) {</span>
<span class="lineNum">    1132 </span><span class="lineCov">          1 :     nsDOMMutationObserver::LeaveMutationHandling();</span>
<span class="lineNum">    1133 </span>            :     // Nothing to do.
<span class="lineNum">    1134 </span><span class="lineCov">          1 :     return;</span>
<span class="lineNum">    1135 </span>            :   }
<span class="lineNum">    1136 </span>            : 
<span class="lineNum">    1137 </span><span class="lineCov">          1 :   mBatchTargets.Sort(TreeOrderComparator());</span>
<span class="lineNum">    1138 </span>            : 
<span class="lineNum">    1139 </span><span class="lineCov">          1 :   for (nsDOMMutationObserver* ob : mObservers) {</span>
<span class="lineNum">    1140 </span><span class="lineCov">          1 :     bool didAddRecords = false;</span>
<span class="lineNum">    1141 </span>            : 
<span class="lineNum">    1142 </span><span class="lineCov">          1 :     for (nsINode* target : mBatchTargets) {</span>
<span class="lineNum">    1143 </span><span class="lineCov">          1 :       EntryArray* entries = mEntryTable.Get(target);</span>
<span class="lineNum">    1144 </span>            :       MOZ_ASSERT(entries,
<span class="lineNum">    1145 </span>            :         &quot;Targets in entry table and targets list should match&quot;);
<span class="lineNum">    1146 </span>            : 
<span class="lineNum">    1147 </span>            :       RefPtr&lt;nsDOMMutationRecord&gt; m =
<span class="lineNum">    1148 </span><span class="lineCov">          1 :         new nsDOMMutationRecord(nsGkAtoms::animations, ob-&gt;GetParentObject());</span>
<span class="lineNum">    1149 </span><span class="lineCov">          1 :       m-&gt;mTarget = target;</span>
<span class="lineNum">    1150 </span>            : 
<span class="lineNum">    1151 </span><span class="lineCov">          1 :       for (const Entry&amp; e : *entries) {</span>
<span class="lineNum">    1152 </span><span class="lineCov">          1 :         if (e.mState == eState_Added) {</span>
<span class="lineNum">    1153 </span><span class="lineCov">          1 :           m-&gt;mAddedAnimations.AppendElement(e.mAnimation);</span>
<span class="lineNum">    1154 </span><span class="lineCov">          1 :         } else if (e.mState == eState_Removed) {</span>
<span class="lineNum">    1155 </span><span class="lineCov">          1 :           m-&gt;mRemovedAnimations.AppendElement(e.mAnimation);</span>
<span class="lineNum">    1156 </span><span class="lineCov">          1 :         } else if (e.mState == eState_RemainedPresent &amp;&amp; e.mChanged) {</span>
<span class="lineNum">    1157 </span><span class="lineCov">          1 :           m-&gt;mChangedAnimations.AppendElement(e.mAnimation);</span>
<span class="lineNum">    1158 </span>            :         }
<span class="lineNum">    1159 </span>            :       }
<span class="lineNum">    1160 </span>            : 
<span class="lineNum">    1161 </span><span class="lineCov">          1 :       if (!m-&gt;mAddedAnimations.IsEmpty() ||</span>
<span class="lineNum">    1162 </span><span class="lineCov">          1 :           !m-&gt;mChangedAnimations.IsEmpty() ||</span>
<span class="lineNum">    1163 </span><span class="lineCov">          1 :           !m-&gt;mRemovedAnimations.IsEmpty()) {</span>
<span class="lineNum">    1164 </span><span class="lineCov">          1 :         ob-&gt;AppendMutationRecord(m.forget());</span>
<span class="lineNum">    1165 </span><span class="lineCov">          1 :         didAddRecords = true;</span>
<span class="lineNum">    1166 </span>            :       }
<span class="lineNum">    1167 </span><span class="lineCov">          1 :     }</span>
<span class="lineNum">    1168 </span>            : 
<span class="lineNum">    1169 </span><span class="lineCov">          1 :     if (didAddRecords) {</span>
<span class="lineNum">    1170 </span><span class="lineCov">          1 :       ob-&gt;ScheduleForRun();</span>
<span class="lineNum">    1171 </span>            :     }
<span class="lineNum">    1172 </span>            :   }
<span class="lineNum">    1173 </span><span class="lineCov">          1 :   nsDOMMutationObserver::LeaveMutationHandling();</span>
<span class="lineNum">    1174 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
