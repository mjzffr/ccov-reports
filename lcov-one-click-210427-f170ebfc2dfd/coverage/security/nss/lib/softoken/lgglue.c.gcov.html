<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mochitest-e10s.info - security/nss/lib/softoken/lgglue.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">security/nss/lib/softoken</a> - lgglue.c<span style="font-size: 80%;"> (source / <a href="lgglue.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mochitest-e10s.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">4</td>
            <td class="headerCovTableEntry">172</td>
            <td class="headerCovTableEntryLo">2.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">12</td>
            <td class="headerCovTableEntryLo">8.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public</a>
<span class="lineNum">       2 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       3 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       4 </span>            : /*
<span class="lineNum">       5 </span>            :  *  The following code handles the storage of PKCS 11 modules used by the
<span class="lineNum">       6 </span>            :  * NSS. This file is written to abstract away how the modules are
<span class="lineNum">       7 </span>            :  * stored so we can deside that later.
<span class="lineNum">       8 </span>            :  */
<span class="lineNum">       9 </span>            : #include &quot;sftkdb.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;sftkdbti.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;sdb.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;prsystem.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;prprf.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;prenv.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;lgglue.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;secerr.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;softoken.h&quot;
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : static LGOpenFunc legacy_glue_open = NULL;
<span class="lineNum">      20 </span>            : static LGReadSecmodFunc legacy_glue_readSecmod = NULL;
<span class="lineNum">      21 </span>            : static LGReleaseSecmodFunc legacy_glue_releaseSecmod = NULL;
<span class="lineNum">      22 </span>            : static LGDeleteSecmodFunc legacy_glue_deleteSecmod = NULL;
<span class="lineNum">      23 </span>            : static LGAddSecmodFunc legacy_glue_addSecmod = NULL;
<span class="lineNum">      24 </span>            : static LGShutdownFunc legacy_glue_shutdown = NULL;
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : /*
<span class="lineNum">      27 </span>            :  * The following 3 functions duplicate the work done by bl_LoadLibrary.
<span class="lineNum">      28 </span>            :  * We should make bl_LoadLibrary a global and replace the call to
<span class="lineNum">      29 </span>            :  * sftkdb_LoadLibrary(const char *libname) with it.
<span class="lineNum">      30 </span>            :  */
<span class="lineNum">      31 </span>            : #ifdef XP_UNIX
<span class="lineNum">      32 </span>            : #include &lt;unistd.h&gt;
<a name="33"><span class="lineNum">      33 </span>            : #define LG_MAX_LINKS 20</a>
<span class="lineNum">      34 </span>            : static char *
<span class="lineNum">      35 </span><span class="lineNoCov">          0 : sftkdb_resolvePath(const char *orig)</span>
<span class="lineNum">      36 </span>            : {
<span class="lineNum">      37 </span><span class="lineNoCov">          0 :     int count = 0;</span>
<span class="lineNum">      38 </span><span class="lineNoCov">          0 :     int len = 0;</span>
<span class="lineNum">      39 </span><span class="lineNoCov">          0 :     int ret = -1;</span>
<span class="lineNum">      40 </span><span class="lineNoCov">          0 :     char *resolved = NULL;</span>
<span class="lineNum">      41 </span><span class="lineNoCov">          0 :     char *source = NULL;</span>
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span><span class="lineNoCov">          0 :     len = 1025; /* MAX PATH +1*/</span>
<span class="lineNum">      44 </span><span class="lineNoCov">          0 :     if (strlen(orig) + 1 &gt; len) {</span>
<span class="lineNum">      45 </span>            :         /* PATH TOO LONG */
<span class="lineNum">      46 </span>            :         return NULL;
<span class="lineNum">      47 </span>            :     }
<span class="lineNum">      48 </span><span class="lineNoCov">          0 :     resolved = PORT_Alloc(len);</span>
<span class="lineNum">      49 </span><span class="lineNoCov">          0 :     if (!resolved) {</span>
<span class="lineNum">      50 </span>            :         return NULL;
<span class="lineNum">      51 </span>            :     }
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :     source = PORT_Alloc(len);</span>
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :     if (!source) {</span>
<span class="lineNum">      54 </span>            :         goto loser;
<span class="lineNum">      55 </span>            :     }
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :     PORT_Strcpy(source, orig);</span>
<span class="lineNum">      57 </span>            :     /* Walk down all the links */
<span class="lineNum">      58 </span><span class="lineNoCov">          0 :     while (count++ &lt; LG_MAX_LINKS) {</span>
<span class="lineNum">      59 </span>            :         char *tmp;
<span class="lineNum">      60 </span>            :         /* swap our previous sorce out with resolved */
<span class="lineNum">      61 </span>            :         /* read it */
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :         ret = readlink(source, resolved, len - 1);</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :         if (ret &lt; 0) {</span>
<span class="lineNum">      64 </span>            :             break;
<span class="lineNum">      65 </span>            :         }
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :         resolved[ret] = 0;</span>
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :         tmp = source;</span>
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :         source = resolved;</span>
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :         resolved = tmp;</span>
<span class="lineNum">      70 </span>            :     }
<span class="lineNum">      71 </span><span class="lineNoCov">          0 :     if (count &gt; 1) {</span>
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :         ret = 0;</span>
<span class="lineNum">      73 </span>            :     }
<span class="lineNum">      74 </span>            : loser:
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :     if (resolved) {</span>
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :         PORT_Free(resolved);</span>
<span class="lineNum">      77 </span>            :     }
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :     if (ret &lt; 0) {</span>
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :         if (source) {</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :             PORT_Free(source);</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :             source = NULL;</span>
<span class="lineNum">      82 </span>            :         }
<span class="lineNum">      83 </span>            :     }
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :     return source;</span>
<span class="lineNum">      85 </span>            : }
<span class="lineNum">      86 </span>            : 
<span class="lineNum">      87 </span>            : #endif
<a name="88"><span class="lineNum">      88 </span>            : </a>
<span class="lineNum">      89 </span>            : static PRLibrary *
<span class="lineNum">      90 </span><span class="lineNoCov">          0 : sftkdb_LoadFromPath(const char *path, const char *libname)</span>
<span class="lineNum">      91 </span>            : {
<span class="lineNum">      92 </span>            :     char *c;
<span class="lineNum">      93 </span>            :     int pathLen, nameLen, fullPathLen;
<span class="lineNum">      94 </span><span class="lineNoCov">          0 :     char *fullPathName = NULL;</span>
<span class="lineNum">      95 </span>            :     PRLibSpec libSpec;
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :     PRLibrary *lib = NULL;</span>
<span class="lineNum">      97 </span>            : 
<span class="lineNum">      98 </span>            :     /* strip of our parent's library name */
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :     c = strrchr(path, PR_GetDirectorySeparator());</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :     if (!c) {</span>
<span class="lineNum">     101 </span>            :         return NULL; /* invalid path */
<span class="lineNum">     102 </span>            :     }
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :     pathLen = (c - path) + 1;</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :     nameLen = strlen(libname);</span>
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :     fullPathLen = pathLen + nameLen + 1;</span>
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :     fullPathName = (char *)PORT_Alloc(fullPathLen);</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :     if (fullPathName == NULL) {</span>
<span class="lineNum">     108 </span>            :         return NULL; /* memory allocation error */
<span class="lineNum">     109 </span>            :     }
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :     PORT_Memcpy(fullPathName, path, pathLen);</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :     PORT_Memcpy(fullPathName + pathLen, libname, nameLen);</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :     fullPathName[fullPathLen - 1] = 0;</span>
<span class="lineNum">     113 </span>            : 
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :     libSpec.type = PR_LibSpec_Pathname;</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :     libSpec.value.pathname = fullPathName;</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :     lib = PR_LoadLibraryWithFlags(libSpec, PR_LD_NOW | PR_LD_LOCAL);</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :     PORT_Free(fullPathName);</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :     return lib;</span>
<span class="lineNum">     119 </span>            : }
<a name="120"><span class="lineNum">     120 </span>            : </a>
<span class="lineNum">     121 </span>            : static PRLibrary *
<span class="lineNum">     122 </span><span class="lineNoCov">          0 : sftkdb_LoadLibrary(const char *libname)</span>
<span class="lineNum">     123 </span>            : {
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :     PRLibrary *lib = NULL;</span>
<span class="lineNum">     125 </span>            :     PRFuncPtr fn_addr;
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :     char *parentLibPath = NULL;</span>
<span class="lineNum">     127 </span>            : 
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :     fn_addr = (PRFuncPtr)&amp;sftkdb_LoadLibrary;</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :     parentLibPath = PR_GetLibraryFilePathname(SOFTOKEN_LIB_NAME, fn_addr);</span>
<span class="lineNum">     130 </span>            : 
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :     if (!parentLibPath) {</span>
<span class="lineNum">     132 </span>            :         goto done;
<span class="lineNum">     133 </span>            :     }
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :     lib = sftkdb_LoadFromPath(parentLibPath, libname);</span>
<span class="lineNum">     136 </span>            : #ifdef XP_UNIX
<span class="lineNum">     137 </span>            :     /* handle symbolic link case */
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :     if (!lib) {</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :         char *trueParentLibPath = sftkdb_resolvePath(parentLibPath);</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :         if (!trueParentLibPath) {</span>
<span class="lineNum">     141 </span>            :             goto done;
<span class="lineNum">     142 </span>            :         }
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :         lib = sftkdb_LoadFromPath(trueParentLibPath, libname);</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :         PORT_Free(trueParentLibPath);</span>
<span class="lineNum">     145 </span>            :     }
<span class="lineNum">     146 </span>            : #endif
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span>            : done:
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :     if (parentLibPath) {</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :         PORT_Free(parentLibPath);</span>
<span class="lineNum">     151 </span>            :     }
<span class="lineNum">     152 </span>            : 
<span class="lineNum">     153 </span>            :     /* still couldn't load it, try the generic path */
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :     if (!lib) {</span>
<span class="lineNum">     155 </span>            :         PRLibSpec libSpec;
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :         libSpec.type = PR_LibSpec_Pathname;</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :         libSpec.value.pathname = libname;</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :         lib = PR_LoadLibraryWithFlags(libSpec, PR_LD_NOW | PR_LD_LOCAL);</span>
<span class="lineNum">     159 </span>            :     }
<span class="lineNum">     160 </span>            : 
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :     return lib;</span>
<span class="lineNum">     162 </span>            : }
<span class="lineNum">     163 </span>            : 
<span class="lineNum">     164 </span>            : /*
<span class="lineNum">     165 </span>            :  * stub files for legacy db's to be able to encrypt and decrypt
<span class="lineNum">     166 </span>            :  * various keys and attributes.
<a name="167"><span class="lineNum">     167 </span>            :  */</a>
<span class="lineNum">     168 </span>            : static SECStatus
<span class="lineNum">     169 </span><span class="lineNoCov">          0 : sftkdb_encrypt_stub(PLArenaPool *arena, SDB *sdb, SECItem *plainText,</span>
<span class="lineNum">     170 </span>            :                     SECItem **cipherText)
<span class="lineNum">     171 </span>            : {
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :     SFTKDBHandle *handle = sdb-&gt;app_private;</span>
<span class="lineNum">     173 </span>            :     SECStatus rv;
<span class="lineNum">     174 </span>            : 
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     if (handle == NULL) {</span>
<span class="lineNum">     176 </span>            :         return SECFailure;
<span class="lineNum">     177 </span>            :     }
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span>            :     /* if we aren't the key handle, try the other handle */
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :     if (handle-&gt;type != SFTK_KEYDB_TYPE) {</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :         handle = handle-&gt;peerDB;</span>
<span class="lineNum">     182 </span>            :     }
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span>            :     /* not a key handle */
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :     if (handle == NULL || handle-&gt;passwordLock == NULL) {</span>
<span class="lineNum">     186 </span>            :         return SECFailure;
<span class="lineNum">     187 </span>            :     }
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :     PZ_Lock(handle-&gt;passwordLock);</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :     if (handle-&gt;passwordKey.data == NULL) {</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :         PZ_Unlock(handle-&gt;passwordLock);</span>
<span class="lineNum">     192 </span>            :         /* PORT_SetError */
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :         return SECFailure;</span>
<span class="lineNum">     194 </span>            :     }
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :     rv = sftkdb_EncryptAttribute(arena,</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :                                  handle-&gt;newKey ? handle-&gt;newKey : &amp;handle-&gt;passwordKey,</span>
<span class="lineNum">     198 </span>            :                                  plainText, cipherText);
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     PZ_Unlock(handle-&gt;passwordLock);</span>
<span class="lineNum">     200 </span>            : 
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">     202 </span>            : }
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span>            : /*
<span class="lineNum">     205 </span>            :  * stub files for legacy db's to be able to encrypt and decrypt
<span class="lineNum">     206 </span>            :  * various keys and attributes.
<a name="207"><span class="lineNum">     207 </span>            :  */</a>
<span class="lineNum">     208 </span>            : static SECStatus
<span class="lineNum">     209 </span><span class="lineNoCov">          0 : sftkdb_decrypt_stub(SDB *sdb, SECItem *cipherText, SECItem **plainText)</span>
<span class="lineNum">     210 </span>            : {
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :     SFTKDBHandle *handle = sdb-&gt;app_private;</span>
<span class="lineNum">     212 </span>            :     SECStatus rv;
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :     SECItem *oldKey = NULL;</span>
<span class="lineNum">     214 </span>            : 
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :     if (handle == NULL) {</span>
<span class="lineNum">     216 </span>            :         return SECFailure;
<span class="lineNum">     217 </span>            :     }
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span>            :     /* if we aren't th handle, try the other handle */
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :     oldKey = handle-&gt;oldKey;</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :     if (handle-&gt;type != SFTK_KEYDB_TYPE) {</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :         handle = handle-&gt;peerDB;</span>
<span class="lineNum">     223 </span>            :     }
<span class="lineNum">     224 </span>            : 
<span class="lineNum">     225 </span>            :     /* not a key handle */
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :     if (handle == NULL || handle-&gt;passwordLock == NULL) {</span>
<span class="lineNum">     227 </span>            :         return SECFailure;
<span class="lineNum">     228 </span>            :     }
<span class="lineNum">     229 </span>            : 
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :     PZ_Lock(handle-&gt;passwordLock);</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :     if (handle-&gt;passwordKey.data == NULL) {</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :         PZ_Unlock(handle-&gt;passwordLock);</span>
<span class="lineNum">     233 </span>            :         /* PORT_SetError */
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :         return SECFailure;</span>
<span class="lineNum">     235 </span>            :     }
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :     rv = sftkdb_DecryptAttribute(oldKey ? oldKey : &amp;handle-&gt;passwordKey,</span>
<span class="lineNum">     237 </span>            :                                  cipherText, plainText);
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :     PZ_Unlock(handle-&gt;passwordLock);</span>
<span class="lineNum">     239 </span>            : 
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">     241 </span>            : }
<span class="lineNum">     242 </span>            : 
<span class="lineNum">     243 </span>            : static const char *LEGACY_LIB_NAME =
<span class="lineNum">     244 </span>            :     SHLIB_PREFIX &quot;nssdbm&quot; SHLIB_VERSION &quot;.&quot; SHLIB_SUFFIX;
<span class="lineNum">     245 </span>            : /*
<span class="lineNum">     246 </span>            :  * 2 bools to tell us if we've check the legacy library successfully or
<span class="lineNum">     247 </span>            :  * not. Initialize on startup to false by the C BSS segment;
<span class="lineNum">     248 </span>            :  */
<a name="249"><span class="lineNum">     249 </span>            : static PRLibrary *legacy_glue_lib = NULL;</a>
<span class="lineNum">     250 </span>            : static SECStatus
<span class="lineNum">     251 </span><span class="lineNoCov">          0 : sftkdbLoad_Legacy()</span>
<span class="lineNum">     252 </span>            : {
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :     PRLibrary *lib = NULL;</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :     LGSetCryptFunc setCryptFunction = NULL;</span>
<span class="lineNum">     255 </span>            : 
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :     if (legacy_glue_lib) {</span>
<span class="lineNum">     257 </span>            :         return SECSuccess;
<span class="lineNum">     258 </span>            :     }
<span class="lineNum">     259 </span>            : 
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :     lib = sftkdb_LoadLibrary(LEGACY_LIB_NAME);</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :     if (lib == NULL) {</span>
<span class="lineNum">     262 </span>            :         return SECFailure;
<span class="lineNum">     263 </span>            :     }
<span class="lineNum">     264 </span>            : 
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :     legacy_glue_open = (LGOpenFunc)PR_FindFunctionSymbol(lib, &quot;legacy_Open&quot;);</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :     legacy_glue_readSecmod =</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :         (LGReadSecmodFunc)PR_FindFunctionSymbol(lib, &quot;legacy_ReadSecmodDB&quot;);</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :     legacy_glue_releaseSecmod =</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :         (LGReleaseSecmodFunc)PR_FindFunctionSymbol(lib, &quot;legacy_ReleaseSecmodDBData&quot;);</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :     legacy_glue_deleteSecmod =</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :         (LGDeleteSecmodFunc)PR_FindFunctionSymbol(lib, &quot;legacy_DeleteSecmodDB&quot;);</span>
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :     legacy_glue_addSecmod =</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :         (LGAddSecmodFunc)PR_FindFunctionSymbol(lib, &quot;legacy_AddSecmodDB&quot;);</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :     legacy_glue_shutdown =</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :         (LGShutdownFunc)PR_FindFunctionSymbol(lib, &quot;legacy_Shutdown&quot;);</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :     setCryptFunction =</span>
<span class="lineNum">     277 </span>            :         (LGSetCryptFunc)PR_FindFunctionSymbol(lib, &quot;legacy_SetCryptFunctions&quot;);
<span class="lineNum">     278 </span>            : 
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :     if (!legacy_glue_open || !legacy_glue_readSecmod ||</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :         !legacy_glue_releaseSecmod || !legacy_glue_deleteSecmod ||</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :         !legacy_glue_addSecmod || !setCryptFunction) {</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :         PR_UnloadLibrary(lib);</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :         return SECFailure;</span>
<span class="lineNum">     284 </span>            :     }
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :     setCryptFunction(sftkdb_encrypt_stub, sftkdb_decrypt_stub);</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :     legacy_glue_lib = lib;</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :     return SECSuccess;</span>
<span class="lineNum">     289 </span>            : }
<a name="290"><span class="lineNum">     290 </span>            : </a>
<span class="lineNum">     291 </span>            : CK_RV
<span class="lineNum">     292 </span><span class="lineNoCov">          0 : sftkdbCall_open(const char *dir, const char *certPrefix, const char *keyPrefix,</span>
<span class="lineNum">     293 </span>            :                 int certVersion, int keyVersion, int flags,
<span class="lineNum">     294 </span>            :                 SDB **certDB, SDB **keyDB)
<span class="lineNum">     295 </span>            : {
<span class="lineNum">     296 </span>            :     SECStatus rv;
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :     rv = sftkdbLoad_Legacy();</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :     if (rv != SECSuccess) {</span>
<span class="lineNum">     300 </span>            :         return CKR_GENERAL_ERROR;
<span class="lineNum">     301 </span>            :     }
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :     if (!legacy_glue_open) {</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :         PORT_SetError(SEC_ERROR_LIBRARY_FAILURE);</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :         return SECFailure;</span>
<span class="lineNum">     305 </span>            :     }
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :     return (*legacy_glue_open)(dir, certPrefix, keyPrefix,</span>
<span class="lineNum">     307 </span>            :                                certVersion, keyVersion,
<span class="lineNum">     308 </span>            :                                flags, certDB, keyDB);
<span class="lineNum">     309 </span>            : }
<a name="310"><span class="lineNum">     310 </span>            : </a>
<span class="lineNum">     311 </span>            : char **
<span class="lineNum">     312 </span><span class="lineNoCov">          0 : sftkdbCall_ReadSecmodDB(const char *appName, const char *filename,</span>
<span class="lineNum">     313 </span>            :                         const char *dbname, char *params, PRBool rw)
<span class="lineNum">     314 </span>            : {
<span class="lineNum">     315 </span>            :     SECStatus rv;
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :     rv = sftkdbLoad_Legacy();</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :     if (rv != SECSuccess) {</span>
<span class="lineNum">     319 </span>            :         return NULL;
<span class="lineNum">     320 </span>            :     }
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :     if (!legacy_glue_readSecmod) {</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :         PORT_SetError(SEC_ERROR_LIBRARY_FAILURE);</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">     324 </span>            :     }
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :     return (*legacy_glue_readSecmod)(appName, filename, dbname, params, rw);</span>
<span class="lineNum">     326 </span>            : }
<a name="327"><span class="lineNum">     327 </span>            : </a>
<span class="lineNum">     328 </span>            : SECStatus
<span class="lineNum">     329 </span><span class="lineNoCov">          0 : sftkdbCall_ReleaseSecmodDBData(const char *appName,</span>
<span class="lineNum">     330 </span>            :                                const char *filename, const char *dbname,
<span class="lineNum">     331 </span>            :                                char **moduleSpecList, PRBool rw)
<span class="lineNum">     332 </span>            : {
<span class="lineNum">     333 </span>            :     SECStatus rv;
<span class="lineNum">     334 </span>            : 
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :     rv = sftkdbLoad_Legacy();</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :     if (rv != SECSuccess) {</span>
<span class="lineNum">     337 </span>            :         return rv;
<span class="lineNum">     338 </span>            :     }
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :     if (!legacy_glue_releaseSecmod) {</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :         PORT_SetError(SEC_ERROR_LIBRARY_FAILURE);</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :         return SECFailure;</span>
<span class="lineNum">     342 </span>            :     }
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :     return (*legacy_glue_releaseSecmod)(appName, filename, dbname,</span>
<span class="lineNum">     344 </span>            :                                         moduleSpecList, rw);
<span class="lineNum">     345 </span>            : }
<a name="346"><span class="lineNum">     346 </span>            : </a>
<span class="lineNum">     347 </span>            : SECStatus
<span class="lineNum">     348 </span><span class="lineNoCov">          0 : sftkdbCall_DeleteSecmodDB(const char *appName,</span>
<span class="lineNum">     349 </span>            :                           const char *filename, const char *dbname,
<span class="lineNum">     350 </span>            :                           char *args, PRBool rw)
<span class="lineNum">     351 </span>            : {
<span class="lineNum">     352 </span>            :     SECStatus rv;
<span class="lineNum">     353 </span>            : 
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :     rv = sftkdbLoad_Legacy();</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :     if (rv != SECSuccess) {</span>
<span class="lineNum">     356 </span>            :         return rv;
<span class="lineNum">     357 </span>            :     }
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :     if (!legacy_glue_deleteSecmod) {</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :         PORT_SetError(SEC_ERROR_LIBRARY_FAILURE);</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :         return SECFailure;</span>
<span class="lineNum">     361 </span>            :     }
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :     return (*legacy_glue_deleteSecmod)(appName, filename, dbname, args, rw);</span>
<span class="lineNum">     363 </span>            : }
<a name="364"><span class="lineNum">     364 </span>            : </a>
<span class="lineNum">     365 </span>            : SECStatus
<span class="lineNum">     366 </span><span class="lineNoCov">          0 : sftkdbCall_AddSecmodDB(const char *appName,</span>
<span class="lineNum">     367 </span>            :                        const char *filename, const char *dbname,
<span class="lineNum">     368 </span>            :                        char *module, PRBool rw)
<span class="lineNum">     369 </span>            : {
<span class="lineNum">     370 </span>            :     SECStatus rv;
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :     rv = sftkdbLoad_Legacy();</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :     if (rv != SECSuccess) {</span>
<span class="lineNum">     374 </span>            :         return rv;
<span class="lineNum">     375 </span>            :     }
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :     if (!legacy_glue_addSecmod) {</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :         PORT_SetError(SEC_ERROR_LIBRARY_FAILURE);</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :         return SECFailure;</span>
<span class="lineNum">     379 </span>            :     }
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :     return (*legacy_glue_addSecmod)(appName, filename, dbname, module, rw);</span>
<span class="lineNum">     381 </span>            : }
<a name="382"><span class="lineNum">     382 </span>            : </a>
<span class="lineNum">     383 </span>            : CK_RV
<span class="lineNum">     384 </span><span class="lineCov">          3 : sftkdbCall_Shutdown(void)</span>
<span class="lineNum">     385 </span>            : {
<span class="lineNum">     386 </span><span class="lineCov">          3 :     CK_RV crv = CKR_OK;</span>
<span class="lineNum">     387 </span><span class="lineCov">          3 :     char *disableUnload = NULL;</span>
<span class="lineNum">     388 </span><span class="lineCov">          3 :     if (!legacy_glue_lib) {</span>
<span class="lineNum">     389 </span>            :         return CKR_OK;
<span class="lineNum">     390 </span>            :     }
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     if (legacy_glue_shutdown) {</span>
<span class="lineNum">     392 </span>            : #ifdef NO_FORK_CHECK
<span class="lineNum">     393 </span>            :         PRBool parentForkedAfterC_Initialize = PR_FALSE;
<span class="lineNum">     394 </span>            : #endif
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :         crv = (*legacy_glue_shutdown)(parentForkedAfterC_Initialize);</span>
<span class="lineNum">     396 </span>            :     }
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :     disableUnload = PR_GetEnvSecure(&quot;NSS_DISABLE_UNLOAD&quot;);</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :     if (!disableUnload) {</span>
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :         PR_UnloadLibrary(legacy_glue_lib);</span>
<span class="lineNum">     400 </span>            :     }
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :     legacy_glue_lib = NULL;</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :     legacy_glue_open = NULL;</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :     legacy_glue_readSecmod = NULL;</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :     legacy_glue_releaseSecmod = NULL;</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :     legacy_glue_deleteSecmod = NULL;</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :     legacy_glue_addSecmod = NULL;</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :     return crv;</span>
<span class="lineNum">     408 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
