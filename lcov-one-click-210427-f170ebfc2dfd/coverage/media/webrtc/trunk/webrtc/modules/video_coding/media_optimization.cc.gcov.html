<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mochitest-e10s.info - media/webrtc/trunk/webrtc/modules/video_coding/media_optimization.cc</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../index.html">top level</a> - <a href="index.html">media/webrtc/trunk/webrtc/modules/video_coding</a> - media_optimization.cc<span style="font-size: 80%;"> (source / <a href="media_optimization.cc.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mochitest-e10s.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">318</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">30</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *  Copyright (c) 2012 The WebRTC project authors. All Rights Reserved.
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *  Use of this source code is governed by a BSD-style license
<span class="lineNum">       5 </span>            :  *  that can be found in the LICENSE file in the root of the source
<span class="lineNum">       6 </span>            :  *  tree. An additional intellectual property rights grant can be found
<span class="lineNum">       7 </span>            :  *  in the file PATENTS.  All contributing project authors may
<span class="lineNum">       8 </span>            :  *  be found in the AUTHORS file in the root of the source tree.
<span class="lineNum">       9 </span>            :  */
<span class="lineNum">      10 </span>            : 
<span class="lineNum">      11 </span>            : #include &quot;webrtc/modules/video_coding/media_optimization.h&quot;
<span class="lineNum">      12 </span>            : 
<span class="lineNum">      13 </span>            : #include &quot;webrtc/base/logging.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;webrtc/modules/video_coding/content_metrics_processing.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;webrtc/modules/video_coding/qm_select.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;webrtc/modules/video_coding/utility/frame_dropper.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;webrtc/system_wrappers/include/clock.h&quot;
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            : namespace webrtc {
<a name="20"><span class="lineNum">      20 </span>            : namespace media_optimization {</a>
<span class="lineNum">      21 </span>            : namespace {
<span class="lineNum">      22 </span><span class="lineNoCov">          0 : void UpdateProtectionCallback(</span>
<span class="lineNum">      23 </span>            :     VCMProtectionMethod* selected_method,
<span class="lineNum">      24 </span>            :     uint32_t* video_rate_bps,
<span class="lineNum">      25 </span>            :     uint32_t* nack_overhead_rate_bps,
<span class="lineNum">      26 </span>            :     uint32_t* fec_overhead_rate_bps,
<span class="lineNum">      27 </span>            :     VCMProtectionCallback* video_protection_callback) {
<span class="lineNum">      28 </span>            :   FecProtectionParams delta_fec_params;
<span class="lineNum">      29 </span>            :   FecProtectionParams key_fec_params;
<span class="lineNum">      30 </span>            :   // Get the FEC code rate for Key frames (set to 0 when NA).
<span class="lineNum">      31 </span><span class="lineNoCov">          0 :   key_fec_params.fec_rate = selected_method-&gt;RequiredProtectionFactorK();</span>
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            :   // Get the FEC code rate for Delta frames (set to 0 when NA).
<span class="lineNum">      34 </span><span class="lineNoCov">          0 :   delta_fec_params.fec_rate = selected_method-&gt;RequiredProtectionFactorD();</span>
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            :   // Get the FEC-UEP protection status for Key frames: UEP on/off.
<span class="lineNum">      37 </span><span class="lineNoCov">          0 :   key_fec_params.use_uep_protection = selected_method-&gt;RequiredUepProtectionK();</span>
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            :   // Get the FEC-UEP protection status for Delta frames: UEP on/off.
<span class="lineNum">      40 </span>            :   delta_fec_params.use_uep_protection =
<span class="lineNum">      41 </span><span class="lineNoCov">          0 :       selected_method-&gt;RequiredUepProtectionD();</span>
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            :   // The RTP module currently requires the same |max_fec_frames| for both
<span class="lineNum">      44 </span>            :   // key and delta frames.
<span class="lineNum">      45 </span><span class="lineNoCov">          0 :   delta_fec_params.max_fec_frames = selected_method-&gt;MaxFramesFec();</span>
<span class="lineNum">      46 </span><span class="lineNoCov">          0 :   key_fec_params.max_fec_frames = selected_method-&gt;MaxFramesFec();</span>
<span class="lineNum">      47 </span>            : 
<span class="lineNum">      48 </span>            :   // Set the FEC packet mask type. |kFecMaskBursty| is more effective for
<span class="lineNum">      49 </span>            :   // consecutive losses and little/no packet re-ordering. As we currently
<span class="lineNum">      50 </span>            :   // do not have feedback data on the degree of correlated losses and packet
<span class="lineNum">      51 </span>            :   // re-ordering, we keep default setting to |kFecMaskRandom| for now.
<span class="lineNum">      52 </span><span class="lineNoCov">          0 :   delta_fec_params.fec_mask_type = kFecMaskRandom;</span>
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :   key_fec_params.fec_mask_type = kFecMaskRandom;</span>
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span>            :   // TODO(Marco): Pass FEC protection values per layer.
<span class="lineNum">      56 </span>            :   video_protection_callback-&gt;ProtectionRequest(
<span class="lineNum">      57 </span>            :       &amp;delta_fec_params, &amp;key_fec_params, video_rate_bps,
<span class="lineNum">      58 </span><span class="lineNoCov">          0 :       nack_overhead_rate_bps, fec_overhead_rate_bps);</span>
<span class="lineNum">      59 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">      60 </span>            : }  // namespace
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span>            : struct MediaOptimization::EncodedFrameSample {
<span class="lineNum">      63 </span>            :   EncodedFrameSample(size_t size_bytes,
<span class="lineNum">      64 </span>            :                      uint32_t timestamp,
<span class="lineNum">      65 </span>            :                      int64_t time_complete_ms)
<a name="66"><span class="lineNum">      66 </span>            :       : size_bytes(size_bytes),</a>
<span class="lineNum">      67 </span>            :         timestamp(timestamp),
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :         time_complete_ms(time_complete_ms) {}</span>
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span>            :   size_t size_bytes;
<span class="lineNum">      71 </span>            :   uint32_t timestamp;
<span class="lineNum">      72 </span>            :   int64_t time_complete_ms;
<a name="73"><span class="lineNum">      73 </span>            : };</a>
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span><span class="lineNoCov">          0 : MediaOptimization::MediaOptimization(Clock* clock)</span>
<span class="lineNum">      76 </span>            :     : crit_sect_(CriticalSectionWrapper::CreateCriticalSection()),
<span class="lineNum">      77 </span>            :       clock_(clock),
<span class="lineNum">      78 </span>            :       max_bit_rate_(0),
<span class="lineNum">      79 </span>            :       send_codec_type_(kVideoCodecUnknown),
<span class="lineNum">      80 </span>            :       codec_width_(0),
<span class="lineNum">      81 </span>            :       codec_height_(0),
<span class="lineNum">      82 </span>            :       user_frame_rate_(0),
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :       frame_dropper_(new FrameDropper),</span>
<span class="lineNum">      84 </span>            :       loss_prot_logic_(
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :           new VCMLossProtectionLogic(clock_-&gt;TimeInMilliseconds())),</span>
<span class="lineNum">      86 </span>            :       fraction_lost_(0),
<span class="lineNum">      87 </span>            :       send_statistics_zero_encode_(0),
<span class="lineNum">      88 </span>            :       max_payload_size_(1460),
<span class="lineNum">      89 </span>            :       video_target_bitrate_(0),
<span class="lineNum">      90 </span>            :       incoming_frame_rate_(0),
<span class="lineNum">      91 </span>            :       enable_qm_(false),
<span class="lineNum">      92 </span>            :       encoded_frame_samples_(),
<span class="lineNum">      93 </span>            :       avg_sent_bit_rate_bps_(0),
<span class="lineNum">      94 </span>            :       avg_sent_framerate_(0),
<span class="lineNum">      95 </span>            :       key_frame_cnt_(0),
<span class="lineNum">      96 </span>            :       delta_frame_cnt_(0),
<span class="lineNum">      97 </span>            :       content_(new VCMContentMetricsProcessing()),
<span class="lineNum">      98 </span>            :       qm_resolution_(new VCMQmResolution()),
<span class="lineNum">      99 </span>            :       last_qm_update_time_(0),
<span class="lineNum">     100 </span>            :       last_change_time_(0),
<span class="lineNum">     101 </span>            :       num_layers_(0),
<span class="lineNum">     102 </span>            :       suspension_enabled_(false),
<span class="lineNum">     103 </span>            :       video_suspended_(false),
<span class="lineNum">     104 </span>            :       suspension_threshold_bps_(0),
<span class="lineNum">     105 </span>            :       suspension_window_bps_(0),
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :       loadstate_(kLoadNormal) {</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :   memset(send_statistics_, 0, sizeof(send_statistics_));</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :   memset(incoming_frame_times_, -1, sizeof(incoming_frame_times_));</span>
<a name="109"><span class="lineNum">     109 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span><span class="lineNoCov">          0 : MediaOptimization::~MediaOptimization(void) {</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :   loss_prot_logic_-&gt;Release();</span>
<a name="113"><span class="lineNum">     113 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span><span class="lineNoCov">          0 : void MediaOptimization::Reset() {</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :   CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     117 </span>            :   SetEncodingData(
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :       kVideoCodecUnknown, 0, 0, 0, 0, 0, 1, 0, max_payload_size_);</span>
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :   memset(incoming_frame_times_, -1, sizeof(incoming_frame_times_));</span>
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :   incoming_frame_rate_ = 0.0;</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :   frame_dropper_-&gt;Reset();</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :   loss_prot_logic_-&gt;Reset(clock_-&gt;TimeInMilliseconds());</span>
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :   frame_dropper_-&gt;SetRates(0, 0);</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :   content_-&gt;Reset();</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :   qm_resolution_-&gt;Reset();</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :   loss_prot_logic_-&gt;UpdateFrameRate(incoming_frame_rate_);</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :   loss_prot_logic_-&gt;Reset(clock_-&gt;TimeInMilliseconds());</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :   send_statistics_zero_encode_ = 0;</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :   video_target_bitrate_ = 0;</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :   codec_width_ = 0;</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :   codec_height_ = 0;</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :   min_width_ = 0;</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :   min_height_ = 0;</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :   user_frame_rate_ = 0;</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :   key_frame_cnt_ = 0;</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :   delta_frame_cnt_ = 0;</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :   last_qm_update_time_ = 0;</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :   last_change_time_ = 0;</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :   encoded_frame_samples_.clear();</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :   avg_sent_bit_rate_bps_ = 0;</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :   num_layers_ = 1;</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     143 </span>            : 
<span class="lineNum">     144 </span>            : // Euclid's algorithm
<a name="145"><span class="lineNum">     145 </span>            : // on arm, binary may be faster, but we do this rarely</a>
<span class="lineNum">     146 </span>            : static int GreatestCommonDenominator(int a, int b) {
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :   while (b != 0) {</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :     int t = b;</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :     b = a % b;</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :     a = t;</span>
<span class="lineNum">     151 </span>            :   }
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :   return a;</span>
<a name="153"><span class="lineNum">     153 </span>            : }</a>
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span><span class="lineNoCov">          0 : void MediaOptimization::SetEncodingData(VideoCodecType send_codec_type,</span>
<span class="lineNum">     156 </span>            :                                         int32_t max_bit_rate,    // in bits/s
<span class="lineNum">     157 </span>            :                                         uint32_t target_bitrate, // in bits/s
<span class="lineNum">     158 </span>            :                                         uint16_t width,
<span class="lineNum">     159 </span>            :                                         uint16_t height,
<span class="lineNum">     160 </span>            :                                         uint32_t frame_rate,     // in fps*1000
<span class="lineNum">     161 </span>            :                                         uint8_t  divisor,
<span class="lineNum">     162 </span>            :                                         int num_layers,
<span class="lineNum">     163 </span>            :                                         int32_t mtu) {
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :   CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     165 </span>            :   SetEncodingDataInternal(send_codec_type, max_bit_rate, target_bitrate,
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :                           width, height, frame_rate, divisor, num_layers, mtu);</span>
<span class="lineNum">     167 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     168 </span>            : 
<span class="lineNum">     169 </span><span class="lineNoCov">          0 : void MediaOptimization::SetEncodingDataInternal(VideoCodecType send_codec_type,</span>
<span class="lineNum">     170 </span>            :                                                 int32_t max_bit_rate,    // in bits/s
<span class="lineNum">     171 </span>            :                                                 uint32_t target_bitrate, // in bits/s
<span class="lineNum">     172 </span>            :                                                 uint16_t width,
<span class="lineNum">     173 </span>            :                                                 uint16_t height,
<span class="lineNum">     174 </span>            :                                                 uint32_t frame_rate,     // in fps*1000
<span class="lineNum">     175 </span>            :                                                 uint8_t  divisor,
<span class="lineNum">     176 </span>            :                                                 int num_layers,
<span class="lineNum">     177 </span>            :                                                 int32_t mtu) {
<span class="lineNum">     178 </span>            :   // Everything codec specific should be reset here since this means the codec
<span class="lineNum">     179 </span>            :   // has changed. If native dimension values have changed, then either user
<span class="lineNum">     180 </span>            :   // initiated change, or QM initiated change. Will be able to determine only
<span class="lineNum">     181 </span>            :   // after the processing of the first frame.
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :   last_change_time_ = clock_-&gt;TimeInMilliseconds();</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :   content_-&gt;Reset();</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :   content_-&gt;UpdateFrameRate(static_cast&lt;float&gt;(frame_rate) / 1000.0f);</span>
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :   max_bit_rate_ = max_bit_rate;</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :   send_codec_type_ = send_codec_type;</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :   video_target_bitrate_ = target_bitrate;</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :   float target_bitrate_kbps = static_cast&lt;float&gt;(target_bitrate) / 1000.0f;</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :   loss_prot_logic_-&gt;UpdateBitRate(target_bitrate_kbps);</span>
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :   loss_prot_logic_-&gt;UpdateFrameRate(static_cast&lt;float&gt;(frame_rate) / 1000.0f);</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :   loss_prot_logic_-&gt;UpdateFrameSize(width, height);</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :   loss_prot_logic_-&gt;UpdateNumLayers(num_layers);</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :   frame_dropper_-&gt;Reset();</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :   frame_dropper_-&gt;SetRates(target_bitrate_kbps, static_cast&lt;float&gt;(frame_rate) / 1000.0f);</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :   user_frame_rate_ = static_cast&lt;float&gt;(frame_rate)/1000.0f;</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :   codec_width_ = width;</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :   codec_height_ = height;</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :   int gcd = GreatestCommonDenominator(codec_width_, codec_height_);</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :   min_width_ = gcd ? (codec_width_/gcd * divisor) : 0;</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :   min_height_ = gcd ? (codec_height_/gcd * divisor) : 0;</span>
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :   num_layers_ = (num_layers &lt;= 1) ? 1 : num_layers;  // Can also be zero.</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :   max_payload_size_ = mtu;</span>
<span class="lineNum">     204 </span>            :   qm_resolution_-&gt;Initialize(target_bitrate_kbps, user_frame_rate_,
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :                              codec_width_, codec_height_, num_layers_);</span>
<a name="206"><span class="lineNum">     206 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     207 </span>            : 
<span class="lineNum">     208 </span><span class="lineNoCov">          0 : uint32_t MediaOptimization::SetTargetRates(</span>
<span class="lineNum">     209 </span>            :     uint32_t target_bitrate,
<span class="lineNum">     210 </span>            :     uint8_t fraction_lost,
<span class="lineNum">     211 </span>            :     int64_t round_trip_time_ms,
<span class="lineNum">     212 </span>            :     VCMProtectionCallback* protection_callback,
<span class="lineNum">     213 </span>            :     VCMQMSettingsCallback* qmsettings_callback) {
<span class="lineNum">     214 </span>            : 
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :   CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :   LOG(LS_INFO) &lt;&lt; &quot;SetTargetRates: &quot; &lt;&lt;  target_bitrate &lt;&lt; &quot; bps &quot; &lt;&lt; (int) fraction_lost</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :                &lt;&lt; &quot;% loss &quot; &lt;&lt; round_trip_time_ms &lt;&lt; &quot;ms RTT&quot;;</span>
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :   VCMProtectionMethod* selected_method = loss_prot_logic_-&gt;SelectedMethod();</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :   float target_bitrate_kbps = static_cast&lt;float&gt;(target_bitrate) / 1000.0f;</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :   loss_prot_logic_-&gt;UpdateBitRate(target_bitrate_kbps);</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :   loss_prot_logic_-&gt;UpdateRtt(round_trip_time_ms);</span>
<span class="lineNum">     223 </span>            : 
<span class="lineNum">     224 </span>            :   // Get frame rate for encoder: this is the actual/sent frame rate.
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :   float actual_frame_rate = SentFrameRateInternal();</span>
<span class="lineNum">     226 </span>            : 
<span class="lineNum">     227 </span>            :   // Sanity check.
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :   if (actual_frame_rate &lt; 1.0) {</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :     actual_frame_rate = 1.0;</span>
<span class="lineNum">     230 </span>            :   }
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span>            :   // Update frame rate for the loss protection logic class: frame rate should
<span class="lineNum">     233 </span>            :   // be the actual/sent rate.
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :   loss_prot_logic_-&gt;UpdateFrameRate(actual_frame_rate);</span>
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :   fraction_lost_ = fraction_lost;</span>
<span class="lineNum">     237 </span>            : 
<span class="lineNum">     238 </span>            :   // Returns the filtered packet loss, used for the protection setting.
<span class="lineNum">     239 </span>            :   // The filtered loss may be the received loss (no filter), or some
<span class="lineNum">     240 </span>            :   // filtered value (average or max window filter).
<span class="lineNum">     241 </span>            :   // Use max window filter for now.
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :   FilterPacketLossMode filter_mode = kMaxFilter;</span>
<span class="lineNum">     243 </span>            :   uint8_t packet_loss_enc = loss_prot_logic_-&gt;FilteredLoss(
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :       clock_-&gt;TimeInMilliseconds(), filter_mode, fraction_lost);</span>
<span class="lineNum">     245 </span>            : 
<span class="lineNum">     246 </span>            :   // For now use the filtered loss for computing the robustness settings.
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :   loss_prot_logic_-&gt;UpdateFilteredLossPr(packet_loss_enc);</span>
<span class="lineNum">     248 </span>            : 
<span class="lineNum">     249 </span>            :   // Rate cost of the protection methods.
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :   float protection_overhead_rate = 0.0f;</span>
<span class="lineNum">     251 </span>            : 
<span class="lineNum">     252 </span>            :   // Update protection settings, when applicable.
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :   float sent_video_rate_kbps = 0.0f;</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :   if (loss_prot_logic_-&gt;SelectedType() != kNone) {</span>
<span class="lineNum">     255 </span>            :     // Update protection method with content metrics.
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :     selected_method-&gt;UpdateContentMetrics(content_-&gt;ShortTermAvgData());</span>
<span class="lineNum">     257 </span>            : 
<span class="lineNum">     258 </span>            :     // Update method will compute the robustness settings for the given
<span class="lineNum">     259 </span>            :     // protection method and the overhead cost
<span class="lineNum">     260 </span>            :     // the protection method is set by the user via SetVideoProtection.
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :     loss_prot_logic_-&gt;UpdateMethod();</span>
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span>            :     // Update protection callback with protection settings.
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :     uint32_t sent_video_rate_bps = 0;</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :     uint32_t sent_nack_rate_bps = 0;</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :     uint32_t sent_fec_rate_bps = 0;</span>
<span class="lineNum">     267 </span>            :     // Get the bit cost of protection method, based on the amount of
<span class="lineNum">     268 </span>            :     // overhead data actually transmitted (including headers) the last
<span class="lineNum">     269 </span>            :     // second.
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :     if (protection_callback) {</span>
<span class="lineNum">     271 </span>            :       UpdateProtectionCallback(selected_method, &amp;sent_video_rate_bps,
<span class="lineNum">     272 </span>            :                                &amp;sent_nack_rate_bps, &amp;sent_fec_rate_bps,
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :                                protection_callback);</span>
<span class="lineNum">     274 </span>            :     }
<span class="lineNum">     275 </span>            :     uint32_t sent_total_rate_bps =
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :         sent_video_rate_bps + sent_nack_rate_bps + sent_fec_rate_bps;</span>
<span class="lineNum">     277 </span>            :     // Estimate the overhead costs of the next second as staying the same
<span class="lineNum">     278 </span>            :     // wrt the source bitrate.
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :     if (sent_total_rate_bps &gt; 0) {</span>
<span class="lineNum">     280 </span>            :       protection_overhead_rate =
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :           static_cast&lt;float&gt;(sent_nack_rate_bps + sent_fec_rate_bps) /</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :           sent_total_rate_bps;</span>
<span class="lineNum">     283 </span>            :     }
<span class="lineNum">     284 </span>            :     // Cap the overhead estimate to 50%.
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :     if (protection_overhead_rate &gt; 0.5)</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :       protection_overhead_rate = 0.5;</span>
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span>            :     // Get the effective packet loss for encoder ER when applicable. Should be
<span class="lineNum">     289 </span>            :     // passed to encoder via fraction_lost.
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :     packet_loss_enc = selected_method-&gt;RequiredPacketLossER();</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :     sent_video_rate_kbps = static_cast&lt;float&gt;(sent_video_rate_bps) / 1000.0f;</span>
<span class="lineNum">     292 </span>            :   }
<span class="lineNum">     293 </span>            : 
<span class="lineNum">     294 </span>            :   // Source coding rate: total rate - protection overhead.
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :   video_target_bitrate_ = target_bitrate * (1.0 - protection_overhead_rate);</span>
<span class="lineNum">     296 </span>            : 
<span class="lineNum">     297 </span>            :   // Cap target video bitrate to codec maximum.
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :   if (max_bit_rate_ &gt; 0 &amp;&amp; video_target_bitrate_ &gt; max_bit_rate_) {</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :     video_target_bitrate_ = max_bit_rate_;</span>
<span class="lineNum">     300 </span>            :   }
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span>            :   // Update encoding rates following protection settings.
<span class="lineNum">     303 </span>            :   float target_video_bitrate_kbps =
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :       static_cast&lt;float&gt;(video_target_bitrate_) / 1000.0f;</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :   frame_dropper_-&gt;SetRates(target_video_bitrate_kbps, incoming_frame_rate_);</span>
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :   if (enable_qm_ &amp;&amp; qmsettings_callback) {</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :   LOG(LS_INFO) &lt;&lt; &quot;SetTargetRates/enable_qm: &quot; &lt;&lt;  target_video_bitrate_kbps</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :                &lt;&lt; &quot; bps, &quot; &lt;&lt; sent_video_rate_kbps &lt;&lt; &quot; kbps, &quot; &lt;&lt; incoming_frame_rate_</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :                &lt;&lt; &quot; fps, &quot; &lt;&lt; fraction_lost &lt;&lt; &quot; loss&quot;;</span>
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span>            :     // Update QM with rates.
<span class="lineNum">     313 </span>            :     qm_resolution_-&gt;UpdateRates(target_video_bitrate_kbps, sent_video_rate_kbps,
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :                                 incoming_frame_rate_, fraction_lost_);</span>
<span class="lineNum">     315 </span>            :     // Check for QM selection.
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :     bool select_qm = CheckStatusForQMchange();</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :     if (select_qm) {</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :       SelectQuality(qmsettings_callback);</span>
<span class="lineNum">     319 </span>            :     }
<span class="lineNum">     320 </span>            :     // Reset the short-term averaged content data.
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :     content_-&gt;ResetShortTermAvgData();</span>
<span class="lineNum">     322 </span>            :   }
<span class="lineNum">     323 </span>            : 
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :   CheckSuspendConditions();</span>
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :   return video_target_bitrate_;</span>
<a name="327"><span class="lineNum">     327 </span>            : }</a>
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span><span class="lineNoCov">          0 : void MediaOptimization::SetProtectionMethod(VCMProtectionMethodEnum method) {</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :   CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :   loss_prot_logic_-&gt;SetMethod(method);</span>
<a name="332"><span class="lineNum">     332 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     333 </span>            : 
<span class="lineNum">     334 </span><span class="lineNoCov">          0 : uint32_t MediaOptimization::InputFrameRate() {</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :   CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :   return InputFrameRateInternal();</span>
<a name="337"><span class="lineNum">     337 </span>            : }</a>
<span class="lineNum">     338 </span>            : 
<span class="lineNum">     339 </span><span class="lineNoCov">          0 : uint32_t MediaOptimization::InputFrameRateInternal() {</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :   ProcessIncomingFrameRate(clock_-&gt;TimeInMilliseconds());</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :   return uint32_t(incoming_frame_rate_ + 0.5f);</span>
<a name="342"><span class="lineNum">     342 </span>            : }</a>
<span class="lineNum">     343 </span>            : 
<span class="lineNum">     344 </span><span class="lineNoCov">          0 : uint32_t MediaOptimization::SentFrameRate() {</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :   CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :   return SentFrameRateInternal();</span>
<a name="347"><span class="lineNum">     347 </span>            : }</a>
<span class="lineNum">     348 </span>            : 
<span class="lineNum">     349 </span><span class="lineNoCov">          0 : uint32_t MediaOptimization::SentFrameRateInternal() {</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :   PurgeOldFrameSamples(clock_-&gt;TimeInMilliseconds());</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :   UpdateSentFramerate();</span>
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :   return avg_sent_framerate_;</span>
<a name="353"><span class="lineNum">     353 </span>            : }</a>
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span><span class="lineNoCov">          0 : uint32_t MediaOptimization::SentBitRate() {</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :   CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :   const int64_t now_ms = clock_-&gt;TimeInMilliseconds();</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :   PurgeOldFrameSamples(now_ms);</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :   UpdateSentBitrate(now_ms);</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :   return avg_sent_bit_rate_bps_;</span>
<span class="lineNum">     361 </span>            : }
<span class="lineNum">     362 </span>            : 
<span class="lineNum">     363 </span><span class="lineNoCov">          0 : int32_t MediaOptimization::UpdateWithEncodedData(</span>
<span class="lineNum">     364 </span>            :     const EncodedImage&amp; encoded_image) {
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :   size_t encoded_length = encoded_image._length;</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :   uint32_t timestamp = encoded_image._timeStamp;</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :   CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :   const int64_t now_ms = clock_-&gt;TimeInMilliseconds();</span>
<span class="lineNum">     369 </span>            :   bool same_frame;
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :   PurgeOldFrameSamples(now_ms);</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :   if (encoded_frame_samples_.size() &gt; 0 &amp;&amp;</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :       encoded_frame_samples_.back().timestamp == timestamp) {</span>
<span class="lineNum">     373 </span>            :     // Frames having the same timestamp are generated from the same input
<span class="lineNum">     374 </span>            :     // frame. We don't want to double count them, but only increment the
<span class="lineNum">     375 </span>            :     // size_bytes.
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :     encoded_frame_samples_.back().size_bytes += encoded_length;</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :     encoded_frame_samples_.back().time_complete_ms = now_ms;</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :     same_frame = true;</span>
<span class="lineNum">     379 </span>            :   } else {
<span class="lineNum">     380 </span>            :     encoded_frame_samples_.push_back(
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :         EncodedFrameSample(encoded_length, timestamp, now_ms));</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :     same_frame = false;</span>
<span class="lineNum">     383 </span>            :   }
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :   UpdateSentBitrate(now_ms);</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :   UpdateSentFramerate();</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :   if (encoded_length &gt; 0) {</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :     const bool delta_frame = encoded_image._frameType != kVideoFrameKey;</span>
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span>            :     // XXX TODO(jesup): if same_frame is true, we should be considering it a single
<span class="lineNum">     390 </span>            :     // frame here.
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     frame_dropper_-&gt;Fill(encoded_length, delta_frame);</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :     if (max_payload_size_ &gt; 0 &amp;&amp; encoded_length &gt; 0) {</span>
<span class="lineNum">     393 </span>            :       const float min_packets_per_frame =
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :           encoded_length / static_cast&lt;float&gt;(max_payload_size_);</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :       if (delta_frame) {</span>
<span class="lineNum">     396 </span>            :         loss_prot_logic_-&gt;UpdatePacketsPerFrame(min_packets_per_frame,
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :                                                 clock_-&gt;TimeInMilliseconds());</span>
<span class="lineNum">     398 </span>            :       } else {
<span class="lineNum">     399 </span>            :         loss_prot_logic_-&gt;UpdatePacketsPerFrameKey(
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :             min_packets_per_frame, clock_-&gt;TimeInMilliseconds());</span>
<span class="lineNum">     401 </span>            :       }
<span class="lineNum">     402 </span>            : 
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :       if (enable_qm_) {</span>
<span class="lineNum">     404 </span>            :         // Update quality select with encoded length.
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :         qm_resolution_-&gt;UpdateEncodedSize(encoded_length);</span>
<span class="lineNum">     406 </span>            :       }
<span class="lineNum">     407 </span>            :     }
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :     if (!delta_frame &amp;&amp; encoded_length &gt; 0) {</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :       loss_prot_logic_-&gt;UpdateKeyFrameSize(static_cast&lt;float&gt;(encoded_length));</span>
<span class="lineNum">     410 </span>            :     }
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span>            :     // Updating counters.
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :     if (!same_frame) {</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :       if (delta_frame) {</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :         delta_frame_cnt_++;</span>
<span class="lineNum">     416 </span>            :       } else {
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :         key_frame_cnt_++;</span>
<span class="lineNum">     418 </span>            :       }
<span class="lineNum">     419 </span>            :     }
<span class="lineNum">     420 </span>            :   }
<span class="lineNum">     421 </span>            : 
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :   return VCM_OK;</span>
<a name="423"><span class="lineNum">     423 </span>            : }</a>
<span class="lineNum">     424 </span>            : 
<span class="lineNum">     425 </span><span class="lineNoCov">          0 : void MediaOptimization::EnableQM(bool enable) {</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :   CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :   enable_qm_ = enable;</span>
<a name="428"><span class="lineNum">     428 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     429 </span>            : 
<span class="lineNum">     430 </span><span class="lineNoCov">          0 : void MediaOptimization::EnableFrameDropper(bool enable) {</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :   CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :   frame_dropper_-&gt;Enable(enable);</span>
<a name="433"><span class="lineNum">     433 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span><span class="lineNoCov">          0 : void MediaOptimization::SuspendBelowMinBitrate(int threshold_bps,</span>
<span class="lineNum">     436 </span>            :                                                int window_bps) {
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :   CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     438 </span>            :   assert(threshold_bps &gt; 0 &amp;&amp; window_bps &gt;= 0);
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :   suspension_threshold_bps_ = threshold_bps;</span>
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :   suspension_window_bps_ = window_bps;</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :   suspension_enabled_ = true;</span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :   video_suspended_ = false;</span>
<a name="443"><span class="lineNum">     443 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span><span class="lineNoCov">          0 : bool MediaOptimization::IsVideoSuspended() const {</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :   CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :   return video_suspended_;</span>
<a name="448"><span class="lineNum">     448 </span>            : }</a>
<span class="lineNum">     449 </span>            : 
<span class="lineNum">     450 </span><span class="lineNoCov">          0 : bool MediaOptimization::DropFrame() {</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :   CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :   UpdateIncomingFrameRate();</span>
<span class="lineNum">     453 </span>            :   // Leak appropriate number of bytes.
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :   frame_dropper_-&gt;Leak((uint32_t)(InputFrameRateInternal() + 0.5f));</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :   if (video_suspended_) {</span>
<span class="lineNum">     456 </span>            :     return true;  // Drop all frames when muted.
<span class="lineNum">     457 </span>            :   }
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :   return frame_dropper_-&gt;DropFrame();</span>
<a name="459"><span class="lineNum">     459 </span>            : }</a>
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span><span class="lineNoCov">          0 : void MediaOptimization::UpdateContentData(</span>
<span class="lineNum">     462 </span>            :     const VideoContentMetrics* content_metrics) {
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :   CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     464 </span>            :   // Updating content metrics.
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :   if (content_metrics == NULL) {</span>
<span class="lineNum">     466 </span>            :     // Disable QM if metrics are NULL.
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :     enable_qm_ = false;</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :     qm_resolution_-&gt;Reset();</span>
<span class="lineNum">     469 </span>            :   } else {
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :     content_-&gt;UpdateContentData(content_metrics);</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :   }</span>
<a name="472"><span class="lineNum">     472 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span><span class="lineNoCov">          0 : void MediaOptimization::UpdateIncomingFrameRate() {</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :   int64_t now = clock_-&gt;TimeInMilliseconds();</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :   if (incoming_frame_times_[0] == 0) {</span>
<span class="lineNum">     477 </span>            :     // No shifting if this is the first time.
<span class="lineNum">     478 </span>            :   } else {
<span class="lineNum">     479 </span>            :     // Shift all times one step.
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :     for (int32_t i = (kFrameCountHistorySize - 2); i &gt;= 0; i--) {</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :       incoming_frame_times_[i + 1] = incoming_frame_times_[i];</span>
<span class="lineNum">     482 </span>            :     }
<span class="lineNum">     483 </span>            :   }
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :   incoming_frame_times_[0] = now;</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :   ProcessIncomingFrameRate(now);</span>
<a name="486"><span class="lineNum">     486 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     487 </span>            : 
<span class="lineNum">     488 </span><span class="lineNoCov">          0 : int32_t MediaOptimization::SelectQuality(</span>
<span class="lineNum">     489 </span>            :     VCMQMSettingsCallback* video_qmsettings_callback) {
<span class="lineNum">     490 </span>            :   // Reset quantities for QM select.
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :   qm_resolution_-&gt;ResetQM();</span>
<span class="lineNum">     492 </span>            : 
<span class="lineNum">     493 </span>            :   // Update QM will long-term averaged content metrics.
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :   qm_resolution_-&gt;UpdateContent(content_-&gt;LongTermAvgData());</span>
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span>            :   // Update QM with current CPU load
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :   qm_resolution_-&gt;SetCPULoadState(loadstate_);</span>
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span>            :   // Select quality mode.
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :   VCMResolutionScale* qm = NULL;</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :   int32_t ret = qm_resolution_-&gt;SelectResolution(&amp;qm);</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :   if (ret &lt; 0) {</span>
<span class="lineNum">     503 </span>            :     return ret;
<span class="lineNum">     504 </span>            :   }
<span class="lineNum">     505 </span>            : 
<span class="lineNum">     506 </span>            :   // Check for updates to spatial/temporal modes.
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :   QMUpdate(qm, video_qmsettings_callback);</span>
<span class="lineNum">     508 </span>            : 
<span class="lineNum">     509 </span>            :   // Reset all the rate and related frame counters quantities.
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :   qm_resolution_-&gt;ResetRates();</span>
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span>            :   // Reset counters.
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :   last_qm_update_time_ = clock_-&gt;TimeInMilliseconds();</span>
<span class="lineNum">     514 </span>            : 
<span class="lineNum">     515 </span>            :   // Reset content metrics.
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :   content_-&gt;Reset();</span>
<span class="lineNum">     517 </span>            : 
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :   return VCM_OK;</span>
<a name="519"><span class="lineNum">     519 </span>            : }</a>
<span class="lineNum">     520 </span>            : 
<span class="lineNum">     521 </span><span class="lineNoCov">          0 : void MediaOptimization::PurgeOldFrameSamples(int64_t now_ms) {</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :   while (!encoded_frame_samples_.empty()) {</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :     if (now_ms - encoded_frame_samples_.front().time_complete_ms &gt;</span>
<span class="lineNum">     524 </span>            :         kBitrateAverageWinMs) {
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :       encoded_frame_samples_.pop_front();</span>
<span class="lineNum">     526 </span>            :     } else {
<span class="lineNum">     527 </span>            :       break;
<span class="lineNum">     528 </span>            :     }
<span class="lineNum">     529 </span>            :   }
<a name="530"><span class="lineNum">     530 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     531 </span>            : 
<span class="lineNum">     532 </span><span class="lineNoCov">          0 : void MediaOptimization::UpdateSentBitrate(int64_t now_ms) {</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :   if (encoded_frame_samples_.empty()) {</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :     avg_sent_bit_rate_bps_ = 0;</span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     536 </span>            :   }
<span class="lineNum">     537 </span>            :   size_t framesize_sum = 0;
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :   for (FrameSampleList::iterator it = encoded_frame_samples_.begin();</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :        it != encoded_frame_samples_.end(); ++it) {</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :     framesize_sum += it-&gt;size_bytes;</span>
<span class="lineNum">     541 </span>            :   }
<span class="lineNum">     542 </span>            :   float denom = static_cast&lt;float&gt;(
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :       now_ms - encoded_frame_samples_.front().time_complete_ms);</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :   if (denom &gt;= 1.0f) {</span>
<span class="lineNum">     545 </span>            :     avg_sent_bit_rate_bps_ =
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :         static_cast&lt;uint32_t&gt;(framesize_sum * 8.0f * 1000.0f / denom + 0.5f);</span>
<span class="lineNum">     547 </span>            :   } else {
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :     avg_sent_bit_rate_bps_ = framesize_sum * 8;</span>
<span class="lineNum">     549 </span>            :   }
<a name="550"><span class="lineNum">     550 </span>            : }</a>
<span class="lineNum">     551 </span>            : 
<span class="lineNum">     552 </span><span class="lineNoCov">          0 : void MediaOptimization::UpdateSentFramerate() {</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :   if (encoded_frame_samples_.size() &lt;= 1) {</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :     avg_sent_framerate_ = encoded_frame_samples_.size();</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     556 </span>            :   }
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :   int denom = encoded_frame_samples_.back().timestamp -</span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :               encoded_frame_samples_.front().timestamp;</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :   if (denom &gt; 0) {</span>
<span class="lineNum">     560 </span>            :     avg_sent_framerate_ =
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :         (90000 * (encoded_frame_samples_.size() - 1) + denom / 2) / denom;</span>
<span class="lineNum">     562 </span>            :   } else {
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :     avg_sent_framerate_ = encoded_frame_samples_.size();</span>
<span class="lineNum">     564 </span>            :   }
<a name="565"><span class="lineNum">     565 </span>            : }</a>
<span class="lineNum">     566 </span>            : 
<span class="lineNum">     567 </span><span class="lineNoCov">          0 : bool MediaOptimization::QMUpdate(</span>
<span class="lineNum">     568 </span>            :     VCMResolutionScale* qm,
<span class="lineNum">     569 </span>            :     VCMQMSettingsCallback* video_qmsettings_callback) {
<span class="lineNum">     570 </span>            :   // Check for no change.
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :   if (!qm-&gt;change_resolution_spatial &amp;&amp; !qm-&gt;change_resolution_temporal) {</span>
<span class="lineNum">     572 </span>            :     return false;
<span class="lineNum">     573 </span>            :   }
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span>            :   // Check for change in frame rate.
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :   if (qm-&gt;change_resolution_temporal) {</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :     incoming_frame_rate_ = qm-&gt;frame_rate;</span>
<span class="lineNum">     578 </span>            :     // Reset frame rate estimate.
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :     memset(incoming_frame_times_, -1, sizeof(incoming_frame_times_));</span>
<span class="lineNum">     580 </span>            :   }
<span class="lineNum">     581 </span>            : 
<span class="lineNum">     582 </span>            :   // Check for change in frame size.
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :   if (qm-&gt;change_resolution_spatial) {</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :     codec_width_ = qm-&gt;codec_width;</span>
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :     codec_height_ = qm-&gt;codec_height;</span>
<span class="lineNum">     586 </span>            :   }
<span class="lineNum">     587 </span>            :   // handle codec limitations on input resolutions
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :   if (codec_width_ % min_width_ != 0 || codec_height_ % min_height_ != 0) {</span>
<span class="lineNum">     589 </span>            :     // XXX find a better algorithm for selecting sizes
<span class="lineNum">     590 </span>            :     // This uses the GCD to find options that meet alignment requirements
<span class="lineNum">     591 </span>            :     // (divisor) and at the same time retain the aspect ratio exactly.
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :     codec_width_ = ((codec_width_ + min_width_-1)/min_width_)*min_width_;</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :     codec_height_ = ((codec_height_ + min_height_-1)/min_height_)*min_height_;</span>
<span class="lineNum">     594 </span>            : 
<span class="lineNum">     595 </span>            :     // to avoid confusion later
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :     qm-&gt;codec_width = codec_width_;</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :    qm-&gt;codec_height = codec_height_;</span>
<span class="lineNum">     598 </span>            :   }
<span class="lineNum">     599 </span>            : 
<span class="lineNum">     600 </span>            : 
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :   LOG(LS_INFO) &lt;&lt; &quot;Media optimizer requests the video resolution to be changed &quot;</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :               &quot;to &quot; &lt;&lt; qm-&gt;codec_width &lt;&lt; &quot; (&quot; &lt;&lt; codec_width_ &lt;&lt; &quot;) x &quot;</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :                &lt;&lt; qm-&gt;codec_height &lt;&lt; &quot; (&quot; &lt;&lt; codec_height_ &lt;&lt; &quot;) @ &quot;</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :                &lt;&lt; qm-&gt;frame_rate;</span>
<span class="lineNum">     605 </span>            : 
<span class="lineNum">     606 </span>            :   // Update VPM with new target frame rate and frame size.
<span class="lineNum">     607 </span>            :   // Note: use |qm-&gt;frame_rate| instead of |_incoming_frame_rate| for updating
<span class="lineNum">     608 </span>            :   // target frame rate in VPM frame dropper. The quantity |_incoming_frame_rate|
<span class="lineNum">     609 </span>            :   // will vary/fluctuate, and since we don't want to change the state of the
<span class="lineNum">     610 </span>            :   // VPM frame dropper, unless a temporal action was selected, we use the
<span class="lineNum">     611 </span>            :   // quantity |qm-&gt;frame_rate| for updating.
<span class="lineNum">     612 </span>            :   video_qmsettings_callback-&gt;SetVideoQMSettings(qm-&gt;frame_rate, codec_width_,
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :                                                 codec_height_);</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :   content_-&gt;UpdateFrameRate(qm-&gt;frame_rate);</span>
<span class="lineNum">     615 </span>            :   qm_resolution_-&gt;UpdateCodecParameters(qm-&gt;frame_rate, codec_width_,
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :                                         codec_height_);</span>
<span class="lineNum">     617 </span><span class="lineNoCov">          0 :   return true;</span>
<span class="lineNum">     618 </span>            : }
<span class="lineNum">     619 </span>            : 
<span class="lineNum">     620 </span>            : // Check timing constraints and look for significant change in:
<a name="621"><span class="lineNum">     621 </span>            : // (1) scene content,</a>
<span class="lineNum">     622 </span>            : // (2) target bit rate.
<span class="lineNum">     623 </span><span class="lineNoCov">          0 : bool MediaOptimization::CheckStatusForQMchange() {</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :   bool status = true;</span>
<span class="lineNum">     625 </span>            : 
<span class="lineNum">     626 </span>            :   // Check that we do not call QMSelect too often, and that we waited some time
<span class="lineNum">     627 </span>            :   // (to sample the metrics) from the event last_change_time
<span class="lineNum">     628 </span>            :   // last_change_time is the time where user changed the size/rate/frame rate
<span class="lineNum">     629 </span>            :   // (via SetEncodingData).
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :   int64_t now = clock_-&gt;TimeInMilliseconds();</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :   if ((now - last_qm_update_time_) &lt; kQmMinIntervalMs ||</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :       (now - last_change_time_) &lt; kQmMinIntervalMs) {</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :     status = false;</span>
<span class="lineNum">     634 </span>            :   }
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :   return status;</span>
<span class="lineNum">     637 </span>            : }
<a name="638"><span class="lineNum">     638 </span>            : </a>
<span class="lineNum">     639 </span>            : // Allowing VCM to keep track of incoming frame rate.
<span class="lineNum">     640 </span><span class="lineNoCov">          0 : void MediaOptimization::ProcessIncomingFrameRate(int64_t now) {</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :   int32_t num = 0;</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :   int32_t nr_of_frames = 0;</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :   for (num = 1; num &lt; (kFrameCountHistorySize - 1); ++num) {</span>
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :     if (incoming_frame_times_[num] &lt;= 0 ||</span>
<span class="lineNum">     645 </span>            :         // don't use data older than 2 s
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :         now - incoming_frame_times_[num] &gt; kFrameHistoryWinMs) {</span>
<span class="lineNum">     647 </span>            :       break;
<span class="lineNum">     648 </span>            :     } else {
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :       nr_of_frames++;</span>
<span class="lineNum">     650 </span>            :     }
<span class="lineNum">     651 </span>            :   }
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :   if (num &gt; 1) {</span>
<span class="lineNum">     653 </span>            :     const int64_t diff =
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :         incoming_frame_times_[0] - incoming_frame_times_[num - 1];</span>
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :     incoming_frame_rate_ = 0.0;  // No frame rate estimate available.</span>
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :     if (diff &gt; 0) {</span>
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :       incoming_frame_rate_ = nr_of_frames * 1000.0f / static_cast&lt;float&gt;(diff);</span>
<span class="lineNum">     658 </span>            :     }
<span class="lineNum">     659 </span>            :   }
<a name="660"><span class="lineNum">     660 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     661 </span>            : 
<span class="lineNum">     662 </span><span class="lineNoCov">          0 : void MediaOptimization::SetCPULoadState(CPULoadState state) {</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :     CriticalSectionScoped lock(crit_sect_.get());</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :     loadstate_ = state;</span>
<a name="665"><span class="lineNum">     665 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     666 </span>            : 
<span class="lineNum">     667 </span><span class="lineNoCov">          0 : void MediaOptimization::CheckSuspendConditions() {</span>
<span class="lineNum">     668 </span>            :   // Check conditions for SuspendBelowMinBitrate. |video_target_bitrate_| is in
<span class="lineNum">     669 </span>            :   // bps.
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :   if (suspension_enabled_) {</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :     if (!video_suspended_) {</span>
<span class="lineNum">     672 </span>            :       // Check if we just went below the threshold.
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :       if (video_target_bitrate_ &lt; suspension_threshold_bps_) {</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :         video_suspended_ = true;</span>
<span class="lineNum">     675 </span>            :       }
<span class="lineNum">     676 </span>            :     } else {
<span class="lineNum">     677 </span>            :       // Video is already suspended. Check if we just went over the threshold
<span class="lineNum">     678 </span>            :       // with a margin.
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :       if (video_target_bitrate_ &gt;</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :           suspension_threshold_bps_ + suspension_window_bps_) {</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :         video_suspended_ = false;</span>
<span class="lineNum">     682 </span>            :       }
<span class="lineNum">     683 </span>            :     }
<span class="lineNum">     684 </span>            :   }
<span class="lineNum">     685 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     686 </span>            : 
<span class="lineNum">     687 </span>            : }  // namespace media_optimization
<span class="lineNum">     688 </span>            : }  // namespace webrtc
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
