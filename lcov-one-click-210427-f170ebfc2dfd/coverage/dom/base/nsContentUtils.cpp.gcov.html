<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mochitest-e10s.info - dom/base/nsContentUtils.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">dom/base</a> - nsContentUtils.cpp<span style="font-size: 80%;"> (source / <a href="nsContentUtils.cpp.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mochitest-e10s.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">251</td>
            <td class="headerCovTableEntry">3592</td>
            <td class="headerCovTableEntryLo">7.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">37</td>
            <td class="headerCovTableEntry">407</td>
            <td class="headerCovTableEntryLo">9.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* vim: set ts=8 sts=2 et sw=2 tw=80: */
<span class="lineNum">       3 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       4 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       5 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            : /* A namespace class for static layout utilities. */
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : #include &quot;nsContentUtils.h&quot;
<span class="lineNum">      10 </span>            : 
<span class="lineNum">      11 </span>            : #include &lt;algorithm&gt;
<span class="lineNum">      12 </span>            : #include &lt;math.h&gt;
<span class="lineNum">      13 </span>            : 
<span class="lineNum">      14 </span>            : #include &quot;DecoderTraits.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;harfbuzz/hb.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;imgICache.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;imgIContainer.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;imgINotificationObserver.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;imgLoader.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;imgRequestProxy.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;jsapi.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;jsfriendapi.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;js/Value.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;Layers.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;MediaDecoder.h&quot;
<span class="lineNum">      26 </span>            : // nsNPAPIPluginInstance must be included before nsIDocument.h, which is included in mozAutoDocUpdate.h.
<span class="lineNum">      27 </span>            : #include &quot;nsNPAPIPluginInstance.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;gfxDrawable.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;gfxPrefs.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;ImageOps.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;mozAutoDocUpdate.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;mozilla/ArrayUtils.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;mozilla/Attributes.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;mozilla/AutoRestore.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;mozilla/AutoTimelineMarker.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;mozilla/Base64.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;mozilla/CheckedInt.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;mozilla/DebugOnly.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;mozilla/LoadInfo.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;mozilla/dom/ContentChild.h&quot;
<span class="lineNum">      41 </span>            : #include &quot;mozilla/dom/CustomElementRegistry.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;mozilla/dom/DocumentFragment.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;mozilla/dom/DOMTypes.h&quot;
<span class="lineNum">      44 </span>            : #include &quot;mozilla/dom/Element.h&quot;
<span class="lineNum">      45 </span>            : #include &quot;mozilla/dom/FileSystemSecurity.h&quot;
<span class="lineNum">      46 </span>            : #include &quot;mozilla/dom/FileBlobImpl.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;mozilla/dom/HTMLInputElement.h&quot;
<span class="lineNum">      48 </span>            : #include &quot;mozilla/dom/HTMLMediaElement.h&quot;
<span class="lineNum">      49 </span>            : #include &quot;mozilla/dom/HTMLTemplateElement.h&quot;
<span class="lineNum">      50 </span>            : #include &quot;mozilla/dom/HTMLContentElement.h&quot;
<span class="lineNum">      51 </span>            : #include &quot;mozilla/dom/HTMLShadowElement.h&quot;
<span class="lineNum">      52 </span>            : #include &quot;mozilla/dom/ipc/BlobChild.h&quot;
<span class="lineNum">      53 </span>            : #include &quot;mozilla/dom/ipc/BlobParent.h&quot;
<span class="lineNum">      54 </span>            : #include &quot;mozilla/dom/Promise.h&quot;
<span class="lineNum">      55 </span>            : #include &quot;mozilla/dom/ScriptSettings.h&quot;
<span class="lineNum">      56 </span>            : #include &quot;mozilla/dom/TabParent.h&quot;
<span class="lineNum">      57 </span>            : #include &quot;mozilla/dom/TextDecoder.h&quot;
<span class="lineNum">      58 </span>            : #include &quot;mozilla/dom/TouchEvent.h&quot;
<span class="lineNum">      59 </span>            : #include &quot;mozilla/dom/ShadowRoot.h&quot;
<span class="lineNum">      60 </span>            : #include &quot;mozilla/dom/WorkerPrivate.h&quot;
<span class="lineNum">      61 </span>            : #include &quot;mozilla/dom/workers/ServiceWorkerManager.h&quot;
<span class="lineNum">      62 </span>            : #include &quot;mozilla/EventDispatcher.h&quot;
<span class="lineNum">      63 </span>            : #include &quot;mozilla/EventListenerManager.h&quot;
<span class="lineNum">      64 </span>            : #include &quot;mozilla/EventStateManager.h&quot;
<span class="lineNum">      65 </span>            : #include &quot;mozilla/gfx/DataSurfaceHelpers.h&quot;
<span class="lineNum">      66 </span>            : #include &quot;mozilla/IMEStateManager.h&quot;
<span class="lineNum">      67 </span>            : #include &quot;mozilla/InternalMutationEvent.h&quot;
<span class="lineNum">      68 </span>            : #include &quot;mozilla/Likely.h&quot;
<span class="lineNum">      69 </span>            : #include &quot;mozilla/MouseEvents.h&quot;
<span class="lineNum">      70 </span>            : #include &quot;mozilla/Preferences.h&quot;
<span class="lineNum">      71 </span>            : #include &quot;mozilla/dom/Selection.h&quot;
<span class="lineNum">      72 </span>            : #include &quot;mozilla/TextEvents.h&quot;
<span class="lineNum">      73 </span>            : #include &quot;nsArrayUtils.h&quot;
<span class="lineNum">      74 </span>            : #include &quot;nsAString.h&quot;
<span class="lineNum">      75 </span>            : #include &quot;nsAttrName.h&quot;
<span class="lineNum">      76 </span>            : #include &quot;nsAttrValue.h&quot;
<span class="lineNum">      77 </span>            : #include &quot;nsAttrValueInlines.h&quot;
<span class="lineNum">      78 </span>            : #include &quot;nsBindingManager.h&quot;
<span class="lineNum">      79 </span>            : #include &quot;nsCaret.h&quot;
<span class="lineNum">      80 </span>            : #include &quot;nsCCUncollectableMarker.h&quot;
<span class="lineNum">      81 </span>            : #include &quot;nsCharSeparatedTokenizer.h&quot;
<span class="lineNum">      82 </span>            : #include &quot;nsCOMPtr.h&quot;
<span class="lineNum">      83 </span>            : #include &quot;nsContentCreatorFunctions.h&quot;
<span class="lineNum">      84 </span>            : #include &quot;nsContentDLF.h&quot;
<span class="lineNum">      85 </span>            : #include &quot;nsContentList.h&quot;
<span class="lineNum">      86 </span>            : #include &quot;nsContentPolicyUtils.h&quot;
<span class="lineNum">      87 </span>            : #include &quot;nsContentSecurityManager.h&quot;
<span class="lineNum">      88 </span>            : #include &quot;nsCPrefetchService.h&quot;
<span class="lineNum">      89 </span>            : #include &quot;nsCRT.h&quot;
<span class="lineNum">      90 </span>            : #include &quot;nsCycleCollectionParticipant.h&quot;
<span class="lineNum">      91 </span>            : #include &quot;nsCycleCollector.h&quot;
<span class="lineNum">      92 </span>            : #include &quot;nsDataHashtable.h&quot;
<span class="lineNum">      93 </span>            : #include &quot;nsDocShellCID.h&quot;
<span class="lineNum">      94 </span>            : #include &quot;nsDocument.h&quot;
<span class="lineNum">      95 </span>            : #include &quot;nsDOMCID.h&quot;
<span class="lineNum">      96 </span>            : #include &quot;mozilla/dom/DataTransfer.h&quot;
<span class="lineNum">      97 </span>            : #include &quot;nsDOMJSUtils.h&quot;
<span class="lineNum">      98 </span>            : #include &quot;nsDOMMutationObserver.h&quot;
<span class="lineNum">      99 </span>            : #include &quot;nsError.h&quot;
<span class="lineNum">     100 </span>            : #include &quot;nsFocusManager.h&quot;
<span class="lineNum">     101 </span>            : #include &quot;nsGenericHTMLElement.h&quot;
<span class="lineNum">     102 </span>            : #include &quot;nsGenericHTMLFrameElement.h&quot;
<span class="lineNum">     103 </span>            : #include &quot;nsGkAtoms.h&quot;
<span class="lineNum">     104 </span>            : #include &quot;nsHostObjectProtocolHandler.h&quot;
<span class="lineNum">     105 </span>            : #include &quot;nsHtml5Module.h&quot;
<span class="lineNum">     106 </span>            : #include &quot;nsHtml5StringParser.h&quot;
<span class="lineNum">     107 </span>            : #include &quot;nsIAddonPolicyService.h&quot;
<span class="lineNum">     108 </span>            : #include &quot;nsIAnonymousContentCreator.h&quot;
<span class="lineNum">     109 </span>            : #include &quot;nsIAsyncVerifyRedirectCallback.h&quot;
<span class="lineNum">     110 </span>            : #include &quot;nsICategoryManager.h&quot;
<span class="lineNum">     111 </span>            : #include &quot;nsIChannelEventSink.h&quot;
<span class="lineNum">     112 </span>            : #include &quot;nsICharsetDetectionObserver.h&quot;
<span class="lineNum">     113 </span>            : #include &quot;nsIChromeRegistry.h&quot;
<span class="lineNum">     114 </span>            : #include &quot;nsIConsoleService.h&quot;
<span class="lineNum">     115 </span>            : #include &quot;nsIContent.h&quot;
<span class="lineNum">     116 </span>            : #include &quot;nsIContentInlines.h&quot;
<span class="lineNum">     117 </span>            : #include &quot;nsIContentSecurityPolicy.h&quot;
<span class="lineNum">     118 </span>            : #include &quot;nsIContentSink.h&quot;
<span class="lineNum">     119 </span>            : #include &quot;nsIContentViewer.h&quot;
<span class="lineNum">     120 </span>            : #include &quot;nsIDocShell.h&quot;
<span class="lineNum">     121 </span>            : #include &quot;nsIDocShellTreeOwner.h&quot;
<span class="lineNum">     122 </span>            : #include &quot;nsIDocument.h&quot;
<span class="lineNum">     123 </span>            : #include &quot;nsIDocumentEncoder.h&quot;
<span class="lineNum">     124 </span>            : #include &quot;nsIDOMChromeWindow.h&quot;
<span class="lineNum">     125 </span>            : #include &quot;nsIDOMDocument.h&quot;
<span class="lineNum">     126 </span>            : #include &quot;nsIDOMDocumentType.h&quot;
<span class="lineNum">     127 </span>            : #include &quot;nsIDOMEvent.h&quot;
<span class="lineNum">     128 </span>            : #include &quot;nsIDOMElement.h&quot;
<span class="lineNum">     129 </span>            : #include &quot;nsIDOMHTMLElement.h&quot;
<span class="lineNum">     130 </span>            : #include &quot;nsIDOMHTMLFormElement.h&quot;
<span class="lineNum">     131 </span>            : #include &quot;nsIDOMHTMLInputElement.h&quot;
<span class="lineNum">     132 </span>            : #include &quot;nsIDOMNode.h&quot;
<span class="lineNum">     133 </span>            : #include &quot;nsIDOMNodeList.h&quot;
<span class="lineNum">     134 </span>            : #include &quot;nsIDOMWindowUtils.h&quot;
<span class="lineNum">     135 </span>            : #include &quot;nsIDOMXULCommandEvent.h&quot;
<span class="lineNum">     136 </span>            : #include &quot;nsIDragService.h&quot;
<span class="lineNum">     137 </span>            : #include &quot;nsIEditor.h&quot;
<span class="lineNum">     138 </span>            : #include &quot;nsIFormControl.h&quot;
<span class="lineNum">     139 </span>            : #include &quot;nsIForm.h&quot;
<span class="lineNum">     140 </span>            : #include &quot;nsIFragmentContentSink.h&quot;
<span class="lineNum">     141 </span>            : #include &quot;nsContainerFrame.h&quot;
<span class="lineNum">     142 </span>            : #include &quot;nsIHTMLDocument.h&quot;
<span class="lineNum">     143 </span>            : #include &quot;nsIIdleService.h&quot;
<span class="lineNum">     144 </span>            : #include &quot;nsIImageLoadingContent.h&quot;
<span class="lineNum">     145 </span>            : #include &quot;nsIInterfaceRequestor.h&quot;
<span class="lineNum">     146 </span>            : #include &quot;nsIInterfaceRequestorUtils.h&quot;
<span class="lineNum">     147 </span>            : #include &quot;nsIIOService.h&quot;
<span class="lineNum">     148 </span>            : #include &quot;nsILineBreaker.h&quot;
<span class="lineNum">     149 </span>            : #include &quot;nsILoadContext.h&quot;
<span class="lineNum">     150 </span>            : #include &quot;nsILoadGroup.h&quot;
<span class="lineNum">     151 </span>            : #include &quot;nsIMemoryReporter.h&quot;
<span class="lineNum">     152 </span>            : #include &quot;nsIMIMEHeaderParam.h&quot;
<span class="lineNum">     153 </span>            : #include &quot;nsIMIMEService.h&quot;
<span class="lineNum">     154 </span>            : #include &quot;nsINode.h&quot;
<span class="lineNum">     155 </span>            : #include &quot;mozilla/dom/NodeInfo.h&quot;
<span class="lineNum">     156 </span>            : #include &quot;nsIObjectLoadingContent.h&quot;
<span class="lineNum">     157 </span>            : #include &quot;nsIObserver.h&quot;
<span class="lineNum">     158 </span>            : #include &quot;nsIObserverService.h&quot;
<span class="lineNum">     159 </span>            : #include &quot;nsIOfflineCacheUpdate.h&quot;
<span class="lineNum">     160 </span>            : #include &quot;nsIParser.h&quot;
<span class="lineNum">     161 </span>            : #include &quot;nsIParserService.h&quot;
<span class="lineNum">     162 </span>            : #include &quot;nsIPermissionManager.h&quot;
<span class="lineNum">     163 </span>            : #include &quot;nsIPluginHost.h&quot;
<span class="lineNum">     164 </span>            : #include &quot;nsIRequest.h&quot;
<span class="lineNum">     165 </span>            : #include &quot;nsIRunnable.h&quot;
<span class="lineNum">     166 </span>            : #include &quot;nsIScriptContext.h&quot;
<span class="lineNum">     167 </span>            : #include &quot;nsIScriptError.h&quot;
<span class="lineNum">     168 </span>            : #include &quot;nsIScriptGlobalObject.h&quot;
<span class="lineNum">     169 </span>            : #include &quot;nsIScriptObjectPrincipal.h&quot;
<span class="lineNum">     170 </span>            : #include &quot;nsIScriptSecurityManager.h&quot;
<span class="lineNum">     171 </span>            : #include &quot;nsIScrollable.h&quot;
<span class="lineNum">     172 </span>            : #include &quot;nsIStreamConverterService.h&quot;
<span class="lineNum">     173 </span>            : #include &quot;nsIStringBundle.h&quot;
<span class="lineNum">     174 </span>            : #include &quot;nsIURI.h&quot;
<span class="lineNum">     175 </span>            : #include &quot;nsIURIWithPrincipal.h&quot;
<span class="lineNum">     176 </span>            : #include &quot;nsIURL.h&quot;
<span class="lineNum">     177 </span>            : #include &quot;nsIWebNavigation.h&quot;
<span class="lineNum">     178 </span>            : #include &quot;nsIWindowMediator.h&quot;
<span class="lineNum">     179 </span>            : #include &quot;nsIWordBreaker.h&quot;
<span class="lineNum">     180 </span>            : #include &quot;nsIXPConnect.h&quot;
<span class="lineNum">     181 </span>            : #include &quot;nsJSUtils.h&quot;
<span class="lineNum">     182 </span>            : #include &quot;nsLWBrkCIID.h&quot;
<span class="lineNum">     183 </span>            : #include &quot;nsMappedAttributes.h&quot;
<span class="lineNum">     184 </span>            : #include &quot;nsNetCID.h&quot;
<span class="lineNum">     185 </span>            : #include &quot;nsNetUtil.h&quot;
<span class="lineNum">     186 </span>            : #include &quot;nsNodeInfoManager.h&quot;
<span class="lineNum">     187 </span>            : #include &quot;NullPrincipal.h&quot;
<span class="lineNum">     188 </span>            : #include &quot;nsParserCIID.h&quot;
<span class="lineNum">     189 </span>            : #include &quot;nsParserConstants.h&quot;
<span class="lineNum">     190 </span>            : #include &quot;nsPIDOMWindow.h&quot;
<span class="lineNum">     191 </span>            : #include &quot;nsPresContext.h&quot;
<span class="lineNum">     192 </span>            : #include &quot;nsPrintfCString.h&quot;
<span class="lineNum">     193 </span>            : #include &quot;nsReferencedElement.h&quot;
<span class="lineNum">     194 </span>            : #include &quot;nsSandboxFlags.h&quot;
<span class="lineNum">     195 </span>            : #include &quot;nsScriptSecurityManager.h&quot;
<span class="lineNum">     196 </span>            : #include &quot;nsSerializationHelper.h&quot;
<span class="lineNum">     197 </span>            : #include &quot;nsStreamUtils.h&quot;
<span class="lineNum">     198 </span>            : #include &quot;nsTextEditorState.h&quot;
<span class="lineNum">     199 </span>            : #include &quot;nsTextFragment.h&quot;
<span class="lineNum">     200 </span>            : #include &quot;nsTextNode.h&quot;
<span class="lineNum">     201 </span>            : #include &quot;nsThreadUtils.h&quot;
<span class="lineNum">     202 </span>            : #include &quot;nsUnicharUtilCIID.h&quot;
<span class="lineNum">     203 </span>            : #include &quot;nsUnicodeProperties.h&quot;
<span class="lineNum">     204 </span>            : #include &quot;nsViewManager.h&quot;
<span class="lineNum">     205 </span>            : #include &quot;nsViewportInfo.h&quot;
<span class="lineNum">     206 </span>            : #include &quot;nsWidgetsCID.h&quot;
<span class="lineNum">     207 </span>            : #include &quot;nsIWindowProvider.h&quot;
<span class="lineNum">     208 </span>            : #include &quot;nsWrapperCacheInlines.h&quot;
<span class="lineNum">     209 </span>            : #include &quot;nsXULPopupManager.h&quot;
<span class="lineNum">     210 </span>            : #include &quot;xpcprivate.h&quot; // nsXPConnect
<span class="lineNum">     211 </span>            : #include &quot;HTMLSplitOnSpacesTokenizer.h&quot;
<span class="lineNum">     212 </span>            : #include &quot;nsContentTypeParser.h&quot;
<span class="lineNum">     213 </span>            : #include &quot;nsICookiePermission.h&quot;
<span class="lineNum">     214 </span>            : #include &quot;mozIThirdPartyUtil.h&quot;
<span class="lineNum">     215 </span>            : #include &quot;nsICookieService.h&quot;
<span class="lineNum">     216 </span>            : #include &quot;mozilla/EnumSet.h&quot;
<span class="lineNum">     217 </span>            : #include &quot;mozilla/BloomFilter.h&quot;
<span class="lineNum">     218 </span>            : #include &quot;TabChild.h&quot;
<span class="lineNum">     219 </span>            : #include &quot;mozilla/dom/DocGroup.h&quot;
<span class="lineNum">     220 </span>            : #include &quot;mozilla/dom/TabGroup.h&quot;
<span class="lineNum">     221 </span>            : #include &quot;nsIWebNavigationInfo.h&quot;
<span class="lineNum">     222 </span>            : #include &quot;nsPluginHost.h&quot;
<span class="lineNum">     223 </span>            : 
<span class="lineNum">     224 </span>            : #include &quot;nsIBidiKeyboard.h&quot;
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span>            : #if defined(XP_WIN)
<span class="lineNum">     227 </span>            : // Undefine LoadImage to prevent naming conflict with Windows.
<span class="lineNum">     228 </span>            : #undef LoadImage
<span class="lineNum">     229 </span>            : #endif
<span class="lineNum">     230 </span>            : 
<span class="lineNum">     231 </span>            : extern &quot;C&quot; int MOZ_XMLTranslateEntity(const char* ptr, const char* end,
<span class="lineNum">     232 </span>            :                                       const char** next, char16_t* result);
<span class="lineNum">     233 </span>            : extern &quot;C&quot; int MOZ_XMLCheckQName(const char* ptr, const char* end,
<span class="lineNum">     234 </span>            :                                  int ns_aware, const char** colon);
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span>            : class imgLoader;
<span class="lineNum">     237 </span>            : 
<span class="lineNum">     238 </span>            : using namespace mozilla::dom;
<span class="lineNum">     239 </span>            : using namespace mozilla::ipc;
<span class="lineNum">     240 </span>            : using namespace mozilla::gfx;
<span class="lineNum">     241 </span>            : using namespace mozilla::layers;
<span class="lineNum">     242 </span>            : using namespace mozilla::widget;
<span class="lineNum">     243 </span>            : using namespace mozilla;
<span class="lineNum">     244 </span>            : 
<span class="lineNum">     245 </span>            : const char kLoadAsData[] = &quot;loadAsData&quot;;
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span>            : nsIXPConnect *nsContentUtils::sXPConnect;
<span class="lineNum">     248 </span>            : nsIScriptSecurityManager *nsContentUtils::sSecurityManager;
<span class="lineNum">     249 </span>            : nsIPrincipal *nsContentUtils::sSystemPrincipal;
<span class="lineNum">     250 </span>            : nsIPrincipal *nsContentUtils::sNullSubjectPrincipal;
<span class="lineNum">     251 </span>            : nsIParserService *nsContentUtils::sParserService = nullptr;
<span class="lineNum">     252 </span>            : nsNameSpaceManager *nsContentUtils::sNameSpaceManager;
<span class="lineNum">     253 </span>            : nsIIOService *nsContentUtils::sIOService;
<span class="lineNum">     254 </span>            : nsIUUIDGenerator *nsContentUtils::sUUIDGenerator;
<span class="lineNum">     255 </span>            : nsIConsoleService *nsContentUtils::sConsoleService;
<span class="lineNum">     256 </span>            : nsDataHashtable&lt;nsISupportsHashKey, EventNameMapping&gt;* nsContentUtils::sAtomEventTable = nullptr;
<span class="lineNum">     257 </span>            : nsDataHashtable&lt;nsStringHashKey, EventNameMapping&gt;* nsContentUtils::sStringEventTable = nullptr;
<span class="lineNum">     258 </span>            : nsCOMArray&lt;nsIAtom&gt;* nsContentUtils::sUserDefinedEvents = nullptr;
<span class="lineNum">     259 </span>            : nsIStringBundleService *nsContentUtils::sStringBundleService;
<span class="lineNum">     260 </span>            : nsIStringBundle *nsContentUtils::sStringBundles[PropertiesFile_COUNT];
<span class="lineNum">     261 </span>            : nsIContentPolicy *nsContentUtils::sContentPolicyService;
<span class="lineNum">     262 </span>            : bool nsContentUtils::sTriedToGetContentPolicy = false;
<span class="lineNum">     263 </span>            : nsILineBreaker *nsContentUtils::sLineBreaker;
<span class="lineNum">     264 </span>            : nsIWordBreaker *nsContentUtils::sWordBreaker;
<span class="lineNum">     265 </span>            : nsIBidiKeyboard *nsContentUtils::sBidiKeyboard = nullptr;
<span class="lineNum">     266 </span>            : uint32_t nsContentUtils::sScriptBlockerCount = 0;
<span class="lineNum">     267 </span>            : uint32_t nsContentUtils::sDOMNodeRemovedSuppressCount = 0;
<span class="lineNum">     268 </span>            : uint32_t nsContentUtils::sMicroTaskLevel = 0;
<span class="lineNum">     269 </span>            : AutoTArray&lt;nsCOMPtr&lt;nsIRunnable&gt;, 8&gt;* nsContentUtils::sBlockedScriptRunners = nullptr;
<span class="lineNum">     270 </span>            : uint32_t nsContentUtils::sRunnersCountAtFirstBlocker = 0;
<span class="lineNum">     271 </span>            : nsIInterfaceRequestor* nsContentUtils::sSameOriginChecker = nullptr;
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span>            : bool nsContentUtils::sIsHandlingKeyBoardEvent = false;
<span class="lineNum">     274 </span>            : bool nsContentUtils::sAllowXULXBL_for_file = false;
<span class="lineNum">     275 </span>            : 
<span class="lineNum">     276 </span>            : nsString* nsContentUtils::sShiftText = nullptr;
<span class="lineNum">     277 </span>            : nsString* nsContentUtils::sControlText = nullptr;
<span class="lineNum">     278 </span>            : nsString* nsContentUtils::sMetaText = nullptr;
<span class="lineNum">     279 </span>            : nsString* nsContentUtils::sOSText = nullptr;
<span class="lineNum">     280 </span>            : nsString* nsContentUtils::sAltText = nullptr;
<span class="lineNum">     281 </span>            : nsString* nsContentUtils::sModifierSeparator = nullptr;
<span class="lineNum">     282 </span>            : 
<span class="lineNum">     283 </span>            : bool nsContentUtils::sInitialized = false;
<span class="lineNum">     284 </span>            : bool nsContentUtils::sIsFullScreenApiEnabled = false;
<span class="lineNum">     285 </span>            : bool nsContentUtils::sIsUnprefixedFullscreenApiEnabled = false;
<span class="lineNum">     286 </span>            : bool nsContentUtils::sTrustedFullScreenOnly = true;
<span class="lineNum">     287 </span>            : bool nsContentUtils::sIsCutCopyAllowed = true;
<span class="lineNum">     288 </span>            : bool nsContentUtils::sIsFrameTimingPrefEnabled = false;
<span class="lineNum">     289 </span>            : bool nsContentUtils::sIsPerformanceTimingEnabled = false;
<span class="lineNum">     290 </span>            : bool nsContentUtils::sIsResourceTimingEnabled = false;
<span class="lineNum">     291 </span>            : bool nsContentUtils::sIsUserTimingLoggingEnabled = false;
<span class="lineNum">     292 </span>            : bool nsContentUtils::sIsExperimentalAutocompleteEnabled = false;
<span class="lineNum">     293 </span>            : bool nsContentUtils::sIsWebComponentsEnabled = false;
<span class="lineNum">     294 </span>            : bool nsContentUtils::sPrivacyResistFingerprinting = false;
<span class="lineNum">     295 </span>            : bool nsContentUtils::sSendPerformanceTimingNotifications = false;
<span class="lineNum">     296 </span>            : bool nsContentUtils::sUseActivityCursor = false;
<span class="lineNum">     297 </span>            : bool nsContentUtils::sAnimationsAPICoreEnabled = false;
<span class="lineNum">     298 </span>            : bool nsContentUtils::sAnimationsAPIElementAnimateEnabled = false;
<span class="lineNum">     299 </span>            : bool nsContentUtils::sGetBoxQuadsEnabled = false;
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span>            : int32_t nsContentUtils::sPrivacyMaxInnerWidth = 1000;
<span class="lineNum">     302 </span>            : int32_t nsContentUtils::sPrivacyMaxInnerHeight = 1000;
<span class="lineNum">     303 </span>            : 
<span class="lineNum">     304 </span>            : uint32_t nsContentUtils::sHandlingInputTimeout = 1000;
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span>            : uint32_t nsContentUtils::sCookiesLifetimePolicy = nsICookieService::ACCEPT_NORMALLY;
<span class="lineNum">     307 </span>            : uint32_t nsContentUtils::sCookiesBehavior = nsICookieService::BEHAVIOR_ACCEPT;
<span class="lineNum">     308 </span>            : 
<span class="lineNum">     309 </span>            : nsHtml5StringParser* nsContentUtils::sHTMLFragmentParser = nullptr;
<span class="lineNum">     310 </span>            : nsIParser* nsContentUtils::sXMLFragmentParser = nullptr;
<span class="lineNum">     311 </span>            : nsIFragmentContentSink* nsContentUtils::sXMLFragmentSink = nullptr;
<span class="lineNum">     312 </span>            : bool nsContentUtils::sFragmentParsingActive = false;
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span>            : #if !(defined(DEBUG) || defined(MOZ_ENABLE_JS_DUMP))
<span class="lineNum">     315 </span>            : bool nsContentUtils::sDOMWindowDumpEnabled;
<span class="lineNum">     316 </span>            : #endif
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span>            : bool nsContentUtils::sDoNotTrackEnabled = false;
<span class="lineNum">     319 </span>            : 
<span class="lineNum">     320 </span>            : mozilla::LazyLogModule nsContentUtils::sDOMDumpLog(&quot;Dump&quot;);
<span class="lineNum">     321 </span>            : 
<span class="lineNum">     322 </span>            : // Subset of http://www.whatwg.org/specs/web-apps/current-work/#autofill-field-name
<span class="lineNum">     323 </span>            : enum AutocompleteFieldName : uint8_t
<span class="lineNum">     324 </span>            : {
<span class="lineNum">     325 </span>            :   #define AUTOCOMPLETE_FIELD_NAME(name_, value_) \
<span class="lineNum">     326 </span>            :     eAutocompleteFieldName_##name_,
<span class="lineNum">     327 </span>            :   #define AUTOCOMPLETE_CONTACT_FIELD_NAME(name_, value_) \
<span class="lineNum">     328 </span>            :     AUTOCOMPLETE_FIELD_NAME(name_, value_)
<span class="lineNum">     329 </span>            :   #include &quot;AutocompleteFieldList.h&quot;
<span class="lineNum">     330 </span>            :   #undef AUTOCOMPLETE_FIELD_NAME
<span class="lineNum">     331 </span>            :   #undef AUTOCOMPLETE_CONTACT_FIELD_NAME
<span class="lineNum">     332 </span>            : };
<span class="lineNum">     333 </span>            : 
<span class="lineNum">     334 </span>            : enum AutocompleteFieldHint : uint8_t
<span class="lineNum">     335 </span>            : {
<span class="lineNum">     336 </span>            :   #define AUTOCOMPLETE_FIELD_HINT(name_, value_) \
<span class="lineNum">     337 </span>            :     eAutocompleteFieldHint_##name_,
<span class="lineNum">     338 </span>            :   #include &quot;AutocompleteFieldList.h&quot;
<span class="lineNum">     339 </span>            :   #undef AUTOCOMPLETE_FIELD_HINT
<span class="lineNum">     340 </span>            : };
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span>            : enum AutocompleteFieldContactHint : uint8_t
<span class="lineNum">     343 </span>            : {
<span class="lineNum">     344 </span>            :   #define AUTOCOMPLETE_FIELD_CONTACT_HINT(name_, value_) \
<span class="lineNum">     345 </span>            :     eAutocompleteFieldContactHint_##name_,
<span class="lineNum">     346 </span>            :   #include &quot;AutocompleteFieldList.h&quot;
<span class="lineNum">     347 </span>            :   #undef AUTOCOMPLETE_FIELD_CONTACT_HINT
<span class="lineNum">     348 </span>            : };
<span class="lineNum">     349 </span>            : 
<span class="lineNum">     350 </span>            : enum AutocompleteCategory
<span class="lineNum">     351 </span>            : {
<span class="lineNum">     352 </span>            :   #define AUTOCOMPLETE_CATEGORY(name_, value_) eAutocompleteCategory_##name_,
<span class="lineNum">     353 </span>            :   #include &quot;AutocompleteFieldList.h&quot;
<span class="lineNum">     354 </span>            :   #undef AUTOCOMPLETE_CATEGORY
<span class="lineNum">     355 </span>            : };
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span>            : static const nsAttrValue::EnumTable kAutocompleteFieldNameTable[] = {
<span class="lineNum">     358 </span>            :   #define AUTOCOMPLETE_FIELD_NAME(name_, value_) \
<span class="lineNum">     359 </span>            :     { value_, eAutocompleteFieldName_##name_ },
<span class="lineNum">     360 </span>            :   #include &quot;AutocompleteFieldList.h&quot;
<span class="lineNum">     361 </span>            :   #undef AUTOCOMPLETE_FIELD_NAME
<span class="lineNum">     362 </span>            :   { nullptr, 0 }
<span class="lineNum">     363 </span>            : };
<span class="lineNum">     364 </span>            : 
<span class="lineNum">     365 </span>            : static const nsAttrValue::EnumTable kAutocompleteContactFieldNameTable[] = {
<span class="lineNum">     366 </span>            :   #define AUTOCOMPLETE_CONTACT_FIELD_NAME(name_, value_) \
<span class="lineNum">     367 </span>            :     { value_, eAutocompleteFieldName_##name_ },
<span class="lineNum">     368 </span>            :   #include &quot;AutocompleteFieldList.h&quot;
<span class="lineNum">     369 </span>            :   #undef AUTOCOMPLETE_CONTACT_FIELD_NAME
<span class="lineNum">     370 </span>            :   { nullptr, 0 }
<span class="lineNum">     371 </span>            : };
<span class="lineNum">     372 </span>            : 
<span class="lineNum">     373 </span>            : static const nsAttrValue::EnumTable kAutocompleteFieldHintTable[] = {
<span class="lineNum">     374 </span>            :   #define AUTOCOMPLETE_FIELD_HINT(name_, value_) \
<span class="lineNum">     375 </span>            :     { value_, eAutocompleteFieldHint_##name_ },
<span class="lineNum">     376 </span>            :   #include &quot;AutocompleteFieldList.h&quot;
<span class="lineNum">     377 </span>            :   #undef AUTOCOMPLETE_FIELD_HINT
<span class="lineNum">     378 </span>            :   { nullptr, 0 }
<span class="lineNum">     379 </span>            : };
<span class="lineNum">     380 </span>            : 
<span class="lineNum">     381 </span>            : static const nsAttrValue::EnumTable kAutocompleteContactFieldHintTable[] = {
<span class="lineNum">     382 </span>            :   #define AUTOCOMPLETE_FIELD_CONTACT_HINT(name_, value_) \
<span class="lineNum">     383 </span>            :     { value_, eAutocompleteFieldContactHint_##name_ },
<span class="lineNum">     384 </span>            :   #include &quot;AutocompleteFieldList.h&quot;
<span class="lineNum">     385 </span>            :   #undef AUTOCOMPLETE_FIELD_CONTACT_HINT
<span class="lineNum">     386 </span>            :   { nullptr, 0 }
<span class="lineNum">     387 </span>            : };
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span>            : namespace {
<span class="lineNum">     390 </span>            : 
<span class="lineNum">     391 </span>            : static NS_DEFINE_CID(kParserServiceCID, NS_PARSERSERVICE_CID);
<span class="lineNum">     392 </span>            : static NS_DEFINE_CID(kCParserCID, NS_PARSER_CID);
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span>            : static PLDHashTable* sEventListenerManagersHash;
<span class="lineNum">     395 </span>            : 
<a name="396"><span class="lineNum">     396 </span><span class="lineCov">        120 : class DOMEventListenerManagersHashReporter final : public nsIMemoryReporter</span></a>
<span class="lineNum">     397 </span>            : {
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :   MOZ_DEFINE_MALLOC_SIZE_OF(MallocSizeOf)</span>
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span>            :   ~DOMEventListenerManagersHashReporter() = default;
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span>            : public:
<a name="403"><span class="lineNum">     403 </span>            :   NS_DECL_ISUPPORTS</a>
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :   NS_IMETHOD CollectReports(nsIHandleReportCallback* aHandleReport,</span>
<span class="lineNum">     406 </span>            :                             nsISupports* aData, bool aAnonymize) override
<span class="lineNum">     407 </span>            :   {
<span class="lineNum">     408 </span>            :     // We don't measure the |EventListenerManager| objects pointed to by the
<span class="lineNum">     409 </span>            :     // entries because those references are non-owning.
<span class="lineNum">     410 </span>            :     int64_t amount = sEventListenerManagersHash
<span class="lineNum">     411 </span>            :                    ? sEventListenerManagersHash-&gt;ShallowSizeOfIncludingThis(
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :                        MallocSizeOf)</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :                    : 0;</span>
<span class="lineNum">     414 </span>            : 
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :     MOZ_COLLECT_REPORT(</span>
<span class="lineNum">     416 </span>            :       &quot;explicit/dom/event-listener-managers-hash&quot;, KIND_HEAP, UNITS_BYTES,
<span class="lineNum">     417 </span>            :       amount,
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :       &quot;Memory used by the event listener manager's hash table.&quot;);</span>
<span class="lineNum">     419 </span>            : 
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">     421 </span>            :   }
<a name="422"><span class="lineNum">     422 </span>            : };</a>
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span><span class="lineCov">       1020 : NS_IMPL_ISUPPORTS(DOMEventListenerManagersHashReporter, nsIMemoryReporter)</span>
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span>            : class EventListenerManagerMapEntry : public PLDHashEntryHdr
<span class="lineNum">     427 </span>            : {
<a name="428"><span class="lineNum">     428 </span>            : public:</a>
<span class="lineNum">     429 </span>            :   explicit EventListenerManagerMapEntry(const void* aKey)
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :     : mKey(aKey)</span>
<span class="lineNum">     431 </span>            :   {
<span class="lineNum">     432 </span>            :   }
<a name="433"><span class="lineNum">     433 </span>            : </a>
<span class="lineNum">     434 </span>            :   ~EventListenerManagerMapEntry()
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :   {</span>
<span class="lineNum">     436 </span>            :     NS_ASSERTION(!mListenerManager, &quot;caller must release and disconnect ELM&quot;);
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">     438 </span>            : 
<span class="lineNum">     439 </span>            : protected:          // declared protected to silence clang warnings
<span class="lineNum">     440 </span>            :   const void *mKey; // must be first, to look like PLDHashEntryStub
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span>            : public:
<span class="lineNum">     443 </span>            :   RefPtr&lt;EventListenerManager&gt; mListenerManager;
<span class="lineNum">     444 </span>            : };
<span class="lineNum">     445 </span>            : 
<span class="lineNum">     446 </span>            : static void
<span class="lineNum">     447 </span><span class="lineNoCov">          0 : EventListenerManagerHashInitEntry(PLDHashEntryHdr *entry, const void *key)</span>
<span class="lineNum">     448 </span>            : {
<span class="lineNum">     449 </span>            :   // Initialize the entry with placement new
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :   new (entry) EventListenerManagerMapEntry(key);</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span>            : static void
<span class="lineNum">     454 </span><span class="lineNoCov">          0 : EventListenerManagerHashClearEntry(PLDHashTable *table, PLDHashEntryHdr *entry)</span>
<span class="lineNum">     455 </span>            : {
<span class="lineNum">     456 </span>            :   EventListenerManagerMapEntry *lm =
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :     static_cast&lt;EventListenerManagerMapEntry *&gt;(entry);</span>
<span class="lineNum">     458 </span>            : 
<span class="lineNum">     459 </span>            :   // Let the EventListenerManagerMapEntry clean itself up...
<span class="lineNum">     460 </span>            :   lm-&gt;~EventListenerManagerMapEntry();
<a name="461"><span class="lineNum">     461 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     462 </span>            : 
<span class="lineNum">     463 </span><span class="lineNoCov">          0 : class SameOriginCheckerImpl final : public nsIChannelEventSink,</span>
<span class="lineNum">     464 </span>            :                                     public nsIInterfaceRequestor
<span class="lineNum">     465 </span>            : {
<span class="lineNum">     466 </span>            :   ~SameOriginCheckerImpl() = default;
<span class="lineNum">     467 </span>            : 
<span class="lineNum">     468 </span>            :   NS_DECL_ISUPPORTS
<span class="lineNum">     469 </span>            :   NS_DECL_NSICHANNELEVENTSINK
<span class="lineNum">     470 </span>            :   NS_DECL_NSIINTERFACEREQUESTOR
<span class="lineNum">     471 </span>            : };
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span>            : class CharsetDetectionObserver final : public nsICharsetDetectionObserver
<span class="lineNum">     474 </span>            : {
<span class="lineNum">     475 </span>            : public:
<span class="lineNum">     476 </span>            :   NS_DECL_ISUPPORTS
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span>            :   NS_IMETHOD Notify(const char *aCharset, nsDetectionConfident aConf) override
<span class="lineNum">     479 </span>            :   {
<span class="lineNum">     480 </span>            :     mCharset = aCharset;
<span class="lineNum">     481 </span>            :     return NS_OK;
<span class="lineNum">     482 </span>            :   }
<span class="lineNum">     483 </span>            : 
<span class="lineNum">     484 </span>            :   const nsACString&amp; GetResult() const
<span class="lineNum">     485 </span>            :   {
<span class="lineNum">     486 </span>            :     return mCharset;
<span class="lineNum">     487 </span>            :   }
<span class="lineNum">     488 </span>            : 
<span class="lineNum">     489 </span>            : private:
<span class="lineNum">     490 </span>            :   nsCString mCharset;
<span class="lineNum">     491 </span>            : };
<span class="lineNum">     492 </span>            : 
<span class="lineNum">     493 </span>            : } // namespace
<span class="lineNum">     494 </span>            : 
<a name="495"><span class="lineNum">     495 </span>            : /* static */</a>
<span class="lineNum">     496 </span>            : TimeDuration
<span class="lineNum">     497 </span><span class="lineNoCov">          0 : nsContentUtils::HandlingUserInputTimeout()</span>
<span class="lineNum">     498 </span>            : {
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :   return TimeDuration::FromMilliseconds(sHandlingInputTimeout);</span>
<span class="lineNum">     500 </span>            : }
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span>            : // static
<span class="lineNum">     503 </span>            : nsresult
<span class="lineNum">     504 </span><span class="lineCov">         60 : nsContentUtils::Init()</span>
<span class="lineNum">     505 </span>            : {
<span class="lineNum">     506 </span><span class="lineCov">         60 :   if (sInitialized) {</span>
<span class="lineNum">     507 </span>            :     NS_WARNING(&quot;Init() called twice&quot;);
<span class="lineNum">     508 </span>            : 
<span class="lineNum">     509 </span>            :     return NS_OK;
<span class="lineNum">     510 </span>            :   }
<span class="lineNum">     511 </span>            : 
<span class="lineNum">     512 </span><span class="lineCov">         60 :   sNameSpaceManager = nsNameSpaceManager::GetInstance();</span>
<span class="lineNum">     513 </span><span class="lineCov">         60 :   NS_ENSURE_TRUE(sNameSpaceManager, NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">     514 </span>            : 
<span class="lineNum">     515 </span><span class="lineCov">         60 :   sXPConnect = nsXPConnect::XPConnect();</span>
<span class="lineNum">     516 </span>            : 
<span class="lineNum">     517 </span><span class="lineCov">         60 :   sSecurityManager = nsScriptSecurityManager::GetScriptSecurityManager();</span>
<span class="lineNum">     518 </span><span class="lineCov">         60 :   if(!sSecurityManager)</span>
<span class="lineNum">     519 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">     520 </span><span class="lineCov">         60 :   NS_ADDREF(sSecurityManager);</span>
<span class="lineNum">     521 </span>            : 
<span class="lineNum">     522 </span><span class="lineCov">         60 :   sSecurityManager-&gt;GetSystemPrincipal(&amp;sSystemPrincipal);</span>
<span class="lineNum">     523 </span>            :   MOZ_ASSERT(sSystemPrincipal);
<span class="lineNum">     524 </span>            : 
<span class="lineNum">     525 </span><span class="lineCov">        180 :   RefPtr&lt;NullPrincipal&gt; nullPrincipal = NullPrincipal::Create();</span>
<span class="lineNum">     526 </span><span class="lineCov">         60 :   if (!nullPrincipal) {</span>
<span class="lineNum">     527 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">     528 </span>            :   }
<span class="lineNum">     529 </span>            : 
<span class="lineNum">     530 </span>            :   nullPrincipal.forget(&amp;sNullSubjectPrincipal);
<span class="lineNum">     531 </span>            : 
<span class="lineNum">     532 </span><span class="lineCov">         60 :   nsresult rv = CallGetService(NS_IOSERVICE_CONTRACTID, &amp;sIOService);</span>
<span class="lineNum">     533 </span><span class="lineCov">        120 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">     534 </span>            :     // This makes life easier, but we can live without it.
<span class="lineNum">     535 </span>            : 
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :     sIOService = nullptr;</span>
<span class="lineNum">     537 </span>            :   }
<span class="lineNum">     538 </span>            : 
<span class="lineNum">     539 </span><span class="lineCov">         60 :   rv = CallGetService(NS_LBRK_CONTRACTID, &amp;sLineBreaker);</span>
<span class="lineNum">     540 </span><span class="lineCov">        120 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     541 </span>            : 
<span class="lineNum">     542 </span><span class="lineCov">         60 :   rv = CallGetService(NS_WBRK_CONTRACTID, &amp;sWordBreaker);</span>
<span class="lineNum">     543 </span><span class="lineCov">        120 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     544 </span>            : 
<span class="lineNum">     545 </span><span class="lineCov">         60 :   if (!InitializeEventTable())</span>
<span class="lineNum">     546 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">     547 </span>            : 
<span class="lineNum">     548 </span><span class="lineCov">         60 :   if (!sEventListenerManagersHash) {</span>
<span class="lineNum">     549 </span>            :     static const PLDHashTableOps hash_table_ops =
<span class="lineNum">     550 </span>            :     {
<span class="lineNum">     551 </span>            :       PLDHashTable::HashVoidPtrKeyStub,
<span class="lineNum">     552 </span>            :       PLDHashTable::MatchEntryStub,
<span class="lineNum">     553 </span>            :       PLDHashTable::MoveEntryStub,
<span class="lineNum">     554 </span>            :       EventListenerManagerHashClearEntry,
<span class="lineNum">     555 </span>            :       EventListenerManagerHashInitEntry
<span class="lineNum">     556 </span>            :     };
<span class="lineNum">     557 </span>            : 
<span class="lineNum">     558 </span>            :     sEventListenerManagersHash =
<span class="lineNum">     559 </span><span class="lineCov">         60 :       new PLDHashTable(&amp;hash_table_ops, sizeof(EventListenerManagerMapEntry));</span>
<span class="lineNum">     560 </span>            : 
<span class="lineNum">     561 </span><span class="lineCov">        120 :     RegisterStrongMemoryReporter(new DOMEventListenerManagersHashReporter());</span>
<span class="lineNum">     562 </span>            :   }
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span><span class="lineCov">         60 :   sBlockedScriptRunners = new AutoTArray&lt;nsCOMPtr&lt;nsIRunnable&gt;, 8&gt;;</span>
<span class="lineNum">     565 </span>            : 
<span class="lineNum">     566 </span>            :   Preferences::AddBoolVarCache(&amp;sAllowXULXBL_for_file,
<span class="lineNum">     567 </span><span class="lineCov">         60 :                                &quot;dom.allow_XUL_XBL_for_file&quot;);</span>
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span>            :   Preferences::AddBoolVarCache(&amp;sIsFullScreenApiEnabled,
<span class="lineNum">     570 </span><span class="lineCov">         60 :                                &quot;full-screen-api.enabled&quot;);</span>
<span class="lineNum">     571 </span>            : 
<span class="lineNum">     572 </span>            :   Preferences::AddBoolVarCache(&amp;sIsUnprefixedFullscreenApiEnabled,
<span class="lineNum">     573 </span><span class="lineCov">         60 :                                &quot;full-screen-api.unprefix.enabled&quot;);</span>
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span>            :   Preferences::AddBoolVarCache(&amp;sTrustedFullScreenOnly,
<span class="lineNum">     576 </span><span class="lineCov">         60 :                                &quot;full-screen-api.allow-trusted-requests-only&quot;);</span>
<span class="lineNum">     577 </span>            : 
<span class="lineNum">     578 </span>            :   Preferences::AddBoolVarCache(&amp;sIsCutCopyAllowed,
<span class="lineNum">     579 </span><span class="lineCov">         60 :                                &quot;dom.allow_cut_copy&quot;, true);</span>
<span class="lineNum">     580 </span>            : 
<span class="lineNum">     581 </span>            :   Preferences::AddBoolVarCache(&amp;sIsPerformanceTimingEnabled,
<span class="lineNum">     582 </span><span class="lineCov">         60 :                                &quot;dom.enable_performance&quot;, true);</span>
<span class="lineNum">     583 </span>            : 
<span class="lineNum">     584 </span>            :   Preferences::AddBoolVarCache(&amp;sIsResourceTimingEnabled,
<span class="lineNum">     585 </span><span class="lineCov">         60 :                                &quot;dom.enable_resource_timing&quot;, true);</span>
<span class="lineNum">     586 </span>            : 
<span class="lineNum">     587 </span>            :   Preferences::AddBoolVarCache(&amp;sIsUserTimingLoggingEnabled,
<span class="lineNum">     588 </span><span class="lineCov">         60 :                                &quot;dom.performance.enable_user_timing_logging&quot;, false);</span>
<span class="lineNum">     589 </span>            : 
<span class="lineNum">     590 </span>            :   Preferences::AddBoolVarCache(&amp;sIsFrameTimingPrefEnabled,
<span class="lineNum">     591 </span><span class="lineCov">         60 :                                &quot;dom.enable_frame_timing&quot;, false);</span>
<span class="lineNum">     592 </span>            : 
<span class="lineNum">     593 </span>            :   Preferences::AddBoolVarCache(&amp;sIsExperimentalAutocompleteEnabled,
<span class="lineNum">     594 </span><span class="lineCov">         60 :                                &quot;dom.forms.autocomplete.experimental&quot;, false);</span>
<span class="lineNum">     595 </span>            : 
<span class="lineNum">     596 </span>            :   Preferences::AddBoolVarCache(&amp;sIsWebComponentsEnabled,
<span class="lineNum">     597 </span><span class="lineCov">         60 :                                &quot;dom.webcomponents.enabled&quot;, false);</span>
<span class="lineNum">     598 </span>            : 
<span class="lineNum">     599 </span>            :   Preferences::AddBoolVarCache(&amp;sPrivacyResistFingerprinting,
<span class="lineNum">     600 </span><span class="lineCov">         60 :                                &quot;privacy.resistFingerprinting&quot;, false);</span>
<span class="lineNum">     601 </span>            : 
<span class="lineNum">     602 </span>            :   Preferences::AddIntVarCache(&amp;sPrivacyMaxInnerWidth,
<span class="lineNum">     603 </span>            :                               &quot;privacy.window.maxInnerWidth&quot;,
<span class="lineNum">     604 </span><span class="lineCov">         60 :                               1000);</span>
<span class="lineNum">     605 </span>            : 
<span class="lineNum">     606 </span>            :   Preferences::AddIntVarCache(&amp;sPrivacyMaxInnerHeight,
<span class="lineNum">     607 </span>            :                               &quot;privacy.window.maxInnerHeight&quot;,
<span class="lineNum">     608 </span><span class="lineCov">         60 :                               1000);</span>
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span>            :   Preferences::AddUintVarCache(&amp;sHandlingInputTimeout,
<span class="lineNum">     611 </span>            :                                &quot;dom.event.handling-user-input-time-limit&quot;,
<span class="lineNum">     612 </span><span class="lineCov">         60 :                                1000);</span>
<span class="lineNum">     613 </span>            : 
<span class="lineNum">     614 </span>            :   Preferences::AddBoolVarCache(&amp;sSendPerformanceTimingNotifications,
<span class="lineNum">     615 </span><span class="lineCov">         60 :                                &quot;dom.performance.enable_notify_performance_timing&quot;, false);</span>
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span>            :   Preferences::AddUintVarCache(&amp;sCookiesLifetimePolicy,
<span class="lineNum">     618 </span>            :                                &quot;network.cookie.lifetimePolicy&quot;,
<span class="lineNum">     619 </span><span class="lineCov">         60 :                                nsICookieService::ACCEPT_NORMALLY);</span>
<span class="lineNum">     620 </span>            : 
<span class="lineNum">     621 </span>            :   Preferences::AddUintVarCache(&amp;sCookiesBehavior,
<span class="lineNum">     622 </span>            :                                &quot;network.cookie.cookieBehavior&quot;,
<span class="lineNum">     623 </span><span class="lineCov">         60 :                                nsICookieService::BEHAVIOR_ACCEPT);</span>
<span class="lineNum">     624 </span>            : 
<span class="lineNum">     625 </span>            : #if !(defined(DEBUG) || defined(MOZ_ENABLE_JS_DUMP))
<span class="lineNum">     626 </span>            :   Preferences::AddBoolVarCache(&amp;sDOMWindowDumpEnabled,
<span class="lineNum">     627 </span><span class="lineCov">         60 :                                &quot;browser.dom.window.dump.enabled&quot;);</span>
<span class="lineNum">     628 </span>            : #endif
<span class="lineNum">     629 </span>            : 
<span class="lineNum">     630 </span>            :   Preferences::AddBoolVarCache(&amp;sDoNotTrackEnabled,
<span class="lineNum">     631 </span><span class="lineCov">         60 :                                &quot;privacy.donottrackheader.enabled&quot;, false);</span>
<span class="lineNum">     632 </span>            : 
<span class="lineNum">     633 </span>            :   Preferences::AddBoolVarCache(&amp;sUseActivityCursor,
<span class="lineNum">     634 </span><span class="lineCov">         60 :                                &quot;ui.use_activity_cursor&quot;, false);</span>
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span>            :   Preferences::AddBoolVarCache(&amp;sAnimationsAPICoreEnabled,
<span class="lineNum">     637 </span><span class="lineCov">         60 :                                &quot;dom.animations-api.core.enabled&quot;, false);</span>
<span class="lineNum">     638 </span>            : 
<span class="lineNum">     639 </span>            :   Preferences::AddBoolVarCache(&amp;sAnimationsAPIElementAnimateEnabled,
<span class="lineNum">     640 </span><span class="lineCov">         60 :                                &quot;dom.animations-api.element-animate.enabled&quot;, false);</span>
<span class="lineNum">     641 </span>            : 
<span class="lineNum">     642 </span>            :   Preferences::AddBoolVarCache(&amp;sGetBoxQuadsEnabled,
<span class="lineNum">     643 </span><span class="lineCov">         60 :                                &quot;layout.css.getBoxQuads.enabled&quot;, false);</span>
<span class="lineNum">     644 </span>            : 
<span class="lineNum">     645 </span><span class="lineCov">         60 :   Element::InitCCCallbacks();</span>
<span class="lineNum">     646 </span>            : 
<span class="lineNum">     647 </span>            :   nsCOMPtr&lt;nsIUUIDGenerator&gt; uuidGenerator =
<span class="lineNum">     648 </span><span class="lineCov">         60 :     do_GetService(&quot;@mozilla.org/uuid-generator;1&quot;, &amp;rv);</span>
<span class="lineNum">     649 </span><span class="lineCov">        120 :   if (NS_WARN_IF(NS_FAILED(rv))) {</span>
<span class="lineNum">     650 </span>            :     return rv;
<span class="lineNum">     651 </span>            :   }
<span class="lineNum">     652 </span>            :   uuidGenerator.forget(&amp;sUUIDGenerator);
<span class="lineNum">     653 </span>            : 
<span class="lineNum">     654 </span><span class="lineCov">         60 :   sInitialized = true;</span>
<span class="lineNum">     655 </span>            : 
<span class="lineNum">     656 </span><span class="lineCov">        120 :   return NS_OK;</span>
<span class="lineNum">     657 </span>            : }
<a name="658"><span class="lineNum">     658 </span>            : </a>
<span class="lineNum">     659 </span>            : void
<span class="lineNum">     660 </span><span class="lineNoCov">          0 : nsContentUtils::GetShiftText(nsAString&amp; text)</span>
<span class="lineNum">     661 </span>            : {
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :   if (!sShiftText)</span>
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :     InitializeModifierStrings();</span>
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :   text.Assign(*sShiftText);</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 : }</span>
<a name="666"><span class="lineNum">     666 </span>            : </a>
<span class="lineNum">     667 </span>            : void
<span class="lineNum">     668 </span><span class="lineNoCov">          0 : nsContentUtils::GetControlText(nsAString&amp; text)</span>
<span class="lineNum">     669 </span>            : {
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :   if (!sControlText)</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :     InitializeModifierStrings();</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :   text.Assign(*sControlText);</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 : }</span>
<a name="674"><span class="lineNum">     674 </span>            : </a>
<span class="lineNum">     675 </span>            : void
<span class="lineNum">     676 </span><span class="lineNoCov">          0 : nsContentUtils::GetMetaText(nsAString&amp; text)</span>
<span class="lineNum">     677 </span>            : {
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :   if (!sMetaText)</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :     InitializeModifierStrings();</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :   text.Assign(*sMetaText);</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 : }</span>
<a name="682"><span class="lineNum">     682 </span>            : </a>
<span class="lineNum">     683 </span>            : void
<span class="lineNum">     684 </span><span class="lineNoCov">          0 : nsContentUtils::GetOSText(nsAString&amp; text)</span>
<span class="lineNum">     685 </span>            : {
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :   if (!sOSText) {</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :     InitializeModifierStrings();</span>
<span class="lineNum">     688 </span>            :   }
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :   text.Assign(*sOSText);</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 : }</span>
<a name="691"><span class="lineNum">     691 </span>            : </a>
<span class="lineNum">     692 </span>            : void
<span class="lineNum">     693 </span><span class="lineNoCov">          0 : nsContentUtils::GetAltText(nsAString&amp; text)</span>
<span class="lineNum">     694 </span>            : {
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :   if (!sAltText)</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :     InitializeModifierStrings();</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :   text.Assign(*sAltText);</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 : }</span>
<a name="699"><span class="lineNum">     699 </span>            : </a>
<span class="lineNum">     700 </span>            : void
<span class="lineNum">     701 </span><span class="lineNoCov">          0 : nsContentUtils::GetModifierSeparatorText(nsAString&amp; text)</span>
<span class="lineNum">     702 </span>            : {
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :   if (!sModifierSeparator)</span>
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :     InitializeModifierStrings();</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :   text.Assign(*sModifierSeparator);</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     707 </span>            : 
<span class="lineNum">     708 </span>            : void
<span class="lineNum">     709 </span><span class="lineNoCov">          0 : nsContentUtils::InitializeModifierStrings()</span>
<span class="lineNum">     710 </span>            : {
<span class="lineNum">     711 </span>            :   //load the display strings for the keyboard accelerators
<span class="lineNum">     712 </span>            :   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :     mozilla::services::GetStringBundleService();</span>
<span class="lineNum">     714 </span>            :   nsCOMPtr&lt;nsIStringBundle&gt; bundle;
<span class="lineNum">     715 </span>            :   DebugOnly&lt;nsresult&gt; rv = NS_OK;
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :   if (bundleService) {</span>
<span class="lineNum">     717 </span>            :     rv = bundleService-&gt;CreateBundle( &quot;chrome://global-platform/locale/platformKeys.properties&quot;,
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :                                       getter_AddRefs(bundle));</span>
<span class="lineNum">     719 </span>            :   }
<span class="lineNum">     720 </span>            : 
<span class="lineNum">     721 </span>            :   NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; bundle, &quot;chrome://global/locale/platformKeys.properties could not be loaded&quot;);
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :   nsXPIDLString shiftModifier;</span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :   nsXPIDLString metaModifier;</span>
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :   nsXPIDLString osModifier;</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :   nsXPIDLString altModifier;</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :   nsXPIDLString controlModifier;</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :   nsXPIDLString modifierSeparator;</span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :   if (bundle) {</span>
<span class="lineNum">     729 </span>            :     //macs use symbols for each modifier key, so fetch each from the bundle, which also covers i18n
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :     bundle-&gt;GetStringFromName(u&quot;VK_SHIFT&quot;, getter_Copies(shiftModifier));</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :     bundle-&gt;GetStringFromName(u&quot;VK_META&quot;, getter_Copies(metaModifier));</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :     bundle-&gt;GetStringFromName(u&quot;VK_WIN&quot;, getter_Copies(osModifier));</span>
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :     bundle-&gt;GetStringFromName(u&quot;VK_ALT&quot;, getter_Copies(altModifier));</span>
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :     bundle-&gt;GetStringFromName(u&quot;VK_CONTROL&quot;, getter_Copies(controlModifier));</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :     bundle-&gt;GetStringFromName(u&quot;MODIFIER_SEPARATOR&quot;, getter_Copies(modifierSeparator));</span>
<span class="lineNum">     736 </span>            :   }
<span class="lineNum">     737 </span>            :   //if any of these don't exist, we get  an empty string
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :   sShiftText = new nsString(shiftModifier);</span>
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :   sMetaText = new nsString(metaModifier);</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :   sOSText = new nsString(osModifier);</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :   sAltText = new nsString(altModifier);</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :   sControlText = new nsString(controlModifier);</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :   sModifierSeparator = new nsString(modifierSeparator);</span>
<span class="lineNum">     744 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     745 </span>            : 
<span class="lineNum">     746 </span>            : // Because of SVG/SMIL we have several atoms mapped to the same
<a name="747"><span class="lineNum">     747 </span>            : // id, but we can rely on MESSAGE_TO_EVENT to map id to only one atom.</a>
<span class="lineNum">     748 </span>            : static bool
<span class="lineNum">     749 </span><span class="lineCov">      11880 : ShouldAddEventToStringEventTable(const EventNameMapping&amp; aMapping)</span>
<span class="lineNum">     750 </span>            : {
<span class="lineNum">     751 </span><span class="lineCov">      11880 :   switch(aMapping.mMessage) {</span>
<span class="lineNum">     752 </span>            : #define MESSAGE_TO_EVENT(name_, message_, type_, struct_) \
<span class="lineNum">     753 </span>            :   case message_: return nsGkAtoms::on##name_ == aMapping.mAtom;
<span class="lineNum">     754 </span>            : #include &quot;mozilla/EventNameList.h&quot;
<span class="lineNum">     755 </span>            : #undef MESSAGE_TO_EVENT
<span class="lineNum">     756 </span>            :   default:
<span class="lineNum">     757 </span>            :     break;
<span class="lineNum">     758 </span>            :   }
<span class="lineNum">     759 </span>            :   return false;
<span class="lineNum">     760 </span>            : }
<a name="761"><span class="lineNum">     761 </span>            : </a>
<span class="lineNum">     762 </span>            : bool
<span class="lineNum">     763 </span><span class="lineCov">         60 : nsContentUtils::InitializeEventTable() {</span>
<span class="lineNum">     764 </span>            :   NS_ASSERTION(!sAtomEventTable, &quot;EventTable already initialized!&quot;);
<span class="lineNum">     765 </span>            :   NS_ASSERTION(!sStringEventTable, &quot;EventTable already initialized!&quot;);
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span>            :   static const EventNameMapping eventArray[] = {
<span class="lineNum">     768 </span>            : #define EVENT(name_,  _message, _type, _class)          \
<span class="lineNum">     769 </span>            :     { nsGkAtoms::on##name_, _type, _message, _class, false },
<span class="lineNum">     770 </span>            : #define WINDOW_ONLY_EVENT EVENT
<span class="lineNum">     771 </span>            : #define NON_IDL_EVENT EVENT
<span class="lineNum">     772 </span>            : #include &quot;mozilla/EventNameList.h&quot;
<span class="lineNum">     773 </span>            : #undef WINDOW_ONLY_EVENT
<span class="lineNum">     774 </span>            : #undef NON_IDL_EVENT
<span class="lineNum">     775 </span>            : #undef EVENT
<span class="lineNum">     776 </span>            :     { nullptr }
<span class="lineNum">     777 </span><span class="lineCov">         60 :   };</span>
<span class="lineNum">     778 </span>            : 
<span class="lineNum">     779 </span>            :   sAtomEventTable = new nsDataHashtable&lt;nsISupportsHashKey, EventNameMapping&gt;(
<span class="lineNum">     780 </span><span class="lineCov">        180 :       ArrayLength(eventArray));</span>
<span class="lineNum">     781 </span>            :   sStringEventTable = new nsDataHashtable&lt;nsStringHashKey, EventNameMapping&gt;(
<span class="lineNum">     782 </span><span class="lineCov">        180 :       ArrayLength(eventArray));</span>
<span class="lineNum">     783 </span><span class="lineCov">        120 :   sUserDefinedEvents = new nsCOMArray&lt;nsIAtom&gt;(64);</span>
<span class="lineNum">     784 </span>            : 
<span class="lineNum">     785 </span>            :   // Subtract one from the length because of the trailing null
<span class="lineNum">     786 </span><span class="lineCov">      11940 :   for (uint32_t i = 0; i &lt; ArrayLength(eventArray) - 1; ++i) {</span>
<span class="lineNum">     787 </span><span class="lineCov">      11880 :     sAtomEventTable-&gt;Put(eventArray[i].mAtom, eventArray[i]);</span>
<span class="lineNum">     788 </span><span class="lineCov">      11880 :     if (ShouldAddEventToStringEventTable(eventArray[i])) {</span>
<span class="lineNum">     789 </span>            :       sStringEventTable-&gt;Put(
<span class="lineNum">     790 </span>            :         Substring(nsDependentAtomString(eventArray[i].mAtom), 2),
<span class="lineNum">     791 </span><span class="lineCov">      45840 :         eventArray[i]);</span>
<span class="lineNum">     792 </span>            :     }
<span class="lineNum">     793 </span>            :   }
<span class="lineNum">     794 </span>            : 
<span class="lineNum">     795 </span><span class="lineCov">         60 :   return true;</span>
<span class="lineNum">     796 </span>            : }
<a name="797"><span class="lineNum">     797 </span>            : </a>
<span class="lineNum">     798 </span>            : void
<span class="lineNum">     799 </span><span class="lineNoCov">          0 : nsContentUtils::InitializeTouchEventTable()</span>
<span class="lineNum">     800 </span>            : {
<span class="lineNum">     801 </span>            :   static bool sEventTableInitialized = false;
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :   if (!sEventTableInitialized &amp;&amp; sAtomEventTable &amp;&amp; sStringEventTable) {</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :     sEventTableInitialized = true;</span>
<span class="lineNum">     804 </span>            :     static const EventNameMapping touchEventArray[] = {
<span class="lineNum">     805 </span>            : #define EVENT(name_,  _message, _type, _class)
<span class="lineNum">     806 </span>            : #define TOUCH_EVENT(name_,  _message, _type, _class)      \
<span class="lineNum">     807 </span>            :       { nsGkAtoms::on##name_, _type, _message, _class },
<span class="lineNum">     808 </span>            : #include &quot;mozilla/EventNameList.h&quot;
<span class="lineNum">     809 </span>            : #undef TOUCH_EVENT
<span class="lineNum">     810 </span>            : #undef EVENT
<span class="lineNum">     811 </span>            :       { nullptr }
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :     };</span>
<span class="lineNum">     813 </span>            :     // Subtract one from the length because of the trailing null
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :     for (uint32_t i = 0; i &lt; ArrayLength(touchEventArray) - 1; ++i) {</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :       sAtomEventTable-&gt;Put(touchEventArray[i].mAtom, touchEventArray[i]);</span>
<span class="lineNum">     816 </span>            :       sStringEventTable-&gt;Put(Substring(nsDependentAtomString(touchEventArray[i].mAtom), 2),
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :                              touchEventArray[i]);</span>
<span class="lineNum">     818 </span>            :     }
<span class="lineNum">     819 </span>            :   }
<span class="lineNum">     820 </span><span class="lineNoCov">          0 : }</span>
<a name="821"><span class="lineNum">     821 </span>            : </a>
<span class="lineNum">     822 </span>            : static bool
<span class="lineNum">     823 </span><span class="lineNoCov">          0 : Is8bit(const nsAString&amp; aString)</span>
<span class="lineNum">     824 </span>            : {
<span class="lineNum">     825 </span>            :   static const char16_t EIGHT_BIT = char16_t(~0x00FF);
<span class="lineNum">     826 </span>            : 
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :   for (nsAString::const_char_iterator start = aString.BeginReading(),</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :          end = aString.EndReading();</span>
<span class="lineNum">     829 </span>            :        start != end;
<span class="lineNum">     830 </span>            :        ++start) {
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :     if (*start &amp; EIGHT_BIT) {</span>
<span class="lineNum">     832 </span>            :       return false;
<span class="lineNum">     833 </span>            :     }
<span class="lineNum">     834 </span>            :   }
<span class="lineNum">     835 </span>            : 
<span class="lineNum">     836 </span>            :   return true;
<span class="lineNum">     837 </span>            : }
<a name="838"><span class="lineNum">     838 </span>            : </a>
<span class="lineNum">     839 </span>            : nsresult
<span class="lineNum">     840 </span><span class="lineNoCov">          0 : nsContentUtils::Btoa(const nsAString&amp; aBinaryData,</span>
<span class="lineNum">     841 </span>            :                      nsAString&amp; aAsciiBase64String)
<span class="lineNum">     842 </span>            : {
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :   if (!Is8bit(aBinaryData)) {</span>
<span class="lineNum">     844 </span>            :     aAsciiBase64String.Truncate();
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :     return NS_ERROR_DOM_INVALID_CHARACTER_ERR;</span>
<span class="lineNum">     846 </span>            :   }
<span class="lineNum">     847 </span>            : 
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :   return Base64Encode(aBinaryData, aAsciiBase64String);</span>
<span class="lineNum">     849 </span>            : }
<a name="850"><span class="lineNum">     850 </span>            : </a>
<span class="lineNum">     851 </span>            : nsresult
<span class="lineNum">     852 </span><span class="lineNoCov">          0 : nsContentUtils::Atob(const nsAString&amp; aAsciiBase64String,</span>
<span class="lineNum">     853 </span>            :                      nsAString&amp; aBinaryData)
<span class="lineNum">     854 </span>            : {
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :   if (!Is8bit(aAsciiBase64String)) {</span>
<span class="lineNum">     856 </span>            :     aBinaryData.Truncate();
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :     return NS_ERROR_DOM_INVALID_CHARACTER_ERR;</span>
<span class="lineNum">     858 </span>            :   }
<span class="lineNum">     859 </span>            : 
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :   const char16_t* start = aAsciiBase64String.BeginReading();</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :   const char16_t* end = aAsciiBase64String.EndReading();</span>
<span class="lineNum">     862 </span>            :   nsString trimmedString;
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :   if (!trimmedString.SetCapacity(aAsciiBase64String.Length(), fallible)) {</span>
<span class="lineNum">     864 </span>            :     return NS_ERROR_DOM_INVALID_CHARACTER_ERR;
<span class="lineNum">     865 </span>            :   }
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :   while (start &lt; end) {</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :     if (!nsContentUtils::IsHTMLWhitespace(*start)) {</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :       trimmedString.Append(*start);</span>
<span class="lineNum">     869 </span>            :     }
<span class="lineNum">     870 </span><span class="lineNoCov">          0 :     start++;</span>
<span class="lineNum">     871 </span>            :   }
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :   nsresult rv = Base64Decode(trimmedString, aBinaryData);</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv) &amp;&amp; rv == NS_ERROR_INVALID_ARG) {</span>
<span class="lineNum">     874 </span>            :     return NS_ERROR_DOM_INVALID_CHARACTER_ERR;
<span class="lineNum">     875 </span>            :   }
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :   return rv;</span>
<span class="lineNum">     877 </span>            : }
<span class="lineNum">     878 </span>            : 
<span class="lineNum">     879 </span>            : bool
<span class="lineNum">     880 </span><span class="lineNoCov">          0 : nsContentUtils::IsAutocompleteEnabled(nsIDOMHTMLInputElement* aInput)</span>
<span class="lineNum">     881 </span>            : {
<span class="lineNum">     882 </span>            :   NS_PRECONDITION(aInput, &quot;aInput should not be null!&quot;);
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :   nsAutoString autocomplete;</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :   aInput-&gt;GetAutocomplete(autocomplete);</span>
<span class="lineNum">     886 </span>            : 
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :   if (autocomplete.IsEmpty()) {</span>
<span class="lineNum">     888 </span>            :     nsCOMPtr&lt;nsIDOMHTMLFormElement&gt; form;
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :     aInput-&gt;GetForm(getter_AddRefs(form));</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :     if (!form) {</span>
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :       return true;</span>
<span class="lineNum">     892 </span>            :     }
<span class="lineNum">     893 </span>            : 
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :     form-&gt;GetAutocomplete(autocomplete);</span>
<span class="lineNum">     895 </span>            :   }
<span class="lineNum">     896 </span>            : 
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :   return !autocomplete.EqualsLiteral(&quot;off&quot;);</span>
<span class="lineNum">     898 </span>            : }
<a name="899"><span class="lineNum">     899 </span>            : </a>
<span class="lineNum">     900 </span>            : nsContentUtils::AutocompleteAttrState
<span class="lineNum">     901 </span><span class="lineNoCov">          0 : nsContentUtils::SerializeAutocompleteAttribute(const nsAttrValue* aAttr,</span>
<span class="lineNum">     902 </span>            :                                                nsAString&amp; aResult,
<span class="lineNum">     903 </span>            :                                                AutocompleteAttrState aCachedState)
<span class="lineNum">     904 </span>            : {
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :   if (!aAttr ||</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :       aCachedState == nsContentUtils::eAutocompleteAttrState_Invalid) {</span>
<span class="lineNum">     907 </span>            :     return aCachedState;
<span class="lineNum">     908 </span>            :   }
<span class="lineNum">     909 </span>            : 
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :   if (aCachedState == nsContentUtils::eAutocompleteAttrState_Valid) {</span>
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :     uint32_t atomCount = aAttr-&gt;GetAtomCount();</span>
<span class="lineNum">     912 </span><span class="lineNoCov">          0 :     for (uint32_t i = 0; i &lt; atomCount; i++) {</span>
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :       if (i != 0) {</span>
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :         aResult.Append(' ');</span>
<span class="lineNum">     915 </span>            :       }
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :       aResult.Append(nsDependentAtomString(aAttr-&gt;AtomAt(i)));</span>
<span class="lineNum">     917 </span>            :     }
<span class="lineNum">     918 </span>            :     nsContentUtils::ASCIIToLower(aResult);
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :     return aCachedState;</span>
<span class="lineNum">     920 </span>            :   }
<span class="lineNum">     921 </span>            : 
<span class="lineNum">     922 </span>            :   aResult.Truncate();
<span class="lineNum">     923 </span>            : 
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :   mozilla::dom::AutocompleteInfo info;</span>
<span class="lineNum">     925 </span>            :   AutocompleteAttrState state =
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :     InternalSerializeAutocompleteAttribute(aAttr, info);</span>
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :   if (state == eAutocompleteAttrState_Valid) {</span>
<span class="lineNum">     928 </span>            :     // Concatenate the info fields.
<span class="lineNum">     929 </span>            :     aResult = info.mSection;
<span class="lineNum">     930 </span>            : 
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :     if (!info.mAddressType.IsEmpty()) {</span>
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :       if (!aResult.IsEmpty()) {</span>
<span class="lineNum">     933 </span>            :         aResult += ' ';
<span class="lineNum">     934 </span>            :       }
<span class="lineNum">     935 </span>            :       aResult += info.mAddressType;
<span class="lineNum">     936 </span>            :     }
<span class="lineNum">     937 </span>            : 
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :     if (!info.mContactType.IsEmpty()) {</span>
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :       if (!aResult.IsEmpty()) {</span>
<span class="lineNum">     940 </span>            :         aResult += ' ';
<span class="lineNum">     941 </span>            :       }
<span class="lineNum">     942 </span>            :       aResult += info.mContactType;
<span class="lineNum">     943 </span>            :     }
<span class="lineNum">     944 </span>            : 
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :     if (!info.mFieldName.IsEmpty()) {</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :       if (!aResult.IsEmpty()) {</span>
<span class="lineNum">     947 </span>            :         aResult += ' ';
<span class="lineNum">     948 </span>            :       }
<span class="lineNum">     949 </span>            :       aResult += info.mFieldName;
<span class="lineNum">     950 </span>            :     }
<span class="lineNum">     951 </span>            :   }
<span class="lineNum">     952 </span>            : 
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :   return state;</span>
<span class="lineNum">     954 </span>            : }
<a name="955"><span class="lineNum">     955 </span>            : </a>
<span class="lineNum">     956 </span>            : nsContentUtils::AutocompleteAttrState
<span class="lineNum">     957 </span><span class="lineNoCov">          0 : nsContentUtils::SerializeAutocompleteAttribute(const nsAttrValue* aAttr,</span>
<span class="lineNum">     958 </span>            :                                                mozilla::dom::AutocompleteInfo&amp; aInfo,
<span class="lineNum">     959 </span>            :                                                AutocompleteAttrState aCachedState)
<span class="lineNum">     960 </span>            : {
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :   if (!aAttr ||</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :       aCachedState == nsContentUtils::eAutocompleteAttrState_Invalid) {</span>
<span class="lineNum">     963 </span>            :     return aCachedState;
<span class="lineNum">     964 </span>            :   }
<span class="lineNum">     965 </span>            : 
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :   return InternalSerializeAutocompleteAttribute(aAttr, aInfo);</span>
<span class="lineNum">     967 </span>            : }
<span class="lineNum">     968 </span>            : 
<span class="lineNum">     969 </span>            : /**
<span class="lineNum">     970 </span>            :  * Helper to validate the @autocomplete tokens.
<span class="lineNum">     971 </span>            :  *
<span class="lineNum">     972 </span>            :  * @return {AutocompleteAttrState} The state of the attribute (invalid/valid).
<a name="973"><span class="lineNum">     973 </span>            :  */</a>
<span class="lineNum">     974 </span>            : nsContentUtils::AutocompleteAttrState
<span class="lineNum">     975 </span><span class="lineNoCov">          0 : nsContentUtils::InternalSerializeAutocompleteAttribute(const nsAttrValue* aAttrVal,</span>
<span class="lineNum">     976 </span>            :                                                        mozilla::dom::AutocompleteInfo&amp; aInfo)
<span class="lineNum">     977 </span>            : {
<span class="lineNum">     978 </span>            :   // No sandbox attribute so we are done
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :   if (!aAttrVal) {</span>
<span class="lineNum">     980 </span>            :     return eAutocompleteAttrState_Invalid;
<span class="lineNum">     981 </span>            :   }
<span class="lineNum">     982 </span>            : 
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :   uint32_t numTokens = aAttrVal-&gt;GetAtomCount();</span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :   if (!numTokens) {</span>
<span class="lineNum">     985 </span>            :     return eAutocompleteAttrState_Invalid;
<span class="lineNum">     986 </span>            :   }
<span class="lineNum">     987 </span>            : 
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :   uint32_t index = numTokens - 1;</span>
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :   nsString tokenString = nsDependentAtomString(aAttrVal-&gt;AtomAt(index));</span>
<span class="lineNum">     990 </span>            :   AutocompleteCategory category;
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :   nsAttrValue enumValue;</span>
<span class="lineNum">     992 </span>            : 
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :   nsAutoString str;</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :   bool result = enumValue.ParseEnumValue(tokenString, kAutocompleteFieldNameTable, false);</span>
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :   if (result) {</span>
<span class="lineNum">     996 </span>            :     // Off/Automatic/Normal categories.
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :     if (enumValue.Equals(NS_LITERAL_STRING(&quot;off&quot;), eIgnoreCase) ||</span>
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :         enumValue.Equals(NS_LITERAL_STRING(&quot;on&quot;), eIgnoreCase)) {</span>
<span class="lineNum">     999 </span><span class="lineNoCov">          0 :       if (numTokens &gt; 1) {</span>
<span class="lineNum">    1000 </span>            :         return eAutocompleteAttrState_Invalid;
<span class="lineNum">    1001 </span>            :       }
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 :       enumValue.ToString(str);</span>
<span class="lineNum">    1003 </span>            :       ASCIIToLower(str);
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :       aInfo.mFieldName.Assign(str);</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :       return eAutocompleteAttrState_Valid;</span>
<span class="lineNum">    1006 </span>            :     }
<span class="lineNum">    1007 </span>            : 
<span class="lineNum">    1008 </span>            :     // Only allow on/off if experimental @autocomplete values aren't enabled.
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :     if (!sIsExperimentalAutocompleteEnabled) {</span>
<span class="lineNum">    1010 </span>            :       return eAutocompleteAttrState_Invalid;
<span class="lineNum">    1011 </span>            :     }
<span class="lineNum">    1012 </span>            : 
<span class="lineNum">    1013 </span>            :     // Normal category
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :     if (numTokens &gt; 2) {</span>
<span class="lineNum">    1015 </span>            :       return eAutocompleteAttrState_Invalid;
<span class="lineNum">    1016 </span>            :     }
<span class="lineNum">    1017 </span>            :     category = eAutocompleteCategory_NORMAL;
<span class="lineNum">    1018 </span>            :   } else { // Check if the last token is of the contact category instead.
<span class="lineNum">    1019 </span>            :     // Only allow on/off if experimental @autocomplete values aren't enabled.
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :     if (!sIsExperimentalAutocompleteEnabled) {</span>
<span class="lineNum">    1021 </span>            :       return eAutocompleteAttrState_Invalid;
<span class="lineNum">    1022 </span>            :     }
<span class="lineNum">    1023 </span>            : 
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :     result = enumValue.ParseEnumValue(tokenString, kAutocompleteContactFieldNameTable, false);</span>
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :     if (!result || numTokens &gt; 3) {</span>
<span class="lineNum">    1026 </span>            :       return eAutocompleteAttrState_Invalid;
<span class="lineNum">    1027 </span>            :     }
<span class="lineNum">    1028 </span>            : 
<span class="lineNum">    1029 </span>            :     category = eAutocompleteCategory_CONTACT;
<span class="lineNum">    1030 </span>            :   }
<span class="lineNum">    1031 </span>            : 
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :   enumValue.ToString(str);</span>
<span class="lineNum">    1033 </span>            :   ASCIIToLower(str);
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :   aInfo.mFieldName.Assign(str);</span>
<span class="lineNum">    1035 </span>            : 
<span class="lineNum">    1036 </span>            :   // We are done if this was the only token.
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :   if (numTokens == 1) {</span>
<span class="lineNum">    1038 </span>            :     return eAutocompleteAttrState_Valid;
<span class="lineNum">    1039 </span>            :   }
<span class="lineNum">    1040 </span>            : 
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :   --index;</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :   tokenString = nsDependentAtomString(aAttrVal-&gt;AtomAt(index));</span>
<span class="lineNum">    1043 </span>            : 
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :   if (category == eAutocompleteCategory_CONTACT) {</span>
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :     nsAttrValue contactFieldHint;</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :     result = contactFieldHint.ParseEnumValue(tokenString, kAutocompleteContactFieldHintTable, false);</span>
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :     if (result) {</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :       nsAutoString contactFieldHintString;</span>
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :       contactFieldHint.ToString(contactFieldHintString);</span>
<span class="lineNum">    1050 </span>            :       ASCIIToLower(contactFieldHintString);
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :       aInfo.mContactType.Assign(contactFieldHintString);</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :       if (index == 0) {</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :         return eAutocompleteAttrState_Valid;</span>
<span class="lineNum">    1054 </span>            :       }
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :       --index;</span>
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :       tokenString = nsDependentAtomString(aAttrVal-&gt;AtomAt(index));</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1058 </span>            :   }
<span class="lineNum">    1059 </span>            : 
<span class="lineNum">    1060 </span>            :   // Check for billing/shipping tokens
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :   nsAttrValue fieldHint;</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :   if (fieldHint.ParseEnumValue(tokenString, kAutocompleteFieldHintTable, false)) {</span>
<span class="lineNum">    1063 </span>            :     nsString fieldHintString;
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :     fieldHint.ToString(fieldHintString);</span>
<span class="lineNum">    1065 </span>            :     ASCIIToLower(fieldHintString);
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :     aInfo.mAddressType.Assign(fieldHintString);</span>
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :     if (index == 0) {</span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :       return eAutocompleteAttrState_Valid;</span>
<span class="lineNum">    1069 </span>            :     }
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :     --index;</span>
<span class="lineNum">    1071 </span>            :   }
<span class="lineNum">    1072 </span>            : 
<span class="lineNum">    1073 </span>            :   // Clear the fields as the autocomplete attribute is invalid.
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :   aInfo.mAddressType.Truncate();</span>
<span class="lineNum">    1075 </span><span class="lineNoCov">          0 :   aInfo.mContactType.Truncate();</span>
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :   aInfo.mFieldName.Truncate();</span>
<span class="lineNum">    1077 </span>            : 
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :   return eAutocompleteAttrState_Invalid;</span>
<span class="lineNum">    1079 </span>            : }
<span class="lineNum">    1080 </span>            : 
<a name="1081"><span class="lineNum">    1081 </span>            : // Parse an integer according to HTML spec</a>
<span class="lineNum">    1082 </span>            : int32_t
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 : nsContentUtils::ParseHTMLInteger(const nsAString&amp; aValue,</span>
<span class="lineNum">    1084 </span>            :                                  ParseHTMLIntegerResultFlags *aResult)
<span class="lineNum">    1085 </span>            : {
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :   int result = eParseHTMLInteger_NoFlags;</span>
<span class="lineNum">    1087 </span>            : 
<span class="lineNum">    1088 </span>            :   nsAString::const_iterator iter, end;
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :   aValue.BeginReading(iter);</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :   aValue.EndReading(end);</span>
<span class="lineNum">    1091 </span>            : 
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :   while (iter != end &amp;&amp; nsContentUtils::IsHTMLWhitespace(*iter)) {</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :     result |= eParseHTMLInteger_NonStandard;</span>
<span class="lineNum">    1094 </span>            :     ++iter;
<span class="lineNum">    1095 </span>            :   }
<span class="lineNum">    1096 </span>            : 
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :   if (iter == end) {</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :     result |= eParseHTMLInteger_Error | eParseHTMLInteger_ErrorNoValue;</span>
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :     *aResult = (ParseHTMLIntegerResultFlags)result;</span>
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 :     return 0;</span>
<span class="lineNum">    1101 </span>            :   }
<span class="lineNum">    1102 </span>            : 
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :   int sign = 1;</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :   if (*iter == char16_t('-')) {</span>
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :     sign = -1;</span>
<span class="lineNum">    1106 </span>            :     ++iter;
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :   } else if (*iter == char16_t('+')) {</span>
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :     result |= eParseHTMLInteger_NonStandard;</span>
<span class="lineNum">    1109 </span>            :     ++iter;
<span class="lineNum">    1110 </span>            :   }
<span class="lineNum">    1111 </span>            : 
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :   bool foundValue = false;</span>
<span class="lineNum">    1113 </span>            :   CheckedInt32 value = 0;
<span class="lineNum">    1114 </span>            : 
<span class="lineNum">    1115 </span>            :   // Check for leading zeros first.
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :   uint64_t leadingZeros = 0;</span>
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :   while (iter != end) {</span>
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :     if (*iter != char16_t('0')) {</span>
<span class="lineNum">    1119 </span>            :       break;
<span class="lineNum">    1120 </span>            :     }
<span class="lineNum">    1121 </span>            : 
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :     ++leadingZeros;</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :     foundValue = true;</span>
<span class="lineNum">    1124 </span>            :     ++iter;
<span class="lineNum">    1125 </span>            :   }
<span class="lineNum">    1126 </span>            : 
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 :   while (iter != end) {</span>
<span class="lineNum">    1128 </span><span class="lineNoCov">          0 :     if (*iter &gt;= char16_t('0') &amp;&amp; *iter &lt;= char16_t('9')) {</span>
<span class="lineNum">    1129 </span><span class="lineNoCov">          0 :       value = (value * 10) + (*iter - char16_t('0')) * sign;</span>
<span class="lineNum">    1130 </span>            :       ++iter;
<span class="lineNum">    1131 </span><span class="lineNoCov">          0 :       if (!value.isValid()) {</span>
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :         result |= eParseHTMLInteger_Error | eParseHTMLInteger_ErrorOverflow;</span>
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    1134 </span>            :       }
<span class="lineNum">    1135 </span>            :       foundValue = true;
<span class="lineNum">    1136 </span><span class="lineNoCov">          0 :     } else if (*iter == char16_t('%')) {</span>
<span class="lineNum">    1137 </span>            :       ++iter;
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :       result |= eParseHTMLInteger_IsPercent;</span>
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1140 </span>            :     } else {
<span class="lineNum">    1141 </span>            :       break;
<span class="lineNum">    1142 </span>            :     }
<span class="lineNum">    1143 </span>            :   }
<span class="lineNum">    1144 </span>            : 
<span class="lineNum">    1145 </span><span class="lineNoCov">          0 :   if (!foundValue) {</span>
<span class="lineNum">    1146 </span><span class="lineNoCov">          0 :     result |= eParseHTMLInteger_Error | eParseHTMLInteger_ErrorNoValue;</span>
<span class="lineNum">    1147 </span>            :   }
<span class="lineNum">    1148 </span>            : 
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :   if (value.isValid() &amp;&amp;</span>
<span class="lineNum">    1150 </span><span class="lineNoCov">          0 :        ((leadingZeros &gt; 1 || (leadingZeros == 1 &amp;&amp; !(value == 0))) ||</span>
<span class="lineNum">    1151 </span><span class="lineNoCov">          0 :        (sign == -1 &amp;&amp; value == 0))) {</span>
<span class="lineNum">    1152 </span><span class="lineNoCov">          0 :     result |= eParseHTMLInteger_NonStandard;</span>
<span class="lineNum">    1153 </span>            :   }
<span class="lineNum">    1154 </span>            : 
<span class="lineNum">    1155 </span><span class="lineNoCov">          0 :   if (iter != end) {</span>
<span class="lineNum">    1156 </span><span class="lineNoCov">          0 :     result |= eParseHTMLInteger_DidNotConsumeAllInput;</span>
<span class="lineNum">    1157 </span>            :   }
<span class="lineNum">    1158 </span>            : 
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :   *aResult = (ParseHTMLIntegerResultFlags)result;</span>
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :   return value.isValid() ? value.value() : 0;</span>
<span class="lineNum">    1161 </span>            : }
<span class="lineNum">    1162 </span>            : 
<span class="lineNum">    1163 </span>            : #define SKIP_WHITESPACE(iter, end_iter, end_res)                 \
<span class="lineNum">    1164 </span>            :   while ((iter) != (end_iter) &amp;&amp; nsCRT::IsAsciiSpace(*(iter))) { \
<span class="lineNum">    1165 </span>            :     ++(iter);                                                    \
<span class="lineNum">    1166 </span>            :   }                                                              \
<span class="lineNum">    1167 </span>            :   if ((iter) == (end_iter)) {                                    \
<span class="lineNum">    1168 </span>            :     return (end_res);                                            \
<span class="lineNum">    1169 </span>            :   }
<span class="lineNum">    1170 </span>            : 
<span class="lineNum">    1171 </span>            : #define SKIP_ATTR_NAME(iter, end_iter)                            \
<span class="lineNum">    1172 </span>            :   while ((iter) != (end_iter) &amp;&amp; !nsCRT::IsAsciiSpace(*(iter)) &amp;&amp; \
<span class="lineNum">    1173 </span>            :          *(iter) != '=') {                                        \
<span class="lineNum">    1174 </span>            :     ++(iter);                                                     \
<span class="lineNum">    1175 </span>            :   }
<a name="1176"><span class="lineNum">    1176 </span>            : </a>
<span class="lineNum">    1177 </span>            : bool
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 : nsContentUtils::GetPseudoAttributeValue(const nsString&amp; aSource, nsIAtom *aName,</span>
<span class="lineNum">    1179 </span>            :                                         nsAString&amp; aValue)
<span class="lineNum">    1180 </span>            : {
<span class="lineNum">    1181 </span>            :   aValue.Truncate();
<span class="lineNum">    1182 </span>            : 
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :   const char16_t *start = aSource.get();</span>
<span class="lineNum">    1184 </span><span class="lineNoCov">          0 :   const char16_t *end = start + aSource.Length();</span>
<span class="lineNum">    1185 </span>            :   const char16_t *iter;
<span class="lineNum">    1186 </span>            : 
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 :   while (start != end) {</span>
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :     SKIP_WHITESPACE(start, end, false)</span>
<span class="lineNum">    1189 </span><span class="lineNoCov">          0 :     iter = start;</span>
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 :     SKIP_ATTR_NAME(iter, end)</span>
<span class="lineNum">    1191 </span>            : 
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 :     if (start == iter) {</span>
<span class="lineNum">    1193 </span>            :       return false;
<span class="lineNum">    1194 </span>            :     }
<span class="lineNum">    1195 </span>            : 
<span class="lineNum">    1196 </span>            :     // Remember the attr name.
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :     const nsDependentSubstring &amp; attrName = Substring(start, iter);</span>
<span class="lineNum">    1198 </span>            : 
<span class="lineNum">    1199 </span>            :     // Now check whether this is a valid name=&quot;value&quot; pair.
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :     start = iter;</span>
<span class="lineNum">    1201 </span><span class="lineNoCov">          0 :     SKIP_WHITESPACE(start, end, false)</span>
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :     if (*start != '=') {</span>
<span class="lineNum">    1203 </span>            :       // No '=', so this is not a name=&quot;value&quot; pair.  We don't know
<span class="lineNum">    1204 </span>            :       // what it is, and we have no way to handle it.
<span class="lineNum">    1205 </span>            :       return false;
<span class="lineNum">    1206 </span>            :     }
<span class="lineNum">    1207 </span>            : 
<span class="lineNum">    1208 </span>            :     // Have to skip the value.
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :     ++start;</span>
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :     SKIP_WHITESPACE(start, end, false)</span>
<span class="lineNum">    1211 </span><span class="lineNoCov">          0 :     char16_t q = *start;</span>
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :     if (q != kQuote &amp;&amp; q != kApostrophe) {</span>
<span class="lineNum">    1213 </span>            :       // Not a valid quoted value, so bail.
<span class="lineNum">    1214 </span>            :       return false;
<span class="lineNum">    1215 </span>            :     }
<span class="lineNum">    1216 </span>            : 
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :     ++start;  // Point to the first char of the value.</span>
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :     iter = start;</span>
<span class="lineNum">    1219 </span>            : 
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :     while (iter != end &amp;&amp; *iter != q) {</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :       ++iter;</span>
<span class="lineNum">    1222 </span>            :     }
<span class="lineNum">    1223 </span>            : 
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :     if (iter == end) {</span>
<span class="lineNum">    1225 </span>            :       // Oops, unterminated quoted string.
<span class="lineNum">    1226 </span>            :       return false;
<span class="lineNum">    1227 </span>            :     }
<span class="lineNum">    1228 </span>            : 
<span class="lineNum">    1229 </span>            :     // At this point attrName holds the name of the &quot;attribute&quot; and
<span class="lineNum">    1230 </span>            :     // the value is between start and iter.
<span class="lineNum">    1231 </span>            : 
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :     if (aName-&gt;Equals(attrName)) {</span>
<span class="lineNum">    1233 </span>            :       // We'll accumulate as many characters as possible (until we hit either
<span class="lineNum">    1234 </span>            :       // the end of the string or the beginning of an entity). Chunks will be
<span class="lineNum">    1235 </span>            :       // delimited by start and chunkEnd.
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :       const char16_t *chunkEnd = start;</span>
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :       while (chunkEnd != iter) {</span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :         if (*chunkEnd == kLessThan) {</span>
<span class="lineNum">    1239 </span>            :           aValue.Truncate();
<span class="lineNum">    1240 </span>            : 
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :           return false;</span>
<span class="lineNum">    1242 </span>            :         }
<span class="lineNum">    1243 </span>            : 
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 :         if (*chunkEnd == kAmpersand) {</span>
<span class="lineNum">    1245 </span><span class="lineNoCov">          0 :           aValue.Append(start, chunkEnd - start);</span>
<span class="lineNum">    1246 </span>            : 
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 :           const char16_t *afterEntity = nullptr;</span>
<span class="lineNum">    1248 </span>            :           char16_t result[2];
<span class="lineNum">    1249 </span>            :           uint32_t count =
<span class="lineNum">    1250 </span>            :             MOZ_XMLTranslateEntity(reinterpret_cast&lt;const char*&gt;(chunkEnd),
<span class="lineNum">    1251 </span>            :                                    reinterpret_cast&lt;const char*&gt;(iter),
<span class="lineNum">    1252 </span>            :                                    reinterpret_cast&lt;const char**&gt;(&amp;afterEntity),
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :                                    result);</span>
<span class="lineNum">    1254 </span><span class="lineNoCov">          0 :           if (count == 0) {</span>
<span class="lineNum">    1255 </span>            :             aValue.Truncate();
<span class="lineNum">    1256 </span>            : 
<span class="lineNum">    1257 </span><span class="lineNoCov">          0 :             return false;</span>
<span class="lineNum">    1258 </span>            :           }
<span class="lineNum">    1259 </span>            : 
<span class="lineNum">    1260 </span><span class="lineNoCov">          0 :           aValue.Append(result, count);</span>
<span class="lineNum">    1261 </span>            : 
<span class="lineNum">    1262 </span>            :           // Advance to after the entity and begin a new chunk.
<span class="lineNum">    1263 </span><span class="lineNoCov">          0 :           start = chunkEnd = afterEntity;</span>
<span class="lineNum">    1264 </span>            :         }
<span class="lineNum">    1265 </span>            :         else {
<span class="lineNum">    1266 </span><span class="lineNoCov">          0 :           ++chunkEnd;</span>
<span class="lineNum">    1267 </span>            :         }
<span class="lineNum">    1268 </span>            :       }
<span class="lineNum">    1269 </span>            : 
<span class="lineNum">    1270 </span>            :       // Append remainder.
<span class="lineNum">    1271 </span><span class="lineNoCov">          0 :       aValue.Append(start, iter - start);</span>
<span class="lineNum">    1272 </span>            : 
<span class="lineNum">    1273 </span><span class="lineNoCov">          0 :       return true;</span>
<span class="lineNum">    1274 </span>            :     }
<span class="lineNum">    1275 </span>            : 
<span class="lineNum">    1276 </span>            :     // Resume scanning after the end of the attribute value (past the quote
<span class="lineNum">    1277 </span>            :     // char).
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :     start = iter + 1;</span>
<span class="lineNum">    1279 </span>            :   }
<span class="lineNum">    1280 </span>            : 
<span class="lineNum">    1281 </span>            :   return false;
<span class="lineNum">    1282 </span>            : }
<a name="1283"><span class="lineNum">    1283 </span>            : </a>
<span class="lineNum">    1284 </span>            : bool
<span class="lineNum">    1285 </span><span class="lineNoCov">          0 : nsContentUtils::IsJavaScriptLanguage(const nsString&amp; aName)</span>
<span class="lineNum">    1286 </span>            : {
<span class="lineNum">    1287 </span><span class="lineNoCov">          0 :   return aName.LowerCaseEqualsLiteral(&quot;javascript&quot;) ||</span>
<span class="lineNum">    1288 </span><span class="lineNoCov">          0 :          aName.LowerCaseEqualsLiteral(&quot;livescript&quot;) ||</span>
<span class="lineNum">    1289 </span><span class="lineNoCov">          0 :          aName.LowerCaseEqualsLiteral(&quot;mocha&quot;) ||</span>
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :          aName.LowerCaseEqualsLiteral(&quot;javascript1.0&quot;) ||</span>
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :          aName.LowerCaseEqualsLiteral(&quot;javascript1.1&quot;) ||</span>
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :          aName.LowerCaseEqualsLiteral(&quot;javascript1.2&quot;) ||</span>
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :          aName.LowerCaseEqualsLiteral(&quot;javascript1.3&quot;) ||</span>
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :          aName.LowerCaseEqualsLiteral(&quot;javascript1.4&quot;) ||</span>
<span class="lineNum">    1295 </span><span class="lineNoCov">          0 :          aName.LowerCaseEqualsLiteral(&quot;javascript1.5&quot;);</span>
<span class="lineNum">    1296 </span>            : }
<a name="1297"><span class="lineNum">    1297 </span>            : </a>
<span class="lineNum">    1298 </span>            : JSVersion
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 : nsContentUtils::ParseJavascriptVersion(const nsAString&amp; aVersionStr)</span>
<span class="lineNum">    1300 </span>            : {
<span class="lineNum">    1301 </span><span class="lineNoCov">          0 :   if (aVersionStr.Length() != 3 || aVersionStr[0] != '1' ||</span>
<span class="lineNum">    1302 </span><span class="lineNoCov">          0 :       aVersionStr[1] != '.') {</span>
<span class="lineNum">    1303 </span>            :     return JSVERSION_UNKNOWN;
<span class="lineNum">    1304 </span>            :   }
<span class="lineNum">    1305 </span>            : 
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 :   switch (aVersionStr[2]) {</span>
<span class="lineNum">    1307 </span>            :   case '0': /* fall through */
<span class="lineNum">    1308 </span>            :   case '1': /* fall through */
<span class="lineNum">    1309 </span>            :   case '2': /* fall through */
<span class="lineNum">    1310 </span>            :   case '3': /* fall through */
<span class="lineNum">    1311 </span>            :   case '4': /* fall through */
<span class="lineNum">    1312 </span>            :   case '5': return JSVERSION_DEFAULT;
<span class="lineNum">    1313 </span>            :   case '6': return JSVERSION_1_6;
<span class="lineNum">    1314 </span>            :   case '7': return JSVERSION_1_7;
<span class="lineNum">    1315 </span>            :   case '8': return JSVERSION_1_8;
<span class="lineNum">    1316 </span>            :   default:  return JSVERSION_UNKNOWN;
<span class="lineNum">    1317 </span>            :   }
<span class="lineNum">    1318 </span>            : }
<a name="1319"><span class="lineNum">    1319 </span>            : </a>
<span class="lineNum">    1320 </span>            : void
<span class="lineNum">    1321 </span><span class="lineNoCov">          0 : nsContentUtils::SplitMimeType(const nsAString&amp; aValue, nsString&amp; aType,</span>
<span class="lineNum">    1322 </span>            :                               nsString&amp; aParams)
<span class="lineNum">    1323 </span>            : {
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :   aType.Truncate();</span>
<span class="lineNum">    1325 </span><span class="lineNoCov">          0 :   aParams.Truncate();</span>
<span class="lineNum">    1326 </span><span class="lineNoCov">          0 :   int32_t semiIndex = aValue.FindChar(char16_t(';'));</span>
<span class="lineNum">    1327 </span><span class="lineNoCov">          0 :   if (-1 != semiIndex) {</span>
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :     aType = Substring(aValue, 0, semiIndex);</span>
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :     aParams = Substring(aValue, semiIndex + 1,</span>
<span class="lineNum">    1330 </span><span class="lineNoCov">          0 :                        aValue.Length() - (semiIndex + 1));</span>
<span class="lineNum">    1331 </span><span class="lineNoCov">          0 :     aParams.StripWhitespace();</span>
<span class="lineNum">    1332 </span>            :   }
<span class="lineNum">    1333 </span>            :   else {
<span class="lineNum">    1334 </span>            :     aType = aValue;
<span class="lineNum">    1335 </span>            :   }
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :   aType.StripWhitespace();</span>
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1338 </span>            : 
<span class="lineNum">    1339 </span>            : nsresult
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 : nsContentUtils::IsUserIdle(uint32_t aRequestedIdleTimeInMS, bool* aUserIsIdle)</span>
<span class="lineNum">    1341 </span>            : {
<span class="lineNum">    1342 </span>            :   nsresult rv;
<span class="lineNum">    1343 </span>            :   nsCOMPtr&lt;nsIIdleService&gt; idleService =
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :     do_GetService(&quot;@mozilla.org/widget/idleservice;1&quot;, &amp;rv);</span>
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1346 </span>            : 
<span class="lineNum">    1347 </span>            :   uint32_t idleTimeInMS;
<span class="lineNum">    1348 </span><span class="lineNoCov">          0 :   rv = idleService-&gt;GetIdleTime(&amp;idleTimeInMS);</span>
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1350 </span>            : 
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :   *aUserIsIdle = idleTimeInMS &gt;= aRequestedIdleTimeInMS;</span>
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1353 </span>            : }
<span class="lineNum">    1354 </span>            : 
<span class="lineNum">    1355 </span>            : /**
<span class="lineNum">    1356 </span>            :  * Access a cached parser service. Don't addref. We need only one
<span class="lineNum">    1357 </span>            :  * reference to it and this class has that one.
<span class="lineNum">    1358 </span>            :  */
<a name="1359"><span class="lineNum">    1359 </span>            : /* static */</a>
<span class="lineNum">    1360 </span>            : nsIParserService*
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 : nsContentUtils::GetParserService()</span>
<span class="lineNum">    1362 </span>            : {
<span class="lineNum">    1363 </span>            :   // XXX: This isn't accessed from several threads, is it?
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :   if (!sParserService) {</span>
<span class="lineNum">    1365 </span>            :     // Lock, recheck sCachedParserService and aquire if this should be
<span class="lineNum">    1366 </span>            :     // safe for multiple threads.
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :     nsresult rv = CallGetService(kParserServiceCID, &amp;sParserService);</span>
<span class="lineNum">    1368 </span><span class="lineNoCov">          0 :     if (NS_FAILED(rv)) {</span>
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :       sParserService = nullptr;</span>
<span class="lineNum">    1370 </span>            :     }
<span class="lineNum">    1371 </span>            :   }
<span class="lineNum">    1372 </span>            : 
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :   return sParserService;</span>
<span class="lineNum">    1374 </span>            : }
<span class="lineNum">    1375 </span>            : 
<span class="lineNum">    1376 </span>            : /**
<span class="lineNum">    1377 </span>            : * A helper function that parses a sandbox attribute (of an &lt;iframe&gt; or a CSP
<span class="lineNum">    1378 </span>            : * directive) and converts it to the set of flags used internally.
<span class="lineNum">    1379 </span>            : *
<span class="lineNum">    1380 </span>            : * @param aSandboxAttr  the sandbox attribute
<span class="lineNum">    1381 </span>            : * @return              the set of flags (SANDBOXED_NONE if aSandboxAttr is
<span class="lineNum">    1382 </span>            : *                      null)
<a name="1383"><span class="lineNum">    1383 </span>            : */</a>
<span class="lineNum">    1384 </span>            : uint32_t
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 : nsContentUtils::ParseSandboxAttributeToFlags(const nsAttrValue* aSandboxAttr)</span>
<span class="lineNum">    1386 </span>            : {
<span class="lineNum">    1387 </span><span class="lineNoCov">          0 :   if (!aSandboxAttr) {</span>
<span class="lineNum">    1388 </span>            :     return SANDBOXED_NONE;
<span class="lineNum">    1389 </span>            :   }
<span class="lineNum">    1390 </span>            : 
<span class="lineNum">    1391 </span><span class="lineNoCov">          0 :   uint32_t out = SANDBOX_ALL_FLAGS;</span>
<span class="lineNum">    1392 </span>            : 
<span class="lineNum">    1393 </span>            : #define SANDBOX_KEYWORD(string, atom, flags)                  \
<span class="lineNum">    1394 </span>            :   if (aSandboxAttr-&gt;Contains(nsGkAtoms::atom, eIgnoreCase)) { \
<span class="lineNum">    1395 </span>            :     out &amp;= ~(flags);                                          \
<span class="lineNum">    1396 </span>            :   }
<span class="lineNum">    1397 </span>            : #include &quot;IframeSandboxKeywordList.h&quot;
<span class="lineNum">    1398 </span>            : #undef SANDBOX_KEYWORD
<span class="lineNum">    1399 </span>            : 
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :   return out;</span>
<span class="lineNum">    1401 </span>            : }
<span class="lineNum">    1402 </span>            : 
<span class="lineNum">    1403 </span>            : /**
<span class="lineNum">    1404 </span>            : * A helper function that checks if a string matches a valid sandbox flag.
<span class="lineNum">    1405 </span>            : *
<span class="lineNum">    1406 </span>            : * @param aFlag   the potential sandbox flag.
<span class="lineNum">    1407 </span>            : * @return        true if the flag is a sandbox flag.
<a name="1408"><span class="lineNum">    1408 </span>            : */</a>
<span class="lineNum">    1409 </span>            : bool
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 : nsContentUtils::IsValidSandboxFlag(const nsAString&amp; aFlag)</span>
<span class="lineNum">    1411 </span>            : {
<span class="lineNum">    1412 </span>            : #define SANDBOX_KEYWORD(string, atom, flags)                                  \
<span class="lineNum">    1413 </span>            :   if (EqualsIgnoreASCIICase(nsDependentAtomString(nsGkAtoms::atom), aFlag)) { \
<span class="lineNum">    1414 </span>            :     return true;                                                              \
<span class="lineNum">    1415 </span>            :   }
<span class="lineNum">    1416 </span>            : #include &quot;IframeSandboxKeywordList.h&quot;
<span class="lineNum">    1417 </span>            : #undef SANDBOX_KEYWORD
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :   return false;</span>
<span class="lineNum">    1419 </span>            : }
<span class="lineNum">    1420 </span>            : 
<span class="lineNum">    1421 </span>            : /**
<span class="lineNum">    1422 </span>            :  * A helper function that returns a string attribute corresponding to the
<span class="lineNum">    1423 </span>            :  * sandbox flags.
<span class="lineNum">    1424 </span>            :  *
<span class="lineNum">    1425 </span>            :  * @param aFlags    the sandbox flags
<span class="lineNum">    1426 </span>            :  * @param aString   the attribute corresponding to the flags (null if aFlags
<span class="lineNum">    1427 </span>            :  *                  is zero)
<a name="1428"><span class="lineNum">    1428 </span>            :  */</a>
<span class="lineNum">    1429 </span>            : void
<span class="lineNum">    1430 </span><span class="lineNoCov">          0 : nsContentUtils::SandboxFlagsToString(uint32_t aFlags, nsAString&amp; aString)</span>
<span class="lineNum">    1431 </span>            : {
<span class="lineNum">    1432 </span><span class="lineNoCov">          0 :   if (!aFlags) {</span>
<span class="lineNum">    1433 </span><span class="lineNoCov">          0 :     SetDOMStringToNull(aString);</span>
<span class="lineNum">    1434 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    1435 </span>            :   }
<span class="lineNum">    1436 </span>            : 
<span class="lineNum">    1437 </span>            :   aString.Truncate();
<span class="lineNum">    1438 </span>            : 
<span class="lineNum">    1439 </span>            : #define SANDBOX_KEYWORD(string, atom, flags)                \
<span class="lineNum">    1440 </span>            :   if (!(aFlags &amp; (flags))) {                                \
<span class="lineNum">    1441 </span>            :     if (!aString.IsEmpty()) {                               \
<span class="lineNum">    1442 </span>            :       aString.Append(NS_LITERAL_STRING(&quot; &quot;));               \
<span class="lineNum">    1443 </span>            :     }                                                       \
<span class="lineNum">    1444 </span>            :     aString.Append(nsDependentAtomString(nsGkAtoms::atom)); \
<span class="lineNum">    1445 </span>            :   }
<span class="lineNum">    1446 </span>            : #include &quot;IframeSandboxKeywordList.h&quot;
<span class="lineNum">    1447 </span>            : #undef SANDBOX_KEYWORD
<span class="lineNum">    1448 </span>            : }
<a name="1449"><span class="lineNum">    1449 </span>            : </a>
<span class="lineNum">    1450 </span>            : nsIBidiKeyboard*
<span class="lineNum">    1451 </span><span class="lineCov">          5 : nsContentUtils::GetBidiKeyboard()</span>
<span class="lineNum">    1452 </span>            : {
<span class="lineNum">    1453 </span><span class="lineCov">          5 :   if (!sBidiKeyboard) {</span>
<span class="lineNum">    1454 </span><span class="lineCov">          5 :     nsresult rv = CallGetService(&quot;@mozilla.org/widget/bidikeyboard;1&quot;, &amp;sBidiKeyboard);</span>
<span class="lineNum">    1455 </span><span class="lineCov">          5 :     if (NS_FAILED(rv)) {</span>
<span class="lineNum">    1456 </span><span class="lineNoCov">          0 :       sBidiKeyboard = nullptr;</span>
<span class="lineNum">    1457 </span>            :     }
<span class="lineNum">    1458 </span>            :   }
<span class="lineNum">    1459 </span><span class="lineCov">          5 :   return sBidiKeyboard;</span>
<span class="lineNum">    1460 </span>            : }
<span class="lineNum">    1461 </span>            : 
<span class="lineNum">    1462 </span>            : template &lt;class OutputIterator&gt;
<span class="lineNum">    1463 </span>            : struct NormalizeNewlinesCharTraits {
<span class="lineNum">    1464 </span>            :   public:
<span class="lineNum">    1465 </span>            :     typedef typename OutputIterator::value_type value_type;
<a name="1466"><span class="lineNum">    1466 </span>            : </a>
<span class="lineNum">    1467 </span>            :   public:
<a name="1468"><span class="lineNum">    1468 </span><span class="lineNoCov">          0 :     explicit NormalizeNewlinesCharTraits(OutputIterator&amp; aIterator) : mIterator(aIterator) { }</span></a>
<span class="lineNum">    1469 </span>            :     void writechar(typename OutputIterator::value_type aChar) {
<span class="lineNum">    1470 </span><span class="lineNoCov">          0 :       *mIterator++ = aChar;</span>
<span class="lineNum">    1471 </span>            :     }
<span class="lineNum">    1472 </span>            : 
<span class="lineNum">    1473 </span>            :   private:
<span class="lineNum">    1474 </span>            :     OutputIterator mIterator;
<span class="lineNum">    1475 </span>            : };
<span class="lineNum">    1476 </span>            : 
<span class="lineNum">    1477 </span>            : template &lt;class CharT&gt;
<span class="lineNum">    1478 </span>            : struct NormalizeNewlinesCharTraits&lt;CharT*&gt; {
<span class="lineNum">    1479 </span>            :   public:
<span class="lineNum">    1480 </span>            :     typedef CharT value_type;
<a name="1481"><span class="lineNum">    1481 </span>            : </a>
<span class="lineNum">    1482 </span>            :   public:
<a name="1483"><span class="lineNum">    1483 </span><span class="lineNoCov">          0 :     explicit NormalizeNewlinesCharTraits(CharT* aCharPtr) : mCharPtr(aCharPtr) { }</span></a>
<span class="lineNum">    1484 </span>            :     void writechar(CharT aChar) {
<span class="lineNum">    1485 </span><span class="lineNoCov">          0 :       *mCharPtr++ = aChar;</span>
<span class="lineNum">    1486 </span>            :     }
<span class="lineNum">    1487 </span>            : 
<span class="lineNum">    1488 </span>            :   private:
<span class="lineNum">    1489 </span>            :     CharT* mCharPtr;
<span class="lineNum">    1490 </span>            : };
<span class="lineNum">    1491 </span>            : 
<span class="lineNum">    1492 </span>            : template &lt;class OutputIterator&gt;
<span class="lineNum">    1493 </span>            : class CopyNormalizeNewlines
<span class="lineNum">    1494 </span>            : {
<span class="lineNum">    1495 </span>            :   public:
<span class="lineNum">    1496 </span>            :     typedef typename OutputIterator::value_type value_type;
<span class="lineNum">    1497 </span>            : 
<span class="lineNum">    1498 </span>            :   public:
<span class="lineNum">    1499 </span>            :     explicit CopyNormalizeNewlines(OutputIterator* aDestination,
<span class="lineNum">    1500 </span>            :                                    bool aLastCharCR = false) :
<span class="lineNum">    1501 </span>            :       mLastCharCR(aLastCharCR),
<span class="lineNum">    1502 </span>            :       mDestination(aDestination),
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :       mWritten(0)</span>
<span class="lineNum">    1504 </span>            :     { }
<span class="lineNum">    1505 </span>            : 
<span class="lineNum">    1506 </span>            :     uint32_t GetCharsWritten() {
<span class="lineNum">    1507 </span>            :       return mWritten;
<span class="lineNum">    1508 </span>            :     }
<span class="lineNum">    1509 </span>            : 
<span class="lineNum">    1510 </span>            :     bool IsLastCharCR() {
<span class="lineNum">    1511 </span>            :       return mLastCharCR;
<span class="lineNum">    1512 </span>            :     }
<span class="lineNum">    1513 </span>            : 
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :     void write(const typename OutputIterator::value_type* aSource, uint32_t aSourceLength) {</span>
<span class="lineNum">    1515 </span>            : 
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :       const typename OutputIterator::value_type* done_writing = aSource + aSourceLength;</span>
<span class="lineNum">    1517 </span>            : 
<span class="lineNum">    1518 </span>            :       // If the last source buffer ended with a CR...
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :       if (mLastCharCR) {</span>
<span class="lineNum">    1520 </span>            :         // ..and if the next one is a LF, then skip it since
<span class="lineNum">    1521 </span>            :         // we've already written out a newline
<span class="lineNum">    1522 </span><span class="lineNoCov">          0 :         if (aSourceLength &amp;&amp; (*aSource == value_type('\n'))) {</span>
<span class="lineNum">    1523 </span><span class="lineNoCov">          0 :           ++aSource;</span>
<span class="lineNum">    1524 </span>            :         }
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :         mLastCharCR = false;</span>
<span class="lineNum">    1526 </span>            :       }
<span class="lineNum">    1527 </span>            : 
<span class="lineNum">    1528 </span>            :       uint32_t num_written = 0;
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :       while ( aSource &lt; done_writing ) {</span>
<span class="lineNum">    1530 </span><span class="lineNoCov">          0 :         if (*aSource == value_type('\r')) {</span>
<span class="lineNum">    1531 </span><span class="lineNoCov">          0 :           mDestination-&gt;writechar('\n');</span>
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 :           ++aSource;</span>
<span class="lineNum">    1533 </span>            :           // If we've reached the end of the buffer, record
<span class="lineNum">    1534 </span>            :           // that we wrote out a CR
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :           if (aSource == done_writing) {</span>
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :             mLastCharCR = true;</span>
<span class="lineNum">    1537 </span>            :           }
<span class="lineNum">    1538 </span>            :           // If the next character is a LF, skip it
<span class="lineNum">    1539 </span><span class="lineNoCov">          0 :           else if (*aSource == value_type('\n')) {</span>
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :             ++aSource;</span>
<span class="lineNum">    1541 </span>            :           }
<span class="lineNum">    1542 </span>            :         }
<span class="lineNum">    1543 </span>            :         else {
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :           mDestination-&gt;writechar(*aSource++);</span>
<span class="lineNum">    1545 </span>            :         }
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 :         ++num_written;</span>
<span class="lineNum">    1547 </span>            :       }
<span class="lineNum">    1548 </span>            : 
<span class="lineNum">    1549 </span><span class="lineNoCov">          0 :       mWritten += num_written;</span>
<span class="lineNum">    1550 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1551 </span>            : 
<span class="lineNum">    1552 </span>            :   private:
<span class="lineNum">    1553 </span>            :     bool mLastCharCR;
<span class="lineNum">    1554 </span>            :     OutputIterator* mDestination;
<span class="lineNum">    1555 </span>            :     uint32_t mWritten;
<span class="lineNum">    1556 </span>            : };
<span class="lineNum">    1557 </span>            : 
<span class="lineNum">    1558 </span>            : // static
<span class="lineNum">    1559 </span>            : uint32_t
<span class="lineNum">    1560 </span><span class="lineNoCov">          0 : nsContentUtils::CopyNewlineNormalizedUnicodeTo(const nsAString&amp; aSource,</span>
<span class="lineNum">    1561 </span>            :                                                uint32_t aSrcOffset,
<span class="lineNum">    1562 </span>            :                                                char16_t* aDest,
<span class="lineNum">    1563 </span>            :                                                uint32_t aLength,
<span class="lineNum">    1564 </span>            :                                                bool&amp; aLastCharCR)
<span class="lineNum">    1565 </span>            : {
<span class="lineNum">    1566 </span>            :   typedef NormalizeNewlinesCharTraits&lt;char16_t*&gt; sink_traits;
<span class="lineNum">    1567 </span>            : 
<span class="lineNum">    1568 </span>            :   sink_traits dest_traits(aDest);
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :   CopyNormalizeNewlines&lt;sink_traits&gt; normalizer(&amp;dest_traits,aLastCharCR);</span>
<span class="lineNum">    1570 </span>            :   nsReadingIterator&lt;char16_t&gt; fromBegin, fromEnd;
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :   copy_string(aSource.BeginReading(fromBegin).advance( int32_t(aSrcOffset) ),</span>
<span class="lineNum">    1572 </span><span class="lineNoCov">          0 :               aSource.BeginReading(fromEnd).advance( int32_t(aSrcOffset+aLength) ),</span>
<span class="lineNum">    1573 </span><span class="lineNoCov">          0 :               normalizer);</span>
<span class="lineNum">    1574 </span><span class="lineNoCov">          0 :   aLastCharCR = normalizer.IsLastCharCR();</span>
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 :   return normalizer.GetCharsWritten();</span>
<span class="lineNum">    1576 </span>            : }
<span class="lineNum">    1577 </span>            : 
<span class="lineNum">    1578 </span>            : // static
<span class="lineNum">    1579 </span>            : uint32_t
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 : nsContentUtils::CopyNewlineNormalizedUnicodeTo(nsReadingIterator&lt;char16_t&gt;&amp; aSrcStart, const nsReadingIterator&lt;char16_t&gt;&amp; aSrcEnd, nsAString&amp; aDest)</span>
<span class="lineNum">    1581 </span>            : {
<span class="lineNum">    1582 </span>            :   typedef nsWritingIterator&lt;char16_t&gt; WritingIterator;
<span class="lineNum">    1583 </span>            :   typedef NormalizeNewlinesCharTraits&lt;WritingIterator&gt; sink_traits;
<span class="lineNum">    1584 </span>            : 
<span class="lineNum">    1585 </span>            :   WritingIterator iter;
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :   aDest.BeginWriting(iter);</span>
<span class="lineNum">    1587 </span>            :   sink_traits dest_traits(iter);
<span class="lineNum">    1588 </span>            :   CopyNormalizeNewlines&lt;sink_traits&gt; normalizer(&amp;dest_traits);
<span class="lineNum">    1589 </span><span class="lineNoCov">          0 :   copy_string(aSrcStart, aSrcEnd, normalizer);</span>
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :   return normalizer.GetCharsWritten();</span>
<span class="lineNum">    1591 </span>            : }
<span class="lineNum">    1592 </span>            : 
<span class="lineNum">    1593 </span>            : /**
<span class="lineNum">    1594 </span>            :  * This is used to determine whether a character is in one of the classes
<span class="lineNum">    1595 </span>            :  * which CSS says should be part of the first-letter.  Currently, that is
<span class="lineNum">    1596 </span>            :  * all punctuation classes (P*).  Note that this is a change from CSS2
<span class="lineNum">    1597 </span>            :  * which excluded Pc and Pd.
<span class="lineNum">    1598 </span>            :  *
<span class="lineNum">    1599 </span>            :  * https://www.w3.org/TR/css-pseudo-4/#first-letter-pseudo
<span class="lineNum">    1600 </span>            :  * &quot;Punctuation (i.e, characters that belong to the Punctuation (P*) Unicode
<span class="lineNum">    1601 </span>            :  *  general category [UAX44]) [...]&quot;
<span class="lineNum">    1602 </span>            :  */
<span class="lineNum">    1603 </span>            : 
<a name="1604"><span class="lineNum">    1604 </span>            : // static</a>
<span class="lineNum">    1605 </span>            : bool
<span class="lineNum">    1606 </span><span class="lineNoCov">          0 : nsContentUtils::IsFirstLetterPunctuation(uint32_t aChar)</span>
<span class="lineNum">    1607 </span>            : {
<span class="lineNum">    1608 </span><span class="lineNoCov">          0 :   switch (mozilla::unicode::GetGeneralCategory(aChar)) {</span>
<span class="lineNum">    1609 </span>            :     case HB_UNICODE_GENERAL_CATEGORY_CONNECT_PUNCTUATION: /* Pc */
<span class="lineNum">    1610 </span>            :     case HB_UNICODE_GENERAL_CATEGORY_DASH_PUNCTUATION:    /* Pd */
<span class="lineNum">    1611 </span>            :     case HB_UNICODE_GENERAL_CATEGORY_CLOSE_PUNCTUATION:   /* Pe */
<span class="lineNum">    1612 </span>            :     case HB_UNICODE_GENERAL_CATEGORY_FINAL_PUNCTUATION:   /* Pf */
<span class="lineNum">    1613 </span>            :     case HB_UNICODE_GENERAL_CATEGORY_INITIAL_PUNCTUATION: /* Pi */
<span class="lineNum">    1614 </span>            :     case HB_UNICODE_GENERAL_CATEGORY_OTHER_PUNCTUATION:   /* Po */
<span class="lineNum">    1615 </span>            :     case HB_UNICODE_GENERAL_CATEGORY_OPEN_PUNCTUATION:    /* Ps */
<span class="lineNum">    1616 </span>            :       return true;
<span class="lineNum">    1617 </span>            :     default:
<span class="lineNum">    1618 </span><span class="lineNoCov">          0 :       return false;</span>
<span class="lineNum">    1619 </span>            :   }
<span class="lineNum">    1620 </span>            : }
<span class="lineNum">    1621 </span>            : 
<a name="1622"><span class="lineNum">    1622 </span>            : // static</a>
<span class="lineNum">    1623 </span>            : bool
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 : nsContentUtils::IsFirstLetterPunctuationAt(const nsTextFragment* aFrag, uint32_t aOffset)</span>
<span class="lineNum">    1625 </span>            : {
<span class="lineNum">    1626 </span><span class="lineNoCov">          0 :   char16_t h = aFrag-&gt;CharAt(aOffset);</span>
<span class="lineNum">    1627 </span><span class="lineNoCov">          0 :   if (!IS_SURROGATE(h)) {</span>
<span class="lineNum">    1628 </span><span class="lineNoCov">          0 :     return IsFirstLetterPunctuation(h);</span>
<span class="lineNum">    1629 </span>            :   }
<span class="lineNum">    1630 </span><span class="lineNoCov">          0 :   if (NS_IS_HIGH_SURROGATE(h) &amp;&amp; aOffset + 1 &lt; aFrag-&gt;GetLength()) {</span>
<span class="lineNum">    1631 </span><span class="lineNoCov">          0 :     char16_t l = aFrag-&gt;CharAt(aOffset + 1);</span>
<span class="lineNum">    1632 </span><span class="lineNoCov">          0 :     if (NS_IS_LOW_SURROGATE(l)) {</span>
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :       return IsFirstLetterPunctuation(SURROGATE_TO_UCS4(h, l));</span>
<span class="lineNum">    1634 </span>            :     }
<span class="lineNum">    1635 </span>            :   }
<span class="lineNum">    1636 </span>            :   return false;
<span class="lineNum">    1637 </span>            : }
<a name="1638"><span class="lineNum">    1638 </span>            : </a>
<span class="lineNum">    1639 </span>            : // static
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 : bool nsContentUtils::IsAlphanumeric(uint32_t aChar)</span>
<span class="lineNum">    1641 </span>            : {
<span class="lineNum">    1642 </span><span class="lineNoCov">          0 :   nsIUGenCategory::nsUGenCategory cat = mozilla::unicode::GetGenCategory(aChar);</span>
<span class="lineNum">    1643 </span>            : 
<span class="lineNum">    1644 </span><span class="lineNoCov">          0 :   return (cat == nsIUGenCategory::kLetter || cat == nsIUGenCategory::kNumber);</span>
<span class="lineNum">    1645 </span>            : }
<a name="1646"><span class="lineNum">    1646 </span>            : </a>
<span class="lineNum">    1647 </span>            : // static
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 : bool nsContentUtils::IsAlphanumericAt(const nsTextFragment* aFrag, uint32_t aOffset)</span>
<span class="lineNum">    1649 </span>            : {
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :   char16_t h = aFrag-&gt;CharAt(aOffset);</span>
<span class="lineNum">    1651 </span><span class="lineNoCov">          0 :   if (!IS_SURROGATE(h)) {</span>
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :     return IsAlphanumeric(h);</span>
<span class="lineNum">    1653 </span>            :   }
<span class="lineNum">    1654 </span><span class="lineNoCov">          0 :   if (NS_IS_HIGH_SURROGATE(h) &amp;&amp; aOffset + 1 &lt; aFrag-&gt;GetLength()) {</span>
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :     char16_t l = aFrag-&gt;CharAt(aOffset + 1);</span>
<span class="lineNum">    1656 </span><span class="lineNoCov">          0 :     if (NS_IS_LOW_SURROGATE(l)) {</span>
<span class="lineNum">    1657 </span><span class="lineNoCov">          0 :       return IsAlphanumeric(SURROGATE_TO_UCS4(h, l));</span>
<span class="lineNum">    1658 </span>            :     }
<span class="lineNum">    1659 </span>            :   }
<span class="lineNum">    1660 </span>            :   return false;
<span class="lineNum">    1661 </span>            : }
<span class="lineNum">    1662 </span>            : 
<a name="1663"><span class="lineNum">    1663 </span>            : /* static */</a>
<span class="lineNum">    1664 </span>            : bool
<span class="lineNum">    1665 </span><span class="lineNoCov">          0 : nsContentUtils::IsHTMLWhitespace(char16_t aChar)</span>
<span class="lineNum">    1666 </span>            : {
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 :   return aChar == char16_t(0x0009) ||</span>
<span class="lineNum">    1668 </span><span class="lineNoCov">          0 :          aChar == char16_t(0x000A) ||</span>
<span class="lineNum">    1669 </span><span class="lineNoCov">          0 :          aChar == char16_t(0x000C) ||</span>
<span class="lineNum">    1670 </span><span class="lineNoCov">          0 :          aChar == char16_t(0x000D) ||</span>
<span class="lineNum">    1671 </span><span class="lineNoCov">          0 :          aChar == char16_t(0x0020);</span>
<span class="lineNum">    1672 </span>            : }
<span class="lineNum">    1673 </span>            : 
<a name="1674"><span class="lineNum">    1674 </span>            : /* static */</a>
<span class="lineNum">    1675 </span>            : bool
<span class="lineNum">    1676 </span><span class="lineNoCov">          0 : nsContentUtils::IsHTMLWhitespaceOrNBSP(char16_t aChar)</span>
<span class="lineNum">    1677 </span>            : {
<span class="lineNum">    1678 </span><span class="lineNoCov">          0 :   return IsHTMLWhitespace(aChar) || aChar == char16_t(0xA0);</span>
<span class="lineNum">    1679 </span>            : }
<span class="lineNum">    1680 </span>            : 
<a name="1681"><span class="lineNum">    1681 </span>            : /* static */</a>
<span class="lineNum">    1682 </span>            : bool
<span class="lineNum">    1683 </span><span class="lineNoCov">          0 : nsContentUtils::IsHTMLBlock(nsIContent* aContent)</span>
<span class="lineNum">    1684 </span>            : {
<span class="lineNum">    1685 </span>            :   return aContent-&gt;IsAnyOfHTMLElements(nsGkAtoms::address,
<span class="lineNum">    1686 </span>            :                                        nsGkAtoms::article,
<span class="lineNum">    1687 </span>            :                                        nsGkAtoms::aside,
<span class="lineNum">    1688 </span>            :                                        nsGkAtoms::blockquote,
<span class="lineNum">    1689 </span>            :                                        nsGkAtoms::center,
<span class="lineNum">    1690 </span>            :                                        nsGkAtoms::dir,
<span class="lineNum">    1691 </span>            :                                        nsGkAtoms::div,
<span class="lineNum">    1692 </span>            :                                        nsGkAtoms::dl, // XXX why not dt and dd?
<span class="lineNum">    1693 </span>            :                                        nsGkAtoms::fieldset,
<span class="lineNum">    1694 </span>            :                                        nsGkAtoms::figure, // XXX shouldn't figcaption be on this list
<span class="lineNum">    1695 </span>            :                                        nsGkAtoms::footer,
<span class="lineNum">    1696 </span>            :                                        nsGkAtoms::form,
<span class="lineNum">    1697 </span>            :                                        nsGkAtoms::h1,
<span class="lineNum">    1698 </span>            :                                        nsGkAtoms::h2,
<span class="lineNum">    1699 </span>            :                                        nsGkAtoms::h3,
<span class="lineNum">    1700 </span>            :                                        nsGkAtoms::h4,
<span class="lineNum">    1701 </span>            :                                        nsGkAtoms::h5,
<span class="lineNum">    1702 </span>            :                                        nsGkAtoms::h6,
<span class="lineNum">    1703 </span>            :                                        nsGkAtoms::header,
<span class="lineNum">    1704 </span>            :                                        nsGkAtoms::hgroup,
<span class="lineNum">    1705 </span>            :                                        nsGkAtoms::hr,
<span class="lineNum">    1706 </span>            :                                        nsGkAtoms::li,
<span class="lineNum">    1707 </span>            :                                        nsGkAtoms::listing,
<span class="lineNum">    1708 </span>            :                                        nsGkAtoms::menu,
<span class="lineNum">    1709 </span>            :                                        nsGkAtoms::multicol, // XXX get rid of this one?
<span class="lineNum">    1710 </span>            :                                        nsGkAtoms::nav,
<span class="lineNum">    1711 </span>            :                                        nsGkAtoms::ol,
<span class="lineNum">    1712 </span>            :                                        nsGkAtoms::p,
<span class="lineNum">    1713 </span>            :                                        nsGkAtoms::pre,
<span class="lineNum">    1714 </span>            :                                        nsGkAtoms::section,
<span class="lineNum">    1715 </span>            :                                        nsGkAtoms::table,
<span class="lineNum">    1716 </span>            :                                        nsGkAtoms::ul,
<span class="lineNum">    1717 </span><span class="lineNoCov">          0 :                                        nsGkAtoms::xmp);</span>
<span class="lineNum">    1718 </span>            : }
<span class="lineNum">    1719 </span>            : 
<a name="1720"><span class="lineNum">    1720 </span>            : /* static */</a>
<span class="lineNum">    1721 </span>            : bool
<span class="lineNum">    1722 </span><span class="lineNoCov">          0 : nsContentUtils::ParseIntMarginValue(const nsAString&amp; aString, nsIntMargin&amp; result)</span>
<span class="lineNum">    1723 </span>            : {
<span class="lineNum">    1724 </span><span class="lineNoCov">          0 :   nsAutoString marginStr(aString);</span>
<span class="lineNum">    1725 </span><span class="lineNoCov">          0 :   marginStr.CompressWhitespace(true, true);</span>
<span class="lineNum">    1726 </span><span class="lineNoCov">          0 :   if (marginStr.IsEmpty()) {</span>
<span class="lineNum">    1727 </span>            :     return false;
<span class="lineNum">    1728 </span>            :   }
<span class="lineNum">    1729 </span>            : 
<span class="lineNum">    1730 </span>            :   int32_t start = 0, end = 0;
<span class="lineNum">    1731 </span><span class="lineNoCov">          0 :   for (int count = 0; count &lt; 4; count++) {</span>
<span class="lineNum">    1732 </span><span class="lineNoCov">          0 :     if ((uint32_t)end &gt;= marginStr.Length())</span>
<span class="lineNum">    1733 </span><span class="lineNoCov">          0 :       return false;</span>
<span class="lineNum">    1734 </span>            : 
<span class="lineNum">    1735 </span>            :     // top, right, bottom, left
<span class="lineNum">    1736 </span><span class="lineNoCov">          0 :     if (count &lt; 3)</span>
<span class="lineNum">    1737 </span><span class="lineNoCov">          0 :       end = Substring(marginStr, start).FindChar(',');</span>
<span class="lineNum">    1738 </span>            :     else
<span class="lineNum">    1739 </span><span class="lineNoCov">          0 :       end = Substring(marginStr, start).Length();</span>
<span class="lineNum">    1740 </span>            : 
<span class="lineNum">    1741 </span><span class="lineNoCov">          0 :     if (end &lt;= 0)</span>
<span class="lineNum">    1742 </span>            :       return false;
<span class="lineNum">    1743 </span>            : 
<span class="lineNum">    1744 </span>            :     nsresult ec;
<span class="lineNum">    1745 </span><span class="lineNoCov">          0 :     int32_t val = nsString(Substring(marginStr, start, end)).ToInteger(&amp;ec);</span>
<span class="lineNum">    1746 </span><span class="lineNoCov">          0 :     if (NS_FAILED(ec))</span>
<span class="lineNum">    1747 </span>            :       return false;
<span class="lineNum">    1748 </span>            : 
<span class="lineNum">    1749 </span><span class="lineNoCov">          0 :     switch(count) {</span>
<span class="lineNum">    1750 </span>            :       case 0:
<span class="lineNum">    1751 </span><span class="lineNoCov">          0 :         result.top = val;</span>
<span class="lineNum">    1752 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1753 </span>            :       case 1:
<span class="lineNum">    1754 </span><span class="lineNoCov">          0 :         result.right = val;</span>
<span class="lineNum">    1755 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1756 </span>            :       case 2:
<span class="lineNum">    1757 </span><span class="lineNoCov">          0 :         result.bottom = val;</span>
<span class="lineNum">    1758 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1759 </span>            :       case 3:
<span class="lineNum">    1760 </span><span class="lineNoCov">          0 :         result.left = val;</span>
<span class="lineNum">    1761 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1762 </span>            :     }
<span class="lineNum">    1763 </span><span class="lineNoCov">          0 :     start += end + 1;</span>
<span class="lineNum">    1764 </span>            :   }
<span class="lineNum">    1765 </span>            :   return true;
<span class="lineNum">    1766 </span>            : }
<span class="lineNum">    1767 </span>            : 
<a name="1768"><span class="lineNum">    1768 </span>            : // static</a>
<span class="lineNum">    1769 </span>            : int32_t
<span class="lineNum">    1770 </span><span class="lineNoCov">          0 : nsContentUtils::ParseLegacyFontSize(const nsAString&amp; aValue)</span>
<span class="lineNum">    1771 </span>            : {
<span class="lineNum">    1772 </span>            :   nsAString::const_iterator iter, end;
<span class="lineNum">    1773 </span><span class="lineNoCov">          0 :   aValue.BeginReading(iter);</span>
<span class="lineNum">    1774 </span><span class="lineNoCov">          0 :   aValue.EndReading(end);</span>
<span class="lineNum">    1775 </span>            : 
<span class="lineNum">    1776 </span><span class="lineNoCov">          0 :   while (iter != end &amp;&amp; nsContentUtils::IsHTMLWhitespace(*iter)) {</span>
<span class="lineNum">    1777 </span>            :     ++iter;
<span class="lineNum">    1778 </span>            :   }
<span class="lineNum">    1779 </span>            : 
<span class="lineNum">    1780 </span><span class="lineNoCov">          0 :   if (iter == end) {</span>
<span class="lineNum">    1781 </span>            :     return 0;
<span class="lineNum">    1782 </span>            :   }
<span class="lineNum">    1783 </span>            : 
<span class="lineNum">    1784 </span><span class="lineNoCov">          0 :   bool relative = false;</span>
<span class="lineNum">    1785 </span><span class="lineNoCov">          0 :   bool negate = false;</span>
<span class="lineNum">    1786 </span><span class="lineNoCov">          0 :   if (*iter == char16_t('-')) {</span>
<span class="lineNum">    1787 </span><span class="lineNoCov">          0 :     relative = true;</span>
<span class="lineNum">    1788 </span><span class="lineNoCov">          0 :     negate = true;</span>
<span class="lineNum">    1789 </span>            :     ++iter;
<span class="lineNum">    1790 </span><span class="lineNoCov">          0 :   } else if (*iter == char16_t('+')) {</span>
<span class="lineNum">    1791 </span><span class="lineNoCov">          0 :     relative = true;</span>
<span class="lineNum">    1792 </span>            :     ++iter;
<span class="lineNum">    1793 </span>            :   }
<span class="lineNum">    1794 </span>            : 
<span class="lineNum">    1795 </span><span class="lineNoCov">          0 :   if (iter == end || *iter &lt; char16_t('0') || *iter &gt; char16_t('9')) {</span>
<span class="lineNum">    1796 </span>            :     return 0;
<span class="lineNum">    1797 </span>            :   }
<span class="lineNum">    1798 </span>            : 
<span class="lineNum">    1799 </span>            :   // We don't have to worry about overflow, since we can bail out as soon as
<span class="lineNum">    1800 </span>            :   // we're bigger than 7.
<span class="lineNum">    1801 </span><span class="lineNoCov">          0 :   int32_t value = 0;</span>
<span class="lineNum">    1802 </span><span class="lineNoCov">          0 :   while (iter != end &amp;&amp; *iter &gt;= char16_t('0') &amp;&amp; *iter &lt;= char16_t('9')) {</span>
<span class="lineNum">    1803 </span><span class="lineNoCov">          0 :     value = 10*value + (*iter - char16_t('0'));</span>
<span class="lineNum">    1804 </span><span class="lineNoCov">          0 :     if (value &gt;= 7) {</span>
<span class="lineNum">    1805 </span>            :       break;
<span class="lineNum">    1806 </span>            :     }
<span class="lineNum">    1807 </span>            :     ++iter;
<span class="lineNum">    1808 </span>            :   }
<span class="lineNum">    1809 </span>            : 
<span class="lineNum">    1810 </span><span class="lineNoCov">          0 :   if (relative) {</span>
<span class="lineNum">    1811 </span><span class="lineNoCov">          0 :     if (negate) {</span>
<span class="lineNum">    1812 </span><span class="lineNoCov">          0 :       value = 3 - value;</span>
<span class="lineNum">    1813 </span>            :     } else {
<span class="lineNum">    1814 </span><span class="lineNoCov">          0 :       value = 3 + value;</span>
<span class="lineNum">    1815 </span>            :     }
<span class="lineNum">    1816 </span>            :   }
<span class="lineNum">    1817 </span>            : 
<span class="lineNum">    1818 </span><span class="lineNoCov">          0 :   return clamped(value, 1, 7);</span>
<span class="lineNum">    1819 </span>            : }
<span class="lineNum">    1820 </span>            : 
<a name="1821"><span class="lineNum">    1821 </span>            : /* static */</a>
<span class="lineNum">    1822 </span>            : bool
<span class="lineNum">    1823 </span><span class="lineNoCov">          0 : nsContentUtils::IsControlledByServiceWorker(nsIDocument* aDocument)</span>
<span class="lineNum">    1824 </span>            : {
<span class="lineNum">    1825 </span><span class="lineNoCov">          0 :   if (nsContentUtils::IsInPrivateBrowsing(aDocument)) {</span>
<span class="lineNum">    1826 </span>            :     return false;
<span class="lineNum">    1827 </span>            :   }
<span class="lineNum">    1828 </span>            : 
<span class="lineNum">    1829 </span>            :   RefPtr&lt;workers::ServiceWorkerManager&gt; swm =
<span class="lineNum">    1830 </span><span class="lineNoCov">          0 :     workers::ServiceWorkerManager::GetInstance();</span>
<span class="lineNum">    1831 </span>            :   MOZ_ASSERT(swm);
<span class="lineNum">    1832 </span>            : 
<span class="lineNum">    1833 </span>            :   ErrorResult rv;
<span class="lineNum">    1834 </span><span class="lineNoCov">          0 :   bool controlled = swm-&gt;IsControlled(aDocument, rv);</span>
<span class="lineNum">    1835 </span><span class="lineNoCov">          0 :   if (NS_WARN_IF(rv.Failed())) {</span>
<span class="lineNum">    1836 </span><span class="lineNoCov">          0 :     rv.SuppressException();</span>
<span class="lineNum">    1837 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">    1838 </span>            :   }
<span class="lineNum">    1839 </span>            : 
<span class="lineNum">    1840 </span><span class="lineNoCov">          0 :   return controlled;</span>
<span class="lineNum">    1841 </span>            : }
<span class="lineNum">    1842 </span>            : 
<a name="1843"><span class="lineNum">    1843 </span>            : /* static */</a>
<span class="lineNum">    1844 </span>            : void
<span class="lineNum">    1845 </span><span class="lineNoCov">          0 : nsContentUtils::GetOfflineAppManifest(nsIDocument *aDocument, nsIURI **aURI)</span>
<span class="lineNum">    1846 </span>            : {
<span class="lineNum">    1847 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    1848 </span>            :   MOZ_ASSERT(aDocument);
<span class="lineNum">    1849 </span><span class="lineNoCov">          0 :   *aURI = nullptr;</span>
<span class="lineNum">    1850 </span>            : 
<span class="lineNum">    1851 </span><span class="lineNoCov">          0 :   if (IsControlledByServiceWorker(aDocument)) {</span>
<span class="lineNum">    1852 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    1853 </span>            :   }
<span class="lineNum">    1854 </span>            : 
<span class="lineNum">    1855 </span><span class="lineNoCov">          0 :   Element* docElement = aDocument-&gt;GetRootElement();</span>
<span class="lineNum">    1856 </span><span class="lineNoCov">          0 :   if (!docElement) {</span>
<span class="lineNum">    1857 </span>            :     return;
<span class="lineNum">    1858 </span>            :   }
<span class="lineNum">    1859 </span>            : 
<span class="lineNum">    1860 </span><span class="lineNoCov">          0 :   nsAutoString manifestSpec;</span>
<span class="lineNum">    1861 </span><span class="lineNoCov">          0 :   docElement-&gt;GetAttr(kNameSpaceID_None, nsGkAtoms::manifest, manifestSpec);</span>
<span class="lineNum">    1862 </span>            : 
<span class="lineNum">    1863 </span>            :   // Manifest URIs can't have fragment identifiers.
<span class="lineNum">    1864 </span><span class="lineNoCov">          0 :   if (manifestSpec.IsEmpty() ||</span>
<span class="lineNum">    1865 </span><span class="lineNoCov">          0 :       manifestSpec.Contains('#')) {</span>
<span class="lineNum">    1866 </span>            :     return;
<span class="lineNum">    1867 </span>            :   }
<span class="lineNum">    1868 </span>            : 
<span class="lineNum">    1869 </span>            :   nsContentUtils::NewURIWithDocumentCharset(aURI, manifestSpec,
<span class="lineNum">    1870 </span>            :                                             aDocument,
<span class="lineNum">    1871 </span><span class="lineNoCov">          0 :                                             aDocument-&gt;GetDocBaseURI());</span>
<span class="lineNum">    1872 </span>            : }
<span class="lineNum">    1873 </span>            : 
<span class="lineNum">    1874 </span>            : /* static */
<span class="lineNum">    1875 </span>            : bool
<span class="lineNum">    1876 </span><span class="lineNoCov">          0 : nsContentUtils::OfflineAppAllowed(nsIURI *aURI)</span>
<span class="lineNum">    1877 </span>            : {
<span class="lineNum">    1878 </span>            :   nsCOMPtr&lt;nsIOfflineCacheUpdateService&gt; updateService =
<span class="lineNum">    1879 </span><span class="lineNoCov">          0 :     do_GetService(NS_OFFLINECACHEUPDATESERVICE_CONTRACTID);</span>
<span class="lineNum">    1880 </span><span class="lineNoCov">          0 :   if (!updateService) {</span>
<span class="lineNum">    1881 </span>            :     return false;
<span class="lineNum">    1882 </span>            :   }
<span class="lineNum">    1883 </span>            : 
<span class="lineNum">    1884 </span>            :   bool allowed;
<span class="lineNum">    1885 </span>            :   nsresult rv =
<span class="lineNum">    1886 </span>            :     updateService-&gt;OfflineAppAllowedForURI(aURI,
<span class="lineNum">    1887 </span>            :                                            Preferences::GetRootBranch(),
<span class="lineNum">    1888 </span><span class="lineNoCov">          0 :                                            &amp;allowed);</span>
<span class="lineNum">    1889 </span><span class="lineNoCov">          0 :   return NS_SUCCEEDED(rv) &amp;&amp; allowed;</span>
<span class="lineNum">    1890 </span>            : }
<span class="lineNum">    1891 </span>            : 
<span class="lineNum">    1892 </span>            : /* static */
<span class="lineNum">    1893 </span>            : bool
<span class="lineNum">    1894 </span><span class="lineNoCov">          0 : nsContentUtils::OfflineAppAllowed(nsIPrincipal *aPrincipal)</span>
<span class="lineNum">    1895 </span>            : {
<span class="lineNum">    1896 </span>            :   nsCOMPtr&lt;nsIOfflineCacheUpdateService&gt; updateService =
<span class="lineNum">    1897 </span><span class="lineNoCov">          0 :     do_GetService(NS_OFFLINECACHEUPDATESERVICE_CONTRACTID);</span>
<span class="lineNum">    1898 </span><span class="lineNoCov">          0 :   if (!updateService) {</span>
<span class="lineNum">    1899 </span>            :     return false;
<span class="lineNum">    1900 </span>            :   }
<span class="lineNum">    1901 </span>            : 
<span class="lineNum">    1902 </span>            :   bool allowed;
<span class="lineNum">    1903 </span>            :   nsresult rv = updateService-&gt;OfflineAppAllowed(aPrincipal,
<span class="lineNum">    1904 </span>            :                                                  Preferences::GetRootBranch(),
<span class="lineNum">    1905 </span><span class="lineNoCov">          0 :                                                  &amp;allowed);</span>
<span class="lineNum">    1906 </span><span class="lineNoCov">          0 :   return NS_SUCCEEDED(rv) &amp;&amp; allowed;</span>
<span class="lineNum">    1907 </span>            : }
<span class="lineNum">    1908 </span>            : 
<span class="lineNum">    1909 </span>            : bool
<span class="lineNum">    1910 </span><span class="lineNoCov">          0 : nsContentUtils::MaybeAllowOfflineAppByDefault(nsIPrincipal *aPrincipal)</span>
<span class="lineNum">    1911 </span>            : {
<span class="lineNum">    1912 </span><span class="lineNoCov">          0 :   if (!Preferences::GetRootBranch())</span>
<span class="lineNum">    1913 </span>            :     return false;
<span class="lineNum">    1914 </span>            : 
<span class="lineNum">    1915 </span>            :   nsresult rv;
<span class="lineNum">    1916 </span>            : 
<span class="lineNum">    1917 </span>            :   bool allowedByDefault;
<span class="lineNum">    1918 </span><span class="lineNoCov">          0 :   rv = Preferences::GetRootBranch()-&gt;GetBoolPref(</span>
<span class="lineNum">    1919 </span><span class="lineNoCov">          0 :     &quot;offline-apps.allow_by_default&quot;, &amp;allowedByDefault);</span>
<span class="lineNum">    1920 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv))</span>
<span class="lineNum">    1921 </span>            :     return false;
<span class="lineNum">    1922 </span>            : 
<span class="lineNum">    1923 </span><span class="lineNoCov">          0 :   if (!allowedByDefault)</span>
<span class="lineNum">    1924 </span>            :     return false;
<span class="lineNum">    1925 </span>            : 
<span class="lineNum">    1926 </span>            :   nsCOMPtr&lt;nsIOfflineCacheUpdateService&gt; updateService =
<span class="lineNum">    1927 </span><span class="lineNoCov">          0 :     do_GetService(NS_OFFLINECACHEUPDATESERVICE_CONTRACTID);</span>
<span class="lineNum">    1928 </span><span class="lineNoCov">          0 :   if (!updateService) {</span>
<span class="lineNum">    1929 </span>            :     return false;
<span class="lineNum">    1930 </span>            :   }
<span class="lineNum">    1931 </span>            : 
<span class="lineNum">    1932 </span><span class="lineNoCov">          0 :   rv = updateService-&gt;AllowOfflineApp(aPrincipal);</span>
<span class="lineNum">    1933 </span><span class="lineNoCov">          0 :   return NS_SUCCEEDED(rv);</span>
<span class="lineNum">    1934 </span>            : }
<span class="lineNum">    1935 </span>            : 
<a name="1936"><span class="lineNum">    1936 </span>            : // static</a>
<span class="lineNum">    1937 </span>            : void
<span class="lineNum">    1938 </span><span class="lineCov">         60 : nsContentUtils::Shutdown()</span>
<span class="lineNum">    1939 </span>            : {
<span class="lineNum">    1940 </span><span class="lineCov">         60 :   sInitialized = false;</span>
<span class="lineNum">    1941 </span>            : 
<span class="lineNum">    1942 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sContentPolicyService);</span>
<span class="lineNum">    1943 </span><span class="lineCov">         60 :   sTriedToGetContentPolicy = false;</span>
<span class="lineNum">    1944 </span>            :   uint32_t i;
<span class="lineNum">    1945 </span><span class="lineCov">        900 :   for (i = 0; i &lt; PropertiesFile_COUNT; ++i)</span>
<span class="lineNum">    1946 </span><span class="lineCov">        840 :     NS_IF_RELEASE(sStringBundles[i]);</span>
<span class="lineNum">    1947 </span>            : 
<span class="lineNum">    1948 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sStringBundleService);</span>
<span class="lineNum">    1949 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sConsoleService);</span>
<span class="lineNum">    1950 </span><span class="lineCov">         60 :   sXPConnect = nullptr;</span>
<span class="lineNum">    1951 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sSecurityManager);</span>
<span class="lineNum">    1952 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sSystemPrincipal);</span>
<span class="lineNum">    1953 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sNullSubjectPrincipal);</span>
<span class="lineNum">    1954 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sParserService);</span>
<span class="lineNum">    1955 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sIOService);</span>
<span class="lineNum">    1956 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sUUIDGenerator);</span>
<span class="lineNum">    1957 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sLineBreaker);</span>
<span class="lineNum">    1958 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sWordBreaker);</span>
<span class="lineNum">    1959 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sBidiKeyboard);</span>
<span class="lineNum">    1960 </span>            : 
<span class="lineNum">    1961 </span><span class="lineCov">         60 :   delete sAtomEventTable;</span>
<span class="lineNum">    1962 </span><span class="lineCov">         60 :   sAtomEventTable = nullptr;</span>
<span class="lineNum">    1963 </span><span class="lineCov">         60 :   delete sStringEventTable;</span>
<span class="lineNum">    1964 </span><span class="lineCov">         60 :   sStringEventTable = nullptr;</span>
<span class="lineNum">    1965 </span><span class="lineCov">         60 :   delete sUserDefinedEvents;</span>
<span class="lineNum">    1966 </span><span class="lineCov">         60 :   sUserDefinedEvents = nullptr;</span>
<span class="lineNum">    1967 </span>            : 
<span class="lineNum">    1968 </span><span class="lineCov">         60 :   if (sEventListenerManagersHash) {</span>
<span class="lineNum">    1969 </span>            :     NS_ASSERTION(sEventListenerManagersHash-&gt;EntryCount() == 0,
<span class="lineNum">    1970 </span>            :                  &quot;Event listener manager hash not empty at shutdown!&quot;);
<span class="lineNum">    1971 </span>            : 
<span class="lineNum">    1972 </span>            :     // See comment above.
<span class="lineNum">    1973 </span>            : 
<span class="lineNum">    1974 </span>            :     // However, we have to handle this table differently.  If it still
<span class="lineNum">    1975 </span>            :     // has entries, we want to leak it too, so that we can keep it alive
<span class="lineNum">    1976 </span>            :     // in case any elements are destroyed.  Because if they are, we need
<span class="lineNum">    1977 </span>            :     // their event listener managers to be destroyed too, or otherwise
<span class="lineNum">    1978 </span>            :     // it could leave dangling references in DOMClassInfo's preserved
<span class="lineNum">    1979 </span>            :     // wrapper table.
<span class="lineNum">    1980 </span>            : 
<span class="lineNum">    1981 </span><span class="lineCov">         60 :     if (sEventListenerManagersHash-&gt;EntryCount() == 0) {</span>
<span class="lineNum">    1982 </span><span class="lineCov">         60 :       delete sEventListenerManagersHash;</span>
<span class="lineNum">    1983 </span><span class="lineCov">         60 :       sEventListenerManagersHash = nullptr;</span>
<span class="lineNum">    1984 </span>            :     }
<span class="lineNum">    1985 </span>            :   }
<span class="lineNum">    1986 </span>            : 
<span class="lineNum">    1987 </span>            :   NS_ASSERTION(!sBlockedScriptRunners ||
<span class="lineNum">    1988 </span>            :                sBlockedScriptRunners-&gt;Length() == 0,
<span class="lineNum">    1989 </span>            :                &quot;How'd this happen?&quot;);
<span class="lineNum">    1990 </span><span class="lineCov">         60 :   delete sBlockedScriptRunners;</span>
<span class="lineNum">    1991 </span><span class="lineCov">         60 :   sBlockedScriptRunners = nullptr;</span>
<span class="lineNum">    1992 </span>            : 
<span class="lineNum">    1993 </span><span class="lineCov">         60 :   delete sShiftText;</span>
<span class="lineNum">    1994 </span><span class="lineCov">         60 :   sShiftText = nullptr;</span>
<span class="lineNum">    1995 </span><span class="lineCov">         60 :   delete sControlText;</span>
<span class="lineNum">    1996 </span><span class="lineCov">         60 :   sControlText = nullptr;</span>
<span class="lineNum">    1997 </span><span class="lineCov">         60 :   delete sMetaText;</span>
<span class="lineNum">    1998 </span><span class="lineCov">         60 :   sMetaText = nullptr;</span>
<span class="lineNum">    1999 </span><span class="lineCov">         60 :   delete sOSText;</span>
<span class="lineNum">    2000 </span><span class="lineCov">         60 :   sOSText = nullptr;</span>
<span class="lineNum">    2001 </span><span class="lineCov">         60 :   delete sAltText;</span>
<span class="lineNum">    2002 </span><span class="lineCov">         60 :   sAltText = nullptr;</span>
<span class="lineNum">    2003 </span><span class="lineCov">         60 :   delete sModifierSeparator;</span>
<span class="lineNum">    2004 </span><span class="lineCov">         60 :   sModifierSeparator = nullptr;</span>
<span class="lineNum">    2005 </span>            : 
<span class="lineNum">    2006 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sSameOriginChecker);</span>
<span class="lineNum">    2007 </span>            : 
<span class="lineNum">    2008 </span><span class="lineCov">         60 :   HTMLInputElement::Shutdown();</span>
<span class="lineNum">    2009 </span><span class="lineCov">         60 :   nsMappedAttributes::Shutdown();</span>
<span class="lineNum">    2010 </span><span class="lineCov">         60 : }</span>
<span class="lineNum">    2011 </span>            : 
<span class="lineNum">    2012 </span>            : /**
<span class="lineNum">    2013 </span>            :  * Checks whether two nodes come from the same origin. aTrustedNode is
<span class="lineNum">    2014 </span>            :  * considered 'safe' in that a user can operate on it and that it isn't
<span class="lineNum">    2015 </span>            :  * a js-object that implements nsIDOMNode.
<span class="lineNum">    2016 </span>            :  * Never call this function with the first node provided by script, it
<span class="lineNum">    2017 </span>            :  * must always be known to be a 'real' node!
<span class="lineNum">    2018 </span>            :  */
<span class="lineNum">    2019 </span>            : // static
<span class="lineNum">    2020 </span>            : nsresult
<span class="lineNum">    2021 </span><span class="lineNoCov">          0 : nsContentUtils::CheckSameOrigin(const nsINode *aTrustedNode,</span>
<span class="lineNum">    2022 </span>            :                                 nsIDOMNode *aUnTrustedNode)
<span class="lineNum">    2023 </span>            : {
<span class="lineNum">    2024 </span>            :   MOZ_ASSERT(aTrustedNode);
<span class="lineNum">    2025 </span>            : 
<span class="lineNum">    2026 </span>            :   // Make sure it's a real node.
<span class="lineNum">    2027 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsINode&gt; unTrustedNode = do_QueryInterface(aUnTrustedNode);</span>
<span class="lineNum">    2028 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(unTrustedNode, NS_ERROR_UNEXPECTED);</span>
<span class="lineNum">    2029 </span><span class="lineNoCov">          0 :   return CheckSameOrigin(aTrustedNode, unTrustedNode);</span>
<span class="lineNum">    2030 </span>            : }
<span class="lineNum">    2031 </span>            : 
<span class="lineNum">    2032 </span>            : nsresult
<span class="lineNum">    2033 </span><span class="lineNoCov">          0 : nsContentUtils::CheckSameOrigin(const nsINode* aTrustedNode,</span>
<span class="lineNum">    2034 </span>            :                                 const nsINode* unTrustedNode)
<span class="lineNum">    2035 </span>            : {
<span class="lineNum">    2036 </span>            :   MOZ_ASSERT(aTrustedNode);
<span class="lineNum">    2037 </span>            :   MOZ_ASSERT(unTrustedNode);
<span class="lineNum">    2038 </span>            : 
<span class="lineNum">    2039 </span>            :   /*
<span class="lineNum">    2040 </span>            :    * Get hold of each node's principal
<span class="lineNum">    2041 </span>            :    */
<span class="lineNum">    2042 </span>            : 
<span class="lineNum">    2043 </span><span class="lineNoCov">          0 :   nsIPrincipal* trustedPrincipal = aTrustedNode-&gt;NodePrincipal();</span>
<span class="lineNum">    2044 </span><span class="lineNoCov">          0 :   nsIPrincipal* unTrustedPrincipal = unTrustedNode-&gt;NodePrincipal();</span>
<span class="lineNum">    2045 </span>            : 
<span class="lineNum">    2046 </span><span class="lineNoCov">          0 :   if (trustedPrincipal == unTrustedPrincipal) {</span>
<span class="lineNum">    2047 </span>            :     return NS_OK;
<span class="lineNum">    2048 </span>            :   }
<span class="lineNum">    2049 </span>            : 
<span class="lineNum">    2050 </span>            :   bool equal;
<span class="lineNum">    2051 </span>            :   // XXXbz should we actually have a Subsumes() check here instead?  Or perhaps
<span class="lineNum">    2052 </span>            :   // a separate method for that, with callers using one or the other?
<span class="lineNum">    2053 </span><span class="lineNoCov">          0 :   if (NS_FAILED(trustedPrincipal-&gt;Equals(unTrustedPrincipal, &amp;equal)) ||</span>
<span class="lineNum">    2054 </span><span class="lineNoCov">          0 :       !equal) {</span>
<span class="lineNum">    2055 </span>            :     return NS_ERROR_DOM_PROP_ACCESS_DENIED;
<span class="lineNum">    2056 </span>            :   }
<span class="lineNum">    2057 </span>            : 
<span class="lineNum">    2058 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    2059 </span>            : }
<span class="lineNum">    2060 </span>            : 
<a name="2061"><span class="lineNum">    2061 </span>            : // static</a>
<span class="lineNum">    2062 </span>            : bool
<span class="lineNum">    2063 </span><span class="lineNoCov">          0 : nsContentUtils::CanCallerAccess(nsIPrincipal* aSubjectPrincipal,</span>
<span class="lineNum">    2064 </span>            :                                 nsIPrincipal* aPrincipal)
<span class="lineNum">    2065 </span>            : {
<span class="lineNum">    2066 </span>            :   bool subsumes;
<span class="lineNum">    2067 </span><span class="lineNoCov">          0 :   nsresult rv = aSubjectPrincipal-&gt;Subsumes(aPrincipal, &amp;subsumes);</span>
<span class="lineNum">    2068 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, false);</span>
<span class="lineNum">    2069 </span>            : 
<span class="lineNum">    2070 </span><span class="lineNoCov">          0 :   if (subsumes) {</span>
<span class="lineNum">    2071 </span>            :     return true;
<span class="lineNum">    2072 </span>            :   }
<span class="lineNum">    2073 </span>            : 
<span class="lineNum">    2074 </span>            :   // The subject doesn't subsume aPrincipal. Allow access only if the subject
<span class="lineNum">    2075 </span>            :   // is chrome.
<span class="lineNum">    2076 </span><span class="lineNoCov">          0 :   return IsCallerChrome();</span>
<span class="lineNum">    2077 </span>            : }
<span class="lineNum">    2078 </span>            : 
<span class="lineNum">    2079 </span>            : // static
<span class="lineNum">    2080 </span>            : bool
<span class="lineNum">    2081 </span><span class="lineNoCov">          0 : nsContentUtils::CanCallerAccess(nsIDOMNode *aNode)</span>
<span class="lineNum">    2082 </span>            : {
<span class="lineNum">    2083 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsINode&gt; node = do_QueryInterface(aNode);</span>
<span class="lineNum">    2084 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(node, false);</span>
<span class="lineNum">    2085 </span><span class="lineNoCov">          0 :   return CanCallerAccess(node);</span>
<span class="lineNum">    2086 </span>            : }
<span class="lineNum">    2087 </span>            : 
<span class="lineNum">    2088 </span>            : // static
<span class="lineNum">    2089 </span>            : bool
<span class="lineNum">    2090 </span><span class="lineNoCov">          0 : nsContentUtils::CanCallerAccess(nsINode* aNode)</span>
<span class="lineNum">    2091 </span>            : {
<span class="lineNum">    2092 </span><span class="lineNoCov">          0 :   return CanCallerAccess(SubjectPrincipal(), aNode-&gt;NodePrincipal());</span>
<span class="lineNum">    2093 </span>            : }
<span class="lineNum">    2094 </span>            : 
<span class="lineNum">    2095 </span>            : // static
<span class="lineNum">    2096 </span>            : bool
<span class="lineNum">    2097 </span><span class="lineNoCov">          0 : nsContentUtils::CanCallerAccess(nsPIDOMWindowInner* aWindow)</span>
<span class="lineNum">    2098 </span>            : {
<span class="lineNum">    2099 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIScriptObjectPrincipal&gt; scriptObject = do_QueryInterface(aWindow);</span>
<span class="lineNum">    2100 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(scriptObject, false);</span>
<span class="lineNum">    2101 </span>            : 
<span class="lineNum">    2102 </span><span class="lineNoCov">          0 :   return CanCallerAccess(SubjectPrincipal(), scriptObject-&gt;GetPrincipal());</span>
<span class="lineNum">    2103 </span>            : }
<span class="lineNum">    2104 </span>            : 
<a name="2105"><span class="lineNum">    2105 </span>            : // static</a>
<span class="lineNum">    2106 </span>            : bool
<span class="lineNum">    2107 </span><span class="lineNoCov">          0 : nsContentUtils::PrincipalHasPermission(nsIPrincipal* aPrincipal, const nsAString&amp; aPerm)</span>
<span class="lineNum">    2108 </span>            : {
<span class="lineNum">    2109 </span>            :   // Chrome gets access by default.
<span class="lineNum">    2110 </span><span class="lineNoCov">          0 :   if (IsSystemPrincipal(aPrincipal)) {</span>
<span class="lineNum">    2111 </span>            :     return true;
<span class="lineNum">    2112 </span>            :   }
<span class="lineNum">    2113 </span>            : 
<span class="lineNum">    2114 </span>            :   // Otherwise, only allow if caller is an addon with the permission.
<span class="lineNum">    2115 </span><span class="lineNoCov">          0 :   return BasePrincipal::Cast(aPrincipal)-&gt;AddonHasPermission(aPerm);</span>
<span class="lineNum">    2116 </span>            : }
<span class="lineNum">    2117 </span>            : 
<a name="2118"><span class="lineNum">    2118 </span>            : // static</a>
<span class="lineNum">    2119 </span>            : bool
<span class="lineNum">    2120 </span><span class="lineNoCov">          0 : nsContentUtils::CallerHasPermission(JSContext* aCx, const nsAString&amp; aPerm)</span>
<span class="lineNum">    2121 </span>            : {
<span class="lineNum">    2122 </span><span class="lineNoCov">          0 :   return PrincipalHasPermission(SubjectPrincipal(aCx), aPerm);</span>
<span class="lineNum">    2123 </span>            : }
<span class="lineNum">    2124 </span>            : 
<a name="2125"><span class="lineNum">    2125 </span>            : //static</a>
<span class="lineNum">    2126 </span>            : bool
<span class="lineNum">    2127 </span><span class="lineNoCov">          0 : nsContentUtils::InProlog(nsINode *aNode)</span>
<span class="lineNum">    2128 </span>            : {
<span class="lineNum">    2129 </span>            :   NS_PRECONDITION(aNode, &quot;missing node to nsContentUtils::InProlog&quot;);
<span class="lineNum">    2130 </span>            : 
<span class="lineNum">    2131 </span><span class="lineNoCov">          0 :   nsINode* parent = aNode-&gt;GetParentNode();</span>
<span class="lineNum">    2132 </span><span class="lineNoCov">          0 :   if (!parent || !parent-&gt;IsNodeOfType(nsINode::eDOCUMENT)) {</span>
<span class="lineNum">    2133 </span>            :     return false;
<span class="lineNum">    2134 </span>            :   }
<span class="lineNum">    2135 </span>            : 
<span class="lineNum">    2136 </span><span class="lineNoCov">          0 :   nsIDocument* doc = static_cast&lt;nsIDocument*&gt;(parent);</span>
<span class="lineNum">    2137 </span><span class="lineNoCov">          0 :   nsIContent* root = doc-&gt;GetRootElement();</span>
<span class="lineNum">    2138 </span>            : 
<span class="lineNum">    2139 </span><span class="lineNoCov">          0 :   return !root || doc-&gt;IndexOf(aNode) &lt; doc-&gt;IndexOf(root);</span>
<span class="lineNum">    2140 </span>            : }
<span class="lineNum">    2141 </span>            : 
<span class="lineNum">    2142 </span>            : nsIDocument*
<span class="lineNum">    2143 </span><span class="lineNoCov">          0 : nsContentUtils::GetDocumentFromCaller()</span>
<span class="lineNum">    2144 </span>            : {
<span class="lineNum">    2145 </span><span class="lineNoCov">          0 :   AutoJSContext cx;</span>
<span class="lineNum">    2146 </span>            : 
<span class="lineNum">    2147 </span>            :   nsCOMPtr&lt;nsPIDOMWindowInner&gt; win =
<span class="lineNum">    2148 </span><span class="lineNoCov">          0 :     do_QueryInterface(nsJSUtils::GetStaticScriptGlobal(JS::CurrentGlobalOrNull(cx)));</span>
<span class="lineNum">    2149 </span><span class="lineNoCov">          0 :   if (!win) {</span>
<span class="lineNum">    2150 </span>            :     return nullptr;
<span class="lineNum">    2151 </span>            :   }
<span class="lineNum">    2152 </span>            : 
<span class="lineNum">    2153 </span><span class="lineNoCov">          0 :   return win-&gt;GetExtantDoc();</span>
<span class="lineNum">    2154 </span>            : }
<a name="2155"><span class="lineNum">    2155 </span>            : </a>
<span class="lineNum">    2156 </span>            : bool
<span class="lineNum">    2157 </span><span class="lineCov">       7100 : nsContentUtils::IsCallerChrome()</span>
<span class="lineNum">    2158 </span>            : {
<span class="lineNum">    2159 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    2160 </span><span class="lineCov">       7100 :   if (SubjectPrincipal() == sSystemPrincipal) {</span>
<span class="lineNum">    2161 </span>            :     return true;
<span class="lineNum">    2162 </span>            :   }
<span class="lineNum">    2163 </span>            : 
<span class="lineNum">    2164 </span>            :   // If the check failed, look for UniversalXPConnect on the cx compartment.
<span class="lineNum">    2165 </span><span class="lineNoCov">          0 :   return xpc::IsUniversalXPConnectEnabled(GetCurrentJSContext());</span>
<span class="lineNum">    2166 </span>            : }
<span class="lineNum">    2167 </span>            : 
<a name="2168"><span class="lineNum">    2168 </span>            : /* static */</a>
<span class="lineNum">    2169 </span>            : bool
<span class="lineNum">    2170 </span><span class="lineNoCov">          0 : nsContentUtils::ShouldResistFingerprinting()</span>
<span class="lineNum">    2171 </span>            : {
<span class="lineNum">    2172 </span><span class="lineNoCov">          0 :   return sPrivacyResistFingerprinting;</span>
<span class="lineNum">    2173 </span>            : }
<a name="2174"><span class="lineNum">    2174 </span>            : </a>
<span class="lineNum">    2175 </span>            : bool
<span class="lineNum">    2176 </span><span class="lineNoCov">          0 : nsContentUtils::ShouldResistFingerprinting(nsIDocShell* aDocShell)</span>
<span class="lineNum">    2177 </span>            : {
<span class="lineNum">    2178 </span><span class="lineNoCov">          0 :   if (!aDocShell) {</span>
<span class="lineNum">    2179 </span>            :     return false;
<span class="lineNum">    2180 </span>            :   }
<span class="lineNum">    2181 </span><span class="lineNoCov">          0 :   bool isChrome = nsContentUtils::IsChromeDoc(aDocShell-&gt;GetDocument());</span>
<span class="lineNum">    2182 </span><span class="lineNoCov">          0 :   return !isChrome &amp;&amp; sPrivacyResistFingerprinting;</span>
<span class="lineNum">    2183 </span>            : }
<span class="lineNum">    2184 </span>            : 
<a name="2185"><span class="lineNum">    2185 </span>            : /* static */</a>
<span class="lineNum">    2186 </span>            : void
<span class="lineNum">    2187 </span><span class="lineNoCov">          0 : nsContentUtils::CalcRoundedWindowSizeForResistingFingerprinting(int32_t  aChromeWidth,</span>
<span class="lineNum">    2188 </span>            :                                                                 int32_t  aChromeHeight,
<span class="lineNum">    2189 </span>            :                                                                 int32_t  aScreenWidth,
<span class="lineNum">    2190 </span>            :                                                                 int32_t  aScreenHeight,
<span class="lineNum">    2191 </span>            :                                                                 int32_t  aInputWidth,
<span class="lineNum">    2192 </span>            :                                                                 int32_t  aInputHeight,
<span class="lineNum">    2193 </span>            :                                                                 bool     aSetOuterWidth,
<span class="lineNum">    2194 </span>            :                                                                 bool     aSetOuterHeight,
<span class="lineNum">    2195 </span>            :                                                                 int32_t* aOutputWidth,
<span class="lineNum">    2196 </span>            :                                                                 int32_t* aOutputHeight)
<span class="lineNum">    2197 </span>            : {
<span class="lineNum">    2198 </span>            :   MOZ_ASSERT(aOutputWidth);
<span class="lineNum">    2199 </span>            :   MOZ_ASSERT(aOutputHeight);
<span class="lineNum">    2200 </span>            : 
<span class="lineNum">    2201 </span><span class="lineNoCov">          0 :   int32_t availContentWidth  = 0;</span>
<span class="lineNum">    2202 </span><span class="lineNoCov">          0 :   int32_t availContentHeight = 0;</span>
<span class="lineNum">    2203 </span>            : 
<span class="lineNum">    2204 </span>            :   availContentWidth = std::min(sPrivacyMaxInnerWidth,
<span class="lineNum">    2205 </span><span class="lineNoCov">          0 :                                aScreenWidth - aChromeWidth);</span>
<span class="lineNum">    2206 </span>            : #ifdef MOZ_WIDGET_GTK
<span class="lineNum">    2207 </span>            :   // In the GTK window, it will not report outside system decorations
<span class="lineNum">    2208 </span>            :   // when we get available window size, see Bug 581863. So, we leave a
<span class="lineNum">    2209 </span>            :   // 40 pixels space for them when calculating the available content
<span class="lineNum">    2210 </span>            :   // height. It is not necessary for the width since the content width
<span class="lineNum">    2211 </span>            :   // is usually pretty much the same as the chrome width.
<span class="lineNum">    2212 </span>            :   availContentHeight = std::min(sPrivacyMaxInnerHeight,
<span class="lineNum">    2213 </span><span class="lineNoCov">          0 :                                 (-40 + aScreenHeight) - aChromeHeight);</span>
<span class="lineNum">    2214 </span>            : #else
<span class="lineNum">    2215 </span>            :   availContentHeight = std::min(sPrivacyMaxInnerHeight,
<span class="lineNum">    2216 </span>            :                                 aScreenHeight - aChromeHeight);
<span class="lineNum">    2217 </span>            : #endif
<span class="lineNum">    2218 </span>            : 
<span class="lineNum">    2219 </span>            :   // Ideally, we'd like to round window size to 1000x1000, but the
<span class="lineNum">    2220 </span>            :   // screen space could be too small to accommodate this size in some
<span class="lineNum">    2221 </span>            :   // cases. If it happens, we would round the window size to the nearest
<span class="lineNum">    2222 </span>            :   // 200x100.
<span class="lineNum">    2223 </span><span class="lineNoCov">          0 :   availContentWidth = availContentWidth - (availContentWidth % 200);</span>
<span class="lineNum">    2224 </span><span class="lineNoCov">          0 :   availContentHeight = availContentHeight - (availContentHeight % 100);</span>
<span class="lineNum">    2225 </span>            : 
<span class="lineNum">    2226 </span>            :   // If aIsOuter is true, we are setting the outer window. So we
<span class="lineNum">    2227 </span>            :   // have to consider the chrome UI.
<span class="lineNum">    2228 </span><span class="lineNoCov">          0 :   int32_t chromeOffsetWidth = aSetOuterWidth ? aChromeWidth : 0;</span>
<span class="lineNum">    2229 </span><span class="lineNoCov">          0 :   int32_t chromeOffsetHeight = aSetOuterHeight ? aChromeHeight : 0;</span>
<span class="lineNum">    2230 </span><span class="lineNoCov">          0 :   int32_t resultWidth = 0, resultHeight = 0;</span>
<span class="lineNum">    2231 </span>            : 
<span class="lineNum">    2232 </span>            :   // if the original size is greater than the maximum available size, we set
<span class="lineNum">    2233 </span>            :   // it to the maximum size. And if the original value is less than the
<span class="lineNum">    2234 </span>            :   // minimum rounded size, we set it to the minimum 200x100.
<span class="lineNum">    2235 </span><span class="lineNoCov">          0 :   if (aInputWidth &gt; (availContentWidth + chromeOffsetWidth)) {</span>
<span class="lineNum">    2236 </span>            :     resultWidth = availContentWidth + chromeOffsetWidth;
<span class="lineNum">    2237 </span><span class="lineNoCov">          0 :   } else if (aInputWidth &lt; (200 + chromeOffsetWidth)) {</span>
<span class="lineNum">    2238 </span><span class="lineNoCov">          0 :     resultWidth = 200 + chromeOffsetWidth;</span>
<span class="lineNum">    2239 </span>            :   } else {
<span class="lineNum">    2240 </span>            :     // Otherwise, we round the window to the nearest upper rounded 200x100.
<span class="lineNum">    2241 </span><span class="lineNoCov">          0 :     resultWidth = NSToIntCeil((aInputWidth - chromeOffsetWidth) / 200.0) * 200 + chromeOffsetWidth;</span>
<span class="lineNum">    2242 </span>            :   }
<span class="lineNum">    2243 </span>            : 
<span class="lineNum">    2244 </span><span class="lineNoCov">          0 :   if (aInputHeight &gt; (availContentHeight + chromeOffsetHeight)) {</span>
<span class="lineNum">    2245 </span>            :     resultHeight = availContentHeight + chromeOffsetHeight;
<span class="lineNum">    2246 </span><span class="lineNoCov">          0 :   } else if (aInputHeight &lt; (100 + chromeOffsetHeight)) {</span>
<span class="lineNum">    2247 </span><span class="lineNoCov">          0 :     resultHeight = 100 + chromeOffsetHeight;</span>
<span class="lineNum">    2248 </span>            :   } else {
<span class="lineNum">    2249 </span><span class="lineNoCov">          0 :     resultHeight = NSToIntCeil((aInputHeight - chromeOffsetHeight) / 100.0) * 100 + chromeOffsetHeight;</span>
<span class="lineNum">    2250 </span>            :   }
<span class="lineNum">    2251 </span>            : 
<span class="lineNum">    2252 </span><span class="lineNoCov">          0 :   *aOutputWidth = resultWidth;</span>
<span class="lineNum">    2253 </span><span class="lineNoCov">          0 :   *aOutputHeight = resultHeight;</span>
<span class="lineNum">    2254 </span><span class="lineNoCov">          0 : }</span>
<a name="2255"><span class="lineNum">    2255 </span>            : </a>
<span class="lineNum">    2256 </span>            : bool
<span class="lineNum">    2257 </span><span class="lineNoCov">          0 : nsContentUtils::ThreadsafeIsCallerChrome()</span>
<span class="lineNum">    2258 </span>            : {
<span class="lineNum">    2259 </span><span class="lineNoCov">          0 :   return NS_IsMainThread() ?</span>
<span class="lineNum">    2260 </span>            :     IsCallerChrome() :
<span class="lineNum">    2261 </span><span class="lineNoCov">          0 :     mozilla::dom::workers::IsCurrentThreadRunningChromeWorker();</span>
<span class="lineNum">    2262 </span>            : }
<a name="2263"><span class="lineNum">    2263 </span>            : </a>
<span class="lineNum">    2264 </span>            : bool
<span class="lineNum">    2265 </span><span class="lineNoCov">          0 : nsContentUtils::IsCallerContentXBL()</span>
<span class="lineNum">    2266 </span>            : {
<span class="lineNum">    2267 </span><span class="lineNoCov">          0 :     JSContext *cx = GetCurrentJSContext();</span>
<span class="lineNum">    2268 </span><span class="lineNoCov">          0 :     if (!cx)</span>
<span class="lineNum">    2269 </span>            :         return false;
<span class="lineNum">    2270 </span>            : 
<span class="lineNum">    2271 </span><span class="lineNoCov">          0 :     JSCompartment *c = js::GetContextCompartment(cx);</span>
<span class="lineNum">    2272 </span>            : 
<span class="lineNum">    2273 </span>            :     // For remote XUL, we run XBL in the XUL scope. Given that we care about
<span class="lineNum">    2274 </span>            :     // compat and not security for remote XUL, just always claim to be XBL.
<span class="lineNum">    2275 </span><span class="lineNoCov">          0 :     if (!xpc::AllowContentXBLScope(c)) {</span>
<span class="lineNum">    2276 </span>            :       MOZ_ASSERT(nsContentUtils::AllowXULXBLForPrincipal(xpc::GetCompartmentPrincipal(c)));
<span class="lineNum">    2277 </span>            :       return true;
<span class="lineNum">    2278 </span>            :     }
<span class="lineNum">    2279 </span>            : 
<span class="lineNum">    2280 </span><span class="lineNoCov">          0 :     return xpc::IsContentXBLScope(c);</span>
<span class="lineNum">    2281 </span>            : }
<a name="2282"><span class="lineNum">    2282 </span>            : </a>
<span class="lineNum">    2283 </span>            : bool
<span class="lineNum">    2284 </span><span class="lineCov">        185 : nsContentUtils::IsSystemCaller(JSContext* aCx)</span>
<span class="lineNum">    2285 </span>            : {
<span class="lineNum">    2286 </span>            :   // Note that SubjectPrincipal() assumes we are in a compartment here.
<span class="lineNum">    2287 </span><span class="lineCov">        185 :   return SubjectPrincipal(aCx) == sSystemPrincipal;</span>
<span class="lineNum">    2288 </span>            : }
<a name="2289"><span class="lineNum">    2289 </span>            : </a>
<span class="lineNum">    2290 </span>            : bool
<span class="lineNum">    2291 </span><span class="lineCov">        180 : nsContentUtils::ThreadsafeIsSystemCaller(JSContext* aCx)</span>
<span class="lineNum">    2292 </span>            : {
<span class="lineNum">    2293 </span><span class="lineCov">        180 :   if (NS_IsMainThread()) {</span>
<span class="lineNum">    2294 </span><span class="lineCov">        180 :     return IsSystemCaller(aCx);</span>
<span class="lineNum">    2295 </span>            :   }
<span class="lineNum">    2296 </span>            : 
<span class="lineNum">    2297 </span><span class="lineNoCov">          0 :   return workers::GetWorkerPrivateFromContext(aCx)-&gt;UsesSystemPrincipal();</span>
<span class="lineNum">    2298 </span>            : }
<span class="lineNum">    2299 </span>            : 
<a name="2300"><span class="lineNum">    2300 </span>            : // static</a>
<span class="lineNum">    2301 </span>            : bool
<span class="lineNum">    2302 </span><span class="lineNoCov">          0 : nsContentUtils::LookupBindingMember(JSContext* aCx, nsIContent *aContent,</span>
<span class="lineNum">    2303 </span>            :                                     JS::Handle&lt;jsid&gt; aId,
<span class="lineNum">    2304 </span>            :                                     JS::MutableHandle&lt;JS::PropertyDescriptor&gt; aDesc)
<span class="lineNum">    2305 </span>            : {
<span class="lineNum">    2306 </span><span class="lineNoCov">          0 :   nsXBLBinding* binding = aContent-&gt;GetXBLBinding();</span>
<span class="lineNum">    2307 </span><span class="lineNoCov">          0 :   if (!binding)</span>
<span class="lineNum">    2308 </span>            :     return true;
<span class="lineNum">    2309 </span><span class="lineNoCov">          0 :   return binding-&gt;LookupMember(aCx, aId, aDesc);</span>
<span class="lineNum">    2310 </span>            : }
<span class="lineNum">    2311 </span>            : 
<a name="2312"><span class="lineNum">    2312 </span>            : // static</a>
<span class="lineNum">    2313 </span>            : nsINode*
<span class="lineNum">    2314 </span><span class="lineNoCov">          0 : nsContentUtils::GetCrossDocParentNode(nsINode* aChild)</span>
<span class="lineNum">    2315 </span>            : {
<span class="lineNum">    2316 </span>            :   NS_PRECONDITION(aChild, &quot;The child is null!&quot;);
<span class="lineNum">    2317 </span>            : 
<span class="lineNum">    2318 </span><span class="lineNoCov">          0 :   nsINode* parent = aChild-&gt;GetParentNode();</span>
<span class="lineNum">    2319 </span><span class="lineNoCov">          0 :   if (parent &amp;&amp; parent-&gt;IsContent() &amp;&amp; aChild-&gt;IsContent()) {</span>
<span class="lineNum">    2320 </span><span class="lineNoCov">          0 :     parent = aChild-&gt;AsContent()-&gt;GetFlattenedTreeParent();</span>
<span class="lineNum">    2321 </span>            :   }
<span class="lineNum">    2322 </span>            : 
<span class="lineNum">    2323 </span><span class="lineNoCov">          0 :   if (parent || !aChild-&gt;IsNodeOfType(nsINode::eDOCUMENT))</span>
<span class="lineNum">    2324 </span>            :     return parent;
<span class="lineNum">    2325 </span>            : 
<span class="lineNum">    2326 </span><span class="lineNoCov">          0 :   nsIDocument* doc = static_cast&lt;nsIDocument*&gt;(aChild);</span>
<span class="lineNum">    2327 </span><span class="lineNoCov">          0 :   nsIDocument* parentDoc = doc-&gt;GetParentDocument();</span>
<span class="lineNum">    2328 </span><span class="lineNoCov">          0 :   return parentDoc ? parentDoc-&gt;FindContentForSubDocument(doc) : nullptr;</span>
<span class="lineNum">    2329 </span>            : }
<span class="lineNum">    2330 </span>            : 
<a name="2331"><span class="lineNum">    2331 </span>            : // static</a>
<span class="lineNum">    2332 </span>            : bool
<span class="lineNum">    2333 </span><span class="lineNoCov">          0 : nsContentUtils::ContentIsDescendantOf(const nsINode* aPossibleDescendant,</span>
<span class="lineNum">    2334 </span>            :                                       const nsINode* aPossibleAncestor)
<span class="lineNum">    2335 </span>            : {
<span class="lineNum">    2336 </span>            :   NS_PRECONDITION(aPossibleDescendant, &quot;The possible descendant is null!&quot;);
<span class="lineNum">    2337 </span>            :   NS_PRECONDITION(aPossibleAncestor, &quot;The possible ancestor is null!&quot;);
<span class="lineNum">    2338 </span>            : 
<span class="lineNum">    2339 </span><span class="lineNoCov">          0 :   do {</span>
<span class="lineNum">    2340 </span><span class="lineNoCov">          0 :     if (aPossibleDescendant == aPossibleAncestor)</span>
<span class="lineNum">    2341 </span>            :       return true;
<span class="lineNum">    2342 </span><span class="lineNoCov">          0 :     aPossibleDescendant = aPossibleDescendant-&gt;GetParentNode();</span>
<span class="lineNum">    2343 </span>            :   } while (aPossibleDescendant);
<span class="lineNum">    2344 </span>            : 
<span class="lineNum">    2345 </span>            :   return false;
<span class="lineNum">    2346 </span>            : }
<a name="2347"><span class="lineNum">    2347 </span>            : </a>
<span class="lineNum">    2348 </span>            : bool
<span class="lineNum">    2349 </span><span class="lineNoCov">          0 : nsContentUtils::ContentIsHostIncludingDescendantOf(</span>
<span class="lineNum">    2350 </span>            :   const nsINode* aPossibleDescendant, const nsINode* aPossibleAncestor)
<span class="lineNum">    2351 </span>            : {
<span class="lineNum">    2352 </span>            :   NS_PRECONDITION(aPossibleDescendant, &quot;The possible descendant is null!&quot;);
<span class="lineNum">    2353 </span>            :   NS_PRECONDITION(aPossibleAncestor, &quot;The possible ancestor is null!&quot;);
<span class="lineNum">    2354 </span>            : 
<span class="lineNum">    2355 </span><span class="lineNoCov">          0 :   do {</span>
<span class="lineNum">    2356 </span><span class="lineNoCov">          0 :     if (aPossibleDescendant == aPossibleAncestor)</span>
<span class="lineNum">    2357 </span>            :       return true;
<span class="lineNum">    2358 </span><span class="lineNoCov">          0 :     if (aPossibleDescendant-&gt;NodeType() == nsIDOMNode::DOCUMENT_FRAGMENT_NODE) {</span>
<span class="lineNum">    2359 </span>            :       aPossibleDescendant =
<span class="lineNum">    2360 </span><span class="lineNoCov">          0 :         static_cast&lt;const DocumentFragment*&gt;(aPossibleDescendant)-&gt;GetHost();</span>
<span class="lineNum">    2361 </span>            :     } else {
<span class="lineNum">    2362 </span><span class="lineNoCov">          0 :       aPossibleDescendant = aPossibleDescendant-&gt;GetParentNode();</span>
<span class="lineNum">    2363 </span>            :     }
<span class="lineNum">    2364 </span>            :   } while (aPossibleDescendant);
<span class="lineNum">    2365 </span>            : 
<span class="lineNum">    2366 </span>            :   return false;
<span class="lineNum">    2367 </span>            : }
<span class="lineNum">    2368 </span>            : 
<a name="2369"><span class="lineNum">    2369 </span>            : // static</a>
<span class="lineNum">    2370 </span>            : bool
<span class="lineNum">    2371 </span><span class="lineNoCov">          0 : nsContentUtils::ContentIsCrossDocDescendantOf(nsINode* aPossibleDescendant,</span>
<span class="lineNum">    2372 </span>            :                                               nsINode* aPossibleAncestor)
<span class="lineNum">    2373 </span>            : {
<span class="lineNum">    2374 </span>            :   NS_PRECONDITION(aPossibleDescendant, &quot;The possible descendant is null!&quot;);
<span class="lineNum">    2375 </span>            :   NS_PRECONDITION(aPossibleAncestor, &quot;The possible ancestor is null!&quot;);
<span class="lineNum">    2376 </span>            : 
<span class="lineNum">    2377 </span><span class="lineNoCov">          0 :   do {</span>
<span class="lineNum">    2378 </span><span class="lineNoCov">          0 :     if (aPossibleDescendant == aPossibleAncestor)</span>
<span class="lineNum">    2379 </span>            :       return true;
<span class="lineNum">    2380 </span>            : 
<span class="lineNum">    2381 </span><span class="lineNoCov">          0 :     aPossibleDescendant = GetCrossDocParentNode(aPossibleDescendant);</span>
<span class="lineNum">    2382 </span>            :   } while (aPossibleDescendant);
<span class="lineNum">    2383 </span>            : 
<span class="lineNum">    2384 </span>            :   return false;
<span class="lineNum">    2385 </span>            : }
<span class="lineNum">    2386 </span>            : 
<span class="lineNum">    2387 </span>            : 
<a name="2388"><span class="lineNum">    2388 </span>            : // static</a>
<span class="lineNum">    2389 </span>            : nsresult
<span class="lineNum">    2390 </span><span class="lineNoCov">          0 : nsContentUtils::GetAncestors(nsINode* aNode,</span>
<span class="lineNum">    2391 </span>            :                              nsTArray&lt;nsINode*&gt;&amp; aArray)
<span class="lineNum">    2392 </span>            : {
<span class="lineNum">    2393 </span><span class="lineNoCov">          0 :   while (aNode) {</span>
<span class="lineNum">    2394 </span><span class="lineNoCov">          0 :     aArray.AppendElement(aNode);</span>
<span class="lineNum">    2395 </span><span class="lineNoCov">          0 :     aNode = aNode-&gt;GetParentNode();</span>
<span class="lineNum">    2396 </span>            :   }
<span class="lineNum">    2397 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    2398 </span>            : }
<span class="lineNum">    2399 </span>            : 
<span class="lineNum">    2400 </span>            : // static
<span class="lineNum">    2401 </span>            : nsresult
<span class="lineNum">    2402 </span><span class="lineNoCov">          0 : nsContentUtils::GetAncestorsAndOffsets(nsIDOMNode* aNode,</span>
<span class="lineNum">    2403 </span>            :                                        int32_t aOffset,
<span class="lineNum">    2404 </span>            :                                        nsTArray&lt;nsIContent*&gt;* aAncestorNodes,
<span class="lineNum">    2405 </span>            :                                        nsTArray&lt;int32_t&gt;* aAncestorOffsets)
<span class="lineNum">    2406 </span>            : {
<span class="lineNum">    2407 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(aNode);</span>
<span class="lineNum">    2408 </span>            : 
<span class="lineNum">    2409 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIContent&gt; content(do_QueryInterface(aNode));</span>
<span class="lineNum">    2410 </span>            : 
<span class="lineNum">    2411 </span><span class="lineNoCov">          0 :   if (!content) {</span>
<span class="lineNum">    2412 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">    2413 </span>            :   }
<span class="lineNum">    2414 </span>            : 
<span class="lineNum">    2415 </span><span class="lineNoCov">          0 :   if (!aAncestorNodes-&gt;IsEmpty()) {</span>
<span class="lineNum">    2416 </span>            :     NS_WARNING(&quot;aAncestorNodes is not empty&quot;);
<span class="lineNum">    2417 </span><span class="lineNoCov">          0 :     aAncestorNodes-&gt;Clear();</span>
<span class="lineNum">    2418 </span>            :   }
<span class="lineNum">    2419 </span>            : 
<span class="lineNum">    2420 </span><span class="lineNoCov">          0 :   if (!aAncestorOffsets-&gt;IsEmpty()) {</span>
<span class="lineNum">    2421 </span>            :     NS_WARNING(&quot;aAncestorOffsets is not empty&quot;);
<span class="lineNum">    2422 </span><span class="lineNoCov">          0 :     aAncestorOffsets-&gt;Clear();</span>
<span class="lineNum">    2423 </span>            :   }
<span class="lineNum">    2424 </span>            : 
<span class="lineNum">    2425 </span>            :   // insert the node itself
<span class="lineNum">    2426 </span><span class="lineNoCov">          0 :   aAncestorNodes-&gt;AppendElement(content.get());</span>
<span class="lineNum">    2427 </span><span class="lineNoCov">          0 :   aAncestorOffsets-&gt;AppendElement(aOffset);</span>
<span class="lineNum">    2428 </span>            : 
<span class="lineNum">    2429 </span>            :   // insert all the ancestors
<span class="lineNum">    2430 </span><span class="lineNoCov">          0 :   nsIContent* child = content;</span>
<span class="lineNum">    2431 </span><span class="lineNoCov">          0 :   nsIContent* parent = child-&gt;GetParent();</span>
<span class="lineNum">    2432 </span><span class="lineNoCov">          0 :   while (parent) {</span>
<span class="lineNum">    2433 </span><span class="lineNoCov">          0 :     aAncestorNodes-&gt;AppendElement(parent);</span>
<span class="lineNum">    2434 </span><span class="lineNoCov">          0 :     aAncestorOffsets-&gt;AppendElement(parent-&gt;IndexOf(child));</span>
<span class="lineNum">    2435 </span><span class="lineNoCov">          0 :     child = parent;</span>
<span class="lineNum">    2436 </span><span class="lineNoCov">          0 :     parent = parent-&gt;GetParent();</span>
<span class="lineNum">    2437 </span>            :   }
<span class="lineNum">    2438 </span>            : 
<span class="lineNum">    2439 </span>            :   return NS_OK;
<span class="lineNum">    2440 </span>            : }
<span class="lineNum">    2441 </span>            : 
<span class="lineNum">    2442 </span>            : // static
<span class="lineNum">    2443 </span>            : nsresult
<span class="lineNum">    2444 </span><span class="lineNoCov">          0 : nsContentUtils::GetCommonAncestor(nsIDOMNode *aNode,</span>
<span class="lineNum">    2445 </span>            :                                   nsIDOMNode *aOther,
<span class="lineNum">    2446 </span>            :                                   nsIDOMNode** aCommonAncestor)
<span class="lineNum">    2447 </span>            : {
<span class="lineNum">    2448 </span><span class="lineNoCov">          0 :   *aCommonAncestor = nullptr;</span>
<span class="lineNum">    2449 </span>            : 
<span class="lineNum">    2450 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsINode&gt; node1 = do_QueryInterface(aNode);</span>
<span class="lineNum">    2451 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsINode&gt; node2 = do_QueryInterface(aOther);</span>
<span class="lineNum">    2452 </span>            : 
<span class="lineNum">    2453 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(node1 &amp;&amp; node2, NS_ERROR_UNEXPECTED);</span>
<span class="lineNum">    2454 </span>            : 
<span class="lineNum">    2455 </span><span class="lineNoCov">          0 :   nsINode* common = GetCommonAncestor(node1, node2);</span>
<span class="lineNum">    2456 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(common, NS_ERROR_NOT_AVAILABLE);</span>
<span class="lineNum">    2457 </span>            : 
<span class="lineNum">    2458 </span><span class="lineNoCov">          0 :   return CallQueryInterface(common, aCommonAncestor);</span>
<span class="lineNum">    2459 </span>            : }
<span class="lineNum">    2460 </span>            : 
<a name="2461"><span class="lineNum">    2461 </span>            : // static</a>
<span class="lineNum">    2462 </span>            : nsINode*
<span class="lineNum">    2463 </span><span class="lineNoCov">          0 : nsContentUtils::GetCommonAncestor(nsINode* aNode1,</span>
<span class="lineNum">    2464 </span>            :                                   nsINode* aNode2)
<span class="lineNum">    2465 </span>            : {
<span class="lineNum">    2466 </span><span class="lineNoCov">          0 :   if (aNode1 == aNode2) {</span>
<span class="lineNum">    2467 </span>            :     return aNode1;
<span class="lineNum">    2468 </span>            :   }
<span class="lineNum">    2469 </span>            : 
<span class="lineNum">    2470 </span>            :   // Build the chain of parents
<span class="lineNum">    2471 </span><span class="lineNoCov">          0 :   AutoTArray&lt;nsINode*, 30&gt; parents1, parents2;</span>
<span class="lineNum">    2472 </span><span class="lineNoCov">          0 :   do {</span>
<span class="lineNum">    2473 </span><span class="lineNoCov">          0 :     parents1.AppendElement(aNode1);</span>
<span class="lineNum">    2474 </span><span class="lineNoCov">          0 :     aNode1 = aNode1-&gt;GetParentNode();</span>
<span class="lineNum">    2475 </span>            :   } while (aNode1);
<span class="lineNum">    2476 </span><span class="lineNoCov">          0 :   do {</span>
<span class="lineNum">    2477 </span><span class="lineNoCov">          0 :     parents2.AppendElement(aNode2);</span>
<span class="lineNum">    2478 </span><span class="lineNoCov">          0 :     aNode2 = aNode2-&gt;GetParentNode();</span>
<span class="lineNum">    2479 </span>            :   } while (aNode2);
<span class="lineNum">    2480 </span>            : 
<span class="lineNum">    2481 </span>            :   // Find where the parent chain differs
<span class="lineNum">    2482 </span><span class="lineNoCov">          0 :   uint32_t pos1 = parents1.Length();</span>
<span class="lineNum">    2483 </span><span class="lineNoCov">          0 :   uint32_t pos2 = parents2.Length();</span>
<span class="lineNum">    2484 </span><span class="lineNoCov">          0 :   nsINode* parent = nullptr;</span>
<span class="lineNum">    2485 </span>            :   uint32_t len;
<span class="lineNum">    2486 </span><span class="lineNoCov">          0 :   for (len = std::min(pos1, pos2); len &gt; 0; --len) {</span>
<span class="lineNum">    2487 </span><span class="lineNoCov">          0 :     nsINode* child1 = parents1.ElementAt(--pos1);</span>
<span class="lineNum">    2488 </span><span class="lineNoCov">          0 :     nsINode* child2 = parents2.ElementAt(--pos2);</span>
<span class="lineNum">    2489 </span><span class="lineNoCov">          0 :     if (child1 != child2) {</span>
<span class="lineNum">    2490 </span>            :       break;
<span class="lineNum">    2491 </span>            :     }
<span class="lineNum">    2492 </span><span class="lineNoCov">          0 :     parent = child1;</span>
<span class="lineNum">    2493 </span>            :   }
<span class="lineNum">    2494 </span>            : 
<span class="lineNum">    2495 </span><span class="lineNoCov">          0 :   return parent;</span>
<span class="lineNum">    2496 </span>            : }
<span class="lineNum">    2497 </span>            : 
<a name="2498"><span class="lineNum">    2498 </span>            : /* static */</a>
<span class="lineNum">    2499 </span>            : bool
<span class="lineNum">    2500 </span><span class="lineNoCov">          0 : nsContentUtils::PositionIsBefore(nsINode* aNode1, nsINode* aNode2)</span>
<span class="lineNum">    2501 </span>            : {
<span class="lineNum">    2502 </span><span class="lineNoCov">          0 :   return (aNode2-&gt;CompareDocumentPosition(*aNode1) &amp;</span>
<span class="lineNum">    2503 </span>            :     (nsIDOMNode::DOCUMENT_POSITION_PRECEDING |
<span class="lineNum">    2504 </span>            :      nsIDOMNode::DOCUMENT_POSITION_DISCONNECTED)) ==
<span class="lineNum">    2505 </span><span class="lineNoCov">          0 :     nsIDOMNode::DOCUMENT_POSITION_PRECEDING;</span>
<span class="lineNum">    2506 </span>            : }
<span class="lineNum">    2507 </span>            : 
<a name="2508"><span class="lineNum">    2508 </span>            : /* static */</a>
<span class="lineNum">    2509 </span>            : int32_t
<span class="lineNum">    2510 </span><span class="lineNoCov">          0 : nsContentUtils::ComparePoints(nsINode* aParent1, int32_t aOffset1,</span>
<span class="lineNum">    2511 </span>            :                               nsINode* aParent2, int32_t aOffset2,
<span class="lineNum">    2512 </span>            :                               bool* aDisconnected)
<span class="lineNum">    2513 </span>            : {
<span class="lineNum">    2514 </span><span class="lineNoCov">          0 :   if (aParent1 == aParent2) {</span>
<span class="lineNum">    2515 </span>            :     return aOffset1 &lt; aOffset2 ? -1 :
<span class="lineNum">    2516 </span>            :            aOffset1 &gt; aOffset2 ? 1 :
<span class="lineNum">    2517 </span><span class="lineNoCov">          0 :            0;</span>
<span class="lineNum">    2518 </span>            :   }
<span class="lineNum">    2519 </span>            : 
<span class="lineNum">    2520 </span><span class="lineNoCov">          0 :   AutoTArray&lt;nsINode*, 32&gt; parents1, parents2;</span>
<span class="lineNum">    2521 </span><span class="lineNoCov">          0 :   nsINode* node1 = aParent1;</span>
<span class="lineNum">    2522 </span><span class="lineNoCov">          0 :   nsINode* node2 = aParent2;</span>
<span class="lineNum">    2523 </span><span class="lineNoCov">          0 :   do {</span>
<span class="lineNum">    2524 </span><span class="lineNoCov">          0 :     parents1.AppendElement(node1);</span>
<span class="lineNum">    2525 </span><span class="lineNoCov">          0 :     node1 = node1-&gt;GetParentNode();</span>
<span class="lineNum">    2526 </span>            :   } while (node1);
<span class="lineNum">    2527 </span><span class="lineNoCov">          0 :   do {</span>
<span class="lineNum">    2528 </span><span class="lineNoCov">          0 :     parents2.AppendElement(node2);</span>
<span class="lineNum">    2529 </span><span class="lineNoCov">          0 :     node2 = node2-&gt;GetParentNode();</span>
<span class="lineNum">    2530 </span>            :   } while (node2);
<span class="lineNum">    2531 </span>            : 
<span class="lineNum">    2532 </span><span class="lineNoCov">          0 :   uint32_t pos1 = parents1.Length() - 1;</span>
<span class="lineNum">    2533 </span><span class="lineNoCov">          0 :   uint32_t pos2 = parents2.Length() - 1;</span>
<span class="lineNum">    2534 </span>            : 
<span class="lineNum">    2535 </span><span class="lineNoCov">          0 :   bool disconnected = parents1.ElementAt(pos1) != parents2.ElementAt(pos2);</span>
<span class="lineNum">    2536 </span><span class="lineNoCov">          0 :   if (aDisconnected) {</span>
<span class="lineNum">    2537 </span><span class="lineNoCov">          0 :     *aDisconnected = disconnected;</span>
<span class="lineNum">    2538 </span>            :   }
<span class="lineNum">    2539 </span><span class="lineNoCov">          0 :   if (disconnected) {</span>
<span class="lineNum">    2540 </span>            :     NS_ASSERTION(aDisconnected, &quot;unexpected disconnected nodes&quot;);
<span class="lineNum">    2541 </span>            :     return 1;
<span class="lineNum">    2542 </span>            :   }
<span class="lineNum">    2543 </span>            : 
<span class="lineNum">    2544 </span>            :   // Find where the parent chains differ
<span class="lineNum">    2545 </span><span class="lineNoCov">          0 :   nsINode* parent = parents1.ElementAt(pos1);</span>
<span class="lineNum">    2546 </span>            :   uint32_t len;
<span class="lineNum">    2547 </span><span class="lineNoCov">          0 :   for (len = std::min(pos1, pos2); len &gt; 0; --len) {</span>
<span class="lineNum">    2548 </span><span class="lineNoCov">          0 :     nsINode* child1 = parents1.ElementAt(--pos1);</span>
<span class="lineNum">    2549 </span><span class="lineNoCov">          0 :     nsINode* child2 = parents2.ElementAt(--pos2);</span>
<span class="lineNum">    2550 </span><span class="lineNoCov">          0 :     if (child1 != child2) {</span>
<span class="lineNum">    2551 </span><span class="lineNoCov">          0 :       return parent-&gt;IndexOf(child1) &lt; parent-&gt;IndexOf(child2) ? -1 : 1;</span>
<span class="lineNum">    2552 </span>            :     }
<span class="lineNum">    2553 </span><span class="lineNoCov">          0 :     parent = child1;</span>
<span class="lineNum">    2554 </span>            :   }
<span class="lineNum">    2555 </span>            : 
<span class="lineNum">    2556 </span>            : 
<span class="lineNum">    2557 </span>            :   // The parent chains never differed, so one of the nodes is an ancestor of
<span class="lineNum">    2558 </span>            :   // the other
<span class="lineNum">    2559 </span>            : 
<span class="lineNum">    2560 </span>            :   NS_ASSERTION(!pos1 || !pos2,
<span class="lineNum">    2561 </span>            :                &quot;should have run out of parent chain for one of the nodes&quot;);
<span class="lineNum">    2562 </span>            : 
<span class="lineNum">    2563 </span><span class="lineNoCov">          0 :   if (!pos1) {</span>
<span class="lineNum">    2564 </span><span class="lineNoCov">          0 :     nsINode* child2 = parents2.ElementAt(--pos2);</span>
<span class="lineNum">    2565 </span><span class="lineNoCov">          0 :     return aOffset1 &lt;= parent-&gt;IndexOf(child2) ? -1 : 1;</span>
<span class="lineNum">    2566 </span>            :   }
<span class="lineNum">    2567 </span>            : 
<span class="lineNum">    2568 </span><span class="lineNoCov">          0 :   nsINode* child1 = parents1.ElementAt(--pos1);</span>
<span class="lineNum">    2569 </span><span class="lineNoCov">          0 :   return parent-&gt;IndexOf(child1) &lt; aOffset2 ? -1 : 1;</span>
<span class="lineNum">    2570 </span>            : }
<span class="lineNum">    2571 </span>            : 
<span class="lineNum">    2572 </span>            : /* static */
<span class="lineNum">    2573 </span>            : int32_t
<span class="lineNum">    2574 </span><span class="lineNoCov">          0 : nsContentUtils::ComparePoints(nsIDOMNode* aParent1, int32_t aOffset1,</span>
<span class="lineNum">    2575 </span>            :                               nsIDOMNode* aParent2, int32_t aOffset2,
<span class="lineNum">    2576 </span>            :                               bool* aDisconnected)
<span class="lineNum">    2577 </span>            : {
<span class="lineNum">    2578 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsINode&gt; parent1 = do_QueryInterface(aParent1);</span>
<span class="lineNum">    2579 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsINode&gt; parent2 = do_QueryInterface(aParent2);</span>
<span class="lineNum">    2580 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(parent1 &amp;&amp; parent2, -1);</span>
<span class="lineNum">    2581 </span><span class="lineNoCov">          0 :   return ComparePoints(parent1, aOffset1, parent2, aOffset2);</span>
<span class="lineNum">    2582 </span>            : }
<a name="2583"><span class="lineNum">    2583 </span>            : </a>
<span class="lineNum">    2584 </span>            : inline bool
<span class="lineNum">    2585 </span><span class="lineNoCov">          0 : IsCharInSet(const char* aSet,</span>
<span class="lineNum">    2586 </span>            :             const char16_t aChar)
<span class="lineNum">    2587 </span>            : {
<span class="lineNum">    2588 </span>            :   char16_t ch;
<span class="lineNum">    2589 </span><span class="lineNoCov">          0 :   while ((ch = *aSet)) {</span>
<span class="lineNum">    2590 </span><span class="lineNoCov">          0 :     if (aChar == char16_t(ch)) {</span>
<span class="lineNum">    2591 </span>            :       return true;
<span class="lineNum">    2592 </span>            :     }
<span class="lineNum">    2593 </span><span class="lineNoCov">          0 :     ++aSet;</span>
<span class="lineNum">    2594 </span>            :   }
<span class="lineNum">    2595 </span>            :   return false;
<span class="lineNum">    2596 </span>            : }
<span class="lineNum">    2597 </span>            : 
<span class="lineNum">    2598 </span>            : /**
<span class="lineNum">    2599 </span>            :  * This method strips leading/trailing chars, in given set, from string.
<span class="lineNum">    2600 </span>            :  */
<span class="lineNum">    2601 </span>            : 
<a name="2602"><span class="lineNum">    2602 </span>            : // static</a>
<span class="lineNum">    2603 </span>            : const nsDependentSubstring
<span class="lineNum">    2604 </span><span class="lineNoCov">          0 : nsContentUtils::TrimCharsInSet(const char* aSet,</span>
<span class="lineNum">    2605 </span>            :                                const nsAString&amp; aValue)
<span class="lineNum">    2606 </span>            : {
<span class="lineNum">    2607 </span>            :   nsAString::const_iterator valueCurrent, valueEnd;
<span class="lineNum">    2608 </span>            : 
<span class="lineNum">    2609 </span><span class="lineNoCov">          0 :   aValue.BeginReading(valueCurrent);</span>
<span class="lineNum">    2610 </span><span class="lineNoCov">          0 :   aValue.EndReading(valueEnd);</span>
<span class="lineNum">    2611 </span>            : 
<span class="lineNum">    2612 </span>            :   // Skip characters in the beginning
<span class="lineNum">    2613 </span><span class="lineNoCov">          0 :   while (valueCurrent != valueEnd) {</span>
<span class="lineNum">    2614 </span><span class="lineNoCov">          0 :     if (!IsCharInSet(aSet, *valueCurrent)) {</span>
<span class="lineNum">    2615 </span>            :       break;
<span class="lineNum">    2616 </span>            :     }
<span class="lineNum">    2617 </span>            :     ++valueCurrent;
<span class="lineNum">    2618 </span>            :   }
<span class="lineNum">    2619 </span>            : 
<span class="lineNum">    2620 </span><span class="lineNoCov">          0 :   if (valueCurrent != valueEnd) {</span>
<span class="lineNum">    2621 </span>            :     for (;;) {
<span class="lineNum">    2622 </span>            :       --valueEnd;
<span class="lineNum">    2623 </span><span class="lineNoCov">          0 :       if (!IsCharInSet(aSet, *valueEnd)) {</span>
<span class="lineNum">    2624 </span>            :         break;
<span class="lineNum">    2625 </span>            :       }
<span class="lineNum">    2626 </span>            :     }
<span class="lineNum">    2627 </span>            :     ++valueEnd; // Step beyond the last character we want in the value.
<span class="lineNum">    2628 </span>            :   }
<span class="lineNum">    2629 </span>            : 
<span class="lineNum">    2630 </span>            :   // valueEnd should point to the char after the last to copy
<span class="lineNum">    2631 </span><span class="lineNoCov">          0 :   return Substring(valueCurrent, valueEnd);</span>
<span class="lineNum">    2632 </span>            : }
<span class="lineNum">    2633 </span>            : 
<span class="lineNum">    2634 </span>            : /**
<span class="lineNum">    2635 </span>            :  * This method strips leading and trailing whitespace from a string.
<span class="lineNum">    2636 </span>            :  */
<span class="lineNum">    2637 </span>            : 
<span class="lineNum">    2638 </span>            : // static
<a name="2639"><span class="lineNum">    2639 </span>            : template&lt;bool IsWhitespace(char16_t)&gt;</a>
<span class="lineNum">    2640 </span>            : const nsDependentSubstring
<span class="lineNum">    2641 </span><span class="lineNoCov">          0 : nsContentUtils::TrimWhitespace(const nsAString&amp; aStr, bool aTrimTrailing)</span>
<span class="lineNum">    2642 </span>            : {
<span class="lineNum">    2643 </span>            :   nsAString::const_iterator start, end;
<span class="lineNum">    2644 </span>            : 
<span class="lineNum">    2645 </span><span class="lineNoCov">          0 :   aStr.BeginReading(start);</span>
<span class="lineNum">    2646 </span><span class="lineNoCov">          0 :   aStr.EndReading(end);</span>
<span class="lineNum">    2647 </span>            : 
<span class="lineNum">    2648 </span>            :   // Skip whitespace characters in the beginning
<span class="lineNum">    2649 </span><span class="lineNoCov">          0 :   while (start != end &amp;&amp; IsWhitespace(*start)) {</span>
<span class="lineNum">    2650 </span>            :     ++start;
<span class="lineNum">    2651 </span>            :   }
<span class="lineNum">    2652 </span>            : 
<span class="lineNum">    2653 </span><span class="lineNoCov">          0 :   if (aTrimTrailing) {</span>
<span class="lineNum">    2654 </span>            :     // Skip whitespace characters in the end.
<span class="lineNum">    2655 </span><span class="lineNoCov">          0 :     while (end != start) {</span>
<span class="lineNum">    2656 </span>            :       --end;
<span class="lineNum">    2657 </span>            : 
<span class="lineNum">    2658 </span><span class="lineNoCov">          0 :       if (!IsWhitespace(*end)) {</span>
<span class="lineNum">    2659 </span>            :         // Step back to the last non-whitespace character.
<span class="lineNum">    2660 </span>            :         ++end;
<span class="lineNum">    2661 </span>            : 
<span class="lineNum">    2662 </span>            :         break;
<span class="lineNum">    2663 </span>            :       }
<span class="lineNum">    2664 </span>            :     }
<span class="lineNum">    2665 </span>            :   }
<span class="lineNum">    2666 </span>            : 
<span class="lineNum">    2667 </span>            :   // Return a substring for the string w/o leading and/or trailing
<span class="lineNum">    2668 </span>            :   // whitespace
<span class="lineNum">    2669 </span>            : 
<span class="lineNum">    2670 </span><span class="lineNoCov">          0 :   return Substring(start, end);</span>
<span class="lineNum">    2671 </span>            : }
<span class="lineNum">    2672 </span>            : 
<span class="lineNum">    2673 </span>            : // Declaring the templates we are going to use avoid linking issues without
<span class="lineNum">    2674 </span>            : // inlining the method. Considering there is not so much spaces checking
<span class="lineNum">    2675 </span>            : // methods we can consider this to be better than inlining.
<span class="lineNum">    2676 </span>            : template
<span class="lineNum">    2677 </span>            : const nsDependentSubstring
<span class="lineNum">    2678 </span>            : nsContentUtils::TrimWhitespace&lt;nsCRT::IsAsciiSpace&gt;(const nsAString&amp;, bool);
<span class="lineNum">    2679 </span>            : template
<span class="lineNum">    2680 </span>            : const nsDependentSubstring
<span class="lineNum">    2681 </span>            : nsContentUtils::TrimWhitespace&lt;nsContentUtils::IsHTMLWhitespace&gt;(const nsAString&amp;, bool);
<span class="lineNum">    2682 </span>            : template
<span class="lineNum">    2683 </span>            : const nsDependentSubstring
<a name="2684"><span class="lineNum">    2684 </span>            : nsContentUtils::TrimWhitespace&lt;nsContentUtils::IsHTMLWhitespaceOrNBSP&gt;(const nsAString&amp;, bool);</a>
<span class="lineNum">    2685 </span>            : 
<span class="lineNum">    2686 </span><span class="lineNoCov">          0 : static inline void KeyAppendSep(nsACString&amp; aKey)</span>
<span class="lineNum">    2687 </span>            : {
<span class="lineNum">    2688 </span><span class="lineNoCov">          0 :   if (!aKey.IsEmpty()) {</span>
<span class="lineNum">    2689 </span><span class="lineNoCov">          0 :     aKey.Append('&gt;');</span>
<span class="lineNum">    2690 </span>            :   }
<a name="2691"><span class="lineNum">    2691 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2692 </span>            : 
<span class="lineNum">    2693 </span><span class="lineNoCov">          0 : static inline void KeyAppendString(const nsAString&amp; aString, nsACString&amp; aKey)</span>
<span class="lineNum">    2694 </span>            : {
<span class="lineNum">    2695 </span><span class="lineNoCov">          0 :   KeyAppendSep(aKey);</span>
<span class="lineNum">    2696 </span>            : 
<span class="lineNum">    2697 </span>            :   // Could escape separator here if collisions happen.  &gt; is not a legal char
<span class="lineNum">    2698 </span>            :   // for a name or type attribute, so we should be safe avoiding that extra work.
<span class="lineNum">    2699 </span>            : 
<span class="lineNum">    2700 </span><span class="lineNoCov">          0 :   AppendUTF16toUTF8(aString, aKey);</span>
<a name="2701"><span class="lineNum">    2701 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2702 </span>            : 
<span class="lineNum">    2703 </span><span class="lineNoCov">          0 : static inline void KeyAppendString(const nsACString&amp; aString, nsACString&amp; aKey)</span>
<span class="lineNum">    2704 </span>            : {
<span class="lineNum">    2705 </span><span class="lineNoCov">          0 :   KeyAppendSep(aKey);</span>
<span class="lineNum">    2706 </span>            : 
<span class="lineNum">    2707 </span>            :   // Could escape separator here if collisions happen.  &gt; is not a legal char
<span class="lineNum">    2708 </span>            :   // for a name or type attribute, so we should be safe avoiding that extra work.
<span class="lineNum">    2709 </span>            : 
<span class="lineNum">    2710 </span><span class="lineNoCov">          0 :   aKey.Append(aString);</span>
<a name="2711"><span class="lineNum">    2711 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2712 </span>            : 
<span class="lineNum">    2713 </span><span class="lineNoCov">          0 : static inline void KeyAppendInt(int32_t aInt, nsACString&amp; aKey)</span>
<span class="lineNum">    2714 </span>            : {
<span class="lineNum">    2715 </span><span class="lineNoCov">          0 :   KeyAppendSep(aKey);</span>
<span class="lineNum">    2716 </span>            : 
<span class="lineNum">    2717 </span><span class="lineNoCov">          0 :   aKey.Append(nsPrintfCString(&quot;%d&quot;, aInt));</span>
<a name="2718"><span class="lineNum">    2718 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    2719 </span>            : 
<span class="lineNum">    2720 </span><span class="lineNoCov">          0 : static inline bool IsAutocompleteOff(const nsIContent* aElement)</span>
<span class="lineNum">    2721 </span>            : {
<span class="lineNum">    2722 </span>            :   return aElement-&gt;AttrValueIs(kNameSpaceID_None, nsGkAtoms::autocomplete,
<span class="lineNum">    2723 </span><span class="lineNoCov">          0 :                                NS_LITERAL_STRING(&quot;off&quot;), eIgnoreCase);</span>
<span class="lineNum">    2724 </span>            : }
<span class="lineNum">    2725 </span>            : 
<span class="lineNum">    2726 </span>            : /*static*/ nsresult
<span class="lineNum">    2727 </span><span class="lineNoCov">          0 : nsContentUtils::GenerateStateKey(nsIContent* aContent,</span>
<span class="lineNum">    2728 </span>            :                                  const nsIDocument* aDocument,
<span class="lineNum">    2729 </span>            :                                  nsACString&amp; aKey)
<span class="lineNum">    2730 </span>            : {
<span class="lineNum">    2731 </span>            :   aKey.Truncate();
<span class="lineNum">    2732 </span>            : 
<span class="lineNum">    2733 </span><span class="lineNoCov">          0 :   uint32_t partID = aDocument ? aDocument-&gt;GetPartID() : 0;</span>
<span class="lineNum">    2734 </span>            : 
<span class="lineNum">    2735 </span>            :   // We must have content if we're not using a special state id
<span class="lineNum">    2736 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(aContent, NS_ERROR_FAILURE);</span>
<span class="lineNum">    2737 </span>            : 
<span class="lineNum">    2738 </span>            :   // Don't capture state for anonymous content
<span class="lineNum">    2739 </span><span class="lineNoCov">          0 :   if (aContent-&gt;IsInAnonymousSubtree()) {</span>
<span class="lineNum">    2740 </span>            :     return NS_OK;
<span class="lineNum">    2741 </span>            :   }
<span class="lineNum">    2742 </span>            : 
<span class="lineNum">    2743 </span><span class="lineNoCov">          0 :   if (IsAutocompleteOff(aContent)) {</span>
<span class="lineNum">    2744 </span>            :     return NS_OK;
<span class="lineNum">    2745 </span>            :   }
<span class="lineNum">    2746 </span>            : 
<span class="lineNum">    2747 </span>            :   nsCOMPtr&lt;nsIHTMLDocument&gt; htmlDocument =
<span class="lineNum">    2748 </span><span class="lineNoCov">          0 :     do_QueryInterface(aContent-&gt;GetUncomposedDoc());</span>
<span class="lineNum">    2749 </span>            : 
<span class="lineNum">    2750 </span><span class="lineNoCov">          0 :   KeyAppendInt(partID, aKey);  // first append a partID</span>
<span class="lineNum">    2751 </span><span class="lineNoCov">          0 :   bool generatedUniqueKey = false;</span>
<span class="lineNum">    2752 </span>            : 
<span class="lineNum">    2753 </span><span class="lineNoCov">          0 :   if (htmlDocument) {</span>
<span class="lineNum">    2754 </span>            :     // Flush our content model so it'll be up to date
<span class="lineNum">    2755 </span>            :     // If this becomes unnecessary and the following line is removed,
<span class="lineNum">    2756 </span>            :     // please also remove the corresponding flush operation from
<span class="lineNum">    2757 </span>            :     // nsHtml5TreeBuilderCppSupplement.h. (Look for &quot;See bug 497861.&quot; there.)
<span class="lineNum">    2758 </span><span class="lineNoCov">          0 :     aContent-&gt;GetUncomposedDoc()-&gt;FlushPendingNotifications(FlushType::Content);</span>
<span class="lineNum">    2759 </span>            : 
<span class="lineNum">    2760 </span><span class="lineNoCov">          0 :     nsContentList *htmlForms = htmlDocument-&gt;GetForms();</span>
<span class="lineNum">    2761 </span><span class="lineNoCov">          0 :     nsContentList *htmlFormControls = htmlDocument-&gt;GetFormControls();</span>
<span class="lineNum">    2762 </span>            : 
<span class="lineNum">    2763 </span><span class="lineNoCov">          0 :     NS_ENSURE_TRUE(htmlForms &amp;&amp; htmlFormControls, NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">    2764 </span>            : 
<span class="lineNum">    2765 </span>            :     // If we have a form control and can calculate form information, use that
<span class="lineNum">    2766 </span>            :     // as the key - it is more reliable than just recording position in the
<span class="lineNum">    2767 </span>            :     // DOM.
<span class="lineNum">    2768 </span>            :     // XXXbz Is it, really?  We have bugs on this, I think...
<span class="lineNum">    2769 </span>            :     // Important to have a unique key, and tag/type/name may not be.
<span class="lineNum">    2770 </span>            :     //
<span class="lineNum">    2771 </span>            :     // If the control has a form, the format of the key is:
<span class="lineNum">    2772 </span>            :     // f&gt;type&gt;IndOfFormInDoc&gt;IndOfControlInForm&gt;FormName&gt;name
<span class="lineNum">    2773 </span>            :     // else:
<span class="lineNum">    2774 </span>            :     // d&gt;type&gt;IndOfControlInDoc&gt;name
<span class="lineNum">    2775 </span>            :     //
<span class="lineNum">    2776 </span>            :     // XXX We don't need to use index if name is there
<span class="lineNum">    2777 </span>            :     // XXXbz We don't?  Why not?  I don't follow.
<span class="lineNum">    2778 </span>            :     //
<span class="lineNum">    2779 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIFormControl&gt; control(do_QueryInterface(aContent));</span>
<span class="lineNum">    2780 </span><span class="lineNoCov">          0 :     if (control &amp;&amp; htmlFormControls &amp;&amp; htmlForms) {</span>
<span class="lineNum">    2781 </span>            : 
<span class="lineNum">    2782 </span>            :       // Append the control type
<span class="lineNum">    2783 </span><span class="lineNoCov">          0 :       KeyAppendInt(control-&gt;ControlType(), aKey);</span>
<span class="lineNum">    2784 </span>            : 
<span class="lineNum">    2785 </span>            :       // If in a form, add form name / index of form / index in form
<span class="lineNum">    2786 </span><span class="lineNoCov">          0 :       int32_t index = -1;</span>
<span class="lineNum">    2787 </span><span class="lineNoCov">          0 :       Element *formElement = control-&gt;GetFormElement();</span>
<span class="lineNum">    2788 </span><span class="lineNoCov">          0 :       if (formElement) {</span>
<span class="lineNum">    2789 </span><span class="lineNoCov">          0 :         if (IsAutocompleteOff(formElement)) {</span>
<span class="lineNum">    2790 </span>            :           aKey.Truncate();
<span class="lineNum">    2791 </span><span class="lineNoCov">          0 :           return NS_OK;</span>
<span class="lineNum">    2792 </span>            :         }
<span class="lineNum">    2793 </span>            : 
<span class="lineNum">    2794 </span><span class="lineNoCov">          0 :         KeyAppendString(NS_LITERAL_CSTRING(&quot;f&quot;), aKey);</span>
<span class="lineNum">    2795 </span>            : 
<span class="lineNum">    2796 </span>            :         // Append the index of the form in the document
<span class="lineNum">    2797 </span><span class="lineNoCov">          0 :         index = htmlForms-&gt;IndexOf(formElement, false);</span>
<span class="lineNum">    2798 </span><span class="lineNoCov">          0 :         if (index &lt;= -1) {</span>
<span class="lineNum">    2799 </span>            :           //
<span class="lineNum">    2800 </span>            :           // XXX HACK this uses some state that was dumped into the document
<span class="lineNum">    2801 </span>            :           // specifically to fix bug 138892.  What we are trying to do is *guess*
<span class="lineNum">    2802 </span>            :           // which form this control's state is found in, with the highly likely
<span class="lineNum">    2803 </span>            :           // guess that the highest form parsed so far is the one.
<span class="lineNum">    2804 </span>            :           // This code should not be on trunk, only branch.
<span class="lineNum">    2805 </span>            :           //
<span class="lineNum">    2806 </span><span class="lineNoCov">          0 :           index = htmlDocument-&gt;GetNumFormsSynchronous() - 1;</span>
<span class="lineNum">    2807 </span>            :         }
<span class="lineNum">    2808 </span><span class="lineNoCov">          0 :         if (index &gt; -1) {</span>
<span class="lineNum">    2809 </span><span class="lineNoCov">          0 :           KeyAppendInt(index, aKey);</span>
<span class="lineNum">    2810 </span>            : 
<span class="lineNum">    2811 </span>            :           // Append the index of the control in the form
<span class="lineNum">    2812 </span><span class="lineNoCov">          0 :           nsCOMPtr&lt;nsIForm&gt; form(do_QueryInterface(formElement));</span>
<span class="lineNum">    2813 </span><span class="lineNoCov">          0 :           index = form-&gt;IndexOfControl(control);</span>
<span class="lineNum">    2814 </span>            : 
<span class="lineNum">    2815 </span><span class="lineNoCov">          0 :           if (index &gt; -1) {</span>
<span class="lineNum">    2816 </span><span class="lineNoCov">          0 :             KeyAppendInt(index, aKey);</span>
<span class="lineNum">    2817 </span><span class="lineNoCov">          0 :             generatedUniqueKey = true;</span>
<span class="lineNum">    2818 </span>            :           }
<span class="lineNum">    2819 </span>            :         }
<span class="lineNum">    2820 </span>            : 
<span class="lineNum">    2821 </span>            :         // Append the form name
<span class="lineNum">    2822 </span><span class="lineNoCov">          0 :         nsAutoString formName;</span>
<span class="lineNum">    2823 </span><span class="lineNoCov">          0 :         formElement-&gt;GetAttr(kNameSpaceID_None, nsGkAtoms::name, formName);</span>
<span class="lineNum">    2824 </span><span class="lineNoCov">          0 :         KeyAppendString(formName, aKey);</span>
<span class="lineNum">    2825 </span>            : 
<span class="lineNum">    2826 </span>            :       } else {
<span class="lineNum">    2827 </span>            : 
<span class="lineNum">    2828 </span><span class="lineNoCov">          0 :         KeyAppendString(NS_LITERAL_CSTRING(&quot;d&quot;), aKey);</span>
<span class="lineNum">    2829 </span>            : 
<span class="lineNum">    2830 </span>            :         // If not in a form, add index of control in document
<span class="lineNum">    2831 </span>            :         // Less desirable than indexing by form info.
<span class="lineNum">    2832 </span>            : 
<span class="lineNum">    2833 </span>            :         // Hash by index of control in doc (we are not in a form)
<span class="lineNum">    2834 </span>            :         // These are important as they are unique, and type/name may not be.
<span class="lineNum">    2835 </span>            : 
<span class="lineNum">    2836 </span>            :         // We have to flush sink notifications at this point to make
<span class="lineNum">    2837 </span>            :         // sure that htmlFormControls is up to date.
<span class="lineNum">    2838 </span><span class="lineNoCov">          0 :         index = htmlFormControls-&gt;IndexOf(aContent, true);</span>
<span class="lineNum">    2839 </span><span class="lineNoCov">          0 :         if (index &gt; -1) {</span>
<span class="lineNum">    2840 </span><span class="lineNoCov">          0 :           KeyAppendInt(index, aKey);</span>
<span class="lineNum">    2841 </span><span class="lineNoCov">          0 :           generatedUniqueKey = true;</span>
<span class="lineNum">    2842 </span>            :         }
<span class="lineNum">    2843 </span>            :       }
<span class="lineNum">    2844 </span>            : 
<span class="lineNum">    2845 </span>            :       // Append the control name
<span class="lineNum">    2846 </span><span class="lineNoCov">          0 :       nsAutoString name;</span>
<span class="lineNum">    2847 </span><span class="lineNoCov">          0 :       aContent-&gt;GetAttr(kNameSpaceID_None, nsGkAtoms::name, name);</span>
<span class="lineNum">    2848 </span><span class="lineNoCov">          0 :       KeyAppendString(name, aKey);</span>
<span class="lineNum">    2849 </span>            :     }
<span class="lineNum">    2850 </span>            :   }
<span class="lineNum">    2851 </span>            : 
<span class="lineNum">    2852 </span><span class="lineNoCov">          0 :   if (!generatedUniqueKey) {</span>
<span class="lineNum">    2853 </span>            :     // Either we didn't have a form control or we aren't in an HTML document so
<span class="lineNum">    2854 </span>            :     // we can't figure out form info.  Append the tag name if it's an element
<span class="lineNum">    2855 </span>            :     // to avoid restoring state for one type of element on another type.
<span class="lineNum">    2856 </span><span class="lineNoCov">          0 :     if (aContent-&gt;IsElement()) {</span>
<span class="lineNum">    2857 </span><span class="lineNoCov">          0 :       KeyAppendString(nsDependentAtomString(aContent-&gt;NodeInfo()-&gt;NameAtom()),</span>
<span class="lineNum">    2858 </span><span class="lineNoCov">          0 :                       aKey);</span>
<span class="lineNum">    2859 </span>            :     }
<span class="lineNum">    2860 </span>            :     else {
<span class="lineNum">    2861 </span>            :       // Append a character that is not &quot;d&quot; or &quot;f&quot; to disambiguate from
<span class="lineNum">    2862 </span>            :       // the case when we were a form control in an HTML document.
<span class="lineNum">    2863 </span><span class="lineNoCov">          0 :       KeyAppendString(NS_LITERAL_CSTRING(&quot;o&quot;), aKey);</span>
<span class="lineNum">    2864 </span>            :     }
<span class="lineNum">    2865 </span>            : 
<span class="lineNum">    2866 </span>            :     // Now start at aContent and append the indices of it and all its ancestors
<span class="lineNum">    2867 </span>            :     // in their containers.  That should at least pin down its position in the
<span class="lineNum">    2868 </span>            :     // DOM...
<span class="lineNum">    2869 </span><span class="lineNoCov">          0 :     nsINode* parent = aContent-&gt;GetParentNode();</span>
<span class="lineNum">    2870 </span><span class="lineNoCov">          0 :     nsINode* content = aContent;</span>
<span class="lineNum">    2871 </span><span class="lineNoCov">          0 :     while (parent) {</span>
<span class="lineNum">    2872 </span><span class="lineNoCov">          0 :       KeyAppendInt(parent-&gt;IndexOf(content), aKey);</span>
<span class="lineNum">    2873 </span><span class="lineNoCov">          0 :       content = parent;</span>
<span class="lineNum">    2874 </span><span class="lineNoCov">          0 :       parent = content-&gt;GetParentNode();</span>
<span class="lineNum">    2875 </span>            :     }
<span class="lineNum">    2876 </span>            :   }
<span class="lineNum">    2877 </span>            : 
<span class="lineNum">    2878 </span>            :   return NS_OK;
<span class="lineNum">    2879 </span>            : }
<span class="lineNum">    2880 </span>            : 
<a name="2881"><span class="lineNum">    2881 </span>            : // static</a>
<span class="lineNum">    2882 </span>            : nsIPrincipal*
<span class="lineNum">    2883 </span><span class="lineCov">       7554 : nsContentUtils::SubjectPrincipal(JSContext* aCx)</span>
<span class="lineNum">    2884 </span>            : {
<span class="lineNum">    2885 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    2886 </span>            : 
<span class="lineNum">    2887 </span>            :   // As opposed to SubjectPrincipal(), we do in fact assume that
<span class="lineNum">    2888 </span>            :   // we're in a compartment here; anyone who calls this function
<span class="lineNum">    2889 </span>            :   // in situations where that's not the case is doing it wrong.
<span class="lineNum">    2890 </span><span class="lineCov">       7554 :   JSCompartment* compartment = js::GetContextCompartment(aCx);</span>
<span class="lineNum">    2891 </span>            :   MOZ_ASSERT(compartment);
<span class="lineNum">    2892 </span>            : 
<span class="lineNum">    2893 </span><span class="lineCov">       7554 :   JSPrincipals* principals = JS_GetCompartmentPrincipals(compartment);</span>
<span class="lineNum">    2894 </span><span class="lineCov">       7554 :   return nsJSPrincipals::get(principals);</span>
<span class="lineNum">    2895 </span>            : }
<span class="lineNum">    2896 </span>            : 
<a name="2897"><span class="lineNum">    2897 </span>            : // static</a>
<span class="lineNum">    2898 </span>            : nsIPrincipal*
<span class="lineNum">    2899 </span><span class="lineCov">       7369 : nsContentUtils::SubjectPrincipal()</span>
<span class="lineNum">    2900 </span>            : {
<span class="lineNum">    2901 </span>            :   MOZ_ASSERT(IsInitialized());
<span class="lineNum">    2902 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    2903 </span><span class="lineCov">       7369 :   JSContext* cx = GetCurrentJSContext();</span>
<span class="lineNum">    2904 </span><span class="lineCov">       7369 :   if (!cx) {</span>
<span class="lineNum">    2905 </span><span class="lineNoCov">          0 :     MOZ_CRASH(&quot;Accessing the Subject Principal without an AutoJSAPI on the stack is forbidden&quot;);</span>
<span class="lineNum">    2906 </span>            :   }
<span class="lineNum">    2907 </span>            : 
<span class="lineNum">    2908 </span><span class="lineCov">       7369 :   JSCompartment *compartment = js::GetContextCompartment(cx);</span>
<span class="lineNum">    2909 </span>            : 
<span class="lineNum">    2910 </span>            :   // When an AutoJSAPI is instantiated, we are in a null compartment until the
<span class="lineNum">    2911 </span>            :   // first JSAutoCompartment, which is kind of a purgatory as far as permissions
<span class="lineNum">    2912 </span>            :   // go. It would be nice to just hard-abort if somebody does a security check
<span class="lineNum">    2913 </span>            :   // in this purgatory zone, but that would be too fragile, since it could be
<span class="lineNum">    2914 </span>            :   // triggered by random IsCallerChrome() checks 20-levels deep.
<span class="lineNum">    2915 </span>            :   //
<span class="lineNum">    2916 </span>            :   // So we want to return _something_ here - and definitely not the System
<span class="lineNum">    2917 </span>            :   // Principal, since that would make an AutoJSAPI a very dangerous thing to
<span class="lineNum">    2918 </span>            :   // instantiate.
<span class="lineNum">    2919 </span>            :   //
<span class="lineNum">    2920 </span>            :   // The natural thing to return is a null principal. Ideally, we'd return a
<span class="lineNum">    2921 </span>            :   // different null principal each time, to avoid any unexpected interactions
<span class="lineNum">    2922 </span>            :   // when the principal accidentally gets inherited somewhere. But
<span class="lineNum">    2923 </span>            :   // SubjectPrincipal doesn't return strong references, so there's no way to
<span class="lineNum">    2924 </span>            :   // sanely manage the lifetime of multiple null principals.
<span class="lineNum">    2925 </span>            :   //
<span class="lineNum">    2926 </span>            :   // So we use a singleton null principal. To avoid it being accidentally
<span class="lineNum">    2927 </span>            :   // inherited and becoming a &quot;real&quot; subject or object principal, we do a
<span class="lineNum">    2928 </span>            :   // release-mode assert during compartment creation against using this
<span class="lineNum">    2929 </span>            :   // principal on an actual global.
<span class="lineNum">    2930 </span><span class="lineCov">       7369 :   if (!compartment) {</span>
<span class="lineNum">    2931 </span><span class="lineNoCov">          0 :     return sNullSubjectPrincipal;</span>
<span class="lineNum">    2932 </span>            :   }
<span class="lineNum">    2933 </span>            : 
<span class="lineNum">    2934 </span><span class="lineCov">       7369 :   return SubjectPrincipal(cx);</span>
<span class="lineNum">    2935 </span>            : }
<span class="lineNum">    2936 </span>            : 
<a name="2937"><span class="lineNum">    2937 </span>            : // static</a>
<span class="lineNum">    2938 </span>            : nsIPrincipal*
<span class="lineNum">    2939 </span><span class="lineCov">        272 : nsContentUtils::ObjectPrincipal(JSObject* aObj)</span>
<span class="lineNum">    2940 </span>            : {
<span class="lineNum">    2941 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    2942 </span>            : 
<span class="lineNum">    2943 </span>            : #ifdef DEBUG
<span class="lineNum">    2944 </span>            :   JS::AssertObjectBelongsToCurrentThread(aObj);
<span class="lineNum">    2945 </span>            : #endif
<span class="lineNum">    2946 </span>            : 
<span class="lineNum">    2947 </span>            :   // This is duplicated from nsScriptSecurityManager. We don't call through there
<span class="lineNum">    2948 </span>            :   // because the API unnecessarily requires a JSContext for historical reasons.
<span class="lineNum">    2949 </span><span class="lineCov">        272 :   JSCompartment *compartment = js::GetObjectCompartment(aObj);</span>
<span class="lineNum">    2950 </span><span class="lineCov">        272 :   JSPrincipals *principals = JS_GetCompartmentPrincipals(compartment);</span>
<span class="lineNum">    2951 </span><span class="lineCov">        272 :   return nsJSPrincipals::get(principals);</span>
<span class="lineNum">    2952 </span>            : }
<span class="lineNum">    2953 </span>            : 
<a name="2954"><span class="lineNum">    2954 </span>            : // static</a>
<span class="lineNum">    2955 </span>            : nsresult
<span class="lineNum">    2956 </span><span class="lineNoCov">          0 : nsContentUtils::NewURIWithDocumentCharset(nsIURI** aResult,</span>
<span class="lineNum">    2957 </span>            :                                           const nsAString&amp; aSpec,
<span class="lineNum">    2958 </span>            :                                           nsIDocument* aDocument,
<span class="lineNum">    2959 </span>            :                                           nsIURI* aBaseURI)
<span class="lineNum">    2960 </span>            : {
<span class="lineNum">    2961 </span>            :   return NS_NewURI(aResult, aSpec,
<span class="lineNum">    2962 </span>            :                    aDocument ? aDocument-&gt;GetDocumentCharacterSet().get() : nullptr,
<span class="lineNum">    2963 </span><span class="lineNoCov">          0 :                    aBaseURI, sIOService);</span>
<span class="lineNum">    2964 </span>            : }
<span class="lineNum">    2965 </span>            : 
<a name="2966"><span class="lineNum">    2966 </span>            : // static</a>
<span class="lineNum">    2967 </span>            : bool
<span class="lineNum">    2968 </span><span class="lineNoCov">          0 : nsContentUtils::IsCustomElementName(nsIAtom* aName)</span>
<span class="lineNum">    2969 </span>            : {
<span class="lineNum">    2970 </span>            :   // A valid custom element name is a sequence of characters name which
<span class="lineNum">    2971 </span>            :   // must match the PotentialCustomElementName production:
<span class="lineNum">    2972 </span>            :   // PotentialCustomElementName ::= [a-z] (PCENChar)* '-' (PCENChar)*
<span class="lineNum">    2973 </span><span class="lineNoCov">          0 :   const char16_t* name = aName-&gt;GetUTF16String();</span>
<span class="lineNum">    2974 </span><span class="lineNoCov">          0 :   uint32_t len = aName-&gt;GetLength();</span>
<span class="lineNum">    2975 </span><span class="lineNoCov">          0 :   bool hasDash = false;</span>
<span class="lineNum">    2976 </span>            : 
<span class="lineNum">    2977 </span><span class="lineNoCov">          0 :   if (!len || name[0] &lt; 'a' || name[0] &gt; 'z') {</span>
<span class="lineNum">    2978 </span>            :     return false;
<span class="lineNum">    2979 </span>            :   }
<span class="lineNum">    2980 </span>            : 
<span class="lineNum">    2981 </span>            :   uint32_t i = 1;
<span class="lineNum">    2982 </span><span class="lineNoCov">          0 :   while (i &lt; len) {</span>
<span class="lineNum">    2983 </span><span class="lineNoCov">          0 :     if (NS_IS_HIGH_SURROGATE(name[i]) &amp;&amp; i + 1 &lt; len &amp;&amp;</span>
<span class="lineNum">    2984 </span><span class="lineNoCov">          0 :         NS_IS_LOW_SURROGATE(name[i + 1])) {</span>
<span class="lineNum">    2985 </span>            :       // Merged two 16-bit surrogate pairs into code point.
<span class="lineNum">    2986 </span><span class="lineNoCov">          0 :       char32_t code = SURROGATE_TO_UCS4(name[i], name[i + 1]);</span>
<span class="lineNum">    2987 </span>            : 
<span class="lineNum">    2988 </span><span class="lineNoCov">          0 :       if (code &lt; 0x10000 || code &gt; 0xEFFFF) {</span>
<span class="lineNum">    2989 </span>            :         return false;
<span class="lineNum">    2990 </span>            :       }
<span class="lineNum">    2991 </span>            : 
<span class="lineNum">    2992 </span><span class="lineNoCov">          0 :       i += 2;</span>
<span class="lineNum">    2993 </span>            :     } else {
<span class="lineNum">    2994 </span><span class="lineNoCov">          0 :       if (name[i] == '-') {</span>
<span class="lineNum">    2995 </span><span class="lineNoCov">          0 :         hasDash = true;</span>
<span class="lineNum">    2996 </span>            :       }
<span class="lineNum">    2997 </span>            : 
<span class="lineNum">    2998 </span><span class="lineNoCov">          0 :       if (name[i] != '-' &amp;&amp; name[i] != '.' &amp;&amp;</span>
<span class="lineNum">    2999 </span><span class="lineNoCov">          0 :           name[i] != '_' &amp;&amp; name[i] != 0xB7 &amp;&amp;</span>
<span class="lineNum">    3000 </span><span class="lineNoCov">          0 :          (name[i] &lt; '0' || name[i] &gt; '9') &amp;&amp;</span>
<span class="lineNum">    3001 </span><span class="lineNoCov">          0 :          (name[i] &lt; 'a' || name[i] &gt; 'z') &amp;&amp;</span>
<span class="lineNum">    3002 </span><span class="lineNoCov">          0 :          (name[i] &lt; 0xC0 || name[i] &gt; 0xD6) &amp;&amp;</span>
<span class="lineNum">    3003 </span><span class="lineNoCov">          0 :          (name[i] &lt; 0xF8 || name[i] &gt; 0x37D) &amp;&amp;</span>
<span class="lineNum">    3004 </span><span class="lineNoCov">          0 :          (name[i] &lt; 0x37F || name[i] &gt; 0x1FFF) &amp;&amp;</span>
<span class="lineNum">    3005 </span><span class="lineNoCov">          0 :          (name[i] &lt; 0x200C || name[i] &gt; 0x200D) &amp;&amp;</span>
<span class="lineNum">    3006 </span><span class="lineNoCov">          0 :          (name[i] &lt; 0x203F || name[i] &gt; 0x2040) &amp;&amp;</span>
<span class="lineNum">    3007 </span><span class="lineNoCov">          0 :          (name[i] &lt; 0x2070 || name[i] &gt; 0x218F) &amp;&amp;</span>
<span class="lineNum">    3008 </span><span class="lineNoCov">          0 :          (name[i] &lt; 0x2C00 || name[i] &gt; 0x2FEF) &amp;&amp;</span>
<span class="lineNum">    3009 </span><span class="lineNoCov">          0 :          (name[i] &lt; 0x3001 || name[i] &gt; 0xD7FF) &amp;&amp;</span>
<span class="lineNum">    3010 </span><span class="lineNoCov">          0 :          (name[i] &lt; 0xF900 || name[i] &gt; 0xFDCF) &amp;&amp;</span>
<span class="lineNum">    3011 </span><span class="lineNoCov">          0 :          (name[i] &lt; 0xFDF0 || name[i] &gt; 0xFFFD)) {</span>
<span class="lineNum">    3012 </span>            :         return false;
<span class="lineNum">    3013 </span>            :       }
<span class="lineNum">    3014 </span>            : 
<span class="lineNum">    3015 </span><span class="lineNoCov">          0 :       i++;</span>
<span class="lineNum">    3016 </span>            :     }
<span class="lineNum">    3017 </span>            :   }
<span class="lineNum">    3018 </span>            : 
<span class="lineNum">    3019 </span><span class="lineNoCov">          0 :   if (!hasDash) {</span>
<span class="lineNum">    3020 </span>            :     return false;
<span class="lineNum">    3021 </span>            :   }
<span class="lineNum">    3022 </span>            : 
<span class="lineNum">    3023 </span>            :   // The custom element name must not be one of the following values:
<span class="lineNum">    3024 </span>            :   //  annotation-xml
<span class="lineNum">    3025 </span>            :   //  color-profile
<span class="lineNum">    3026 </span>            :   //  font-face
<span class="lineNum">    3027 </span>            :   //  font-face-src
<span class="lineNum">    3028 </span>            :   //  font-face-uri
<span class="lineNum">    3029 </span>            :   //  font-face-format
<span class="lineNum">    3030 </span>            :   //  font-face-name
<span class="lineNum">    3031 </span>            :   //  missing-glyph
<span class="lineNum">    3032 </span><span class="lineNoCov">          0 :   return aName != nsGkAtoms::annotation_xml_ &amp;&amp;</span>
<span class="lineNum">    3033 </span><span class="lineNoCov">          0 :          aName != nsGkAtoms::colorProfile &amp;&amp;</span>
<span class="lineNum">    3034 </span><span class="lineNoCov">          0 :          aName != nsGkAtoms::font_face &amp;&amp;</span>
<span class="lineNum">    3035 </span><span class="lineNoCov">          0 :          aName != nsGkAtoms::font_face_src &amp;&amp;</span>
<span class="lineNum">    3036 </span><span class="lineNoCov">          0 :          aName != nsGkAtoms::font_face_uri &amp;&amp;</span>
<span class="lineNum">    3037 </span><span class="lineNoCov">          0 :          aName != nsGkAtoms::font_face_format &amp;&amp;</span>
<span class="lineNum">    3038 </span><span class="lineNoCov">          0 :          aName != nsGkAtoms::font_face_name &amp;&amp;</span>
<span class="lineNum">    3039 </span><span class="lineNoCov">          0 :          aName != nsGkAtoms::missingGlyph;</span>
<span class="lineNum">    3040 </span>            : }
<span class="lineNum">    3041 </span>            : 
<a name="3042"><span class="lineNum">    3042 </span>            : // static</a>
<span class="lineNum">    3043 </span>            : nsresult
<span class="lineNum">    3044 </span><span class="lineNoCov">          0 : nsContentUtils::CheckQName(const nsAString&amp; aQualifiedName,</span>
<span class="lineNum">    3045 </span>            :                            bool aNamespaceAware,
<span class="lineNum">    3046 </span>            :                            const char16_t** aColon)
<span class="lineNum">    3047 </span>            : {
<span class="lineNum">    3048 </span><span class="lineNoCov">          0 :   const char* colon = nullptr;</span>
<span class="lineNum">    3049 </span><span class="lineNoCov">          0 :   const char16_t* begin = aQualifiedName.BeginReading();</span>
<span class="lineNum">    3050 </span><span class="lineNoCov">          0 :   const char16_t* end = aQualifiedName.EndReading();</span>
<span class="lineNum">    3051 </span>            : 
<span class="lineNum">    3052 </span>            :   int result = MOZ_XMLCheckQName(reinterpret_cast&lt;const char*&gt;(begin),
<span class="lineNum">    3053 </span>            :                                  reinterpret_cast&lt;const char*&gt;(end),
<span class="lineNum">    3054 </span><span class="lineNoCov">          0 :                                  aNamespaceAware, &amp;colon);</span>
<span class="lineNum">    3055 </span>            : 
<span class="lineNum">    3056 </span><span class="lineNoCov">          0 :   if (!result) {</span>
<span class="lineNum">    3057 </span><span class="lineNoCov">          0 :     if (aColon) {</span>
<span class="lineNum">    3058 </span><span class="lineNoCov">          0 :       *aColon = reinterpret_cast&lt;const char16_t*&gt;(colon);</span>
<span class="lineNum">    3059 </span>            :     }
<span class="lineNum">    3060 </span>            : 
<span class="lineNum">    3061 </span>            :     return NS_OK;
<span class="lineNum">    3062 </span>            :   }
<span class="lineNum">    3063 </span>            : 
<span class="lineNum">    3064 </span>            :   // MOZ_EXPAT_EMPTY_QNAME || MOZ_EXPAT_INVALID_CHARACTER
<span class="lineNum">    3065 </span><span class="lineNoCov">          0 :   if (result == (1 &lt;&lt; 0) || result == (1 &lt;&lt; 1)) {</span>
<span class="lineNum">    3066 </span>            :     return NS_ERROR_DOM_INVALID_CHARACTER_ERR;
<span class="lineNum">    3067 </span>            :   }
<span class="lineNum">    3068 </span>            : 
<span class="lineNum">    3069 </span><span class="lineNoCov">          0 :   return NS_ERROR_DOM_NAMESPACE_ERR;</span>
<span class="lineNum">    3070 </span>            : }
<span class="lineNum">    3071 </span>            : 
<a name="3072"><span class="lineNum">    3072 </span>            : //static</a>
<span class="lineNum">    3073 </span>            : nsresult
<span class="lineNum">    3074 </span><span class="lineNoCov">          0 : nsContentUtils::SplitQName(const nsIContent* aNamespaceResolver,</span>
<span class="lineNum">    3075 </span>            :                            const nsAFlatString&amp; aQName,
<span class="lineNum">    3076 </span>            :                            int32_t *aNamespace, nsIAtom **aLocalName)
<span class="lineNum">    3077 </span>            : {
<span class="lineNum">    3078 </span>            :   const char16_t* colon;
<span class="lineNum">    3079 </span><span class="lineNoCov">          0 :   nsresult rv = nsContentUtils::CheckQName(aQName, true, &amp;colon);</span>
<span class="lineNum">    3080 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3081 </span>            : 
<span class="lineNum">    3082 </span><span class="lineNoCov">          0 :   if (colon) {</span>
<span class="lineNum">    3083 </span>            :     const char16_t* end;
<span class="lineNum">    3084 </span><span class="lineNoCov">          0 :     aQName.EndReading(end);</span>
<span class="lineNum">    3085 </span><span class="lineNoCov">          0 :     nsAutoString nameSpace;</span>
<span class="lineNum">    3086 </span>            :     rv = aNamespaceResolver-&gt;LookupNamespaceURIInternal(Substring(aQName.get(),
<span class="lineNum">    3087 </span>            :                                                                   colon),
<span class="lineNum">    3088 </span><span class="lineNoCov">          0 :                                                         nameSpace);</span>
<span class="lineNum">    3089 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3090 </span>            : 
<span class="lineNum">    3091 </span>            :     *aNamespace = NameSpaceManager()-&gt;GetNameSpaceID(nameSpace,
<span class="lineNum">    3092 </span><span class="lineNoCov">          0 :                                                      nsContentUtils::IsChromeDoc(aNamespaceResolver-&gt;OwnerDoc()));</span>
<span class="lineNum">    3093 </span><span class="lineNoCov">          0 :     if (*aNamespace == kNameSpaceID_Unknown)</span>
<span class="lineNum">    3094 </span>            :       return NS_ERROR_FAILURE;
<span class="lineNum">    3095 </span>            : 
<span class="lineNum">    3096 </span><span class="lineNoCov">          0 :     *aLocalName = NS_AtomizeMainThread(Substring(colon + 1, end)).take();</span>
<span class="lineNum">    3097 </span>            :   }
<span class="lineNum">    3098 </span>            :   else {
<span class="lineNum">    3099 </span><span class="lineNoCov">          0 :     *aNamespace = kNameSpaceID_None;</span>
<span class="lineNum">    3100 </span><span class="lineNoCov">          0 :     *aLocalName = NS_AtomizeMainThread(aQName).take();</span>
<span class="lineNum">    3101 </span>            :   }
<span class="lineNum">    3102 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(aLocalName, NS_ERROR_OUT_OF_MEMORY);</span>
<span class="lineNum">    3103 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    3104 </span>            : }
<span class="lineNum">    3105 </span>            : 
<span class="lineNum">    3106 </span>            : // static
<span class="lineNum">    3107 </span>            : nsresult
<span class="lineNum">    3108 </span><span class="lineNoCov">          0 : nsContentUtils::GetNodeInfoFromQName(const nsAString&amp; aNamespaceURI,</span>
<span class="lineNum">    3109 </span>            :                                      const nsAString&amp; aQualifiedName,
<span class="lineNum">    3110 </span>            :                                      nsNodeInfoManager* aNodeInfoManager,
<span class="lineNum">    3111 </span>            :                                      uint16_t aNodeType,
<span class="lineNum">    3112 </span>            :                                      mozilla::dom::NodeInfo** aNodeInfo)
<span class="lineNum">    3113 </span>            : {
<span class="lineNum">    3114 </span><span class="lineNoCov">          0 :   const nsAFlatString&amp; qName = PromiseFlatString(aQualifiedName);</span>
<span class="lineNum">    3115 </span>            :   const char16_t* colon;
<span class="lineNum">    3116 </span><span class="lineNoCov">          0 :   nsresult rv = nsContentUtils::CheckQName(qName, true, &amp;colon);</span>
<span class="lineNum">    3117 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3118 </span>            : 
<span class="lineNum">    3119 </span>            :   int32_t nsID;
<span class="lineNum">    3120 </span><span class="lineNoCov">          0 :   sNameSpaceManager-&gt;RegisterNameSpace(aNamespaceURI, nsID);</span>
<span class="lineNum">    3121 </span><span class="lineNoCov">          0 :   if (colon) {</span>
<span class="lineNum">    3122 </span>            :     const char16_t* end;
<span class="lineNum">    3123 </span><span class="lineNoCov">          0 :     qName.EndReading(end);</span>
<span class="lineNum">    3124 </span>            : 
<span class="lineNum">    3125 </span>            :     nsCOMPtr&lt;nsIAtom&gt; prefix =
<span class="lineNum">    3126 </span><span class="lineNoCov">          0 :       NS_AtomizeMainThread(Substring(qName.get(), colon));</span>
<span class="lineNum">    3127 </span>            : 
<span class="lineNum">    3128 </span>            :     rv = aNodeInfoManager-&gt;GetNodeInfo(Substring(colon + 1, end), prefix,
<span class="lineNum">    3129 </span><span class="lineNoCov">          0 :                                        nsID, aNodeType, aNodeInfo);</span>
<span class="lineNum">    3130 </span>            :   }
<span class="lineNum">    3131 </span>            :   else {
<span class="lineNum">    3132 </span>            :     rv = aNodeInfoManager-&gt;GetNodeInfo(aQualifiedName, nullptr, nsID,
<span class="lineNum">    3133 </span><span class="lineNoCov">          0 :                                        aNodeType, aNodeInfo);</span>
<span class="lineNum">    3134 </span>            :   }
<span class="lineNum">    3135 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3136 </span>            : 
<span class="lineNum">    3137 </span>            :   return nsContentUtils::IsValidNodeName((*aNodeInfo)-&gt;NameAtom(),
<span class="lineNum">    3138 </span>            :                                          (*aNodeInfo)-&gt;GetPrefixAtom(),
<span class="lineNum">    3139 </span><span class="lineNoCov">          0 :                                          (*aNodeInfo)-&gt;NamespaceID()) ?</span>
<span class="lineNum">    3140 </span><span class="lineNoCov">          0 :          NS_OK : NS_ERROR_DOM_NAMESPACE_ERR;</span>
<span class="lineNum">    3141 </span>            : }
<span class="lineNum">    3142 </span>            : 
<a name="3143"><span class="lineNum">    3143 </span>            : // static</a>
<span class="lineNum">    3144 </span>            : void
<span class="lineNum">    3145 </span><span class="lineNoCov">          0 : nsContentUtils::SplitExpatName(const char16_t *aExpatName, nsIAtom **aPrefix,</span>
<span class="lineNum">    3146 </span>            :                                nsIAtom **aLocalName, int32_t* aNameSpaceID)
<span class="lineNum">    3147 </span>            : {
<span class="lineNum">    3148 </span>            :   /**
<span class="lineNum">    3149 </span>            :    *  Expat can send the following:
<span class="lineNum">    3150 </span>            :    *    localName
<span class="lineNum">    3151 </span>            :    *    namespaceURI&lt;separator&gt;localName
<span class="lineNum">    3152 </span>            :    *    namespaceURI&lt;separator&gt;localName&lt;separator&gt;prefix
<span class="lineNum">    3153 </span>            :    *
<span class="lineNum">    3154 </span>            :    *  and we use 0xFFFF for the &lt;separator&gt;.
<span class="lineNum">    3155 </span>            :    *
<span class="lineNum">    3156 </span>            :    */
<span class="lineNum">    3157 </span>            : 
<span class="lineNum">    3158 </span><span class="lineNoCov">          0 :   const char16_t *uriEnd = nullptr;</span>
<span class="lineNum">    3159 </span><span class="lineNoCov">          0 :   const char16_t *nameEnd = nullptr;</span>
<span class="lineNum">    3160 </span>            :   const char16_t *pos;
<span class="lineNum">    3161 </span><span class="lineNoCov">          0 :   for (pos = aExpatName; *pos; ++pos) {</span>
<span class="lineNum">    3162 </span><span class="lineNoCov">          0 :     if (*pos == 0xFFFF) {</span>
<span class="lineNum">    3163 </span><span class="lineNoCov">          0 :       if (uriEnd) {</span>
<span class="lineNum">    3164 </span>            :         nameEnd = pos;
<span class="lineNum">    3165 </span>            :       }
<span class="lineNum">    3166 </span>            :       else {
<span class="lineNum">    3167 </span><span class="lineNoCov">          0 :         uriEnd = pos;</span>
<span class="lineNum">    3168 </span>            :       }
<span class="lineNum">    3169 </span>            :     }
<span class="lineNum">    3170 </span>            :   }
<span class="lineNum">    3171 </span>            : 
<span class="lineNum">    3172 </span>            :   const char16_t *nameStart;
<span class="lineNum">    3173 </span><span class="lineNoCov">          0 :   if (uriEnd) {</span>
<span class="lineNum">    3174 </span><span class="lineNoCov">          0 :     if (sNameSpaceManager) {</span>
<span class="lineNum">    3175 </span>            :       sNameSpaceManager-&gt;RegisterNameSpace(nsDependentSubstring(aExpatName,
<span class="lineNum">    3176 </span>            :                                                                 uriEnd),
<span class="lineNum">    3177 </span><span class="lineNoCov">          0 :                                            *aNameSpaceID);</span>
<span class="lineNum">    3178 </span>            :     }
<span class="lineNum">    3179 </span>            :     else {
<span class="lineNum">    3180 </span><span class="lineNoCov">          0 :       *aNameSpaceID = kNameSpaceID_Unknown;</span>
<span class="lineNum">    3181 </span>            :     }
<span class="lineNum">    3182 </span>            : 
<span class="lineNum">    3183 </span><span class="lineNoCov">          0 :     nameStart = (uriEnd + 1);</span>
<span class="lineNum">    3184 </span><span class="lineNoCov">          0 :     if (nameEnd)  {</span>
<span class="lineNum">    3185 </span><span class="lineNoCov">          0 :       const char16_t *prefixStart = nameEnd + 1;</span>
<span class="lineNum">    3186 </span><span class="lineNoCov">          0 :       *aPrefix = NS_AtomizeMainThread(Substring(prefixStart, pos)).take();</span>
<span class="lineNum">    3187 </span>            :     }
<span class="lineNum">    3188 </span>            :     else {
<span class="lineNum">    3189 </span><span class="lineNoCov">          0 :       nameEnd = pos;</span>
<span class="lineNum">    3190 </span><span class="lineNoCov">          0 :       *aPrefix = nullptr;</span>
<span class="lineNum">    3191 </span>            :     }
<span class="lineNum">    3192 </span>            :   }
<span class="lineNum">    3193 </span>            :   else {
<span class="lineNum">    3194 </span><span class="lineNoCov">          0 :     *aNameSpaceID = kNameSpaceID_None;</span>
<span class="lineNum">    3195 </span><span class="lineNoCov">          0 :     nameStart = aExpatName;</span>
<span class="lineNum">    3196 </span><span class="lineNoCov">          0 :     nameEnd = pos;</span>
<span class="lineNum">    3197 </span><span class="lineNoCov">          0 :     *aPrefix = nullptr;</span>
<span class="lineNum">    3198 </span>            :   }
<span class="lineNum">    3199 </span><span class="lineNoCov">          0 :   *aLocalName = NS_AtomizeMainThread(Substring(nameStart, nameEnd)).take();</span>
<span class="lineNum">    3200 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3201 </span>            : 
<a name="3202"><span class="lineNum">    3202 </span>            : // static</a>
<span class="lineNum">    3203 </span>            : nsPresContext*
<span class="lineNum">    3204 </span><span class="lineNoCov">          0 : nsContentUtils::GetContextForContent(const nsIContent* aContent)</span>
<span class="lineNum">    3205 </span>            : {
<span class="lineNum">    3206 </span><span class="lineNoCov">          0 :   nsIDocument* doc = aContent-&gt;GetComposedDoc();</span>
<span class="lineNum">    3207 </span><span class="lineNoCov">          0 :   if (doc) {</span>
<span class="lineNum">    3208 </span><span class="lineNoCov">          0 :     nsIPresShell *presShell = doc-&gt;GetShell();</span>
<span class="lineNum">    3209 </span><span class="lineNoCov">          0 :     if (presShell) {</span>
<span class="lineNum">    3210 </span><span class="lineNoCov">          0 :       return presShell-&gt;GetPresContext();</span>
<span class="lineNum">    3211 </span>            :     }
<span class="lineNum">    3212 </span>            :   }
<span class="lineNum">    3213 </span>            :   return nullptr;
<span class="lineNum">    3214 </span>            : }
<span class="lineNum">    3215 </span>            : 
<span class="lineNum">    3216 </span>            : // static
<span class="lineNum">    3217 </span>            : bool
<span class="lineNum">    3218 </span><span class="lineNoCov">          0 : nsContentUtils::CanLoadImage(nsIURI* aURI, nsISupports* aContext,</span>
<span class="lineNum">    3219 </span>            :                              nsIDocument* aLoadingDocument,
<span class="lineNum">    3220 </span>            :                              nsIPrincipal* aLoadingPrincipal,
<span class="lineNum">    3221 </span>            :                              int16_t* aImageBlockingStatus,
<span class="lineNum">    3222 </span>            :                              uint32_t aContentType)
<span class="lineNum">    3223 </span>            : {
<span class="lineNum">    3224 </span>            :   NS_PRECONDITION(aURI, &quot;Must have a URI&quot;);
<span class="lineNum">    3225 </span>            :   NS_PRECONDITION(aLoadingDocument, &quot;Must have a document&quot;);
<span class="lineNum">    3226 </span>            :   NS_PRECONDITION(aLoadingPrincipal, &quot;Must have a loading principal&quot;);
<span class="lineNum">    3227 </span>            : 
<span class="lineNum">    3228 </span>            :   nsresult rv;
<span class="lineNum">    3229 </span>            : 
<span class="lineNum">    3230 </span><span class="lineNoCov">          0 :   uint32_t appType = nsIDocShell::APP_TYPE_UNKNOWN;</span>
<span class="lineNum">    3231 </span>            : 
<span class="lineNum">    3232 </span>            :   {
<span class="lineNum">    3233 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellTreeItem = aLoadingDocument-&gt;GetDocShell();</span>
<span class="lineNum">    3234 </span><span class="lineNoCov">          0 :     if (docShellTreeItem) {</span>
<span class="lineNum">    3235 </span>            :       nsCOMPtr&lt;nsIDocShellTreeItem&gt; root;
<span class="lineNum">    3236 </span><span class="lineNoCov">          0 :       docShellTreeItem-&gt;GetRootTreeItem(getter_AddRefs(root));</span>
<span class="lineNum">    3237 </span>            : 
<span class="lineNum">    3238 </span><span class="lineNoCov">          0 :       nsCOMPtr&lt;nsIDocShell&gt; docShell(do_QueryInterface(root));</span>
<span class="lineNum">    3239 </span>            : 
<span class="lineNum">    3240 </span><span class="lineNoCov">          0 :       if (!docShell || NS_FAILED(docShell-&gt;GetAppType(&amp;appType))) {</span>
<span class="lineNum">    3241 </span><span class="lineNoCov">          0 :         appType = nsIDocShell::APP_TYPE_UNKNOWN;</span>
<span class="lineNum">    3242 </span>            :       }
<span class="lineNum">    3243 </span>            :     }
<span class="lineNum">    3244 </span>            :   }
<span class="lineNum">    3245 </span>            : 
<span class="lineNum">    3246 </span><span class="lineNoCov">          0 :   if (appType != nsIDocShell::APP_TYPE_EDITOR) {</span>
<span class="lineNum">    3247 </span>            :     // Editor apps get special treatment here, editors can load images
<span class="lineNum">    3248 </span>            :     // from anywhere.  This allows editor to insert images from file://
<span class="lineNum">    3249 </span>            :     // into documents that are being edited.
<span class="lineNum">    3250 </span>            :     rv = sSecurityManager-&gt;
<span class="lineNum">    3251 </span>            :       CheckLoadURIWithPrincipal(aLoadingPrincipal, aURI,
<span class="lineNum">    3252 </span><span class="lineNoCov">          0 :                                 nsIScriptSecurityManager::ALLOW_CHROME);</span>
<span class="lineNum">    3253 </span><span class="lineNoCov">          0 :     if (NS_FAILED(rv)) {</span>
<span class="lineNum">    3254 </span><span class="lineNoCov">          0 :       if (aImageBlockingStatus) {</span>
<span class="lineNum">    3255 </span>            :         // Reject the request itself, not all requests to the relevant
<span class="lineNum">    3256 </span>            :         // server...
<span class="lineNum">    3257 </span><span class="lineNoCov">          0 :         *aImageBlockingStatus = nsIContentPolicy::REJECT_REQUEST;</span>
<span class="lineNum">    3258 </span>            :       }
<span class="lineNum">    3259 </span>            :       return false;
<span class="lineNum">    3260 </span>            :     }
<span class="lineNum">    3261 </span>            :   }
<span class="lineNum">    3262 </span>            : 
<span class="lineNum">    3263 </span><span class="lineNoCov">          0 :   int16_t decision = nsIContentPolicy::ACCEPT;</span>
<span class="lineNum">    3264 </span>            : 
<span class="lineNum">    3265 </span>            :   rv = NS_CheckContentLoadPolicy(aContentType,
<span class="lineNum">    3266 </span>            :                                  aURI,
<span class="lineNum">    3267 </span>            :                                  aLoadingPrincipal,
<span class="lineNum">    3268 </span>            :                                  aContext,
<span class="lineNum">    3269 </span><span class="lineNoCov">          0 :                                  EmptyCString(), //mime guess</span>
<span class="lineNum">    3270 </span>            :                                  nullptr,         //extra
<span class="lineNum">    3271 </span>            :                                  &amp;decision,
<span class="lineNum">    3272 </span>            :                                  GetContentPolicy(),
<span class="lineNum">    3273 </span><span class="lineNoCov">          0 :                                  sSecurityManager);</span>
<span class="lineNum">    3274 </span>            : 
<span class="lineNum">    3275 </span><span class="lineNoCov">          0 :   if (aImageBlockingStatus) {</span>
<span class="lineNum">    3276 </span>            :     *aImageBlockingStatus =
<span class="lineNum">    3277 </span><span class="lineNoCov">          0 :       NS_FAILED(rv) ? nsIContentPolicy::REJECT_REQUEST : decision;</span>
<span class="lineNum">    3278 </span>            :   }
<span class="lineNum">    3279 </span><span class="lineNoCov">          0 :   return NS_FAILED(rv) ? false : NS_CP_ACCEPTED(decision);</span>
<span class="lineNum">    3280 </span>            : }
<span class="lineNum">    3281 </span>            : 
<span class="lineNum">    3282 </span>            : // static
<span class="lineNum">    3283 </span>            : mozilla::OriginAttributes
<span class="lineNum">    3284 </span><span class="lineNoCov">          0 : nsContentUtils::GetOriginAttributes(nsIDocument* aDocument)</span>
<span class="lineNum">    3285 </span>            : {
<span class="lineNum">    3286 </span><span class="lineNoCov">          0 :   if (!aDocument) {</span>
<span class="lineNum">    3287 </span>            :     return mozilla::OriginAttributes();
<span class="lineNum">    3288 </span>            :   }
<span class="lineNum">    3289 </span>            : 
<span class="lineNum">    3290 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsILoadGroup&gt; loadGroup = aDocument-&gt;GetDocumentLoadGroup();</span>
<span class="lineNum">    3291 </span><span class="lineNoCov">          0 :   if (loadGroup) {</span>
<span class="lineNum">    3292 </span><span class="lineNoCov">          0 :     return GetOriginAttributes(loadGroup);</span>
<span class="lineNum">    3293 </span>            :   }
<span class="lineNum">    3294 </span>            : 
<span class="lineNum">    3295 </span>            :   mozilla::OriginAttributes attrs;
<span class="lineNum">    3296 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIChannel&gt; channel = aDocument-&gt;GetChannel();</span>
<span class="lineNum">    3297 </span><span class="lineNoCov">          0 :   if (channel) {</span>
<span class="lineNum">    3298 </span><span class="lineNoCov">          0 :     NS_GetOriginAttributes(channel, attrs);</span>
<span class="lineNum">    3299 </span>            :   }
<span class="lineNum">    3300 </span>            :   return attrs;
<span class="lineNum">    3301 </span>            : }
<span class="lineNum">    3302 </span>            : 
<span class="lineNum">    3303 </span>            : // static
<span class="lineNum">    3304 </span>            : mozilla::OriginAttributes
<span class="lineNum">    3305 </span><span class="lineNoCov">          0 : nsContentUtils::GetOriginAttributes(nsILoadGroup* aLoadGroup)</span>
<span class="lineNum">    3306 </span>            : {
<span class="lineNum">    3307 </span><span class="lineNoCov">          0 :   if (!aLoadGroup) {</span>
<span class="lineNum">    3308 </span>            :     return mozilla::OriginAttributes();
<span class="lineNum">    3309 </span>            :   }
<span class="lineNum">    3310 </span>            :   mozilla::OriginAttributes attrs;
<span class="lineNum">    3311 </span>            :   nsCOMPtr&lt;nsIInterfaceRequestor&gt; callbacks;
<span class="lineNum">    3312 </span><span class="lineNoCov">          0 :   aLoadGroup-&gt;GetNotificationCallbacks(getter_AddRefs(callbacks));</span>
<span class="lineNum">    3313 </span><span class="lineNoCov">          0 :   if (callbacks) {</span>
<span class="lineNum">    3314 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsILoadContext&gt; loadContext = do_GetInterface(callbacks);</span>
<span class="lineNum">    3315 </span><span class="lineNoCov">          0 :     if (loadContext) {</span>
<span class="lineNum">    3316 </span><span class="lineNoCov">          0 :       loadContext-&gt;GetOriginAttributes(attrs);</span>
<span class="lineNum">    3317 </span>            :     }
<span class="lineNum">    3318 </span>            :   }
<span class="lineNum">    3319 </span>            :   return attrs;
<span class="lineNum">    3320 </span>            : }
<span class="lineNum">    3321 </span>            : 
<span class="lineNum">    3322 </span>            : // static
<span class="lineNum">    3323 </span>            : bool
<span class="lineNum">    3324 </span><span class="lineNoCov">          0 : nsContentUtils::IsInPrivateBrowsing(nsIDocument* aDoc)</span>
<span class="lineNum">    3325 </span>            : {
<span class="lineNum">    3326 </span><span class="lineNoCov">          0 :   if (!aDoc) {</span>
<span class="lineNum">    3327 </span>            :     return false;
<span class="lineNum">    3328 </span>            :   }
<span class="lineNum">    3329 </span>            : 
<span class="lineNum">    3330 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsILoadGroup&gt; loadGroup = aDoc-&gt;GetDocumentLoadGroup();</span>
<span class="lineNum">    3331 </span><span class="lineNoCov">          0 :   if (loadGroup) {</span>
<span class="lineNum">    3332 </span><span class="lineNoCov">          0 :     return IsInPrivateBrowsing(loadGroup);</span>
<span class="lineNum">    3333 </span>            :   }
<span class="lineNum">    3334 </span>            : 
<span class="lineNum">    3335 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIChannel&gt; channel = aDoc-&gt;GetChannel();</span>
<span class="lineNum">    3336 </span><span class="lineNoCov">          0 :   return channel &amp;&amp; NS_UsePrivateBrowsing(channel);</span>
<span class="lineNum">    3337 </span>            : }
<span class="lineNum">    3338 </span>            : 
<span class="lineNum">    3339 </span>            : // static
<span class="lineNum">    3340 </span>            : bool
<span class="lineNum">    3341 </span><span class="lineNoCov">          0 : nsContentUtils::IsInPrivateBrowsing(nsILoadGroup* aLoadGroup)</span>
<span class="lineNum">    3342 </span>            : {
<span class="lineNum">    3343 </span><span class="lineNoCov">          0 :   if (!aLoadGroup) {</span>
<span class="lineNum">    3344 </span>            :     return false;
<span class="lineNum">    3345 </span>            :   }
<span class="lineNum">    3346 </span><span class="lineNoCov">          0 :   bool isPrivate = false;</span>
<span class="lineNum">    3347 </span>            :   nsCOMPtr&lt;nsIInterfaceRequestor&gt; callbacks;
<span class="lineNum">    3348 </span><span class="lineNoCov">          0 :   aLoadGroup-&gt;GetNotificationCallbacks(getter_AddRefs(callbacks));</span>
<span class="lineNum">    3349 </span><span class="lineNoCov">          0 :   if (callbacks) {</span>
<span class="lineNum">    3350 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsILoadContext&gt; loadContext = do_GetInterface(callbacks);</span>
<span class="lineNum">    3351 </span><span class="lineNoCov">          0 :     isPrivate = loadContext &amp;&amp; loadContext-&gt;UsePrivateBrowsing();</span>
<span class="lineNum">    3352 </span>            :   }
<span class="lineNum">    3353 </span><span class="lineNoCov">          0 :   return isPrivate;</span>
<span class="lineNum">    3354 </span>            : }
<span class="lineNum">    3355 </span>            : 
<span class="lineNum">    3356 </span>            : bool
<span class="lineNum">    3357 </span><span class="lineNoCov">          0 : nsContentUtils::DocumentInactiveForImageLoads(nsIDocument* aDocument)</span>
<span class="lineNum">    3358 </span>            : {
<span class="lineNum">    3359 </span><span class="lineNoCov">          0 :   if (aDocument &amp;&amp; !IsChromeDoc(aDocument) &amp;&amp; !aDocument-&gt;IsResourceDoc()) {</span>
<span class="lineNum">    3360 </span>            :     nsCOMPtr&lt;nsPIDOMWindowInner&gt; win =
<span class="lineNum">    3361 </span><span class="lineNoCov">          0 :       do_QueryInterface(aDocument-&gt;GetScopeObject());</span>
<span class="lineNum">    3362 </span><span class="lineNoCov">          0 :     return !win || !win-&gt;GetDocShell();</span>
<span class="lineNum">    3363 </span>            :   }
<span class="lineNum">    3364 </span>            :   return false;
<span class="lineNum">    3365 </span>            : }
<a name="3366"><span class="lineNum">    3366 </span>            : </a>
<span class="lineNum">    3367 </span>            : imgLoader*
<span class="lineNum">    3368 </span><span class="lineNoCov">          0 : nsContentUtils::GetImgLoaderForDocument(nsIDocument* aDoc)</span>
<span class="lineNum">    3369 </span>            : {
<span class="lineNum">    3370 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(!DocumentInactiveForImageLoads(aDoc), nullptr);</span>
<span class="lineNum">    3371 </span>            : 
<span class="lineNum">    3372 </span><span class="lineNoCov">          0 :   if (!aDoc) {</span>
<span class="lineNum">    3373 </span><span class="lineNoCov">          0 :     return imgLoader::NormalLoader();</span>
<span class="lineNum">    3374 </span>            :   }
<span class="lineNum">    3375 </span><span class="lineNoCov">          0 :   bool isPrivate = IsInPrivateBrowsing(aDoc);</span>
<span class="lineNum">    3376 </span>            :   return isPrivate ? imgLoader::PrivateBrowsingLoader()
<span class="lineNum">    3377 </span><span class="lineNoCov">          0 :                    : imgLoader::NormalLoader();</span>
<span class="lineNum">    3378 </span>            : }
<span class="lineNum">    3379 </span>            : 
<span class="lineNum">    3380 </span>            : // static
<span class="lineNum">    3381 </span>            : imgLoader*
<span class="lineNum">    3382 </span><span class="lineNoCov">          0 : nsContentUtils::GetImgLoaderForChannel(nsIChannel* aChannel,</span>
<span class="lineNum">    3383 </span>            :                                        nsIDocument* aContext)
<span class="lineNum">    3384 </span>            : {
<span class="lineNum">    3385 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(!DocumentInactiveForImageLoads(aContext), nullptr);</span>
<span class="lineNum">    3386 </span>            : 
<span class="lineNum">    3387 </span><span class="lineNoCov">          0 :   if (!aChannel) {</span>
<span class="lineNum">    3388 </span><span class="lineNoCov">          0 :     return imgLoader::NormalLoader();</span>
<span class="lineNum">    3389 </span>            :   }
<span class="lineNum">    3390 </span>            :   nsCOMPtr&lt;nsILoadContext&gt; context;
<span class="lineNum">    3391 </span><span class="lineNoCov">          0 :   NS_QueryNotificationCallbacks(aChannel, context);</span>
<span class="lineNum">    3392 </span><span class="lineNoCov">          0 :   return context &amp;&amp; context-&gt;UsePrivateBrowsing() ?</span>
<span class="lineNum">    3393 </span>            :                       imgLoader::PrivateBrowsingLoader() :
<span class="lineNum">    3394 </span><span class="lineNoCov">          0 :                       imgLoader::NormalLoader();</span>
<span class="lineNum">    3395 </span>            : }
<span class="lineNum">    3396 </span>            : 
<span class="lineNum">    3397 </span>            : // static
<span class="lineNum">    3398 </span>            : bool
<span class="lineNum">    3399 </span><span class="lineNoCov">          0 : nsContentUtils::IsImageInCache(nsIURI* aURI, nsIDocument* aDocument)</span>
<span class="lineNum">    3400 </span>            : {
<span class="lineNum">    3401 </span><span class="lineNoCov">          0 :     imgILoader* loader = GetImgLoaderForDocument(aDocument);</span>
<span class="lineNum">    3402 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;imgICache&gt; cache = do_QueryInterface(loader);</span>
<span class="lineNum">    3403 </span>            : 
<span class="lineNum">    3404 </span>            :     // If something unexpected happened we return false, otherwise if props
<span class="lineNum">    3405 </span>            :     // is set, the image is cached and we return true
<span class="lineNum">    3406 </span>            :     nsCOMPtr&lt;nsIProperties&gt; props;
<span class="lineNum">    3407 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIDOMDocument&gt; domDoc = do_QueryInterface(aDocument);</span>
<span class="lineNum">    3408 </span><span class="lineNoCov">          0 :     nsresult rv = cache-&gt;FindEntryProperties(aURI, domDoc, getter_AddRefs(props));</span>
<span class="lineNum">    3409 </span><span class="lineNoCov">          0 :     return (NS_SUCCEEDED(rv) &amp;&amp; props);</span>
<span class="lineNum">    3410 </span>            : }
<span class="lineNum">    3411 </span>            : 
<span class="lineNum">    3412 </span>            : // static
<span class="lineNum">    3413 </span>            : nsresult
<span class="lineNum">    3414 </span><span class="lineNoCov">          0 : nsContentUtils::LoadImage(nsIURI* aURI, nsINode* aContext,</span>
<span class="lineNum">    3415 </span>            :                           nsIDocument* aLoadingDocument,
<span class="lineNum">    3416 </span>            :                           nsIPrincipal* aLoadingPrincipal, nsIURI* aReferrer,
<span class="lineNum">    3417 </span>            :                           net::ReferrerPolicy aReferrerPolicy,
<span class="lineNum">    3418 </span>            :                           imgINotificationObserver* aObserver, int32_t aLoadFlags,
<span class="lineNum">    3419 </span>            :                           const nsAString&amp; initiatorType,
<span class="lineNum">    3420 </span>            :                           imgRequestProxy** aRequest,
<span class="lineNum">    3421 </span>            :                           uint32_t aContentPolicyType)
<span class="lineNum">    3422 </span>            : {
<span class="lineNum">    3423 </span>            :   NS_PRECONDITION(aURI, &quot;Must have a URI&quot;);
<span class="lineNum">    3424 </span>            :   NS_PRECONDITION(aContext, &quot;Must have a context&quot;);
<span class="lineNum">    3425 </span>            :   NS_PRECONDITION(aLoadingDocument, &quot;Must have a document&quot;);
<span class="lineNum">    3426 </span>            :   NS_PRECONDITION(aLoadingPrincipal, &quot;Must have a principal&quot;);
<span class="lineNum">    3427 </span>            :   NS_PRECONDITION(aRequest, &quot;Null out param&quot;);
<span class="lineNum">    3428 </span>            : 
<span class="lineNum">    3429 </span><span class="lineNoCov">          0 :   imgLoader* imgLoader = GetImgLoaderForDocument(aLoadingDocument);</span>
<span class="lineNum">    3430 </span><span class="lineNoCov">          0 :   if (!imgLoader) {</span>
<span class="lineNum">    3431 </span>            :     // nothing we can do here
<span class="lineNum">    3432 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">    3433 </span>            :   }
<span class="lineNum">    3434 </span>            : 
<span class="lineNum">    3435 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsILoadGroup&gt; loadGroup = aLoadingDocument-&gt;GetDocumentLoadGroup();</span>
<span class="lineNum">    3436 </span>            : 
<span class="lineNum">    3437 </span><span class="lineNoCov">          0 :   nsIURI *documentURI = aLoadingDocument-&gt;GetDocumentURI();</span>
<span class="lineNum">    3438 </span>            : 
<span class="lineNum">    3439 </span>            :   NS_ASSERTION(loadGroup || IsFontTableURI(documentURI),
<span class="lineNum">    3440 </span>            :                &quot;Could not get loadgroup; onload may fire too early&quot;);
<span class="lineNum">    3441 </span>            : 
<span class="lineNum">    3442 </span>            :   // Make the URI immutable so people won't change it under us
<span class="lineNum">    3443 </span><span class="lineNoCov">          0 :   NS_TryToSetImmutable(aURI);</span>
<span class="lineNum">    3444 </span>            : 
<span class="lineNum">    3445 </span>            :   // XXXbz using &quot;documentURI&quot; for the initialDocumentURI is not quite
<span class="lineNum">    3446 </span>            :   // right, but the best we can do here...
<span class="lineNum">    3447 </span>            :   return imgLoader-&gt;LoadImage(aURI,                 /* uri to load */
<span class="lineNum">    3448 </span>            :                               documentURI,          /* initialDocumentURI */
<span class="lineNum">    3449 </span>            :                               aReferrer,            /* referrer */
<span class="lineNum">    3450 </span>            :                               aReferrerPolicy,      /* referrer policy */
<span class="lineNum">    3451 </span>            :                               aLoadingPrincipal,    /* loading principal */
<span class="lineNum">    3452 </span>            :                               loadGroup,            /* loadgroup */
<span class="lineNum">    3453 </span>            :                               aObserver,            /* imgINotificationObserver */
<span class="lineNum">    3454 </span>            :                               aContext,             /* loading context */
<span class="lineNum">    3455 </span>            :                               aLoadingDocument,     /* uniquification key */
<span class="lineNum">    3456 </span>            :                               aLoadFlags,           /* load flags */
<span class="lineNum">    3457 </span>            :                               nullptr,              /* cache key */
<span class="lineNum">    3458 </span>            :                               aContentPolicyType,   /* content policy type */
<span class="lineNum">    3459 </span>            :                               initiatorType,        /* the load initiator */
<span class="lineNum">    3460 </span><span class="lineNoCov">          0 :                               aRequest);</span>
<span class="lineNum">    3461 </span>            : }
<span class="lineNum">    3462 </span>            : 
<span class="lineNum">    3463 </span>            : // static
<span class="lineNum">    3464 </span>            : already_AddRefed&lt;imgIContainer&gt;
<span class="lineNum">    3465 </span><span class="lineNoCov">          0 : nsContentUtils::GetImageFromContent(nsIImageLoadingContent* aContent,</span>
<span class="lineNum">    3466 </span>            :                                     imgIRequest **aRequest)
<span class="lineNum">    3467 </span>            : {
<span class="lineNum">    3468 </span><span class="lineNoCov">          0 :   if (aRequest) {</span>
<span class="lineNum">    3469 </span><span class="lineNoCov">          0 :     *aRequest = nullptr;</span>
<span class="lineNum">    3470 </span>            :   }
<span class="lineNum">    3471 </span>            : 
<span class="lineNum">    3472 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(aContent, nullptr);</span>
<span class="lineNum">    3473 </span>            : 
<span class="lineNum">    3474 </span>            :   nsCOMPtr&lt;imgIRequest&gt; imgRequest;
<span class="lineNum">    3475 </span>            :   aContent-&gt;GetRequest(nsIImageLoadingContent::CURRENT_REQUEST,
<span class="lineNum">    3476 </span><span class="lineNoCov">          0 :                       getter_AddRefs(imgRequest));</span>
<span class="lineNum">    3477 </span><span class="lineNoCov">          0 :   if (!imgRequest) {</span>
<span class="lineNum">    3478 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">    3479 </span>            :   }
<span class="lineNum">    3480 </span>            : 
<span class="lineNum">    3481 </span>            :   nsCOMPtr&lt;imgIContainer&gt; imgContainer;
<span class="lineNum">    3482 </span><span class="lineNoCov">          0 :   imgRequest-&gt;GetImage(getter_AddRefs(imgContainer));</span>
<span class="lineNum">    3483 </span>            : 
<span class="lineNum">    3484 </span><span class="lineNoCov">          0 :   if (!imgContainer) {</span>
<span class="lineNum">    3485 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">    3486 </span>            :   }
<span class="lineNum">    3487 </span>            : 
<span class="lineNum">    3488 </span><span class="lineNoCov">          0 :   if (aRequest) {</span>
<span class="lineNum">    3489 </span>            :     imgRequest.swap(*aRequest);
<span class="lineNum">    3490 </span>            :   }
<span class="lineNum">    3491 </span>            : 
<span class="lineNum">    3492 </span>            :   return imgContainer.forget();
<span class="lineNum">    3493 </span>            : }
<span class="lineNum">    3494 </span>            : 
<a name="3495"><span class="lineNum">    3495 </span>            : //static</a>
<span class="lineNum">    3496 </span>            : already_AddRefed&lt;imgRequestProxy&gt;
<span class="lineNum">    3497 </span><span class="lineNoCov">          0 : nsContentUtils::GetStaticRequest(imgRequestProxy* aRequest)</span>
<span class="lineNum">    3498 </span>            : {
<span class="lineNum">    3499 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(aRequest, nullptr);</span>
<span class="lineNum">    3500 </span>            :   RefPtr&lt;imgRequestProxy&gt; retval;
<span class="lineNum">    3501 </span><span class="lineNoCov">          0 :   aRequest-&gt;GetStaticRequest(getter_AddRefs(retval));</span>
<span class="lineNum">    3502 </span><span class="lineNoCov">          0 :   return retval.forget();</span>
<span class="lineNum">    3503 </span>            : }
<span class="lineNum">    3504 </span>            : 
<span class="lineNum">    3505 </span>            : // static
<span class="lineNum">    3506 </span>            : bool
<span class="lineNum">    3507 </span><span class="lineNoCov">          0 : nsContentUtils::ContentIsDraggable(nsIContent* aContent)</span>
<span class="lineNum">    3508 </span>            : {
<span class="lineNum">    3509 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDOMHTMLElement&gt; htmlElement = do_QueryInterface(aContent);</span>
<span class="lineNum">    3510 </span><span class="lineNoCov">          0 :   if (htmlElement) {</span>
<span class="lineNum">    3511 </span><span class="lineNoCov">          0 :     bool draggable = false;</span>
<span class="lineNum">    3512 </span><span class="lineNoCov">          0 :     htmlElement-&gt;GetDraggable(&amp;draggable);</span>
<span class="lineNum">    3513 </span><span class="lineNoCov">          0 :     if (draggable)</span>
<span class="lineNum">    3514 </span><span class="lineNoCov">          0 :       return true;</span>
<span class="lineNum">    3515 </span>            : 
<span class="lineNum">    3516 </span><span class="lineNoCov">          0 :     if (aContent-&gt;AttrValueIs(kNameSpaceID_None, nsGkAtoms::draggable,</span>
<span class="lineNum">    3517 </span><span class="lineNoCov">          0 :                               nsGkAtoms::_false, eIgnoreCase))</span>
<span class="lineNum">    3518 </span>            :       return false;
<span class="lineNum">    3519 </span>            :   }
<span class="lineNum">    3520 </span>            : 
<span class="lineNum">    3521 </span>            :   // special handling for content area image and link dragging
<span class="lineNum">    3522 </span><span class="lineNoCov">          0 :   return IsDraggableImage(aContent) || IsDraggableLink(aContent);</span>
<span class="lineNum">    3523 </span>            : }
<span class="lineNum">    3524 </span>            : 
<span class="lineNum">    3525 </span>            : // static
<span class="lineNum">    3526 </span>            : bool
<span class="lineNum">    3527 </span><span class="lineNoCov">          0 : nsContentUtils::IsDraggableImage(nsIContent* aContent)</span>
<span class="lineNum">    3528 </span>            : {
<span class="lineNum">    3529 </span>            :   NS_PRECONDITION(aContent, &quot;Must have content node to test&quot;);
<span class="lineNum">    3530 </span>            : 
<span class="lineNum">    3531 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIImageLoadingContent&gt; imageContent(do_QueryInterface(aContent));</span>
<span class="lineNum">    3532 </span><span class="lineNoCov">          0 :   if (!imageContent) {</span>
<span class="lineNum">    3533 </span>            :     return false;
<span class="lineNum">    3534 </span>            :   }
<span class="lineNum">    3535 </span>            : 
<span class="lineNum">    3536 </span>            :   nsCOMPtr&lt;imgIRequest&gt; imgRequest;
<span class="lineNum">    3537 </span>            :   imageContent-&gt;GetRequest(nsIImageLoadingContent::CURRENT_REQUEST,
<span class="lineNum">    3538 </span><span class="lineNoCov">          0 :                            getter_AddRefs(imgRequest));</span>
<span class="lineNum">    3539 </span>            : 
<span class="lineNum">    3540 </span>            :   // XXXbz It may be draggable even if the request resulted in an error.  Why?
<span class="lineNum">    3541 </span>            :   // Not sure; that's what the old nsContentAreaDragDrop/nsFrame code did.
<span class="lineNum">    3542 </span><span class="lineNoCov">          0 :   return imgRequest != nullptr;</span>
<span class="lineNum">    3543 </span>            : }
<span class="lineNum">    3544 </span>            : 
<span class="lineNum">    3545 </span>            : // static
<span class="lineNum">    3546 </span>            : bool
<span class="lineNum">    3547 </span><span class="lineNoCov">          0 : nsContentUtils::IsDraggableLink(const nsIContent* aContent) {</span>
<span class="lineNum">    3548 </span>            :   nsCOMPtr&lt;nsIURI&gt; absURI;
<span class="lineNum">    3549 </span><span class="lineNoCov">          0 :   return aContent-&gt;IsLink(getter_AddRefs(absURI));</span>
<span class="lineNum">    3550 </span>            : }
<span class="lineNum">    3551 </span>            : 
<span class="lineNum">    3552 </span>            : // static
<span class="lineNum">    3553 </span>            : nsresult
<span class="lineNum">    3554 </span><span class="lineNoCov">          0 : nsContentUtils::QNameChanged(mozilla::dom::NodeInfo* aNodeInfo, nsIAtom* aName,</span>
<span class="lineNum">    3555 </span>            :                              mozilla::dom::NodeInfo** aResult)
<span class="lineNum">    3556 </span>            : {
<span class="lineNum">    3557 </span><span class="lineNoCov">          0 :   nsNodeInfoManager *niMgr = aNodeInfo-&gt;NodeInfoManager();</span>
<span class="lineNum">    3558 </span>            : 
<span class="lineNum">    3559 </span>            :   *aResult = niMgr-&gt;GetNodeInfo(aName, nullptr,
<span class="lineNum">    3560 </span>            :                                 aNodeInfo-&gt;NamespaceID(),
<span class="lineNum">    3561 </span><span class="lineNoCov">          0 :                                 aNodeInfo-&gt;NodeType(),</span>
<span class="lineNum">    3562 </span><span class="lineNoCov">          0 :                                 aNodeInfo-&gt;GetExtraName()).take();</span>
<span class="lineNum">    3563 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    3564 </span>            : }
<span class="lineNum">    3565 </span>            : 
<span class="lineNum">    3566 </span>            : 
<span class="lineNum">    3567 </span>            : static bool
<span class="lineNum">    3568 </span><span class="lineNoCov">          0 : TestSitePerm(nsIPrincipal* aPrincipal, const char* aType, uint32_t aPerm, bool aExactHostMatch)</span>
<span class="lineNum">    3569 </span>            : {
<span class="lineNum">    3570 </span><span class="lineNoCov">          0 :   if (!aPrincipal) {</span>
<span class="lineNum">    3571 </span>            :     // We always deny (i.e. don't allow) the permission if we don't have a
<span class="lineNum">    3572 </span>            :     // principal.
<span class="lineNum">    3573 </span><span class="lineNoCov">          0 :     return aPerm != nsIPermissionManager::ALLOW_ACTION;</span>
<span class="lineNum">    3574 </span>            :   }
<span class="lineNum">    3575 </span>            : 
<span class="lineNum">    3576 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIPermissionManager&gt; permMgr = services::GetPermissionManager();</span>
<span class="lineNum">    3577 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(permMgr, false);</span>
<span class="lineNum">    3578 </span>            : 
<span class="lineNum">    3579 </span>            :   uint32_t perm;
<span class="lineNum">    3580 </span>            :   nsresult rv;
<span class="lineNum">    3581 </span><span class="lineNoCov">          0 :   if (aExactHostMatch) {</span>
<span class="lineNum">    3582 </span><span class="lineNoCov">          0 :     rv = permMgr-&gt;TestExactPermissionFromPrincipal(aPrincipal, aType, &amp;perm);</span>
<span class="lineNum">    3583 </span>            :   } else {
<span class="lineNum">    3584 </span><span class="lineNoCov">          0 :     rv = permMgr-&gt;TestPermissionFromPrincipal(aPrincipal, aType, &amp;perm);</span>
<span class="lineNum">    3585 </span>            :   }
<span class="lineNum">    3586 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, false);</span>
<span class="lineNum">    3587 </span>            : 
<span class="lineNum">    3588 </span><span class="lineNoCov">          0 :   return perm == aPerm;</span>
<span class="lineNum">    3589 </span>            : }
<a name="3590"><span class="lineNum">    3590 </span>            : </a>
<span class="lineNum">    3591 </span>            : bool
<span class="lineNum">    3592 </span><span class="lineNoCov">          0 : nsContentUtils::IsSitePermAllow(nsIPrincipal* aPrincipal, const char* aType)</span>
<span class="lineNum">    3593 </span>            : {
<span class="lineNum">    3594 </span><span class="lineNoCov">          0 :   return TestSitePerm(aPrincipal, aType, nsIPermissionManager::ALLOW_ACTION, false);</span>
<span class="lineNum">    3595 </span>            : }
<a name="3596"><span class="lineNum">    3596 </span>            : </a>
<span class="lineNum">    3597 </span>            : bool
<span class="lineNum">    3598 </span><span class="lineNoCov">          0 : nsContentUtils::IsSitePermDeny(nsIPrincipal* aPrincipal, const char* aType)</span>
<span class="lineNum">    3599 </span>            : {
<span class="lineNum">    3600 </span><span class="lineNoCov">          0 :   return TestSitePerm(aPrincipal, aType, nsIPermissionManager::DENY_ACTION, false);</span>
<span class="lineNum">    3601 </span>            : }
<a name="3602"><span class="lineNum">    3602 </span>            : </a>
<span class="lineNum">    3603 </span>            : bool
<span class="lineNum">    3604 </span><span class="lineNoCov">          0 : nsContentUtils::IsExactSitePermAllow(nsIPrincipal* aPrincipal, const char* aType)</span>
<span class="lineNum">    3605 </span>            : {
<span class="lineNum">    3606 </span><span class="lineNoCov">          0 :   return TestSitePerm(aPrincipal, aType, nsIPermissionManager::ALLOW_ACTION, true);</span>
<span class="lineNum">    3607 </span>            : }
<a name="3608"><span class="lineNum">    3608 </span>            : </a>
<span class="lineNum">    3609 </span>            : bool
<span class="lineNum">    3610 </span><span class="lineNoCov">          0 : nsContentUtils::IsExactSitePermDeny(nsIPrincipal* aPrincipal, const char* aType)</span>
<span class="lineNum">    3611 </span>            : {
<span class="lineNum">    3612 </span><span class="lineNoCov">          0 :   return TestSitePerm(aPrincipal, aType, nsIPermissionManager::DENY_ACTION, true);</span>
<span class="lineNum">    3613 </span>            : }
<span class="lineNum">    3614 </span>            : 
<span class="lineNum">    3615 </span>            : static const char *gEventNames[] = {&quot;event&quot;};
<span class="lineNum">    3616 </span>            : static const char *gSVGEventNames[] = {&quot;evt&quot;};
<span class="lineNum">    3617 </span>            : // for b/w compat, the first name to onerror is still 'event', even though it
<span class="lineNum">    3618 </span>            : // is actually the error message
<span class="lineNum">    3619 </span>            : static const char *gOnErrorNames[] = {&quot;event&quot;, &quot;source&quot;, &quot;lineno&quot;,
<span class="lineNum">    3620 </span>            :                                       &quot;colno&quot;, &quot;error&quot;};
<span class="lineNum">    3621 </span>            : 
<a name="3622"><span class="lineNum">    3622 </span>            : // static</a>
<span class="lineNum">    3623 </span>            : void
<span class="lineNum">    3624 </span><span class="lineNoCov">          0 : nsContentUtils::GetEventArgNames(int32_t aNameSpaceID,</span>
<span class="lineNum">    3625 </span>            :                                  nsIAtom *aEventName,
<span class="lineNum">    3626 </span>            :                                  bool aIsForWindow,
<span class="lineNum">    3627 </span>            :                                  uint32_t *aArgCount,
<span class="lineNum">    3628 </span>            :                                  const char*** aArgArray)
<span class="lineNum">    3629 </span>            : {
<span class="lineNum">    3630 </span>            : #define SET_EVENT_ARG_NAMES(names) \
<span class="lineNum">    3631 </span>            :     *aArgCount = sizeof(names)/sizeof(names[0]); \
<span class="lineNum">    3632 </span>            :     *aArgArray = names;
<span class="lineNum">    3633 </span>            : 
<span class="lineNum">    3634 </span>            :   // JSEventHandler is what does the arg magic for onerror, and it does
<span class="lineNum">    3635 </span>            :   // not seem to take the namespace into account.  So we let onerror in all
<span class="lineNum">    3636 </span>            :   // namespaces get the 3 arg names.
<span class="lineNum">    3637 </span><span class="lineNoCov">          0 :   if (aEventName == nsGkAtoms::onerror &amp;&amp; aIsForWindow) {</span>
<span class="lineNum">    3638 </span><span class="lineNoCov">          0 :     SET_EVENT_ARG_NAMES(gOnErrorNames);</span>
<span class="lineNum">    3639 </span><span class="lineNoCov">          0 :   } else if (aNameSpaceID == kNameSpaceID_SVG) {</span>
<span class="lineNum">    3640 </span><span class="lineNoCov">          0 :     SET_EVENT_ARG_NAMES(gSVGEventNames);</span>
<span class="lineNum">    3641 </span>            :   } else {
<span class="lineNum">    3642 </span><span class="lineNoCov">          0 :     SET_EVENT_ARG_NAMES(gEventNames);</span>
<span class="lineNum">    3643 </span>            :   }
<span class="lineNum">    3644 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3645 </span>            : 
<span class="lineNum">    3646 </span>            : static const char gPropertiesFiles[nsContentUtils::PropertiesFile_COUNT][56] = {
<span class="lineNum">    3647 </span>            :   // Must line up with the enum values in |PropertiesFile| enum.
<span class="lineNum">    3648 </span>            :   &quot;chrome://global/locale/css.properties&quot;,
<span class="lineNum">    3649 </span>            :   &quot;chrome://global/locale/xbl.properties&quot;,
<span class="lineNum">    3650 </span>            :   &quot;chrome://global/locale/xul.properties&quot;,
<span class="lineNum">    3651 </span>            :   &quot;chrome://global/locale/layout_errors.properties&quot;,
<span class="lineNum">    3652 </span>            :   &quot;chrome://global/locale/layout/HtmlForm.properties&quot;,
<span class="lineNum">    3653 </span>            :   &quot;chrome://global/locale/printing.properties&quot;,
<span class="lineNum">    3654 </span>            :   &quot;chrome://global/locale/dom/dom.properties&quot;,
<span class="lineNum">    3655 </span>            :   &quot;chrome://global/locale/layout/htmlparser.properties&quot;,
<span class="lineNum">    3656 </span>            :   &quot;chrome://global/locale/svg/svg.properties&quot;,
<span class="lineNum">    3657 </span>            :   &quot;chrome://branding/locale/brand.properties&quot;,
<span class="lineNum">    3658 </span>            :   &quot;chrome://global/locale/commonDialogs.properties&quot;,
<span class="lineNum">    3659 </span>            :   &quot;chrome://global/locale/mathml/mathml.properties&quot;,
<span class="lineNum">    3660 </span>            :   &quot;chrome://global/locale/security/security.properties&quot;,
<span class="lineNum">    3661 </span>            :   &quot;chrome://necko/locale/necko.properties&quot;
<span class="lineNum">    3662 </span>            : };
<a name="3663"><span class="lineNum">    3663 </span>            : </a>
<span class="lineNum">    3664 </span>            : /* static */ nsresult
<span class="lineNum">    3665 </span><span class="lineNoCov">          0 : nsContentUtils::EnsureStringBundle(PropertiesFile aFile)</span>
<span class="lineNum">    3666 </span>            : {
<span class="lineNum">    3667 </span><span class="lineNoCov">          0 :   if (!sStringBundles[aFile]) {</span>
<span class="lineNum">    3668 </span><span class="lineNoCov">          0 :     if (!sStringBundleService) {</span>
<span class="lineNum">    3669 </span>            :       nsresult rv =
<span class="lineNum">    3670 </span><span class="lineNoCov">          0 :         CallGetService(NS_STRINGBUNDLE_CONTRACTID, &amp;sStringBundleService);</span>
<span class="lineNum">    3671 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3672 </span>            :     }
<span class="lineNum">    3673 </span>            :     nsIStringBundle *bundle;
<span class="lineNum">    3674 </span>            :     nsresult rv =
<span class="lineNum">    3675 </span><span class="lineNoCov">          0 :       sStringBundleService-&gt;CreateBundle(gPropertiesFiles[aFile], &amp;bundle);</span>
<span class="lineNum">    3676 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3677 </span><span class="lineNoCov">          0 :     sStringBundles[aFile] = bundle; // transfer ownership</span>
<span class="lineNum">    3678 </span>            :   }
<span class="lineNum">    3679 </span>            :   return NS_OK;
<span class="lineNum">    3680 </span>            : }
<a name="3681"><span class="lineNum">    3681 </span>            : </a>
<span class="lineNum">    3682 </span>            : /* static */
<span class="lineNum">    3683 </span><span class="lineNoCov">          0 : nsresult nsContentUtils::GetLocalizedString(PropertiesFile aFile,</span>
<span class="lineNum">    3684 </span>            :                                             const char* aKey,
<span class="lineNum">    3685 </span>            :                                             nsXPIDLString&amp; aResult)
<span class="lineNum">    3686 </span>            : {
<span class="lineNum">    3687 </span><span class="lineNoCov">          0 :   nsresult rv = EnsureStringBundle(aFile);</span>
<span class="lineNum">    3688 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3689 </span><span class="lineNoCov">          0 :   nsIStringBundle *bundle = sStringBundles[aFile];</span>
<span class="lineNum">    3690 </span>            : 
<span class="lineNum">    3691 </span>            :   return bundle-&gt;GetStringFromName(NS_ConvertASCIItoUTF16(aKey).get(),
<span class="lineNum">    3692 </span><span class="lineNoCov">          0 :                                    getter_Copies(aResult));</span>
<span class="lineNum">    3693 </span>            : }
<a name="3694"><span class="lineNum">    3694 </span>            : </a>
<span class="lineNum">    3695 </span>            : /* static */
<span class="lineNum">    3696 </span><span class="lineNoCov">          0 : nsresult nsContentUtils::FormatLocalizedString(PropertiesFile aFile,</span>
<span class="lineNum">    3697 </span>            :                                                const char* aKey,
<span class="lineNum">    3698 </span>            :                                                const char16_t **aParams,
<span class="lineNum">    3699 </span>            :                                                uint32_t aParamsLength,
<span class="lineNum">    3700 </span>            :                                                nsXPIDLString&amp; aResult)
<span class="lineNum">    3701 </span>            : {
<span class="lineNum">    3702 </span><span class="lineNoCov">          0 :   nsresult rv = EnsureStringBundle(aFile);</span>
<span class="lineNum">    3703 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3704 </span><span class="lineNoCov">          0 :   nsIStringBundle *bundle = sStringBundles[aFile];</span>
<span class="lineNum">    3705 </span>            : 
<span class="lineNum">    3706 </span><span class="lineNoCov">          0 :   if (!aParams || !aParamsLength) {</span>
<span class="lineNum">    3707 </span>            :     return bundle-&gt;GetStringFromName(NS_ConvertASCIItoUTF16(aKey).get(),
<span class="lineNum">    3708 </span><span class="lineNoCov">          0 :                                      getter_Copies(aResult));</span>
<span class="lineNum">    3709 </span>            :   }
<span class="lineNum">    3710 </span>            : 
<span class="lineNum">    3711 </span>            :   return bundle-&gt;FormatStringFromName(NS_ConvertASCIItoUTF16(aKey).get(),
<span class="lineNum">    3712 </span>            :                                       aParams, aParamsLength,
<span class="lineNum">    3713 </span><span class="lineNoCov">          0 :                                       getter_Copies(aResult));</span>
<span class="lineNum">    3714 </span>            : }
<a name="3715"><span class="lineNum">    3715 </span>            : </a>
<span class="lineNum">    3716 </span>            : /* static */
<span class="lineNum">    3717 </span><span class="lineNoCov">          0 : nsresult nsContentUtils::FormatLocalizedString(</span>
<span class="lineNum">    3718 </span>            :                                           PropertiesFile aFile,
<span class="lineNum">    3719 </span>            :                                           const char* aKey,
<span class="lineNum">    3720 </span>            :                                           const nsTArray&lt;nsString&gt;&amp; aParamArray,
<span class="lineNum">    3721 </span>            :                                           nsXPIDLString&amp; aResult)
<span class="lineNum">    3722 </span>            : {
<span class="lineNum">    3723 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    3724 </span>            : 
<span class="lineNum">    3725 </span>            :   UniquePtr&lt;const char16_t*[]&gt; params;
<span class="lineNum">    3726 </span><span class="lineNoCov">          0 :   uint32_t paramsLength = aParamArray.Length();</span>
<span class="lineNum">    3727 </span><span class="lineNoCov">          0 :   if (paramsLength &gt; 0) {</span>
<span class="lineNum">    3728 </span><span class="lineNoCov">          0 :     params = MakeUnique&lt;const char16_t*[]&gt;(paramsLength);</span>
<span class="lineNum">    3729 </span><span class="lineNoCov">          0 :     for (uint32_t i = 0; i &lt; paramsLength; ++i) {</span>
<span class="lineNum">    3730 </span><span class="lineNoCov">          0 :       params[i] = aParamArray[i].get();</span>
<span class="lineNum">    3731 </span>            :     }
<span class="lineNum">    3732 </span>            :   }
<span class="lineNum">    3733 </span>            :   return FormatLocalizedString(aFile, aKey, params.get(), paramsLength,
<span class="lineNum">    3734 </span><span class="lineNoCov">          0 :                                aResult);</span>
<span class="lineNum">    3735 </span>            : }
<span class="lineNum">    3736 </span>            : 
<span class="lineNum">    3737 </span>            : 
<span class="lineNum">    3738 </span>            : /* static */ void
<span class="lineNum">    3739 </span><span class="lineNoCov">          0 : nsContentUtils::LogSimpleConsoleError(const nsAString&amp; aErrorText,</span>
<span class="lineNum">    3740 </span>            :                                       const char * classification)
<span class="lineNum">    3741 </span>            : {
<span class="lineNum">    3742 </span>            :   nsCOMPtr&lt;nsIScriptError&gt; scriptError =
<span class="lineNum">    3743 </span><span class="lineNoCov">          0 :     do_CreateInstance(NS_SCRIPTERROR_CONTRACTID);</span>
<span class="lineNum">    3744 </span><span class="lineNoCov">          0 :   if (scriptError) {</span>
<span class="lineNum">    3745 </span>            :     nsCOMPtr&lt;nsIConsoleService&gt; console =
<span class="lineNum">    3746 </span><span class="lineNoCov">          0 :       do_GetService(NS_CONSOLESERVICE_CONTRACTID);</span>
<span class="lineNum">    3747 </span><span class="lineNoCov">          0 :     if (console &amp;&amp; NS_SUCCEEDED(scriptError-&gt;Init(aErrorText, EmptyString(),</span>
<span class="lineNum">    3748 </span>            :                                                   EmptyString(), 0, 0,
<span class="lineNum">    3749 </span>            :                                                   nsIScriptError::errorFlag,
<span class="lineNum">    3750 </span>            :                                                   classification))) {
<span class="lineNum">    3751 </span><span class="lineNoCov">          0 :       console-&gt;LogMessage(scriptError);</span>
<span class="lineNum">    3752 </span>            :     }
<span class="lineNum">    3753 </span>            :   }
<span class="lineNum">    3754 </span><span class="lineNoCov">          0 : }</span>
<a name="3755"><span class="lineNum">    3755 </span>            : </a>
<span class="lineNum">    3756 </span>            : /* static */ nsresult
<span class="lineNum">    3757 </span><span class="lineNoCov">          0 : nsContentUtils::ReportToConsole(uint32_t aErrorFlags,</span>
<span class="lineNum">    3758 </span>            :                                 const nsACString&amp; aCategory,
<span class="lineNum">    3759 </span>            :                                 const nsIDocument* aDocument,
<span class="lineNum">    3760 </span>            :                                 PropertiesFile aFile,
<span class="lineNum">    3761 </span>            :                                 const char *aMessageName,
<span class="lineNum">    3762 </span>            :                                 const char16_t **aParams,
<span class="lineNum">    3763 </span>            :                                 uint32_t aParamsLength,
<span class="lineNum">    3764 </span>            :                                 nsIURI* aURI,
<span class="lineNum">    3765 </span>            :                                 const nsAFlatString&amp; aSourceLine,
<span class="lineNum">    3766 </span>            :                                 uint32_t aLineNumber,
<span class="lineNum">    3767 </span>            :                                 uint32_t aColumnNumber)
<span class="lineNum">    3768 </span>            : {
<span class="lineNum">    3769 </span>            :   NS_ASSERTION((aParams &amp;&amp; aParamsLength) || (!aParams &amp;&amp; !aParamsLength),
<span class="lineNum">    3770 </span>            :                &quot;Supply either both parameters and their number or no&quot;
<span class="lineNum">    3771 </span>            :                &quot;parameters and 0.&quot;);
<span class="lineNum">    3772 </span>            : 
<span class="lineNum">    3773 </span>            :   nsresult rv;
<span class="lineNum">    3774 </span><span class="lineNoCov">          0 :   nsXPIDLString errorText;</span>
<span class="lineNum">    3775 </span><span class="lineNoCov">          0 :   if (aParams) {</span>
<span class="lineNum">    3776 </span>            :     rv = FormatLocalizedString(aFile, aMessageName, aParams, aParamsLength,
<span class="lineNum">    3777 </span><span class="lineNoCov">          0 :                                errorText);</span>
<span class="lineNum">    3778 </span>            :   }
<span class="lineNum">    3779 </span>            :   else {
<span class="lineNum">    3780 </span><span class="lineNoCov">          0 :     rv = GetLocalizedString(aFile, aMessageName, errorText);</span>
<span class="lineNum">    3781 </span>            :   }
<span class="lineNum">    3782 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3783 </span>            : 
<span class="lineNum">    3784 </span>            :   return ReportToConsoleNonLocalized(errorText, aErrorFlags, aCategory,
<span class="lineNum">    3785 </span>            :                                      aDocument, aURI, aSourceLine,
<span class="lineNum">    3786 </span><span class="lineNoCov">          0 :                                      aLineNumber, aColumnNumber);</span>
<span class="lineNum">    3787 </span>            : }
<span class="lineNum">    3788 </span>            : 
<span class="lineNum">    3789 </span>            : 
<span class="lineNum">    3790 </span>            : /* static */ nsresult
<span class="lineNum">    3791 </span><span class="lineNoCov">          0 : nsContentUtils::ReportToConsoleNonLocalized(const nsAString&amp; aErrorText,</span>
<span class="lineNum">    3792 </span>            :                                             uint32_t aErrorFlags,
<span class="lineNum">    3793 </span>            :                                             const nsACString&amp; aCategory,
<span class="lineNum">    3794 </span>            :                                             const nsIDocument* aDocument,
<span class="lineNum">    3795 </span>            :                                             nsIURI* aURI,
<span class="lineNum">    3796 </span>            :                                             const nsAFlatString&amp; aSourceLine,
<span class="lineNum">    3797 </span>            :                                             uint32_t aLineNumber,
<span class="lineNum">    3798 </span>            :                                             uint32_t aColumnNumber,
<span class="lineNum">    3799 </span>            :                                             MissingErrorLocationMode aLocationMode)
<span class="lineNum">    3800 </span>            : {
<span class="lineNum">    3801 </span><span class="lineNoCov">          0 :   uint64_t innerWindowID = 0;</span>
<span class="lineNum">    3802 </span><span class="lineNoCov">          0 :   if (aDocument) {</span>
<span class="lineNum">    3803 </span><span class="lineNoCov">          0 :     if (!aURI) {</span>
<span class="lineNum">    3804 </span><span class="lineNoCov">          0 :       aURI = aDocument-&gt;GetDocumentURI();</span>
<span class="lineNum">    3805 </span>            :     }
<span class="lineNum">    3806 </span><span class="lineNoCov">          0 :     innerWindowID = aDocument-&gt;InnerWindowID();</span>
<span class="lineNum">    3807 </span>            :   }
<span class="lineNum">    3808 </span>            : 
<span class="lineNum">    3809 </span>            :   return ReportToConsoleByWindowID(aErrorText, aErrorFlags, aCategory,
<span class="lineNum">    3810 </span>            :                                    innerWindowID, aURI, aSourceLine,
<span class="lineNum">    3811 </span><span class="lineNoCov">          0 :                                    aLineNumber, aColumnNumber, aLocationMode);</span>
<span class="lineNum">    3812 </span>            : }
<span class="lineNum">    3813 </span>            : 
<span class="lineNum">    3814 </span>            : /* static */ nsresult
<span class="lineNum">    3815 </span><span class="lineNoCov">          0 : nsContentUtils::ReportToConsoleByWindowID(const nsAString&amp; aErrorText,</span>
<span class="lineNum">    3816 </span>            :                                           uint32_t aErrorFlags,
<span class="lineNum">    3817 </span>            :                                           const nsACString&amp; aCategory,
<span class="lineNum">    3818 </span>            :                                           uint64_t aInnerWindowID,
<span class="lineNum">    3819 </span>            :                                           nsIURI* aURI,
<span class="lineNum">    3820 </span>            :                                           const nsAFlatString&amp; aSourceLine,
<span class="lineNum">    3821 </span>            :                                           uint32_t aLineNumber,
<span class="lineNum">    3822 </span>            :                                           uint32_t aColumnNumber,
<span class="lineNum">    3823 </span>            :                                           MissingErrorLocationMode aLocationMode)
<span class="lineNum">    3824 </span>            : {
<span class="lineNum">    3825 </span>            :   nsresult rv;
<span class="lineNum">    3826 </span><span class="lineNoCov">          0 :   if (!sConsoleService) { // only need to bother null-checking here</span>
<span class="lineNum">    3827 </span><span class="lineNoCov">          0 :     rv = CallGetService(NS_CONSOLESERVICE_CONTRACTID, &amp;sConsoleService);</span>
<span class="lineNum">    3828 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3829 </span>            :   }
<span class="lineNum">    3830 </span>            : 
<span class="lineNum">    3831 </span><span class="lineNoCov">          0 :   nsAutoCString spec;</span>
<span class="lineNum">    3832 </span><span class="lineNoCov">          0 :   if (!aLineNumber &amp;&amp; aLocationMode == eUSE_CALLING_LOCATION) {</span>
<span class="lineNum">    3833 </span><span class="lineNoCov">          0 :     JSContext *cx = GetCurrentJSContext();</span>
<span class="lineNum">    3834 </span><span class="lineNoCov">          0 :     if (cx) {</span>
<span class="lineNum">    3835 </span><span class="lineNoCov">          0 :       nsJSUtils::GetCallingLocation(cx, spec, &amp;aLineNumber, &amp;aColumnNumber);</span>
<span class="lineNum">    3836 </span>            :     }
<span class="lineNum">    3837 </span>            :   }
<span class="lineNum">    3838 </span><span class="lineNoCov">          0 :   if (spec.IsEmpty() &amp;&amp; aURI) {</span>
<span class="lineNum">    3839 </span><span class="lineNoCov">          0 :     spec = aURI-&gt;GetSpecOrDefault();</span>
<span class="lineNum">    3840 </span>            :   }
<span class="lineNum">    3841 </span>            : 
<span class="lineNum">    3842 </span>            :   nsCOMPtr&lt;nsIScriptError&gt; errorObject =
<span class="lineNum">    3843 </span><span class="lineNoCov">          0 :       do_CreateInstance(NS_SCRIPTERROR_CONTRACTID, &amp;rv);</span>
<span class="lineNum">    3844 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3845 </span>            : 
<span class="lineNum">    3846 </span>            :   rv = errorObject-&gt;InitWithWindowID(aErrorText,
<span class="lineNum">    3847 </span>            :                                      NS_ConvertUTF8toUTF16(spec), // file name
<span class="lineNum">    3848 </span>            :                                      aSourceLine,
<span class="lineNum">    3849 </span>            :                                      aLineNumber, aColumnNumber,
<span class="lineNum">    3850 </span>            :                                      aErrorFlags, aCategory,
<span class="lineNum">    3851 </span><span class="lineNoCov">          0 :                                      aInnerWindowID);</span>
<span class="lineNum">    3852 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    3853 </span>            : 
<span class="lineNum">    3854 </span><span class="lineNoCov">          0 :   return sConsoleService-&gt;LogMessage(errorObject);</span>
<span class="lineNum">    3855 </span>            : }
<a name="3856"><span class="lineNum">    3856 </span>            : </a>
<span class="lineNum">    3857 </span>            : void
<span class="lineNum">    3858 </span><span class="lineNoCov">          0 : nsContentUtils::LogMessageToConsole(const char* aMsg)</span>
<span class="lineNum">    3859 </span>            : {
<span class="lineNum">    3860 </span><span class="lineNoCov">          0 :   if (!sConsoleService) { // only need to bother null-checking here</span>
<span class="lineNum">    3861 </span><span class="lineNoCov">          0 :     CallGetService(NS_CONSOLESERVICE_CONTRACTID, &amp;sConsoleService);</span>
<span class="lineNum">    3862 </span><span class="lineNoCov">          0 :     if (!sConsoleService) {</span>
<span class="lineNum">    3863 </span><span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">    3864 </span>            :     }
<span class="lineNum">    3865 </span>            :   }
<span class="lineNum">    3866 </span><span class="lineNoCov">          0 :   sConsoleService-&gt;LogStringMessage(NS_ConvertUTF8toUTF16(aMsg).get());</span>
<span class="lineNum">    3867 </span>            : }
<span class="lineNum">    3868 </span>            : 
<span class="lineNum">    3869 </span>            : bool
<span class="lineNum">    3870 </span><span class="lineNoCov">          0 : nsContentUtils::IsChromeDoc(nsIDocument *aDocument)</span>
<span class="lineNum">    3871 </span>            : {
<span class="lineNum">    3872 </span><span class="lineNoCov">          0 :   if (!aDocument) {</span>
<span class="lineNum">    3873 </span>            :     return false;
<span class="lineNum">    3874 </span>            :   }
<span class="lineNum">    3875 </span><span class="lineNoCov">          0 :   return aDocument-&gt;NodePrincipal() == sSystemPrincipal;</span>
<span class="lineNum">    3876 </span>            : }
<span class="lineNum">    3877 </span>            : 
<span class="lineNum">    3878 </span>            : bool
<span class="lineNum">    3879 </span><span class="lineNoCov">          0 : nsContentUtils::IsChildOfSameType(nsIDocument* aDoc)</span>
<span class="lineNum">    3880 </span>            : {
<span class="lineNum">    3881 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellAsItem(aDoc-&gt;GetDocShell());</span>
<span class="lineNum">    3882 </span>            :   nsCOMPtr&lt;nsIDocShellTreeItem&gt; sameTypeParent;
<span class="lineNum">    3883 </span><span class="lineNoCov">          0 :   if (docShellAsItem) {</span>
<span class="lineNum">    3884 </span><span class="lineNoCov">          0 :     docShellAsItem-&gt;GetSameTypeParent(getter_AddRefs(sameTypeParent));</span>
<span class="lineNum">    3885 </span>            :   }
<span class="lineNum">    3886 </span><span class="lineNoCov">          0 :   return sameTypeParent != nullptr;</span>
<span class="lineNum">    3887 </span>            : }
<a name="3888"><span class="lineNum">    3888 </span>            : </a>
<span class="lineNum">    3889 </span>            : bool
<span class="lineNum">    3890 </span><span class="lineNoCov">          0 : nsContentUtils::IsScriptType(const nsACString&amp; aContentType)</span>
<span class="lineNum">    3891 </span>            : {
<span class="lineNum">    3892 </span>            :   // NOTE: if you add a type here, add it to the CONTENTDLF_CATEGORIES
<span class="lineNum">    3893 </span>            :   // define in nsContentDLF.h as well.
<span class="lineNum">    3894 </span><span class="lineNoCov">          0 :   return aContentType.EqualsLiteral(APPLICATION_JAVASCRIPT) ||</span>
<span class="lineNum">    3895 </span><span class="lineNoCov">          0 :          aContentType.EqualsLiteral(APPLICATION_XJAVASCRIPT) ||</span>
<span class="lineNum">    3896 </span><span class="lineNoCov">          0 :          aContentType.EqualsLiteral(TEXT_ECMASCRIPT) ||</span>
<span class="lineNum">    3897 </span><span class="lineNoCov">          0 :          aContentType.EqualsLiteral(APPLICATION_ECMASCRIPT) ||</span>
<span class="lineNum">    3898 </span><span class="lineNoCov">          0 :          aContentType.EqualsLiteral(TEXT_JAVASCRIPT) ||</span>
<span class="lineNum">    3899 </span><span class="lineNoCov">          0 :          aContentType.EqualsLiteral(APPLICATION_JSON) ||</span>
<span class="lineNum">    3900 </span><span class="lineNoCov">          0 :          aContentType.EqualsLiteral(TEXT_JSON);</span>
<span class="lineNum">    3901 </span>            : }
<a name="3902"><span class="lineNum">    3902 </span>            : </a>
<span class="lineNum">    3903 </span>            : bool
<span class="lineNum">    3904 </span><span class="lineNoCov">          0 : nsContentUtils::IsPlainTextType(const nsACString&amp; aContentType)</span>
<span class="lineNum">    3905 </span>            : {
<span class="lineNum">    3906 </span>            :   // NOTE: if you add a type here, add it to the CONTENTDLF_CATEGORIES
<span class="lineNum">    3907 </span>            :   // define in nsContentDLF.h as well.
<span class="lineNum">    3908 </span><span class="lineNoCov">          0 :   return aContentType.EqualsLiteral(TEXT_PLAIN) ||</span>
<span class="lineNum">    3909 </span><span class="lineNoCov">          0 :          aContentType.EqualsLiteral(TEXT_CSS) ||</span>
<span class="lineNum">    3910 </span><span class="lineNoCov">          0 :          aContentType.EqualsLiteral(TEXT_CACHE_MANIFEST) ||</span>
<span class="lineNum">    3911 </span><span class="lineNoCov">          0 :          aContentType.EqualsLiteral(TEXT_VTT) ||</span>
<span class="lineNum">    3912 </span><span class="lineNoCov">          0 :          IsScriptType(aContentType);</span>
<span class="lineNum">    3913 </span>            : }
<a name="3914"><span class="lineNum">    3914 </span>            : </a>
<span class="lineNum">    3915 </span>            : bool
<span class="lineNum">    3916 </span><span class="lineNoCov">          0 : nsContentUtils::IsUtf8OnlyPlainTextType(const nsACString&amp; aContentType)</span>
<span class="lineNum">    3917 </span>            : {
<span class="lineNum">    3918 </span>            :   // NOTE: This must be a subset of the list in IsPlainTextType().
<span class="lineNum">    3919 </span><span class="lineNoCov">          0 :   return aContentType.EqualsLiteral(TEXT_CACHE_MANIFEST) ||</span>
<span class="lineNum">    3920 </span><span class="lineNoCov">          0 :          aContentType.EqualsLiteral(APPLICATION_JSON) ||</span>
<span class="lineNum">    3921 </span><span class="lineNoCov">          0 :          aContentType.EqualsLiteral(TEXT_JSON) ||</span>
<span class="lineNum">    3922 </span><span class="lineNoCov">          0 :          aContentType.EqualsLiteral(TEXT_VTT);</span>
<span class="lineNum">    3923 </span>            : }
<span class="lineNum">    3924 </span>            : 
<span class="lineNum">    3925 </span>            : bool
<span class="lineNum">    3926 </span><span class="lineNoCov">          0 : nsContentUtils::GetWrapperSafeScriptFilename(nsIDocument* aDocument,</span>
<span class="lineNum">    3927 </span>            :                                              nsIURI* aURI,
<span class="lineNum">    3928 </span>            :                                              nsACString&amp; aScriptURI,
<span class="lineNum">    3929 </span>            :                                              nsresult* aRv)
<span class="lineNum">    3930 </span>            : {
<span class="lineNum">    3931 </span>            :   MOZ_ASSERT(aRv);
<span class="lineNum">    3932 </span><span class="lineNoCov">          0 :   bool scriptFileNameModified = false;</span>
<span class="lineNum">    3933 </span><span class="lineNoCov">          0 :   *aRv = NS_OK;</span>
<span class="lineNum">    3934 </span>            : 
<span class="lineNum">    3935 </span><span class="lineNoCov">          0 :   *aRv = aURI-&gt;GetSpec(aScriptURI);</span>
<span class="lineNum">    3936 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(*aRv, false);</span>
<span class="lineNum">    3937 </span>            : 
<span class="lineNum">    3938 </span><span class="lineNoCov">          0 :   if (IsChromeDoc(aDocument)) {</span>
<span class="lineNum">    3939 </span>            :     nsCOMPtr&lt;nsIChromeRegistry&gt; chromeReg =
<span class="lineNum">    3940 </span><span class="lineNoCov">          0 :       mozilla::services::GetChromeRegistryService();</span>
<span class="lineNum">    3941 </span>            : 
<span class="lineNum">    3942 </span><span class="lineNoCov">          0 :     if (!chromeReg) {</span>
<span class="lineNum">    3943 </span>            :       // If we're running w/o a chrome registry we won't modify any
<span class="lineNum">    3944 </span>            :       // script file names.
<span class="lineNum">    3945 </span>            : 
<span class="lineNum">    3946 </span>            :       return scriptFileNameModified;
<span class="lineNum">    3947 </span>            :     }
<span class="lineNum">    3948 </span>            : 
<span class="lineNum">    3949 </span>            :     bool docWrappersEnabled =
<span class="lineNum">    3950 </span><span class="lineNoCov">          0 :       chromeReg-&gt;WrappersEnabled(aDocument-&gt;GetDocumentURI());</span>
<span class="lineNum">    3951 </span>            : 
<span class="lineNum">    3952 </span><span class="lineNoCov">          0 :     bool uriWrappersEnabled = chromeReg-&gt;WrappersEnabled(aURI);</span>
<span class="lineNum">    3953 </span>            : 
<span class="lineNum">    3954 </span><span class="lineNoCov">          0 :     nsIURI *docURI = aDocument-&gt;GetDocumentURI();</span>
<span class="lineNum">    3955 </span>            : 
<span class="lineNum">    3956 </span><span class="lineNoCov">          0 :     if (docURI &amp;&amp; docWrappersEnabled &amp;&amp; !uriWrappersEnabled) {</span>
<span class="lineNum">    3957 </span>            :       // aURI is a script from a URL that doesn't get wrapper
<span class="lineNum">    3958 </span>            :       // automation. aDocument is a chrome document that does get
<span class="lineNum">    3959 </span>            :       // wrapper automation. Prepend the chrome document's URI
<span class="lineNum">    3960 </span>            :       // followed by the string &quot; -&gt; &quot; to the URI of the script we're
<span class="lineNum">    3961 </span>            :       // loading here so that script in that URI gets the same wrapper
<span class="lineNum">    3962 </span>            :       // automation that the chrome document expects.
<span class="lineNum">    3963 </span><span class="lineNoCov">          0 :       nsAutoCString spec;</span>
<span class="lineNum">    3964 </span><span class="lineNoCov">          0 :       *aRv = docURI-&gt;GetSpec(spec);</span>
<span class="lineNum">    3965 </span><span class="lineNoCov">          0 :       if (NS_WARN_IF(NS_FAILED(*aRv))) {</span>
<span class="lineNum">    3966 </span><span class="lineNoCov">          0 :         return false;</span>
<span class="lineNum">    3967 </span>            :       }
<span class="lineNum">    3968 </span>            : 
<span class="lineNum">    3969 </span><span class="lineNoCov">          0 :       spec.AppendLiteral(&quot; -&gt; &quot;);</span>
<span class="lineNum">    3970 </span><span class="lineNoCov">          0 :       spec.Append(aScriptURI);</span>
<span class="lineNum">    3971 </span>            : 
<span class="lineNum">    3972 </span>            :       aScriptURI = spec;
<span class="lineNum">    3973 </span>            : 
<span class="lineNum">    3974 </span><span class="lineNoCov">          0 :       scriptFileNameModified = true;</span>
<span class="lineNum">    3975 </span>            :     }
<span class="lineNum">    3976 </span>            :   }
<span class="lineNum">    3977 </span>            : 
<span class="lineNum">    3978 </span><span class="lineNoCov">          0 :   return scriptFileNameModified;</span>
<span class="lineNum">    3979 </span>            : }
<span class="lineNum">    3980 </span>            : 
<span class="lineNum">    3981 </span>            : // static
<span class="lineNum">    3982 </span>            : bool
<span class="lineNum">    3983 </span><span class="lineNoCov">          0 : nsContentUtils::IsInChromeDocshell(nsIDocument *aDocument)</span>
<span class="lineNum">    3984 </span>            : {
<span class="lineNum">    3985 </span><span class="lineNoCov">          0 :   if (!aDocument) {</span>
<span class="lineNum">    3986 </span>            :     return false;
<span class="lineNum">    3987 </span>            :   }
<span class="lineNum">    3988 </span>            : 
<span class="lineNum">    3989 </span><span class="lineNoCov">          0 :   if (aDocument-&gt;GetDisplayDocument()) {</span>
<span class="lineNum">    3990 </span><span class="lineNoCov">          0 :     return IsInChromeDocshell(aDocument-&gt;GetDisplayDocument());</span>
<span class="lineNum">    3991 </span>            :   }
<span class="lineNum">    3992 </span>            : 
<span class="lineNum">    3993 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShell = aDocument-&gt;GetDocShell();</span>
<span class="lineNum">    3994 </span><span class="lineNoCov">          0 :   if (!docShell) {</span>
<span class="lineNum">    3995 </span>            :     return false;
<span class="lineNum">    3996 </span>            :   }
<span class="lineNum">    3997 </span>            : 
<span class="lineNum">    3998 </span><span class="lineNoCov">          0 :   return docShell-&gt;ItemType() == nsIDocShellTreeItem::typeChrome;</span>
<span class="lineNum">    3999 </span>            : }
<span class="lineNum">    4000 </span>            : 
<a name="4001"><span class="lineNum">    4001 </span>            : // static</a>
<span class="lineNum">    4002 </span>            : nsIContentPolicy*
<span class="lineNum">    4003 </span><span class="lineCov">        105 : nsContentUtils::GetContentPolicy()</span>
<span class="lineNum">    4004 </span>            : {
<span class="lineNum">    4005 </span><span class="lineCov">        105 :   if (!sTriedToGetContentPolicy) {</span>
<span class="lineNum">    4006 </span><span class="lineCov">         60 :     CallGetService(NS_CONTENTPOLICY_CONTRACTID, &amp;sContentPolicyService);</span>
<span class="lineNum">    4007 </span>            :     // It's OK to not have a content policy service
<span class="lineNum">    4008 </span><span class="lineCov">         60 :     sTriedToGetContentPolicy = true;</span>
<span class="lineNum">    4009 </span>            :   }
<span class="lineNum">    4010 </span>            : 
<span class="lineNum">    4011 </span><span class="lineCov">        105 :   return sContentPolicyService;</span>
<span class="lineNum">    4012 </span>            : }
<span class="lineNum">    4013 </span>            : 
<a name="4014"><span class="lineNum">    4014 </span>            : // static</a>
<span class="lineNum">    4015 </span>            : bool
<span class="lineNum">    4016 </span><span class="lineNoCov">          0 : nsContentUtils::IsEventAttributeName(nsIAtom* aName, int32_t aType)</span>
<span class="lineNum">    4017 </span>            : {
<span class="lineNum">    4018 </span><span class="lineNoCov">          0 :   const char16_t* name = aName-&gt;GetUTF16String();</span>
<span class="lineNum">    4019 </span><span class="lineNoCov">          0 :   if (name[0] != 'o' || name[1] != 'n')</span>
<span class="lineNum">    4020 </span>            :     return false;
<span class="lineNum">    4021 </span>            : 
<span class="lineNum">    4022 </span>            :   EventNameMapping mapping;
<span class="lineNum">    4023 </span><span class="lineNoCov">          0 :   return (sAtomEventTable-&gt;Get(aName, &amp;mapping) &amp;&amp; mapping.mType &amp; aType);</span>
<span class="lineNum">    4024 </span>            : }
<span class="lineNum">    4025 </span>            : 
<a name="4026"><span class="lineNum">    4026 </span>            : // static</a>
<span class="lineNum">    4027 </span>            : EventMessage
<span class="lineNum">    4028 </span><span class="lineNoCov">          0 : nsContentUtils::GetEventMessage(nsIAtom* aName)</span>
<span class="lineNum">    4029 </span>            : {
<span class="lineNum">    4030 </span><span class="lineNoCov">          0 :   if (aName) {</span>
<span class="lineNum">    4031 </span>            :     EventNameMapping mapping;
<span class="lineNum">    4032 </span><span class="lineNoCov">          0 :     if (sAtomEventTable-&gt;Get(aName, &amp;mapping)) {</span>
<span class="lineNum">    4033 </span><span class="lineNoCov">          0 :       return mapping.mMessage;</span>
<span class="lineNum">    4034 </span>            :     }
<span class="lineNum">    4035 </span>            :   }
<span class="lineNum">    4036 </span>            : 
<span class="lineNum">    4037 </span>            :   return eUnidentifiedEvent;
<span class="lineNum">    4038 </span>            : }
<span class="lineNum">    4039 </span>            : 
<a name="4040"><span class="lineNum">    4040 </span>            : // static</a>
<span class="lineNum">    4041 </span>            : mozilla::EventClassID
<span class="lineNum">    4042 </span><span class="lineNoCov">          0 : nsContentUtils::GetEventClassID(const nsAString&amp; aName)</span>
<span class="lineNum">    4043 </span>            : {
<span class="lineNum">    4044 </span>            :   EventNameMapping mapping;
<span class="lineNum">    4045 </span><span class="lineNoCov">          0 :   if (sStringEventTable-&gt;Get(aName, &amp;mapping))</span>
<span class="lineNum">    4046 </span><span class="lineNoCov">          0 :     return mapping.mEventClassID;</span>
<span class="lineNum">    4047 </span>            : 
<span class="lineNum">    4048 </span>            :   return eBasicEventClass;
<span class="lineNum">    4049 </span>            : }
<span class="lineNum">    4050 </span>            : 
<span class="lineNum">    4051 </span>            : nsIAtom*
<span class="lineNum">    4052 </span><span class="lineNoCov">          0 : nsContentUtils::GetEventMessageAndAtom(const nsAString&amp; aName,</span>
<span class="lineNum">    4053 </span>            :                                        mozilla::EventClassID aEventClassID,
<span class="lineNum">    4054 </span>            :                                        EventMessage* aEventMessage)
<span class="lineNum">    4055 </span>            : {
<span class="lineNum">    4056 </span>            :   EventNameMapping mapping;
<span class="lineNum">    4057 </span><span class="lineNoCov">          0 :   if (sStringEventTable-&gt;Get(aName, &amp;mapping)) {</span>
<span class="lineNum">    4058 </span>            :     *aEventMessage =
<span class="lineNum">    4059 </span><span class="lineNoCov">          0 :       mapping.mEventClassID == aEventClassID ? mapping.mMessage :</span>
<span class="lineNum">    4060 </span><span class="lineNoCov">          0 :                                                eUnidentifiedEvent;</span>
<span class="lineNum">    4061 </span><span class="lineNoCov">          0 :     return mapping.mAtom;</span>
<span class="lineNum">    4062 </span>            :   }
<span class="lineNum">    4063 </span>            : 
<span class="lineNum">    4064 </span>            :   // If we have cached lots of user defined event names, clear some of them.
<span class="lineNum">    4065 </span><span class="lineNoCov">          0 :   if (sUserDefinedEvents-&gt;Count() &gt; 127) {</span>
<span class="lineNum">    4066 </span><span class="lineNoCov">          0 :     while (sUserDefinedEvents-&gt;Count() &gt; 64) {</span>
<span class="lineNum">    4067 </span><span class="lineNoCov">          0 :       nsIAtom* first = sUserDefinedEvents-&gt;ObjectAt(0);</span>
<span class="lineNum">    4068 </span><span class="lineNoCov">          0 :       sStringEventTable-&gt;Remove(Substring(nsDependentAtomString(first), 2));</span>
<span class="lineNum">    4069 </span><span class="lineNoCov">          0 :       sUserDefinedEvents-&gt;RemoveObjectAt(0);</span>
<span class="lineNum">    4070 </span>            :     }
<span class="lineNum">    4071 </span>            :   }
<span class="lineNum">    4072 </span>            : 
<span class="lineNum">    4073 </span><span class="lineNoCov">          0 :   *aEventMessage = eUnidentifiedEvent;</span>
<span class="lineNum">    4074 </span>            :   nsCOMPtr&lt;nsIAtom&gt; atom =
<span class="lineNum">    4075 </span><span class="lineNoCov">          0 :     NS_AtomizeMainThread(NS_LITERAL_STRING(&quot;on&quot;) + aName);</span>
<span class="lineNum">    4076 </span><span class="lineNoCov">          0 :   sUserDefinedEvents-&gt;AppendObject(atom);</span>
<span class="lineNum">    4077 </span><span class="lineNoCov">          0 :   mapping.mAtom = atom;</span>
<span class="lineNum">    4078 </span><span class="lineNoCov">          0 :   mapping.mMessage = eUnidentifiedEvent;</span>
<span class="lineNum">    4079 </span><span class="lineNoCov">          0 :   mapping.mType = EventNameType_None;</span>
<span class="lineNum">    4080 </span><span class="lineNoCov">          0 :   mapping.mEventClassID = eBasicEventClass;</span>
<span class="lineNum">    4081 </span>            :   // This is a slow hashtable call, but at least we cache the result for the
<span class="lineNum">    4082 </span>            :   // following calls. Because GetEventMessageAndAtomForListener utilizes
<span class="lineNum">    4083 </span>            :   // sStringEventTable, it needs to know in which cases sStringEventTable
<span class="lineNum">    4084 </span>            :   // doesn't contain the information it needs so that it can use
<span class="lineNum">    4085 </span>            :   // sAtomEventTable instead.
<span class="lineNum">    4086 </span>            :   mapping.mMaybeSpecialSVGorSMILEvent =
<span class="lineNum">    4087 </span><span class="lineNoCov">          0 :     GetEventMessage(atom) != eUnidentifiedEvent;</span>
<span class="lineNum">    4088 </span><span class="lineNoCov">          0 :   sStringEventTable-&gt;Put(aName, mapping);</span>
<span class="lineNum">    4089 </span><span class="lineNoCov">          0 :   return mapping.mAtom;</span>
<span class="lineNum">    4090 </span>            : }
<span class="lineNum">    4091 </span>            : 
<span class="lineNum">    4092 </span>            : // static
<span class="lineNum">    4093 </span>            : EventMessage
<span class="lineNum">    4094 </span><span class="lineNoCov">          0 : nsContentUtils::GetEventMessageAndAtomForListener(const nsAString&amp; aName,</span>
<span class="lineNum">    4095 </span>            :                                                   nsIAtom** aOnName)
<span class="lineNum">    4096 </span>            : {
<span class="lineNum">    4097 </span>            :   // Because of SVG/SMIL sStringEventTable contains a subset of the event names
<span class="lineNum">    4098 </span>            :   // comparing to the sAtomEventTable. However, usually sStringEventTable
<span class="lineNum">    4099 </span>            :   // contains the information we need, so in order to reduce hashtable
<span class="lineNum">    4100 </span>            :   // lookups, start from it.
<span class="lineNum">    4101 </span>            :   EventNameMapping mapping;
<span class="lineNum">    4102 </span><span class="lineNoCov">          0 :   EventMessage msg = eUnidentifiedEvent;</span>
<span class="lineNum">    4103 </span>            :   nsCOMPtr&lt;nsIAtom&gt; atom;
<span class="lineNum">    4104 </span><span class="lineNoCov">          0 :   if (sStringEventTable-&gt;Get(aName, &amp;mapping)) {</span>
<span class="lineNum">    4105 </span><span class="lineNoCov">          0 :     if (mapping.mMaybeSpecialSVGorSMILEvent) {</span>
<span class="lineNum">    4106 </span>            :       // Try the atom version so that we should get the right message for
<span class="lineNum">    4107 </span>            :       // SVG/SMIL.
<span class="lineNum">    4108 </span><span class="lineNoCov">          0 :       atom = NS_AtomizeMainThread(NS_LITERAL_STRING(&quot;on&quot;) + aName);</span>
<span class="lineNum">    4109 </span><span class="lineNoCov">          0 :       msg = GetEventMessage(atom);</span>
<span class="lineNum">    4110 </span>            :     } else {
<span class="lineNum">    4111 </span><span class="lineNoCov">          0 :       atom = mapping.mAtom;</span>
<span class="lineNum">    4112 </span><span class="lineNoCov">          0 :       msg = mapping.mMessage;</span>
<span class="lineNum">    4113 </span>            :     }
<span class="lineNum">    4114 </span>            :     atom.forget(aOnName);
<span class="lineNum">    4115 </span><span class="lineNoCov">          0 :     return msg;</span>
<span class="lineNum">    4116 </span>            :   }
<span class="lineNum">    4117 </span>            : 
<span class="lineNum">    4118 </span>            :   // GetEventMessageAndAtom will cache the event type for the future usage...
<span class="lineNum">    4119 </span><span class="lineNoCov">          0 :   GetEventMessageAndAtom(aName, eBasicEventClass, &amp;msg);</span>
<span class="lineNum">    4120 </span>            : 
<span class="lineNum">    4121 </span>            :   // ...and then call this method recursively to get the message and atom from
<span class="lineNum">    4122 </span>            :   // now updated sStringEventTable.
<span class="lineNum">    4123 </span><span class="lineNoCov">          0 :   return GetEventMessageAndAtomForListener(aName, aOnName);</span>
<span class="lineNum">    4124 </span>            : }
<span class="lineNum">    4125 </span>            : 
<span class="lineNum">    4126 </span>            : static
<span class="lineNum">    4127 </span><span class="lineNoCov">          0 : nsresult GetEventAndTarget(nsIDocument* aDoc, nsISupports* aTarget,</span>
<span class="lineNum">    4128 </span>            :                            const nsAString&amp; aEventName,
<span class="lineNum">    4129 </span>            :                            bool aCanBubble, bool aCancelable,
<span class="lineNum">    4130 </span>            :                            bool aTrusted, nsIDOMEvent** aEvent,
<span class="lineNum">    4131 </span>            :                            EventTarget** aTargetOut)
<span class="lineNum">    4132 </span>            : {
<span class="lineNum">    4133 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDOMDocument&gt; domDoc = do_QueryInterface(aDoc);</span>
<span class="lineNum">    4134 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;EventTarget&gt; target(do_QueryInterface(aTarget));</span>
<span class="lineNum">    4135 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(domDoc &amp;&amp; target, NS_ERROR_INVALID_ARG);</span>
<span class="lineNum">    4136 </span>            : 
<span class="lineNum">    4137 </span>            :   nsCOMPtr&lt;nsIDOMEvent&gt; event;
<span class="lineNum">    4138 </span>            :   nsresult rv =
<span class="lineNum">    4139 </span><span class="lineNoCov">          0 :     domDoc-&gt;CreateEvent(NS_LITERAL_STRING(&quot;Events&quot;), getter_AddRefs(event));</span>
<span class="lineNum">    4140 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4141 </span>            : 
<span class="lineNum">    4142 </span><span class="lineNoCov">          0 :   event-&gt;InitEvent(aEventName, aCanBubble, aCancelable);</span>
<span class="lineNum">    4143 </span><span class="lineNoCov">          0 :   event-&gt;SetTrusted(aTrusted);</span>
<span class="lineNum">    4144 </span>            : 
<span class="lineNum">    4145 </span><span class="lineNoCov">          0 :   rv = event-&gt;SetTarget(target);</span>
<span class="lineNum">    4146 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4147 </span>            : 
<span class="lineNum">    4148 </span>            :   event.forget(aEvent);
<span class="lineNum">    4149 </span>            :   target.forget(aTargetOut);
<span class="lineNum">    4150 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    4151 </span>            : }
<span class="lineNum">    4152 </span>            : 
<a name="4153"><span class="lineNum">    4153 </span>            : // static</a>
<span class="lineNum">    4154 </span>            : nsresult
<span class="lineNum">    4155 </span><span class="lineNoCov">          0 : nsContentUtils::DispatchTrustedEvent(nsIDocument* aDoc, nsISupports* aTarget,</span>
<span class="lineNum">    4156 </span>            :                                      const nsAString&amp; aEventName,
<span class="lineNum">    4157 </span>            :                                      bool aCanBubble, bool aCancelable,
<span class="lineNum">    4158 </span>            :                                      bool *aDefaultAction)
<span class="lineNum">    4159 </span>            : {
<span class="lineNum">    4160 </span>            :   return DispatchEvent(aDoc, aTarget, aEventName, aCanBubble, aCancelable,
<span class="lineNum">    4161 </span><span class="lineNoCov">          0 :                        true, aDefaultAction);</span>
<span class="lineNum">    4162 </span>            : }
<span class="lineNum">    4163 </span>            : 
<a name="4164"><span class="lineNum">    4164 </span>            : // static</a>
<span class="lineNum">    4165 </span>            : nsresult
<span class="lineNum">    4166 </span><span class="lineNoCov">          0 : nsContentUtils::DispatchUntrustedEvent(nsIDocument* aDoc, nsISupports* aTarget,</span>
<span class="lineNum">    4167 </span>            :                                        const nsAString&amp; aEventName,
<span class="lineNum">    4168 </span>            :                                        bool aCanBubble, bool aCancelable,
<span class="lineNum">    4169 </span>            :                                        bool *aDefaultAction)
<span class="lineNum">    4170 </span>            : {
<span class="lineNum">    4171 </span>            :   return DispatchEvent(aDoc, aTarget, aEventName, aCanBubble, aCancelable,
<span class="lineNum">    4172 </span><span class="lineNoCov">          0 :                        false, aDefaultAction);</span>
<span class="lineNum">    4173 </span>            : }
<span class="lineNum">    4174 </span>            : 
<span class="lineNum">    4175 </span>            : // static
<span class="lineNum">    4176 </span>            : nsresult
<span class="lineNum">    4177 </span><span class="lineNoCov">          0 : nsContentUtils::DispatchEvent(nsIDocument* aDoc, nsISupports* aTarget,</span>
<span class="lineNum">    4178 </span>            :                               const nsAString&amp; aEventName,
<span class="lineNum">    4179 </span>            :                               bool aCanBubble, bool aCancelable,
<span class="lineNum">    4180 </span>            :                               bool aTrusted, bool *aDefaultAction,
<span class="lineNum">    4181 </span>            :                               bool aOnlyChromeDispatch)
<span class="lineNum">    4182 </span>            : {
<span class="lineNum">    4183 </span>            :   nsCOMPtr&lt;nsIDOMEvent&gt; event;
<span class="lineNum">    4184 </span>            :   nsCOMPtr&lt;EventTarget&gt; target;
<span class="lineNum">    4185 </span>            :   nsresult rv = GetEventAndTarget(aDoc, aTarget, aEventName, aCanBubble,
<span class="lineNum">    4186 </span>            :                                   aCancelable, aTrusted, getter_AddRefs(event),
<span class="lineNum">    4187 </span><span class="lineNoCov">          0 :                                   getter_AddRefs(target));</span>
<span class="lineNum">    4188 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4189 </span><span class="lineNoCov">          0 :   event-&gt;WidgetEventPtr()-&gt;mFlags.mOnlyChromeDispatch = aOnlyChromeDispatch;</span>
<span class="lineNum">    4190 </span>            : 
<span class="lineNum">    4191 </span>            :   bool dummy;
<span class="lineNum">    4192 </span><span class="lineNoCov">          0 :   return target-&gt;DispatchEvent(event, aDefaultAction ? aDefaultAction : &amp;dummy);</span>
<span class="lineNum">    4193 </span>            : }
<span class="lineNum">    4194 </span>            : 
<span class="lineNum">    4195 </span>            : nsresult
<span class="lineNum">    4196 </span><span class="lineNoCov">          0 : nsContentUtils::DispatchChromeEvent(nsIDocument *aDoc,</span>
<span class="lineNum">    4197 </span>            :                                     nsISupports *aTarget,
<span class="lineNum">    4198 </span>            :                                     const nsAString&amp; aEventName,
<span class="lineNum">    4199 </span>            :                                     bool aCanBubble, bool aCancelable,
<span class="lineNum">    4200 </span>            :                                     bool *aDefaultAction)
<span class="lineNum">    4201 </span>            : {
<span class="lineNum">    4202 </span>            : 
<span class="lineNum">    4203 </span>            :   nsCOMPtr&lt;nsIDOMEvent&gt; event;
<span class="lineNum">    4204 </span>            :   nsCOMPtr&lt;EventTarget&gt; target;
<span class="lineNum">    4205 </span>            :   nsresult rv = GetEventAndTarget(aDoc, aTarget, aEventName, aCanBubble,
<span class="lineNum">    4206 </span>            :                                   aCancelable, true, getter_AddRefs(event),
<span class="lineNum">    4207 </span><span class="lineNoCov">          0 :                                   getter_AddRefs(target));</span>
<span class="lineNum">    4208 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4209 </span>            : 
<span class="lineNum">    4210 </span>            :   NS_ASSERTION(aDoc, &quot;GetEventAndTarget lied?&quot;);
<span class="lineNum">    4211 </span><span class="lineNoCov">          0 :   if (!aDoc-&gt;GetWindow())</span>
<span class="lineNum">    4212 </span>            :     return NS_ERROR_INVALID_ARG;
<span class="lineNum">    4213 </span>            : 
<span class="lineNum">    4214 </span><span class="lineNoCov">          0 :   EventTarget* piTarget = aDoc-&gt;GetWindow()-&gt;GetParentTarget();</span>
<span class="lineNum">    4215 </span><span class="lineNoCov">          0 :   if (!piTarget)</span>
<span class="lineNum">    4216 </span>            :     return NS_ERROR_INVALID_ARG;
<span class="lineNum">    4217 </span>            : 
<span class="lineNum">    4218 </span><span class="lineNoCov">          0 :   nsEventStatus status = nsEventStatus_eIgnore;</span>
<span class="lineNum">    4219 </span><span class="lineNoCov">          0 :   rv = piTarget-&gt;DispatchDOMEvent(nullptr, event, nullptr, &amp;status);</span>
<span class="lineNum">    4220 </span><span class="lineNoCov">          0 :   if (aDefaultAction) {</span>
<span class="lineNum">    4221 </span><span class="lineNoCov">          0 :     *aDefaultAction = (status != nsEventStatus_eConsumeNoDefault);</span>
<span class="lineNum">    4222 </span>            :   }
<span class="lineNum">    4223 </span><span class="lineNoCov">          0 :   return rv;</span>
<span class="lineNum">    4224 </span>            : }
<span class="lineNum">    4225 </span>            : 
<span class="lineNum">    4226 </span>            : /* static */
<span class="lineNum">    4227 </span>            : nsresult
<span class="lineNum">    4228 </span><span class="lineNoCov">          0 : nsContentUtils::DispatchFocusChromeEvent(nsPIDOMWindowOuter* aWindow)</span>
<span class="lineNum">    4229 </span>            : {
<span class="lineNum">    4230 </span>            :   MOZ_ASSERT(aWindow);
<span class="lineNum">    4231 </span>            : 
<span class="lineNum">    4232 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocument&gt; doc = aWindow-&gt;GetExtantDoc();</span>
<span class="lineNum">    4233 </span><span class="lineNoCov">          0 :   if (!doc) {</span>
<span class="lineNum">    4234 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">    4235 </span>            :   }
<span class="lineNum">    4236 </span>            : 
<span class="lineNum">    4237 </span>            :   return DispatchChromeEvent(doc, aWindow,
<span class="lineNum">    4238 </span>            :                              NS_LITERAL_STRING(&quot;DOMWindowFocus&quot;),
<span class="lineNum">    4239 </span><span class="lineNoCov">          0 :                              true, true);</span>
<span class="lineNum">    4240 </span>            : }
<a name="4241"><span class="lineNum">    4241 </span>            : </a>
<span class="lineNum">    4242 </span>            : nsresult
<span class="lineNum">    4243 </span><span class="lineNoCov">          0 : nsContentUtils::DispatchEventOnlyToChrome(nsIDocument* aDoc,</span>
<span class="lineNum">    4244 </span>            :                                           nsISupports* aTarget,
<span class="lineNum">    4245 </span>            :                                           const nsAString&amp; aEventName,
<span class="lineNum">    4246 </span>            :                                           bool aCanBubble, bool aCancelable,
<span class="lineNum">    4247 </span>            :                                           bool* aDefaultAction)
<span class="lineNum">    4248 </span>            : {
<span class="lineNum">    4249 </span>            :   return DispatchEvent(aDoc, aTarget, aEventName, aCanBubble, aCancelable,
<span class="lineNum">    4250 </span><span class="lineNoCov">          0 :                        true, aDefaultAction, true);</span>
<span class="lineNum">    4251 </span>            : }
<span class="lineNum">    4252 </span>            : 
<a name="4253"><span class="lineNum">    4253 </span>            : /* static */</a>
<span class="lineNum">    4254 </span>            : Element*
<span class="lineNum">    4255 </span><span class="lineNoCov">          0 : nsContentUtils::MatchElementId(nsIContent *aContent, const nsIAtom* aId)</span>
<span class="lineNum">    4256 </span>            : {
<span class="lineNum">    4257 </span><span class="lineNoCov">          0 :   for (nsIContent* cur = aContent;</span>
<span class="lineNum">    4258 </span>            :        cur;
<span class="lineNum">    4259 </span><span class="lineNoCov">          0 :        cur = cur-&gt;GetNextNode(aContent)) {</span>
<span class="lineNum">    4260 </span><span class="lineNoCov">          0 :     if (aId == cur-&gt;GetID()) {</span>
<span class="lineNum">    4261 </span><span class="lineNoCov">          0 :       return cur-&gt;AsElement();</span>
<span class="lineNum">    4262 </span>            :     }
<span class="lineNum">    4263 </span>            :   }
<span class="lineNum">    4264 </span>            : 
<span class="lineNum">    4265 </span>            :   return nullptr;
<span class="lineNum">    4266 </span>            : }
<span class="lineNum">    4267 </span>            : 
<span class="lineNum">    4268 </span>            : /* static */
<span class="lineNum">    4269 </span>            : Element *
<span class="lineNum">    4270 </span><span class="lineNoCov">          0 : nsContentUtils::MatchElementId(nsIContent *aContent, const nsAString&amp; aId)</span>
<span class="lineNum">    4271 </span>            : {
<span class="lineNum">    4272 </span>            :   NS_PRECONDITION(!aId.IsEmpty(), &quot;Will match random elements&quot;);
<span class="lineNum">    4273 </span>            : 
<span class="lineNum">    4274 </span>            :   // ID attrs are generally stored as atoms, so just atomize this up front
<span class="lineNum">    4275 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIAtom&gt; id(NS_Atomize(aId));</span>
<span class="lineNum">    4276 </span><span class="lineNoCov">          0 :   if (!id) {</span>
<span class="lineNum">    4277 </span>            :     // OOM, so just bail
<span class="lineNum">    4278 </span>            :     return nullptr;
<span class="lineNum">    4279 </span>            :   }
<span class="lineNum">    4280 </span>            : 
<span class="lineNum">    4281 </span><span class="lineNoCov">          0 :   return MatchElementId(aContent, id);</span>
<span class="lineNum">    4282 </span>            : }
<span class="lineNum">    4283 </span>            : 
<span class="lineNum">    4284 </span>            : /* static */
<span class="lineNum">    4285 </span>            : nsIDocument*
<span class="lineNum">    4286 </span><span class="lineNoCov">          0 : nsContentUtils::GetSubdocumentWithOuterWindowId(nsIDocument *aDocument,</span>
<span class="lineNum">    4287 </span>            :                                                 uint64_t aOuterWindowId)
<span class="lineNum">    4288 </span>            : {
<span class="lineNum">    4289 </span><span class="lineNoCov">          0 :   if (!aDocument || !aOuterWindowId) {</span>
<span class="lineNum">    4290 </span>            :     return nullptr;
<span class="lineNum">    4291 </span>            :   }
<span class="lineNum">    4292 </span>            : 
<span class="lineNum">    4293 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsGlobalWindow::GetOuterWindowWithId(aOuterWindowId)-&gt;AsOuter();</span>
<span class="lineNum">    4294 </span><span class="lineNoCov">          0 :   if (!window) {</span>
<span class="lineNum">    4295 </span>            :     return nullptr;
<span class="lineNum">    4296 </span>            :   }
<span class="lineNum">    4297 </span>            : 
<span class="lineNum">    4298 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocument&gt; foundDoc = window-&gt;GetDoc();</span>
<span class="lineNum">    4299 </span><span class="lineNoCov">          0 :   if (nsContentUtils::ContentIsCrossDocDescendantOf(foundDoc, aDocument)) {</span>
<span class="lineNum">    4300 </span>            :     // Note that ContentIsCrossDocDescendantOf will return true if
<span class="lineNum">    4301 </span>            :     // foundDoc == aDocument.
<span class="lineNum">    4302 </span><span class="lineNoCov">          0 :     return foundDoc;</span>
<span class="lineNum">    4303 </span>            :   }
<span class="lineNum">    4304 </span>            : 
<span class="lineNum">    4305 </span>            :   return nullptr;
<span class="lineNum">    4306 </span>            : }
<span class="lineNum">    4307 </span>            : 
<span class="lineNum">    4308 </span>            : // Convert the string from the given encoding to Unicode.
<a name="4309"><span class="lineNum">    4309 </span>            : /* static */</a>
<span class="lineNum">    4310 </span>            : nsresult
<span class="lineNum">    4311 </span><span class="lineNoCov">          0 : nsContentUtils::ConvertStringFromEncoding(const nsACString&amp; aEncoding,</span>
<span class="lineNum">    4312 </span>            :                                           const nsACString&amp; aInput,
<span class="lineNum">    4313 </span>            :                                           nsAString&amp; aOutput)
<span class="lineNum">    4314 </span>            : {
<span class="lineNum">    4315 </span><span class="lineNoCov">          0 :   nsAutoCString encoding;</span>
<span class="lineNum">    4316 </span><span class="lineNoCov">          0 :   if (aEncoding.IsEmpty()) {</span>
<span class="lineNum">    4317 </span><span class="lineNoCov">          0 :     encoding.AssignLiteral(&quot;UTF-8&quot;);</span>
<span class="lineNum">    4318 </span>            :   } else {
<span class="lineNum">    4319 </span><span class="lineNoCov">          0 :     encoding.Assign(aEncoding);</span>
<span class="lineNum">    4320 </span>            :   }
<span class="lineNum">    4321 </span>            : 
<span class="lineNum">    4322 </span>            :   ErrorResult rv;
<span class="lineNum">    4323 </span><span class="lineNoCov">          0 :   nsAutoPtr&lt;TextDecoder&gt; decoder(new TextDecoder());</span>
<span class="lineNum">    4324 </span><span class="lineNoCov">          0 :   decoder-&gt;InitWithEncoding(encoding, false);</span>
<span class="lineNum">    4325 </span>            : 
<span class="lineNum">    4326 </span><span class="lineNoCov">          0 :   decoder-&gt;Decode(aInput.BeginReading(), aInput.Length(), false,</span>
<span class="lineNum">    4327 </span><span class="lineNoCov">          0 :                   aOutput, rv);</span>
<span class="lineNum">    4328 </span><span class="lineNoCov">          0 :   return rv.StealNSResult();</span>
<span class="lineNum">    4329 </span>            : }
<span class="lineNum">    4330 </span>            : 
<a name="4331"><span class="lineNum">    4331 </span>            : /* static */</a>
<span class="lineNum">    4332 </span>            : bool
<span class="lineNum">    4333 </span><span class="lineCov">         36 : nsContentUtils::CheckForBOM(const unsigned char* aBuffer, uint32_t aLength,</span>
<span class="lineNum">    4334 </span>            :                             nsACString&amp; aCharset)
<span class="lineNum">    4335 </span>            : {
<span class="lineNum">    4336 </span><span class="lineCov">         36 :   bool found = true;</span>
<span class="lineNum">    4337 </span>            :   aCharset.Truncate();
<span class="lineNum">    4338 </span><span class="lineCov">         72 :   if (aLength &gt;= 3 &amp;&amp;</span>
<span class="lineNum">    4339 </span><span class="lineCov">         36 :       aBuffer[0] == 0xEF &amp;&amp;</span>
<span class="lineNum">    4340 </span><span class="lineNoCov">          0 :       aBuffer[1] == 0xBB &amp;&amp;</span>
<span class="lineNum">    4341 </span><span class="lineNoCov">          0 :       aBuffer[2] == 0xBF) {</span>
<span class="lineNum">    4342 </span>            :     aCharset = &quot;UTF-8&quot;;
<span class="lineNum">    4343 </span>            :   }
<span class="lineNum">    4344 </span><span class="lineCov">         72 :   else if (aLength &gt;= 2 &amp;&amp;</span>
<span class="lineNum">    4345 </span><span class="lineCov">         36 :            aBuffer[0] == 0xFE &amp;&amp; aBuffer[1] == 0xFF) {</span>
<span class="lineNum">    4346 </span>            :     aCharset = &quot;UTF-16BE&quot;;
<span class="lineNum">    4347 </span>            :   }
<span class="lineNum">    4348 </span><span class="lineCov">         72 :   else if (aLength &gt;= 2 &amp;&amp;</span>
<span class="lineNum">    4349 </span><span class="lineCov">         36 :            aBuffer[0] == 0xFF &amp;&amp; aBuffer[1] == 0xFE) {</span>
<span class="lineNum">    4350 </span>            :     aCharset = &quot;UTF-16LE&quot;;
<span class="lineNum">    4351 </span>            :   } else {
<span class="lineNum">    4352 </span>            :     found = false;
<span class="lineNum">    4353 </span>            :   }
<span class="lineNum">    4354 </span>            : 
<span class="lineNum">    4355 </span><span class="lineCov">         36 :   return found;</span>
<span class="lineNum">    4356 </span>            : }
<span class="lineNum">    4357 </span>            : 
<span class="lineNum">    4358 </span>            : /* static */
<span class="lineNum">    4359 </span>            : void
<span class="lineNum">    4360 </span><span class="lineCov">         65 : nsContentUtils::RegisterShutdownObserver(nsIObserver* aObserver)</span>
<span class="lineNum">    4361 </span>            : {
<span class="lineNum">    4362 </span>            :   nsCOMPtr&lt;nsIObserverService&gt; observerService =
<span class="lineNum">    4363 </span><span class="lineCov">        130 :     mozilla::services::GetObserverService();</span>
<span class="lineNum">    4364 </span><span class="lineCov">         65 :   if (observerService) {</span>
<span class="lineNum">    4365 </span>            :     observerService-&gt;AddObserver(aObserver,
<span class="lineNum">    4366 </span>            :                                  NS_XPCOM_SHUTDOWN_OBSERVER_ID,
<span class="lineNum">    4367 </span><span class="lineCov">         65 :                                  false);</span>
<span class="lineNum">    4368 </span>            :   }
<span class="lineNum">    4369 </span><span class="lineCov">         65 : }</span>
<span class="lineNum">    4370 </span>            : 
<span class="lineNum">    4371 </span>            : /* static */
<span class="lineNum">    4372 </span>            : void
<span class="lineNum">    4373 </span><span class="lineCov">        125 : nsContentUtils::UnregisterShutdownObserver(nsIObserver* aObserver)</span>
<span class="lineNum">    4374 </span>            : {
<span class="lineNum">    4375 </span>            :   nsCOMPtr&lt;nsIObserverService&gt; observerService =
<span class="lineNum">    4376 </span><span class="lineCov">        250 :     mozilla::services::GetObserverService();</span>
<span class="lineNum">    4377 </span><span class="lineCov">        125 :   if (observerService) {</span>
<span class="lineNum">    4378 </span><span class="lineCov">         65 :     observerService-&gt;RemoveObserver(aObserver, NS_XPCOM_SHUTDOWN_OBSERVER_ID);</span>
<span class="lineNum">    4379 </span>            :   }
<span class="lineNum">    4380 </span><span class="lineCov">        125 : }</span>
<span class="lineNum">    4381 </span>            : 
<a name="4382"><span class="lineNum">    4382 </span>            : /* static */</a>
<span class="lineNum">    4383 </span>            : bool
<span class="lineNum">    4384 </span><span class="lineNoCov">          0 : nsContentUtils::HasNonEmptyAttr(const nsIContent* aContent, int32_t aNameSpaceID,</span>
<span class="lineNum">    4385 </span>            :                                 nsIAtom* aName)
<span class="lineNum">    4386 </span>            : {
<span class="lineNum">    4387 </span>            :   static nsIContent::AttrValuesArray strings[] = {&amp;nsGkAtoms::_empty, nullptr};
<span class="lineNum">    4388 </span><span class="lineNoCov">          0 :   return aContent-&gt;FindAttrValueIn(aNameSpaceID, aName, strings, eCaseMatters)</span>
<span class="lineNum">    4389 </span><span class="lineNoCov">          0 :     == nsIContent::ATTR_VALUE_NO_MATCH;</span>
<span class="lineNum">    4390 </span>            : }
<span class="lineNum">    4391 </span>            : 
<span class="lineNum">    4392 </span>            : /* static */
<span class="lineNum">    4393 </span>            : bool
<span class="lineNum">    4394 </span><span class="lineNoCov">          0 : nsContentUtils::HasMutationListeners(nsINode* aNode,</span>
<span class="lineNum">    4395 </span>            :                                      uint32_t aType,
<span class="lineNum">    4396 </span>            :                                      nsINode* aTargetForSubtreeModified)
<span class="lineNum">    4397 </span>            : {
<span class="lineNum">    4398 </span><span class="lineNoCov">          0 :   nsIDocument* doc = aNode-&gt;OwnerDoc();</span>
<span class="lineNum">    4399 </span>            : 
<span class="lineNum">    4400 </span>            :   // global object will be null for documents that don't have windows.
<span class="lineNum">    4401 </span><span class="lineNoCov">          0 :   nsPIDOMWindowInner* window = doc-&gt;GetInnerWindow();</span>
<span class="lineNum">    4402 </span>            :   // This relies on EventListenerManager::AddEventListener, which sets
<span class="lineNum">    4403 </span>            :   // all mutation bits when there is a listener for DOMSubtreeModified event.
<span class="lineNum">    4404 </span><span class="lineNoCov">          0 :   if (window &amp;&amp; !window-&gt;HasMutationListeners(aType)) {</span>
<span class="lineNum">    4405 </span>            :     return false;
<span class="lineNum">    4406 </span>            :   }
<span class="lineNum">    4407 </span>            : 
<span class="lineNum">    4408 </span><span class="lineNoCov">          0 :   if (aNode-&gt;IsNodeOfType(nsINode::eCONTENT) &amp;&amp;</span>
<span class="lineNum">    4409 </span><span class="lineNoCov">          0 :       static_cast&lt;nsIContent*&gt;(aNode)-&gt;ChromeOnlyAccess()) {</span>
<span class="lineNum">    4410 </span>            :     return false;
<span class="lineNum">    4411 </span>            :   }
<span class="lineNum">    4412 </span>            : 
<span class="lineNum">    4413 </span><span class="lineNoCov">          0 :   doc-&gt;MayDispatchMutationEvent(aTargetForSubtreeModified);</span>
<span class="lineNum">    4414 </span>            : 
<span class="lineNum">    4415 </span>            :   // If we have a window, we can check it for mutation listeners now.
<span class="lineNum">    4416 </span><span class="lineNoCov">          0 :   if (aNode-&gt;IsInUncomposedDoc()) {</span>
<span class="lineNum">    4417 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;EventTarget&gt; piTarget(do_QueryInterface(window));</span>
<span class="lineNum">    4418 </span><span class="lineNoCov">          0 :     if (piTarget) {</span>
<span class="lineNum">    4419 </span><span class="lineNoCov">          0 :       EventListenerManager* manager = piTarget-&gt;GetExistingListenerManager();</span>
<span class="lineNum">    4420 </span><span class="lineNoCov">          0 :       if (manager &amp;&amp; manager-&gt;HasMutationListeners()) {</span>
<span class="lineNum">    4421 </span><span class="lineNoCov">          0 :         return true;</span>
<span class="lineNum">    4422 </span>            :       }
<span class="lineNum">    4423 </span>            :     }
<span class="lineNum">    4424 </span>            :   }
<span class="lineNum">    4425 </span>            : 
<span class="lineNum">    4426 </span>            :   // If we have a window, we know a mutation listener is registered, but it
<span class="lineNum">    4427 </span>            :   // might not be in our chain.  If we don't have a window, we might have a
<span class="lineNum">    4428 </span>            :   // mutation listener.  Check quickly to see.
<span class="lineNum">    4429 </span><span class="lineNoCov">          0 :   while (aNode) {</span>
<span class="lineNum">    4430 </span><span class="lineNoCov">          0 :     EventListenerManager* manager = aNode-&gt;GetExistingListenerManager();</span>
<span class="lineNum">    4431 </span><span class="lineNoCov">          0 :     if (manager &amp;&amp; manager-&gt;HasMutationListeners()) {</span>
<span class="lineNum">    4432 </span>            :       return true;
<span class="lineNum">    4433 </span>            :     }
<span class="lineNum">    4434 </span>            : 
<span class="lineNum">    4435 </span><span class="lineNoCov">          0 :     if (aNode-&gt;IsNodeOfType(nsINode::eCONTENT)) {</span>
<span class="lineNum">    4436 </span><span class="lineNoCov">          0 :       nsIContent* content = static_cast&lt;nsIContent*&gt;(aNode);</span>
<span class="lineNum">    4437 </span><span class="lineNoCov">          0 :       nsIContent* insertionParent = content-&gt;GetXBLInsertionParent();</span>
<span class="lineNum">    4438 </span><span class="lineNoCov">          0 :       if (insertionParent) {</span>
<span class="lineNum">    4439 </span>            :         aNode = insertionParent;
<span class="lineNum">    4440 </span>            :         continue;
<span class="lineNum">    4441 </span>            :       }
<span class="lineNum">    4442 </span>            :     }
<span class="lineNum">    4443 </span><span class="lineNoCov">          0 :     aNode = aNode-&gt;GetParentNode();</span>
<span class="lineNum">    4444 </span>            :   }
<span class="lineNum">    4445 </span>            : 
<span class="lineNum">    4446 </span>            :   return false;
<span class="lineNum">    4447 </span>            : }
<span class="lineNum">    4448 </span>            : 
<a name="4449"><span class="lineNum">    4449 </span>            : /* static */</a>
<span class="lineNum">    4450 </span>            : bool
<span class="lineNum">    4451 </span><span class="lineNoCov">          0 : nsContentUtils::HasMutationListeners(nsIDocument* aDocument,</span>
<span class="lineNum">    4452 </span>            :                                      uint32_t aType)
<span class="lineNum">    4453 </span>            : {
<span class="lineNum">    4454 </span>            :   nsPIDOMWindowInner* window = aDocument ?
<span class="lineNum">    4455 </span><span class="lineNoCov">          0 :     aDocument-&gt;GetInnerWindow() : nullptr;</span>
<span class="lineNum">    4456 </span>            : 
<span class="lineNum">    4457 </span>            :   // This relies on EventListenerManager::AddEventListener, which sets
<span class="lineNum">    4458 </span>            :   // all mutation bits when there is a listener for DOMSubtreeModified event.
<span class="lineNum">    4459 </span><span class="lineNoCov">          0 :   return !window || window-&gt;HasMutationListeners(aType);</span>
<span class="lineNum">    4460 </span>            : }
<a name="4461"><span class="lineNum">    4461 </span>            : </a>
<span class="lineNum">    4462 </span>            : void
<span class="lineNum">    4463 </span><span class="lineNoCov">          0 : nsContentUtils::MaybeFireNodeRemoved(nsINode* aChild, nsINode* aParent,</span>
<span class="lineNum">    4464 </span>            :                                      nsIDocument* aOwnerDoc)
<span class="lineNum">    4465 </span>            : {
<span class="lineNum">    4466 </span>            :   NS_PRECONDITION(aChild, &quot;Missing child&quot;);
<span class="lineNum">    4467 </span>            :   NS_PRECONDITION(aChild-&gt;GetParentNode() == aParent, &quot;Wrong parent&quot;);
<span class="lineNum">    4468 </span>            :   NS_PRECONDITION(aChild-&gt;OwnerDoc() == aOwnerDoc, &quot;Wrong owner-doc&quot;);
<span class="lineNum">    4469 </span>            : 
<span class="lineNum">    4470 </span>            :   // Having an explicit check here since it's an easy mistake to fall into,
<span class="lineNum">    4471 </span>            :   // and there might be existing code with problems. We'd rather be safe
<span class="lineNum">    4472 </span>            :   // than fire DOMNodeRemoved in all corner cases. We also rely on it for
<span class="lineNum">    4473 </span>            :   // nsAutoScriptBlockerSuppressNodeRemoved.
<span class="lineNum">    4474 </span><span class="lineNoCov">          0 :   if (!IsSafeToRunScript()) {</span>
<span class="lineNum">    4475 </span>            :     // This checks that IsSafeToRunScript is true since we don't want to fire
<span class="lineNum">    4476 </span>            :     // events when that is false. We can't rely on EventDispatcher to assert
<span class="lineNum">    4477 </span>            :     // this in this situation since most of the time there are no mutation
<span class="lineNum">    4478 </span>            :     // event listeners, in which case we won't even attempt to dispatch events.
<span class="lineNum">    4479 </span>            :     // However this also allows for two exceptions. First off, we don't assert
<span class="lineNum">    4480 </span>            :     // if the mutation happens to native anonymous content since we never fire
<span class="lineNum">    4481 </span>            :     // mutation events on such content anyway.
<span class="lineNum">    4482 </span>            :     // Second, we don't assert if sDOMNodeRemovedSuppressCount is true since
<span class="lineNum">    4483 </span>            :     // that is a know case when we'd normally fire a mutation event, but can't
<span class="lineNum">    4484 </span>            :     // make that safe and so we suppress it at this time. Ideally this should
<span class="lineNum">    4485 </span>            :     // go away eventually.
<span class="lineNum">    4486 </span><span class="lineNoCov">          0 :     if (!(aChild-&gt;IsContent() &amp;&amp; aChild-&gt;AsContent()-&gt;IsInNativeAnonymousSubtree()) &amp;&amp;</span>
<span class="lineNum">    4487 </span><span class="lineNoCov">          0 :         !sDOMNodeRemovedSuppressCount) {</span>
<span class="lineNum">    4488 </span>            :       NS_ERROR(&quot;Want to fire DOMNodeRemoved event, but it's not safe&quot;);
<span class="lineNum">    4489 </span><span class="lineNoCov">          0 :       WarnScriptWasIgnored(aOwnerDoc);</span>
<span class="lineNum">    4490 </span>            :     }
<span class="lineNum">    4491 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    4492 </span>            :   }
<span class="lineNum">    4493 </span>            : 
<span class="lineNum">    4494 </span><span class="lineNoCov">          0 :   if (HasMutationListeners(aChild,</span>
<span class="lineNum">    4495 </span>            :         NS_EVENT_BITS_MUTATION_NODEREMOVED, aParent)) {
<span class="lineNum">    4496 </span><span class="lineNoCov">          0 :     InternalMutationEvent mutation(true, eLegacyNodeRemoved);</span>
<span class="lineNum">    4497 </span><span class="lineNoCov">          0 :     mutation.mRelatedNode = do_QueryInterface(aParent);</span>
<span class="lineNum">    4498 </span>            : 
<span class="lineNum">    4499 </span><span class="lineNoCov">          0 :     mozAutoSubtreeModified subtree(aOwnerDoc, aParent);</span>
<span class="lineNum">    4500 </span><span class="lineNoCov">          0 :     EventDispatcher::Dispatch(aChild, nullptr, &amp;mutation);</span>
<span class="lineNum">    4501 </span>            :   }
<span class="lineNum">    4502 </span>            : }
<a name="4503"><span class="lineNum">    4503 </span>            : </a>
<span class="lineNum">    4504 </span>            : void
<span class="lineNum">    4505 </span><span class="lineNoCov">          0 : nsContentUtils::UnmarkGrayJSListenersInCCGenerationDocuments()</span>
<span class="lineNum">    4506 </span>            : {
<span class="lineNum">    4507 </span><span class="lineNoCov">          0 :   if (!sEventListenerManagersHash) {</span>
<span class="lineNum">    4508 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    4509 </span>            :   }
<span class="lineNum">    4510 </span>            : 
<span class="lineNum">    4511 </span><span class="lineNoCov">          0 :   for (auto i = sEventListenerManagersHash-&gt;Iter(); !i.Done(); i.Next()) {</span>
<span class="lineNum">    4512 </span><span class="lineNoCov">          0 :     auto entry = static_cast&lt;EventListenerManagerMapEntry*&gt;(i.Get());</span>
<span class="lineNum">    4513 </span><span class="lineNoCov">          0 :     nsINode* n = static_cast&lt;nsINode*&gt;(entry-&gt;mListenerManager-&gt;GetTarget());</span>
<span class="lineNum">    4514 </span><span class="lineNoCov">          0 :     if (n &amp;&amp; n-&gt;IsInUncomposedDoc() &amp;&amp;</span>
<span class="lineNum">    4515 </span><span class="lineNoCov">          0 :         nsCCUncollectableMarker::InGeneration(n-&gt;OwnerDoc()-&gt;GetMarkedCCGeneration())) {</span>
<span class="lineNum">    4516 </span><span class="lineNoCov">          0 :       entry-&gt;mListenerManager-&gt;MarkForCC();</span>
<span class="lineNum">    4517 </span>            :     }
<span class="lineNum">    4518 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    4519 </span>            : }
<span class="lineNum">    4520 </span>            : 
<a name="4521"><span class="lineNum">    4521 </span>            : /* static */</a>
<span class="lineNum">    4522 </span>            : void
<span class="lineNum">    4523 </span><span class="lineNoCov">          0 : nsContentUtils::TraverseListenerManager(nsINode *aNode,</span>
<span class="lineNum">    4524 </span>            :                                         nsCycleCollectionTraversalCallback &amp;cb)
<span class="lineNum">    4525 </span>            : {
<span class="lineNum">    4526 </span><span class="lineNoCov">          0 :   if (!sEventListenerManagersHash) {</span>
<span class="lineNum">    4527 </span>            :     // We're already shut down, just return.
<span class="lineNum">    4528 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    4529 </span>            :   }
<span class="lineNum">    4530 </span>            : 
<span class="lineNum">    4531 </span>            :   auto entry = static_cast&lt;EventListenerManagerMapEntry*&gt;
<span class="lineNum">    4532 </span><span class="lineNoCov">          0 :                           (sEventListenerManagersHash-&gt;Search(aNode));</span>
<span class="lineNum">    4533 </span><span class="lineNoCov">          0 :   if (entry) {</span>
<span class="lineNum">    4534 </span>            :     CycleCollectionNoteChild(cb, entry-&gt;mListenerManager.get(),
<span class="lineNum">    4535 </span><span class="lineNoCov">          0 :                              &quot;[via hash] mListenerManager&quot;);</span>
<span class="lineNum">    4536 </span>            :   }
<span class="lineNum">    4537 </span>            : }
<a name="4538"><span class="lineNum">    4538 </span>            : </a>
<span class="lineNum">    4539 </span>            : EventListenerManager*
<span class="lineNum">    4540 </span><span class="lineNoCov">          0 : nsContentUtils::GetListenerManagerForNode(nsINode *aNode)</span>
<span class="lineNum">    4541 </span>            : {
<span class="lineNum">    4542 </span><span class="lineNoCov">          0 :   if (!sEventListenerManagersHash) {</span>
<span class="lineNum">    4543 </span>            :     // We're already shut down, don't bother creating an event listener
<span class="lineNum">    4544 </span>            :     // manager.
<span class="lineNum">    4545 </span>            : 
<span class="lineNum">    4546 </span>            :     return nullptr;
<span class="lineNum">    4547 </span>            :   }
<span class="lineNum">    4548 </span>            : 
<span class="lineNum">    4549 </span>            :   auto entry =
<span class="lineNum">    4550 </span>            :     static_cast&lt;EventListenerManagerMapEntry*&gt;
<span class="lineNum">    4551 </span><span class="lineNoCov">          0 :                (sEventListenerManagersHash-&gt;Add(aNode, fallible));</span>
<span class="lineNum">    4552 </span>            : 
<span class="lineNum">    4553 </span><span class="lineNoCov">          0 :   if (!entry) {</span>
<span class="lineNum">    4554 </span>            :     return nullptr;
<span class="lineNum">    4555 </span>            :   }
<span class="lineNum">    4556 </span>            : 
<span class="lineNum">    4557 </span><span class="lineNoCov">          0 :   if (!entry-&gt;mListenerManager) {</span>
<span class="lineNum">    4558 </span><span class="lineNoCov">          0 :     entry-&gt;mListenerManager = new EventListenerManager(aNode);</span>
<span class="lineNum">    4559 </span>            : 
<span class="lineNum">    4560 </span>            :     aNode-&gt;SetFlags(NODE_HAS_LISTENERMANAGER);
<span class="lineNum">    4561 </span>            :   }
<span class="lineNum">    4562 </span>            : 
<span class="lineNum">    4563 </span><span class="lineNoCov">          0 :   return entry-&gt;mListenerManager;</span>
<span class="lineNum">    4564 </span>            : }
<a name="4565"><span class="lineNum">    4565 </span>            : </a>
<span class="lineNum">    4566 </span>            : EventListenerManager*
<span class="lineNum">    4567 </span><span class="lineNoCov">          0 : nsContentUtils::GetExistingListenerManagerForNode(const nsINode *aNode)</span>
<span class="lineNum">    4568 </span>            : {
<span class="lineNum">    4569 </span><span class="lineNoCov">          0 :   if (!aNode-&gt;HasFlag(NODE_HAS_LISTENERMANAGER)) {</span>
<span class="lineNum">    4570 </span>            :     return nullptr;
<span class="lineNum">    4571 </span>            :   }
<span class="lineNum">    4572 </span>            : 
<span class="lineNum">    4573 </span><span class="lineNoCov">          0 :   if (!sEventListenerManagersHash) {</span>
<span class="lineNum">    4574 </span>            :     // We're already shut down, don't bother creating an event listener
<span class="lineNum">    4575 </span>            :     // manager.
<span class="lineNum">    4576 </span>            : 
<span class="lineNum">    4577 </span>            :     return nullptr;
<span class="lineNum">    4578 </span>            :   }
<span class="lineNum">    4579 </span>            : 
<span class="lineNum">    4580 </span>            :   auto entry = static_cast&lt;EventListenerManagerMapEntry*&gt;
<span class="lineNum">    4581 </span><span class="lineNoCov">          0 :                           (sEventListenerManagersHash-&gt;Search(aNode));</span>
<span class="lineNum">    4582 </span><span class="lineNoCov">          0 :   if (entry) {</span>
<span class="lineNum">    4583 </span><span class="lineNoCov">          0 :     return entry-&gt;mListenerManager;</span>
<span class="lineNum">    4584 </span>            :   }
<span class="lineNum">    4585 </span>            : 
<span class="lineNum">    4586 </span>            :   return nullptr;
<span class="lineNum">    4587 </span>            : }
<span class="lineNum">    4588 </span>            : 
<a name="4589"><span class="lineNum">    4589 </span>            : /* static */</a>
<span class="lineNum">    4590 </span>            : void
<span class="lineNum">    4591 </span><span class="lineNoCov">          0 : nsContentUtils::RemoveListenerManager(nsINode *aNode)</span>
<span class="lineNum">    4592 </span>            : {
<span class="lineNum">    4593 </span><span class="lineNoCov">          0 :   if (sEventListenerManagersHash) {</span>
<span class="lineNum">    4594 </span>            :     auto entry = static_cast&lt;EventListenerManagerMapEntry*&gt;
<span class="lineNum">    4595 </span><span class="lineNoCov">          0 :                             (sEventListenerManagersHash-&gt;Search(aNode));</span>
<span class="lineNum">    4596 </span><span class="lineNoCov">          0 :     if (entry) {</span>
<span class="lineNum">    4597 </span>            :       RefPtr&lt;EventListenerManager&gt; listenerManager;
<span class="lineNum">    4598 </span><span class="lineNoCov">          0 :       listenerManager.swap(entry-&gt;mListenerManager);</span>
<span class="lineNum">    4599 </span>            :       // Remove the entry and *then* do operations that could cause further
<span class="lineNum">    4600 </span>            :       // modification of sEventListenerManagersHash.  See bug 334177.
<span class="lineNum">    4601 </span><span class="lineNoCov">          0 :       sEventListenerManagersHash-&gt;RawRemove(entry);</span>
<span class="lineNum">    4602 </span><span class="lineNoCov">          0 :       if (listenerManager) {</span>
<span class="lineNum">    4603 </span><span class="lineNoCov">          0 :         listenerManager-&gt;Disconnect();</span>
<span class="lineNum">    4604 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">    4605 </span>            :     }
<span class="lineNum">    4606 </span>            :   }
<span class="lineNum">    4607 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    4608 </span>            : 
<a name="4609"><span class="lineNum">    4609 </span>            : /* static */</a>
<span class="lineNum">    4610 </span>            : bool
<span class="lineNum">    4611 </span><span class="lineNoCov">          0 : nsContentUtils::IsValidNodeName(nsIAtom *aLocalName, nsIAtom *aPrefix,</span>
<span class="lineNum">    4612 </span>            :                                 int32_t aNamespaceID)
<span class="lineNum">    4613 </span>            : {
<span class="lineNum">    4614 </span><span class="lineNoCov">          0 :   if (aNamespaceID == kNameSpaceID_Unknown) {</span>
<span class="lineNum">    4615 </span>            :     return false;
<span class="lineNum">    4616 </span>            :   }
<span class="lineNum">    4617 </span>            : 
<span class="lineNum">    4618 </span><span class="lineNoCov">          0 :   if (!aPrefix) {</span>
<span class="lineNum">    4619 </span>            :     // If the prefix is null, then either the QName must be xmlns or the
<span class="lineNum">    4620 </span>            :     // namespace must not be XMLNS.
<span class="lineNum">    4621 </span><span class="lineNoCov">          0 :     return (aLocalName == nsGkAtoms::xmlns) ==</span>
<span class="lineNum">    4622 </span><span class="lineNoCov">          0 :            (aNamespaceID == kNameSpaceID_XMLNS);</span>
<span class="lineNum">    4623 </span>            :   }
<span class="lineNum">    4624 </span>            : 
<span class="lineNum">    4625 </span>            :   // If the prefix is non-null then the namespace must not be null.
<span class="lineNum">    4626 </span><span class="lineNoCov">          0 :   if (aNamespaceID == kNameSpaceID_None) {</span>
<span class="lineNum">    4627 </span>            :     return false;
<span class="lineNum">    4628 </span>            :   }
<span class="lineNum">    4629 </span>            : 
<span class="lineNum">    4630 </span>            :   // If the namespace is the XMLNS namespace then the prefix must be xmlns,
<span class="lineNum">    4631 </span>            :   // but the localname must not be xmlns.
<span class="lineNum">    4632 </span><span class="lineNoCov">          0 :   if (aNamespaceID == kNameSpaceID_XMLNS) {</span>
<span class="lineNum">    4633 </span><span class="lineNoCov">          0 :     return aPrefix == nsGkAtoms::xmlns &amp;&amp; aLocalName != nsGkAtoms::xmlns;</span>
<span class="lineNum">    4634 </span>            :   }
<span class="lineNum">    4635 </span>            : 
<span class="lineNum">    4636 </span>            :   // If the namespace is not the XMLNS namespace then the prefix must not be
<span class="lineNum">    4637 </span>            :   // xmlns.
<span class="lineNum">    4638 </span>            :   // If the namespace is the XML namespace then the prefix can be anything.
<span class="lineNum">    4639 </span>            :   // If the namespace is not the XML namespace then the prefix must not be xml.
<span class="lineNum">    4640 </span><span class="lineNoCov">          0 :   return aPrefix != nsGkAtoms::xmlns &amp;&amp;</span>
<span class="lineNum">    4641 </span><span class="lineNoCov">          0 :          (aNamespaceID == kNameSpaceID_XML || aPrefix != nsGkAtoms::xml);</span>
<span class="lineNum">    4642 </span>            : }
<span class="lineNum">    4643 </span>            : 
<a name="4644"><span class="lineNum">    4644 </span>            : /* static */</a>
<span class="lineNum">    4645 </span>            : nsresult
<span class="lineNum">    4646 </span><span class="lineNoCov">          0 : nsContentUtils::CreateContextualFragment(nsINode* aContextNode,</span>
<span class="lineNum">    4647 </span>            :                                          const nsAString&amp; aFragment,
<span class="lineNum">    4648 </span>            :                                          bool aPreventScriptExecution,
<span class="lineNum">    4649 </span>            :                                          nsIDOMDocumentFragment** aReturn)
<span class="lineNum">    4650 </span>            : {
<span class="lineNum">    4651 </span>            :   ErrorResult rv;
<span class="lineNum">    4652 </span><span class="lineNoCov">          0 :   *aReturn = CreateContextualFragment(aContextNode, aFragment,</span>
<span class="lineNum">    4653 </span><span class="lineNoCov">          0 :                                       aPreventScriptExecution, rv).take();</span>
<span class="lineNum">    4654 </span><span class="lineNoCov">          0 :   return rv.StealNSResult();</span>
<span class="lineNum">    4655 </span>            : }
<span class="lineNum">    4656 </span>            : 
<span class="lineNum">    4657 </span>            : already_AddRefed&lt;DocumentFragment&gt;
<span class="lineNum">    4658 </span><span class="lineNoCov">          0 : nsContentUtils::CreateContextualFragment(nsINode* aContextNode,</span>
<span class="lineNum">    4659 </span>            :                                          const nsAString&amp; aFragment,
<span class="lineNum">    4660 </span>            :                                          bool aPreventScriptExecution,
<span class="lineNum">    4661 </span>            :                                          ErrorResult&amp; aRv)
<span class="lineNum">    4662 </span>            : {
<span class="lineNum">    4663 </span><span class="lineNoCov">          0 :   if (!aContextNode) {</span>
<span class="lineNum">    4664 </span><span class="lineNoCov">          0 :     aRv.Throw(NS_ERROR_INVALID_ARG);</span>
<span class="lineNum">    4665 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">    4666 </span>            :   }
<span class="lineNum">    4667 </span>            : 
<span class="lineNum">    4668 </span>            :   // If we don't have a document here, we can't get the right security context
<span class="lineNum">    4669 </span>            :   // for compiling event handlers... so just bail out.
<span class="lineNum">    4670 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocument&gt; document = aContextNode-&gt;OwnerDoc();</span>
<span class="lineNum">    4671 </span><span class="lineNoCov">          0 :   bool isHTML = document-&gt;IsHTMLDocument();</span>
<span class="lineNum">    4672 </span>            : #ifdef DEBUG
<span class="lineNum">    4673 </span>            :   nsCOMPtr&lt;nsIHTMLDocument&gt; htmlDoc = do_QueryInterface(document);
<span class="lineNum">    4674 </span>            :   NS_ASSERTION(!isHTML || htmlDoc, &quot;Should have HTMLDocument here!&quot;);
<span class="lineNum">    4675 </span>            : #endif
<span class="lineNum">    4676 </span>            : 
<span class="lineNum">    4677 </span><span class="lineNoCov">          0 :   if (isHTML) {</span>
<span class="lineNum">    4678 </span>            :     RefPtr&lt;DocumentFragment&gt; frag =
<span class="lineNum">    4679 </span><span class="lineNoCov">          0 :       new DocumentFragment(document-&gt;NodeInfoManager());</span>
<span class="lineNum">    4680 </span>            : 
<span class="lineNum">    4681 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIContent&gt; contextAsContent = do_QueryInterface(aContextNode);</span>
<span class="lineNum">    4682 </span><span class="lineNoCov">          0 :     if (contextAsContent &amp;&amp; !contextAsContent-&gt;IsElement()) {</span>
<span class="lineNum">    4683 </span><span class="lineNoCov">          0 :       contextAsContent = contextAsContent-&gt;GetParent();</span>
<span class="lineNum">    4684 </span><span class="lineNoCov">          0 :       if (contextAsContent &amp;&amp; !contextAsContent-&gt;IsElement()) {</span>
<span class="lineNum">    4685 </span>            :         // can this even happen?
<span class="lineNum">    4686 </span><span class="lineNoCov">          0 :         contextAsContent = nullptr;</span>
<span class="lineNum">    4687 </span>            :       }
<span class="lineNum">    4688 </span>            :     }
<span class="lineNum">    4689 </span>            : 
<span class="lineNum">    4690 </span><span class="lineNoCov">          0 :     if (contextAsContent &amp;&amp; !contextAsContent-&gt;IsHTMLElement(nsGkAtoms::html)) {</span>
<span class="lineNum">    4691 </span><span class="lineNoCov">          0 :       aRv = ParseFragmentHTML(aFragment, frag,</span>
<span class="lineNum">    4692 </span>            :                               contextAsContent-&gt;NodeInfo()-&gt;NameAtom(),
<span class="lineNum">    4693 </span>            :                               contextAsContent-&gt;GetNameSpaceID(),
<span class="lineNum">    4694 </span>            :                               (document-&gt;GetCompatibilityMode() ==
<span class="lineNum">    4695 </span>            :                                eCompatibility_NavQuirks),
<span class="lineNum">    4696 </span>            :                               aPreventScriptExecution);
<span class="lineNum">    4697 </span>            :     } else {
<span class="lineNum">    4698 </span><span class="lineNoCov">          0 :       aRv = ParseFragmentHTML(aFragment, frag,</span>
<span class="lineNum">    4699 </span>            :                               nsGkAtoms::body,
<span class="lineNum">    4700 </span>            :                               kNameSpaceID_XHTML,
<span class="lineNum">    4701 </span>            :                               (document-&gt;GetCompatibilityMode() ==
<span class="lineNum">    4702 </span>            :                                eCompatibility_NavQuirks),
<span class="lineNum">    4703 </span>            :                               aPreventScriptExecution);
<span class="lineNum">    4704 </span>            :     }
<span class="lineNum">    4705 </span>            : 
<span class="lineNum">    4706 </span><span class="lineNoCov">          0 :     return frag.forget();</span>
<span class="lineNum">    4707 </span>            :   }
<span class="lineNum">    4708 </span>            : 
<span class="lineNum">    4709 </span><span class="lineNoCov">          0 :   AutoTArray&lt;nsString, 32&gt; tagStack;</span>
<span class="lineNum">    4710 </span><span class="lineNoCov">          0 :   nsAutoString uriStr, nameStr;</span>
<span class="lineNum">    4711 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIContent&gt; content = do_QueryInterface(aContextNode);</span>
<span class="lineNum">    4712 </span>            :   // just in case we have a text node
<span class="lineNum">    4713 </span><span class="lineNoCov">          0 :   if (content &amp;&amp; !content-&gt;IsElement())</span>
<span class="lineNum">    4714 </span><span class="lineNoCov">          0 :     content = content-&gt;GetParent();</span>
<span class="lineNum">    4715 </span>            : 
<span class="lineNum">    4716 </span><span class="lineNoCov">          0 :   while (content &amp;&amp; content-&gt;IsElement()) {</span>
<span class="lineNum">    4717 </span><span class="lineNoCov">          0 :     nsString&amp; tagName = *tagStack.AppendElement();</span>
<span class="lineNum">    4718 </span><span class="lineNoCov">          0 :     tagName = content-&gt;NodeInfo()-&gt;QualifiedName();</span>
<span class="lineNum">    4719 </span>            : 
<span class="lineNum">    4720 </span>            :     // see if we need to add xmlns declarations
<span class="lineNum">    4721 </span><span class="lineNoCov">          0 :     uint32_t count = content-&gt;GetAttrCount();</span>
<span class="lineNum">    4722 </span><span class="lineNoCov">          0 :     bool setDefaultNamespace = false;</span>
<span class="lineNum">    4723 </span><span class="lineNoCov">          0 :     if (count &gt; 0) {</span>
<span class="lineNum">    4724 </span>            :       uint32_t index;
<span class="lineNum">    4725 </span>            : 
<span class="lineNum">    4726 </span><span class="lineNoCov">          0 :       for (index = 0; index &lt; count; index++) {</span>
<span class="lineNum">    4727 </span><span class="lineNoCov">          0 :         const BorrowedAttrInfo info = content-&gt;GetAttrInfoAt(index);</span>
<span class="lineNum">    4728 </span><span class="lineNoCov">          0 :         const nsAttrName* name = info.mName;</span>
<span class="lineNum">    4729 </span><span class="lineNoCov">          0 :         if (name-&gt;NamespaceEquals(kNameSpaceID_XMLNS)) {</span>
<span class="lineNum">    4730 </span><span class="lineNoCov">          0 :           info.mValue-&gt;ToString(uriStr);</span>
<span class="lineNum">    4731 </span>            : 
<span class="lineNum">    4732 </span>            :           // really want something like nsXMLContentSerializer::SerializeAttr
<span class="lineNum">    4733 </span><span class="lineNoCov">          0 :           tagName.AppendLiteral(&quot; xmlns&quot;); // space important</span>
<span class="lineNum">    4734 </span><span class="lineNoCov">          0 :           if (name-&gt;GetPrefix()) {</span>
<span class="lineNum">    4735 </span><span class="lineNoCov">          0 :             tagName.Append(char16_t(':'));</span>
<span class="lineNum">    4736 </span><span class="lineNoCov">          0 :             name-&gt;LocalName()-&gt;ToString(nameStr);</span>
<span class="lineNum">    4737 </span><span class="lineNoCov">          0 :             tagName.Append(nameStr);</span>
<span class="lineNum">    4738 </span>            :           } else {
<span class="lineNum">    4739 </span>            :             setDefaultNamespace = true;
<span class="lineNum">    4740 </span>            :           }
<span class="lineNum">    4741 </span><span class="lineNoCov">          0 :           tagName.AppendLiteral(R&quot;(=&quot;)&quot;);</span>
<span class="lineNum">    4742 </span><span class="lineNoCov">          0 :           tagName.Append(uriStr);</span>
<span class="lineNum">    4743 </span><span class="lineNoCov">          0 :           tagName.Append('&quot;');</span>
<span class="lineNum">    4744 </span>            :         }
<span class="lineNum">    4745 </span>            :       }
<span class="lineNum">    4746 </span>            :     }
<span class="lineNum">    4747 </span>            : 
<span class="lineNum">    4748 </span><span class="lineNoCov">          0 :     if (!setDefaultNamespace) {</span>
<span class="lineNum">    4749 </span><span class="lineNoCov">          0 :       mozilla::dom::NodeInfo* info = content-&gt;NodeInfo();</span>
<span class="lineNum">    4750 </span><span class="lineNoCov">          0 :       if (!info-&gt;GetPrefixAtom() &amp;&amp;</span>
<span class="lineNum">    4751 </span>            :           info-&gt;NamespaceID() != kNameSpaceID_None) {
<span class="lineNum">    4752 </span>            :         // We have no namespace prefix, but have a namespace ID.  Push
<span class="lineNum">    4753 </span>            :         // default namespace attr in, so that our kids will be in our
<span class="lineNum">    4754 </span>            :         // namespace.
<span class="lineNum">    4755 </span><span class="lineNoCov">          0 :         info-&gt;GetNamespaceURI(uriStr);</span>
<span class="lineNum">    4756 </span><span class="lineNoCov">          0 :         tagName.AppendLiteral(R&quot;( xmlns=&quot;)&quot;);</span>
<span class="lineNum">    4757 </span><span class="lineNoCov">          0 :         tagName.Append(uriStr);</span>
<span class="lineNum">    4758 </span><span class="lineNoCov">          0 :         tagName.Append('&quot;');</span>
<span class="lineNum">    4759 </span>            :       }
<span class="lineNum">    4760 </span>            :     }
<span class="lineNum">    4761 </span>            : 
<span class="lineNum">    4762 </span><span class="lineNoCov">          0 :     content = content-&gt;GetParent();</span>
<span class="lineNum">    4763 </span>            :   }
<span class="lineNum">    4764 </span>            : 
<span class="lineNum">    4765 </span>            :   nsCOMPtr&lt;nsIDOMDocumentFragment&gt; frag;
<span class="lineNum">    4766 </span><span class="lineNoCov">          0 :   aRv = ParseFragmentXML(aFragment, document, tagStack,</span>
<span class="lineNum">    4767 </span>            :                          aPreventScriptExecution, getter_AddRefs(frag));
<span class="lineNum">    4768 </span><span class="lineNoCov">          0 :   return frag.forget().downcast&lt;DocumentFragment&gt;();</span>
<span class="lineNum">    4769 </span>            : }
<span class="lineNum">    4770 </span>            : 
<a name="4771"><span class="lineNum">    4771 </span>            : /* static */</a>
<span class="lineNum">    4772 </span>            : void
<span class="lineNum">    4773 </span><span class="lineCov">         60 : nsContentUtils::DropFragmentParsers()</span>
<span class="lineNum">    4774 </span>            : {
<span class="lineNum">    4775 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sHTMLFragmentParser);</span>
<span class="lineNum">    4776 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sXMLFragmentParser);</span>
<span class="lineNum">    4777 </span><span class="lineCov">         60 :   NS_IF_RELEASE(sXMLFragmentSink);</span>
<span class="lineNum">    4778 </span><span class="lineCov">         60 : }</span>
<span class="lineNum">    4779 </span>            : 
<a name="4780"><span class="lineNum">    4780 </span>            : /* static */</a>
<span class="lineNum">    4781 </span>            : void
<span class="lineNum">    4782 </span><span class="lineCov">         60 : nsContentUtils::XPCOMShutdown()</span>
<span class="lineNum">    4783 </span>            : {
<span class="lineNum">    4784 </span><span class="lineCov">         60 :   nsContentUtils::DropFragmentParsers();</span>
<span class="lineNum">    4785 </span><span class="lineCov">         60 : }</span>
<span class="lineNum">    4786 </span>            : 
<a name="4787"><span class="lineNum">    4787 </span>            : /* static */</a>
<span class="lineNum">    4788 </span>            : nsresult
<span class="lineNum">    4789 </span><span class="lineNoCov">          0 : nsContentUtils::ParseFragmentHTML(const nsAString&amp; aSourceBuffer,</span>
<span class="lineNum">    4790 </span>            :                                   nsIContent* aTargetNode,
<span class="lineNum">    4791 </span>            :                                   nsIAtom* aContextLocalName,
<span class="lineNum">    4792 </span>            :                                   int32_t aContextNamespace,
<span class="lineNum">    4793 </span>            :                                   bool aQuirks,
<span class="lineNum">    4794 </span>            :                                   bool aPreventScriptExecution)
<span class="lineNum">    4795 </span>            : {
<span class="lineNum">    4796 </span><span class="lineNoCov">          0 :   AutoTimelineMarker m(aTargetNode-&gt;OwnerDoc()-&gt;GetDocShell(), &quot;Parse HTML&quot;);</span>
<span class="lineNum">    4797 </span>            : 
<span class="lineNum">    4798 </span><span class="lineNoCov">          0 :   if (nsContentUtils::sFragmentParsingActive) {</span>
<span class="lineNum">    4799 </span>            :     NS_NOTREACHED(&quot;Re-entrant fragment parsing attempted.&quot;);
<span class="lineNum">    4800 </span>            :     return NS_ERROR_DOM_INVALID_STATE_ERR;
<span class="lineNum">    4801 </span>            :   }
<span class="lineNum">    4802 </span>            :   mozilla::AutoRestore&lt;bool&gt; guard(nsContentUtils::sFragmentParsingActive);
<span class="lineNum">    4803 </span><span class="lineNoCov">          0 :   nsContentUtils::sFragmentParsingActive = true;</span>
<span class="lineNum">    4804 </span><span class="lineNoCov">          0 :   if (!sHTMLFragmentParser) {</span>
<span class="lineNum">    4805 </span><span class="lineNoCov">          0 :     NS_ADDREF(sHTMLFragmentParser = new nsHtml5StringParser());</span>
<span class="lineNum">    4806 </span>            :     // Now sHTMLFragmentParser owns the object
<span class="lineNum">    4807 </span>            :   }
<span class="lineNum">    4808 </span>            :   nsresult rv =
<span class="lineNum">    4809 </span>            :     sHTMLFragmentParser-&gt;ParseFragment(aSourceBuffer,
<span class="lineNum">    4810 </span>            :                                        aTargetNode,
<span class="lineNum">    4811 </span>            :                                        aContextLocalName,
<span class="lineNum">    4812 </span>            :                                        aContextNamespace,
<span class="lineNum">    4813 </span>            :                                        aQuirks,
<span class="lineNum">    4814 </span><span class="lineNoCov">          0 :                                        aPreventScriptExecution);</span>
<span class="lineNum">    4815 </span><span class="lineNoCov">          0 :   return rv;</span>
<span class="lineNum">    4816 </span>            : }
<span class="lineNum">    4817 </span>            : 
<a name="4818"><span class="lineNum">    4818 </span>            : /* static */</a>
<span class="lineNum">    4819 </span>            : nsresult
<span class="lineNum">    4820 </span><span class="lineNoCov">          0 : nsContentUtils::ParseDocumentHTML(const nsAString&amp; aSourceBuffer,</span>
<span class="lineNum">    4821 </span>            :                                   nsIDocument* aTargetDocument,
<span class="lineNum">    4822 </span>            :                                   bool aScriptingEnabledForNoscriptParsing)
<span class="lineNum">    4823 </span>            : {
<span class="lineNum">    4824 </span><span class="lineNoCov">          0 :   AutoTimelineMarker m(aTargetDocument-&gt;GetDocShell(), &quot;Parse HTML&quot;);</span>
<span class="lineNum">    4825 </span>            : 
<span class="lineNum">    4826 </span><span class="lineNoCov">          0 :   if (nsContentUtils::sFragmentParsingActive) {</span>
<span class="lineNum">    4827 </span>            :     NS_NOTREACHED(&quot;Re-entrant fragment parsing attempted.&quot;);
<span class="lineNum">    4828 </span>            :     return NS_ERROR_DOM_INVALID_STATE_ERR;
<span class="lineNum">    4829 </span>            :   }
<span class="lineNum">    4830 </span>            :   mozilla::AutoRestore&lt;bool&gt; guard(nsContentUtils::sFragmentParsingActive);
<span class="lineNum">    4831 </span><span class="lineNoCov">          0 :   nsContentUtils::sFragmentParsingActive = true;</span>
<span class="lineNum">    4832 </span><span class="lineNoCov">          0 :   if (!sHTMLFragmentParser) {</span>
<span class="lineNum">    4833 </span><span class="lineNoCov">          0 :     NS_ADDREF(sHTMLFragmentParser = new nsHtml5StringParser());</span>
<span class="lineNum">    4834 </span>            :     // Now sHTMLFragmentParser owns the object
<span class="lineNum">    4835 </span>            :   }
<span class="lineNum">    4836 </span>            :   nsresult rv =
<span class="lineNum">    4837 </span>            :     sHTMLFragmentParser-&gt;ParseDocument(aSourceBuffer,
<span class="lineNum">    4838 </span>            :                                        aTargetDocument,
<span class="lineNum">    4839 </span><span class="lineNoCov">          0 :                                        aScriptingEnabledForNoscriptParsing);</span>
<span class="lineNum">    4840 </span><span class="lineNoCov">          0 :   return rv;</span>
<span class="lineNum">    4841 </span>            : }
<span class="lineNum">    4842 </span>            : 
<span class="lineNum">    4843 </span>            : /* static */
<span class="lineNum">    4844 </span>            : nsresult
<span class="lineNum">    4845 </span><span class="lineNoCov">          0 : nsContentUtils::ParseFragmentXML(const nsAString&amp; aSourceBuffer,</span>
<span class="lineNum">    4846 </span>            :                                  nsIDocument* aDocument,
<span class="lineNum">    4847 </span>            :                                  nsTArray&lt;nsString&gt;&amp; aTagStack,
<span class="lineNum">    4848 </span>            :                                  bool aPreventScriptExecution,
<span class="lineNum">    4849 </span>            :                                  nsIDOMDocumentFragment** aReturn)
<span class="lineNum">    4850 </span>            : {
<span class="lineNum">    4851 </span><span class="lineNoCov">          0 :   AutoTimelineMarker m(aDocument-&gt;GetDocShell(), &quot;Parse XML&quot;);</span>
<span class="lineNum">    4852 </span>            : 
<span class="lineNum">    4853 </span><span class="lineNoCov">          0 :   if (nsContentUtils::sFragmentParsingActive) {</span>
<span class="lineNum">    4854 </span>            :     NS_NOTREACHED(&quot;Re-entrant fragment parsing attempted.&quot;);
<span class="lineNum">    4855 </span>            :     return NS_ERROR_DOM_INVALID_STATE_ERR;
<span class="lineNum">    4856 </span>            :   }
<span class="lineNum">    4857 </span>            :   mozilla::AutoRestore&lt;bool&gt; guard(nsContentUtils::sFragmentParsingActive);
<span class="lineNum">    4858 </span><span class="lineNoCov">          0 :   nsContentUtils::sFragmentParsingActive = true;</span>
<span class="lineNum">    4859 </span><span class="lineNoCov">          0 :   if (!sXMLFragmentParser) {</span>
<span class="lineNum">    4860 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIParser&gt; parser = do_CreateInstance(kCParserCID);</span>
<span class="lineNum">    4861 </span>            :     parser.forget(&amp;sXMLFragmentParser);
<span class="lineNum">    4862 </span>            :     // sXMLFragmentParser now owns the parser
<span class="lineNum">    4863 </span>            :   }
<span class="lineNum">    4864 </span><span class="lineNoCov">          0 :   if (!sXMLFragmentSink) {</span>
<span class="lineNum">    4865 </span><span class="lineNoCov">          0 :     NS_NewXMLFragmentContentSink(&amp;sXMLFragmentSink);</span>
<span class="lineNum">    4866 </span>            :     // sXMLFragmentSink now owns the sink
<span class="lineNum">    4867 </span>            :   }
<span class="lineNum">    4868 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIContentSink&gt; contentsink = do_QueryInterface(sXMLFragmentSink);</span>
<span class="lineNum">    4869 </span>            :   MOZ_ASSERT(contentsink, &quot;Sink doesn't QI to nsIContentSink!&quot;);
<span class="lineNum">    4870 </span><span class="lineNoCov">          0 :   sXMLFragmentParser-&gt;SetContentSink(contentsink);</span>
<span class="lineNum">    4871 </span>            : 
<span class="lineNum">    4872 </span><span class="lineNoCov">          0 :   sXMLFragmentSink-&gt;SetTargetDocument(aDocument);</span>
<span class="lineNum">    4873 </span><span class="lineNoCov">          0 :   sXMLFragmentSink-&gt;SetPreventScriptExecution(aPreventScriptExecution);</span>
<span class="lineNum">    4874 </span>            : 
<span class="lineNum">    4875 </span>            :   nsresult rv =
<span class="lineNum">    4876 </span>            :     sXMLFragmentParser-&gt;ParseFragment(aSourceBuffer,
<span class="lineNum">    4877 </span><span class="lineNoCov">          0 :                                       aTagStack);</span>
<span class="lineNum">    4878 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    4879 </span>            :     // Drop the fragment parser and sink that might be in an inconsistent state
<span class="lineNum">    4880 </span><span class="lineNoCov">          0 :     NS_IF_RELEASE(sXMLFragmentParser);</span>
<span class="lineNum">    4881 </span><span class="lineNoCov">          0 :     NS_IF_RELEASE(sXMLFragmentSink);</span>
<span class="lineNum">    4882 </span><span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">    4883 </span>            :   }
<span class="lineNum">    4884 </span>            : 
<span class="lineNum">    4885 </span><span class="lineNoCov">          0 :   rv = sXMLFragmentSink-&gt;FinishFragmentParsing(aReturn);</span>
<span class="lineNum">    4886 </span>            : 
<span class="lineNum">    4887 </span><span class="lineNoCov">          0 :   sXMLFragmentParser-&gt;Reset();</span>
<span class="lineNum">    4888 </span>            : 
<span class="lineNum">    4889 </span><span class="lineNoCov">          0 :   return rv;</span>
<span class="lineNum">    4890 </span>            : }
<span class="lineNum">    4891 </span>            : 
<span class="lineNum">    4892 </span>            : /* static */
<span class="lineNum">    4893 </span>            : nsresult
<span class="lineNum">    4894 </span><span class="lineNoCov">          0 : nsContentUtils::ConvertToPlainText(const nsAString&amp; aSourceBuffer,</span>
<span class="lineNum">    4895 </span>            :                                    nsAString&amp; aResultBuffer,
<span class="lineNum">    4896 </span>            :                                    uint32_t aFlags,
<span class="lineNum">    4897 </span>            :                                    uint32_t aWrapCol)
<span class="lineNum">    4898 </span>            : {
<span class="lineNum">    4899 </span>            :   nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">    4900 </span><span class="lineNoCov">          0 :   NS_NewURI(getter_AddRefs(uri), &quot;about:blank&quot;);</span>
<span class="lineNum">    4901 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIPrincipal&gt; principal = NullPrincipal::Create();</span>
<span class="lineNum">    4902 </span>            :   nsCOMPtr&lt;nsIDOMDocument&gt; domDocument;
<span class="lineNum">    4903 </span>            :   nsresult rv = NS_NewDOMDocument(getter_AddRefs(domDocument),
<span class="lineNum">    4904 </span><span class="lineNoCov">          0 :                                   EmptyString(),</span>
<span class="lineNum">    4905 </span><span class="lineNoCov">          0 :                                   EmptyString(),</span>
<span class="lineNum">    4906 </span>            :                                   nullptr,
<span class="lineNum">    4907 </span>            :                                   uri,
<span class="lineNum">    4908 </span>            :                                   uri,
<span class="lineNum">    4909 </span>            :                                   principal,
<span class="lineNum">    4910 </span>            :                                   true,
<span class="lineNum">    4911 </span>            :                                   nullptr,
<span class="lineNum">    4912 </span><span class="lineNoCov">          0 :                                   DocumentFlavorHTML);</span>
<span class="lineNum">    4913 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4914 </span>            : 
<span class="lineNum">    4915 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocument&gt; document = do_QueryInterface(domDocument);</span>
<span class="lineNum">    4916 </span>            :   rv = nsContentUtils::ParseDocumentHTML(aSourceBuffer, document,
<span class="lineNum">    4917 </span><span class="lineNoCov">          0 :     !(aFlags &amp; nsIDocumentEncoder::OutputNoScriptContent));</span>
<span class="lineNum">    4918 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4919 </span>            : 
<span class="lineNum">    4920 </span>            :   nsCOMPtr&lt;nsIDocumentEncoder&gt; encoder = do_CreateInstance(
<span class="lineNum">    4921 </span><span class="lineNoCov">          0 :     &quot;@mozilla.org/layout/documentEncoder;1?type=text/plain&quot;);</span>
<span class="lineNum">    4922 </span>            : 
<span class="lineNum">    4923 </span><span class="lineNoCov">          0 :   rv = encoder-&gt;Init(domDocument, NS_LITERAL_STRING(&quot;text/plain&quot;), aFlags);</span>
<span class="lineNum">    4924 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4925 </span>            : 
<span class="lineNum">    4926 </span><span class="lineNoCov">          0 :   encoder-&gt;SetWrapColumn(aWrapCol);</span>
<span class="lineNum">    4927 </span>            : 
<span class="lineNum">    4928 </span><span class="lineNoCov">          0 :   return encoder-&gt;EncodeToString(aResultBuffer);</span>
<span class="lineNum">    4929 </span>            : }
<span class="lineNum">    4930 </span>            : 
<span class="lineNum">    4931 </span>            : /* static */
<span class="lineNum">    4932 </span>            : nsresult
<span class="lineNum">    4933 </span><span class="lineNoCov">          0 : nsContentUtils::SetNodeTextContent(nsIContent* aContent,</span>
<span class="lineNum">    4934 </span>            :                                    const nsAString&amp; aValue,
<span class="lineNum">    4935 </span>            :                                    bool aTryReuse)
<span class="lineNum">    4936 </span>            : {
<span class="lineNum">    4937 </span>            :   // Fire DOMNodeRemoved mutation events before we do anything else.
<span class="lineNum">    4938 </span>            :   nsCOMPtr&lt;nsIContent&gt; owningContent;
<span class="lineNum">    4939 </span>            : 
<span class="lineNum">    4940 </span>            :   // Batch possible DOMSubtreeModified events.
<span class="lineNum">    4941 </span><span class="lineNoCov">          0 :   mozAutoSubtreeModified subtree(nullptr, nullptr);</span>
<span class="lineNum">    4942 </span>            : 
<span class="lineNum">    4943 </span>            :   // Scope firing mutation events so that we don't carry any state that
<span class="lineNum">    4944 </span>            :   // might be stale
<span class="lineNum">    4945 </span>            :   {
<span class="lineNum">    4946 </span>            :     // We're relying on mozAutoSubtreeModified to keep a strong reference if
<span class="lineNum">    4947 </span>            :     // needed.
<span class="lineNum">    4948 </span><span class="lineNoCov">          0 :     nsIDocument* doc = aContent-&gt;OwnerDoc();</span>
<span class="lineNum">    4949 </span>            : 
<span class="lineNum">    4950 </span>            :     // Optimize the common case of there being no observers
<span class="lineNum">    4951 </span><span class="lineNoCov">          0 :     if (HasMutationListeners(doc, NS_EVENT_BITS_MUTATION_NODEREMOVED)) {</span>
<span class="lineNum">    4952 </span><span class="lineNoCov">          0 :       subtree.UpdateTarget(doc, nullptr);</span>
<span class="lineNum">    4953 </span>            :       owningContent = aContent;
<span class="lineNum">    4954 </span>            :       nsCOMPtr&lt;nsINode&gt; child;
<span class="lineNum">    4955 </span><span class="lineNoCov">          0 :       bool skipFirst = aTryReuse;</span>
<span class="lineNum">    4956 </span><span class="lineNoCov">          0 :       for (child = aContent-&gt;GetFirstChild();</span>
<span class="lineNum">    4957 </span><span class="lineNoCov">          0 :            child &amp;&amp; child-&gt;GetParentNode() == aContent;</span>
<span class="lineNum">    4958 </span><span class="lineNoCov">          0 :            child = child-&gt;GetNextSibling()) {</span>
<span class="lineNum">    4959 </span><span class="lineNoCov">          0 :         if (skipFirst &amp;&amp; child-&gt;IsNodeOfType(nsINode::eTEXT)) {</span>
<span class="lineNum">    4960 </span>            :           skipFirst = false;
<span class="lineNum">    4961 </span>            :           continue;
<span class="lineNum">    4962 </span>            :         }
<span class="lineNum">    4963 </span><span class="lineNoCov">          0 :         nsContentUtils::MaybeFireNodeRemoved(child, aContent, doc);</span>
<span class="lineNum">    4964 </span>            :       }
<span class="lineNum">    4965 </span>            :     }
<span class="lineNum">    4966 </span>            :   }
<span class="lineNum">    4967 </span>            : 
<span class="lineNum">    4968 </span>            :   // Might as well stick a batch around this since we're performing several
<span class="lineNum">    4969 </span>            :   // mutations.
<span class="lineNum">    4970 </span>            :   mozAutoDocUpdate updateBatch(aContent-&gt;GetComposedDoc(),
<span class="lineNum">    4971 </span><span class="lineNoCov">          0 :     UPDATE_CONTENT_MODEL, true);</span>
<span class="lineNum">    4972 </span><span class="lineNoCov">          0 :   nsAutoMutationBatch mb;</span>
<span class="lineNum">    4973 </span>            : 
<span class="lineNum">    4974 </span><span class="lineNoCov">          0 :   uint32_t childCount = aContent-&gt;GetChildCount();</span>
<span class="lineNum">    4975 </span>            : 
<span class="lineNum">    4976 </span><span class="lineNoCov">          0 :   if (aTryReuse &amp;&amp; !aValue.IsEmpty()) {</span>
<span class="lineNum">    4977 </span>            :     uint32_t removeIndex = 0;
<span class="lineNum">    4978 </span>            : 
<span class="lineNum">    4979 </span><span class="lineNoCov">          0 :     for (uint32_t i = 0; i &lt; childCount; ++i) {</span>
<span class="lineNum">    4980 </span><span class="lineNoCov">          0 :       nsIContent* child = aContent-&gt;GetChildAt(removeIndex);</span>
<span class="lineNum">    4981 </span><span class="lineNoCov">          0 :       if (removeIndex == 0 &amp;&amp; child &amp;&amp; child-&gt;IsNodeOfType(nsINode::eTEXT)) {</span>
<span class="lineNum">    4982 </span><span class="lineNoCov">          0 :         nsresult rv = child-&gt;SetText(aValue, true);</span>
<span class="lineNum">    4983 </span><span class="lineNoCov">          0 :         NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    4984 </span>            : 
<span class="lineNum">    4985 </span>            :         removeIndex = 1;
<span class="lineNum">    4986 </span>            :       }
<span class="lineNum">    4987 </span>            :       else {
<span class="lineNum">    4988 </span><span class="lineNoCov">          0 :         aContent-&gt;RemoveChildAt(removeIndex, true);</span>
<span class="lineNum">    4989 </span>            :       }
<span class="lineNum">    4990 </span>            :     }
<span class="lineNum">    4991 </span>            : 
<span class="lineNum">    4992 </span><span class="lineNoCov">          0 :     if (removeIndex == 1) {</span>
<span class="lineNum">    4993 </span>            :       return NS_OK;
<span class="lineNum">    4994 </span>            :     }
<span class="lineNum">    4995 </span>            :   }
<span class="lineNum">    4996 </span>            :   else {
<span class="lineNum">    4997 </span><span class="lineNoCov">          0 :     mb.Init(aContent, true, false);</span>
<span class="lineNum">    4998 </span><span class="lineNoCov">          0 :     for (uint32_t i = 0; i &lt; childCount; ++i) {</span>
<span class="lineNum">    4999 </span><span class="lineNoCov">          0 :       aContent-&gt;RemoveChildAt(0, true);</span>
<span class="lineNum">    5000 </span>            :     }
<span class="lineNum">    5001 </span>            :   }
<span class="lineNum">    5002 </span><span class="lineNoCov">          0 :   mb.RemovalDone();</span>
<span class="lineNum">    5003 </span>            : 
<span class="lineNum">    5004 </span><span class="lineNoCov">          0 :   if (aValue.IsEmpty()) {</span>
<span class="lineNum">    5005 </span>            :     return NS_OK;
<span class="lineNum">    5006 </span>            :   }
<span class="lineNum">    5007 </span>            : 
<span class="lineNum">    5008 </span>            :   RefPtr&lt;nsTextNode&gt; textContent =
<span class="lineNum">    5009 </span><span class="lineNoCov">          0 :     new nsTextNode(aContent-&gt;NodeInfo()-&gt;NodeInfoManager());</span>
<span class="lineNum">    5010 </span>            : 
<span class="lineNum">    5011 </span><span class="lineNoCov">          0 :   textContent-&gt;SetText(aValue, true);</span>
<span class="lineNum">    5012 </span>            : 
<span class="lineNum">    5013 </span><span class="lineNoCov">          0 :   nsresult rv = aContent-&gt;AppendChildTo(textContent, true);</span>
<span class="lineNum">    5014 </span><span class="lineNoCov">          0 :   mb.NodesAdded();</span>
<span class="lineNum">    5015 </span>            :   return rv;
<span class="lineNum">    5016 </span>            : }
<a name="5017"><span class="lineNum">    5017 </span>            : </a>
<span class="lineNum">    5018 </span>            : static bool
<span class="lineNum">    5019 </span><span class="lineNoCov">          0 : AppendNodeTextContentsRecurse(nsINode* aNode, nsAString&amp; aResult,</span>
<span class="lineNum">    5020 </span>            :                               const fallible_t&amp; aFallible)
<span class="lineNum">    5021 </span>            : {
<span class="lineNum">    5022 </span><span class="lineNoCov">          0 :   for (nsIContent* child = aNode-&gt;GetFirstChild();</span>
<span class="lineNum">    5023 </span>            :        child;
<span class="lineNum">    5024 </span><span class="lineNoCov">          0 :        child = child-&gt;GetNextSibling()) {</span>
<span class="lineNum">    5025 </span><span class="lineNoCov">          0 :     if (child-&gt;IsElement()) {</span>
<span class="lineNum">    5026 </span>            :       bool ok = AppendNodeTextContentsRecurse(child, aResult,
<span class="lineNum">    5027 </span><span class="lineNoCov">          0 :                                               aFallible);</span>
<span class="lineNum">    5028 </span><span class="lineNoCov">          0 :       if (!ok) {</span>
<span class="lineNum">    5029 </span>            :         return false;
<span class="lineNum">    5030 </span>            :       }
<span class="lineNum">    5031 </span>            :     }
<span class="lineNum">    5032 </span><span class="lineNoCov">          0 :     else if (child-&gt;IsNodeOfType(nsINode::eTEXT)) {</span>
<span class="lineNum">    5033 </span><span class="lineNoCov">          0 :       bool ok = child-&gt;AppendTextTo(aResult, aFallible);</span>
<span class="lineNum">    5034 </span><span class="lineNoCov">          0 :       if (!ok) {</span>
<span class="lineNum">    5035 </span>            :         return false;
<span class="lineNum">    5036 </span>            :       }
<span class="lineNum">    5037 </span>            :     }
<span class="lineNum">    5038 </span>            :   }
<span class="lineNum">    5039 </span>            : 
<span class="lineNum">    5040 </span>            :   return true;
<span class="lineNum">    5041 </span>            : }
<span class="lineNum">    5042 </span>            : 
<a name="5043"><span class="lineNum">    5043 </span>            : /* static */</a>
<span class="lineNum">    5044 </span>            : bool
<span class="lineNum">    5045 </span><span class="lineNoCov">          0 : nsContentUtils::AppendNodeTextContent(nsINode* aNode, bool aDeep,</span>
<span class="lineNum">    5046 </span>            :                                       nsAString&amp; aResult,
<span class="lineNum">    5047 </span>            :                                       const fallible_t&amp; aFallible)
<span class="lineNum">    5048 </span>            : {
<span class="lineNum">    5049 </span><span class="lineNoCov">          0 :   if (aNode-&gt;IsNodeOfType(nsINode::eTEXT)) {</span>
<span class="lineNum">    5050 </span>            :     return static_cast&lt;nsIContent*&gt;(aNode)-&gt;AppendTextTo(aResult,
<span class="lineNum">    5051 </span><span class="lineNoCov">          0 :                                                          aFallible);</span>
<span class="lineNum">    5052 </span>            :   }
<span class="lineNum">    5053 </span><span class="lineNoCov">          0 :   if (aDeep) {</span>
<span class="lineNum">    5054 </span><span class="lineNoCov">          0 :     return AppendNodeTextContentsRecurse(aNode, aResult, aFallible);</span>
<span class="lineNum">    5055 </span>            :   }
<span class="lineNum">    5056 </span>            : 
<span class="lineNum">    5057 </span><span class="lineNoCov">          0 :   for (nsIContent* child = aNode-&gt;GetFirstChild();</span>
<span class="lineNum">    5058 </span>            :        child;
<span class="lineNum">    5059 </span><span class="lineNoCov">          0 :        child = child-&gt;GetNextSibling()) {</span>
<span class="lineNum">    5060 </span><span class="lineNoCov">          0 :     if (child-&gt;IsNodeOfType(nsINode::eTEXT)) {</span>
<span class="lineNum">    5061 </span><span class="lineNoCov">          0 :       bool ok = child-&gt;AppendTextTo(aResult, fallible);</span>
<span class="lineNum">    5062 </span><span class="lineNoCov">          0 :       if (!ok) {</span>
<span class="lineNum">    5063 </span>            :         return false;
<span class="lineNum">    5064 </span>            :       }
<span class="lineNum">    5065 </span>            :     }
<span class="lineNum">    5066 </span>            :   }
<span class="lineNum">    5067 </span>            :   return true;
<span class="lineNum">    5068 </span>            : }
<a name="5069"><span class="lineNum">    5069 </span>            : </a>
<span class="lineNum">    5070 </span>            : bool
<span class="lineNum">    5071 </span><span class="lineNoCov">          0 : nsContentUtils::HasNonEmptyTextContent(nsINode* aNode,</span>
<span class="lineNum">    5072 </span>            :                                        TextContentDiscoverMode aDiscoverMode)
<span class="lineNum">    5073 </span>            : {
<span class="lineNum">    5074 </span><span class="lineNoCov">          0 :   for (nsIContent* child = aNode-&gt;GetFirstChild();</span>
<span class="lineNum">    5075 </span>            :        child;
<span class="lineNum">    5076 </span><span class="lineNoCov">          0 :        child = child-&gt;GetNextSibling()) {</span>
<span class="lineNum">    5077 </span><span class="lineNoCov">          0 :     if (child-&gt;IsNodeOfType(nsINode::eTEXT) &amp;&amp;</span>
<span class="lineNum">    5078 </span><span class="lineNoCov">          0 :         child-&gt;TextLength() &gt; 0) {</span>
<span class="lineNum">    5079 </span>            :         return true;
<span class="lineNum">    5080 </span>            :     }
<span class="lineNum">    5081 </span>            : 
<span class="lineNum">    5082 </span><span class="lineNoCov">          0 :     if (aDiscoverMode == eRecurseIntoChildren &amp;&amp;</span>
<span class="lineNum">    5083 </span><span class="lineNoCov">          0 :         HasNonEmptyTextContent(child, aDiscoverMode)) {</span>
<span class="lineNum">    5084 </span>            :       return true;
<span class="lineNum">    5085 </span>            :     }
<span class="lineNum">    5086 </span>            :   }
<span class="lineNum">    5087 </span>            : 
<span class="lineNum">    5088 </span>            :   return false;
<span class="lineNum">    5089 </span>            : }
<span class="lineNum">    5090 </span>            : 
<a name="5091"><span class="lineNum">    5091 </span>            : /* static */</a>
<span class="lineNum">    5092 </span>            : bool
<span class="lineNum">    5093 </span><span class="lineNoCov">          0 : nsContentUtils::IsInSameAnonymousTree(const nsINode* aNode,</span>
<span class="lineNum">    5094 </span>            :                                       const nsIContent* aContent)
<span class="lineNum">    5095 </span>            : {
<span class="lineNum">    5096 </span>            :   NS_PRECONDITION(aNode,
<span class="lineNum">    5097 </span>            :                   &quot;Must have a node to work with&quot;);
<span class="lineNum">    5098 </span>            :   NS_PRECONDITION(aContent,
<span class="lineNum">    5099 </span>            :                   &quot;Must have a content to work with&quot;);
<span class="lineNum">    5100 </span>            : 
<span class="lineNum">    5101 </span><span class="lineNoCov">          0 :   if (!aNode-&gt;IsNodeOfType(nsINode::eCONTENT)) {</span>
<span class="lineNum">    5102 </span>            :     /**
<span class="lineNum">    5103 </span>            :      * The root isn't an nsIContent, so it's a document or attribute.  The only
<span class="lineNum">    5104 </span>            :      * nodes in the same anonymous subtree as it will have a null
<span class="lineNum">    5105 </span>            :      * bindingParent.
<span class="lineNum">    5106 </span>            :      *
<span class="lineNum">    5107 </span>            :      * XXXbz strictly speaking, that's not true for attribute nodes.
<span class="lineNum">    5108 </span>            :      */
<span class="lineNum">    5109 </span><span class="lineNoCov">          0 :     return aContent-&gt;GetBindingParent() == nullptr;</span>
<span class="lineNum">    5110 </span>            :   }
<span class="lineNum">    5111 </span>            : 
<span class="lineNum">    5112 </span><span class="lineNoCov">          0 :   const nsIContent* nodeAsContent = static_cast&lt;const nsIContent*&gt;(aNode);</span>
<span class="lineNum">    5113 </span>            : 
<span class="lineNum">    5114 </span>            :   // For nodes in a shadow tree, it is insufficient to simply compare
<span class="lineNum">    5115 </span>            :   // the binding parent because a node may host multiple ShadowRoots,
<span class="lineNum">    5116 </span>            :   // thus nodes in different shadow tree may have the same binding parent.
<span class="lineNum">    5117 </span><span class="lineNoCov">          0 :   if (aNode-&gt;IsInShadowTree()) {</span>
<span class="lineNum">    5118 </span><span class="lineNoCov">          0 :     return nodeAsContent-&gt;GetContainingShadow() ==</span>
<span class="lineNum">    5119 </span><span class="lineNoCov">          0 :       aContent-&gt;GetContainingShadow();</span>
<span class="lineNum">    5120 </span>            :   }
<span class="lineNum">    5121 </span>            : 
<span class="lineNum">    5122 </span><span class="lineNoCov">          0 :   return nodeAsContent-&gt;GetBindingParent() == aContent-&gt;GetBindingParent();</span>
<a name="5123"><span class="lineNum">    5123 </span>            : }</a>
<span class="lineNum">    5124 </span>            : 
<span class="lineNum">    5125 </span><span class="lineNoCov">          0 : class AnonymousContentDestroyer : public Runnable {</span>
<span class="lineNum">    5126 </span>            : public:
<span class="lineNum">    5127 </span><span class="lineNoCov">          0 :   explicit AnonymousContentDestroyer(nsCOMPtr&lt;nsIContent&gt;* aContent) {</span>
<span class="lineNum">    5128 </span><span class="lineNoCov">          0 :     mContent.swap(*aContent);</span>
<span class="lineNum">    5129 </span><span class="lineNoCov">          0 :     mParent = mContent-&gt;GetParent();</span>
<span class="lineNum">    5130 </span><span class="lineNoCov">          0 :     mDoc = mContent-&gt;OwnerDoc();</span>
<span class="lineNum">    5131 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    5132 </span><span class="lineNoCov">          0 :   explicit AnonymousContentDestroyer(nsCOMPtr&lt;Element&gt;* aElement) {</span>
<span class="lineNum">    5133 </span><span class="lineNoCov">          0 :     mContent = aElement-&gt;forget();</span>
<span class="lineNum">    5134 </span><span class="lineNoCov">          0 :     mParent = mContent-&gt;GetParent();</span>
<span class="lineNum">    5135 </span><span class="lineNoCov">          0 :     mDoc = mContent-&gt;OwnerDoc();</span>
<span class="lineNum">    5136 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    5137 </span><span class="lineNoCov">          0 :   NS_IMETHOD Run() override {</span>
<span class="lineNum">    5138 </span><span class="lineNoCov">          0 :     mContent-&gt;UnbindFromTree();</span>
<span class="lineNum">    5139 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">    5140 </span>            :   }
<span class="lineNum">    5141 </span>            : private:
<span class="lineNum">    5142 </span>            :   nsCOMPtr&lt;nsIContent&gt; mContent;
<span class="lineNum">    5143 </span>            :   // Hold strong refs to the parent content and document so that they
<span class="lineNum">    5144 </span>            :   // don't die unexpectedly
<span class="lineNum">    5145 </span>            :   nsCOMPtr&lt;nsIDocument&gt; mDoc;
<span class="lineNum">    5146 </span>            :   nsCOMPtr&lt;nsIContent&gt; mParent;
<span class="lineNum">    5147 </span>            : };
<span class="lineNum">    5148 </span>            : 
<span class="lineNum">    5149 </span>            : /* static */
<span class="lineNum">    5150 </span>            : void
<span class="lineNum">    5151 </span><span class="lineNoCov">          0 : nsContentUtils::DestroyAnonymousContent(nsCOMPtr&lt;nsIContent&gt;* aContent)</span>
<span class="lineNum">    5152 </span>            : {
<span class="lineNum">    5153 </span><span class="lineNoCov">          0 :   if (*aContent) {</span>
<span class="lineNum">    5154 </span><span class="lineNoCov">          0 :     AddScriptRunner(new AnonymousContentDestroyer(aContent));</span>
<span class="lineNum">    5155 </span>            :   }
<span class="lineNum">    5156 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    5157 </span>            : 
<span class="lineNum">    5158 </span>            : /* static */
<span class="lineNum">    5159 </span>            : void
<span class="lineNum">    5160 </span><span class="lineNoCov">          0 : nsContentUtils::DestroyAnonymousContent(nsCOMPtr&lt;Element&gt;* aElement)</span>
<span class="lineNum">    5161 </span>            : {
<span class="lineNum">    5162 </span><span class="lineNoCov">          0 :   if (*aElement) {</span>
<span class="lineNum">    5163 </span><span class="lineNoCov">          0 :     AddScriptRunner(new AnonymousContentDestroyer(aElement));</span>
<span class="lineNum">    5164 </span>            :   }
<span class="lineNum">    5165 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    5166 </span>            : 
<a name="5167"><span class="lineNum">    5167 </span>            : /* static */</a>
<span class="lineNum">    5168 </span>            : void
<span class="lineNum">    5169 </span><span class="lineNoCov">          0 : nsContentUtils::NotifyInstalledMenuKeyboardListener(bool aInstalling)</span>
<span class="lineNum">    5170 </span>            : {
<span class="lineNum">    5171 </span><span class="lineNoCov">          0 :   IMEStateManager::OnInstalledMenuKeyboardListener(aInstalling);</span>
<span class="lineNum">    5172 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    5173 </span>            : 
<span class="lineNum">    5174 </span><span class="lineNoCov">          0 : static bool SchemeIs(nsIURI* aURI, const char* aScheme)</span>
<span class="lineNum">    5175 </span>            : {
<span class="lineNum">    5176 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIURI&gt; baseURI = NS_GetInnermostURI(aURI);</span>
<span class="lineNum">    5177 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(baseURI, false);</span>
<span class="lineNum">    5178 </span>            : 
<span class="lineNum">    5179 </span><span class="lineNoCov">          0 :   bool isScheme = false;</span>
<span class="lineNum">    5180 </span><span class="lineNoCov">          0 :   return NS_SUCCEEDED(baseURI-&gt;SchemeIs(aScheme, &amp;isScheme)) &amp;&amp; isScheme;</span>
<span class="lineNum">    5181 </span>            : }
<a name="5182"><span class="lineNum">    5182 </span>            : </a>
<span class="lineNum">    5183 </span>            : bool
<span class="lineNum">    5184 </span><span class="lineCov">       1318 : nsContentUtils::IsSystemPrincipal(nsIPrincipal* aPrincipal)</span>
<a name="5185"><span class="lineNum">    5185 </span>            : {</a>
<span class="lineNum">    5186 </span>            :   MOZ_ASSERT(IsInitialized());
<span class="lineNum">    5187 </span><span class="lineCov">       1318 :   return aPrincipal == sSystemPrincipal;</span>
<span class="lineNum">    5188 </span>            : }
<span class="lineNum">    5189 </span>            : 
<span class="lineNum">    5190 </span>            : bool
<span class="lineNum">    5191 </span><span class="lineCov">        120 : nsContentUtils::IsExpandedPrincipal(nsIPrincipal* aPrincipal)</span>
<span class="lineNum">    5192 </span>            : {
<span class="lineNum">    5193 </span><span class="lineCov">        120 :   nsCOMPtr&lt;nsIExpandedPrincipal&gt; ep = do_QueryInterface(aPrincipal);</span>
<span class="lineNum">    5194 </span><span class="lineCov">        240 :   return !!ep;</span>
<span class="lineNum">    5195 </span>            : }
<a name="5196"><span class="lineNum">    5196 </span>            : </a>
<span class="lineNum">    5197 </span>            : nsIPrincipal*
<span class="lineNum">    5198 </span><span class="lineCov">       1750 : nsContentUtils::GetSystemPrincipal()</span>
<span class="lineNum">    5199 </span>            : {
<span class="lineNum">    5200 </span>            :   MOZ_ASSERT(IsInitialized());
<span class="lineNum">    5201 </span><span class="lineCov">       1750 :   return sSystemPrincipal;</span>
<span class="lineNum">    5202 </span>            : }
<span class="lineNum">    5203 </span>            : 
<span class="lineNum">    5204 </span>            : bool
<span class="lineNum">    5205 </span><span class="lineNoCov">          0 : nsContentUtils::CombineResourcePrincipals(nsCOMPtr&lt;nsIPrincipal&gt;* aResourcePrincipal,</span>
<span class="lineNum">    5206 </span>            :                                           nsIPrincipal* aExtraPrincipal)
<span class="lineNum">    5207 </span>            : {
<span class="lineNum">    5208 </span><span class="lineNoCov">          0 :   if (!aExtraPrincipal) {</span>
<span class="lineNum">    5209 </span>            :     return false;
<span class="lineNum">    5210 </span>            :   }
<span class="lineNum">    5211 </span><span class="lineNoCov">          0 :   if (!*aResourcePrincipal) {</span>
<span class="lineNum">    5212 </span>            :     *aResourcePrincipal = aExtraPrincipal;
<span class="lineNum">    5213 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">    5214 </span>            :   }
<span class="lineNum">    5215 </span><span class="lineNoCov">          0 :   if (*aResourcePrincipal == aExtraPrincipal) {</span>
<span class="lineNum">    5216 </span>            :     return false;
<span class="lineNum">    5217 </span>            :   }
<span class="lineNum">    5218 </span>            :   bool subsumes;
<span class="lineNum">    5219 </span><span class="lineNoCov">          0 :   if (NS_SUCCEEDED((*aResourcePrincipal)-&gt;Subsumes(aExtraPrincipal, &amp;subsumes)) &amp;&amp;</span>
<span class="lineNum">    5220 </span>            :       subsumes) {
<span class="lineNum">    5221 </span>            :     return false;
<span class="lineNum">    5222 </span>            :   }
<span class="lineNum">    5223 </span><span class="lineNoCov">          0 :   *aResourcePrincipal = sSystemPrincipal;</span>
<span class="lineNum">    5224 </span><span class="lineNoCov">          0 :   return true;</span>
<span class="lineNum">    5225 </span>            : }
<span class="lineNum">    5226 </span>            : 
<span class="lineNum">    5227 </span>            : /* static */
<span class="lineNum">    5228 </span>            : void
<span class="lineNum">    5229 </span><span class="lineNoCov">          0 : nsContentUtils::TriggerLink(nsIContent *aContent, nsPresContext *aPresContext,</span>
<span class="lineNum">    5230 </span>            :                             nsIURI *aLinkURI, const nsString &amp;aTargetSpec,
<span class="lineNum">    5231 </span>            :                             bool aClick, bool aIsUserTriggered,
<span class="lineNum">    5232 </span>            :                             bool aIsTrusted)
<span class="lineNum">    5233 </span>            : {
<span class="lineNum">    5234 </span>            :   NS_ASSERTION(aPresContext, &quot;Need a nsPresContext&quot;);
<span class="lineNum">    5235 </span>            :   NS_PRECONDITION(aLinkURI, &quot;No link URI&quot;);
<span class="lineNum">    5236 </span>            : 
<span class="lineNum">    5237 </span><span class="lineNoCov">          0 :   if (aContent-&gt;IsEditable()) {</span>
<span class="lineNum">    5238 </span>            :     return;
<span class="lineNum">    5239 </span>            :   }
<span class="lineNum">    5240 </span>            : 
<span class="lineNum">    5241 </span><span class="lineNoCov">          0 :   nsILinkHandler *handler = aPresContext-&gt;GetLinkHandler();</span>
<span class="lineNum">    5242 </span><span class="lineNoCov">          0 :   if (!handler) {</span>
<span class="lineNum">    5243 </span>            :     return;
<span class="lineNum">    5244 </span>            :   }
<span class="lineNum">    5245 </span>            : 
<span class="lineNum">    5246 </span><span class="lineNoCov">          0 :   if (!aClick) {</span>
<span class="lineNum">    5247 </span><span class="lineNoCov">          0 :     handler-&gt;OnOverLink(aContent, aLinkURI, aTargetSpec.get());</span>
<span class="lineNum">    5248 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    5249 </span>            :   }
<span class="lineNum">    5250 </span>            : 
<span class="lineNum">    5251 </span>            :   // Check that this page is allowed to load this URI.
<span class="lineNum">    5252 </span><span class="lineNoCov">          0 :   nsresult proceed = NS_OK;</span>
<span class="lineNum">    5253 </span>            : 
<span class="lineNum">    5254 </span><span class="lineNoCov">          0 :   if (sSecurityManager) {</span>
<span class="lineNum">    5255 </span>            :     uint32_t flag =
<span class="lineNum">    5256 </span>            :       aIsUserTriggered ?
<span class="lineNum">    5257 </span>            :       (uint32_t)nsIScriptSecurityManager::STANDARD :
<span class="lineNum">    5258 </span><span class="lineNoCov">          0 :       (uint32_t)nsIScriptSecurityManager::LOAD_IS_AUTOMATIC_DOCUMENT_REPLACEMENT;</span>
<span class="lineNum">    5259 </span>            :     proceed =
<span class="lineNum">    5260 </span>            :       sSecurityManager-&gt;CheckLoadURIWithPrincipal(aContent-&gt;NodePrincipal(),
<span class="lineNum">    5261 </span><span class="lineNoCov">          0 :                                                   aLinkURI, flag);</span>
<span class="lineNum">    5262 </span>            :   }
<span class="lineNum">    5263 </span>            : 
<span class="lineNum">    5264 </span>            :   // Only pass off the click event if the script security manager says it's ok.
<span class="lineNum">    5265 </span>            :   // We need to rest aTargetSpec for forced downloads.
<span class="lineNum">    5266 </span><span class="lineNoCov">          0 :   if (NS_SUCCEEDED(proceed)) {</span>
<span class="lineNum">    5267 </span>            : 
<span class="lineNum">    5268 </span>            :     // A link/area element with a download attribute is allowed to set
<span class="lineNum">    5269 </span>            :     // a pseudo Content-Disposition header.
<span class="lineNum">    5270 </span>            :     // For security reasons we only allow websites to declare same-origin resources
<span class="lineNum">    5271 </span>            :     // as downloadable. If this check fails we will just do the normal thing
<span class="lineNum">    5272 </span>            :     // (i.e. navigate to the resource).
<span class="lineNum">    5273 </span><span class="lineNoCov">          0 :     nsAutoString fileName;</span>
<span class="lineNum">    5274 </span><span class="lineNoCov">          0 :     if ((!aContent-&gt;IsHTMLElement(nsGkAtoms::a) &amp;&amp;</span>
<span class="lineNum">    5275 </span><span class="lineNoCov">          0 :          !aContent-&gt;IsHTMLElement(nsGkAtoms::area) &amp;&amp;</span>
<span class="lineNum">    5276 </span><span class="lineNoCov">          0 :          !aContent-&gt;IsSVGElement(nsGkAtoms::a)) ||</span>
<span class="lineNum">    5277 </span><span class="lineNoCov">          0 :         !aContent-&gt;GetAttr(kNameSpaceID_None, nsGkAtoms::download, fileName) ||</span>
<span class="lineNum">    5278 </span><span class="lineNoCov">          0 :         NS_FAILED(aContent-&gt;NodePrincipal()-&gt;CheckMayLoad(aLinkURI, false, true))) {</span>
<span class="lineNum">    5279 </span><span class="lineNoCov">          0 :       fileName.SetIsVoid(true); // No actionable download attribute was found.</span>
<span class="lineNum">    5280 </span>            :     }
<span class="lineNum">    5281 </span>            : 
<span class="lineNum">    5282 </span>            :     handler-&gt;OnLinkClick(aContent, aLinkURI,
<span class="lineNum">    5283 </span><span class="lineNoCov">          0 :                          fileName.IsVoid() ? aTargetSpec.get() : EmptyString().get(),</span>
<span class="lineNum">    5284 </span><span class="lineNoCov">          0 :                          fileName, nullptr, nullptr, aIsTrusted, aContent-&gt;NodePrincipal());</span>
<span class="lineNum">    5285 </span>            :   }
<span class="lineNum">    5286 </span>            : }
<span class="lineNum">    5287 </span>            : 
<span class="lineNum">    5288 </span>            : /* static */
<span class="lineNum">    5289 </span>            : void
<span class="lineNum">    5290 </span><span class="lineNoCov">          0 : nsContentUtils::GetLinkLocation(Element* aElement, nsString&amp; aLocationString)</span>
<span class="lineNum">    5291 </span>            : {
<span class="lineNum">    5292 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIURI&gt; hrefURI = aElement-&gt;GetHrefURI();</span>
<span class="lineNum">    5293 </span><span class="lineNoCov">          0 :   if (hrefURI) {</span>
<span class="lineNum">    5294 </span><span class="lineNoCov">          0 :     nsAutoCString specUTF8;</span>
<span class="lineNum">    5295 </span><span class="lineNoCov">          0 :     nsresult rv = hrefURI-&gt;GetSpec(specUTF8);</span>
<span class="lineNum">    5296 </span><span class="lineNoCov">          0 :     if (NS_SUCCEEDED(rv))</span>
<span class="lineNum">    5297 </span><span class="lineNoCov">          0 :       CopyUTF8toUTF16(specUTF8, aLocationString);</span>
<span class="lineNum">    5298 </span>            :   }
<span class="lineNum">    5299 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    5300 </span>            : 
<a name="5301"><span class="lineNum">    5301 </span>            : /* static */</a>
<span class="lineNum">    5302 </span>            : nsIWidget*
<span class="lineNum">    5303 </span><span class="lineNoCov">          0 : nsContentUtils::GetTopLevelWidget(nsIWidget* aWidget)</span>
<span class="lineNum">    5304 </span>            : {
<span class="lineNum">    5305 </span><span class="lineNoCov">          0 :   if (!aWidget)</span>
<span class="lineNum">    5306 </span>            :     return nullptr;
<span class="lineNum">    5307 </span>            : 
<span class="lineNum">    5308 </span><span class="lineNoCov">          0 :   return aWidget-&gt;GetTopLevelWidget();</span>
<span class="lineNum">    5309 </span>            : }
<span class="lineNum">    5310 </span>            : 
<a name="5311"><span class="lineNum">    5311 </span>            : /* static */</a>
<span class="lineNum">    5312 </span>            : const nsDependentString
<span class="lineNum">    5313 </span><span class="lineNoCov">          0 : nsContentUtils::GetLocalizedEllipsis()</span>
<span class="lineNum">    5314 </span>            : {
<span class="lineNum">    5315 </span>            :   static char16_t sBuf[4] = { 0, 0, 0, 0 };
<span class="lineNum">    5316 </span><span class="lineNoCov">          0 :   if (!sBuf[0]) {</span>
<span class="lineNum">    5317 </span><span class="lineNoCov">          0 :     nsAdoptingString tmp = Preferences::GetLocalizedString(&quot;intl.ellipsis&quot;);</span>
<span class="lineNum">    5318 </span><span class="lineNoCov">          0 :     uint32_t len = std::min(uint32_t(tmp.Length()),</span>
<span class="lineNum">    5319 </span><span class="lineNoCov">          0 :                           uint32_t(ArrayLength(sBuf) - 1));</span>
<span class="lineNum">    5320 </span><span class="lineNoCov">          0 :     CopyUnicodeTo(tmp, 0, sBuf, len);</span>
<span class="lineNum">    5321 </span><span class="lineNoCov">          0 :     if (!sBuf[0])</span>
<span class="lineNum">    5322 </span><span class="lineNoCov">          0 :       sBuf[0] = char16_t(0x2026);</span>
<span class="lineNum">    5323 </span>            :   }
<span class="lineNum">    5324 </span><span class="lineNoCov">          0 :   return nsDependentString(sBuf);</span>
<span class="lineNum">    5325 </span>            : }
<span class="lineNum">    5326 </span>            : 
<a name="5327"><span class="lineNum">    5327 </span>            : /* static */</a>
<span class="lineNum">    5328 </span>            : void
<span class="lineNum">    5329 </span><span class="lineCov">        635 : nsContentUtils::AddScriptBlocker()</span>
<span class="lineNum">    5330 </span>            : {
<span class="lineNum">    5331 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    5332 </span><span class="lineCov">        635 :   if (!sScriptBlockerCount) {</span>
<span class="lineNum">    5333 </span>            :     MOZ_ASSERT(sRunnersCountAtFirstBlocker == 0,
<span class="lineNum">    5334 </span>            :                &quot;Should not already have a count&quot;);
<span class="lineNum">    5335 </span><span class="lineCov">       1270 :     sRunnersCountAtFirstBlocker = sBlockedScriptRunners ? sBlockedScriptRunners-&gt;Length() : 0;</span>
<span class="lineNum">    5336 </span>            :   }
<span class="lineNum">    5337 </span><span class="lineCov">        635 :   ++sScriptBlockerCount;</span>
<span class="lineNum">    5338 </span><span class="lineCov">        635 : }</span>
<span class="lineNum">    5339 </span>            : 
<span class="lineNum">    5340 </span>            : #ifdef DEBUG
<span class="lineNum">    5341 </span>            : static bool sRemovingScriptBlockers = false;
<span class="lineNum">    5342 </span>            : #endif
<span class="lineNum">    5343 </span>            : 
<span class="lineNum">    5344 </span>            : /* static */
<span class="lineNum">    5345 </span>            : void
<span class="lineNum">    5346 </span><span class="lineCov">        635 : nsContentUtils::RemoveScriptBlocker()</span>
<span class="lineNum">    5347 </span>            : {
<span class="lineNum">    5348 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    5349 </span>            :   MOZ_ASSERT(!sRemovingScriptBlockers);
<span class="lineNum">    5350 </span>            :   NS_ASSERTION(sScriptBlockerCount != 0, &quot;Negative script blockers&quot;);
<span class="lineNum">    5351 </span><span class="lineCov">        635 :   --sScriptBlockerCount;</span>
<span class="lineNum">    5352 </span><span class="lineCov">        635 :   if (sScriptBlockerCount) {</span>
<span class="lineNum">    5353 </span>            :     return;
<span class="lineNum">    5354 </span>            :   }
<span class="lineNum">    5355 </span>            : 
<span class="lineNum">    5356 </span><span class="lineCov">        635 :   if (!sBlockedScriptRunners) {</span>
<span class="lineNum">    5357 </span>            :     return;
<span class="lineNum">    5358 </span>            :   }
<span class="lineNum">    5359 </span>            : 
<span class="lineNum">    5360 </span><span class="lineCov">        635 :   uint32_t firstBlocker = sRunnersCountAtFirstBlocker;</span>
<span class="lineNum">    5361 </span><span class="lineCov">       1270 :   uint32_t lastBlocker = sBlockedScriptRunners-&gt;Length();</span>
<span class="lineNum">    5362 </span><span class="lineCov">        635 :   uint32_t originalFirstBlocker = firstBlocker;</span>
<span class="lineNum">    5363 </span><span class="lineCov">        635 :   uint32_t blockersCount = lastBlocker - firstBlocker;</span>
<span class="lineNum">    5364 </span><span class="lineCov">        635 :   sRunnersCountAtFirstBlocker = 0;</span>
<span class="lineNum">    5365 </span>            :   NS_ASSERTION(firstBlocker &lt;= lastBlocker,
<span class="lineNum">    5366 </span>            :                &quot;bad sRunnersCountAtFirstBlocker&quot;);
<span class="lineNum">    5367 </span>            : 
<span class="lineNum">    5368 </span><span class="lineCov">       1270 :   while (firstBlocker &lt; lastBlocker) {</span>
<span class="lineNum">    5369 </span>            :     nsCOMPtr&lt;nsIRunnable&gt; runnable;
<span class="lineNum">    5370 </span><span class="lineNoCov">          0 :     runnable.swap((*sBlockedScriptRunners)[firstBlocker]);</span>
<span class="lineNum">    5371 </span><span class="lineNoCov">          0 :     ++firstBlocker;</span>
<span class="lineNum">    5372 </span>            : 
<span class="lineNum">    5373 </span>            :     // Calling the runnable can reenter us
<span class="lineNum">    5374 </span><span class="lineNoCov">          0 :     runnable-&gt;Run();</span>
<span class="lineNum">    5375 </span>            :     // So can dropping the reference to the runnable
<span class="lineNum">    5376 </span><span class="lineNoCov">          0 :     runnable = nullptr;</span>
<span class="lineNum">    5377 </span>            : 
<span class="lineNum">    5378 </span>            :     NS_ASSERTION(sRunnersCountAtFirstBlocker == 0,
<span class="lineNum">    5379 </span>            :                  &quot;Bad count&quot;);
<span class="lineNum">    5380 </span>            :     NS_ASSERTION(!sScriptBlockerCount, &quot;This is really bad&quot;);
<span class="lineNum">    5381 </span>            :   }
<span class="lineNum">    5382 </span>            : #ifdef DEBUG
<span class="lineNum">    5383 </span>            :   AutoRestore&lt;bool&gt; removingScriptBlockers(sRemovingScriptBlockers);
<span class="lineNum">    5384 </span>            :   sRemovingScriptBlockers = true;
<span class="lineNum">    5385 </span>            : #endif
<span class="lineNum">    5386 </span><span class="lineCov">        635 :   sBlockedScriptRunners-&gt;RemoveElementsAt(originalFirstBlocker, blockersCount);</span>
<span class="lineNum">    5387 </span>            : }
<span class="lineNum">    5388 </span>            : 
<a name="5389"><span class="lineNum">    5389 </span>            : /* static */</a>
<span class="lineNum">    5390 </span>            : nsIWindowProvider*
<span class="lineNum">    5391 </span><span class="lineNoCov">          0 : nsContentUtils::GetWindowProviderForContentProcess()</span>
<span class="lineNum">    5392 </span>            : {
<span class="lineNum">    5393 </span>            :   MOZ_ASSERT(XRE_IsContentProcess());
<span class="lineNum">    5394 </span><span class="lineNoCov">          0 :   return ContentChild::GetSingleton();</span>
<span class="lineNum">    5395 </span>            : }
<span class="lineNum">    5396 </span>            : 
<span class="lineNum">    5397 </span>            : /* static */
<span class="lineNum">    5398 </span>            : already_AddRefed&lt;nsPIDOMWindowOuter&gt;
<span class="lineNum">    5399 </span><span class="lineNoCov">          0 : nsContentUtils::GetMostRecentNonPBWindow()</span>
<span class="lineNum">    5400 </span>            : {
<span class="lineNum">    5401 </span>            :   nsCOMPtr&lt;nsIWindowMediator&gt; windowMediator =
<span class="lineNum">    5402 </span><span class="lineNoCov">          0 :     do_GetService(NS_WINDOWMEDIATOR_CONTRACTID);</span>
<span class="lineNum">    5403 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIWindowMediator_44&gt; wm = do_QueryInterface(windowMediator);</span>
<span class="lineNum">    5404 </span>            : 
<span class="lineNum">    5405 </span>            :   nsCOMPtr&lt;mozIDOMWindowProxy&gt; window;
<span class="lineNum">    5406 </span>            :   wm-&gt;GetMostRecentNonPBWindow(u&quot;navigator:browser&quot;,
<span class="lineNum">    5407 </span><span class="lineNoCov">          0 :                                getter_AddRefs(window));</span>
<span class="lineNum">    5408 </span>            :   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; pwindow;
<span class="lineNum">    5409 </span><span class="lineNoCov">          0 :   pwindow = do_QueryInterface(window);</span>
<span class="lineNum">    5410 </span>            : 
<span class="lineNum">    5411 </span><span class="lineNoCov">          0 :   return pwindow.forget();</span>
<span class="lineNum">    5412 </span>            : }
<span class="lineNum">    5413 </span>            : 
<span class="lineNum">    5414 </span>            : /* static */
<span class="lineNum">    5415 </span>            : void
<span class="lineNum">    5416 </span><span class="lineNoCov">          0 : nsContentUtils::WarnScriptWasIgnored(nsIDocument* aDocument)</span>
<span class="lineNum">    5417 </span>            : {
<span class="lineNum">    5418 </span><span class="lineNoCov">          0 :   nsAutoString msg;</span>
<span class="lineNum">    5419 </span><span class="lineNoCov">          0 :   if (aDocument) {</span>
<span class="lineNum">    5420 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIURI&gt; uri = aDocument-&gt;GetDocumentURI();</span>
<span class="lineNum">    5421 </span><span class="lineNoCov">          0 :     if (uri) {</span>
<span class="lineNum">    5422 </span><span class="lineNoCov">          0 :       msg.Append(NS_ConvertUTF8toUTF16(uri-&gt;GetSpecOrDefault()));</span>
<span class="lineNum">    5423 </span><span class="lineNoCov">          0 :       msg.AppendLiteral(&quot; : &quot;);</span>
<span class="lineNum">    5424 </span>            :     }
<span class="lineNum">    5425 </span>            :   }
<span class="lineNum">    5426 </span><span class="lineNoCov">          0 :   msg.AppendLiteral(&quot;Unable to run script because scripts are blocked internally.&quot;);</span>
<span class="lineNum">    5427 </span>            : 
<span class="lineNum">    5428 </span><span class="lineNoCov">          0 :   LogSimpleConsoleError(msg, &quot;DOM&quot;);</span>
<span class="lineNum">    5429 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    5430 </span>            : 
<span class="lineNum">    5431 </span>            : /* static */
<span class="lineNum">    5432 </span>            : void
<span class="lineNum">    5433 </span><span class="lineNoCov">          0 : nsContentUtils::AddScriptRunner(already_AddRefed&lt;nsIRunnable&gt; aRunnable)</span>
<span class="lineNum">    5434 </span>            : {
<span class="lineNum">    5435 </span>            :   nsCOMPtr&lt;nsIRunnable&gt; runnable = aRunnable;
<span class="lineNum">    5436 </span><span class="lineNoCov">          0 :   if (!runnable) {</span>
<span class="lineNum">    5437 </span>            :     return;
<span class="lineNum">    5438 </span>            :   }
<span class="lineNum">    5439 </span>            : 
<span class="lineNum">    5440 </span><span class="lineNoCov">          0 :   if (sScriptBlockerCount) {</span>
<span class="lineNum">    5441 </span><span class="lineNoCov">          0 :     sBlockedScriptRunners-&gt;AppendElement(runnable.forget());</span>
<span class="lineNum">    5442 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    5443 </span>            :   }
<span class="lineNum">    5444 </span>            : 
<span class="lineNum">    5445 </span><span class="lineNoCov">          0 :   runnable-&gt;Run();</span>
<span class="lineNum">    5446 </span>            : }
<span class="lineNum">    5447 </span>            : 
<span class="lineNum">    5448 </span>            : /* static */
<span class="lineNum">    5449 </span>            : void
<span class="lineNum">    5450 </span><span class="lineNoCov">          0 : nsContentUtils::AddScriptRunner(nsIRunnable* aRunnable) {</span>
<span class="lineNum">    5451 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIRunnable&gt; runnable = aRunnable;</span>
<span class="lineNum">    5452 </span><span class="lineNoCov">          0 :   AddScriptRunner(runnable.forget());</span>
<span class="lineNum">    5453 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    5454 </span>            : 
<a name="5455"><span class="lineNum">    5455 </span>            : /* static */</a>
<span class="lineNum">    5456 </span>            : void
<span class="lineNum">    5457 </span><span class="lineNoCov">          0 : nsContentUtils::RunInStableState(already_AddRefed&lt;nsIRunnable&gt; aRunnable)</span>
<span class="lineNum">    5458 </span>            : {
<span class="lineNum">    5459 </span>            :   MOZ_ASSERT(CycleCollectedJSContext::Get(), &quot;Must be on a script thread!&quot;);
<span class="lineNum">    5460 </span><span class="lineNoCov">          0 :   CycleCollectedJSContext::Get()-&gt;RunInStableState(Move(aRunnable));</span>
<span class="lineNum">    5461 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    5462 </span>            : 
<a name="5463"><span class="lineNum">    5463 </span>            : /* static */</a>
<span class="lineNum">    5464 </span>            : void
<span class="lineNum">    5465 </span><span class="lineNoCov">          0 : nsContentUtils::RunInMetastableState(already_AddRefed&lt;nsIRunnable&gt; aRunnable)</span>
<span class="lineNum">    5466 </span>            : {
<span class="lineNum">    5467 </span>            :   MOZ_ASSERT(CycleCollectedJSContext::Get(), &quot;Must be on a script thread!&quot;);
<span class="lineNum">    5468 </span><span class="lineNoCov">          0 :   CycleCollectedJSContext::Get()-&gt;RunInMetastableState(Move(aRunnable));</span>
<span class="lineNum">    5469 </span><span class="lineNoCov">          0 : }</span>
<a name="5470"><span class="lineNum">    5470 </span>            : </a>
<span class="lineNum">    5471 </span>            : void
<span class="lineNum">    5472 </span><span class="lineCov">        272 : nsContentUtils::EnterMicroTask()</span>
<span class="lineNum">    5473 </span>            : {
<span class="lineNum">    5474 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    5475 </span><span class="lineCov">        272 :   ++sMicroTaskLevel;</span>
<span class="lineNum">    5476 </span><span class="lineCov">        272 : }</span>
<a name="5477"><span class="lineNum">    5477 </span>            : </a>
<span class="lineNum">    5478 </span>            : void
<span class="lineNum">    5479 </span><span class="lineCov">        272 : nsContentUtils::LeaveMicroTask()</span>
<span class="lineNum">    5480 </span>            : {
<span class="lineNum">    5481 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    5482 </span><span class="lineCov">        272 :   if (--sMicroTaskLevel == 0) {</span>
<span class="lineNum">    5483 </span>            :     PerformMainThreadMicroTaskCheckpoint();
<span class="lineNum">    5484 </span>            :   }
<span class="lineNum">    5485 </span><span class="lineCov">        272 : }</span>
<a name="5486"><span class="lineNum">    5486 </span>            : </a>
<span class="lineNum">    5487 </span>            : bool
<span class="lineNum">    5488 </span><span class="lineNoCov">          0 : nsContentUtils::IsInMicroTask()</span>
<span class="lineNum">    5489 </span>            : {
<span class="lineNum">    5490 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    5491 </span><span class="lineNoCov">          0 :   return sMicroTaskLevel != 0;</span>
<span class="lineNum">    5492 </span>            : }
<a name="5493"><span class="lineNum">    5493 </span>            : </a>
<span class="lineNum">    5494 </span>            : uint32_t
<span class="lineNum">    5495 </span><span class="lineNoCov">          0 : nsContentUtils::MicroTaskLevel()</span>
<span class="lineNum">    5496 </span>            : {
<span class="lineNum">    5497 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    5498 </span><span class="lineNoCov">          0 :   return sMicroTaskLevel;</span>
<span class="lineNum">    5499 </span>            : }
<a name="5500"><span class="lineNum">    5500 </span>            : </a>
<span class="lineNum">    5501 </span>            : void
<span class="lineNum">    5502 </span><span class="lineNoCov">          0 : nsContentUtils::SetMicroTaskLevel(uint32_t aLevel)</span>
<span class="lineNum">    5503 </span>            : {
<span class="lineNum">    5504 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    5505 </span><span class="lineNoCov">          0 :   sMicroTaskLevel = aLevel;</span>
<span class="lineNum">    5506 </span><span class="lineNoCov">          0 : }</span>
<a name="5507"><span class="lineNum">    5507 </span>            : </a>
<span class="lineNum">    5508 </span>            : void
<span class="lineNum">    5509 </span><span class="lineCov">       1371 : nsContentUtils::PerformMainThreadMicroTaskCheckpoint()</span>
<span class="lineNum">    5510 </span>            : {
<span class="lineNum">    5511 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    5512 </span>            : 
<span class="lineNum">    5513 </span><span class="lineCov">       1643 :   nsDOMMutationObserver::HandleMutations();</span>
<span class="lineNum">    5514 </span><span class="lineCov">       1371 : }</span>
<span class="lineNum">    5515 </span>            : 
<span class="lineNum">    5516 </span>            : /*
<span class="lineNum">    5517 </span>            :  * Helper function for nsContentUtils::ProcessViewportInfo.
<span class="lineNum">    5518 </span>            :  *
<span class="lineNum">    5519 </span>            :  * Handles a single key=value pair. If it corresponds to a valid viewport
<span class="lineNum">    5520 </span>            :  * attribute, add it to the document header data. No validation is done on the
<span class="lineNum">    5521 </span>            :  * value itself (this is done at display time).
<span class="lineNum">    5522 </span>            :  */
<span class="lineNum">    5523 </span><span class="lineNoCov">          0 : static void ProcessViewportToken(nsIDocument *aDocument,</span>
<span class="lineNum">    5524 </span>            :                                  const nsAString &amp;token) {
<span class="lineNum">    5525 </span>            : 
<span class="lineNum">    5526 </span>            :   /* Iterators. */
<span class="lineNum">    5527 </span>            :   nsAString::const_iterator tip, tail, end;
<span class="lineNum">    5528 </span><span class="lineNoCov">          0 :   token.BeginReading(tip);</span>
<span class="lineNum">    5529 </span><span class="lineNoCov">          0 :   tail = tip;</span>
<span class="lineNum">    5530 </span><span class="lineNoCov">          0 :   token.EndReading(end);</span>
<span class="lineNum">    5531 </span>            : 
<span class="lineNum">    5532 </span>            :   /* Move tip to the '='. */
<span class="lineNum">    5533 </span><span class="lineNoCov">          0 :   while ((tip != end) &amp;&amp; (*tip != '='))</span>
<span class="lineNum">    5534 </span>            :     ++tip;
<span class="lineNum">    5535 </span>            : 
<span class="lineNum">    5536 </span>            :   /* If we didn't find an '=', punt. */
<span class="lineNum">    5537 </span><span class="lineNoCov">          0 :   if (tip == end)</span>
<span class="lineNum">    5538 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    5539 </span>            : 
<span class="lineNum">    5540 </span>            :   /* Extract the key and value. */
<span class="lineNum">    5541 </span>            :   const nsAString &amp;key =
<span class="lineNum">    5542 </span>            :     nsContentUtils::TrimWhitespace&lt;nsCRT::IsAsciiSpace&gt;(Substring(tail, tip),
<span class="lineNum">    5543 </span><span class="lineNoCov">          0 :                                                         true);</span>
<span class="lineNum">    5544 </span>            :   const nsAString &amp;value =
<span class="lineNum">    5545 </span><span class="lineNoCov">          0 :     nsContentUtils::TrimWhitespace&lt;nsCRT::IsAsciiSpace&gt;(Substring(++tip, end),</span>
<span class="lineNum">    5546 </span><span class="lineNoCov">          0 :                                                         true);</span>
<span class="lineNum">    5547 </span>            : 
<span class="lineNum">    5548 </span>            :   /* Check for known keys. If we find a match, insert the appropriate
<span class="lineNum">    5549 </span>            :    * information into the document header. */
<span class="lineNum">    5550 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIAtom&gt; key_atom = NS_Atomize(key);</span>
<span class="lineNum">    5551 </span><span class="lineNoCov">          0 :   if (key_atom == nsGkAtoms::height)</span>
<span class="lineNum">    5552 </span><span class="lineNoCov">          0 :     aDocument-&gt;SetHeaderData(nsGkAtoms::viewport_height, value);</span>
<span class="lineNum">    5553 </span><span class="lineNoCov">          0 :   else if (key_atom == nsGkAtoms::width)</span>
<span class="lineNum">    5554 </span><span class="lineNoCov">          0 :     aDocument-&gt;SetHeaderData(nsGkAtoms::viewport_width, value);</span>
<span class="lineNum">    5555 </span><span class="lineNoCov">          0 :   else if (key_atom == nsGkAtoms::initial_scale)</span>
<span class="lineNum">    5556 </span><span class="lineNoCov">          0 :     aDocument-&gt;SetHeaderData(nsGkAtoms::viewport_initial_scale, value);</span>
<span class="lineNum">    5557 </span><span class="lineNoCov">          0 :   else if (key_atom == nsGkAtoms::minimum_scale)</span>
<span class="lineNum">    5558 </span><span class="lineNoCov">          0 :     aDocument-&gt;SetHeaderData(nsGkAtoms::viewport_minimum_scale, value);</span>
<span class="lineNum">    5559 </span><span class="lineNoCov">          0 :   else if (key_atom == nsGkAtoms::maximum_scale)</span>
<span class="lineNum">    5560 </span><span class="lineNoCov">          0 :     aDocument-&gt;SetHeaderData(nsGkAtoms::viewport_maximum_scale, value);</span>
<span class="lineNum">    5561 </span><span class="lineNoCov">          0 :   else if (key_atom == nsGkAtoms::user_scalable)</span>
<span class="lineNum">    5562 </span><span class="lineNoCov">          0 :     aDocument-&gt;SetHeaderData(nsGkAtoms::viewport_user_scalable, value);</span>
<span class="lineNum">    5563 </span>            : }
<span class="lineNum">    5564 </span>            : 
<span class="lineNum">    5565 </span>            : #define IS_SEPARATOR(c) ((c == '=') || (c == ',') || (c == ';') || \
<span class="lineNum">    5566 </span>            :                          (c == '\t') || (c == '\n') || (c == '\r'))
<span class="lineNum">    5567 </span>            : 
<a name="5568"><span class="lineNum">    5568 </span>            : /* static */</a>
<span class="lineNum">    5569 </span>            : nsresult
<span class="lineNum">    5570 </span><span class="lineNoCov">          0 : nsContentUtils::ProcessViewportInfo(nsIDocument *aDocument,</span>
<span class="lineNum">    5571 </span>            :                                     const nsAString &amp;viewportInfo) {
<span class="lineNum">    5572 </span>            : 
<span class="lineNum">    5573 </span>            :   /* We never fail. */
<span class="lineNum">    5574 </span><span class="lineNoCov">          0 :   nsresult rv = NS_OK;</span>
<span class="lineNum">    5575 </span>            : 
<span class="lineNum">    5576 </span><span class="lineNoCov">          0 :   aDocument-&gt;SetHeaderData(nsGkAtoms::viewport, viewportInfo);</span>
<span class="lineNum">    5577 </span>            : 
<span class="lineNum">    5578 </span>            :   /* Iterators. */
<span class="lineNum">    5579 </span>            :   nsAString::const_iterator tip, tail, end;
<span class="lineNum">    5580 </span><span class="lineNoCov">          0 :   viewportInfo.BeginReading(tip);</span>
<span class="lineNum">    5581 </span><span class="lineNoCov">          0 :   tail = tip;</span>
<span class="lineNum">    5582 </span><span class="lineNoCov">          0 :   viewportInfo.EndReading(end);</span>
<span class="lineNum">    5583 </span>            : 
<span class="lineNum">    5584 </span>            :   /* Read the tip to the first non-separator character. */
<span class="lineNum">    5585 </span><span class="lineNoCov">          0 :   while ((tip != end) &amp;&amp; (IS_SEPARATOR(*tip) || nsCRT::IsAsciiSpace(*tip)))</span>
<span class="lineNum">    5586 </span>            :     ++tip;
<span class="lineNum">    5587 </span>            : 
<span class="lineNum">    5588 </span>            :   /* Read through and find tokens separated by separators. */
<span class="lineNum">    5589 </span><span class="lineNoCov">          0 :   while (tip != end) {</span>
<span class="lineNum">    5590 </span>            : 
<span class="lineNum">    5591 </span>            :     /* Synchronize tip and tail. */
<span class="lineNum">    5592 </span>            :     tail = tip;
<span class="lineNum">    5593 </span>            : 
<span class="lineNum">    5594 </span>            :     /* Advance tip past non-separator characters. */
<span class="lineNum">    5595 </span><span class="lineNoCov">          0 :     while ((tip != end) &amp;&amp; !IS_SEPARATOR(*tip))</span>
<span class="lineNum">    5596 </span>            :       ++tip;
<span class="lineNum">    5597 </span>            : 
<span class="lineNum">    5598 </span>            :     /* Allow white spaces that surround the '=' character */
<span class="lineNum">    5599 </span><span class="lineNoCov">          0 :     if ((tip != end) &amp;&amp; (*tip == '=')) {</span>
<span class="lineNum">    5600 </span>            :       ++tip;
<span class="lineNum">    5601 </span>            : 
<span class="lineNum">    5602 </span><span class="lineNoCov">          0 :       while ((tip != end) &amp;&amp; nsCRT::IsAsciiSpace(*tip))</span>
<span class="lineNum">    5603 </span>            :         ++tip;
<span class="lineNum">    5604 </span>            : 
<span class="lineNum">    5605 </span><span class="lineNoCov">          0 :       while ((tip != end) &amp;&amp; !(IS_SEPARATOR(*tip) || nsCRT::IsAsciiSpace(*tip)))</span>
<span class="lineNum">    5606 </span>            :         ++tip;
<span class="lineNum">    5607 </span>            :     }
<span class="lineNum">    5608 </span>            : 
<span class="lineNum">    5609 </span>            :     /* Our token consists of the characters between tail and tip. */
<span class="lineNum">    5610 </span><span class="lineNoCov">          0 :     ProcessViewportToken(aDocument, Substring(tail, tip));</span>
<span class="lineNum">    5611 </span>            : 
<span class="lineNum">    5612 </span>            :     /* Skip separators. */
<span class="lineNum">    5613 </span><span class="lineNoCov">          0 :     while ((tip != end) &amp;&amp; (IS_SEPARATOR(*tip) || nsCRT::IsAsciiSpace(*tip)))</span>
<span class="lineNum">    5614 </span>            :       ++tip;
<span class="lineNum">    5615 </span>            :   }
<span class="lineNum">    5616 </span>            : 
<span class="lineNum">    5617 </span><span class="lineNoCov">          0 :   return rv;</span>
<span class="lineNum">    5618 </span>            : 
<span class="lineNum">    5619 </span>            : }
<span class="lineNum">    5620 </span>            : 
<span class="lineNum">    5621 </span>            : #undef IS_SEPARATOR
<span class="lineNum">    5622 </span>            : 
<span class="lineNum">    5623 </span>            : /* static */
<span class="lineNum">    5624 </span>            : void
<span class="lineNum">    5625 </span><span class="lineNoCov">          0 : nsContentUtils::HidePopupsInDocument(nsIDocument* aDocument)</span>
<span class="lineNum">    5626 </span>            : {
<span class="lineNum">    5627 </span>            : #ifdef MOZ_XUL
<span class="lineNum">    5628 </span><span class="lineNoCov">          0 :   nsXULPopupManager* pm = nsXULPopupManager::GetInstance();</span>
<span class="lineNum">    5629 </span><span class="lineNoCov">          0 :   if (pm &amp;&amp; aDocument) {</span>
<span class="lineNum">    5630 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellToHide = aDocument-&gt;GetDocShell();</span>
<span class="lineNum">    5631 </span><span class="lineNoCov">          0 :     if (docShellToHide)</span>
<span class="lineNum">    5632 </span><span class="lineNoCov">          0 :       pm-&gt;HidePopupsInDocShell(docShellToHide);</span>
<span class="lineNum">    5633 </span>            :   }
<span class="lineNum">    5634 </span>            : #endif
<span class="lineNum">    5635 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    5636 </span>            : 
<span class="lineNum">    5637 </span>            : /* static */
<span class="lineNum">    5638 </span>            : already_AddRefed&lt;nsIDragSession&gt;
<span class="lineNum">    5639 </span><span class="lineNoCov">          0 : nsContentUtils::GetDragSession()</span>
<span class="lineNum">    5640 </span>            : {
<span class="lineNum">    5641 </span>            :   nsCOMPtr&lt;nsIDragSession&gt; dragSession;
<span class="lineNum">    5642 </span>            :   nsCOMPtr&lt;nsIDragService&gt; dragService =
<span class="lineNum">    5643 </span><span class="lineNoCov">          0 :     do_GetService(&quot;@mozilla.org/widget/dragservice;1&quot;);</span>
<span class="lineNum">    5644 </span><span class="lineNoCov">          0 :   if (dragService)</span>
<span class="lineNum">    5645 </span><span class="lineNoCov">          0 :     dragService-&gt;GetCurrentSession(getter_AddRefs(dragSession));</span>
<span class="lineNum">    5646 </span><span class="lineNoCov">          0 :   return dragSession.forget();</span>
<span class="lineNum">    5647 </span>            : }
<span class="lineNum">    5648 </span>            : 
<span class="lineNum">    5649 </span>            : /* static */
<span class="lineNum">    5650 </span>            : nsresult
<span class="lineNum">    5651 </span><span class="lineNoCov">          0 : nsContentUtils::SetDataTransferInEvent(WidgetDragEvent* aDragEvent)</span>
<span class="lineNum">    5652 </span>            : {
<span class="lineNum">    5653 </span><span class="lineNoCov">          0 :   if (aDragEvent-&gt;mDataTransfer || !aDragEvent-&gt;IsTrusted()) {</span>
<span class="lineNum">    5654 </span>            :     return NS_OK;
<span class="lineNum">    5655 </span>            :   }
<span class="lineNum">    5656 </span>            : 
<span class="lineNum">    5657 </span>            :   // For dragstart events, the data transfer object is
<span class="lineNum">    5658 </span>            :   // created before the event fires, so it should already be set. For other
<span class="lineNum">    5659 </span>            :   // drag events, get the object from the drag session.
<span class="lineNum">    5660 </span>            :   NS_ASSERTION(aDragEvent-&gt;mMessage != eDragStart,
<span class="lineNum">    5661 </span>            :                &quot;draggesture event created without a dataTransfer&quot;);
<span class="lineNum">    5662 </span>            : 
<span class="lineNum">    5663 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDragSession&gt; dragSession = GetDragSession();</span>
<span class="lineNum">    5664 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(dragSession, NS_OK); // no drag in progress</span>
<span class="lineNum">    5665 </span>            : 
<span class="lineNum">    5666 </span>            :   nsCOMPtr&lt;nsIDOMDataTransfer&gt; dataTransfer;
<span class="lineNum">    5667 </span>            :   nsCOMPtr&lt;DataTransfer&gt; initialDataTransfer;
<span class="lineNum">    5668 </span><span class="lineNoCov">          0 :   dragSession-&gt;GetDataTransfer(getter_AddRefs(dataTransfer));</span>
<span class="lineNum">    5669 </span><span class="lineNoCov">          0 :   if (dataTransfer) {</span>
<span class="lineNum">    5670 </span><span class="lineNoCov">          0 :     initialDataTransfer = do_QueryInterface(dataTransfer);</span>
<span class="lineNum">    5671 </span><span class="lineNoCov">          0 :     if (!initialDataTransfer) {</span>
<span class="lineNum">    5672 </span>            :       return NS_ERROR_FAILURE;
<span class="lineNum">    5673 </span>            :     }
<span class="lineNum">    5674 </span>            :   } else {
<span class="lineNum">    5675 </span>            :     // A dataTransfer won't exist when a drag was started by some other
<span class="lineNum">    5676 </span>            :     // means, for instance calling the drag service directly, or a drag
<span class="lineNum">    5677 </span>            :     // from another application. In either case, a new dataTransfer should
<span class="lineNum">    5678 </span>            :     // be created that reflects the data.
<span class="lineNum">    5679 </span><span class="lineNoCov">          0 :     initialDataTransfer =</span>
<span class="lineNum">    5680 </span><span class="lineNoCov">          0 :       new DataTransfer(aDragEvent-&gt;mTarget, aDragEvent-&gt;mMessage, true, -1);</span>
<span class="lineNum">    5681 </span>            : 
<span class="lineNum">    5682 </span>            :     // now set it in the drag session so we don't need to create it again
<span class="lineNum">    5683 </span><span class="lineNoCov">          0 :     dragSession-&gt;SetDataTransfer(initialDataTransfer);</span>
<span class="lineNum">    5684 </span>            :   }
<span class="lineNum">    5685 </span>            : 
<span class="lineNum">    5686 </span><span class="lineNoCov">          0 :   bool isCrossDomainSubFrameDrop = false;</span>
<span class="lineNum">    5687 </span><span class="lineNoCov">          0 :   if (aDragEvent-&gt;mMessage == eDrop) {</span>
<span class="lineNum">    5688 </span><span class="lineNoCov">          0 :     isCrossDomainSubFrameDrop = CheckForSubFrameDrop(dragSession, aDragEvent);</span>
<span class="lineNum">    5689 </span>            :   }
<span class="lineNum">    5690 </span>            : 
<span class="lineNum">    5691 </span>            :   // each event should use a clone of the original dataTransfer.
<span class="lineNum">    5692 </span>            :   initialDataTransfer-&gt;Clone(aDragEvent-&gt;mTarget, aDragEvent-&gt;mMessage,
<span class="lineNum">    5693 </span>            :                              aDragEvent-&gt;mUserCancelled,
<span class="lineNum">    5694 </span>            :                              isCrossDomainSubFrameDrop,
<span class="lineNum">    5695 </span><span class="lineNoCov">          0 :                              getter_AddRefs(aDragEvent-&gt;mDataTransfer));</span>
<span class="lineNum">    5696 </span><span class="lineNoCov">          0 :   if (NS_WARN_IF(!aDragEvent-&gt;mDataTransfer)) {</span>
<span class="lineNum">    5697 </span>            :     return NS_ERROR_OUT_OF_MEMORY;
<span class="lineNum">    5698 </span>            :   }
<span class="lineNum">    5699 </span>            : 
<span class="lineNum">    5700 </span>            :   // for the dragenter and dragover events, initialize the drop effect
<span class="lineNum">    5701 </span>            :   // from the drop action, which platform specific widget code sets before
<span class="lineNum">    5702 </span>            :   // the event is fired based on the keyboard state.
<span class="lineNum">    5703 </span><span class="lineNoCov">          0 :   if (aDragEvent-&gt;mMessage == eDragEnter || aDragEvent-&gt;mMessage == eDragOver) {</span>
<span class="lineNum">    5704 </span>            :     uint32_t action, effectAllowed;
<span class="lineNum">    5705 </span><span class="lineNoCov">          0 :     dragSession-&gt;GetDragAction(&amp;action);</span>
<span class="lineNum">    5706 </span><span class="lineNoCov">          0 :     aDragEvent-&gt;mDataTransfer-&gt;GetEffectAllowedInt(&amp;effectAllowed);</span>
<span class="lineNum">    5707 </span>            :     aDragEvent-&gt;mDataTransfer-&gt;SetDropEffectInt(
<span class="lineNum">    5708 </span><span class="lineNoCov">          0 :                                  FilterDropEffect(action, effectAllowed));</span>
<span class="lineNum">    5709 </span>            :   }
<span class="lineNum">    5710 </span><span class="lineNoCov">          0 :   else if (aDragEvent-&gt;mMessage == eDrop ||</span>
<span class="lineNum">    5711 </span>            :            aDragEvent-&gt;mMessage == eDragEnd) {
<span class="lineNum">    5712 </span>            :     // For the drop and dragend events, set the drop effect based on the
<span class="lineNum">    5713 </span>            :     // last value that the dropEffect had. This will have been set in
<span class="lineNum">    5714 </span>            :     // EventStateManager::PostHandleEvent for the last dragenter or
<span class="lineNum">    5715 </span>            :     // dragover event.
<span class="lineNum">    5716 </span>            :     uint32_t dropEffect;
<span class="lineNum">    5717 </span><span class="lineNoCov">          0 :     initialDataTransfer-&gt;GetDropEffectInt(&amp;dropEffect);</span>
<span class="lineNum">    5718 </span><span class="lineNoCov">          0 :     aDragEvent-&gt;mDataTransfer-&gt;SetDropEffectInt(dropEffect);</span>
<span class="lineNum">    5719 </span>            :   }
<span class="lineNum">    5720 </span>            : 
<span class="lineNum">    5721 </span>            :   return NS_OK;
<span class="lineNum">    5722 </span>            : }
<span class="lineNum">    5723 </span>            : 
<a name="5724"><span class="lineNum">    5724 </span>            : /* static */</a>
<span class="lineNum">    5725 </span>            : uint32_t
<span class="lineNum">    5726 </span><span class="lineNoCov">          0 : nsContentUtils::FilterDropEffect(uint32_t aAction, uint32_t aEffectAllowed)</span>
<span class="lineNum">    5727 </span>            : {
<span class="lineNum">    5728 </span>            :   // It is possible for the drag action to include more than one action, but
<span class="lineNum">    5729 </span>            :   // the widget code which sets the action from the keyboard state should only
<span class="lineNum">    5730 </span>            :   // be including one. If multiple actions were set, we just consider them in
<span class="lineNum">    5731 </span>            :   //  the following order:
<span class="lineNum">    5732 </span>            :   //   copy, link, move
<span class="lineNum">    5733 </span><span class="lineNoCov">          0 :   if (aAction &amp; nsIDragService::DRAGDROP_ACTION_COPY)</span>
<span class="lineNum">    5734 </span>            :     aAction = nsIDragService::DRAGDROP_ACTION_COPY;
<span class="lineNum">    5735 </span><span class="lineNoCov">          0 :   else if (aAction &amp; nsIDragService::DRAGDROP_ACTION_LINK)</span>
<span class="lineNum">    5736 </span>            :     aAction = nsIDragService::DRAGDROP_ACTION_LINK;
<span class="lineNum">    5737 </span><span class="lineNoCov">          0 :   else if (aAction &amp; nsIDragService::DRAGDROP_ACTION_MOVE)</span>
<span class="lineNum">    5738 </span><span class="lineNoCov">          0 :     aAction = nsIDragService::DRAGDROP_ACTION_MOVE;</span>
<span class="lineNum">    5739 </span>            : 
<span class="lineNum">    5740 </span>            :   // Filter the action based on the effectAllowed. If the effectAllowed
<span class="lineNum">    5741 </span>            :   // doesn't include the action, then that action cannot be done, so adjust
<span class="lineNum">    5742 </span>            :   // the action to something that is allowed. For a copy, adjust to move or
<span class="lineNum">    5743 </span>            :   // link. For a move, adjust to copy or link. For a link, adjust to move or
<span class="lineNum">    5744 </span>            :   // link. Otherwise, use none.
<span class="lineNum">    5745 </span><span class="lineNoCov">          0 :   if (aAction &amp; aEffectAllowed ||</span>
<span class="lineNum">    5746 </span>            :       aEffectAllowed == nsIDragService::DRAGDROP_ACTION_UNINITIALIZED)
<span class="lineNum">    5747 </span>            :     return aAction;
<span class="lineNum">    5748 </span><span class="lineNoCov">          0 :   if (aEffectAllowed &amp; nsIDragService::DRAGDROP_ACTION_MOVE)</span>
<span class="lineNum">    5749 </span>            :     return nsIDragService::DRAGDROP_ACTION_MOVE;
<span class="lineNum">    5750 </span><span class="lineNoCov">          0 :   if (aEffectAllowed &amp; nsIDragService::DRAGDROP_ACTION_COPY)</span>
<span class="lineNum">    5751 </span>            :     return nsIDragService::DRAGDROP_ACTION_COPY;
<span class="lineNum">    5752 </span><span class="lineNoCov">          0 :   if (aEffectAllowed &amp; nsIDragService::DRAGDROP_ACTION_LINK)</span>
<span class="lineNum">    5753 </span>            :     return nsIDragService::DRAGDROP_ACTION_LINK;
<span class="lineNum">    5754 </span><span class="lineNoCov">          0 :   return nsIDragService::DRAGDROP_ACTION_NONE;</span>
<span class="lineNum">    5755 </span>            : }
<span class="lineNum">    5756 </span>            : 
<span class="lineNum">    5757 </span>            : /* static */
<span class="lineNum">    5758 </span>            : bool
<span class="lineNum">    5759 </span><span class="lineNoCov">          0 : nsContentUtils::CheckForSubFrameDrop(nsIDragSession* aDragSession,</span>
<span class="lineNum">    5760 </span>            :                                      WidgetDragEvent* aDropEvent)
<span class="lineNum">    5761 </span>            : {
<span class="lineNum">    5762 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIContent&gt; target = do_QueryInterface(aDropEvent-&gt;mOriginalTarget);</span>
<span class="lineNum">    5763 </span><span class="lineNoCov">          0 :   if (!target) {</span>
<span class="lineNum">    5764 </span>            :     return true;
<span class="lineNum">    5765 </span>            :   }
<span class="lineNum">    5766 </span>            : 
<span class="lineNum">    5767 </span><span class="lineNoCov">          0 :   nsIDocument* targetDoc = target-&gt;OwnerDoc();</span>
<span class="lineNum">    5768 </span><span class="lineNoCov">          0 :   nsPIDOMWindowOuter* targetWin = targetDoc-&gt;GetWindow();</span>
<span class="lineNum">    5769 </span><span class="lineNoCov">          0 :   if (!targetWin) {</span>
<span class="lineNum">    5770 </span>            :     return true;
<span class="lineNum">    5771 </span>            :   }
<span class="lineNum">    5772 </span>            : 
<span class="lineNum">    5773 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocShellTreeItem&gt; tdsti = targetWin-&gt;GetDocShell();</span>
<span class="lineNum">    5774 </span><span class="lineNoCov">          0 :   if (!tdsti) {</span>
<span class="lineNum">    5775 </span>            :     return true;
<span class="lineNum">    5776 </span>            :   }
<span class="lineNum">    5777 </span>            : 
<span class="lineNum">    5778 </span>            :   // Always allow dropping onto chrome shells.
<span class="lineNum">    5779 </span><span class="lineNoCov">          0 :   if (tdsti-&gt;ItemType() == nsIDocShellTreeItem::typeChrome) {</span>
<span class="lineNum">    5780 </span>            :     return false;
<span class="lineNum">    5781 </span>            :   }
<span class="lineNum">    5782 </span>            : 
<span class="lineNum">    5783 </span>            :   // If there is no source node, then this is a drag from another
<span class="lineNum">    5784 </span>            :   // application, which should be allowed.
<span class="lineNum">    5785 </span>            :   nsCOMPtr&lt;nsIDOMDocument&gt; sourceDocument;
<span class="lineNum">    5786 </span><span class="lineNoCov">          0 :   aDragSession-&gt;GetSourceDocument(getter_AddRefs(sourceDocument));</span>
<span class="lineNum">    5787 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocument&gt; doc = do_QueryInterface(sourceDocument);</span>
<span class="lineNum">    5788 </span><span class="lineNoCov">          0 :   if (doc) {</span>
<span class="lineNum">    5789 </span>            :     // Get each successive parent of the source document and compare it to
<span class="lineNum">    5790 </span>            :     // the drop document. If they match, then this is a drag from a child frame.
<span class="lineNum">    5791 </span><span class="lineNoCov">          0 :     do {</span>
<span class="lineNum">    5792 </span><span class="lineNoCov">          0 :       doc = doc-&gt;GetParentDocument();</span>
<span class="lineNum">    5793 </span><span class="lineNoCov">          0 :       if (doc == targetDoc) {</span>
<span class="lineNum">    5794 </span>            :         // The drag is from a child frame.
<span class="lineNum">    5795 </span>            :         return true;
<span class="lineNum">    5796 </span>            :       }
<span class="lineNum">    5797 </span>            :     } while (doc);
<span class="lineNum">    5798 </span>            :   }
<span class="lineNum">    5799 </span>            : 
<span class="lineNum">    5800 </span>            :   return false;
<span class="lineNum">    5801 </span>            : }
<span class="lineNum">    5802 </span>            : 
<span class="lineNum">    5803 </span>            : /* static */
<span class="lineNum">    5804 </span>            : bool
<span class="lineNum">    5805 </span><span class="lineNoCov">          0 : nsContentUtils::URIIsLocalFile(nsIURI *aURI)</span>
<span class="lineNum">    5806 </span>            : {
<span class="lineNum">    5807 </span>            :   bool isFile;
<span class="lineNum">    5808 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsINetUtil&gt; util = do_QueryInterface(sIOService);</span>
<span class="lineNum">    5809 </span>            : 
<span class="lineNum">    5810 </span>            :   // Important: we do NOT test the entire URI chain here!
<span class="lineNum">    5811 </span><span class="lineNoCov">          0 :   return util &amp;&amp; NS_SUCCEEDED(util-&gt;ProtocolHasFlags(aURI,</span>
<span class="lineNum">    5812 </span>            :                                 nsIProtocolHandler::URI_IS_LOCAL_FILE,
<span class="lineNum">    5813 </span><span class="lineNoCov">          0 :                                 &amp;isFile)) &amp;&amp;</span>
<span class="lineNum">    5814 </span><span class="lineNoCov">          0 :          isFile;</span>
<span class="lineNum">    5815 </span>            : }
<span class="lineNum">    5816 </span>            : 
<a name="5817"><span class="lineNum">    5817 </span>            : /* static */</a>
<span class="lineNum">    5818 </span>            : nsIScriptContext*
<span class="lineNum">    5819 </span><span class="lineNoCov">          0 : nsContentUtils::GetContextForEventHandlers(nsINode* aNode,</span>
<span class="lineNum">    5820 </span>            :                                            nsresult* aRv)
<span class="lineNum">    5821 </span>            : {
<span class="lineNum">    5822 </span><span class="lineNoCov">          0 :   *aRv = NS_OK;</span>
<span class="lineNum">    5823 </span><span class="lineNoCov">          0 :   bool hasHadScriptObject = true;</span>
<span class="lineNum">    5824 </span>            :   nsIScriptGlobalObject* sgo =
<span class="lineNum">    5825 </span><span class="lineNoCov">          0 :     aNode-&gt;OwnerDoc()-&gt;GetScriptHandlingObject(hasHadScriptObject);</span>
<span class="lineNum">    5826 </span>            :   // It is bad if the document doesn't have event handling context,
<span class="lineNum">    5827 </span>            :   // but it used to have one.
<span class="lineNum">    5828 </span><span class="lineNoCov">          0 :   if (!sgo &amp;&amp; hasHadScriptObject) {</span>
<span class="lineNum">    5829 </span><span class="lineNoCov">          0 :     *aRv = NS_ERROR_UNEXPECTED;</span>
<span class="lineNum">    5830 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">    5831 </span>            :   }
<span class="lineNum">    5832 </span>            : 
<span class="lineNum">    5833 </span><span class="lineNoCov">          0 :   if (sgo) {</span>
<span class="lineNum">    5834 </span><span class="lineNoCov">          0 :     nsIScriptContext* scx = sgo-&gt;GetContext();</span>
<span class="lineNum">    5835 </span>            :     // Bad, no context from script global object!
<span class="lineNum">    5836 </span><span class="lineNoCov">          0 :     if (!scx) {</span>
<span class="lineNum">    5837 </span><span class="lineNoCov">          0 :       *aRv = NS_ERROR_UNEXPECTED;</span>
<span class="lineNum">    5838 </span><span class="lineNoCov">          0 :       return nullptr;</span>
<span class="lineNum">    5839 </span>            :     }
<span class="lineNum">    5840 </span>            :     return scx;
<span class="lineNum">    5841 </span>            :   }
<span class="lineNum">    5842 </span>            : 
<span class="lineNum">    5843 </span>            :   return nullptr;
<span class="lineNum">    5844 </span>            : }
<span class="lineNum">    5845 </span>            : 
<a name="5846"><span class="lineNum">    5846 </span>            : /* static */</a>
<span class="lineNum">    5847 </span>            : JSContext *
<span class="lineNum">    5848 </span><span class="lineCov">       8383 : nsContentUtils::GetCurrentJSContext()</span>
<span class="lineNum">    5849 </span>            : {
<span class="lineNum">    5850 </span>            :   MOZ_ASSERT(NS_IsMainThread());
<span class="lineNum">    5851 </span>            :   MOZ_ASSERT(IsInitialized());
<span class="lineNum">    5852 </span><span class="lineCov">       8383 :   if (!IsJSAPIActive()) {</span>
<span class="lineNum">    5853 </span>            :     return nullptr;
<span class="lineNum">    5854 </span>            :   }
<span class="lineNum">    5855 </span><span class="lineCov">       8383 :   return danger::GetJSContext();</span>
<span class="lineNum">    5856 </span>            : }
<span class="lineNum">    5857 </span>            : 
<a name="5858"><span class="lineNum">    5858 </span>            : /* static */</a>
<span class="lineNum">    5859 </span>            : JSContext *
<span class="lineNum">    5860 </span><span class="lineCov">        745 : nsContentUtils::GetCurrentJSContextForThread()</span>
<span class="lineNum">    5861 </span>            : {
<span class="lineNum">    5862 </span>            :   MOZ_ASSERT(IsInitialized());
<span class="lineNum">    5863 </span><span class="lineCov">        745 :   if (MOZ_LIKELY(NS_IsMainThread())) {</span>
<span class="lineNum">    5864 </span><span class="lineCov">        745 :     return GetCurrentJSContext();</span>
<span class="lineNum">    5865 </span>            :   }
<span class="lineNum">    5866 </span><span class="lineNoCov">          0 :   return workers::GetCurrentThreadJSContext();</span>
<span class="lineNum">    5867 </span>            : }
<span class="lineNum">    5868 </span>            : 
<a name="5869"><span class="lineNum">    5869 </span>            : template&lt;typename StringType, typename CharType&gt;</a>
<span class="lineNum">    5870 </span>            : void
<span class="lineNum">    5871 </span><span class="lineCov">       2170 : _ASCIIToLowerInSitu(StringType&amp; aStr)</span>
<span class="lineNum">    5872 </span>            : {
<span class="lineNum">    5873 </span><span class="lineCov">       2170 :   CharType* iter = aStr.BeginWriting();</span>
<span class="lineNum">    5874 </span><span class="lineCov">       2170 :   CharType* end = aStr.EndWriting();</span>
<span class="lineNum">    5875 </span>            :   MOZ_ASSERT(iter &amp;&amp; end);
<span class="lineNum">    5876 </span>            : 
<span class="lineNum">    5877 </span><span class="lineCov">      36295 :   while (iter != end) {</span>
<span class="lineNum">    5878 </span><span class="lineCov">      31955 :     CharType c = *iter;</span>
<span class="lineNum">    5879 </span><span class="lineCov">      31955 :     if (c &gt;= 'A' &amp;&amp; c &lt;= 'Z') {</span>
<span class="lineNum">    5880 </span><span class="lineNoCov">          0 :       *iter = c + ('a' - 'A');</span>
<span class="lineNum">    5881 </span>            :     }
<span class="lineNum">    5882 </span><span class="lineCov">      31955 :     ++iter;</span>
<span class="lineNum">    5883 </span>            :   }
<span class="lineNum">    5884 </span><span class="lineCov">       2170 : }</span>
<span class="lineNum">    5885 </span>            : 
<a name="5886"><span class="lineNum">    5886 </span>            : /* static */</a>
<span class="lineNum">    5887 </span>            : void
<a name="5888"><span class="lineNum">    5888 </span><span class="lineCov">       2170 : nsContentUtils::ASCIIToLower(nsAString&amp; aStr)</span></a>
<span class="lineNum">    5889 </span>            : {
<span class="lineNum">    5890 </span><span class="lineCov">       2170 :   return _ASCIIToLowerInSitu&lt;nsAString, char16_t&gt;(aStr);</span>
<span class="lineNum">    5891 </span>            : }
<span class="lineNum">    5892 </span>            : 
<a name="5893"><span class="lineNum">    5893 </span>            : /* static */</a>
<span class="lineNum">    5894 </span>            : void
<span class="lineNum">    5895 </span><span class="lineNoCov">          0 : nsContentUtils::ASCIIToLower(nsACString&amp; aStr)</span>
<span class="lineNum">    5896 </span>            : {
<span class="lineNum">    5897 </span><span class="lineNoCov">          0 :   return _ASCIIToLowerInSitu&lt;nsACString, char&gt;(aStr);</span>
<span class="lineNum">    5898 </span>            : }
<span class="lineNum">    5899 </span>            : 
<a name="5900"><span class="lineNum">    5900 </span>            : template&lt;typename StringType, typename CharType&gt;</a>
<span class="lineNum">    5901 </span>            : void
<span class="lineNum">    5902 </span><span class="lineCov">       7125 : _ASCIIToLowerCopy(const StringType&amp; aSource, StringType&amp; aDest)</span>
<span class="lineNum">    5903 </span>            : {
<span class="lineNum">    5904 </span><span class="lineCov">       7125 :   uint32_t len = aSource.Length();</span>
<span class="lineNum">    5905 </span><span class="lineCov">       7125 :   aDest.SetLength(len);</span>
<span class="lineNum">    5906 </span>            :   MOZ_ASSERT(aDest.Length() == len);
<span class="lineNum">    5907 </span>            : 
<span class="lineNum">    5908 </span><span class="lineCov">       7125 :   CharType* dest = aDest.BeginWriting();</span>
<span class="lineNum">    5909 </span>            :   MOZ_ASSERT(dest);
<span class="lineNum">    5910 </span>            : 
<span class="lineNum">    5911 </span><span class="lineCov">       7125 :   const CharType* iter = aSource.BeginReading();</span>
<span class="lineNum">    5912 </span><span class="lineCov">      14250 :   const CharType* end = aSource.EndReading();</span>
<span class="lineNum">    5913 </span><span class="lineCov">      50215 :   while (iter != end) {</span>
<span class="lineNum">    5914 </span><span class="lineCov">      35965 :     CharType c = *iter;</span>
<span class="lineNum">    5915 </span><span class="lineCov">      35965 :     *dest = (c &gt;= 'A' &amp;&amp; c &lt;= 'Z') ?</span>
<span class="lineNum">    5916 </span>            :        c + ('a' - 'A') : c;
<span class="lineNum">    5917 </span><span class="lineCov">      35965 :     ++iter;</span>
<span class="lineNum">    5918 </span><span class="lineCov">      35965 :     ++dest;</span>
<span class="lineNum">    5919 </span>            :   }
<span class="lineNum">    5920 </span><span class="lineCov">       7125 : }</span>
<span class="lineNum">    5921 </span>            : 
<a name="5922"><span class="lineNum">    5922 </span>            : /* static */</a>
<span class="lineNum">    5923 </span>            : void
<span class="lineNum">    5924 </span><span class="lineCov">       7125 : nsContentUtils::ASCIIToLower(const nsAString&amp; aSource, nsAString&amp; aDest) {</span>
<span class="lineNum">    5925 </span><span class="lineCov">       7125 :   return _ASCIIToLowerCopy&lt;nsAString, char16_t&gt;(aSource, aDest);</span>
<span class="lineNum">    5926 </span>            : }
<span class="lineNum">    5927 </span>            : 
<a name="5928"><span class="lineNum">    5928 </span>            : /* static */</a>
<span class="lineNum">    5929 </span>            : void
<span class="lineNum">    5930 </span><span class="lineNoCov">          0 : nsContentUtils::ASCIIToLower(const nsACString&amp; aSource, nsACString&amp; aDest) {</span>
<span class="lineNum">    5931 </span><span class="lineNoCov">          0 :   return _ASCIIToLowerCopy&lt;nsACString, char&gt;(aSource, aDest);</span>
<span class="lineNum">    5932 </span>            : }
<span class="lineNum">    5933 </span>            : 
<span class="lineNum">    5934 </span>            : 
<a name="5935"><span class="lineNum">    5935 </span>            : template&lt;typename StringType, typename CharType&gt;</a>
<span class="lineNum">    5936 </span>            : void
<span class="lineNum">    5937 </span><span class="lineNoCov">          0 : _ASCIIToUpperInSitu(StringType&amp; aStr)</span>
<span class="lineNum">    5938 </span>            : {
<span class="lineNum">    5939 </span><span class="lineNoCov">          0 :   CharType* iter = aStr.BeginWriting();</span>
<span class="lineNum">    5940 </span><span class="lineNoCov">          0 :   CharType* end = aStr.EndWriting();</span>
<span class="lineNum">    5941 </span>            :   MOZ_ASSERT(iter &amp;&amp; end);
<span class="lineNum">    5942 </span>            : 
<span class="lineNum">    5943 </span><span class="lineNoCov">          0 :   while (iter != end) {</span>
<span class="lineNum">    5944 </span><span class="lineNoCov">          0 :     CharType c = *iter;</span>
<span class="lineNum">    5945 </span><span class="lineNoCov">          0 :     if (c &gt;= 'a' &amp;&amp; c &lt;= 'z') {</span>
<span class="lineNum">    5946 </span><span class="lineNoCov">          0 :       *iter = c + ('A' - 'a');</span>
<span class="lineNum">    5947 </span>            :     }
<span class="lineNum">    5948 </span><span class="lineNoCov">          0 :     ++iter;</span>
<span class="lineNum">    5949 </span>            :   }
<span class="lineNum">    5950 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    5951 </span>            : 
<a name="5952"><span class="lineNum">    5952 </span>            : /* static */</a>
<span class="lineNum">    5953 </span>            : void
<span class="lineNum">    5954 </span><span class="lineNoCov">          0 : nsContentUtils::ASCIIToUpper(nsAString&amp; aStr)</span>
<span class="lineNum">    5955 </span>            : {
<span class="lineNum">    5956 </span><span class="lineNoCov">          0 :   return _ASCIIToUpperInSitu&lt;nsAString, char16_t&gt;(aStr);</span>
<span class="lineNum">    5957 </span>            : }
<span class="lineNum">    5958 </span>            : 
<a name="5959"><span class="lineNum">    5959 </span>            : /* static */</a>
<span class="lineNum">    5960 </span>            : void
<span class="lineNum">    5961 </span><span class="lineNoCov">          0 : nsContentUtils::ASCIIToUpper(nsACString&amp; aStr)</span>
<span class="lineNum">    5962 </span>            : {
<span class="lineNum">    5963 </span><span class="lineNoCov">          0 :   return _ASCIIToUpperInSitu&lt;nsACString, char&gt;(aStr);</span>
<span class="lineNum">    5964 </span>            : }
<span class="lineNum">    5965 </span>            : 
<a name="5966"><span class="lineNum">    5966 </span>            : template&lt;typename StringType, typename CharType&gt;</a>
<span class="lineNum">    5967 </span>            : void
<span class="lineNum">    5968 </span><span class="lineNoCov">          0 : _ASCIIToUpperCopy(const StringType&amp; aSource, StringType&amp; aDest)</span>
<span class="lineNum">    5969 </span>            : {
<span class="lineNum">    5970 </span><span class="lineNoCov">          0 :   uint32_t len = aSource.Length();</span>
<span class="lineNum">    5971 </span><span class="lineNoCov">          0 :   aDest.SetLength(len);</span>
<span class="lineNum">    5972 </span>            :   MOZ_ASSERT(aDest.Length() == len);
<span class="lineNum">    5973 </span>            : 
<span class="lineNum">    5974 </span><span class="lineNoCov">          0 :   CharType* dest = aDest.BeginWriting();</span>
<span class="lineNum">    5975 </span>            :   MOZ_ASSERT(dest);
<span class="lineNum">    5976 </span>            : 
<span class="lineNum">    5977 </span><span class="lineNoCov">          0 :   const CharType* iter = aSource.BeginReading();</span>
<span class="lineNum">    5978 </span><span class="lineNoCov">          0 :   const CharType* end = aSource.EndReading();</span>
<span class="lineNum">    5979 </span><span class="lineNoCov">          0 :   while (iter != end) {</span>
<span class="lineNum">    5980 </span><span class="lineNoCov">          0 :     CharType c = *iter;</span>
<span class="lineNum">    5981 </span><span class="lineNoCov">          0 :     *dest = (c &gt;= 'a' &amp;&amp; c &lt;= 'z') ?</span>
<span class="lineNum">    5982 </span>            :       c + ('A' - 'a') : c;
<span class="lineNum">    5983 </span><span class="lineNoCov">          0 :     ++iter;</span>
<span class="lineNum">    5984 </span><span class="lineNoCov">          0 :     ++dest;</span>
<span class="lineNum">    5985 </span>            :   }
<span class="lineNum">    5986 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    5987 </span>            : 
<a name="5988"><span class="lineNum">    5988 </span>            : /* static */</a>
<span class="lineNum">    5989 </span>            : void
<span class="lineNum">    5990 </span><span class="lineNoCov">          0 : nsContentUtils::ASCIIToUpper(const nsAString&amp; aSource, nsAString&amp; aDest)</span>
<span class="lineNum">    5991 </span>            : {
<span class="lineNum">    5992 </span><span class="lineNoCov">          0 :   return _ASCIIToUpperCopy&lt;nsAString, char16_t&gt;(aSource, aDest);</span>
<span class="lineNum">    5993 </span>            : }
<span class="lineNum">    5994 </span>            : 
<a name="5995"><span class="lineNum">    5995 </span>            : /* static */</a>
<span class="lineNum">    5996 </span>            : void
<span class="lineNum">    5997 </span><span class="lineNoCov">          0 : nsContentUtils::ASCIIToUpper(const nsACString&amp; aSource, nsACString&amp; aDest)</span>
<span class="lineNum">    5998 </span>            : {
<span class="lineNum">    5999 </span><span class="lineNoCov">          0 :   return _ASCIIToUpperCopy&lt;nsACString, char&gt;(aSource, aDest);</span>
<span class="lineNum">    6000 </span>            : }
<span class="lineNum">    6001 </span>            : 
<a name="6002"><span class="lineNum">    6002 </span>            : /* static */</a>
<span class="lineNum">    6003 </span>            : bool
<span class="lineNum">    6004 </span><span class="lineNoCov">          0 : nsContentUtils::EqualsIgnoreASCIICase(const nsAString&amp; aStr1,</span>
<span class="lineNum">    6005 </span>            :                                       const nsAString&amp; aStr2)
<span class="lineNum">    6006 </span>            : {
<span class="lineNum">    6007 </span><span class="lineNoCov">          0 :   uint32_t len = aStr1.Length();</span>
<span class="lineNum">    6008 </span><span class="lineNoCov">          0 :   if (len != aStr2.Length()) {</span>
<span class="lineNum">    6009 </span>            :     return false;
<span class="lineNum">    6010 </span>            :   }
<span class="lineNum">    6011 </span>            : 
<span class="lineNum">    6012 </span><span class="lineNoCov">          0 :   const char16_t* str1 = aStr1.BeginReading();</span>
<span class="lineNum">    6013 </span><span class="lineNoCov">          0 :   const char16_t* str2 = aStr2.BeginReading();</span>
<span class="lineNum">    6014 </span><span class="lineNoCov">          0 :   const char16_t* end = str1 + len;</span>
<span class="lineNum">    6015 </span>            : 
<span class="lineNum">    6016 </span><span class="lineNoCov">          0 :   while (str1 &lt; end) {</span>
<span class="lineNum">    6017 </span><span class="lineNoCov">          0 :     char16_t c1 = *str1++;</span>
<span class="lineNum">    6018 </span><span class="lineNoCov">          0 :     char16_t c2 = *str2++;</span>
<span class="lineNum">    6019 </span>            : 
<span class="lineNum">    6020 </span>            :     // First check if any bits other than the 0x0020 differs
<span class="lineNum">    6021 </span><span class="lineNoCov">          0 :     if ((c1 ^ c2) &amp; 0xffdf) {</span>
<span class="lineNum">    6022 </span>            :       return false;
<span class="lineNum">    6023 </span>            :     }
<span class="lineNum">    6024 </span>            : 
<span class="lineNum">    6025 </span>            :     // We know they can only differ in the 0x0020 bit.
<span class="lineNum">    6026 </span>            :     // Likely the two chars are the same, so check that first
<span class="lineNum">    6027 </span><span class="lineNoCov">          0 :     if (c1 != c2) {</span>
<span class="lineNum">    6028 </span>            :       // They do differ, but since it's only in the 0x0020 bit, check if it's
<span class="lineNum">    6029 </span>            :       // the same ascii char, but just differing in case
<span class="lineNum">    6030 </span><span class="lineNoCov">          0 :       char16_t c1Upper = c1 &amp; 0xffdf;</span>
<span class="lineNum">    6031 </span><span class="lineNoCov">          0 :       if (!('A' &lt;= c1Upper &amp;&amp; c1Upper &lt;= 'Z')) {</span>
<span class="lineNum">    6032 </span>            :         return false;
<span class="lineNum">    6033 </span>            :       }
<span class="lineNum">    6034 </span>            :     }
<span class="lineNum">    6035 </span>            :   }
<span class="lineNum">    6036 </span>            : 
<span class="lineNum">    6037 </span>            :   return true;
<span class="lineNum">    6038 </span>            : }
<span class="lineNum">    6039 </span>            : 
<a name="6040"><span class="lineNum">    6040 </span>            : /* static */</a>
<span class="lineNum">    6041 </span>            : bool
<span class="lineNum">    6042 </span><span class="lineNoCov">          0 : nsContentUtils::StringContainsASCIIUpper(const nsAString&amp; aStr)</span>
<span class="lineNum">    6043 </span>            : {
<span class="lineNum">    6044 </span><span class="lineNoCov">          0 :   const char16_t* iter = aStr.BeginReading();</span>
<span class="lineNum">    6045 </span><span class="lineNoCov">          0 :   const char16_t* end = aStr.EndReading();</span>
<span class="lineNum">    6046 </span><span class="lineNoCov">          0 :   while (iter != end) {</span>
<span class="lineNum">    6047 </span><span class="lineNoCov">          0 :     char16_t c = *iter;</span>
<span class="lineNum">    6048 </span><span class="lineNoCov">          0 :     if (c &gt;= 'A' &amp;&amp; c &lt;= 'Z') {</span>
<span class="lineNum">    6049 </span>            :       return true;
<span class="lineNum">    6050 </span>            :     }
<span class="lineNum">    6051 </span><span class="lineNoCov">          0 :     ++iter;</span>
<span class="lineNum">    6052 </span>            :   }
<span class="lineNum">    6053 </span>            : 
<span class="lineNum">    6054 </span>            :   return false;
<span class="lineNum">    6055 </span>            : }
<span class="lineNum">    6056 </span>            : 
<a name="6057"><span class="lineNum">    6057 </span>            : /* static */</a>
<span class="lineNum">    6058 </span>            : nsIInterfaceRequestor*
<span class="lineNum">    6059 </span><span class="lineNoCov">          0 : nsContentUtils::SameOriginChecker()</span>
<span class="lineNum">    6060 </span>            : {
<span class="lineNum">    6061 </span><span class="lineNoCov">          0 :   if (!sSameOriginChecker) {</span>
<span class="lineNum">    6062 </span><span class="lineNoCov">          0 :     sSameOriginChecker = new SameOriginCheckerImpl();</span>
<span class="lineNum">    6063 </span><span class="lineNoCov">          0 :     NS_ADDREF(sSameOriginChecker);</span>
<span class="lineNum">    6064 </span>            :   }
<span class="lineNum">    6065 </span><span class="lineNoCov">          0 :   return sSameOriginChecker;</span>
<span class="lineNum">    6066 </span>            : }
<span class="lineNum">    6067 </span>            : 
<span class="lineNum">    6068 </span>            : /* static */
<span class="lineNum">    6069 </span>            : nsresult
<span class="lineNum">    6070 </span><span class="lineNoCov">          0 : nsContentUtils::CheckSameOrigin(nsIChannel *aOldChannel, nsIChannel *aNewChannel)</span>
<span class="lineNum">    6071 </span>            : {
<span class="lineNum">    6072 </span><span class="lineNoCov">          0 :   if (!nsContentUtils::GetSecurityManager())</span>
<span class="lineNum">    6073 </span>            :     return NS_ERROR_NOT_AVAILABLE;
<span class="lineNum">    6074 </span>            : 
<span class="lineNum">    6075 </span>            :   nsCOMPtr&lt;nsIPrincipal&gt; oldPrincipal;
<span class="lineNum">    6076 </span>            :   nsContentUtils::GetSecurityManager()-&gt;
<span class="lineNum">    6077 </span><span class="lineNoCov">          0 :     GetChannelResultPrincipal(aOldChannel, getter_AddRefs(oldPrincipal));</span>
<span class="lineNum">    6078 </span>            : 
<span class="lineNum">    6079 </span>            :   nsCOMPtr&lt;nsIURI&gt; newURI;
<span class="lineNum">    6080 </span><span class="lineNoCov">          0 :   aNewChannel-&gt;GetURI(getter_AddRefs(newURI));</span>
<span class="lineNum">    6081 </span>            :   nsCOMPtr&lt;nsIURI&gt; newOriginalURI;
<span class="lineNum">    6082 </span><span class="lineNoCov">          0 :   aNewChannel-&gt;GetOriginalURI(getter_AddRefs(newOriginalURI));</span>
<span class="lineNum">    6083 </span>            : 
<span class="lineNum">    6084 </span><span class="lineNoCov">          0 :   NS_ENSURE_STATE(oldPrincipal &amp;&amp; newURI &amp;&amp; newOriginalURI);</span>
<span class="lineNum">    6085 </span>            : 
<span class="lineNum">    6086 </span><span class="lineNoCov">          0 :   nsresult rv = oldPrincipal-&gt;CheckMayLoad(newURI, false, false);</span>
<span class="lineNum">    6087 </span><span class="lineNoCov">          0 :   if (NS_SUCCEEDED(rv) &amp;&amp; newOriginalURI != newURI) {</span>
<span class="lineNum">    6088 </span><span class="lineNoCov">          0 :     rv = oldPrincipal-&gt;CheckMayLoad(newOriginalURI, false, false);</span>
<span class="lineNum">    6089 </span>            :   }
<span class="lineNum">    6090 </span>            : 
<span class="lineNum">    6091 </span><span class="lineNoCov">          0 :   return rv;</span>
<a name="6092"><span class="lineNum">    6092 </span>            : }</a>
<span class="lineNum">    6093 </span>            : 
<span class="lineNum">    6094 </span><span class="lineNoCov">          0 : NS_IMPL_ISUPPORTS(SameOriginCheckerImpl,</span>
<span class="lineNum">    6095 </span>            :                   nsIChannelEventSink,
<span class="lineNum">    6096 </span>            :                   nsIInterfaceRequestor)
<a name="6097"><span class="lineNum">    6097 </span>            : </a>
<span class="lineNum">    6098 </span>            : NS_IMETHODIMP
<span class="lineNum">    6099 </span><span class="lineNoCov">          0 : SameOriginCheckerImpl::AsyncOnChannelRedirect(nsIChannel* aOldChannel,</span>
<span class="lineNum">    6100 </span>            :                                               nsIChannel* aNewChannel,
<span class="lineNum">    6101 </span>            :                                               uint32_t aFlags,
<span class="lineNum">    6102 </span>            :                                               nsIAsyncVerifyRedirectCallback* cb)
<span class="lineNum">    6103 </span>            : {
<span class="lineNum">    6104 </span>            :   NS_PRECONDITION(aNewChannel, &quot;Redirecting to null channel?&quot;);
<span class="lineNum">    6105 </span>            : 
<span class="lineNum">    6106 </span><span class="lineNoCov">          0 :   nsresult rv = nsContentUtils::CheckSameOrigin(aOldChannel, aNewChannel);</span>
<span class="lineNum">    6107 </span><span class="lineNoCov">          0 :   if (NS_SUCCEEDED(rv)) {</span>
<span class="lineNum">    6108 </span><span class="lineNoCov">          0 :     cb-&gt;OnRedirectVerifyCallback(NS_OK);</span>
<span class="lineNum">    6109 </span>            :   }
<span class="lineNum">    6110 </span>            : 
<span class="lineNum">    6111 </span><span class="lineNoCov">          0 :   return rv;</span>
<span class="lineNum">    6112 </span>            : }
<a name="6113"><span class="lineNum">    6113 </span>            : </a>
<span class="lineNum">    6114 </span>            : NS_IMETHODIMP
<span class="lineNum">    6115 </span><span class="lineNoCov">          0 : SameOriginCheckerImpl::GetInterface(const nsIID&amp; aIID, void** aResult)</span>
<span class="lineNum">    6116 </span>            : {
<span class="lineNum">    6117 </span><span class="lineNoCov">          0 :   return QueryInterface(aIID, aResult);</span>
<span class="lineNum">    6118 </span>            : }
<span class="lineNum">    6119 </span>            : 
<span class="lineNum">    6120 </span>            : /* static */
<span class="lineNum">    6121 </span>            : nsresult
<span class="lineNum">    6122 </span><span class="lineNoCov">          0 : nsContentUtils::GetASCIIOrigin(nsIPrincipal* aPrincipal, nsACString&amp; aOrigin)</span>
<span class="lineNum">    6123 </span>            : {
<span class="lineNum">    6124 </span>            :   NS_PRECONDITION(aPrincipal, &quot;missing principal&quot;);
<span class="lineNum">    6125 </span>            : 
<span class="lineNum">    6126 </span>            :   aOrigin.Truncate();
<span class="lineNum">    6127 </span>            : 
<span class="lineNum">    6128 </span>            :   nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">    6129 </span><span class="lineNoCov">          0 :   nsresult rv = aPrincipal-&gt;GetURI(getter_AddRefs(uri));</span>
<span class="lineNum">    6130 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    6131 </span>            : 
<span class="lineNum">    6132 </span><span class="lineNoCov">          0 :   if (uri) {</span>
<span class="lineNum">    6133 </span><span class="lineNoCov">          0 :     return GetASCIIOrigin(uri, aOrigin);</span>
<span class="lineNum">    6134 </span>            :   }
<span class="lineNum">    6135 </span>            : 
<span class="lineNum">    6136 </span><span class="lineNoCov">          0 :   aOrigin.AssignLiteral(&quot;null&quot;);</span>
<span class="lineNum">    6137 </span>            : 
<span class="lineNum">    6138 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    6139 </span>            : }
<span class="lineNum">    6140 </span>            : 
<span class="lineNum">    6141 </span>            : /* static */
<span class="lineNum">    6142 </span>            : nsresult
<span class="lineNum">    6143 </span><span class="lineNoCov">          0 : nsContentUtils::GetASCIIOrigin(nsIURI* aURI, nsACString&amp; aOrigin)</span>
<span class="lineNum">    6144 </span>            : {
<span class="lineNum">    6145 </span>            :   NS_PRECONDITION(aURI, &quot;missing uri&quot;);
<span class="lineNum">    6146 </span>            : 
<span class="lineNum">    6147 </span>            :   // For Blob URI we have to return the origin of page using its principal.
<span class="lineNum">    6148 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIURIWithPrincipal&gt; uriWithPrincipal = do_QueryInterface(aURI);</span>
<span class="lineNum">    6149 </span><span class="lineNoCov">          0 :   if (uriWithPrincipal) {</span>
<span class="lineNum">    6150 </span>            :     nsCOMPtr&lt;nsIPrincipal&gt; principal;
<span class="lineNum">    6151 </span><span class="lineNoCov">          0 :     uriWithPrincipal-&gt;GetPrincipal(getter_AddRefs(principal));</span>
<span class="lineNum">    6152 </span>            : 
<span class="lineNum">    6153 </span><span class="lineNoCov">          0 :     if (principal) {</span>
<span class="lineNum">    6154 </span>            :       nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">    6155 </span><span class="lineNoCov">          0 :       nsresult rv = principal-&gt;GetURI(getter_AddRefs(uri));</span>
<span class="lineNum">    6156 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    6157 </span>            : 
<span class="lineNum">    6158 </span><span class="lineNoCov">          0 :       if (uri &amp;&amp; uri != aURI) {</span>
<span class="lineNum">    6159 </span><span class="lineNoCov">          0 :         return GetASCIIOrigin(uri, aOrigin);</span>
<span class="lineNum">    6160 </span>            :       }
<span class="lineNum">    6161 </span>            :     }
<span class="lineNum">    6162 </span>            :   }
<span class="lineNum">    6163 </span>            : 
<span class="lineNum">    6164 </span>            :   aOrigin.Truncate();
<span class="lineNum">    6165 </span>            : 
<span class="lineNum">    6166 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIURI&gt; uri = NS_GetInnermostURI(aURI);</span>
<span class="lineNum">    6167 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(uri, NS_ERROR_UNEXPECTED);</span>
<span class="lineNum">    6168 </span>            : 
<span class="lineNum">    6169 </span>            :   nsCString host;
<span class="lineNum">    6170 </span><span class="lineNoCov">          0 :   nsresult rv = uri-&gt;GetAsciiHost(host);</span>
<span class="lineNum">    6171 </span>            : 
<span class="lineNum">    6172 </span><span class="lineNoCov">          0 :   if (NS_SUCCEEDED(rv) &amp;&amp; !host.IsEmpty()) {</span>
<span class="lineNum">    6173 </span>            :     nsCString scheme;
<span class="lineNum">    6174 </span><span class="lineNoCov">          0 :     rv = uri-&gt;GetScheme(scheme);</span>
<span class="lineNum">    6175 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    6176 </span>            : 
<span class="lineNum">    6177 </span><span class="lineNoCov">          0 :     int32_t port = -1;</span>
<span class="lineNum">    6178 </span><span class="lineNoCov">          0 :     uri-&gt;GetPort(&amp;port);</span>
<span class="lineNum">    6179 </span><span class="lineNoCov">          0 :     if (port != -1 &amp;&amp; port == NS_GetDefaultPort(scheme.get()))</span>
<span class="lineNum">    6180 </span><span class="lineNoCov">          0 :       port = -1;</span>
<span class="lineNum">    6181 </span>            : 
<span class="lineNum">    6182 </span>            :     nsCString hostPort;
<span class="lineNum">    6183 </span><span class="lineNoCov">          0 :     rv = NS_GenerateHostPort(host, port, hostPort);</span>
<span class="lineNum">    6184 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    6185 </span>            : 
<span class="lineNum">    6186 </span><span class="lineNoCov">          0 :     aOrigin = scheme + NS_LITERAL_CSTRING(&quot;://&quot;) + hostPort;</span>
<span class="lineNum">    6187 </span>            :   }
<span class="lineNum">    6188 </span>            :   else {
<span class="lineNum">    6189 </span><span class="lineNoCov">          0 :     aOrigin.AssignLiteral(&quot;null&quot;);</span>
<span class="lineNum">    6190 </span>            :   }
<span class="lineNum">    6191 </span>            : 
<span class="lineNum">    6192 </span>            :   return NS_OK;
<span class="lineNum">    6193 </span>            : }
<span class="lineNum">    6194 </span>            : 
<span class="lineNum">    6195 </span>            : /* static */
<span class="lineNum">    6196 </span>            : nsresult
<span class="lineNum">    6197 </span><span class="lineNoCov">          0 : nsContentUtils::GetUTFOrigin(nsIPrincipal* aPrincipal, nsAString&amp; aOrigin)</span>
<span class="lineNum">    6198 </span>            : {
<span class="lineNum">    6199 </span>            :   NS_PRECONDITION(aPrincipal, &quot;missing principal&quot;);
<span class="lineNum">    6200 </span>            : 
<span class="lineNum">    6201 </span>            :   aOrigin.Truncate();
<span class="lineNum">    6202 </span>            : 
<span class="lineNum">    6203 </span>            :   nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">    6204 </span><span class="lineNoCov">          0 :   nsresult rv = aPrincipal-&gt;GetURI(getter_AddRefs(uri));</span>
<span class="lineNum">    6205 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    6206 </span>            : 
<span class="lineNum">    6207 </span><span class="lineNoCov">          0 :   if (uri) {</span>
<span class="lineNum">    6208 </span><span class="lineNoCov">          0 :     return GetUTFOrigin(uri, aOrigin);</span>
<span class="lineNum">    6209 </span>            :   }
<span class="lineNum">    6210 </span>            : 
<span class="lineNum">    6211 </span><span class="lineNoCov">          0 :   aOrigin.AssignLiteral(&quot;null&quot;);</span>
<span class="lineNum">    6212 </span>            : 
<span class="lineNum">    6213 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    6214 </span>            : }
<span class="lineNum">    6215 </span>            : 
<span class="lineNum">    6216 </span>            : /* static */
<span class="lineNum">    6217 </span>            : nsresult
<span class="lineNum">    6218 </span><span class="lineNoCov">          0 : nsContentUtils::GetUTFOrigin(nsIURI* aURI, nsAString&amp; aOrigin)</span>
<span class="lineNum">    6219 </span>            : {
<span class="lineNum">    6220 </span>            :   NS_PRECONDITION(aURI, &quot;missing uri&quot;);
<span class="lineNum">    6221 </span>            : 
<span class="lineNum">    6222 </span>            :   // For Blob URI we have to return the origin of page using its principal.
<span class="lineNum">    6223 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIURIWithPrincipal&gt; uriWithPrincipal = do_QueryInterface(aURI);</span>
<span class="lineNum">    6224 </span><span class="lineNoCov">          0 :   if (uriWithPrincipal) {</span>
<span class="lineNum">    6225 </span>            :     nsCOMPtr&lt;nsIPrincipal&gt; principal;
<span class="lineNum">    6226 </span><span class="lineNoCov">          0 :     uriWithPrincipal-&gt;GetPrincipal(getter_AddRefs(principal));</span>
<span class="lineNum">    6227 </span>            : 
<span class="lineNum">    6228 </span><span class="lineNoCov">          0 :     if (principal) {</span>
<span class="lineNum">    6229 </span>            :       nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">    6230 </span><span class="lineNoCov">          0 :       nsresult rv = principal-&gt;GetURI(getter_AddRefs(uri));</span>
<span class="lineNum">    6231 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    6232 </span>            : 
<span class="lineNum">    6233 </span><span class="lineNoCov">          0 :       if (uri &amp;&amp; uri != aURI) {</span>
<span class="lineNum">    6234 </span><span class="lineNoCov">          0 :         return GetUTFOrigin(uri, aOrigin);</span>
<span class="lineNum">    6235 </span>            :       }
<span class="lineNum">    6236 </span>            :     } else {
<span class="lineNum">    6237 </span>            :       // We are probably dealing with an unknown blob URL.
<span class="lineNum">    6238 </span><span class="lineNoCov">          0 :       bool isBlobURL = false;</span>
<span class="lineNum">    6239 </span><span class="lineNoCov">          0 :       nsresult rv = aURI-&gt;SchemeIs(BLOBURI_SCHEME, &amp;isBlobURL);</span>
<span class="lineNum">    6240 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    6241 </span>            : 
<span class="lineNum">    6242 </span><span class="lineNoCov">          0 :       if (isBlobURL) {</span>
<span class="lineNum">    6243 </span><span class="lineNoCov">          0 :         nsAutoCString path;</span>
<span class="lineNum">    6244 </span><span class="lineNoCov">          0 :         rv = aURI-&gt;GetPath(path);</span>
<span class="lineNum">    6245 </span><span class="lineNoCov">          0 :         NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    6246 </span>            : 
<span class="lineNum">    6247 </span>            :         nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">    6248 </span><span class="lineNoCov">          0 :         nsresult rv = NS_NewURI(getter_AddRefs(uri), path);</span>
<span class="lineNum">    6249 </span><span class="lineNoCov">          0 :         if (NS_FAILED(rv)) {</span>
<span class="lineNum">    6250 </span><span class="lineNoCov">          0 :           aOrigin.AssignLiteral(&quot;null&quot;);</span>
<span class="lineNum">    6251 </span><span class="lineNoCov">          0 :           return NS_OK;</span>
<span class="lineNum">    6252 </span>            :         }
<span class="lineNum">    6253 </span>            : 
<span class="lineNum">    6254 </span><span class="lineNoCov">          0 :         return GetUTFOrigin(uri, aOrigin);</span>
<span class="lineNum">    6255 </span>            :       }
<span class="lineNum">    6256 </span>            :     }
<span class="lineNum">    6257 </span>            :   }
<span class="lineNum">    6258 </span>            : 
<span class="lineNum">    6259 </span>            :   aOrigin.Truncate();
<span class="lineNum">    6260 </span>            : 
<span class="lineNum">    6261 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIURI&gt; uri = NS_GetInnermostURI(aURI);</span>
<span class="lineNum">    6262 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(uri, NS_ERROR_UNEXPECTED);</span>
<span class="lineNum">    6263 </span>            : 
<span class="lineNum">    6264 </span>            :   nsCString host;
<span class="lineNum">    6265 </span><span class="lineNoCov">          0 :   nsresult rv = uri-&gt;GetHost(host);</span>
<span class="lineNum">    6266 </span>            : 
<span class="lineNum">    6267 </span><span class="lineNoCov">          0 :   if (NS_SUCCEEDED(rv) &amp;&amp; !host.IsEmpty()) {</span>
<span class="lineNum">    6268 </span>            :     nsCString scheme;
<span class="lineNum">    6269 </span><span class="lineNoCov">          0 :     rv = uri-&gt;GetScheme(scheme);</span>
<span class="lineNum">    6270 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    6271 </span>            : 
<span class="lineNum">    6272 </span><span class="lineNoCov">          0 :     int32_t port = -1;</span>
<span class="lineNum">    6273 </span><span class="lineNoCov">          0 :     uri-&gt;GetPort(&amp;port);</span>
<span class="lineNum">    6274 </span><span class="lineNoCov">          0 :     if (port != -1 &amp;&amp; port == NS_GetDefaultPort(scheme.get()))</span>
<span class="lineNum">    6275 </span><span class="lineNoCov">          0 :       port = -1;</span>
<span class="lineNum">    6276 </span>            : 
<span class="lineNum">    6277 </span>            :     nsCString hostPort;
<span class="lineNum">    6278 </span><span class="lineNoCov">          0 :     rv = NS_GenerateHostPort(host, port, hostPort);</span>
<span class="lineNum">    6279 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    6280 </span>            : 
<span class="lineNum">    6281 </span><span class="lineNoCov">          0 :     aOrigin = NS_ConvertUTF8toUTF16(</span>
<span class="lineNum">    6282 </span><span class="lineNoCov">          0 :       scheme + NS_LITERAL_CSTRING(&quot;://&quot;) + hostPort);</span>
<span class="lineNum">    6283 </span>            :   }
<span class="lineNum">    6284 </span>            :   else {
<span class="lineNum">    6285 </span><span class="lineNoCov">          0 :     aOrigin.AssignLiteral(&quot;null&quot;);</span>
<span class="lineNum">    6286 </span>            :   }
<span class="lineNum">    6287 </span>            : 
<span class="lineNum">    6288 </span>            :   return NS_OK;
<span class="lineNum">    6289 </span>            : }
<span class="lineNum">    6290 </span>            : 
<span class="lineNum">    6291 </span>            : /* static */
<span class="lineNum">    6292 </span>            : bool
<span class="lineNum">    6293 </span><span class="lineNoCov">          0 : nsContentUtils::CheckMayLoad(nsIPrincipal* aPrincipal, nsIChannel* aChannel, bool aAllowIfInheritsPrincipal)</span>
<span class="lineNum">    6294 </span>            : {
<span class="lineNum">    6295 </span>            :   nsCOMPtr&lt;nsIURI&gt; channelURI;
<span class="lineNum">    6296 </span><span class="lineNoCov">          0 :   nsresult rv = NS_GetFinalChannelURI(aChannel, getter_AddRefs(channelURI));</span>
<span class="lineNum">    6297 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, false);</span>
<span class="lineNum">    6298 </span>            : 
<span class="lineNum">    6299 </span><span class="lineNoCov">          0 :   return NS_SUCCEEDED(aPrincipal-&gt;CheckMayLoad(channelURI, false, aAllowIfInheritsPrincipal));</span>
<a name="6300"><span class="lineNum">    6300 </span>            : }</a>
<span class="lineNum">    6301 </span>            : 
<span class="lineNum">    6302 </span><span class="lineNoCov">          0 : nsContentTypeParser::nsContentTypeParser(const nsAString&amp; aString)</span>
<span class="lineNum">    6303 </span><span class="lineNoCov">          0 :   : mString(aString), mService(nullptr)</span>
<span class="lineNum">    6304 </span>            : {
<span class="lineNum">    6305 </span><span class="lineNoCov">          0 :   CallGetService(&quot;@mozilla.org/network/mime-hdrparam;1&quot;, &amp;mService);</span>
<a name="6306"><span class="lineNum">    6306 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    6307 </span>            : 
<span class="lineNum">    6308 </span><span class="lineNoCov">          0 : nsContentTypeParser::~nsContentTypeParser()</span>
<span class="lineNum">    6309 </span>            : {
<span class="lineNum">    6310 </span><span class="lineNoCov">          0 :   NS_IF_RELEASE(mService);</span>
<span class="lineNum">    6311 </span><span class="lineNoCov">          0 : }</span>
<a name="6312"><span class="lineNum">    6312 </span>            : </a>
<span class="lineNum">    6313 </span>            : nsresult
<span class="lineNum">    6314 </span><span class="lineNoCov">          0 : nsContentTypeParser::GetParameter(const char* aParameterName,</span>
<span class="lineNum">    6315 </span>            :                                   nsAString&amp; aResult) const
<span class="lineNum">    6316 </span>            : {
<span class="lineNum">    6317 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(mService, NS_ERROR_FAILURE);</span>
<span class="lineNum">    6318 </span>            :   return mService-&gt;GetParameterHTTP(mString, aParameterName,
<span class="lineNum">    6319 </span><span class="lineNoCov">          0 :                                     EmptyCString(), false, nullptr,</span>
<span class="lineNum">    6320 </span><span class="lineNoCov">          0 :                                     aResult);</span>
<span class="lineNum">    6321 </span>            : }
<span class="lineNum">    6322 </span>            : 
<span class="lineNum">    6323 </span>            : nsresult
<span class="lineNum">    6324 </span><span class="lineNoCov">          0 : nsContentTypeParser::GetType(nsAString&amp; aResult) const</span>
<span class="lineNum">    6325 </span>            : {
<span class="lineNum">    6326 </span><span class="lineNoCov">          0 :   nsresult rv = GetParameter(nullptr, aResult);</span>
<span class="lineNum">    6327 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    6328 </span>            :     return rv;
<span class="lineNum">    6329 </span>            :   }
<span class="lineNum">    6330 </span>            :   nsContentUtils::ASCIIToLower(aResult);
<span class="lineNum">    6331 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    6332 </span>            : }
<span class="lineNum">    6333 </span>            : 
<span class="lineNum">    6334 </span>            : /* static */
<a name="6335"><span class="lineNum">    6335 </span>            : </a>
<span class="lineNum">    6336 </span>            : bool
<span class="lineNum">    6337 </span><span class="lineNoCov">          0 : nsContentUtils::CanAccessNativeAnon()</span>
<span class="lineNum">    6338 </span>            : {
<span class="lineNum">    6339 </span><span class="lineNoCov">          0 :   return LegacyIsCallerChromeOrNativeCode() || IsCallerContentXBL();</span>
<span class="lineNum">    6340 </span>            : }
<span class="lineNum">    6341 </span>            : 
<span class="lineNum">    6342 </span>            : /* static */ nsresult
<span class="lineNum">    6343 </span><span class="lineNoCov">          0 : nsContentUtils::DispatchXULCommand(nsIContent* aTarget,</span>
<span class="lineNum">    6344 </span>            :                                    bool aTrusted,
<span class="lineNum">    6345 </span>            :                                    nsIDOMEvent* aSourceEvent,
<span class="lineNum">    6346 </span>            :                                    nsIPresShell* aShell,
<span class="lineNum">    6347 </span>            :                                    bool aCtrl,
<span class="lineNum">    6348 </span>            :                                    bool aAlt,
<span class="lineNum">    6349 </span>            :                                    bool aShift,
<span class="lineNum">    6350 </span>            :                                    bool aMeta)
<span class="lineNum">    6351 </span>            : {
<span class="lineNum">    6352 </span><span class="lineNoCov">          0 :   NS_ENSURE_STATE(aTarget);</span>
<span class="lineNum">    6353 </span><span class="lineNoCov">          0 :   nsIDocument* doc = aTarget-&gt;OwnerDoc();</span>
<span class="lineNum">    6354 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDOMDocument&gt; domDoc = do_QueryInterface(doc);</span>
<span class="lineNum">    6355 </span><span class="lineNoCov">          0 :   NS_ENSURE_STATE(domDoc);</span>
<span class="lineNum">    6356 </span>            :   nsCOMPtr&lt;nsIDOMEvent&gt; event;
<span class="lineNum">    6357 </span>            :   domDoc-&gt;CreateEvent(NS_LITERAL_STRING(&quot;xulcommandevent&quot;),
<span class="lineNum">    6358 </span><span class="lineNoCov">          0 :                       getter_AddRefs(event));</span>
<span class="lineNum">    6359 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDOMXULCommandEvent&gt; xulCommand = do_QueryInterface(event);</span>
<span class="lineNum">    6360 </span>            :   nsresult rv = xulCommand-&gt;InitCommandEvent(NS_LITERAL_STRING(&quot;command&quot;),
<span class="lineNum">    6361 </span><span class="lineNoCov">          0 :                                              true, true, doc-&gt;GetInnerWindow(),</span>
<span class="lineNum">    6362 </span>            :                                              0, aCtrl, aAlt, aShift, aMeta,
<span class="lineNum">    6363 </span><span class="lineNoCov">          0 :                                              aSourceEvent);</span>
<span class="lineNum">    6364 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    6365 </span>            : 
<span class="lineNum">    6366 </span><span class="lineNoCov">          0 :   if (aShell) {</span>
<span class="lineNum">    6367 </span><span class="lineNoCov">          0 :     nsEventStatus status = nsEventStatus_eIgnore;</span>
<span class="lineNum">    6368 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIPresShell&gt; kungFuDeathGrip = aShell;</span>
<span class="lineNum">    6369 </span><span class="lineNoCov">          0 :     return aShell-&gt;HandleDOMEventWithTarget(aTarget, event, &amp;status);</span>
<span class="lineNum">    6370 </span>            :   }
<span class="lineNum">    6371 </span>            : 
<span class="lineNum">    6372 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;EventTarget&gt; target = do_QueryInterface(aTarget);</span>
<span class="lineNum">    6373 </span><span class="lineNoCov">          0 :   NS_ENSURE_STATE(target);</span>
<span class="lineNum">    6374 </span>            :   bool dummy;
<span class="lineNum">    6375 </span><span class="lineNoCov">          0 :   return target-&gt;DispatchEvent(event, &amp;dummy);</span>
<span class="lineNum">    6376 </span>            : }
<span class="lineNum">    6377 </span>            : 
<a name="6378"><span class="lineNum">    6378 </span>            : // static</a>
<span class="lineNum">    6379 </span>            : nsresult
<span class="lineNum">    6380 </span><span class="lineCov">       1188 : nsContentUtils::WrapNative(JSContext *cx, nsISupports *native,</span>
<span class="lineNum">    6381 </span>            :                            nsWrapperCache *cache, const nsIID* aIID,
<span class="lineNum">    6382 </span>            :                            JS::MutableHandle&lt;JS::Value&gt; vp, bool aAllowWrapping)
<span class="lineNum">    6383 </span>            : {
<span class="lineNum">    6384 </span>            :   MOZ_ASSERT(cx == GetCurrentJSContext());
<span class="lineNum">    6385 </span>            : 
<span class="lineNum">    6386 </span><span class="lineCov">       1188 :   if (!native) {</span>
<span class="lineNum">    6387 </span>            :     vp.setNull();
<span class="lineNum">    6388 </span>            : 
<span class="lineNum">    6389 </span><span class="lineNoCov">          0 :     return NS_OK;</span>
<span class="lineNum">    6390 </span>            :   }
<span class="lineNum">    6391 </span>            : 
<span class="lineNum">    6392 </span><span class="lineCov">       1188 :   JSObject *wrapper = xpc_FastGetCachedWrapper(cx, cache, vp);</span>
<span class="lineNum">    6393 </span><span class="lineCov">       1188 :   if (wrapper) {</span>
<span class="lineNum">    6394 </span>            :     return NS_OK;
<span class="lineNum">    6395 </span>            :   }
<span class="lineNum">    6396 </span>            : 
<span class="lineNum">    6397 </span><span class="lineCov">       1188 :   NS_ENSURE_TRUE(sXPConnect, NS_ERROR_UNEXPECTED);</span>
<span class="lineNum">    6398 </span>            : 
<span class="lineNum">    6399 </span><span class="lineCov">       1188 :   if (!NS_IsMainThread()) {</span>
<span class="lineNum">    6400 </span><span class="lineNoCov">          0 :     MOZ_CRASH();</span>
<span class="lineNum">    6401 </span>            :   }
<span class="lineNum">    6402 </span>            : 
<span class="lineNum">    6403 </span><span class="lineCov">       1188 :   nsresult rv = NS_OK;</span>
<span class="lineNum">    6404 </span><span class="lineCov">       1188 :   JS::Rooted&lt;JSObject*&gt; scope(cx, JS::CurrentGlobalOrNull(cx));</span>
<span class="lineNum">    6405 </span>            :   rv = sXPConnect-&gt;WrapNativeToJSVal(cx, scope, native, cache, aIID,
<span class="lineNum">    6406 </span><span class="lineCov">       1188 :                                      aAllowWrapping, vp);</span>
<span class="lineNum">    6407 </span><span class="lineCov">       1188 :   return rv;</span>
<span class="lineNum">    6408 </span>            : }
<a name="6409"><span class="lineNum">    6409 </span>            : </a>
<span class="lineNum">    6410 </span>            : nsresult
<span class="lineNum">    6411 </span><span class="lineNoCov">          0 : nsContentUtils::CreateArrayBuffer(JSContext *aCx, const nsACString&amp; aData,</span>
<span class="lineNum">    6412 </span>            :                                   JSObject** aResult)
<span class="lineNum">    6413 </span>            : {
<span class="lineNum">    6414 </span><span class="lineNoCov">          0 :   if (!aCx) {</span>
<span class="lineNum">    6415 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">    6416 </span>            :   }
<span class="lineNum">    6417 </span>            : 
<span class="lineNum">    6418 </span><span class="lineNoCov">          0 :   int32_t dataLen = aData.Length();</span>
<span class="lineNum">    6419 </span><span class="lineNoCov">          0 :   *aResult = JS_NewArrayBuffer(aCx, dataLen);</span>
<span class="lineNum">    6420 </span><span class="lineNoCov">          0 :   if (!*aResult) {</span>
<span class="lineNum">    6421 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">    6422 </span>            :   }
<span class="lineNum">    6423 </span>            : 
<span class="lineNum">    6424 </span><span class="lineNoCov">          0 :   if (dataLen &gt; 0) {</span>
<span class="lineNum">    6425 </span>            :     NS_ASSERTION(JS_IsArrayBufferObject(*aResult), &quot;What happened?&quot;);
<span class="lineNum">    6426 </span>            :     JS::AutoCheckCannotGC nogc;
<span class="lineNum">    6427 </span>            :     bool isShared;
<span class="lineNum">    6428 </span><span class="lineNoCov">          0 :     memcpy(JS_GetArrayBufferData(*aResult, &amp;isShared, nogc), aData.BeginReading(), dataLen);</span>
<span class="lineNum">    6429 </span>            :     MOZ_ASSERT(!isShared);
<span class="lineNum">    6430 </span>            :   }
<span class="lineNum">    6431 </span>            : 
<span class="lineNum">    6432 </span>            :   return NS_OK;
<span class="lineNum">    6433 </span>            : }
<a name="6434"><span class="lineNum">    6434 </span>            : </a>
<span class="lineNum">    6435 </span>            : void
<span class="lineNum">    6436 </span><span class="lineNoCov">          0 : nsContentUtils::StripNullChars(const nsAString&amp; aInStr, nsAString&amp; aOutStr)</span>
<span class="lineNum">    6437 </span>            : {
<span class="lineNum">    6438 </span>            :   // In common cases where we don't have nulls in the
<span class="lineNum">    6439 </span>            :   // string we can simple simply bypass the checking code.
<span class="lineNum">    6440 </span><span class="lineNoCov">          0 :   int32_t firstNullPos = aInStr.FindChar('\0');</span>
<span class="lineNum">    6441 </span><span class="lineNoCov">          0 :   if (firstNullPos == kNotFound) {</span>
<span class="lineNum">    6442 </span><span class="lineNoCov">          0 :     aOutStr.Assign(aInStr);</span>
<span class="lineNum">    6443 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    6444 </span>            :   }
<span class="lineNum">    6445 </span>            : 
<span class="lineNum">    6446 </span><span class="lineNoCov">          0 :   aOutStr.SetCapacity(aInStr.Length() - 1);</span>
<span class="lineNum">    6447 </span>            :   nsAString::const_iterator start, end;
<span class="lineNum">    6448 </span><span class="lineNoCov">          0 :   aInStr.BeginReading(start);</span>
<span class="lineNum">    6449 </span><span class="lineNoCov">          0 :   aInStr.EndReading(end);</span>
<span class="lineNum">    6450 </span><span class="lineNoCov">          0 :   while (start != end) {</span>
<span class="lineNum">    6451 </span><span class="lineNoCov">          0 :     if (*start != '\0')</span>
<span class="lineNum">    6452 </span><span class="lineNoCov">          0 :       aOutStr.Append(*start);</span>
<span class="lineNum">    6453 </span>            :     ++start;
<span class="lineNum">    6454 </span>            :   }
<a name="6455"><span class="lineNum">    6455 </span>            : }</a>
<span class="lineNum">    6456 </span>            : 
<span class="lineNum">    6457 </span><span class="lineNoCov">          0 : struct ClassMatchingInfo {</span>
<span class="lineNum">    6458 </span>            :   nsAttrValue::AtomArray mClasses;
<span class="lineNum">    6459 </span>            :   nsCaseTreatment mCaseTreatment;
<span class="lineNum">    6460 </span>            : };
<span class="lineNum">    6461 </span>            : 
<span class="lineNum">    6462 </span>            : // static
<span class="lineNum">    6463 </span>            : bool
<span class="lineNum">    6464 </span><span class="lineNoCov">          0 : nsContentUtils::MatchClassNames(Element* aElement, int32_t aNamespaceID,</span>
<span class="lineNum">    6465 </span>            :                                 nsIAtom* aAtom, void* aData)
<span class="lineNum">    6466 </span>            : {
<span class="lineNum">    6467 </span>            :   // We can't match if there are no class names
<span class="lineNum">    6468 </span><span class="lineNoCov">          0 :   const nsAttrValue* classAttr = aElement-&gt;GetClasses();</span>
<span class="lineNum">    6469 </span><span class="lineNoCov">          0 :   if (!classAttr) {</span>
<span class="lineNum">    6470 </span>            :     return false;
<span class="lineNum">    6471 </span>            :   }
<span class="lineNum">    6472 </span>            : 
<span class="lineNum">    6473 </span>            :   // need to match *all* of the classes
<span class="lineNum">    6474 </span><span class="lineNoCov">          0 :   ClassMatchingInfo* info = static_cast&lt;ClassMatchingInfo*&gt;(aData);</span>
<span class="lineNum">    6475 </span><span class="lineNoCov">          0 :   uint32_t length = info-&gt;mClasses.Length();</span>
<span class="lineNum">    6476 </span><span class="lineNoCov">          0 :   if (!length) {</span>
<span class="lineNum">    6477 </span>            :     // If we actually had no classes, don't match.
<span class="lineNum">    6478 </span>            :     return false;
<span class="lineNum">    6479 </span>            :   }
<span class="lineNum">    6480 </span>            :   uint32_t i;
<span class="lineNum">    6481 </span><span class="lineNoCov">          0 :   for (i = 0; i &lt; length; ++i) {</span>
<span class="lineNum">    6482 </span><span class="lineNoCov">          0 :     if (!classAttr-&gt;Contains(info-&gt;mClasses[i],</span>
<span class="lineNum">    6483 </span><span class="lineNoCov">          0 :                              info-&gt;mCaseTreatment)) {</span>
<span class="lineNum">    6484 </span>            :       return false;
<span class="lineNum">    6485 </span>            :     }
<span class="lineNum">    6486 </span>            :   }
<span class="lineNum">    6487 </span>            : 
<span class="lineNum">    6488 </span>            :   return true;
<span class="lineNum">    6489 </span>            : }
<span class="lineNum">    6490 </span>            : 
<span class="lineNum">    6491 </span>            : // static
<span class="lineNum">    6492 </span>            : void
<span class="lineNum">    6493 </span><span class="lineNoCov">          0 : nsContentUtils::DestroyClassNameArray(void* aData)</span>
<span class="lineNum">    6494 </span>            : {
<span class="lineNum">    6495 </span><span class="lineNoCov">          0 :   ClassMatchingInfo* info = static_cast&lt;ClassMatchingInfo*&gt;(aData);</span>
<span class="lineNum">    6496 </span><span class="lineNoCov">          0 :   delete info;</span>
<span class="lineNum">    6497 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    6498 </span>            : 
<span class="lineNum">    6499 </span>            : // static
<span class="lineNum">    6500 </span>            : void*
<span class="lineNum">    6501 </span><span class="lineNoCov">          0 : nsContentUtils::AllocClassMatchingInfo(nsINode* aRootNode,</span>
<span class="lineNum">    6502 </span>            :                                        const nsString* aClasses)
<span class="lineNum">    6503 </span>            : {
<span class="lineNum">    6504 </span><span class="lineNoCov">          0 :   nsAttrValue attrValue;</span>
<span class="lineNum">    6505 </span><span class="lineNoCov">          0 :   attrValue.ParseAtomArray(*aClasses);</span>
<span class="lineNum">    6506 </span>            :   // nsAttrValue::Equals is sensitive to order, so we'll send an array
<span class="lineNum">    6507 </span><span class="lineNoCov">          0 :   auto* info = new ClassMatchingInfo;</span>
<span class="lineNum">    6508 </span><span class="lineNoCov">          0 :   if (attrValue.Type() == nsAttrValue::eAtomArray) {</span>
<span class="lineNum">    6509 </span><span class="lineNoCov">          0 :     info-&gt;mClasses.SwapElements(*(attrValue.GetAtomArrayValue()));</span>
<span class="lineNum">    6510 </span><span class="lineNoCov">          0 :   } else if (attrValue.Type() == nsAttrValue::eAtom) {</span>
<span class="lineNum">    6511 </span><span class="lineNoCov">          0 :     info-&gt;mClasses.AppendElement(attrValue.GetAtomValue());</span>
<span class="lineNum">    6512 </span>            :   }
<span class="lineNum">    6513 </span>            : 
<span class="lineNum">    6514 </span>            :   info-&gt;mCaseTreatment =
<span class="lineNum">    6515 </span>            :     aRootNode-&gt;OwnerDoc()-&gt;GetCompatibilityMode() == eCompatibility_NavQuirks ?
<span class="lineNum">    6516 </span><span class="lineNoCov">          0 :     eIgnoreCase : eCaseMatters;</span>
<span class="lineNum">    6517 </span><span class="lineNoCov">          0 :   return info;</span>
<span class="lineNum">    6518 </span>            : }
<span class="lineNum">    6519 </span>            : 
<span class="lineNum">    6520 </span>            : // static
<span class="lineNum">    6521 </span>            : bool
<span class="lineNum">    6522 </span><span class="lineNoCov">          0 : nsContentUtils::IsFocusedContent(const nsIContent* aContent)</span>
<span class="lineNum">    6523 </span>            : {
<span class="lineNum">    6524 </span><span class="lineNoCov">          0 :   nsFocusManager* fm = nsFocusManager::GetFocusManager();</span>
<span class="lineNum">    6525 </span>            : 
<span class="lineNum">    6526 </span><span class="lineNoCov">          0 :   return fm &amp;&amp; fm-&gt;GetFocusedContent() == aContent;</span>
<span class="lineNum">    6527 </span>            : }
<span class="lineNum">    6528 </span>            : 
<span class="lineNum">    6529 </span>            : bool
<span class="lineNum">    6530 </span><span class="lineNoCov">          0 : nsContentUtils::IsSubDocumentTabbable(nsIContent* aContent)</span>
<span class="lineNum">    6531 </span>            : {
<span class="lineNum">    6532 </span>            :   //XXXsmaug Shadow DOM spec issue!
<span class="lineNum">    6533 </span>            :   //         We may need to change this to GetComposedDoc().
<span class="lineNum">    6534 </span><span class="lineNoCov">          0 :   nsIDocument* doc = aContent-&gt;GetUncomposedDoc();</span>
<span class="lineNum">    6535 </span><span class="lineNoCov">          0 :   if (!doc) {</span>
<span class="lineNum">    6536 </span>            :     return false;
<span class="lineNum">    6537 </span>            :   }
<span class="lineNum">    6538 </span>            : 
<span class="lineNum">    6539 </span>            :   // If the subdocument lives in another process, the frame is
<span class="lineNum">    6540 </span>            :   // tabbable.
<span class="lineNum">    6541 </span><span class="lineNoCov">          0 :   if (EventStateManager::IsRemoteTarget(aContent)) {</span>
<span class="lineNum">    6542 </span>            :     return true;
<span class="lineNum">    6543 </span>            :   }
<span class="lineNum">    6544 </span>            : 
<span class="lineNum">    6545 </span>            :   // XXXbz should this use OwnerDoc() for GetSubDocumentFor?
<span class="lineNum">    6546 </span>            :   // sXBL/XBL2 issue!
<span class="lineNum">    6547 </span><span class="lineNoCov">          0 :   nsIDocument* subDoc = doc-&gt;GetSubDocumentFor(aContent);</span>
<span class="lineNum">    6548 </span><span class="lineNoCov">          0 :   if (!subDoc) {</span>
<span class="lineNum">    6549 </span>            :     return false;
<span class="lineNum">    6550 </span>            :   }
<span class="lineNum">    6551 </span>            : 
<span class="lineNum">    6552 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocShell&gt; docShell = subDoc-&gt;GetDocShell();</span>
<span class="lineNum">    6553 </span><span class="lineNoCov">          0 :   if (!docShell) {</span>
<span class="lineNum">    6554 </span>            :     return false;
<span class="lineNum">    6555 </span>            :   }
<span class="lineNum">    6556 </span>            : 
<span class="lineNum">    6557 </span>            :   nsCOMPtr&lt;nsIContentViewer&gt; contentViewer;
<span class="lineNum">    6558 </span><span class="lineNoCov">          0 :   docShell-&gt;GetContentViewer(getter_AddRefs(contentViewer));</span>
<span class="lineNum">    6559 </span><span class="lineNoCov">          0 :   if (!contentViewer) {</span>
<span class="lineNum">    6560 </span>            :     return false;
<span class="lineNum">    6561 </span>            :   }
<span class="lineNum">    6562 </span>            : 
<span class="lineNum">    6563 </span>            :   nsCOMPtr&lt;nsIContentViewer&gt; zombieViewer;
<span class="lineNum">    6564 </span><span class="lineNoCov">          0 :   contentViewer-&gt;GetPreviousViewer(getter_AddRefs(zombieViewer));</span>
<span class="lineNum">    6565 </span>            : 
<span class="lineNum">    6566 </span>            :   // If there are 2 viewers for the current docshell, that
<span class="lineNum">    6567 </span>            :   // means the current document is a zombie document.
<span class="lineNum">    6568 </span>            :   // Only navigate into the subdocument if it's not a zombie.
<span class="lineNum">    6569 </span><span class="lineNoCov">          0 :   return !zombieViewer;</span>
<span class="lineNum">    6570 </span>            : }
<span class="lineNum">    6571 </span>            : 
<span class="lineNum">    6572 </span>            : bool
<span class="lineNum">    6573 </span><span class="lineNoCov">          0 : nsContentUtils::IsUserFocusIgnored(nsINode* aNode)</span>
<span class="lineNum">    6574 </span>            : {
<span class="lineNum">    6575 </span><span class="lineNoCov">          0 :   if (!nsGenericHTMLFrameElement::BrowserFramesEnabled()) {</span>
<span class="lineNum">    6576 </span>            :     return false;
<span class="lineNum">    6577 </span>            :   }
<span class="lineNum">    6578 </span>            : 
<span class="lineNum">    6579 </span>            :   // Check if our mozbrowser iframe ancestors has ignoreuserfocus attribute.
<span class="lineNum">    6580 </span><span class="lineNoCov">          0 :   while (aNode) {</span>
<span class="lineNum">    6581 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIMozBrowserFrame&gt; browserFrame = do_QueryInterface(aNode);</span>
<span class="lineNum">    6582 </span><span class="lineNoCov">          0 :     if (browserFrame &amp;&amp;</span>
<span class="lineNum">    6583 </span><span class="lineNoCov">          0 :         aNode-&gt;AsElement()-&gt;HasAttr(kNameSpaceID_None, nsGkAtoms::ignoreuserfocus) &amp;&amp;</span>
<span class="lineNum">    6584 </span><span class="lineNoCov">          0 :         browserFrame-&gt;GetReallyIsBrowser()) {</span>
<span class="lineNum">    6585 </span><span class="lineNoCov">          0 :       return true;</span>
<span class="lineNum">    6586 </span>            :     }
<span class="lineNum">    6587 </span><span class="lineNoCov">          0 :     nsPIDOMWindowOuter* win = aNode-&gt;OwnerDoc()-&gt;GetWindow();</span>
<span class="lineNum">    6588 </span><span class="lineNoCov">          0 :     aNode = win ? win-&gt;GetFrameElementInternal() : nullptr;</span>
<span class="lineNum">    6589 </span>            :   }
<span class="lineNum">    6590 </span>            : 
<span class="lineNum">    6591 </span>            :   return false;
<span class="lineNum">    6592 </span>            : }
<a name="6593"><span class="lineNum">    6593 </span>            : </a>
<span class="lineNum">    6594 </span>            : bool
<span class="lineNum">    6595 </span><span class="lineNoCov">          0 : nsContentUtils::HasScrollgrab(nsIContent* aContent)</span>
<span class="lineNum">    6596 </span>            : {
<span class="lineNum">    6597 </span><span class="lineNoCov">          0 :   nsGenericHTMLElement* element = nsGenericHTMLElement::FromContentOrNull(aContent);</span>
<span class="lineNum">    6598 </span><span class="lineNoCov">          0 :   return element &amp;&amp; element-&gt;Scrollgrab();</span>
<span class="lineNum">    6599 </span>            : }
<span class="lineNum">    6600 </span>            : 
<span class="lineNum">    6601 </span>            : void
<span class="lineNum">    6602 </span><span class="lineNoCov">          0 : nsContentUtils::FlushLayoutForTree(nsPIDOMWindowOuter* aWindow)</span>
<span class="lineNum">    6603 </span>            : {
<span class="lineNum">    6604 </span><span class="lineNoCov">          0 :   if (!aWindow) {</span>
<span class="lineNum">    6605 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    6606 </span>            :   }
<span class="lineNum">    6607 </span>            : 
<span class="lineNum">    6608 </span>            :   // Note that because FlushPendingNotifications flushes parents, this
<span class="lineNum">    6609 </span>            :   // is O(N^2) in docshell tree depth.  However, the docshell tree is
<span class="lineNum">    6610 </span>            :   // usually pretty shallow.
<span class="lineNum">    6611 </span>            : 
<span class="lineNum">    6612 </span><span class="lineNoCov">          0 :   if (nsCOMPtr&lt;nsIDocument&gt; doc = aWindow-&gt;GetDoc()) {</span>
<span class="lineNum">    6613 </span><span class="lineNoCov">          0 :     doc-&gt;FlushPendingNotifications(FlushType::Layout);</span>
<span class="lineNum">    6614 </span>            :   }
<span class="lineNum">    6615 </span>            : 
<span class="lineNum">    6616 </span><span class="lineNoCov">          0 :   if (nsCOMPtr&lt;nsIDocShell&gt; docShell = aWindow-&gt;GetDocShell()) {</span>
<span class="lineNum">    6617 </span><span class="lineNoCov">          0 :     int32_t i = 0, i_end;</span>
<span class="lineNum">    6618 </span><span class="lineNoCov">          0 :     docShell-&gt;GetChildCount(&amp;i_end);</span>
<span class="lineNum">    6619 </span><span class="lineNoCov">          0 :     for (; i &lt; i_end; ++i) {</span>
<span class="lineNum">    6620 </span>            :       nsCOMPtr&lt;nsIDocShellTreeItem&gt; item;
<span class="lineNum">    6621 </span><span class="lineNoCov">          0 :       docShell-&gt;GetChildAt(i, getter_AddRefs(item));</span>
<span class="lineNum">    6622 </span><span class="lineNoCov">          0 :       if (nsCOMPtr&lt;nsPIDOMWindowOuter&gt; win = item-&gt;GetWindow()) {</span>
<span class="lineNum">    6623 </span><span class="lineNoCov">          0 :         FlushLayoutForTree(win);</span>
<span class="lineNum">    6624 </span>            :       }
<span class="lineNum">    6625 </span>            :     }
<span class="lineNum">    6626 </span>            :   }
<a name="6627"><span class="lineNum">    6627 </span>            : }</a>
<span class="lineNum">    6628 </span>            : 
<span class="lineNum">    6629 </span><span class="lineNoCov">          0 : void nsContentUtils::RemoveNewlines(nsString &amp;aString)</span>
<span class="lineNum">    6630 </span>            : {
<span class="lineNum">    6631 </span>            :   // strip CR/LF and null
<span class="lineNum">    6632 </span>            :   static const char badChars[] = {'\r', '\n', 0};
<span class="lineNum">    6633 </span><span class="lineNoCov">          0 :   aString.StripChars(badChars);</span>
<span class="lineNum">    6634 </span><span class="lineNoCov">          0 : }</span>
<a name="6635"><span class="lineNum">    6635 </span>            : </a>
<span class="lineNum">    6636 </span>            : void
<span class="lineNum">    6637 </span><span class="lineNoCov">          0 : nsContentUtils::PlatformToDOMLineBreaks(nsString &amp;aString)</span>
<span class="lineNum">    6638 </span>            : {
<span class="lineNum">    6639 </span><span class="lineNoCov">          0 :   if (!PlatformToDOMLineBreaks(aString, fallible)) {</span>
<span class="lineNum">    6640 </span><span class="lineNoCov">          0 :     aString.AllocFailed(aString.Length());</span>
<span class="lineNum">    6641 </span>            :   }
<span class="lineNum">    6642 </span><span class="lineNoCov">          0 : }</span>
<a name="6643"><span class="lineNum">    6643 </span>            : </a>
<span class="lineNum">    6644 </span>            : bool
<span class="lineNum">    6645 </span><span class="lineNoCov">          0 : nsContentUtils::PlatformToDOMLineBreaks(nsString&amp; aString, const fallible_t&amp; aFallible)</span>
<span class="lineNum">    6646 </span>            : {
<span class="lineNum">    6647 </span><span class="lineNoCov">          0 :   if (aString.FindChar(char16_t('\r')) != -1) {</span>
<span class="lineNum">    6648 </span>            :     // Windows linebreaks: Map CRLF to LF:
<span class="lineNum">    6649 </span><span class="lineNoCov">          0 :     if (!aString.ReplaceSubstring(u&quot;\r\n&quot;, u&quot;\n&quot;, aFallible)) {</span>
<span class="lineNum">    6650 </span>            :       return false;
<span class="lineNum">    6651 </span>            :     }
<span class="lineNum">    6652 </span>            : 
<span class="lineNum">    6653 </span>            :     // Mac linebreaks: Map any remaining CR to LF:
<span class="lineNum">    6654 </span><span class="lineNoCov">          0 :     if (!aString.ReplaceSubstring(u&quot;\r&quot;, u&quot;\n&quot;, aFallible)) {</span>
<span class="lineNum">    6655 </span>            :       return false;
<span class="lineNum">    6656 </span>            :     }
<span class="lineNum">    6657 </span>            :   }
<span class="lineNum">    6658 </span>            : 
<span class="lineNum">    6659 </span>            :   return true;
<span class="lineNum">    6660 </span>            : }
<a name="6661"><span class="lineNum">    6661 </span>            : </a>
<span class="lineNum">    6662 </span>            : void
<span class="lineNum">    6663 </span><span class="lineNoCov">          0 : nsContentUtils::PopulateStringFromStringBuffer(nsStringBuffer* aBuf,</span>
<span class="lineNum">    6664 </span>            :                                                nsAString&amp; aResultString)
<span class="lineNum">    6665 </span>            : {
<span class="lineNum">    6666 </span>            :   MOZ_ASSERT(aBuf, &quot;Expecting a non-null string buffer&quot;);
<span class="lineNum">    6667 </span>            : 
<span class="lineNum">    6668 </span><span class="lineNoCov">          0 :   uint32_t stringLen = NS_strlen(static_cast&lt;char16_t*&gt;(aBuf-&gt;Data()));</span>
<span class="lineNum">    6669 </span>            : 
<span class="lineNum">    6670 </span>            :   // SANITY CHECK: In case the nsStringBuffer isn't correctly
<span class="lineNum">    6671 </span>            :   // null-terminated, let's clamp its length using the allocated size, to be
<span class="lineNum">    6672 </span>            :   // sure the resulting string doesn't sample past the end of the the buffer.
<span class="lineNum">    6673 </span>            :   // (Note that StorageSize() is in units of bytes, so we have to convert that
<span class="lineNum">    6674 </span>            :   // to units of PRUnichars, and subtract 1 for the null-terminator.)
<span class="lineNum">    6675 </span><span class="lineNoCov">          0 :   uint32_t allocStringLen = (aBuf-&gt;StorageSize() / sizeof(char16_t)) - 1;</span>
<span class="lineNum">    6676 </span>            :   MOZ_ASSERT(stringLen &lt;= allocStringLen,
<span class="lineNum">    6677 </span>            :              &quot;string buffer lacks null terminator!&quot;);
<span class="lineNum">    6678 </span><span class="lineNoCov">          0 :   stringLen = std::min(stringLen, allocStringLen);</span>
<span class="lineNum">    6679 </span>            : 
<span class="lineNum">    6680 </span><span class="lineNoCov">          0 :   aBuf-&gt;ToString(stringLen, aResultString);</span>
<span class="lineNum">    6681 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    6682 </span>            : 
<span class="lineNum">    6683 </span>            : nsIPresShell*
<span class="lineNum">    6684 </span><span class="lineNoCov">          0 : nsContentUtils::FindPresShellForDocument(const nsIDocument* aDoc)</span>
<span class="lineNum">    6685 </span>            : {
<span class="lineNum">    6686 </span><span class="lineNoCov">          0 :   const nsIDocument* doc = aDoc;</span>
<span class="lineNum">    6687 </span><span class="lineNoCov">          0 :   nsIDocument* displayDoc = doc-&gt;GetDisplayDocument();</span>
<span class="lineNum">    6688 </span><span class="lineNoCov">          0 :   if (displayDoc) {</span>
<span class="lineNum">    6689 </span><span class="lineNoCov">          0 :     doc = displayDoc;</span>
<span class="lineNum">    6690 </span>            :   }
<span class="lineNum">    6691 </span>            : 
<span class="lineNum">    6692 </span><span class="lineNoCov">          0 :   nsIPresShell* shell = doc-&gt;GetShell();</span>
<span class="lineNum">    6693 </span><span class="lineNoCov">          0 :   if (shell) {</span>
<span class="lineNum">    6694 </span>            :     return shell;
<span class="lineNum">    6695 </span>            :   }
<span class="lineNum">    6696 </span>            : 
<span class="lineNum">    6697 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellTreeItem = doc-&gt;GetDocShell();</span>
<span class="lineNum">    6698 </span><span class="lineNoCov">          0 :   while (docShellTreeItem) {</span>
<span class="lineNum">    6699 </span>            :     // We may be in a display:none subdocument, or we may not have a presshell
<span class="lineNum">    6700 </span>            :     // created yet.
<span class="lineNum">    6701 </span>            :     // Walk the docshell tree to find the nearest container that has a presshell,
<span class="lineNum">    6702 </span>            :     // and return that.
<span class="lineNum">    6703 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIDocShell&gt; docShell = do_QueryInterface(docShellTreeItem);</span>
<span class="lineNum">    6704 </span><span class="lineNoCov">          0 :     nsIPresShell* presShell = docShell-&gt;GetPresShell();</span>
<span class="lineNum">    6705 </span><span class="lineNoCov">          0 :     if (presShell) {</span>
<span class="lineNum">    6706 </span><span class="lineNoCov">          0 :       return presShell;</span>
<span class="lineNum">    6707 </span>            :     }
<span class="lineNum">    6708 </span>            :     nsCOMPtr&lt;nsIDocShellTreeItem&gt; parent;
<span class="lineNum">    6709 </span><span class="lineNoCov">          0 :     docShellTreeItem-&gt;GetParent(getter_AddRefs(parent));</span>
<span class="lineNum">    6710 </span><span class="lineNoCov">          0 :     docShellTreeItem = parent;</span>
<span class="lineNum">    6711 </span>            :   }
<span class="lineNum">    6712 </span>            : 
<span class="lineNum">    6713 </span>            :   return nullptr;
<span class="lineNum">    6714 </span>            : }
<a name="6715"><span class="lineNum">    6715 </span>            : </a>
<span class="lineNum">    6716 </span>            : nsIWidget*
<span class="lineNum">    6717 </span><span class="lineNoCov">          0 : nsContentUtils::WidgetForDocument(const nsIDocument* aDoc)</span>
<span class="lineNum">    6718 </span>            : {
<span class="lineNum">    6719 </span><span class="lineNoCov">          0 :   nsIPresShell* shell = FindPresShellForDocument(aDoc);</span>
<span class="lineNum">    6720 </span><span class="lineNoCov">          0 :   if (shell) {</span>
<span class="lineNum">    6721 </span><span class="lineNoCov">          0 :     nsViewManager* VM = shell-&gt;GetViewManager();</span>
<span class="lineNum">    6722 </span><span class="lineNoCov">          0 :     if (VM) {</span>
<span class="lineNum">    6723 </span><span class="lineNoCov">          0 :       nsView* rootView = VM-&gt;GetRootView();</span>
<span class="lineNum">    6724 </span><span class="lineNoCov">          0 :       if (rootView) {</span>
<span class="lineNum">    6725 </span><span class="lineNoCov">          0 :         nsView* displayRoot = nsViewManager::GetDisplayRootFor(rootView);</span>
<span class="lineNum">    6726 </span><span class="lineNoCov">          0 :         if (displayRoot) {</span>
<span class="lineNum">    6727 </span><span class="lineNoCov">          0 :           return displayRoot-&gt;GetNearestWidget(nullptr);</span>
<span class="lineNum">    6728 </span>            :         }
<span class="lineNum">    6729 </span>            :       }
<span class="lineNum">    6730 </span>            :     }
<span class="lineNum">    6731 </span>            :   }
<span class="lineNum">    6732 </span>            : 
<span class="lineNum">    6733 </span>            :   return nullptr;
<span class="lineNum">    6734 </span>            : }
<a name="6735"><span class="lineNum">    6735 </span>            : </a>
<span class="lineNum">    6736 </span>            : static already_AddRefed&lt;LayerManager&gt;
<span class="lineNum">    6737 </span><span class="lineNoCov">          0 : LayerManagerForDocumentInternal(const nsIDocument *aDoc, bool aRequirePersistent)</span>
<span class="lineNum">    6738 </span>            : {
<span class="lineNum">    6739 </span><span class="lineNoCov">          0 :   nsIWidget *widget = nsContentUtils::WidgetForDocument(aDoc);</span>
<span class="lineNum">    6740 </span><span class="lineNoCov">          0 :   if (widget) {</span>
<span class="lineNum">    6741 </span>            :     RefPtr&lt;LayerManager&gt; manager =
<span class="lineNum">    6742 </span>            :       widget-&gt;GetLayerManager(aRequirePersistent ? nsIWidget::LAYER_MANAGER_PERSISTENT :
<span class="lineNum">    6743 </span><span class="lineNoCov">          0 :                               nsIWidget::LAYER_MANAGER_CURRENT);</span>
<span class="lineNum">    6744 </span><span class="lineNoCov">          0 :     return manager.forget();</span>
<span class="lineNum">    6745 </span>            :   }
<span class="lineNum">    6746 </span>            : 
<span class="lineNum">    6747 </span><span class="lineNoCov">          0 :   return nullptr;</span>
<span class="lineNum">    6748 </span>            : }
<a name="6749"><span class="lineNum">    6749 </span>            : </a>
<span class="lineNum">    6750 </span>            : already_AddRefed&lt;LayerManager&gt;
<span class="lineNum">    6751 </span><span class="lineNoCov">          0 : nsContentUtils::LayerManagerForDocument(const nsIDocument *aDoc)</span>
<span class="lineNum">    6752 </span>            : {
<span class="lineNum">    6753 </span><span class="lineNoCov">          0 :   return LayerManagerForDocumentInternal(aDoc, false);</span>
<span class="lineNum">    6754 </span>            : }
<a name="6755"><span class="lineNum">    6755 </span>            : </a>
<span class="lineNum">    6756 </span>            : already_AddRefed&lt;LayerManager&gt;
<span class="lineNum">    6757 </span><span class="lineNoCov">          0 : nsContentUtils::PersistentLayerManagerForDocument(nsIDocument *aDoc)</span>
<span class="lineNum">    6758 </span>            : {
<span class="lineNum">    6759 </span><span class="lineNoCov">          0 :   return LayerManagerForDocumentInternal(aDoc, true);</span>
<span class="lineNum">    6760 </span>            : }
<span class="lineNum">    6761 </span>            : 
<span class="lineNum">    6762 </span>            : bool
<span class="lineNum">    6763 </span><span class="lineNoCov">          0 : nsContentUtils::AllowXULXBLForPrincipal(nsIPrincipal* aPrincipal)</span>
<span class="lineNum">    6764 </span>            : {
<span class="lineNum">    6765 </span><span class="lineNoCov">          0 :   if (IsSystemPrincipal(aPrincipal)) {</span>
<span class="lineNum">    6766 </span>            :     return true;
<span class="lineNum">    6767 </span>            :   }
<span class="lineNum">    6768 </span>            : 
<span class="lineNum">    6769 </span>            :   nsCOMPtr&lt;nsIURI&gt; princURI;
<span class="lineNum">    6770 </span><span class="lineNoCov">          0 :   aPrincipal-&gt;GetURI(getter_AddRefs(princURI));</span>
<span class="lineNum">    6771 </span>            : 
<span class="lineNum">    6772 </span><span class="lineNoCov">          0 :   return princURI &amp;&amp;</span>
<span class="lineNum">    6773 </span><span class="lineNoCov">          0 :          ((sAllowXULXBL_for_file &amp;&amp; SchemeIs(princURI, &quot;file&quot;)) ||</span>
<span class="lineNum">    6774 </span><span class="lineNoCov">          0 :           IsSitePermAllow(aPrincipal, &quot;allowXULXBL&quot;));</span>
<span class="lineNum">    6775 </span>            : }
<span class="lineNum">    6776 </span>            : 
<span class="lineNum">    6777 </span>            : bool
<span class="lineNum">    6778 </span><span class="lineNoCov">          0 : nsContentUtils::IsPDFJSEnabled()</span>
<span class="lineNum">    6779 </span>            : {
<span class="lineNum">    6780 </span>            :    nsCOMPtr&lt;nsIStreamConverterService&gt; convServ =
<span class="lineNum">    6781 </span><span class="lineNoCov">          0 :      do_GetService(&quot;@mozilla.org/streamConverters;1&quot;);</span>
<span class="lineNum">    6782 </span><span class="lineNoCov">          0 :    nsresult rv = NS_ERROR_FAILURE;</span>
<span class="lineNum">    6783 </span><span class="lineNoCov">          0 :    bool canConvert = false;</span>
<span class="lineNum">    6784 </span><span class="lineNoCov">          0 :    if (convServ) {</span>
<span class="lineNum">    6785 </span><span class="lineNoCov">          0 :      rv = convServ-&gt;CanConvert(&quot;application/pdf&quot;, &quot;text/html&quot;, &amp;canConvert);</span>
<span class="lineNum">    6786 </span>            :    }
<span class="lineNum">    6787 </span><span class="lineNoCov">          0 :    return NS_SUCCEEDED(rv) &amp;&amp; canConvert;</span>
<span class="lineNum">    6788 </span>            : }
<span class="lineNum">    6789 </span>            : 
<span class="lineNum">    6790 </span>            : already_AddRefed&lt;nsIDocumentLoaderFactory&gt;
<span class="lineNum">    6791 </span><span class="lineNoCov">          0 : nsContentUtils::FindInternalContentViewer(const nsACString&amp; aType,</span>
<span class="lineNum">    6792 </span>            :                                           ContentViewerType* aLoaderType)
<span class="lineNum">    6793 </span>            : {
<span class="lineNum">    6794 </span><span class="lineNoCov">          0 :   if (aLoaderType) {</span>
<span class="lineNum">    6795 </span><span class="lineNoCov">          0 :     *aLoaderType = TYPE_UNSUPPORTED;</span>
<span class="lineNum">    6796 </span>            :   }
<span class="lineNum">    6797 </span>            : 
<span class="lineNum">    6798 </span>            :   // one helper factory, please
<span class="lineNum">    6799 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsICategoryManager&gt; catMan(do_GetService(NS_CATEGORYMANAGER_CONTRACTID));</span>
<span class="lineNum">    6800 </span><span class="lineNoCov">          0 :   if (!catMan)</span>
<span class="lineNum">    6801 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">    6802 </span>            : 
<span class="lineNum">    6803 </span>            :   nsCOMPtr&lt;nsIDocumentLoaderFactory&gt; docFactory;
<span class="lineNum">    6804 </span>            : 
<span class="lineNum">    6805 </span><span class="lineNoCov">          0 :   nsXPIDLCString contractID;</span>
<span class="lineNum">    6806 </span>            :   nsresult rv = catMan-&gt;GetCategoryEntry(&quot;Gecko-Content-Viewers&quot;,
<span class="lineNum">    6807 </span>            :                                          PromiseFlatCString(aType).get(),
<span class="lineNum">    6808 </span><span class="lineNoCov">          0 :                                          getter_Copies(contractID));</span>
<span class="lineNum">    6809 </span><span class="lineNoCov">          0 :   if (NS_SUCCEEDED(rv)) {</span>
<span class="lineNum">    6810 </span><span class="lineNoCov">          0 :     docFactory = do_GetService(contractID);</span>
<span class="lineNum">    6811 </span><span class="lineNoCov">          0 :     if (docFactory &amp;&amp; aLoaderType) {</span>
<span class="lineNum">    6812 </span><span class="lineNoCov">          0 :       if (contractID.EqualsLiteral(CONTENT_DLF_CONTRACTID))</span>
<span class="lineNum">    6813 </span><span class="lineNoCov">          0 :         *aLoaderType = TYPE_CONTENT;</span>
<span class="lineNum">    6814 </span><span class="lineNoCov">          0 :       else if (contractID.EqualsLiteral(PLUGIN_DLF_CONTRACTID))</span>
<span class="lineNum">    6815 </span><span class="lineNoCov">          0 :         *aLoaderType = TYPE_PLUGIN;</span>
<span class="lineNum">    6816 </span>            :       else
<span class="lineNum">    6817 </span><span class="lineNoCov">          0 :       *aLoaderType = TYPE_UNKNOWN;</span>
<span class="lineNum">    6818 </span>            :     }
<span class="lineNum">    6819 </span>            :     return docFactory.forget();
<span class="lineNum">    6820 </span>            :   }
<span class="lineNum">    6821 </span>            : 
<span class="lineNum">    6822 </span><span class="lineNoCov">          0 :   if (DecoderTraits::IsSupportedInVideoDocument(aType)) {</span>
<span class="lineNum">    6823 </span><span class="lineNoCov">          0 :     docFactory = do_GetService(&quot;@mozilla.org/content/document-loader-factory;1&quot;);</span>
<span class="lineNum">    6824 </span><span class="lineNoCov">          0 :     if (docFactory &amp;&amp; aLoaderType) {</span>
<span class="lineNum">    6825 </span><span class="lineNoCov">          0 :       *aLoaderType = TYPE_CONTENT;</span>
<span class="lineNum">    6826 </span>            :     }
<span class="lineNum">    6827 </span>            :     return docFactory.forget();
<span class="lineNum">    6828 </span>            :   }
<span class="lineNum">    6829 </span>            : 
<span class="lineNum">    6830 </span><span class="lineNoCov">          0 :   return nullptr;</span>
<span class="lineNum">    6831 </span>            : }
<a name="6832"><span class="lineNum">    6832 </span>            : </a>
<span class="lineNum">    6833 </span>            : static void
<span class="lineNum">    6834 </span><span class="lineNoCov">          0 : ReportPatternCompileFailure(nsAString&amp; aPattern, nsIDocument* aDocument,</span>
<span class="lineNum">    6835 </span>            :                             JSContext* cx)
<span class="lineNum">    6836 </span>            : {
<span class="lineNum">    6837 </span>            :     MOZ_ASSERT(JS_IsExceptionPending(cx));
<span class="lineNum">    6838 </span>            : 
<span class="lineNum">    6839 </span><span class="lineNoCov">          0 :     JS::RootedValue exn(cx);</span>
<span class="lineNum">    6840 </span><span class="lineNoCov">          0 :     if (!JS_GetPendingException(cx, &amp;exn)) {</span>
<span class="lineNum">    6841 </span>            :       return;
<span class="lineNum">    6842 </span>            :     }
<span class="lineNum">    6843 </span><span class="lineNoCov">          0 :     if (!exn.isObject()) {</span>
<span class="lineNum">    6844 </span>            :       // If pending exception is not an object, it should be OOM.
<span class="lineNum">    6845 </span>            :       return;
<span class="lineNum">    6846 </span>            :     }
<span class="lineNum">    6847 </span>            : 
<span class="lineNum">    6848 </span><span class="lineNoCov">          0 :     JS::AutoSaveExceptionState savedExc(cx);</span>
<span class="lineNum">    6849 </span><span class="lineNoCov">          0 :     JS::RootedObject exnObj(cx, &amp;exn.toObject());</span>
<span class="lineNum">    6850 </span><span class="lineNoCov">          0 :     JS::RootedValue messageVal(cx);</span>
<span class="lineNum">    6851 </span><span class="lineNoCov">          0 :     if (!JS_GetProperty(cx, exnObj, &quot;message&quot;, &amp;messageVal)) {</span>
<span class="lineNum">    6852 </span>            :       return;
<span class="lineNum">    6853 </span>            :     }
<span class="lineNum">    6854 </span>            :     MOZ_ASSERT(messageVal.isString());
<span class="lineNum">    6855 </span>            : 
<span class="lineNum">    6856 </span><span class="lineNoCov">          0 :     JS::RootedString messageStr(cx, messageVal.toString());</span>
<span class="lineNum">    6857 </span>            :     MOZ_ASSERT(messageStr);
<span class="lineNum">    6858 </span>            : 
<span class="lineNum">    6859 </span><span class="lineNoCov">          0 :     nsAutoString wideMessage;</span>
<span class="lineNum">    6860 </span><span class="lineNoCov">          0 :     if (!AssignJSString(cx, wideMessage, messageStr)) {</span>
<span class="lineNum">    6861 </span>            :         return;
<span class="lineNum">    6862 </span>            :     }
<span class="lineNum">    6863 </span>            : 
<span class="lineNum">    6864 </span><span class="lineNoCov">          0 :     const nsString&amp; pattern = PromiseFlatString(aPattern);</span>
<span class="lineNum">    6865 </span><span class="lineNoCov">          0 :     const char16_t *strings[] = { pattern.get(), wideMessage.get() };</span>
<span class="lineNum">    6866 </span>            :     nsContentUtils::ReportToConsole(nsIScriptError::errorFlag,
<span class="lineNum">    6867 </span>            :                                     NS_LITERAL_CSTRING(&quot;DOM&quot;),
<span class="lineNum">    6868 </span>            :                                     aDocument,
<span class="lineNum">    6869 </span>            :                                     nsContentUtils::eDOM_PROPERTIES,
<span class="lineNum">    6870 </span>            :                                     &quot;PatternAttributeCompileFailure&quot;,
<span class="lineNum">    6871 </span><span class="lineNoCov">          0 :                                     strings, ArrayLength(strings));</span>
<span class="lineNum">    6872 </span>            :     savedExc.drop();
<span class="lineNum">    6873 </span>            : }
<span class="lineNum">    6874 </span>            : 
<a name="6875"><span class="lineNum">    6875 </span>            : // static</a>
<span class="lineNum">    6876 </span>            : bool
<span class="lineNum">    6877 </span><span class="lineNoCov">          0 : nsContentUtils::IsPatternMatching(nsAString&amp; aValue, nsAString&amp; aPattern,</span>
<span class="lineNum">    6878 </span>            :                                   nsIDocument* aDocument)
<span class="lineNum">    6879 </span>            : {
<span class="lineNum">    6880 </span>            :   NS_ASSERTION(aDocument, &quot;aDocument should be a valid pointer (not null)&quot;);
<span class="lineNum">    6881 </span>            : 
<span class="lineNum">    6882 </span><span class="lineNoCov">          0 :   AutoJSAPI jsapi;</span>
<span class="lineNum">    6883 </span><span class="lineNoCov">          0 :   jsapi.Init();</span>
<span class="lineNum">    6884 </span><span class="lineNoCov">          0 :   JSContext* cx = jsapi.cx();</span>
<span class="lineNum">    6885 </span>            : 
<span class="lineNum">    6886 </span>            :   // We can use the junk scope here, because we're just using it for
<span class="lineNum">    6887 </span>            :   // regexp evaluation, not actual script execution.
<span class="lineNum">    6888 </span><span class="lineNoCov">          0 :   JSAutoCompartment ac(cx, xpc::UnprivilegedJunkScope());</span>
<span class="lineNum">    6889 </span>            : 
<span class="lineNum">    6890 </span>            :   // The pattern has to match the entire value.
<span class="lineNum">    6891 </span><span class="lineNoCov">          0 :   aPattern.Insert(NS_LITERAL_STRING(&quot;^(?:&quot;), 0);</span>
<span class="lineNum">    6892 </span><span class="lineNoCov">          0 :   aPattern.AppendLiteral(&quot;)$&quot;);</span>
<span class="lineNum">    6893 </span>            : 
<span class="lineNum">    6894 </span>            :   JS::Rooted&lt;JSObject*&gt; re(cx,
<span class="lineNum">    6895 </span>            :     JS_NewUCRegExpObject(cx,
<span class="lineNum">    6896 </span><span class="lineNoCov">          0 :                          static_cast&lt;char16_t*&gt;(aPattern.BeginWriting()),</span>
<span class="lineNum">    6897 </span><span class="lineNoCov">          0 :                          aPattern.Length(), JSREG_UNICODE));</span>
<span class="lineNum">    6898 </span><span class="lineNoCov">          0 :   if (!re) {</span>
<span class="lineNum">    6899 </span>            :     // Remove extra patterns added above to report with the original pattern.
<span class="lineNum">    6900 </span><span class="lineNoCov">          0 :     aPattern.Cut(0, 4);</span>
<span class="lineNum">    6901 </span><span class="lineNoCov">          0 :     aPattern.Cut(aPattern.Length() - 2, 2);</span>
<span class="lineNum">    6902 </span><span class="lineNoCov">          0 :     ReportPatternCompileFailure(aPattern, aDocument, cx);</span>
<span class="lineNum">    6903 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">    6904 </span>            :   }
<span class="lineNum">    6905 </span>            : 
<span class="lineNum">    6906 </span><span class="lineNoCov">          0 :   JS::Rooted&lt;JS::Value&gt; rval(cx, JS::NullValue());</span>
<span class="lineNum">    6907 </span><span class="lineNoCov">          0 :   size_t idx = 0;</span>
<span class="lineNum">    6908 </span><span class="lineNoCov">          0 :   if (!JS_ExecuteRegExpNoStatics(cx, re,</span>
<span class="lineNum">    6909 </span>            :                                  static_cast&lt;char16_t*&gt;(aValue.BeginWriting()),
<span class="lineNum">    6910 </span><span class="lineNoCov">          0 :                                  aValue.Length(), &amp;idx, true, &amp;rval)) {</span>
<span class="lineNum">    6911 </span>            :     return true;
<span class="lineNum">    6912 </span>            :   }
<span class="lineNum">    6913 </span>            : 
<span class="lineNum">    6914 </span><span class="lineNoCov">          0 :   return !rval.isNull();</span>
<span class="lineNum">    6915 </span>            : }
<span class="lineNum">    6916 </span>            : 
<a name="6917"><span class="lineNum">    6917 </span>            : // static</a>
<span class="lineNum">    6918 </span>            : nsresult
<span class="lineNum">    6919 </span><span class="lineNoCov">          0 : nsContentUtils::URIInheritsSecurityContext(nsIURI *aURI, bool *aResult)</span>
<span class="lineNum">    6920 </span>            : {
<span class="lineNum">    6921 </span>            :   // Note: about:blank URIs do NOT inherit the security context from the
<span class="lineNum">    6922 </span>            :   // current document, which is what this function tests for...
<span class="lineNum">    6923 </span>            :   return NS_URIChainHasFlags(aURI,
<span class="lineNum">    6924 </span>            :                              nsIProtocolHandler::URI_INHERITS_SECURITY_CONTEXT,
<span class="lineNum">    6925 </span><span class="lineNoCov">          0 :                              aResult);</span>
<span class="lineNum">    6926 </span>            : }
<span class="lineNum">    6927 </span>            : 
<span class="lineNum">    6928 </span>            : // static
<span class="lineNum">    6929 </span>            : bool
<span class="lineNum">    6930 </span><span class="lineNoCov">          0 : nsContentUtils::ChannelShouldInheritPrincipal(nsIPrincipal* aLoadingPrincipal,</span>
<span class="lineNum">    6931 </span>            :                                               nsIURI* aURI,
<span class="lineNum">    6932 </span>            :                                               bool aInheritForAboutBlank,
<span class="lineNum">    6933 </span>            :                                               bool aForceInherit)
<span class="lineNum">    6934 </span>            : {
<span class="lineNum">    6935 </span>            :   MOZ_ASSERT(aLoadingPrincipal, &quot;Can not check inheritance without a principal&quot;);
<span class="lineNum">    6936 </span>            : 
<span class="lineNum">    6937 </span>            :   // Only tell the channel to inherit if it can't provide its own security context.
<span class="lineNum">    6938 </span>            :   //
<span class="lineNum">    6939 </span>            :   // XXX: If this is ever changed, check all callers for what owners
<span class="lineNum">    6940 </span>            :   //      they're passing in.  In particular, see the code and
<span class="lineNum">    6941 </span>            :   //      comments in nsDocShell::LoadURI where we fall back on
<span class="lineNum">    6942 </span>            :   //      inheriting the owner if called from chrome.  That would be
<span class="lineNum">    6943 </span>            :   //      very wrong if this code changed anything but channels that
<span class="lineNum">    6944 </span>            :   //      can't provide their own security context!
<span class="lineNum">    6945 </span>            :   //
<span class="lineNum">    6946 </span>            :   // If aForceInherit is true, we will inherit, even for a channel that
<span class="lineNum">    6947 </span>            :   // can provide its own security context. This is used for srcdoc loads.
<span class="lineNum">    6948 </span><span class="lineNoCov">          0 :   bool inherit = aForceInherit;</span>
<span class="lineNum">    6949 </span><span class="lineNoCov">          0 :   if (!inherit) {</span>
<span class="lineNum">    6950 </span>            :     bool uriInherits;
<span class="lineNum">    6951 </span>            :     // We expect URIInheritsSecurityContext to return success for an
<span class="lineNum">    6952 </span>            :     // about:blank URI, so don't call NS_IsAboutBlank() if this call fails.
<span class="lineNum">    6953 </span>            :     // This condition needs to match the one in nsDocShell::InternalLoad where
<span class="lineNum">    6954 </span>            :     // we're checking for things that will use the owner.
<span class="lineNum">    6955 </span>            :     inherit =
<span class="lineNum">    6956 </span><span class="lineNoCov">          0 :       (NS_SUCCEEDED(URIInheritsSecurityContext(aURI, &amp;uriInherits)) &amp;&amp;</span>
<span class="lineNum">    6957 </span><span class="lineNoCov">          0 :        (uriInherits || (aInheritForAboutBlank &amp;&amp; NS_IsAboutBlank(aURI)))) ||</span>
<span class="lineNum">    6958 </span>            :       //
<span class="lineNum">    6959 </span>            :       // file: uri special-casing
<span class="lineNum">    6960 </span>            :       //
<span class="lineNum">    6961 </span>            :       // If this is a file: load opened from another file: then it may need
<span class="lineNum">    6962 </span>            :       // to inherit the owner from the referrer so they can script each other.
<span class="lineNum">    6963 </span>            :       // If we don't set the owner explicitly then each file: gets an owner
<span class="lineNum">    6964 </span>            :       // based on its own codebase later.
<span class="lineNum">    6965 </span>            :       //
<span class="lineNum">    6966 </span><span class="lineNoCov">          0 :       (URIIsLocalFile(aURI) &amp;&amp;</span>
<span class="lineNum">    6967 </span><span class="lineNoCov">          0 :        NS_SUCCEEDED(aLoadingPrincipal-&gt;CheckMayLoad(aURI, false, false)) &amp;&amp;</span>
<span class="lineNum">    6968 </span>            :        // One more check here.  CheckMayLoad will always return true for the
<span class="lineNum">    6969 </span>            :        // system principal, but we do NOT want to inherit in that case.
<span class="lineNum">    6970 </span><span class="lineNoCov">          0 :        !IsSystemPrincipal(aLoadingPrincipal));</span>
<span class="lineNum">    6971 </span>            :   }
<span class="lineNum">    6972 </span><span class="lineNoCov">          0 :   return inherit;</span>
<span class="lineNum">    6973 </span>            : }
<span class="lineNum">    6974 </span>            : 
<a name="6975"><span class="lineNum">    6975 </span>            : /* static */</a>
<span class="lineNum">    6976 </span>            : bool
<span class="lineNum">    6977 </span><span class="lineNoCov">          0 : nsContentUtils::IsFullScreenApiEnabled()</span>
<span class="lineNum">    6978 </span>            : {
<span class="lineNum">    6979 </span><span class="lineNoCov">          0 :   return sIsFullScreenApiEnabled;</span>
<span class="lineNum">    6980 </span>            : }
<span class="lineNum">    6981 </span>            : 
<a name="6982"><span class="lineNum">    6982 </span>            : /* static */</a>
<span class="lineNum">    6983 </span>            : bool
<span class="lineNum">    6984 </span><span class="lineNoCov">          0 : nsContentUtils::IsRequestFullScreenAllowed(CallerType aCallerType)</span>
<span class="lineNum">    6985 </span>            : {
<span class="lineNum">    6986 </span><span class="lineNoCov">          0 :   return !sTrustedFullScreenOnly ||</span>
<span class="lineNum">    6987 </span><span class="lineNoCov">          0 :          EventStateManager::IsHandlingUserInput() ||</span>
<span class="lineNum">    6988 </span><span class="lineNoCov">          0 :          aCallerType == CallerType::System;</span>
<span class="lineNum">    6989 </span>            : }
<span class="lineNum">    6990 </span>            : 
<a name="6991"><span class="lineNum">    6991 </span>            : /* static */</a>
<span class="lineNum">    6992 </span>            : bool
<span class="lineNum">    6993 </span><span class="lineNoCov">          0 : nsContentUtils::IsCutCopyAllowed(nsIPrincipal* aSubjectPrincipal)</span>
<span class="lineNum">    6994 </span>            : {
<span class="lineNum">    6995 </span><span class="lineNoCov">          0 :   if (!IsCutCopyRestricted() &amp;&amp; EventStateManager::IsHandlingUserInput()) {</span>
<span class="lineNum">    6996 </span>            :     return true;
<span class="lineNum">    6997 </span>            :   }
<span class="lineNum">    6998 </span>            : 
<span class="lineNum">    6999 </span><span class="lineNoCov">          0 :   return PrincipalHasPermission(aSubjectPrincipal, NS_LITERAL_STRING(&quot;clipboardWrite&quot;));</span>
<span class="lineNum">    7000 </span>            : }
<span class="lineNum">    7001 </span>            : 
<a name="7002"><span class="lineNum">    7002 </span>            : /* static */</a>
<span class="lineNum">    7003 </span>            : bool
<span class="lineNum">    7004 </span><span class="lineNoCov">          0 : nsContentUtils::IsFrameTimingEnabled()</span>
<span class="lineNum">    7005 </span>            : {
<span class="lineNum">    7006 </span><span class="lineNoCov">          0 :   return sIsFrameTimingPrefEnabled;</span>
<span class="lineNum">    7007 </span>            : }
<span class="lineNum">    7008 </span>            : 
<span class="lineNum">    7009 </span>            : /* static */
<span class="lineNum">    7010 </span>            : bool
<span class="lineNum">    7011 </span><span class="lineNoCov">          0 : nsContentUtils::HaveEqualPrincipals(nsIDocument* aDoc1, nsIDocument* aDoc2)</span>
<span class="lineNum">    7012 </span>            : {
<span class="lineNum">    7013 </span><span class="lineNoCov">          0 :   if (!aDoc1 || !aDoc2) {</span>
<span class="lineNum">    7014 </span>            :     return false;
<span class="lineNum">    7015 </span>            :   }
<span class="lineNum">    7016 </span><span class="lineNoCov">          0 :   bool principalsEqual = false;</span>
<span class="lineNum">    7017 </span><span class="lineNoCov">          0 :   aDoc1-&gt;NodePrincipal()-&gt;Equals(aDoc2-&gt;NodePrincipal(), &amp;principalsEqual);</span>
<span class="lineNum">    7018 </span><span class="lineNoCov">          0 :   return principalsEqual;</span>
<span class="lineNum">    7019 </span>            : }
<span class="lineNum">    7020 </span>            : 
<span class="lineNum">    7021 </span>            : /* static */
<span class="lineNum">    7022 </span>            : bool
<span class="lineNum">    7023 </span><span class="lineNoCov">          0 : nsContentUtils::HasPluginWithUncontrolledEventDispatch(nsIContent* aContent)</span>
<span class="lineNum">    7024 </span>            : {
<span class="lineNum">    7025 </span>            : #ifdef XP_MACOSX
<span class="lineNum">    7026 </span>            :   // We control dispatch to all mac plugins.
<span class="lineNum">    7027 </span>            :   return false;
<span class="lineNum">    7028 </span>            : #else
<span class="lineNum">    7029 </span><span class="lineNoCov">          0 :   if (!aContent || !aContent-&gt;IsInUncomposedDoc()) {</span>
<span class="lineNum">    7030 </span>            :     return false;
<span class="lineNum">    7031 </span>            :   }
<span class="lineNum">    7032 </span>            : 
<span class="lineNum">    7033 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIObjectLoadingContent&gt; olc = do_QueryInterface(aContent);</span>
<span class="lineNum">    7034 </span><span class="lineNoCov">          0 :   if (!olc) {</span>
<span class="lineNum">    7035 </span>            :     return false;
<span class="lineNum">    7036 </span>            :   }
<span class="lineNum">    7037 </span>            : 
<span class="lineNum">    7038 </span><span class="lineNoCov">          0 :   RefPtr&lt;nsNPAPIPluginInstance&gt; plugin;</span>
<span class="lineNum">    7039 </span><span class="lineNoCov">          0 :   olc-&gt;GetPluginInstance(getter_AddRefs(plugin));</span>
<span class="lineNum">    7040 </span><span class="lineNoCov">          0 :   if (!plugin) {</span>
<span class="lineNum">    7041 </span>            :     return false;
<span class="lineNum">    7042 </span>            :   }
<span class="lineNum">    7043 </span>            : 
<span class="lineNum">    7044 </span><span class="lineNoCov">          0 :   bool isWindowless = false;</span>
<span class="lineNum">    7045 </span><span class="lineNoCov">          0 :   nsresult res = plugin-&gt;IsWindowless(&amp;isWindowless);</span>
<span class="lineNum">    7046 </span><span class="lineNoCov">          0 :   if (NS_FAILED(res)) {</span>
<span class="lineNum">    7047 </span>            :     return false;
<span class="lineNum">    7048 </span>            :   }
<span class="lineNum">    7049 </span>            : 
<span class="lineNum">    7050 </span><span class="lineNoCov">          0 :   return !isWindowless;</span>
<span class="lineNum">    7051 </span>            : #endif
<span class="lineNum">    7052 </span>            : }
<span class="lineNum">    7053 </span>            : 
<a name="7054"><span class="lineNum">    7054 </span>            : /* static */</a>
<span class="lineNum">    7055 </span>            : void
<span class="lineNum">    7056 </span><span class="lineNoCov">          0 : nsContentUtils::FireMutationEventsForDirectParsing(nsIDocument* aDoc,</span>
<span class="lineNum">    7057 </span>            :                                                    nsIContent* aDest,
<span class="lineNum">    7058 </span>            :                                                    int32_t aOldChildCount)
<span class="lineNum">    7059 </span>            : {
<span class="lineNum">    7060 </span>            :   // Fire mutation events. Optimize for the case when there are no listeners
<span class="lineNum">    7061 </span><span class="lineNoCov">          0 :   int32_t newChildCount = aDest-&gt;GetChildCount();</span>
<span class="lineNum">    7062 </span><span class="lineNoCov">          0 :   if (newChildCount &amp;&amp; nsContentUtils::</span>
<span class="lineNum">    7063 </span><span class="lineNoCov">          0 :         HasMutationListeners(aDoc, NS_EVENT_BITS_MUTATION_NODEINSERTED)) {</span>
<span class="lineNum">    7064 </span><span class="lineNoCov">          0 :     AutoTArray&lt;nsCOMPtr&lt;nsIContent&gt;, 50&gt; childNodes;</span>
<span class="lineNum">    7065 </span>            :     NS_ASSERTION(newChildCount - aOldChildCount &gt;= 0,
<span class="lineNum">    7066 </span>            :                  &quot;What, some unexpected dom mutation has happened?&quot;);
<span class="lineNum">    7067 </span><span class="lineNoCov">          0 :     childNodes.SetCapacity(newChildCount - aOldChildCount);</span>
<span class="lineNum">    7068 </span><span class="lineNoCov">          0 :     for (nsIContent* child = aDest-&gt;GetFirstChild();</span>
<span class="lineNum">    7069 </span>            :          child;
<span class="lineNum">    7070 </span><span class="lineNoCov">          0 :          child = child-&gt;GetNextSibling()) {</span>
<span class="lineNum">    7071 </span><span class="lineNoCov">          0 :       childNodes.AppendElement(child);</span>
<span class="lineNum">    7072 </span>            :     }
<span class="lineNum">    7073 </span><span class="lineNoCov">          0 :     FragmentOrElement::FireNodeInserted(aDoc, aDest, childNodes);</span>
<span class="lineNum">    7074 </span>            :   }
<span class="lineNum">    7075 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    7076 </span>            : 
<a name="7077"><span class="lineNum">    7077 </span>            : /* static */</a>
<span class="lineNum">    7078 </span>            : nsIDocument*
<span class="lineNum">    7079 </span><span class="lineNoCov">          0 : nsContentUtils::GetRootDocument(nsIDocument* aDoc)</span>
<span class="lineNum">    7080 </span>            : {
<span class="lineNum">    7081 </span><span class="lineNoCov">          0 :   if (!aDoc) {</span>
<span class="lineNum">    7082 </span>            :     return nullptr;
<span class="lineNum">    7083 </span>            :   }
<span class="lineNum">    7084 </span>            :   nsIDocument* doc = aDoc;
<span class="lineNum">    7085 </span><span class="lineNoCov">          0 :   while (doc-&gt;GetParentDocument()) {</span>
<span class="lineNum">    7086 </span>            :     doc = doc-&gt;GetParentDocument();
<span class="lineNum">    7087 </span>            :   }
<span class="lineNum">    7088 </span><span class="lineNoCov">          0 :   return doc;</span>
<span class="lineNum">    7089 </span>            : }
<span class="lineNum">    7090 </span>            : 
<span class="lineNum">    7091 </span>            : /* static */
<span class="lineNum">    7092 </span>            : bool
<span class="lineNum">    7093 </span><span class="lineNoCov">          0 : nsContentUtils::IsInPointerLockContext(nsPIDOMWindowOuter* aWin)</span>
<span class="lineNum">    7094 </span>            : {
<span class="lineNum">    7095 </span><span class="lineNoCov">          0 :   if (!aWin) {</span>
<span class="lineNum">    7096 </span>            :     return false;
<span class="lineNum">    7097 </span>            :   }
<span class="lineNum">    7098 </span>            : 
<span class="lineNum">    7099 </span>            :   nsCOMPtr&lt;nsIDocument&gt; pointerLockedDoc =
<span class="lineNum">    7100 </span><span class="lineNoCov">          0 :     do_QueryReferent(EventStateManager::sPointerLockedDoc);</span>
<span class="lineNum">    7101 </span><span class="lineNoCov">          0 :   if (!pointerLockedDoc || !pointerLockedDoc-&gt;GetWindow()) {</span>
<span class="lineNum">    7102 </span>            :     return false;
<span class="lineNum">    7103 </span>            :   }
<span class="lineNum">    7104 </span>            : 
<span class="lineNum">    7105 </span>            :   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; lockTop =
<span class="lineNum">    7106 </span><span class="lineNoCov">          0 :     pointerLockedDoc-&gt;GetWindow()-&gt;GetScriptableTop();</span>
<span class="lineNum">    7107 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; top = aWin-&gt;GetScriptableTop();</span>
<span class="lineNum">    7108 </span>            : 
<span class="lineNum">    7109 </span><span class="lineNoCov">          0 :   return top == lockTop;</span>
<span class="lineNum">    7110 </span>            : }
<span class="lineNum">    7111 </span>            : 
<a name="7112"><span class="lineNum">    7112 </span>            : // static</a>
<span class="lineNum">    7113 </span>            : int32_t
<span class="lineNum">    7114 </span><span class="lineNoCov">          0 : nsContentUtils::GetAdjustedOffsetInTextControl(nsIFrame* aOffsetFrame,</span>
<span class="lineNum">    7115 </span>            :                                                int32_t aOffset)
<span class="lineNum">    7116 </span>            : {
<span class="lineNum">    7117 </span>            :   // The structure of the anonymous frames within a text control frame is
<span class="lineNum">    7118 </span>            :   // an optional block frame, followed by an optional br frame.
<span class="lineNum">    7119 </span>            : 
<span class="lineNum">    7120 </span>            :   // If the offset frame has a child, then this frame is the block which
<span class="lineNum">    7121 </span>            :   // has the text frames (containing the content) as its children. This will
<span class="lineNum">    7122 </span>            :   // be the case if we click to the right of any of the text frames, or at the
<span class="lineNum">    7123 </span>            :   // bottom of the text area.
<span class="lineNum">    7124 </span><span class="lineNoCov">          0 :   nsIFrame* firstChild = aOffsetFrame-&gt;PrincipalChildList().FirstChild();</span>
<span class="lineNum">    7125 </span><span class="lineNoCov">          0 :   if (firstChild) {</span>
<span class="lineNum">    7126 </span>            :     // In this case, the passed-in offset is incorrect, and we want the length
<span class="lineNum">    7127 </span>            :     // of the entire content in the text control frame.
<span class="lineNum">    7128 </span><span class="lineNoCov">          0 :     return firstChild-&gt;GetContent()-&gt;Length();</span>
<span class="lineNum">    7129 </span>            :   }
<span class="lineNum">    7130 </span>            : 
<span class="lineNum">    7131 </span><span class="lineNoCov">          0 :   if (aOffsetFrame-&gt;GetPrevSibling() &amp;&amp;</span>
<span class="lineNum">    7132 </span><span class="lineNoCov">          0 :       !aOffsetFrame-&gt;GetNextSibling()) {</span>
<span class="lineNum">    7133 </span>            :     // In this case, we're actually within the last frame, which is a br
<span class="lineNum">    7134 </span>            :     // frame. Our offset should therefore be the length of the first child of
<span class="lineNum">    7135 </span>            :     // our parent.
<span class="lineNum">    7136 </span>            :     int32_t aOutOffset =
<span class="lineNum">    7137 </span><span class="lineNoCov">          0 :       aOffsetFrame-&gt;GetParent()-&gt;PrincipalChildList().FirstChild()-&gt;GetContent()-&gt;Length();</span>
<span class="lineNum">    7138 </span><span class="lineNoCov">          0 :     return aOutOffset;</span>
<span class="lineNum">    7139 </span>            :   }
<span class="lineNum">    7140 </span>            : 
<span class="lineNum">    7141 </span>            :   // Otherwise, we're within one of the text frames, in which case our offset
<span class="lineNum">    7142 </span>            :   // has already been correctly calculated.
<span class="lineNum">    7143 </span>            :   return aOffset;
<span class="lineNum">    7144 </span>            : }
<span class="lineNum">    7145 </span>            : 
<span class="lineNum">    7146 </span>            : // static
<span class="lineNum">    7147 </span>            : void
<span class="lineNum">    7148 </span><span class="lineNoCov">          0 : nsContentUtils::GetSelectionInTextControl(Selection* aSelection,</span>
<span class="lineNum">    7149 </span>            :                                           Element* aRoot,
<span class="lineNum">    7150 </span>            :                                           uint32_t&amp; aOutStartOffset,
<span class="lineNum">    7151 </span>            :                                           uint32_t&amp; aOutEndOffset)
<span class="lineNum">    7152 </span>            : {
<span class="lineNum">    7153 </span>            :   MOZ_ASSERT(aSelection &amp;&amp; aRoot);
<span class="lineNum">    7154 </span>            : 
<span class="lineNum">    7155 </span>            :   // We don't care which end of this selection is anchor and which is focus.  In
<span class="lineNum">    7156 </span>            :   // fact, we explicitly want to know which is the _start_ and which is the
<span class="lineNum">    7157 </span>            :   // _end_, not anchor vs focus.
<span class="lineNum">    7158 </span><span class="lineNoCov">          0 :   const nsRange* range = aSelection-&gt;GetAnchorFocusRange();</span>
<span class="lineNum">    7159 </span><span class="lineNoCov">          0 :   if (!range) {</span>
<span class="lineNum">    7160 </span>            :     // Nothing selected
<span class="lineNum">    7161 </span><span class="lineNoCov">          0 :     aOutStartOffset = aOutEndOffset = 0;</span>
<span class="lineNum">    7162 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    7163 </span>            :   }
<span class="lineNum">    7164 </span>            : 
<span class="lineNum">    7165 </span>            :   // All the node pointers here are raw pointers for performance.  We shouldn't
<span class="lineNum">    7166 </span>            :   // be doing anything in this function that invalidates the node tree.
<span class="lineNum">    7167 </span><span class="lineNoCov">          0 :   nsINode* startParent = range-&gt;GetStartParent();</span>
<span class="lineNum">    7168 </span><span class="lineNoCov">          0 :   uint32_t startOffset = range-&gt;StartOffset();</span>
<span class="lineNum">    7169 </span><span class="lineNoCov">          0 :   nsINode* endParent = range-&gt;GetEndParent();</span>
<span class="lineNum">    7170 </span><span class="lineNoCov">          0 :   uint32_t endOffset = range-&gt;EndOffset();</span>
<span class="lineNum">    7171 </span>            : 
<span class="lineNum">    7172 </span>            :   // We have at most two children, consisting of an optional text node followed
<span class="lineNum">    7173 </span>            :   // by an optional &lt;br&gt;.
<span class="lineNum">    7174 </span>            :   NS_ASSERTION(aRoot-&gt;GetChildCount() &lt;= 2, &quot;Unexpected children&quot;);
<span class="lineNum">    7175 </span><span class="lineNoCov">          0 :   nsIContent* firstChild = aRoot-&gt;GetFirstChild();</span>
<span class="lineNum">    7176 </span>            : #ifdef DEBUG
<span class="lineNum">    7177 </span>            :   nsCOMPtr&lt;nsIContent&gt; lastChild = aRoot-&gt;GetLastChild();
<span class="lineNum">    7178 </span>            :   NS_ASSERTION(startParent == aRoot || startParent == firstChild ||
<span class="lineNum">    7179 </span>            :                startParent == lastChild, &quot;Unexpected startParent&quot;);
<span class="lineNum">    7180 </span>            :   NS_ASSERTION(endParent == aRoot || endParent == firstChild ||
<span class="lineNum">    7181 </span>            :                endParent == lastChild, &quot;Unexpected endParent&quot;);
<span class="lineNum">    7182 </span>            :   // firstChild is either text or a &lt;br&gt; (hence an element).
<span class="lineNum">    7183 </span>            :   MOZ_ASSERT_IF(firstChild,
<span class="lineNum">    7184 </span>            :                 firstChild-&gt;IsNodeOfType(nsINode::eTEXT) || firstChild-&gt;IsElement());
<span class="lineNum">    7185 </span>            : #endif
<span class="lineNum">    7186 </span>            :   // Testing IsElement() is faster than testing IsNodeOfType(), since it's
<span class="lineNum">    7187 </span>            :   // non-virtual.
<span class="lineNum">    7188 </span><span class="lineNoCov">          0 :   if (!firstChild || firstChild-&gt;IsElement()) {</span>
<span class="lineNum">    7189 </span>            :     // No text node, so everything is 0
<span class="lineNum">    7190 </span>            :     startOffset = endOffset = 0;
<span class="lineNum">    7191 </span>            :   } else {
<span class="lineNum">    7192 </span>            :     // First child is text.  If the start/end is already in the text node,
<span class="lineNum">    7193 </span>            :     // or the start of the root node, no change needed.  If it's in the root
<span class="lineNum">    7194 </span>            :     // node but not the start, or in the trailing &lt;br&gt;, we need to set the
<span class="lineNum">    7195 </span>            :     // offset to the end.
<span class="lineNum">    7196 </span><span class="lineNoCov">          0 :     if ((startParent == aRoot &amp;&amp; startOffset != 0) ||</span>
<span class="lineNum">    7197 </span><span class="lineNoCov">          0 :         (startParent != aRoot &amp;&amp; startParent != firstChild)) {</span>
<span class="lineNum">    7198 </span><span class="lineNoCov">          0 :       startOffset = firstChild-&gt;Length();</span>
<span class="lineNum">    7199 </span>            :     }
<span class="lineNum">    7200 </span><span class="lineNoCov">          0 :     if ((endParent == aRoot &amp;&amp; endOffset != 0) ||</span>
<span class="lineNum">    7201 </span><span class="lineNoCov">          0 :         (endParent != aRoot &amp;&amp; endParent != firstChild)) {</span>
<span class="lineNum">    7202 </span><span class="lineNoCov">          0 :       endOffset = firstChild-&gt;Length();</span>
<span class="lineNum">    7203 </span>            :     }
<span class="lineNum">    7204 </span>            :   }
<span class="lineNum">    7205 </span>            : 
<span class="lineNum">    7206 </span>            :   MOZ_ASSERT(startOffset &lt;= endOffset);
<span class="lineNum">    7207 </span><span class="lineNoCov">          0 :   aOutStartOffset = startOffset;</span>
<span class="lineNum">    7208 </span><span class="lineNoCov">          0 :   aOutEndOffset = endOffset;</span>
<span class="lineNum">    7209 </span>            : }
<span class="lineNum">    7210 </span>            : 
<span class="lineNum">    7211 </span>            : 
<span class="lineNum">    7212 </span>            : nsIEditor*
<span class="lineNum">    7213 </span><span class="lineNoCov">          0 : nsContentUtils::GetHTMLEditor(nsPresContext* aPresContext)</span>
<span class="lineNum">    7214 </span>            : {
<span class="lineNum">    7215 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocShell&gt; docShell(aPresContext-&gt;GetDocShell());</span>
<span class="lineNum">    7216 </span>            :   bool isEditable;
<span class="lineNum">    7217 </span><span class="lineNoCov">          0 :   if (!docShell ||</span>
<span class="lineNum">    7218 </span><span class="lineNoCov">          0 :       NS_FAILED(docShell-&gt;GetEditable(&amp;isEditable)) || !isEditable)</span>
<span class="lineNum">    7219 </span>            :     return nullptr;
<span class="lineNum">    7220 </span>            : 
<span class="lineNum">    7221 </span>            :   nsCOMPtr&lt;nsIEditor&gt; editor;
<span class="lineNum">    7222 </span><span class="lineNoCov">          0 :   docShell-&gt;GetEditor(getter_AddRefs(editor));</span>
<span class="lineNum">    7223 </span><span class="lineNoCov">          0 :   return editor;</span>
<span class="lineNum">    7224 </span>            : }
<a name="7225"><span class="lineNum">    7225 </span>            : </a>
<span class="lineNum">    7226 </span>            : bool
<span class="lineNum">    7227 </span><span class="lineNoCov">          0 : nsContentUtils::IsContentInsertionPoint(nsIContent* aContent)</span>
<span class="lineNum">    7228 </span>            : {
<span class="lineNum">    7229 </span>            :   // Check if the content is a XBL insertion point.
<span class="lineNum">    7230 </span><span class="lineNoCov">          0 :   if (aContent-&gt;IsActiveChildrenElement()) {</span>
<span class="lineNum">    7231 </span>            :     return true;
<span class="lineNum">    7232 </span>            :   }
<span class="lineNum">    7233 </span>            : 
<span class="lineNum">    7234 </span>            :   // Check if the content is a web components content insertion point.
<span class="lineNum">    7235 </span>            :   HTMLContentElement* contentElement =
<span class="lineNum">    7236 </span><span class="lineNoCov">          0 :     HTMLContentElement::FromContent(aContent);</span>
<span class="lineNum">    7237 </span><span class="lineNoCov">          0 :   return contentElement &amp;&amp; contentElement-&gt;IsInsertionPoint();</span>
<span class="lineNum">    7238 </span>            : }
<span class="lineNum">    7239 </span>            : 
<a name="7240"><span class="lineNum">    7240 </span>            : // static</a>
<span class="lineNum">    7241 </span>            : bool
<span class="lineNum">    7242 </span><span class="lineNoCov">          0 : nsContentUtils::HasDistributedChildren(nsIContent* aContent)</span>
<span class="lineNum">    7243 </span>            : {
<span class="lineNum">    7244 </span><span class="lineNoCov">          0 :   if (!aContent) {</span>
<span class="lineNum">    7245 </span>            :     return false;
<span class="lineNum">    7246 </span>            :   }
<span class="lineNum">    7247 </span>            : 
<span class="lineNum">    7248 </span><span class="lineNoCov">          0 :   if (aContent-&gt;GetShadowRoot()) {</span>
<span class="lineNum">    7249 </span>            :     // Children of a shadow root host are distributed
<span class="lineNum">    7250 </span>            :     // to content insertion points in the shadow root.
<span class="lineNum">    7251 </span>            :     return true;
<span class="lineNum">    7252 </span>            :   }
<span class="lineNum">    7253 </span>            : 
<span class="lineNum">    7254 </span><span class="lineNoCov">          0 :   ShadowRoot* shadow = ShadowRoot::FromNode(aContent);</span>
<span class="lineNum">    7255 </span><span class="lineNoCov">          0 :   if (shadow) {</span>
<span class="lineNum">    7256 </span>            :     // Children of a shadow root are distributed to
<span class="lineNum">    7257 </span>            :     // the shadow insertion point of the younger shadow root.
<span class="lineNum">    7258 </span><span class="lineNoCov">          0 :     return shadow-&gt;GetYoungerShadowRoot();</span>
<span class="lineNum">    7259 </span>            :   }
<span class="lineNum">    7260 </span>            : 
<span class="lineNum">    7261 </span><span class="lineNoCov">          0 :   HTMLShadowElement* shadowEl = HTMLShadowElement::FromContent(aContent);</span>
<span class="lineNum">    7262 </span><span class="lineNoCov">          0 :   if (shadowEl &amp;&amp; shadowEl-&gt;IsInsertionPoint()) {</span>
<span class="lineNum">    7263 </span>            :     // Children of a shadow insertion points are distributed
<span class="lineNum">    7264 </span>            :     // to the insertion points in the older shadow root.
<span class="lineNum">    7265 </span><span class="lineNoCov">          0 :     return shadowEl-&gt;GetOlderShadowRoot();</span>
<span class="lineNum">    7266 </span>            :   }
<span class="lineNum">    7267 </span>            : 
<span class="lineNum">    7268 </span><span class="lineNoCov">          0 :   HTMLContentElement* contentEl = HTMLContentElement::FromContent(aContent);</span>
<span class="lineNum">    7269 </span><span class="lineNoCov">          0 :   if (contentEl &amp;&amp; contentEl-&gt;IsInsertionPoint()) {</span>
<span class="lineNum">    7270 </span>            :     // Children of a content insertion point are distributed to the
<span class="lineNum">    7271 </span>            :     // content insertion point if the content insertion point does
<span class="lineNum">    7272 </span>            :     // not match any nodes (fallback content).
<span class="lineNum">    7273 </span><span class="lineNoCov">          0 :     return contentEl-&gt;MatchedNodes().IsEmpty();</span>
<span class="lineNum">    7274 </span>            :   }
<span class="lineNum">    7275 </span>            : 
<span class="lineNum">    7276 </span>            :   return false;
<span class="lineNum">    7277 </span>            : }
<span class="lineNum">    7278 </span>            : 
<a name="7279"><span class="lineNum">    7279 </span>            : // static</a>
<span class="lineNum">    7280 </span>            : bool
<span class="lineNum">    7281 </span><span class="lineNoCov">          0 : nsContentUtils::IsForbiddenRequestHeader(const nsACString&amp; aHeader)</span>
<span class="lineNum">    7282 </span>            : {
<span class="lineNum">    7283 </span><span class="lineNoCov">          0 :   if (IsForbiddenSystemRequestHeader(aHeader)) {</span>
<span class="lineNum">    7284 </span>            :     return true;
<span class="lineNum">    7285 </span>            :   }
<span class="lineNum">    7286 </span>            : 
<span class="lineNum">    7287 </span>            :   return StringBeginsWith(aHeader, NS_LITERAL_CSTRING(&quot;proxy-&quot;),
<span class="lineNum">    7288 </span><span class="lineNoCov">          0 :                           nsCaseInsensitiveCStringComparator()) ||</span>
<span class="lineNum">    7289 </span>            :          StringBeginsWith(aHeader, NS_LITERAL_CSTRING(&quot;sec-&quot;),
<span class="lineNum">    7290 </span><span class="lineNoCov">          0 :                           nsCaseInsensitiveCStringComparator());</span>
<span class="lineNum">    7291 </span>            : }
<span class="lineNum">    7292 </span>            : 
<a name="7293"><span class="lineNum">    7293 </span>            : // static</a>
<span class="lineNum">    7294 </span>            : bool
<span class="lineNum">    7295 </span><span class="lineNoCov">          0 : nsContentUtils::IsForbiddenSystemRequestHeader(const nsACString&amp; aHeader)</span>
<span class="lineNum">    7296 </span>            : {
<span class="lineNum">    7297 </span>            :   static const char *kInvalidHeaders[] = {
<span class="lineNum">    7298 </span>            :     &quot;accept-charset&quot;, &quot;accept-encoding&quot;, &quot;access-control-request-headers&quot;,
<span class="lineNum">    7299 </span>            :     &quot;access-control-request-method&quot;, &quot;connection&quot;, &quot;content-length&quot;,
<span class="lineNum">    7300 </span>            :     &quot;cookie&quot;, &quot;cookie2&quot;, &quot;date&quot;, &quot;dnt&quot;, &quot;expect&quot;, &quot;host&quot;, &quot;keep-alive&quot;,
<span class="lineNum">    7301 </span>            :     &quot;origin&quot;, &quot;referer&quot;, &quot;te&quot;, &quot;trailer&quot;, &quot;transfer-encoding&quot;, &quot;upgrade&quot;, &quot;via&quot;
<span class="lineNum">    7302 </span>            :   };
<span class="lineNum">    7303 </span><span class="lineNoCov">          0 :   for (auto&amp; kInvalidHeader : kInvalidHeaders) {</span>
<span class="lineNum">    7304 </span><span class="lineNoCov">          0 :     if (aHeader.LowerCaseEqualsASCII(kInvalidHeader)) {</span>
<span class="lineNum">    7305 </span>            :       return true;
<span class="lineNum">    7306 </span>            :     }
<span class="lineNum">    7307 </span>            :   }
<span class="lineNum">    7308 </span>            :   return false;
<span class="lineNum">    7309 </span>            : }
<span class="lineNum">    7310 </span>            : 
<a name="7311"><span class="lineNum">    7311 </span>            : // static</a>
<span class="lineNum">    7312 </span>            : bool
<span class="lineNum">    7313 </span><span class="lineNoCov">          0 : nsContentUtils::IsForbiddenResponseHeader(const nsACString&amp; aHeader)</span>
<span class="lineNum">    7314 </span>            : {
<span class="lineNum">    7315 </span><span class="lineNoCov">          0 :   return (aHeader.LowerCaseEqualsASCII(&quot;set-cookie&quot;) ||</span>
<span class="lineNum">    7316 </span><span class="lineNoCov">          0 :           aHeader.LowerCaseEqualsASCII(&quot;set-cookie2&quot;));</span>
<span class="lineNum">    7317 </span>            : }
<span class="lineNum">    7318 </span>            : 
<a name="7319"><span class="lineNum">    7319 </span>            : // static</a>
<span class="lineNum">    7320 </span>            : bool
<span class="lineNum">    7321 </span><span class="lineNoCov">          0 : nsContentUtils::IsAllowedNonCorsContentType(const nsACString&amp; aHeaderValue)</span>
<span class="lineNum">    7322 </span>            : {
<span class="lineNum">    7323 </span><span class="lineNoCov">          0 :   nsAutoCString contentType;</span>
<span class="lineNum">    7324 </span><span class="lineNoCov">          0 :   nsAutoCString unused;</span>
<span class="lineNum">    7325 </span>            : 
<span class="lineNum">    7326 </span><span class="lineNoCov">          0 :   nsresult rv = NS_ParseRequestContentType(aHeaderValue, contentType, unused);</span>
<span class="lineNum">    7327 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    7328 </span>            :     return false;
<span class="lineNum">    7329 </span>            :   }
<span class="lineNum">    7330 </span>            : 
<span class="lineNum">    7331 </span><span class="lineNoCov">          0 :   return contentType.LowerCaseEqualsLiteral(&quot;text/plain&quot;) ||</span>
<span class="lineNum">    7332 </span><span class="lineNoCov">          0 :          contentType.LowerCaseEqualsLiteral(&quot;application/x-www-form-urlencoded&quot;) ||</span>
<span class="lineNum">    7333 </span><span class="lineNoCov">          0 :          contentType.LowerCaseEqualsLiteral(&quot;multipart/form-data&quot;);</span>
<span class="lineNum">    7334 </span>            : }
<a name="7335"><span class="lineNum">    7335 </span>            : </a>
<span class="lineNum">    7336 </span>            : bool
<span class="lineNum">    7337 </span><span class="lineCov">          8 : nsContentUtils::DOMWindowDumpEnabled()</span>
<span class="lineNum">    7338 </span>            : {
<span class="lineNum">    7339 </span>            : #if !(defined(DEBUG) || defined(MOZ_ENABLE_JS_DUMP))
<span class="lineNum">    7340 </span>            :   // In optimized builds we check a pref that controls if we should
<span class="lineNum">    7341 </span>            :   // enable output from dump() or not, in debug builds it's always
<span class="lineNum">    7342 </span>            :   // enabled.
<span class="lineNum">    7343 </span><span class="lineCov">          8 :   return nsContentUtils::sDOMWindowDumpEnabled;</span>
<span class="lineNum">    7344 </span>            : #else
<span class="lineNum">    7345 </span>            :   return true;
<span class="lineNum">    7346 </span>            : #endif
<span class="lineNum">    7347 </span>            : }
<a name="7348"><span class="lineNum">    7348 </span>            : </a>
<span class="lineNum">    7349 </span>            : bool
<span class="lineNum">    7350 </span><span class="lineNoCov">          0 : nsContentUtils::DoNotTrackEnabled()</span>
<span class="lineNum">    7351 </span>            : {
<span class="lineNum">    7352 </span><span class="lineNoCov">          0 :   return nsContentUtils::sDoNotTrackEnabled;</span>
<span class="lineNum">    7353 </span>            : }
<a name="7354"><span class="lineNum">    7354 </span>            : </a>
<span class="lineNum">    7355 </span>            : mozilla::LogModule*
<span class="lineNum">    7356 </span><span class="lineNoCov">          0 : nsContentUtils::DOMDumpLog()</span>
<span class="lineNum">    7357 </span>            : {
<span class="lineNum">    7358 </span><span class="lineNoCov">          0 :   return sDOMDumpLog;</span>
<span class="lineNum">    7359 </span>            : }
<a name="7360"><span class="lineNum">    7360 </span>            : </a>
<span class="lineNum">    7361 </span>            : bool
<span class="lineNum">    7362 </span><span class="lineNoCov">          0 : nsContentUtils::GetNodeTextContent(nsINode* aNode, bool aDeep, nsAString&amp; aResult,</span>
<span class="lineNum">    7363 </span>            :                                    const fallible_t&amp; aFallible)
<span class="lineNum">    7364 </span>            : {
<span class="lineNum">    7365 </span>            :   aResult.Truncate();
<span class="lineNum">    7366 </span><span class="lineNoCov">          0 :   return AppendNodeTextContent(aNode, aDeep, aResult, aFallible);</span>
<span class="lineNum">    7367 </span>            : }
<a name="7368"><span class="lineNum">    7368 </span>            : </a>
<span class="lineNum">    7369 </span>            : void
<span class="lineNum">    7370 </span><span class="lineNoCov">          0 : nsContentUtils::GetNodeTextContent(nsINode* aNode, bool aDeep, nsAString&amp; aResult)</span>
<span class="lineNum">    7371 </span>            : {
<span class="lineNum">    7372 </span><span class="lineNoCov">          0 :   if (!GetNodeTextContent(aNode, aDeep, aResult, fallible)) {</span>
<span class="lineNum">    7373 </span><span class="lineNoCov">          0 :     NS_ABORT_OOM(0); // Unfortunately we don't know the allocation size</span>
<span class="lineNum">    7374 </span>            :   }
<span class="lineNum">    7375 </span><span class="lineNoCov">          0 : }</span>
<a name="7376"><span class="lineNum">    7376 </span>            : </a>
<span class="lineNum">    7377 </span>            : void
<span class="lineNum">    7378 </span><span class="lineNoCov">          0 : nsContentUtils::DestroyMatchString(void* aData)</span>
<span class="lineNum">    7379 </span>            : {
<span class="lineNum">    7380 </span><span class="lineNoCov">          0 :   if (aData) {</span>
<span class="lineNum">    7381 </span><span class="lineNoCov">          0 :     nsString* matchString = static_cast&lt;nsString*&gt;(aData);</span>
<span class="lineNum">    7382 </span><span class="lineNoCov">          0 :     delete matchString;</span>
<span class="lineNum">    7383 </span>            :   }
<span class="lineNum">    7384 </span><span class="lineNoCov">          0 : }</span>
<a name="7385"><span class="lineNum">    7385 </span>            : </a>
<span class="lineNum">    7386 </span>            : bool
<span class="lineNum">    7387 </span><span class="lineNoCov">          0 : nsContentUtils::IsJavascriptMIMEType(const nsAString&amp; aMIMEType)</span>
<span class="lineNum">    7388 </span>            : {
<span class="lineNum">    7389 </span>            :   // Table ordered from most to least likely JS MIME types.
<span class="lineNum">    7390 </span>            :   static const char* jsTypes[] = {
<span class="lineNum">    7391 </span>            :     &quot;text/javascript&quot;,
<span class="lineNum">    7392 </span>            :     &quot;text/ecmascript&quot;,
<span class="lineNum">    7393 </span>            :     &quot;application/javascript&quot;,
<span class="lineNum">    7394 </span>            :     &quot;application/ecmascript&quot;,
<span class="lineNum">    7395 </span>            :     &quot;application/x-javascript&quot;,
<span class="lineNum">    7396 </span>            :     &quot;application/x-ecmascript&quot;,
<span class="lineNum">    7397 </span>            :     &quot;text/javascript1.0&quot;,
<span class="lineNum">    7398 </span>            :     &quot;text/javascript1.1&quot;,
<span class="lineNum">    7399 </span>            :     &quot;text/javascript1.2&quot;,
<span class="lineNum">    7400 </span>            :     &quot;text/javascript1.3&quot;,
<span class="lineNum">    7401 </span>            :     &quot;text/javascript1.4&quot;,
<span class="lineNum">    7402 </span>            :     &quot;text/javascript1.5&quot;,
<span class="lineNum">    7403 </span>            :     &quot;text/jscript&quot;,
<span class="lineNum">    7404 </span>            :     &quot;text/livescript&quot;,
<span class="lineNum">    7405 </span>            :     &quot;text/x-ecmascript&quot;,
<span class="lineNum">    7406 </span>            :     &quot;text/x-javascript&quot;,
<span class="lineNum">    7407 </span>            :     nullptr
<span class="lineNum">    7408 </span>            :   };
<span class="lineNum">    7409 </span>            : 
<span class="lineNum">    7410 </span><span class="lineNoCov">          0 :   for (uint32_t i = 0; jsTypes[i]; ++i) {</span>
<span class="lineNum">    7411 </span><span class="lineNoCov">          0 :     if (aMIMEType.LowerCaseEqualsASCII(jsTypes[i])) {</span>
<span class="lineNum">    7412 </span>            :       return true;
<span class="lineNum">    7413 </span>            :     }
<span class="lineNum">    7414 </span>            :   }
<span class="lineNum">    7415 </span>            : 
<span class="lineNum">    7416 </span>            :   return false;
<span class="lineNum">    7417 </span>            : }
<a name="7418"><span class="lineNum">    7418 </span>            : </a>
<span class="lineNum">    7419 </span>            : nsresult
<span class="lineNum">    7420 </span><span class="lineNoCov">          0 : nsContentUtils::GenerateUUIDInPlace(nsID&amp; aUUID)</span>
<span class="lineNum">    7421 </span>            : {
<span class="lineNum">    7422 </span>            :   MOZ_ASSERT(sUUIDGenerator);
<span class="lineNum">    7423 </span>            : 
<span class="lineNum">    7424 </span><span class="lineNoCov">          0 :   nsresult rv = sUUIDGenerator-&gt;GenerateUUIDInPlace(&amp;aUUID);</span>
<span class="lineNum">    7425 </span><span class="lineNoCov">          0 :   if (NS_WARN_IF(NS_FAILED(rv))) {</span>
<span class="lineNum">    7426 </span><span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">    7427 </span>            :   }
<span class="lineNum">    7428 </span>            : 
<span class="lineNum">    7429 </span>            :   return NS_OK;
<span class="lineNum">    7430 </span>            : }
<span class="lineNum">    7431 </span>            : 
<span class="lineNum">    7432 </span>            : bool
<span class="lineNum">    7433 </span><span class="lineNoCov">          0 : nsContentUtils::PrefetchEnabled(nsIDocShell* aDocShell)</span>
<span class="lineNum">    7434 </span>            : {
<span class="lineNum">    7435 </span>            :   //
<span class="lineNum">    7436 </span>            :   // SECURITY CHECK: disable prefetching from mailnews!
<span class="lineNum">    7437 </span>            :   //
<span class="lineNum">    7438 </span>            :   // walk up the docshell tree to see if any containing
<span class="lineNum">    7439 </span>            :   // docshell are of type MAIL.
<span class="lineNum">    7440 </span>            :   //
<span class="lineNum">    7441 </span>            : 
<span class="lineNum">    7442 </span><span class="lineNoCov">          0 :   if (!aDocShell) {</span>
<span class="lineNum">    7443 </span>            :     return false;
<span class="lineNum">    7444 </span>            :   }
<span class="lineNum">    7445 </span>            : 
<span class="lineNum">    7446 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocShell&gt; docshell = aDocShell;</span>
<span class="lineNum">    7447 </span>            :   nsCOMPtr&lt;nsIDocShellTreeItem&gt; parentItem;
<span class="lineNum">    7448 </span>            : 
<span class="lineNum">    7449 </span><span class="lineNoCov">          0 :   do {</span>
<span class="lineNum">    7450 </span><span class="lineNoCov">          0 :     uint32_t appType = 0;</span>
<span class="lineNum">    7451 </span><span class="lineNoCov">          0 :     nsresult rv = docshell-&gt;GetAppType(&amp;appType);</span>
<span class="lineNum">    7452 </span><span class="lineNoCov">          0 :     if (NS_FAILED(rv) || appType == nsIDocShell::APP_TYPE_MAIL) {</span>
<span class="lineNum">    7453 </span><span class="lineNoCov">          0 :       return false; // do not prefetch, preconnect from mailnews</span>
<span class="lineNum">    7454 </span>            :     }
<span class="lineNum">    7455 </span>            : 
<span class="lineNum">    7456 </span><span class="lineNoCov">          0 :     docshell-&gt;GetParent(getter_AddRefs(parentItem));</span>
<span class="lineNum">    7457 </span><span class="lineNoCov">          0 :     if (parentItem) {</span>
<span class="lineNum">    7458 </span><span class="lineNoCov">          0 :       docshell = do_QueryInterface(parentItem);</span>
<span class="lineNum">    7459 </span><span class="lineNoCov">          0 :       if (!docshell) {</span>
<span class="lineNum">    7460 </span>            :         NS_ERROR(&quot;cannot get a docshell from a treeItem!&quot;);
<span class="lineNum">    7461 </span>            :         return false;
<span class="lineNum">    7462 </span>            :       }
<span class="lineNum">    7463 </span>            :     }
<span class="lineNum">    7464 </span>            :   } while (parentItem);
<span class="lineNum">    7465 </span>            : 
<span class="lineNum">    7466 </span>            :   return true;
<span class="lineNum">    7467 </span>            : }
<span class="lineNum">    7468 </span>            : 
<span class="lineNum">    7469 </span>            : uint64_t
<span class="lineNum">    7470 </span><span class="lineNoCov">          0 : nsContentUtils::GetInnerWindowID(nsIRequest* aRequest)</span>
<span class="lineNum">    7471 </span>            : {
<span class="lineNum">    7472 </span>            :   // can't do anything if there's no nsIRequest!
<span class="lineNum">    7473 </span><span class="lineNoCov">          0 :   if (!aRequest) {</span>
<span class="lineNum">    7474 </span>            :     return 0;
<span class="lineNum">    7475 </span>            :   }
<span class="lineNum">    7476 </span>            : 
<span class="lineNum">    7477 </span>            :   nsCOMPtr&lt;nsILoadGroup&gt; loadGroup;
<span class="lineNum">    7478 </span><span class="lineNoCov">          0 :   nsresult rv = aRequest-&gt;GetLoadGroup(getter_AddRefs(loadGroup));</span>
<span class="lineNum">    7479 </span>            : 
<span class="lineNum">    7480 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv) || !loadGroup) {</span>
<span class="lineNum">    7481 </span>            :     return 0;
<span class="lineNum">    7482 </span>            :   }
<span class="lineNum">    7483 </span>            : 
<span class="lineNum">    7484 </span><span class="lineNoCov">          0 :   return GetInnerWindowID(loadGroup);</span>
<span class="lineNum">    7485 </span>            : }
<span class="lineNum">    7486 </span>            : 
<span class="lineNum">    7487 </span>            : uint64_t
<span class="lineNum">    7488 </span><span class="lineNoCov">          0 : nsContentUtils::GetInnerWindowID(nsILoadGroup* aLoadGroup)</span>
<span class="lineNum">    7489 </span>            : {
<span class="lineNum">    7490 </span><span class="lineNoCov">          0 :   if (!aLoadGroup) {</span>
<span class="lineNum">    7491 </span>            :     return 0;
<span class="lineNum">    7492 </span>            :   }
<span class="lineNum">    7493 </span>            : 
<span class="lineNum">    7494 </span>            :   nsCOMPtr&lt;nsIInterfaceRequestor&gt; callbacks;
<span class="lineNum">    7495 </span><span class="lineNoCov">          0 :   nsresult rv = aLoadGroup-&gt;GetNotificationCallbacks(getter_AddRefs(callbacks));</span>
<span class="lineNum">    7496 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv) || !callbacks) {</span>
<span class="lineNum">    7497 </span>            :     return 0;
<span class="lineNum">    7498 </span>            :   }
<span class="lineNum">    7499 </span>            : 
<span class="lineNum">    7500 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsILoadContext&gt; loadContext = do_GetInterface(callbacks);</span>
<span class="lineNum">    7501 </span><span class="lineNoCov">          0 :   if (!loadContext) {</span>
<span class="lineNum">    7502 </span>            :     return 0;
<span class="lineNum">    7503 </span>            :   }
<span class="lineNum">    7504 </span>            : 
<span class="lineNum">    7505 </span>            :   nsCOMPtr&lt;mozIDOMWindowProxy&gt; window;
<span class="lineNum">    7506 </span><span class="lineNoCov">          0 :   rv = loadContext-&gt;GetAssociatedWindow(getter_AddRefs(window));</span>
<span class="lineNum">    7507 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv) || !window) {</span>
<span class="lineNum">    7508 </span>            :     return 0;
<span class="lineNum">    7509 </span>            :   }
<span class="lineNum">    7510 </span>            : 
<span class="lineNum">    7511 </span><span class="lineNoCov">          0 :   auto* pwindow = nsPIDOMWindowOuter::From(window);</span>
<span class="lineNum">    7512 </span><span class="lineNoCov">          0 :   if (!pwindow) {</span>
<span class="lineNum">    7513 </span>            :     return 0;
<span class="lineNum">    7514 </span>            :   }
<span class="lineNum">    7515 </span>            : 
<span class="lineNum">    7516 </span><span class="lineNoCov">          0 :   nsPIDOMWindowInner* inner = pwindow-&gt;GetCurrentInnerWindow();</span>
<span class="lineNum">    7517 </span><span class="lineNoCov">          0 :   return inner ? inner-&gt;WindowID() : 0;</span>
<span class="lineNum">    7518 </span>            : }
<a name="7519"><span class="lineNum">    7519 </span>            : </a>
<span class="lineNum">    7520 </span>            : nsresult
<span class="lineNum">    7521 </span><span class="lineNoCov">          0 : nsContentUtils::GetHostOrIPv6WithBrackets(nsIURI* aURI, nsCString&amp; aHost)</span>
<span class="lineNum">    7522 </span>            : {
<span class="lineNum">    7523 </span><span class="lineNoCov">          0 :   aHost.Truncate();</span>
<span class="lineNum">    7524 </span><span class="lineNoCov">          0 :   nsresult rv = aURI-&gt;GetHost(aHost);</span>
<span class="lineNum">    7525 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) { // Some URIs do not have a host</span>
<span class="lineNum">    7526 </span>            :     return rv;
<span class="lineNum">    7527 </span>            :   }
<span class="lineNum">    7528 </span>            : 
<span class="lineNum">    7529 </span><span class="lineNoCov">          0 :   if (aHost.FindChar(':') != -1) { // Escape IPv6 address</span>
<span class="lineNum">    7530 </span>            :     MOZ_ASSERT(!aHost.Length() ||
<span class="lineNum">    7531 </span>            :       (aHost[0] !='[' &amp;&amp; aHost[aHost.Length() - 1] != ']'));
<span class="lineNum">    7532 </span><span class="lineNoCov">          0 :     aHost.Insert('[', 0);</span>
<span class="lineNum">    7533 </span><span class="lineNoCov">          0 :     aHost.Append(']');</span>
<span class="lineNum">    7534 </span>            :   }
<span class="lineNum">    7535 </span>            : 
<span class="lineNum">    7536 </span>            :   return NS_OK;
<span class="lineNum">    7537 </span>            : }
<a name="7538"><span class="lineNum">    7538 </span>            : </a>
<span class="lineNum">    7539 </span>            : nsresult
<span class="lineNum">    7540 </span><span class="lineNoCov">          0 : nsContentUtils::GetHostOrIPv6WithBrackets(nsIURI* aURI, nsAString&amp; aHost)</span>
<span class="lineNum">    7541 </span>            : {
<span class="lineNum">    7542 </span><span class="lineNoCov">          0 :   nsAutoCString hostname;</span>
<span class="lineNum">    7543 </span><span class="lineNoCov">          0 :   nsresult rv = GetHostOrIPv6WithBrackets(aURI, hostname);</span>
<span class="lineNum">    7544 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    7545 </span>            :     return rv;
<span class="lineNum">    7546 </span>            :   }
<span class="lineNum">    7547 </span><span class="lineNoCov">          0 :   CopyUTF8toUTF16(hostname, aHost);</span>
<span class="lineNum">    7548 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    7549 </span>            : }
<span class="lineNum">    7550 </span>            : 
<span class="lineNum">    7551 </span>            : bool
<span class="lineNum">    7552 </span><span class="lineNoCov">          0 : nsContentUtils::CallOnAllRemoteChildren(nsIMessageBroadcaster* aManager,</span>
<span class="lineNum">    7553 </span>            :                                         CallOnRemoteChildFunction aCallback,
<span class="lineNum">    7554 </span>            :                                         void* aArg)
<span class="lineNum">    7555 </span>            : {
<span class="lineNum">    7556 </span><span class="lineNoCov">          0 :   uint32_t tabChildCount = 0;</span>
<span class="lineNum">    7557 </span><span class="lineNoCov">          0 :   aManager-&gt;GetChildCount(&amp;tabChildCount);</span>
<span class="lineNum">    7558 </span><span class="lineNoCov">          0 :   for (uint32_t j = 0; j &lt; tabChildCount; ++j) {</span>
<span class="lineNum">    7559 </span>            :     nsCOMPtr&lt;nsIMessageListenerManager&gt; childMM;
<span class="lineNum">    7560 </span><span class="lineNoCov">          0 :     aManager-&gt;GetChildAt(j, getter_AddRefs(childMM));</span>
<span class="lineNum">    7561 </span><span class="lineNoCov">          0 :     if (!childMM) {</span>
<span class="lineNum">    7562 </span>            :       continue;
<span class="lineNum">    7563 </span>            :     }
<span class="lineNum">    7564 </span>            : 
<span class="lineNum">    7565 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIMessageBroadcaster&gt; nonLeafMM = do_QueryInterface(childMM);</span>
<span class="lineNum">    7566 </span><span class="lineNoCov">          0 :     if (nonLeafMM) {</span>
<span class="lineNum">    7567 </span><span class="lineNoCov">          0 :       if (CallOnAllRemoteChildren(nonLeafMM, aCallback, aArg)) {</span>
<span class="lineNum">    7568 </span>            :         return true;
<span class="lineNum">    7569 </span>            :       }
<span class="lineNum">    7570 </span>            :       continue;
<span class="lineNum">    7571 </span>            :     }
<span class="lineNum">    7572 </span>            : 
<span class="lineNum">    7573 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIMessageSender&gt; tabMM = do_QueryInterface(childMM);</span>
<span class="lineNum">    7574 </span>            : 
<span class="lineNum">    7575 </span>            :     mozilla::dom::ipc::MessageManagerCallback* cb =
<span class="lineNum">    7576 </span><span class="lineNoCov">          0 :      static_cast&lt;nsFrameMessageManager*&gt;(tabMM.get())-&gt;GetCallback();</span>
<span class="lineNum">    7577 </span><span class="lineNoCov">          0 :     if (cb) {</span>
<span class="lineNum">    7578 </span><span class="lineNoCov">          0 :       nsFrameLoader* fl = static_cast&lt;nsFrameLoader*&gt;(cb);</span>
<span class="lineNum">    7579 </span><span class="lineNoCov">          0 :       TabParent* remote = TabParent::GetFrom(fl);</span>
<span class="lineNum">    7580 </span><span class="lineNoCov">          0 :       if (remote &amp;&amp; aCallback) {</span>
<span class="lineNum">    7581 </span><span class="lineNoCov">          0 :         if (aCallback(remote, aArg)) {</span>
<span class="lineNum">    7582 </span><span class="lineNoCov">          0 :           return true;</span>
<span class="lineNum">    7583 </span>            :         }
<span class="lineNum">    7584 </span>            :       }
<span class="lineNum">    7585 </span>            :     }
<span class="lineNum">    7586 </span>            :   }
<span class="lineNum">    7587 </span>            : 
<span class="lineNum">    7588 </span>            :   return false;
<span class="lineNum">    7589 </span>            : }
<span class="lineNum">    7590 </span>            : 
<span class="lineNum">    7591 </span>            : void
<span class="lineNum">    7592 </span><span class="lineNoCov">          0 : nsContentUtils::CallOnAllRemoteChildren(nsPIDOMWindowOuter* aWindow,</span>
<span class="lineNum">    7593 </span>            :                                         CallOnRemoteChildFunction aCallback,
<span class="lineNum">    7594 </span>            :                                         void* aArg)
<span class="lineNum">    7595 </span>            : {
<span class="lineNum">    7596 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDOMChromeWindow&gt; chromeWindow(do_QueryInterface(aWindow));</span>
<span class="lineNum">    7597 </span><span class="lineNoCov">          0 :   if (chromeWindow) {</span>
<span class="lineNum">    7598 </span>            :     nsCOMPtr&lt;nsIMessageBroadcaster&gt; windowMM;
<span class="lineNum">    7599 </span><span class="lineNoCov">          0 :     chromeWindow-&gt;GetMessageManager(getter_AddRefs(windowMM));</span>
<span class="lineNum">    7600 </span><span class="lineNoCov">          0 :     if (windowMM) {</span>
<span class="lineNum">    7601 </span><span class="lineNoCov">          0 :       CallOnAllRemoteChildren(windowMM, aCallback, aArg);</span>
<span class="lineNum">    7602 </span>            :     }
<span class="lineNum">    7603 </span>            :   }
<span class="lineNum">    7604 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    7605 </span>            : 
<span class="lineNum">    7606 </span>            : struct UIStateChangeInfo {
<span class="lineNum">    7607 </span>            :   UIStateChangeType mShowAccelerators;
<span class="lineNum">    7608 </span>            :   UIStateChangeType mShowFocusRings;
<span class="lineNum">    7609 </span>            : 
<span class="lineNum">    7610 </span>            :   UIStateChangeInfo(UIStateChangeType aShowAccelerators,
<a name="7611"><span class="lineNum">    7611 </span>            :                     UIStateChangeType aShowFocusRings)</a>
<span class="lineNum">    7612 </span>            :     : mShowAccelerators(aShowAccelerators),
<span class="lineNum">    7613 </span><span class="lineNoCov">          0 :       mShowFocusRings(aShowFocusRings)</span>
<span class="lineNum">    7614 </span>            :   {}
<span class="lineNum">    7615 </span>            : };
<a name="7616"><span class="lineNum">    7616 </span>            : </a>
<span class="lineNum">    7617 </span>            : bool
<span class="lineNum">    7618 </span><span class="lineNoCov">          0 : SetKeyboardIndicatorsChild(TabParent* aParent, void* aArg)</span>
<span class="lineNum">    7619 </span>            : {
<span class="lineNum">    7620 </span><span class="lineNoCov">          0 :   UIStateChangeInfo* stateInfo = static_cast&lt;UIStateChangeInfo*&gt;(aArg);</span>
<span class="lineNum">    7621 </span>            :   Unused &lt;&lt; aParent-&gt;SendSetKeyboardIndicators(stateInfo-&gt;mShowAccelerators,
<span class="lineNum">    7622 </span><span class="lineNoCov">          0 :                                                stateInfo-&gt;mShowFocusRings);</span>
<span class="lineNum">    7623 </span><span class="lineNoCov">          0 :   return false;</span>
<span class="lineNum">    7624 </span>            : }
<span class="lineNum">    7625 </span>            : 
<span class="lineNum">    7626 </span>            : void
<span class="lineNum">    7627 </span><span class="lineNoCov">          0 : nsContentUtils::SetKeyboardIndicatorsOnRemoteChildren(nsPIDOMWindowOuter* aWindow,</span>
<span class="lineNum">    7628 </span>            :                                                       UIStateChangeType aShowAccelerators,
<span class="lineNum">    7629 </span>            :                                                       UIStateChangeType aShowFocusRings)
<span class="lineNum">    7630 </span>            : {
<span class="lineNum">    7631 </span>            :   UIStateChangeInfo stateInfo(aShowAccelerators, aShowFocusRings);
<span class="lineNum">    7632 </span>            :   CallOnAllRemoteChildren(aWindow, SetKeyboardIndicatorsChild,
<span class="lineNum">    7633 </span><span class="lineNoCov">          0 :                           (void *)&amp;stateInfo);</span>
<span class="lineNum">    7634 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    7635 </span>            : 
<span class="lineNum">    7636 </span>            : nsresult
<span class="lineNum">    7637 </span><span class="lineNoCov">          0 : nsContentUtils::IPCTransferableToTransferable(const IPCDataTransfer&amp; aDataTransfer,</span>
<span class="lineNum">    7638 </span>            :                                               const bool&amp; aIsPrivateData,
<span class="lineNum">    7639 </span>            :                                               nsIPrincipal* aRequestingPrincipal,
<span class="lineNum">    7640 </span>            :                                               nsITransferable* aTransferable,
<span class="lineNum">    7641 </span>            :                                               mozilla::dom::nsIContentParent* aContentParent,
<span class="lineNum">    7642 </span>            :                                               mozilla::dom::TabChild* aTabChild)
<span class="lineNum">    7643 </span>            : {
<span class="lineNum">    7644 </span>            :   nsresult rv;
<span class="lineNum">    7645 </span>            : 
<span class="lineNum">    7646 </span><span class="lineNoCov">          0 :   const nsTArray&lt;IPCDataTransferItem&gt;&amp; items = aDataTransfer.items();</span>
<span class="lineNum">    7647 </span><span class="lineNoCov">          0 :   for (const auto&amp; item : items) {</span>
<span class="lineNum">    7648 </span><span class="lineNoCov">          0 :     aTransferable-&gt;AddDataFlavor(item.flavor().get());</span>
<span class="lineNum">    7649 </span>            : 
<span class="lineNum">    7650 </span><span class="lineNoCov">          0 :     if (item.data().type() == IPCDataTransferData::TnsString) {</span>
<span class="lineNum">    7651 </span>            :       nsCOMPtr&lt;nsISupportsString&gt; dataWrapper =
<span class="lineNum">    7652 </span><span class="lineNoCov">          0 :         do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv);</span>
<span class="lineNum">    7653 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    7654 </span>            : 
<span class="lineNum">    7655 </span><span class="lineNoCov">          0 :       const nsString&amp; text = item.data().get_nsString();</span>
<span class="lineNum">    7656 </span><span class="lineNoCov">          0 :       rv = dataWrapper-&gt;SetData(text);</span>
<span class="lineNum">    7657 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    7658 </span>            : 
<span class="lineNum">    7659 </span>            :       rv = aTransferable-&gt;SetTransferData(item.flavor().get(), dataWrapper,
<span class="lineNum">    7660 </span><span class="lineNoCov">          0 :                                   text.Length() * sizeof(char16_t));</span>
<span class="lineNum">    7661 </span>            : 
<span class="lineNum">    7662 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    7663 </span><span class="lineNoCov">          0 :     } else if (item.data().type() == IPCDataTransferData::TShmem) {</span>
<span class="lineNum">    7664 </span><span class="lineNoCov">          0 :       if (nsContentUtils::IsFlavorImage(item.flavor())) {</span>
<span class="lineNum">    7665 </span>            :         nsCOMPtr&lt;imgIContainer&gt; imageContainer;
<span class="lineNum">    7666 </span>            :         rv = nsContentUtils::DataTransferItemToImage(item,
<span class="lineNum">    7667 </span><span class="lineNoCov">          0 :                                                      getter_AddRefs(imageContainer));</span>
<span class="lineNum">    7668 </span><span class="lineNoCov">          0 :         NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    7669 </span>            : 
<span class="lineNum">    7670 </span>            :         nsCOMPtr&lt;nsISupportsInterfacePointer&gt; imgPtr =
<span class="lineNum">    7671 </span><span class="lineNoCov">          0 :           do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID);</span>
<span class="lineNum">    7672 </span><span class="lineNoCov">          0 :         NS_ENSURE_TRUE(imgPtr, NS_ERROR_FAILURE);</span>
<span class="lineNum">    7673 </span>            : 
<span class="lineNum">    7674 </span><span class="lineNoCov">          0 :         rv = imgPtr-&gt;SetData(imageContainer);</span>
<span class="lineNum">    7675 </span><span class="lineNoCov">          0 :         NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    7676 </span>            : 
<span class="lineNum">    7677 </span><span class="lineNoCov">          0 :         aTransferable-&gt;SetTransferData(item.flavor().get(), imgPtr, sizeof(nsISupports*));</span>
<span class="lineNum">    7678 </span>            :       } else {
<span class="lineNum">    7679 </span>            :         nsCOMPtr&lt;nsISupportsCString&gt; dataWrapper =
<span class="lineNum">    7680 </span><span class="lineNoCov">          0 :           do_CreateInstance(NS_SUPPORTS_CSTRING_CONTRACTID, &amp;rv);</span>
<span class="lineNum">    7681 </span><span class="lineNoCov">          0 :         NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    7682 </span>            : 
<span class="lineNum">    7683 </span>            :         // The buffer contains the terminating null.
<span class="lineNum">    7684 </span><span class="lineNoCov">          0 :         Shmem itemData = item.data().get_Shmem();</span>
<span class="lineNum">    7685 </span><span class="lineNoCov">          0 :         const nsDependentCString text(itemData.get&lt;char&gt;(),</span>
<span class="lineNum">    7686 </span><span class="lineNoCov">          0 :                                       itemData.Size&lt;char&gt;());</span>
<span class="lineNum">    7687 </span><span class="lineNoCov">          0 :         rv = dataWrapper-&gt;SetData(text);</span>
<span class="lineNum">    7688 </span><span class="lineNoCov">          0 :         NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    7689 </span>            : 
<span class="lineNum">    7690 </span><span class="lineNoCov">          0 :         rv = aTransferable-&gt;SetTransferData(item.flavor().get(), dataWrapper, text.Length());</span>
<span class="lineNum">    7691 </span>            : 
<span class="lineNum">    7692 </span><span class="lineNoCov">          0 :         NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    7693 </span>            :       }
<span class="lineNum">    7694 </span>            : 
<span class="lineNum">    7695 </span><span class="lineNoCov">          0 :       if (aContentParent) {</span>
<span class="lineNum">    7696 </span><span class="lineNoCov">          0 :         Unused &lt;&lt; aContentParent-&gt;DeallocShmem(item.data().get_Shmem());</span>
<span class="lineNum">    7697 </span><span class="lineNoCov">          0 :       } else if (aTabChild) {</span>
<span class="lineNum">    7698 </span><span class="lineNoCov">          0 :         Unused &lt;&lt; aTabChild-&gt;DeallocShmem(item.data().get_Shmem());</span>
<span class="lineNum">    7699 </span>            :       }
<span class="lineNum">    7700 </span>            :     }
<span class="lineNum">    7701 </span>            :   }
<span class="lineNum">    7702 </span>            : 
<span class="lineNum">    7703 </span><span class="lineNoCov">          0 :   aTransferable-&gt;SetIsPrivateData(aIsPrivateData);</span>
<span class="lineNum">    7704 </span><span class="lineNoCov">          0 :   aTransferable-&gt;SetRequestingPrincipal(aRequestingPrincipal);</span>
<span class="lineNum">    7705 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    7706 </span>            : }
<span class="lineNum">    7707 </span>            : 
<span class="lineNum">    7708 </span>            : void
<span class="lineNum">    7709 </span><span class="lineNoCov">          0 : nsContentUtils::TransferablesToIPCTransferables(nsIArray* aTransferables,</span>
<span class="lineNum">    7710 </span>            :                                                 nsTArray&lt;IPCDataTransfer&gt;&amp; aIPC,
<span class="lineNum">    7711 </span>            :                                                 bool aInSyncMessage,
<span class="lineNum">    7712 </span>            :                                                 mozilla::dom::nsIContentChild* aChild,
<span class="lineNum">    7713 </span>            :                                                 mozilla::dom::nsIContentParent* aParent)
<span class="lineNum">    7714 </span>            : {
<span class="lineNum">    7715 </span><span class="lineNoCov">          0 :   aIPC.Clear();</span>
<span class="lineNum">    7716 </span><span class="lineNoCov">          0 :   if (aTransferables) {</span>
<span class="lineNum">    7717 </span><span class="lineNoCov">          0 :     uint32_t transferableCount = 0;</span>
<span class="lineNum">    7718 </span><span class="lineNoCov">          0 :     aTransferables-&gt;GetLength(&amp;transferableCount);</span>
<span class="lineNum">    7719 </span><span class="lineNoCov">          0 :     for (uint32_t i = 0; i &lt; transferableCount; ++i) {</span>
<span class="lineNum">    7720 </span><span class="lineNoCov">          0 :       IPCDataTransfer* dt = aIPC.AppendElement();</span>
<span class="lineNum">    7721 </span><span class="lineNoCov">          0 :       nsCOMPtr&lt;nsITransferable&gt; transferable = do_QueryElementAt(aTransferables, i);</span>
<span class="lineNum">    7722 </span><span class="lineNoCov">          0 :       TransferableToIPCTransferable(transferable, dt, aInSyncMessage, aChild, aParent);</span>
<span class="lineNum">    7723 </span>            :     }
<span class="lineNum">    7724 </span>            :   }
<span class="lineNum">    7725 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    7726 </span>            : 
<span class="lineNum">    7727 </span>            : nsresult
<span class="lineNum">    7728 </span><span class="lineNoCov">          0 : nsContentUtils::SlurpFileToString(nsIFile* aFile, nsACString&amp; aString)</span>
<span class="lineNum">    7729 </span>            : {
<span class="lineNum">    7730 </span>            :   aString.Truncate();
<span class="lineNum">    7731 </span>            : 
<span class="lineNum">    7732 </span>            :   nsCOMPtr&lt;nsIURI&gt; fileURI;
<span class="lineNum">    7733 </span><span class="lineNoCov">          0 :   nsresult rv = NS_NewFileURI(getter_AddRefs(fileURI), aFile);</span>
<span class="lineNum">    7734 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    7735 </span>            :     return rv;
<span class="lineNum">    7736 </span>            :   }
<span class="lineNum">    7737 </span>            : 
<span class="lineNum">    7738 </span>            :   nsCOMPtr&lt;nsIChannel&gt; channel;
<span class="lineNum">    7739 </span>            :   rv = NS_NewChannel(getter_AddRefs(channel),
<span class="lineNum">    7740 </span>            :                      fileURI,
<span class="lineNum">    7741 </span>            :                      nsContentUtils::GetSystemPrincipal(),
<span class="lineNum">    7742 </span>            :                      nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,
<span class="lineNum">    7743 </span><span class="lineNoCov">          0 :                      nsIContentPolicy::TYPE_OTHER);</span>
<span class="lineNum">    7744 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    7745 </span>            :     return rv;
<span class="lineNum">    7746 </span>            :   }
<span class="lineNum">    7747 </span>            : 
<span class="lineNum">    7748 </span>            :   nsCOMPtr&lt;nsIInputStream&gt; stream;
<span class="lineNum">    7749 </span><span class="lineNoCov">          0 :   rv = channel-&gt;Open2(getter_AddRefs(stream));</span>
<span class="lineNum">    7750 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    7751 </span>            :     return rv;
<span class="lineNum">    7752 </span>            :   }
<span class="lineNum">    7753 </span>            : 
<span class="lineNum">    7754 </span><span class="lineNoCov">          0 :   rv = NS_ConsumeStream(stream, UINT32_MAX, aString);</span>
<span class="lineNum">    7755 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    7756 </span>            :     return rv;
<span class="lineNum">    7757 </span>            :   }
<span class="lineNum">    7758 </span>            : 
<span class="lineNum">    7759 </span><span class="lineNoCov">          0 :   rv = stream-&gt;Close();</span>
<span class="lineNum">    7760 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    7761 </span><span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">    7762 </span>            :   }
<span class="lineNum">    7763 </span>            : 
<span class="lineNum">    7764 </span>            :   return NS_OK;
<span class="lineNum">    7765 </span>            : }
<span class="lineNum">    7766 </span>            : 
<span class="lineNum">    7767 </span>            : bool
<span class="lineNum">    7768 </span><span class="lineNoCov">          0 : nsContentUtils::IsFileImage(nsIFile* aFile, nsACString&amp; aType)</span>
<span class="lineNum">    7769 </span>            : {
<span class="lineNum">    7770 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIMIMEService&gt; mime = do_GetService(&quot;@mozilla.org/mime;1&quot;);</span>
<span class="lineNum">    7771 </span><span class="lineNoCov">          0 :   if (!mime) {</span>
<span class="lineNum">    7772 </span>            :     return false;
<span class="lineNum">    7773 </span>            :   }
<span class="lineNum">    7774 </span>            : 
<span class="lineNum">    7775 </span><span class="lineNoCov">          0 :   nsresult rv = mime-&gt;GetTypeFromFile(aFile, aType);</span>
<span class="lineNum">    7776 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    7777 </span>            :     return false;
<span class="lineNum">    7778 </span>            :   }
<span class="lineNum">    7779 </span>            : 
<span class="lineNum">    7780 </span><span class="lineNoCov">          0 :   return StringBeginsWith(aType, NS_LITERAL_CSTRING(&quot;image/&quot;));</span>
<span class="lineNum">    7781 </span>            : }
<span class="lineNum">    7782 </span>            : 
<span class="lineNum">    7783 </span>            : nsresult
<span class="lineNum">    7784 </span><span class="lineNoCov">          0 : nsContentUtils::DataTransferItemToImage(const IPCDataTransferItem&amp; aItem,</span>
<span class="lineNum">    7785 </span>            :                                         imgIContainer** aContainer)
<span class="lineNum">    7786 </span>            : {
<span class="lineNum">    7787 </span>            :   MOZ_ASSERT(aItem.data().type() == IPCDataTransferData::TShmem);
<span class="lineNum">    7788 </span>            :   MOZ_ASSERT(IsFlavorImage(aItem.flavor()));
<span class="lineNum">    7789 </span>            : 
<span class="lineNum">    7790 </span><span class="lineNoCov">          0 :   const IPCDataTransferImage&amp; imageDetails = aItem.imageDetails();</span>
<span class="lineNum">    7791 </span><span class="lineNoCov">          0 :   const IntSize size(imageDetails.width(), imageDetails.height());</span>
<span class="lineNum">    7792 </span><span class="lineNoCov">          0 :   if (!size.width || !size.height) {</span>
<span class="lineNum">    7793 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">    7794 </span>            :   }
<span class="lineNum">    7795 </span>            : 
<span class="lineNum">    7796 </span><span class="lineNoCov">          0 :   Shmem data = aItem.data().get_Shmem();</span>
<span class="lineNum">    7797 </span>            : 
<span class="lineNum">    7798 </span>            :   RefPtr&lt;DataSourceSurface&gt; image =
<span class="lineNum">    7799 </span>            :       CreateDataSourceSurfaceFromData(size,
<span class="lineNum">    7800 </span>            :                                       static_cast&lt;SurfaceFormat&gt;(imageDetails.format()),
<span class="lineNum">    7801 </span><span class="lineNoCov">          0 :                                       data.get&lt;uint8_t&gt;(),</span>
<span class="lineNum">    7802 </span><span class="lineNoCov">          0 :                                       imageDetails.stride());</span>
<span class="lineNum">    7803 </span>            : 
<span class="lineNum">    7804 </span><span class="lineNoCov">          0 :   RefPtr&lt;gfxDrawable&gt; drawable = new gfxSurfaceDrawable(image, size);</span>
<span class="lineNum">    7805 </span>            :   nsCOMPtr&lt;imgIContainer&gt; imageContainer =
<span class="lineNum">    7806 </span><span class="lineNoCov">          0 :     image::ImageOps::CreateFromDrawable(drawable);</span>
<span class="lineNum">    7807 </span>            :   imageContainer.forget(aContainer);
<span class="lineNum">    7808 </span>            : 
<span class="lineNum">    7809 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    7810 </span>            : }
<a name="7811"><span class="lineNum">    7811 </span>            : </a>
<span class="lineNum">    7812 </span>            : bool
<span class="lineNum">    7813 </span><span class="lineNoCov">          0 : nsContentUtils::IsFlavorImage(const nsACString&amp; aFlavor)</span>
<span class="lineNum">    7814 </span>            : {
<span class="lineNum">    7815 </span><span class="lineNoCov">          0 :   return aFlavor.EqualsLiteral(kNativeImageMime) ||</span>
<span class="lineNum">    7816 </span><span class="lineNoCov">          0 :          aFlavor.EqualsLiteral(kJPEGImageMime) ||</span>
<span class="lineNum">    7817 </span><span class="lineNoCov">          0 :          aFlavor.EqualsLiteral(kJPGImageMime) ||</span>
<span class="lineNum">    7818 </span><span class="lineNoCov">          0 :          aFlavor.EqualsLiteral(kPNGImageMime) ||</span>
<span class="lineNum">    7819 </span><span class="lineNoCov">          0 :          aFlavor.EqualsLiteral(kGIFImageMime);</span>
<span class="lineNum">    7820 </span>            : }
<a name="7821"><span class="lineNum">    7821 </span>            : </a>
<span class="lineNum">    7822 </span>            : static Shmem
<span class="lineNum">    7823 </span><span class="lineNoCov">          0 : ConvertToShmem(mozilla::dom::nsIContentChild* aChild,</span>
<span class="lineNum">    7824 </span>            :                mozilla::dom::nsIContentParent* aParent,
<span class="lineNum">    7825 </span>            :                const nsACString&amp; aInput)
<span class="lineNum">    7826 </span>            : {
<span class="lineNum">    7827 </span>            :   MOZ_ASSERT((aChild &amp;&amp; !aParent) || (!aChild &amp;&amp; aParent));
<span class="lineNum">    7828 </span>            : 
<span class="lineNum">    7829 </span>            :   IShmemAllocator* allocator =
<span class="lineNum">    7830 </span><span class="lineNoCov">          0 :     aChild ? static_cast&lt;IShmemAllocator*&gt;(aChild)</span>
<span class="lineNum">    7831 </span><span class="lineNoCov">          0 :            : static_cast&lt;IShmemAllocator*&gt;(aParent);</span>
<span class="lineNum">    7832 </span>            : 
<span class="lineNum">    7833 </span>            :   Shmem result;
<span class="lineNum">    7834 </span><span class="lineNoCov">          0 :   if (!allocator-&gt;AllocShmem(aInput.Length() + 1,</span>
<span class="lineNum">    7835 </span>            :                              SharedMemory::TYPE_BASIC,
<span class="lineNum">    7836 </span><span class="lineNoCov">          0 :                              &amp;result)) {</span>
<span class="lineNum">    7837 </span>            :     return result;
<span class="lineNum">    7838 </span>            :   }
<span class="lineNum">    7839 </span>            : 
<span class="lineNum">    7840 </span>            :   memcpy(result.get&lt;char&gt;(),
<span class="lineNum">    7841 </span><span class="lineNoCov">          0 :          aInput.BeginReading(),</span>
<span class="lineNum">    7842 </span><span class="lineNoCov">          0 :          aInput.Length() + 1);</span>
<span class="lineNum">    7843 </span>            : 
<span class="lineNum">    7844 </span><span class="lineNoCov">          0 :   return result;</span>
<span class="lineNum">    7845 </span>            : }
<span class="lineNum">    7846 </span>            : 
<span class="lineNum">    7847 </span>            : void
<span class="lineNum">    7848 </span><span class="lineNoCov">          0 : nsContentUtils::TransferableToIPCTransferable(nsITransferable* aTransferable,</span>
<span class="lineNum">    7849 </span>            :                                               IPCDataTransfer* aIPCDataTransfer,
<span class="lineNum">    7850 </span>            :                                               bool aInSyncMessage,
<span class="lineNum">    7851 </span>            :                                               mozilla::dom::nsIContentChild* aChild,
<span class="lineNum">    7852 </span>            :                                               mozilla::dom::nsIContentParent* aParent)
<span class="lineNum">    7853 </span>            : {
<span class="lineNum">    7854 </span>            :   MOZ_ASSERT((aChild &amp;&amp; !aParent) || (!aChild &amp;&amp; aParent));
<span class="lineNum">    7855 </span>            : 
<span class="lineNum">    7856 </span><span class="lineNoCov">          0 :   if (aTransferable) {</span>
<span class="lineNum">    7857 </span>            :     nsCOMPtr&lt;nsIArray&gt; flavorList;
<span class="lineNum">    7858 </span><span class="lineNoCov">          0 :     aTransferable-&gt;FlavorsTransferableCanExport(getter_AddRefs(flavorList));</span>
<span class="lineNum">    7859 </span><span class="lineNoCov">          0 :     if (flavorList) {</span>
<span class="lineNum">    7860 </span><span class="lineNoCov">          0 :       uint32_t flavorCount = 0;</span>
<span class="lineNum">    7861 </span><span class="lineNoCov">          0 :       flavorList-&gt;GetLength(&amp;flavorCount);</span>
<span class="lineNum">    7862 </span><span class="lineNoCov">          0 :       for (uint32_t j = 0; j &lt; flavorCount; ++j) {</span>
<span class="lineNum">    7863 </span><span class="lineNoCov">          0 :         nsCOMPtr&lt;nsISupportsCString&gt; flavor = do_QueryElementAt(flavorList, j);</span>
<span class="lineNum">    7864 </span><span class="lineNoCov">          0 :         if (!flavor) {</span>
<span class="lineNum">    7865 </span>            :           continue;
<span class="lineNum">    7866 </span>            :         }
<span class="lineNum">    7867 </span>            : 
<span class="lineNum">    7868 </span><span class="lineNoCov">          0 :         nsAutoCString flavorStr;</span>
<span class="lineNum">    7869 </span><span class="lineNoCov">          0 :         flavor-&gt;GetData(flavorStr);</span>
<span class="lineNum">    7870 </span><span class="lineNoCov">          0 :         if (!flavorStr.Length()) {</span>
<span class="lineNum">    7871 </span>            :           continue;
<span class="lineNum">    7872 </span>            :         }
<span class="lineNum">    7873 </span>            : 
<span class="lineNum">    7874 </span>            :         nsCOMPtr&lt;nsISupports&gt; data;
<span class="lineNum">    7875 </span><span class="lineNoCov">          0 :         uint32_t dataLen = 0;</span>
<span class="lineNum">    7876 </span><span class="lineNoCov">          0 :         aTransferable-&gt;GetTransferData(flavorStr.get(), getter_AddRefs(data), &amp;dataLen);</span>
<span class="lineNum">    7877 </span>            : 
<span class="lineNum">    7878 </span><span class="lineNoCov">          0 :         nsCOMPtr&lt;nsISupportsString&gt; text = do_QueryInterface(data);</span>
<span class="lineNum">    7879 </span><span class="lineNoCov">          0 :         nsCOMPtr&lt;nsISupportsCString&gt; ctext = do_QueryInterface(data);</span>
<span class="lineNum">    7880 </span><span class="lineNoCov">          0 :         if (text) {</span>
<span class="lineNum">    7881 </span><span class="lineNoCov">          0 :           nsAutoString dataAsString;</span>
<span class="lineNum">    7882 </span><span class="lineNoCov">          0 :           text-&gt;GetData(dataAsString);</span>
<span class="lineNum">    7883 </span><span class="lineNoCov">          0 :           IPCDataTransferItem* item = aIPCDataTransfer-&gt;items().AppendElement();</span>
<span class="lineNum">    7884 </span><span class="lineNoCov">          0 :           item-&gt;flavor() = flavorStr;</span>
<span class="lineNum">    7885 </span><span class="lineNoCov">          0 :           item-&gt;data() = dataAsString;</span>
<span class="lineNum">    7886 </span><span class="lineNoCov">          0 :         } else if (ctext) {</span>
<span class="lineNum">    7887 </span><span class="lineNoCov">          0 :           nsAutoCString dataAsString;</span>
<span class="lineNum">    7888 </span><span class="lineNoCov">          0 :           ctext-&gt;GetData(dataAsString);</span>
<span class="lineNum">    7889 </span><span class="lineNoCov">          0 :           IPCDataTransferItem* item = aIPCDataTransfer-&gt;items().AppendElement();</span>
<span class="lineNum">    7890 </span><span class="lineNoCov">          0 :           item-&gt;flavor() = flavorStr;</span>
<span class="lineNum">    7891 </span>            : 
<span class="lineNum">    7892 </span><span class="lineNoCov">          0 :           Shmem dataAsShmem = ConvertToShmem(aChild, aParent, dataAsString);</span>
<span class="lineNum">    7893 </span><span class="lineNoCov">          0 :           if (!dataAsShmem.IsReadable() || !dataAsShmem.Size&lt;char&gt;()) {</span>
<span class="lineNum">    7894 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    7895 </span>            :           }
<span class="lineNum">    7896 </span>            : 
<span class="lineNum">    7897 </span><span class="lineNoCov">          0 :           item-&gt;data() = dataAsShmem;</span>
<span class="lineNum">    7898 </span>            :         } else {
<span class="lineNum">    7899 </span>            :           nsCOMPtr&lt;nsISupportsInterfacePointer&gt; sip =
<span class="lineNum">    7900 </span><span class="lineNoCov">          0 :             do_QueryInterface(data);</span>
<span class="lineNum">    7901 </span><span class="lineNoCov">          0 :           if (sip) {</span>
<span class="lineNum">    7902 </span><span class="lineNoCov">          0 :             sip-&gt;GetData(getter_AddRefs(data));</span>
<span class="lineNum">    7903 </span>            :           }
<span class="lineNum">    7904 </span>            : 
<span class="lineNum">    7905 </span>            :           // Images to be pasted on the clipboard are nsIInputStreams
<span class="lineNum">    7906 </span><span class="lineNoCov">          0 :           nsCOMPtr&lt;nsIInputStream&gt; stream(do_QueryInterface(data));</span>
<span class="lineNum">    7907 </span><span class="lineNoCov">          0 :           if (stream) {</span>
<span class="lineNum">    7908 </span><span class="lineNoCov">          0 :             IPCDataTransferItem* item = aIPCDataTransfer-&gt;items().AppendElement();</span>
<span class="lineNum">    7909 </span><span class="lineNoCov">          0 :             item-&gt;flavor() = flavorStr;</span>
<span class="lineNum">    7910 </span>            : 
<span class="lineNum">    7911 </span>            :             nsCString imageData;
<span class="lineNum">    7912 </span><span class="lineNoCov">          0 :             NS_ConsumeStream(stream, UINT32_MAX, imageData);</span>
<span class="lineNum">    7913 </span>            : 
<span class="lineNum">    7914 </span><span class="lineNoCov">          0 :             Shmem imageDataShmem = ConvertToShmem(aChild, aParent, imageData);</span>
<span class="lineNum">    7915 </span><span class="lineNoCov">          0 :             if (!imageDataShmem.IsReadable() || !imageDataShmem.Size&lt;char&gt;()) {</span>
<span class="lineNum">    7916 </span>            :               continue;
<span class="lineNum">    7917 </span>            :             }
<span class="lineNum">    7918 </span>            : 
<span class="lineNum">    7919 </span><span class="lineNoCov">          0 :             item-&gt;data() = imageDataShmem;</span>
<span class="lineNum">    7920 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    7921 </span>            :           }
<span class="lineNum">    7922 </span>            : 
<span class="lineNum">    7923 </span>            :           // Images to be placed on the clipboard are imgIContainers.
<span class="lineNum">    7924 </span><span class="lineNoCov">          0 :           nsCOMPtr&lt;imgIContainer&gt; image(do_QueryInterface(data));</span>
<span class="lineNum">    7925 </span><span class="lineNoCov">          0 :           if (image) {</span>
<span class="lineNum">    7926 </span>            :             RefPtr&lt;mozilla::gfx::SourceSurface&gt; surface =
<span class="lineNum">    7927 </span>            :               image-&gt;GetFrame(imgIContainer::FRAME_CURRENT,
<span class="lineNum">    7928 </span><span class="lineNoCov">          0 :                               imgIContainer::FLAG_SYNC_DECODE);</span>
<span class="lineNum">    7929 </span><span class="lineNoCov">          0 :             if (!surface) {</span>
<span class="lineNum">    7930 </span>            :               continue;
<span class="lineNum">    7931 </span>            :             }
<span class="lineNum">    7932 </span>            :             RefPtr&lt;mozilla::gfx::DataSourceSurface&gt; dataSurface =
<span class="lineNum">    7933 </span><span class="lineNoCov">          0 :               surface-&gt;GetDataSurface();</span>
<span class="lineNum">    7934 </span><span class="lineNoCov">          0 :             if (!dataSurface) {</span>
<span class="lineNum">    7935 </span>            :               continue;
<span class="lineNum">    7936 </span>            :             }
<span class="lineNum">    7937 </span>            :             size_t length;
<span class="lineNum">    7938 </span>            :             int32_t stride;
<span class="lineNum">    7939 </span><span class="lineNoCov">          0 :             Shmem surfaceData;</span>
<span class="lineNum">    7940 </span><span class="lineNoCov">          0 :             IShmemAllocator* allocator = aChild ? static_cast&lt;IShmemAllocator*&gt;(aChild)</span>
<span class="lineNum">    7941 </span><span class="lineNoCov">          0 :                                                 : static_cast&lt;IShmemAllocator*&gt;(aParent);</span>
<span class="lineNum">    7942 </span>            :             GetSurfaceData(dataSurface, &amp;length, &amp;stride,
<span class="lineNum">    7943 </span>            :                            allocator,
<span class="lineNum">    7944 </span><span class="lineNoCov">          0 :                            &amp;surfaceData);</span>
<span class="lineNum">    7945 </span>            : 
<span class="lineNum">    7946 </span><span class="lineNoCov">          0 :             IPCDataTransferItem* item = aIPCDataTransfer-&gt;items().AppendElement();</span>
<span class="lineNum">    7947 </span><span class="lineNoCov">          0 :             item-&gt;flavor() = flavorStr;</span>
<span class="lineNum">    7948 </span>            :             // Turn item-&gt;data() into an nsCString prior to accessing it.
<span class="lineNum">    7949 </span><span class="lineNoCov">          0 :             item-&gt;data() = surfaceData;</span>
<span class="lineNum">    7950 </span>            : 
<span class="lineNum">    7951 </span><span class="lineNoCov">          0 :             IPCDataTransferImage&amp; imageDetails = item-&gt;imageDetails();</span>
<span class="lineNum">    7952 </span><span class="lineNoCov">          0 :             mozilla::gfx::IntSize size = dataSurface-&gt;GetSize();</span>
<span class="lineNum">    7953 </span><span class="lineNoCov">          0 :             imageDetails.width() = size.width;</span>
<span class="lineNum">    7954 </span><span class="lineNoCov">          0 :             imageDetails.height() = size.height;</span>
<span class="lineNum">    7955 </span><span class="lineNoCov">          0 :             imageDetails.stride() = stride;</span>
<span class="lineNum">    7956 </span><span class="lineNoCov">          0 :             imageDetails.format() = static_cast&lt;uint8_t&gt;(dataSurface-&gt;GetFormat());</span>
<span class="lineNum">    7957 </span>            : 
<span class="lineNum">    7958 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    7959 </span>            :           }
<span class="lineNum">    7960 </span>            : 
<span class="lineNum">    7961 </span>            :           // Otherwise, handle this as a file.
<span class="lineNum">    7962 </span>            :           nsCOMPtr&lt;BlobImpl&gt; blobImpl;
<span class="lineNum">    7963 </span><span class="lineNoCov">          0 :           nsCOMPtr&lt;nsIFile&gt; file = do_QueryInterface(data);</span>
<span class="lineNum">    7964 </span><span class="lineNoCov">          0 :           if (file) {</span>
<span class="lineNum">    7965 </span>            :             // If we can send this over as a blob, do so. Otherwise, we're
<span class="lineNum">    7966 </span>            :             // responding to a sync message and the child can't process the blob
<span class="lineNum">    7967 </span>            :             // constructor before processing our response, which would crash. In
<span class="lineNum">    7968 </span>            :             // that case, hope that the caller is nsClipboardProxy::GetData,
<span class="lineNum">    7969 </span>            :             // called from editor and send over images as raw data.
<span class="lineNum">    7970 </span><span class="lineNoCov">          0 :             if (aInSyncMessage) {</span>
<span class="lineNum">    7971 </span><span class="lineNoCov">          0 :               nsAutoCString type;</span>
<span class="lineNum">    7972 </span><span class="lineNoCov">          0 :               if (IsFileImage(file, type)) {</span>
<span class="lineNum">    7973 </span><span class="lineNoCov">          0 :                 IPCDataTransferItem* item = aIPCDataTransfer-&gt;items().AppendElement();</span>
<span class="lineNum">    7974 </span><span class="lineNoCov">          0 :                 item-&gt;flavor() = type;</span>
<span class="lineNum">    7975 </span><span class="lineNoCov">          0 :                 nsAutoCString data;</span>
<span class="lineNum">    7976 </span><span class="lineNoCov">          0 :                 SlurpFileToString(file, data);</span>
<span class="lineNum">    7977 </span>            : 
<span class="lineNum">    7978 </span><span class="lineNoCov">          0 :                 Shmem dataAsShmem = ConvertToShmem(aChild, aParent, data);</span>
<span class="lineNum">    7979 </span><span class="lineNoCov">          0 :                 item-&gt;data() = dataAsShmem;</span>
<span class="lineNum">    7980 </span>            :               }
<span class="lineNum">    7981 </span>            : 
<span class="lineNum">    7982 </span>            :               continue;
<span class="lineNum">    7983 </span>            :             }
<span class="lineNum">    7984 </span>            : 
<span class="lineNum">    7985 </span><span class="lineNoCov">          0 :             if (aParent) {</span>
<span class="lineNum">    7986 </span><span class="lineNoCov">          0 :               bool isDir = false;</span>
<span class="lineNum">    7987 </span><span class="lineNoCov">          0 :               if (NS_SUCCEEDED(file-&gt;IsDirectory(&amp;isDir)) &amp;&amp; isDir) {</span>
<span class="lineNum">    7988 </span><span class="lineNoCov">          0 :                 nsAutoString path;</span>
<span class="lineNum">    7989 </span><span class="lineNoCov">          0 :                 if (NS_WARN_IF(NS_FAILED(file-&gt;GetPath(path)))) {</span>
<span class="lineNum">    7990 </span>            :                   continue;
<span class="lineNum">    7991 </span>            :                 }
<span class="lineNum">    7992 </span>            : 
<span class="lineNum">    7993 </span><span class="lineNoCov">          0 :                 RefPtr&lt;FileSystemSecurity&gt; fss = FileSystemSecurity::GetOrCreate();</span>
<span class="lineNum">    7994 </span><span class="lineNoCov">          0 :                 fss-&gt;GrantAccessToContentProcess(aParent-&gt;ChildID(), path);</span>
<span class="lineNum">    7995 </span>            :               }
<span class="lineNum">    7996 </span>            :             }
<span class="lineNum">    7997 </span>            : 
<span class="lineNum">    7998 </span><span class="lineNoCov">          0 :             blobImpl = new FileBlobImpl(file);</span>
<span class="lineNum">    7999 </span>            : 
<span class="lineNum">    8000 </span>            :             IgnoredErrorResult rv;
<span class="lineNum">    8001 </span>            : 
<span class="lineNum">    8002 </span>            :             // Ensure that file data is cached no that the content process
<span class="lineNum">    8003 </span>            :             // has this data available to it when passed over:
<span class="lineNum">    8004 </span><span class="lineNoCov">          0 :             blobImpl-&gt;GetSize(rv);</span>
<span class="lineNum">    8005 </span><span class="lineNoCov">          0 :             if (NS_WARN_IF(rv.Failed())) {</span>
<span class="lineNum">    8006 </span>            :               continue;
<span class="lineNum">    8007 </span>            :             }
<span class="lineNum">    8008 </span>            : 
<span class="lineNum">    8009 </span><span class="lineNoCov">          0 :             blobImpl-&gt;GetLastModified(rv);</span>
<span class="lineNum">    8010 </span><span class="lineNoCov">          0 :             if (NS_WARN_IF(rv.Failed())) {</span>
<span class="lineNum">    8011 </span>            :               continue;
<span class="lineNum">    8012 </span>            :             }
<span class="lineNum">    8013 </span>            :           } else {
<span class="lineNum">    8014 </span><span class="lineNoCov">          0 :             if (aInSyncMessage) {</span>
<span class="lineNum">    8015 </span>            :               // Can't do anything.
<span class="lineNum">    8016 </span>            :               continue;
<span class="lineNum">    8017 </span>            :             }
<span class="lineNum">    8018 </span><span class="lineNoCov">          0 :             blobImpl = do_QueryInterface(data);</span>
<span class="lineNum">    8019 </span>            :           }
<span class="lineNum">    8020 </span><span class="lineNoCov">          0 :           if (blobImpl) {</span>
<span class="lineNum">    8021 </span>            :             IPCDataTransferData data;
<span class="lineNum">    8022 </span>            : 
<span class="lineNum">    8023 </span>            :             // If we failed to create the blob actor, then this blob probably
<span class="lineNum">    8024 </span>            :             // can't get the file size for the underlying file, ignore it for
<span class="lineNum">    8025 </span>            :             // now. TODO pass this through anyway.
<span class="lineNum">    8026 </span><span class="lineNoCov">          0 :             if (aChild) {</span>
<span class="lineNum">    8027 </span>            :               auto* child = mozilla::dom::BlobChild::GetOrCreate(aChild,
<span class="lineNum">    8028 </span><span class="lineNoCov">          0 :                               static_cast&lt;BlobImpl*&gt;(blobImpl.get()));</span>
<span class="lineNum">    8029 </span><span class="lineNoCov">          0 :               if (!child) {</span>
<span class="lineNum">    8030 </span><span class="lineNoCov">          0 :                 continue;</span>
<span class="lineNum">    8031 </span>            :               }
<span class="lineNum">    8032 </span>            : 
<span class="lineNum">    8033 </span><span class="lineNoCov">          0 :               data = child;</span>
<span class="lineNum">    8034 </span><span class="lineNoCov">          0 :             } else if (aParent) {</span>
<span class="lineNum">    8035 </span>            :               auto* parent = mozilla::dom::BlobParent::GetOrCreate(aParent,
<span class="lineNum">    8036 </span><span class="lineNoCov">          0 :                                static_cast&lt;BlobImpl*&gt;(blobImpl.get()));</span>
<span class="lineNum">    8037 </span><span class="lineNoCov">          0 :               if (!parent) {</span>
<span class="lineNum">    8038 </span>            :                 continue;
<span class="lineNum">    8039 </span>            :               }
<span class="lineNum">    8040 </span>            : 
<span class="lineNum">    8041 </span><span class="lineNoCov">          0 :               data = parent;</span>
<span class="lineNum">    8042 </span>            :             }
<span class="lineNum">    8043 </span>            : 
<span class="lineNum">    8044 </span><span class="lineNoCov">          0 :             IPCDataTransferItem* item = aIPCDataTransfer-&gt;items().AppendElement();</span>
<span class="lineNum">    8045 </span><span class="lineNoCov">          0 :             item-&gt;flavor() = flavorStr;</span>
<span class="lineNum">    8046 </span><span class="lineNoCov">          0 :             item-&gt;data() = data;</span>
<span class="lineNum">    8047 </span>            :           } else {
<span class="lineNum">    8048 </span>            :             // This is a hack to support kFilePromiseMime.
<span class="lineNum">    8049 </span>            :             // On Windows there just needs to be an entry for it,
<span class="lineNum">    8050 </span>            :             // and for OSX we need to create
<span class="lineNum">    8051 </span>            :             // nsContentAreaDragDropDataProvider as nsIFlavorDataProvider.
<span class="lineNum">    8052 </span><span class="lineNoCov">          0 :             if (flavorStr.EqualsLiteral(kFilePromiseMime)) {</span>
<span class="lineNum">    8053 </span><span class="lineNoCov">          0 :               IPCDataTransferItem* item = aIPCDataTransfer-&gt;items().AppendElement();</span>
<span class="lineNum">    8054 </span><span class="lineNoCov">          0 :               item-&gt;flavor() = flavorStr;</span>
<span class="lineNum">    8055 </span><span class="lineNoCov">          0 :               item-&gt;data() = NS_ConvertUTF8toUTF16(flavorStr);</span>
<span class="lineNum">    8056 </span><span class="lineNoCov">          0 :             } else if (!data) {</span>
<span class="lineNum">    8057 </span>            :               // Empty element, transfer only the flavor
<span class="lineNum">    8058 </span><span class="lineNoCov">          0 :               IPCDataTransferItem* item = aIPCDataTransfer-&gt;items().AppendElement();</span>
<span class="lineNum">    8059 </span><span class="lineNoCov">          0 :               item-&gt;flavor() = flavorStr;</span>
<span class="lineNum">    8060 </span><span class="lineNoCov">          0 :               item-&gt;data() = nsString();</span>
<span class="lineNum">    8061 </span><span class="lineNoCov">          0 :               continue;</span>
<span class="lineNum">    8062 </span>            :             }
<span class="lineNum">    8063 </span>            :           }
<span class="lineNum">    8064 </span>            :         }
<span class="lineNum">    8065 </span>            :       }
<span class="lineNum">    8066 </span>            :     }
<span class="lineNum">    8067 </span>            :   }
<span class="lineNum">    8068 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    8069 </span>            : 
<span class="lineNum">    8070 </span>            : namespace {
<span class="lineNum">    8071 </span>            : // The default type used for calling GetSurfaceData(). Gets surface data as
<span class="lineNum">    8072 </span>            : // raw buffer.
<span class="lineNum">    8073 </span>            : struct GetSurfaceDataRawBuffer
<span class="lineNum">    8074 </span>            : {
<span class="lineNum">    8075 </span>            :   using ReturnType = mozilla::UniquePtr&lt;char[]&gt;;
<a name="8076"><span class="lineNum">    8076 </span>            :   using BufferType = char*;</a>
<span class="lineNum">    8077 </span>            : 
<span class="lineNum">    8078 </span><span class="lineNoCov">          0 :   ReturnType Allocate(size_t aSize)</span>
<span class="lineNum">    8079 </span>            :   {
<span class="lineNum">    8080 </span><span class="lineNoCov">          0 :     return ReturnType(new char[aSize]);</span>
<span class="lineNum">    8081 </span>            :   }
<span class="lineNum">    8082 </span>            : 
<span class="lineNum">    8083 </span>            :   static BufferType
<span class="lineNum">    8084 </span>            :   GetBuffer(const ReturnType&amp; aReturnValue)
<span class="lineNum">    8085 </span>            :   {
<span class="lineNum">    8086 </span>            :     return aReturnValue.get();
<span class="lineNum">    8087 </span>            :   }
<span class="lineNum">    8088 </span>            : 
<span class="lineNum">    8089 </span>            :   static ReturnType
<span class="lineNum">    8090 </span>            :   NullValue()
<span class="lineNum">    8091 </span>            :   {
<span class="lineNum">    8092 </span>            :     return ReturnType();
<span class="lineNum">    8093 </span>            :   }
<span class="lineNum">    8094 </span>            : };
<span class="lineNum">    8095 </span>            : 
<span class="lineNum">    8096 </span>            : // The type used for calling GetSurfaceData() that allocates and writes to
<span class="lineNum">    8097 </span>            : // a shared memory buffer.
<span class="lineNum">    8098 </span>            : struct GetSurfaceDataShmem
<span class="lineNum">    8099 </span>            : {
<span class="lineNum">    8100 </span>            :   using ReturnType = Shmem;
<span class="lineNum">    8101 </span>            :   using BufferType = char*;
<a name="8102"><span class="lineNum">    8102 </span>            : </a>
<span class="lineNum">    8103 </span>            :   explicit GetSurfaceDataShmem(IShmemAllocator* aAllocator)
<span class="lineNum">    8104 </span><span class="lineNoCov">          0 :     : mAllocator(aAllocator)</span>
<a name="8105"><span class="lineNum">    8105 </span>            :   { }</a>
<span class="lineNum">    8106 </span>            : 
<span class="lineNum">    8107 </span><span class="lineNoCov">          0 :   ReturnType Allocate(size_t aSize)</span>
<span class="lineNum">    8108 </span>            :   {
<span class="lineNum">    8109 </span>            :     Shmem returnValue;
<span class="lineNum">    8110 </span>            :     mAllocator-&gt;AllocShmem(aSize,
<span class="lineNum">    8111 </span>            :                            SharedMemory::TYPE_BASIC,
<span class="lineNum">    8112 </span><span class="lineNoCov">          0 :                            &amp;returnValue);</span>
<span class="lineNum">    8113 </span><span class="lineNoCov">          0 :     return returnValue;</span>
<span class="lineNum">    8114 </span>            :   }
<span class="lineNum">    8115 </span>            : 
<span class="lineNum">    8116 </span>            :   static BufferType
<a name="8117"><span class="lineNum">    8117 </span>            :   GetBuffer(const ReturnType&amp; aReturnValue)</a>
<span class="lineNum">    8118 </span>            :   {
<span class="lineNum">    8119 </span><span class="lineNoCov">          0 :     return aReturnValue.get&lt;char&gt;();</span>
<span class="lineNum">    8120 </span>            :   }
<span class="lineNum">    8121 </span>            : 
<span class="lineNum">    8122 </span>            :   static ReturnType
<span class="lineNum">    8123 </span>            :   NullValue()
<span class="lineNum">    8124 </span>            :   {
<span class="lineNum">    8125 </span>            :     return ReturnType();
<span class="lineNum">    8126 </span>            :   }
<span class="lineNum">    8127 </span>            : private:
<span class="lineNum">    8128 </span>            :   IShmemAllocator* mAllocator;
<span class="lineNum">    8129 </span>            : };
<span class="lineNum">    8130 </span>            : 
<span class="lineNum">    8131 </span>            : /*
<span class="lineNum">    8132 </span>            :  * Get the pixel data from the given source surface and return it as a buffer.
<span class="lineNum">    8133 </span>            :  * The length and stride will be assigned from the surface.
<span class="lineNum">    8134 </span>            :  */
<a name="8135"><span class="lineNum">    8135 </span>            : template &lt;typename GetSurfaceDataContext = GetSurfaceDataRawBuffer&gt;</a>
<span class="lineNum">    8136 </span>            : typename GetSurfaceDataContext::ReturnType
<span class="lineNum">    8137 </span><span class="lineNoCov">          0 : GetSurfaceDataImpl(mozilla::gfx::DataSourceSurface* aSurface,</span>
<span class="lineNum">    8138 </span>            :                    size_t* aLength, int32_t* aStride,
<span class="lineNum">    8139 </span>            :                    GetSurfaceDataContext aContext = GetSurfaceDataContext())
<span class="lineNum">    8140 </span>            : {
<span class="lineNum">    8141 </span>            :   mozilla::gfx::DataSourceSurface::MappedSurface map;
<span class="lineNum">    8142 </span><span class="lineNoCov">          0 :   if (!aSurface-&gt;Map(mozilla::gfx::DataSourceSurface::MapType::READ, &amp;map)) {</span>
<span class="lineNum">    8143 </span>            :     return GetSurfaceDataContext::NullValue();
<span class="lineNum">    8144 </span>            :   }
<span class="lineNum">    8145 </span>            : 
<span class="lineNum">    8146 </span><span class="lineNoCov">          0 :   mozilla::gfx::IntSize size = aSurface-&gt;GetSize();</span>
<span class="lineNum">    8147 </span>            :   mozilla::CheckedInt32 requiredBytes =
<span class="lineNum">    8148 </span><span class="lineNoCov">          0 :     mozilla::CheckedInt32(map.mStride) * mozilla::CheckedInt32(size.height);</span>
<span class="lineNum">    8149 </span><span class="lineNoCov">          0 :   if (!requiredBytes.isValid()) {</span>
<span class="lineNum">    8150 </span>            :     return GetSurfaceDataContext::NullValue();
<span class="lineNum">    8151 </span>            :   }
<span class="lineNum">    8152 </span>            : 
<span class="lineNum">    8153 </span><span class="lineNoCov">          0 :   size_t maxBufLen = requiredBytes.value();</span>
<span class="lineNum">    8154 </span><span class="lineNoCov">          0 :   mozilla::gfx::SurfaceFormat format = aSurface-&gt;GetFormat();</span>
<span class="lineNum">    8155 </span>            : 
<span class="lineNum">    8156 </span>            :   // Surface data handling is totally nuts. This is the magic one needs to
<span class="lineNum">    8157 </span>            :   // know to access the data.
<span class="lineNum">    8158 </span><span class="lineNoCov">          0 :   size_t bufLen = maxBufLen - map.mStride + (size.width * BytesPerPixel(format));</span>
<span class="lineNum">    8159 </span>            : 
<span class="lineNum">    8160 </span>            :   // nsDependentCString wants null-terminated string.
<span class="lineNum">    8161 </span><span class="lineNoCov">          0 :   typename GetSurfaceDataContext::ReturnType surfaceData = aContext.Allocate(maxBufLen + 1);</span>
<span class="lineNum">    8162 </span><span class="lineNoCov">          0 :   if (GetSurfaceDataContext::GetBuffer(surfaceData)) {</span>
<span class="lineNum">    8163 </span><span class="lineNoCov">          0 :     memcpy(GetSurfaceDataContext::GetBuffer(surfaceData),</span>
<span class="lineNum">    8164 </span>            :            reinterpret_cast&lt;char*&gt;(map.mData),
<span class="lineNum">    8165 </span><span class="lineNoCov">          0 :            bufLen);</span>
<span class="lineNum">    8166 </span><span class="lineNoCov">          0 :     memset(GetSurfaceDataContext::GetBuffer(surfaceData) + bufLen,</span>
<span class="lineNum">    8167 </span>            :            0,
<span class="lineNum">    8168 </span><span class="lineNoCov">          0 :            maxBufLen - bufLen + 1);</span>
<span class="lineNum">    8169 </span>            :   }
<span class="lineNum">    8170 </span>            : 
<span class="lineNum">    8171 </span><span class="lineNoCov">          0 :   *aLength = maxBufLen;</span>
<span class="lineNum">    8172 </span><span class="lineNoCov">          0 :   *aStride = map.mStride;</span>
<span class="lineNum">    8173 </span>            : 
<span class="lineNum">    8174 </span><span class="lineNoCov">          0 :   aSurface-&gt;Unmap();</span>
<span class="lineNum">    8175 </span><span class="lineNoCov">          0 :   return surfaceData;</span>
<span class="lineNum">    8176 </span>            : }
<span class="lineNum">    8177 </span>            : } // Anonymous namespace.
<a name="8178"><span class="lineNum">    8178 </span>            : </a>
<span class="lineNum">    8179 </span>            : mozilla::UniquePtr&lt;char[]&gt;
<span class="lineNum">    8180 </span><span class="lineNoCov">          0 : nsContentUtils::GetSurfaceData(</span>
<span class="lineNum">    8181 </span>            :   NotNull&lt;mozilla::gfx::DataSourceSurface*&gt; aSurface,
<span class="lineNum">    8182 </span>            :   size_t* aLength, int32_t* aStride)
<span class="lineNum">    8183 </span>            : {
<span class="lineNum">    8184 </span><span class="lineNoCov">          0 :   return GetSurfaceDataImpl(aSurface, aLength, aStride);</span>
<span class="lineNum">    8185 </span>            : }
<span class="lineNum">    8186 </span>            : 
<span class="lineNum">    8187 </span>            : void
<span class="lineNum">    8188 </span><span class="lineNoCov">          0 : nsContentUtils::GetSurfaceData(mozilla::gfx::DataSourceSurface* aSurface,</span>
<span class="lineNum">    8189 </span>            :                                size_t* aLength, int32_t* aStride,
<span class="lineNum">    8190 </span>            :                                IShmemAllocator* aAllocator,
<span class="lineNum">    8191 </span>            :                                Shmem *aOutShmem)
<span class="lineNum">    8192 </span>            : {
<span class="lineNum">    8193 </span><span class="lineNoCov">          0 :   *aOutShmem = GetSurfaceDataImpl(aSurface, aLength, aStride,</span>
<span class="lineNum">    8194 </span><span class="lineNoCov">          0 :                                   GetSurfaceDataShmem(aAllocator));</span>
<span class="lineNum">    8195 </span><span class="lineNoCov">          0 : }</span>
<a name="8196"><span class="lineNum">    8196 </span>            : </a>
<span class="lineNum">    8197 </span>            : mozilla::Modifiers
<span class="lineNum">    8198 </span><span class="lineNoCov">          0 : nsContentUtils::GetWidgetModifiers(int32_t aModifiers)</span>
<span class="lineNum">    8199 </span>            : {
<span class="lineNum">    8200 </span><span class="lineNoCov">          0 :   Modifiers result = 0;</span>
<span class="lineNum">    8201 </span><span class="lineNoCov">          0 :   if (aModifiers &amp; nsIDOMWindowUtils::MODIFIER_SHIFT) {</span>
<span class="lineNum">    8202 </span><span class="lineNoCov">          0 :     result |= mozilla::MODIFIER_SHIFT;</span>
<span class="lineNum">    8203 </span>            :   }
<span class="lineNum">    8204 </span><span class="lineNoCov">          0 :   if (aModifiers &amp; nsIDOMWindowUtils::MODIFIER_CONTROL) {</span>
<span class="lineNum">    8205 </span><span class="lineNoCov">          0 :     result |= mozilla::MODIFIER_CONTROL;</span>
<span class="lineNum">    8206 </span>            :   }
<span class="lineNum">    8207 </span><span class="lineNoCov">          0 :   if (aModifiers &amp; nsIDOMWindowUtils::MODIFIER_ALT) {</span>
<span class="lineNum">    8208 </span><span class="lineNoCov">          0 :     result |= mozilla::MODIFIER_ALT;</span>
<span class="lineNum">    8209 </span>            :   }
<span class="lineNum">    8210 </span><span class="lineNoCov">          0 :   if (aModifiers &amp; nsIDOMWindowUtils::MODIFIER_META) {</span>
<span class="lineNum">    8211 </span><span class="lineNoCov">          0 :     result |= mozilla::MODIFIER_META;</span>
<span class="lineNum">    8212 </span>            :   }
<span class="lineNum">    8213 </span><span class="lineNoCov">          0 :   if (aModifiers &amp; nsIDOMWindowUtils::MODIFIER_ALTGRAPH) {</span>
<span class="lineNum">    8214 </span><span class="lineNoCov">          0 :     result |= mozilla::MODIFIER_ALTGRAPH;</span>
<span class="lineNum">    8215 </span>            :   }
<span class="lineNum">    8216 </span><span class="lineNoCov">          0 :   if (aModifiers &amp; nsIDOMWindowUtils::MODIFIER_CAPSLOCK) {</span>
<span class="lineNum">    8217 </span><span class="lineNoCov">          0 :     result |= mozilla::MODIFIER_CAPSLOCK;</span>
<span class="lineNum">    8218 </span>            :   }
<span class="lineNum">    8219 </span><span class="lineNoCov">          0 :   if (aModifiers &amp; nsIDOMWindowUtils::MODIFIER_FN) {</span>
<span class="lineNum">    8220 </span><span class="lineNoCov">          0 :     result |= mozilla::MODIFIER_FN;</span>
<span class="lineNum">    8221 </span>            :   }
<span class="lineNum">    8222 </span><span class="lineNoCov">          0 :   if (aModifiers &amp; nsIDOMWindowUtils::MODIFIER_FNLOCK) {</span>
<span class="lineNum">    8223 </span><span class="lineNoCov">          0 :     result |= mozilla::MODIFIER_FNLOCK;</span>
<span class="lineNum">    8224 </span>            :   }
<span class="lineNum">    8225 </span><span class="lineNoCov">          0 :   if (aModifiers &amp; nsIDOMWindowUtils::MODIFIER_NUMLOCK) {</span>
<span class="lineNum">    8226 </span><span class="lineNoCov">          0 :     result |= mozilla::MODIFIER_NUMLOCK;</span>
<span class="lineNum">    8227 </span>            :   }
<span class="lineNum">    8228 </span><span class="lineNoCov">          0 :   if (aModifiers &amp; nsIDOMWindowUtils::MODIFIER_SCROLLLOCK) {</span>
<span class="lineNum">    8229 </span><span class="lineNoCov">          0 :     result |= mozilla::MODIFIER_SCROLLLOCK;</span>
<span class="lineNum">    8230 </span>            :   }
<span class="lineNum">    8231 </span><span class="lineNoCov">          0 :   if (aModifiers &amp; nsIDOMWindowUtils::MODIFIER_SYMBOL) {</span>
<span class="lineNum">    8232 </span><span class="lineNoCov">          0 :     result |= mozilla::MODIFIER_SYMBOL;</span>
<span class="lineNum">    8233 </span>            :   }
<span class="lineNum">    8234 </span><span class="lineNoCov">          0 :   if (aModifiers &amp; nsIDOMWindowUtils::MODIFIER_SYMBOLLOCK) {</span>
<span class="lineNum">    8235 </span><span class="lineNoCov">          0 :     result |= mozilla::MODIFIER_SYMBOLLOCK;</span>
<span class="lineNum">    8236 </span>            :   }
<span class="lineNum">    8237 </span><span class="lineNoCov">          0 :   if (aModifiers &amp; nsIDOMWindowUtils::MODIFIER_OS) {</span>
<span class="lineNum">    8238 </span><span class="lineNoCov">          0 :     result |= mozilla::MODIFIER_OS;</span>
<span class="lineNum">    8239 </span>            :   }
<span class="lineNum">    8240 </span><span class="lineNoCov">          0 :   return result;</span>
<span class="lineNum">    8241 </span>            : }
<a name="8242"><span class="lineNum">    8242 </span>            : </a>
<span class="lineNum">    8243 </span>            : nsIWidget*
<span class="lineNum">    8244 </span><span class="lineNoCov">          0 : nsContentUtils::GetWidget(nsIPresShell* aPresShell, nsPoint* aOffset) {</span>
<span class="lineNum">    8245 </span><span class="lineNoCov">          0 :   if (aPresShell) {</span>
<span class="lineNum">    8246 </span><span class="lineNoCov">          0 :     nsIFrame* frame = aPresShell-&gt;GetRootFrame();</span>
<span class="lineNum">    8247 </span><span class="lineNoCov">          0 :     if (frame)</span>
<span class="lineNum">    8248 </span><span class="lineNoCov">          0 :       return frame-&gt;GetView()-&gt;GetNearestWidget(aOffset);</span>
<span class="lineNum">    8249 </span>            :   }
<span class="lineNum">    8250 </span>            :   return nullptr;
<span class="lineNum">    8251 </span>            : }
<a name="8252"><span class="lineNum">    8252 </span>            : </a>
<span class="lineNum">    8253 </span>            : int16_t
<span class="lineNum">    8254 </span><span class="lineNoCov">          0 : nsContentUtils::GetButtonsFlagForButton(int32_t aButton)</span>
<span class="lineNum">    8255 </span>            : {
<span class="lineNum">    8256 </span>            :   switch (aButton) {
<span class="lineNum">    8257 </span>            :     case -1:
<span class="lineNum">    8258 </span>            :       return WidgetMouseEvent::eNoButtonFlag;
<span class="lineNum">    8259 </span>            :     case WidgetMouseEvent::eLeftButton:
<span class="lineNum">    8260 </span>            :       return WidgetMouseEvent::eLeftButtonFlag;
<span class="lineNum">    8261 </span>            :     case WidgetMouseEvent::eMiddleButton:
<span class="lineNum">    8262 </span>            :       return WidgetMouseEvent::eMiddleButtonFlag;
<span class="lineNum">    8263 </span>            :     case WidgetMouseEvent::eRightButton:
<span class="lineNum">    8264 </span>            :       return WidgetMouseEvent::eRightButtonFlag;
<span class="lineNum">    8265 </span>            :     case 4:
<span class="lineNum">    8266 </span>            :       return WidgetMouseEvent::e4thButtonFlag;
<span class="lineNum">    8267 </span>            :     case 5:
<span class="lineNum">    8268 </span>            :       return WidgetMouseEvent::e5thButtonFlag;
<span class="lineNum">    8269 </span>            :     default:
<span class="lineNum">    8270 </span>            :       NS_ERROR(&quot;Button not known.&quot;);
<span class="lineNum">    8271 </span>            :       return 0;
<span class="lineNum">    8272 </span>            :   }
<span class="lineNum">    8273 </span>            : }
<a name="8274"><span class="lineNum">    8274 </span>            : </a>
<span class="lineNum">    8275 </span>            : LayoutDeviceIntPoint
<span class="lineNum">    8276 </span><span class="lineNoCov">          0 : nsContentUtils::ToWidgetPoint(const CSSPoint&amp; aPoint,</span>
<span class="lineNum">    8277 </span>            :                               const nsPoint&amp; aOffset,
<span class="lineNum">    8278 </span>            :                               nsPresContext* aPresContext)
<span class="lineNum">    8279 </span>            : {
<span class="lineNum">    8280 </span>            :   return LayoutDeviceIntPoint::FromAppUnitsRounded(
<span class="lineNum">    8281 </span><span class="lineNoCov">          0 :     (CSSPoint::ToAppUnits(aPoint) +</span>
<span class="lineNum">    8282 </span>            :     aOffset).ApplyResolution(nsLayoutUtils::GetCurrentAPZResolutionScale(aPresContext-&gt;PresShell())),
<span class="lineNum">    8283 </span><span class="lineNoCov">          0 :     aPresContext-&gt;AppUnitsPerDevPixel());</span>
<span class="lineNum">    8284 </span>            : }
<a name="8285"><span class="lineNum">    8285 </span>            : </a>
<span class="lineNum">    8286 </span>            : nsView*
<span class="lineNum">    8287 </span><span class="lineNoCov">          0 : nsContentUtils::GetViewToDispatchEvent(nsPresContext* presContext,</span>
<span class="lineNum">    8288 </span>            :                                        nsIPresShell** presShell)
<span class="lineNum">    8289 </span>            : {
<span class="lineNum">    8290 </span><span class="lineNoCov">          0 :   if (presContext &amp;&amp; presShell) {</span>
<span class="lineNum">    8291 </span><span class="lineNoCov">          0 :     *presShell = presContext-&gt;PresShell();</span>
<span class="lineNum">    8292 </span><span class="lineNoCov">          0 :     if (*presShell) {</span>
<span class="lineNum">    8293 </span><span class="lineNoCov">          0 :       NS_ADDREF(*presShell);</span>
<span class="lineNum">    8294 </span><span class="lineNoCov">          0 :       if (nsViewManager* viewManager = (*presShell)-&gt;GetViewManager()) {</span>
<span class="lineNum">    8295 </span><span class="lineNoCov">          0 :         if (nsView* view = viewManager-&gt;GetRootView()) {</span>
<span class="lineNum">    8296 </span><span class="lineNoCov">          0 :           return view;</span>
<span class="lineNum">    8297 </span>            :         }
<span class="lineNum">    8298 </span>            :       }
<span class="lineNum">    8299 </span>            :     }
<span class="lineNum">    8300 </span>            :   }
<span class="lineNum">    8301 </span>            :   return nullptr;
<span class="lineNum">    8302 </span>            : }
<a name="8303"><span class="lineNum">    8303 </span>            : </a>
<span class="lineNum">    8304 </span>            : nsresult
<span class="lineNum">    8305 </span><span class="lineNoCov">          0 : nsContentUtils::SendKeyEvent(nsIWidget* aWidget,</span>
<span class="lineNum">    8306 </span>            :                              const nsAString&amp; aType,
<span class="lineNum">    8307 </span>            :                              int32_t aKeyCode,
<span class="lineNum">    8308 </span>            :                              int32_t aCharCode,
<span class="lineNum">    8309 </span>            :                              int32_t aModifiers,
<span class="lineNum">    8310 </span>            :                              uint32_t aAdditionalFlags,
<span class="lineNum">    8311 </span>            :                              bool* aDefaultActionTaken)
<span class="lineNum">    8312 </span>            : {
<span class="lineNum">    8313 </span>            :   // get the widget to send the event to
<span class="lineNum">    8314 </span><span class="lineNoCov">          0 :   if (!aWidget)</span>
<span class="lineNum">    8315 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">    8316 </span>            : 
<span class="lineNum">    8317 </span>            :   EventMessage msg;
<span class="lineNum">    8318 </span><span class="lineNoCov">          0 :   if (aType.EqualsLiteral(&quot;keydown&quot;))</span>
<span class="lineNum">    8319 </span>            :     msg = eKeyDown;
<span class="lineNum">    8320 </span><span class="lineNoCov">          0 :   else if (aType.EqualsLiteral(&quot;keyup&quot;))</span>
<span class="lineNum">    8321 </span>            :     msg = eKeyUp;
<span class="lineNum">    8322 </span><span class="lineNoCov">          0 :   else if (aType.EqualsLiteral(&quot;keypress&quot;))</span>
<span class="lineNum">    8323 </span>            :     msg = eKeyPress;
<span class="lineNum">    8324 </span>            :   else
<span class="lineNum">    8325 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">    8326 </span>            : 
<span class="lineNum">    8327 </span><span class="lineNoCov">          0 :   WidgetKeyboardEvent event(true, msg, aWidget);</span>
<span class="lineNum">    8328 </span><span class="lineNoCov">          0 :   event.mModifiers = GetWidgetModifiers(aModifiers);</span>
<span class="lineNum">    8329 </span>            : 
<span class="lineNum">    8330 </span><span class="lineNoCov">          0 :   if (msg == eKeyPress) {</span>
<span class="lineNum">    8331 </span><span class="lineNoCov">          0 :     event.mKeyCode = aCharCode ? 0 : aKeyCode;</span>
<span class="lineNum">    8332 </span><span class="lineNoCov">          0 :     event.mCharCode = aCharCode;</span>
<span class="lineNum">    8333 </span>            :   } else {
<span class="lineNum">    8334 </span><span class="lineNoCov">          0 :     event.mKeyCode = aKeyCode;</span>
<span class="lineNum">    8335 </span><span class="lineNoCov">          0 :     event.mCharCode = 0;</span>
<span class="lineNum">    8336 </span>            :   }
<span class="lineNum">    8337 </span>            : 
<span class="lineNum">    8338 </span>            :   uint32_t locationFlag = (aAdditionalFlags &amp;
<span class="lineNum">    8339 </span>            :     (nsIDOMWindowUtils::KEY_FLAG_LOCATION_STANDARD | nsIDOMWindowUtils::KEY_FLAG_LOCATION_LEFT |
<span class="lineNum">    8340 </span><span class="lineNoCov">          0 :      nsIDOMWindowUtils::KEY_FLAG_LOCATION_RIGHT | nsIDOMWindowUtils::KEY_FLAG_LOCATION_NUMPAD));</span>
<span class="lineNum">    8341 </span><span class="lineNoCov">          0 :   switch (locationFlag) {</span>
<span class="lineNum">    8342 </span>            :     case nsIDOMWindowUtils::KEY_FLAG_LOCATION_STANDARD:
<span class="lineNum">    8343 </span><span class="lineNoCov">          0 :       event.mLocation = eKeyLocationStandard;</span>
<span class="lineNum">    8344 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    8345 </span>            :     case nsIDOMWindowUtils::KEY_FLAG_LOCATION_LEFT:
<span class="lineNum">    8346 </span><span class="lineNoCov">          0 :       event.mLocation = eKeyLocationLeft;</span>
<span class="lineNum">    8347 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    8348 </span>            :     case nsIDOMWindowUtils::KEY_FLAG_LOCATION_RIGHT:
<span class="lineNum">    8349 </span><span class="lineNoCov">          0 :       event.mLocation = eKeyLocationRight;</span>
<span class="lineNum">    8350 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    8351 </span>            :     case nsIDOMWindowUtils::KEY_FLAG_LOCATION_NUMPAD:
<span class="lineNum">    8352 </span><span class="lineNoCov">          0 :       event.mLocation = eKeyLocationNumpad;</span>
<span class="lineNum">    8353 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    8354 </span>            :     default:
<span class="lineNum">    8355 </span><span class="lineNoCov">          0 :       if (locationFlag != 0) {</span>
<span class="lineNum">    8356 </span>            :         return NS_ERROR_INVALID_ARG;
<span class="lineNum">    8357 </span>            :       }
<span class="lineNum">    8358 </span>            :       // If location flag isn't set, choose the location from keycode.
<span class="lineNum">    8359 </span><span class="lineNoCov">          0 :       switch (aKeyCode) {</span>
<span class="lineNum">    8360 </span>            :         case nsIDOMKeyEvent::DOM_VK_NUMPAD0:
<span class="lineNum">    8361 </span>            :         case nsIDOMKeyEvent::DOM_VK_NUMPAD1:
<span class="lineNum">    8362 </span>            :         case nsIDOMKeyEvent::DOM_VK_NUMPAD2:
<span class="lineNum">    8363 </span>            :         case nsIDOMKeyEvent::DOM_VK_NUMPAD3:
<span class="lineNum">    8364 </span>            :         case nsIDOMKeyEvent::DOM_VK_NUMPAD4:
<span class="lineNum">    8365 </span>            :         case nsIDOMKeyEvent::DOM_VK_NUMPAD5:
<span class="lineNum">    8366 </span>            :         case nsIDOMKeyEvent::DOM_VK_NUMPAD6:
<span class="lineNum">    8367 </span>            :         case nsIDOMKeyEvent::DOM_VK_NUMPAD7:
<span class="lineNum">    8368 </span>            :         case nsIDOMKeyEvent::DOM_VK_NUMPAD8:
<span class="lineNum">    8369 </span>            :         case nsIDOMKeyEvent::DOM_VK_NUMPAD9:
<span class="lineNum">    8370 </span>            :         case nsIDOMKeyEvent::DOM_VK_MULTIPLY:
<span class="lineNum">    8371 </span>            :         case nsIDOMKeyEvent::DOM_VK_ADD:
<span class="lineNum">    8372 </span>            :         case nsIDOMKeyEvent::DOM_VK_SEPARATOR:
<span class="lineNum">    8373 </span>            :         case nsIDOMKeyEvent::DOM_VK_SUBTRACT:
<span class="lineNum">    8374 </span>            :         case nsIDOMKeyEvent::DOM_VK_DECIMAL:
<span class="lineNum">    8375 </span>            :         case nsIDOMKeyEvent::DOM_VK_DIVIDE:
<span class="lineNum">    8376 </span><span class="lineNoCov">          0 :           event.mLocation = eKeyLocationNumpad;</span>
<span class="lineNum">    8377 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    8378 </span>            :         case nsIDOMKeyEvent::DOM_VK_SHIFT:
<span class="lineNum">    8379 </span>            :         case nsIDOMKeyEvent::DOM_VK_CONTROL:
<span class="lineNum">    8380 </span>            :         case nsIDOMKeyEvent::DOM_VK_ALT:
<span class="lineNum">    8381 </span>            :         case nsIDOMKeyEvent::DOM_VK_META:
<span class="lineNum">    8382 </span><span class="lineNoCov">          0 :           event.mLocation = eKeyLocationLeft;</span>
<span class="lineNum">    8383 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    8384 </span>            :         default:
<span class="lineNum">    8385 </span><span class="lineNoCov">          0 :           event.mLocation = eKeyLocationStandard;</span>
<span class="lineNum">    8386 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    8387 </span>            :       }
<span class="lineNum">    8388 </span>            :       break;
<span class="lineNum">    8389 </span>            :   }
<span class="lineNum">    8390 </span>            : 
<span class="lineNum">    8391 </span><span class="lineNoCov">          0 :   event.mRefPoint = LayoutDeviceIntPoint(0, 0);</span>
<span class="lineNum">    8392 </span><span class="lineNoCov">          0 :   event.mTime = PR_IntervalNow();</span>
<span class="lineNum">    8393 </span><span class="lineNoCov">          0 :   if (!(aAdditionalFlags &amp; nsIDOMWindowUtils::KEY_FLAG_NOT_SYNTHESIZED_FOR_TESTS)) {</span>
<span class="lineNum">    8394 </span><span class="lineNoCov">          0 :     event.mFlags.mIsSynthesizedForTests = true;</span>
<span class="lineNum">    8395 </span>            :   }
<span class="lineNum">    8396 </span>            : 
<span class="lineNum">    8397 </span><span class="lineNoCov">          0 :   if (aAdditionalFlags &amp; nsIDOMWindowUtils::KEY_FLAG_PREVENT_DEFAULT) {</span>
<span class="lineNum">    8398 </span>            :     event.PreventDefaultBeforeDispatch();
<span class="lineNum">    8399 </span>            :   }
<span class="lineNum">    8400 </span>            : 
<span class="lineNum">    8401 </span>            :   nsEventStatus status;
<span class="lineNum">    8402 </span><span class="lineNoCov">          0 :   nsresult rv = aWidget-&gt;DispatchEvent(&amp;event, status);</span>
<span class="lineNum">    8403 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    8404 </span>            : 
<span class="lineNum">    8405 </span><span class="lineNoCov">          0 :   *aDefaultActionTaken = (status != nsEventStatus_eConsumeNoDefault);</span>
<span class="lineNum">    8406 </span>            : 
<span class="lineNum">    8407 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    8408 </span>            : }
<span class="lineNum">    8409 </span>            : 
<span class="lineNum">    8410 </span>            : nsresult
<span class="lineNum">    8411 </span><span class="lineNoCov">          0 : nsContentUtils::SendMouseEvent(const nsCOMPtr&lt;nsIPresShell&gt;&amp; aPresShell,</span>
<span class="lineNum">    8412 </span>            :                                const nsAString&amp; aType,
<span class="lineNum">    8413 </span>            :                                float aX,
<span class="lineNum">    8414 </span>            :                                float aY,
<span class="lineNum">    8415 </span>            :                                int32_t aButton,
<span class="lineNum">    8416 </span>            :                                int32_t aButtons,
<span class="lineNum">    8417 </span>            :                                int32_t aClickCount,
<span class="lineNum">    8418 </span>            :                                int32_t aModifiers,
<span class="lineNum">    8419 </span>            :                                bool aIgnoreRootScrollFrame,
<span class="lineNum">    8420 </span>            :                                float aPressure,
<span class="lineNum">    8421 </span>            :                                unsigned short aInputSourceArg,
<span class="lineNum">    8422 </span>            :                                uint32_t aIdentifier,
<span class="lineNum">    8423 </span>            :                                bool aToWindow,
<span class="lineNum">    8424 </span>            :                                bool *aPreventDefault,
<span class="lineNum">    8425 </span>            :                                bool aIsDOMEventSynthesized,
<span class="lineNum">    8426 </span>            :                                bool aIsWidgetEventSynthesized)
<span class="lineNum">    8427 </span>            : {
<span class="lineNum">    8428 </span>            :   nsPoint offset;
<span class="lineNum">    8429 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIWidget&gt; widget = GetWidget(aPresShell, &amp;offset);</span>
<span class="lineNum">    8430 </span><span class="lineNoCov">          0 :   if (!widget)</span>
<span class="lineNum">    8431 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">    8432 </span>            : 
<span class="lineNum">    8433 </span>            :   EventMessage msg;
<span class="lineNum">    8434 </span><span class="lineNoCov">          0 :   WidgetMouseEvent::ExitFrom exitFrom = WidgetMouseEvent::eChild;</span>
<span class="lineNum">    8435 </span><span class="lineNoCov">          0 :   bool contextMenuKey = false;</span>
<span class="lineNum">    8436 </span><span class="lineNoCov">          0 :   if (aType.EqualsLiteral(&quot;mousedown&quot;)) {</span>
<span class="lineNum">    8437 </span>            :     msg = eMouseDown;
<span class="lineNum">    8438 </span><span class="lineNoCov">          0 :   } else if (aType.EqualsLiteral(&quot;mouseup&quot;)) {</span>
<span class="lineNum">    8439 </span>            :     msg = eMouseUp;
<span class="lineNum">    8440 </span><span class="lineNoCov">          0 :   } else if (aType.EqualsLiteral(&quot;mousemove&quot;)) {</span>
<span class="lineNum">    8441 </span>            :     msg = eMouseMove;
<span class="lineNum">    8442 </span><span class="lineNoCov">          0 :   } else if (aType.EqualsLiteral(&quot;mouseover&quot;)) {</span>
<span class="lineNum">    8443 </span>            :     msg = eMouseEnterIntoWidget;
<span class="lineNum">    8444 </span><span class="lineNoCov">          0 :   } else if (aType.EqualsLiteral(&quot;mouseout&quot;)) {</span>
<span class="lineNum">    8445 </span>            :     msg = eMouseExitFromWidget;
<span class="lineNum">    8446 </span><span class="lineNoCov">          0 :   } else if (aType.EqualsLiteral(&quot;mousecancel&quot;)) {</span>
<span class="lineNum">    8447 </span>            :     msg = eMouseExitFromWidget;
<span class="lineNum">    8448 </span>            :     exitFrom = WidgetMouseEvent::eTopLevel;
<span class="lineNum">    8449 </span><span class="lineNoCov">          0 :   } else if (aType.EqualsLiteral(&quot;mouselongtap&quot;)) {</span>
<span class="lineNum">    8450 </span>            :     msg = eMouseLongTap;
<span class="lineNum">    8451 </span><span class="lineNoCov">          0 :   } else if (aType.EqualsLiteral(&quot;contextmenu&quot;)) {</span>
<span class="lineNum">    8452 </span><span class="lineNoCov">          0 :     msg = eContextMenu;</span>
<span class="lineNum">    8453 </span><span class="lineNoCov">          0 :     contextMenuKey = (aButton == 0);</span>
<span class="lineNum">    8454 </span><span class="lineNoCov">          0 :   } else if (aType.EqualsLiteral(&quot;MozMouseHittest&quot;)) {</span>
<span class="lineNum">    8455 </span>            :     msg = eMouseHitTest;
<span class="lineNum">    8456 </span>            :   } else {
<span class="lineNum">    8457 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">    8458 </span>            :   }
<span class="lineNum">    8459 </span>            : 
<span class="lineNum">    8460 </span><span class="lineNoCov">          0 :   if (aInputSourceArg == nsIDOMMouseEvent::MOZ_SOURCE_UNKNOWN) {</span>
<span class="lineNum">    8461 </span><span class="lineNoCov">          0 :     aInputSourceArg = nsIDOMMouseEvent::MOZ_SOURCE_MOUSE;</span>
<span class="lineNum">    8462 </span>            :   }
<span class="lineNum">    8463 </span>            : 
<span class="lineNum">    8464 </span>            :   WidgetMouseEvent event(true, msg, widget,
<span class="lineNum">    8465 </span>            :                          aIsWidgetEventSynthesized ?
<span class="lineNum">    8466 </span>            :                            WidgetMouseEvent::eSynthesized :
<span class="lineNum">    8467 </span>            :                            WidgetMouseEvent::eReal,
<span class="lineNum">    8468 </span>            :                          contextMenuKey ? WidgetMouseEvent::eContextMenuKey :
<span class="lineNum">    8469 </span><span class="lineNoCov">          0 :                                           WidgetMouseEvent::eNormal);</span>
<span class="lineNum">    8470 </span><span class="lineNoCov">          0 :   event.pointerId = aIdentifier;</span>
<span class="lineNum">    8471 </span><span class="lineNoCov">          0 :   event.mModifiers = GetWidgetModifiers(aModifiers);</span>
<span class="lineNum">    8472 </span><span class="lineNoCov">          0 :   event.button = aButton;</span>
<span class="lineNum">    8473 </span>            :   event.buttons = aButtons != nsIDOMWindowUtils::MOUSE_BUTTONS_NOT_SPECIFIED ?
<span class="lineNum">    8474 </span>            :                   aButtons :
<span class="lineNum">    8475 </span><span class="lineNoCov">          0 :                   msg == eMouseUp ? 0 : GetButtonsFlagForButton(aButton);</span>
<span class="lineNum">    8476 </span><span class="lineNoCov">          0 :   event.pressure = aPressure;</span>
<span class="lineNum">    8477 </span><span class="lineNoCov">          0 :   event.inputSource = aInputSourceArg;</span>
<span class="lineNum">    8478 </span><span class="lineNoCov">          0 :   event.mClickCount = aClickCount;</span>
<span class="lineNum">    8479 </span><span class="lineNoCov">          0 :   event.mTime = PR_IntervalNow();</span>
<span class="lineNum">    8480 </span><span class="lineNoCov">          0 :   event.mFlags.mIsSynthesizedForTests = aIsDOMEventSynthesized;</span>
<span class="lineNum">    8481 </span><span class="lineNoCov">          0 :   event.mExitFrom = exitFrom;</span>
<span class="lineNum">    8482 </span>            : 
<span class="lineNum">    8483 </span><span class="lineNoCov">          0 :   nsPresContext* presContext = aPresShell-&gt;GetPresContext();</span>
<span class="lineNum">    8484 </span><span class="lineNoCov">          0 :   if (!presContext)</span>
<span class="lineNum">    8485 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">    8486 </span>            : 
<span class="lineNum">    8487 </span><span class="lineNoCov">          0 :   event.mRefPoint = ToWidgetPoint(CSSPoint(aX, aY), offset, presContext);</span>
<span class="lineNum">    8488 </span><span class="lineNoCov">          0 :   event.mIgnoreRootScrollFrame = aIgnoreRootScrollFrame;</span>
<span class="lineNum">    8489 </span>            : 
<span class="lineNum">    8490 </span><span class="lineNoCov">          0 :   nsEventStatus status = nsEventStatus_eIgnore;</span>
<span class="lineNum">    8491 </span><span class="lineNoCov">          0 :   if (aToWindow) {</span>
<span class="lineNum">    8492 </span>            :     nsCOMPtr&lt;nsIPresShell&gt; presShell;
<span class="lineNum">    8493 </span><span class="lineNoCov">          0 :     nsView* view = GetViewToDispatchEvent(presContext, getter_AddRefs(presShell));</span>
<span class="lineNum">    8494 </span><span class="lineNoCov">          0 :     if (!presShell || !view) {</span>
<span class="lineNum">    8495 </span>            :       return NS_ERROR_FAILURE;
<span class="lineNum">    8496 </span>            :     }
<span class="lineNum">    8497 </span><span class="lineNoCov">          0 :     return presShell-&gt;HandleEvent(view-&gt;GetFrame(), &amp;event, false, &amp;status);</span>
<span class="lineNum">    8498 </span>            :   }
<span class="lineNum">    8499 </span><span class="lineNoCov">          0 :   if (gfxPrefs::TestEventsAsyncEnabled()) {</span>
<span class="lineNum">    8500 </span><span class="lineNoCov">          0 :     status = widget-&gt;DispatchInputEvent(&amp;event);</span>
<span class="lineNum">    8501 </span>            :   } else {
<span class="lineNum">    8502 </span><span class="lineNoCov">          0 :     nsresult rv = widget-&gt;DispatchEvent(&amp;event, status);</span>
<span class="lineNum">    8503 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    8504 </span>            :   }
<span class="lineNum">    8505 </span><span class="lineNoCov">          0 :   if (aPreventDefault) {</span>
<span class="lineNum">    8506 </span><span class="lineNoCov">          0 :     *aPreventDefault = (status == nsEventStatus_eConsumeNoDefault);</span>
<span class="lineNum">    8507 </span>            :   }
<span class="lineNum">    8508 </span>            : 
<span class="lineNum">    8509 </span>            :   return NS_OK;
<span class="lineNum">    8510 </span>            : }
<span class="lineNum">    8511 </span>            : 
<span class="lineNum">    8512 </span>            : /* static */
<span class="lineNum">    8513 </span>            : void
<span class="lineNum">    8514 </span><span class="lineNoCov">          0 : nsContentUtils::FirePageHideEvent(nsIDocShellTreeItem* aItem,</span>
<span class="lineNum">    8515 </span>            :                                   EventTarget* aChromeEventHandler)
<span class="lineNum">    8516 </span>            : {
<span class="lineNum">    8517 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocument&gt; doc = aItem-&gt;GetDocument();</span>
<span class="lineNum">    8518 </span>            :   NS_ASSERTION(doc, &quot;What happened here?&quot;);
<span class="lineNum">    8519 </span><span class="lineNoCov">          0 :   doc-&gt;OnPageHide(true, aChromeEventHandler);</span>
<span class="lineNum">    8520 </span>            : 
<span class="lineNum">    8521 </span><span class="lineNoCov">          0 :   int32_t childCount = 0;</span>
<span class="lineNum">    8522 </span><span class="lineNoCov">          0 :   aItem-&gt;GetChildCount(&amp;childCount);</span>
<span class="lineNum">    8523 </span><span class="lineNoCov">          0 :   AutoTArray&lt;nsCOMPtr&lt;nsIDocShellTreeItem&gt;, 8&gt; kids;</span>
<span class="lineNum">    8524 </span><span class="lineNoCov">          0 :   kids.AppendElements(childCount);</span>
<span class="lineNum">    8525 </span><span class="lineNoCov">          0 :   for (int32_t i = 0; i &lt; childCount; ++i) {</span>
<span class="lineNum">    8526 </span><span class="lineNoCov">          0 :     aItem-&gt;GetChildAt(i, getter_AddRefs(kids[i]));</span>
<span class="lineNum">    8527 </span>            :   }
<span class="lineNum">    8528 </span>            : 
<span class="lineNum">    8529 </span><span class="lineNoCov">          0 :   for (uint32_t i = 0; i &lt; kids.Length(); ++i) {</span>
<span class="lineNum">    8530 </span><span class="lineNoCov">          0 :     if (kids[i]) {</span>
<span class="lineNum">    8531 </span><span class="lineNoCov">          0 :       FirePageHideEvent(kids[i], aChromeEventHandler);</span>
<span class="lineNum">    8532 </span>            :     }
<span class="lineNum">    8533 </span>            :   }
<span class="lineNum">    8534 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    8535 </span>            : 
<span class="lineNum">    8536 </span>            : // The pageshow event is fired for a given document only if IsShowing() returns
<span class="lineNum">    8537 </span>            : // the same thing as aFireIfShowing.  This gives us a way to fire pageshow only
<span class="lineNum">    8538 </span>            : // on documents that are still loading or only on documents that are already
<span class="lineNum">    8539 </span>            : // loaded.
<span class="lineNum">    8540 </span>            : /* static */
<span class="lineNum">    8541 </span>            : void
<span class="lineNum">    8542 </span><span class="lineNoCov">          0 : nsContentUtils::FirePageShowEvent(nsIDocShellTreeItem* aItem,</span>
<span class="lineNum">    8543 </span>            :                                   EventTarget* aChromeEventHandler,
<span class="lineNum">    8544 </span>            :                                   bool aFireIfShowing)
<span class="lineNum">    8545 </span>            : {
<span class="lineNum">    8546 </span><span class="lineNoCov">          0 :   int32_t childCount = 0;</span>
<span class="lineNum">    8547 </span><span class="lineNoCov">          0 :   aItem-&gt;GetChildCount(&amp;childCount);</span>
<span class="lineNum">    8548 </span><span class="lineNoCov">          0 :   AutoTArray&lt;nsCOMPtr&lt;nsIDocShellTreeItem&gt;, 8&gt; kids;</span>
<span class="lineNum">    8549 </span><span class="lineNoCov">          0 :   kids.AppendElements(childCount);</span>
<span class="lineNum">    8550 </span><span class="lineNoCov">          0 :   for (int32_t i = 0; i &lt; childCount; ++i) {</span>
<span class="lineNum">    8551 </span><span class="lineNoCov">          0 :     aItem-&gt;GetChildAt(i, getter_AddRefs(kids[i]));</span>
<span class="lineNum">    8552 </span>            :   }
<span class="lineNum">    8553 </span>            : 
<span class="lineNum">    8554 </span><span class="lineNoCov">          0 :   for (uint32_t i = 0; i &lt; kids.Length(); ++i) {</span>
<span class="lineNum">    8555 </span><span class="lineNoCov">          0 :     if (kids[i]) {</span>
<span class="lineNum">    8556 </span><span class="lineNoCov">          0 :       FirePageShowEvent(kids[i], aChromeEventHandler, aFireIfShowing);</span>
<span class="lineNum">    8557 </span>            :     }
<span class="lineNum">    8558 </span>            :   }
<span class="lineNum">    8559 </span>            : 
<span class="lineNum">    8560 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocument&gt; doc = aItem-&gt;GetDocument();</span>
<span class="lineNum">    8561 </span>            :   NS_ASSERTION(doc, &quot;What happened here?&quot;);
<span class="lineNum">    8562 </span><span class="lineNoCov">          0 :   if (doc-&gt;IsShowing() == aFireIfShowing) {</span>
<span class="lineNum">    8563 </span><span class="lineNoCov">          0 :     doc-&gt;OnPageShow(true, aChromeEventHandler);</span>
<span class="lineNum">    8564 </span>            :   }
<span class="lineNum">    8565 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    8566 </span>            : 
<a name="8567"><span class="lineNum">    8567 </span>            : /* static */</a>
<span class="lineNum">    8568 </span>            : already_AddRefed&lt;nsPIWindowRoot&gt;
<span class="lineNum">    8569 </span><span class="lineNoCov">          0 : nsContentUtils::GetWindowRoot(nsIDocument* aDoc)</span>
<span class="lineNum">    8570 </span>            : {
<span class="lineNum">    8571 </span><span class="lineNoCov">          0 :   if (aDoc) {</span>
<span class="lineNum">    8572 </span><span class="lineNoCov">          0 :     if (nsPIDOMWindowOuter* win = aDoc-&gt;GetWindow()) {</span>
<span class="lineNum">    8573 </span><span class="lineNoCov">          0 :       return win-&gt;GetTopWindowRoot();</span>
<span class="lineNum">    8574 </span>            :     }
<span class="lineNum">    8575 </span>            :   }
<span class="lineNum">    8576 </span><span class="lineNoCov">          0 :   return nullptr;</span>
<span class="lineNum">    8577 </span>            : }
<span class="lineNum">    8578 </span>            : 
<a name="8579"><span class="lineNum">    8579 </span>            : /* static */</a>
<span class="lineNum">    8580 </span>            : nsContentPolicyType
<span class="lineNum">    8581 </span><span class="lineCov">       1566 : nsContentUtils::InternalContentPolicyTypeToExternal(nsContentPolicyType aType)</span>
<span class="lineNum">    8582 </span>            : {
<span class="lineNum">    8583 </span><span class="lineCov">       1566 :   switch (aType) {</span>
<span class="lineNum">    8584 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_SCRIPT:
<span class="lineNum">    8585 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_SCRIPT_PRELOAD:
<span class="lineNum">    8586 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_WORKER:
<span class="lineNum">    8587 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_SHARED_WORKER:
<span class="lineNum">    8588 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_SERVICE_WORKER:
<span class="lineNum">    8589 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_WORKER_IMPORT_SCRIPTS:
<span class="lineNum">    8590 </span>            :     return nsIContentPolicy::TYPE_SCRIPT;
<span class="lineNum">    8591 </span>            : 
<span class="lineNum">    8592 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_EMBED:
<span class="lineNum">    8593 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_OBJECT:
<span class="lineNum">    8594 </span><span class="lineNoCov">          0 :     return nsIContentPolicy::TYPE_OBJECT;</span>
<span class="lineNum">    8595 </span>            : 
<span class="lineNum">    8596 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_FRAME:
<span class="lineNum">    8597 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_IFRAME:
<span class="lineNum">    8598 </span><span class="lineNoCov">          0 :     return nsIContentPolicy::TYPE_SUBDOCUMENT;</span>
<span class="lineNum">    8599 </span>            : 
<span class="lineNum">    8600 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_AUDIO:
<span class="lineNum">    8601 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_VIDEO:
<span class="lineNum">    8602 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_TRACK:
<span class="lineNum">    8603 </span><span class="lineNoCov">          0 :     return nsIContentPolicy::TYPE_MEDIA;</span>
<span class="lineNum">    8604 </span>            : 
<span class="lineNum">    8605 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_XMLHTTPREQUEST:
<span class="lineNum">    8606 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_EVENTSOURCE:
<span class="lineNum">    8607 </span><span class="lineNoCov">          0 :     return nsIContentPolicy::TYPE_XMLHTTPREQUEST;</span>
<span class="lineNum">    8608 </span>            : 
<span class="lineNum">    8609 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_IMAGE:
<span class="lineNum">    8610 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_IMAGE_PRELOAD:
<span class="lineNum">    8611 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_IMAGE_FAVICON:
<span class="lineNum">    8612 </span><span class="lineNoCov">          0 :     return nsIContentPolicy::TYPE_IMAGE;</span>
<span class="lineNum">    8613 </span>            : 
<span class="lineNum">    8614 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_STYLESHEET:
<span class="lineNum">    8615 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_STYLESHEET_PRELOAD:
<span class="lineNum">    8616 </span><span class="lineCov">        175 :     return nsIContentPolicy::TYPE_STYLESHEET;</span>
<span class="lineNum">    8617 </span>            : 
<span class="lineNum">    8618 </span>            :   default:
<span class="lineNum">    8619 </span><span class="lineCov">       1391 :     return aType;</span>
<span class="lineNum">    8620 </span>            :   }
<span class="lineNum">    8621 </span>            : }
<span class="lineNum">    8622 </span>            : 
<a name="8623"><span class="lineNum">    8623 </span>            : /* static */</a>
<span class="lineNum">    8624 </span>            : nsContentPolicyType
<span class="lineNum">    8625 </span><span class="lineNoCov">          0 : nsContentUtils::InternalContentPolicyTypeToExternalOrWorker(nsContentPolicyType aType)</span>
<span class="lineNum">    8626 </span>            : {
<span class="lineNum">    8627 </span>            :   switch (aType) {
<span class="lineNum">    8628 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_WORKER:
<span class="lineNum">    8629 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_SHARED_WORKER:
<span class="lineNum">    8630 </span>            :   case nsIContentPolicy::TYPE_INTERNAL_SERVICE_WORKER:
<span class="lineNum">    8631 </span>            :     return aType;
<span class="lineNum">    8632 </span>            : 
<span class="lineNum">    8633 </span>            :   default:
<span class="lineNum">    8634 </span><span class="lineNoCov">          0 :     return InternalContentPolicyTypeToExternal(aType);</span>
<span class="lineNum">    8635 </span>            :   }
<span class="lineNum">    8636 </span>            : }
<span class="lineNum">    8637 </span>            : 
<a name="8638"><span class="lineNum">    8638 </span>            : /* static */</a>
<span class="lineNum">    8639 </span>            : bool
<span class="lineNum">    8640 </span><span class="lineCov">       1146 : nsContentUtils::IsPreloadType(nsContentPolicyType aType)</span>
<span class="lineNum">    8641 </span>            : {
<span class="lineNum">    8642 </span><span class="lineCov">       2292 :   if (aType == nsIContentPolicy::TYPE_INTERNAL_SCRIPT_PRELOAD ||</span>
<span class="lineNum">    8643 </span><span class="lineCov">       2292 :       aType == nsIContentPolicy::TYPE_INTERNAL_IMAGE_PRELOAD ||</span>
<span class="lineNum">    8644 </span>            :       aType == nsIContentPolicy::TYPE_INTERNAL_STYLESHEET_PRELOAD) {
<span class="lineNum">    8645 </span>            :     return true;
<span class="lineNum">    8646 </span>            :   }
<span class="lineNum">    8647 </span><span class="lineCov">       1146 :   return false;</span>
<span class="lineNum">    8648 </span>            : }
<span class="lineNum">    8649 </span>            : 
<span class="lineNum">    8650 </span>            : nsresult
<span class="lineNum">    8651 </span><span class="lineNoCov">          0 : nsContentUtils::SetFetchReferrerURIWithPolicy(nsIPrincipal* aPrincipal,</span>
<span class="lineNum">    8652 </span>            :                                               nsIDocument* aDoc,
<span class="lineNum">    8653 </span>            :                                               nsIHttpChannel* aChannel,
<span class="lineNum">    8654 </span>            :                                               mozilla::net::ReferrerPolicy aReferrerPolicy)
<span class="lineNum">    8655 </span>            : {
<span class="lineNum">    8656 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(aPrincipal);</span>
<span class="lineNum">    8657 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(aChannel);</span>
<span class="lineNum">    8658 </span>            : 
<span class="lineNum">    8659 </span>            :   nsCOMPtr&lt;nsIURI&gt; principalURI;
<span class="lineNum">    8660 </span>            : 
<span class="lineNum">    8661 </span><span class="lineNoCov">          0 :   if (IsSystemPrincipal(aPrincipal)) {</span>
<span class="lineNum">    8662 </span>            :     return NS_OK;
<span class="lineNum">    8663 </span>            :   }
<span class="lineNum">    8664 </span>            : 
<span class="lineNum">    8665 </span><span class="lineNoCov">          0 :   aPrincipal-&gt;GetURI(getter_AddRefs(principalURI));</span>
<span class="lineNum">    8666 </span>            : 
<span class="lineNum">    8667 </span><span class="lineNoCov">          0 :   if (!aDoc) {</span>
<span class="lineNum">    8668 </span><span class="lineNoCov">          0 :     return aChannel-&gt;SetReferrerWithPolicy(principalURI, aReferrerPolicy);</span>
<span class="lineNum">    8669 </span>            :   }
<span class="lineNum">    8670 </span>            : 
<span class="lineNum">    8671 </span>            :   // If it weren't for history.push/replaceState, we could just use the
<span class="lineNum">    8672 </span>            :   // principal's URI here.  But since we want changes to the URI effected
<span class="lineNum">    8673 </span>            :   // by push/replaceState to be reflected in the XHR referrer, we have to
<span class="lineNum">    8674 </span>            :   // be more clever.
<span class="lineNum">    8675 </span>            :   //
<span class="lineNum">    8676 </span>            :   // If the document's original URI (before any push/replaceStates) matches
<span class="lineNum">    8677 </span>            :   // our principal, then we use the document's current URI (after
<span class="lineNum">    8678 </span>            :   // push/replaceStates).  Otherwise (if the document is, say, a data:
<span class="lineNum">    8679 </span>            :   // URI), we just use the principal's URI.
<span class="lineNum">    8680 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIURI&gt; docCurURI = aDoc-&gt;GetDocumentURI();</span>
<span class="lineNum">    8681 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIURI&gt; docOrigURI = aDoc-&gt;GetOriginalURI();</span>
<span class="lineNum">    8682 </span>            : 
<span class="lineNum">    8683 </span>            :   nsCOMPtr&lt;nsIURI&gt; referrerURI;
<span class="lineNum">    8684 </span>            : 
<span class="lineNum">    8685 </span><span class="lineNoCov">          0 :   if (principalURI &amp;&amp; docCurURI &amp;&amp; docOrigURI) {</span>
<span class="lineNum">    8686 </span><span class="lineNoCov">          0 :     bool equal = false;</span>
<span class="lineNum">    8687 </span><span class="lineNoCov">          0 :     principalURI-&gt;Equals(docOrigURI, &amp;equal);</span>
<span class="lineNum">    8688 </span><span class="lineNoCov">          0 :     if (equal) {</span>
<span class="lineNum">    8689 </span><span class="lineNoCov">          0 :       referrerURI = docCurURI;</span>
<span class="lineNum">    8690 </span>            :     }
<span class="lineNum">    8691 </span>            :   }
<span class="lineNum">    8692 </span>            : 
<span class="lineNum">    8693 </span><span class="lineNoCov">          0 :   if (!referrerURI) {</span>
<span class="lineNum">    8694 </span><span class="lineNoCov">          0 :     referrerURI = principalURI;</span>
<span class="lineNum">    8695 </span>            :   }
<span class="lineNum">    8696 </span>            : 
<span class="lineNum">    8697 </span><span class="lineNoCov">          0 :   return aChannel-&gt;SetReferrerWithPolicy(referrerURI, aReferrerPolicy);</span>
<span class="lineNum">    8698 </span>            : }
<span class="lineNum">    8699 </span>            : 
<a name="8700"><span class="lineNum">    8700 </span>            : // static</a>
<span class="lineNum">    8701 </span>            : net::ReferrerPolicy
<span class="lineNum">    8702 </span><span class="lineNoCov">          0 : nsContentUtils::GetReferrerPolicyFromHeader(const nsAString&amp; aHeader)</span>
<span class="lineNum">    8703 </span>            : {
<span class="lineNum">    8704 </span>            :   // Multiple headers could be concatenated into one comma-separated
<span class="lineNum">    8705 </span>            :   // list of policies. Need to tokenize the multiple headers.
<span class="lineNum">    8706 </span>            :   nsCharSeparatedTokenizer tokenizer(aHeader, ',');
<span class="lineNum">    8707 </span><span class="lineNoCov">          0 :   nsAutoString token;</span>
<span class="lineNum">    8708 </span><span class="lineNoCov">          0 :   net::ReferrerPolicy referrerPolicy = mozilla::net::RP_Unset;</span>
<span class="lineNum">    8709 </span><span class="lineNoCov">          0 :   while (tokenizer.hasMoreTokens()) {</span>
<span class="lineNum">    8710 </span><span class="lineNoCov">          0 :     token = tokenizer.nextToken();</span>
<span class="lineNum">    8711 </span><span class="lineNoCov">          0 :     if (token.IsEmpty()) {</span>
<span class="lineNum">    8712 </span>            :       continue;
<span class="lineNum">    8713 </span>            :     }
<span class="lineNum">    8714 </span><span class="lineNoCov">          0 :     net::ReferrerPolicy policy = net::ReferrerPolicyFromString(token);</span>
<span class="lineNum">    8715 </span><span class="lineNoCov">          0 :     if (policy != net::RP_Unset) {</span>
<span class="lineNum">    8716 </span><span class="lineNoCov">          0 :       referrerPolicy = policy;</span>
<span class="lineNum">    8717 </span>            :     }
<span class="lineNum">    8718 </span>            :   }
<span class="lineNum">    8719 </span><span class="lineNoCov">          0 :   return referrerPolicy;</span>
<span class="lineNum">    8720 </span>            : }
<span class="lineNum">    8721 </span>            : 
<a name="8722"><span class="lineNum">    8722 </span>            : // static</a>
<span class="lineNum">    8723 </span>            : bool
<span class="lineNum">    8724 </span><span class="lineNoCov">          0 : nsContentUtils::PushEnabled(JSContext* aCx, JSObject* aObj)</span>
<span class="lineNum">    8725 </span>            : {
<span class="lineNum">    8726 </span><span class="lineNoCov">          0 :   if (NS_IsMainThread()) {</span>
<span class="lineNum">    8727 </span><span class="lineNoCov">          0 :     return Preferences::GetBool(&quot;dom.push.enabled&quot;, false);</span>
<span class="lineNum">    8728 </span>            :   }
<span class="lineNum">    8729 </span>            : 
<span class="lineNum">    8730 </span>            :   using namespace workers;
<span class="lineNum">    8731 </span>            : 
<span class="lineNum">    8732 </span>            :   // Otherwise, check the pref via the WorkerPrivate
<span class="lineNum">    8733 </span><span class="lineNoCov">          0 :   WorkerPrivate* workerPrivate = GetWorkerPrivateFromContext(aCx);</span>
<span class="lineNum">    8734 </span><span class="lineNoCov">          0 :   if (!workerPrivate) {</span>
<span class="lineNum">    8735 </span>            :     return false;
<span class="lineNum">    8736 </span>            :   }
<span class="lineNum">    8737 </span>            : 
<span class="lineNum">    8738 </span><span class="lineNoCov">          0 :   return workerPrivate-&gt;PushEnabled();</span>
<span class="lineNum">    8739 </span>            : }
<span class="lineNum">    8740 </span>            : 
<span class="lineNum">    8741 </span>            : // static
<span class="lineNum">    8742 </span>            : bool
<span class="lineNum">    8743 </span><span class="lineNoCov">          0 : nsContentUtils::IsNonSubresourceRequest(nsIChannel* aChannel)</span>
<span class="lineNum">    8744 </span>            : {
<span class="lineNum">    8745 </span><span class="lineNoCov">          0 :   nsLoadFlags loadFlags = 0;</span>
<span class="lineNum">    8746 </span><span class="lineNoCov">          0 :   aChannel-&gt;GetLoadFlags(&amp;loadFlags);</span>
<span class="lineNum">    8747 </span><span class="lineNoCov">          0 :   if (loadFlags &amp; nsIChannel::LOAD_DOCUMENT_URI) {</span>
<span class="lineNum">    8748 </span>            :     return true;
<span class="lineNum">    8749 </span>            :   }
<span class="lineNum">    8750 </span>            : 
<span class="lineNum">    8751 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsILoadInfo&gt; loadInfo = aChannel-&gt;GetLoadInfo();</span>
<span class="lineNum">    8752 </span><span class="lineNoCov">          0 :   if (!loadInfo) {</span>
<span class="lineNum">    8753 </span>            :     return false;
<span class="lineNum">    8754 </span>            :   }
<span class="lineNum">    8755 </span><span class="lineNoCov">          0 :   nsContentPolicyType type = loadInfo-&gt;InternalContentPolicyType();</span>
<span class="lineNum">    8756 </span><span class="lineNoCov">          0 :   return type == nsIContentPolicy::TYPE_INTERNAL_WORKER ||</span>
<span class="lineNum">    8757 </span><span class="lineNoCov">          0 :          type == nsIContentPolicy::TYPE_INTERNAL_SHARED_WORKER;</span>
<span class="lineNum">    8758 </span>            : }
<span class="lineNum">    8759 </span>            : 
<span class="lineNum">    8760 </span>            : // static, public
<span class="lineNum">    8761 </span>            : nsContentUtils::StorageAccess
<span class="lineNum">    8762 </span><span class="lineNoCov">          0 : nsContentUtils::StorageAllowedForWindow(nsPIDOMWindowInner* aWindow)</span>
<span class="lineNum">    8763 </span>            : {
<span class="lineNum">    8764 </span>            :   MOZ_ASSERT(aWindow-&gt;IsInnerWindow());
<span class="lineNum">    8765 </span>            : 
<span class="lineNum">    8766 </span><span class="lineNoCov">          0 :   if (nsIDocument* document = aWindow-&gt;GetExtantDoc()) {</span>
<span class="lineNum">    8767 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIPrincipal&gt; principal = document-&gt;NodePrincipal();</span>
<span class="lineNum">    8768 </span><span class="lineNoCov">          0 :     return InternalStorageAllowedForPrincipal(principal, aWindow);</span>
<span class="lineNum">    8769 </span>            :   }
<span class="lineNum">    8770 </span>            : 
<span class="lineNum">    8771 </span>            :   return StorageAccess::eDeny;
<span class="lineNum">    8772 </span>            : }
<span class="lineNum">    8773 </span>            : 
<a name="8774"><span class="lineNum">    8774 </span>            : // static, public</a>
<span class="lineNum">    8775 </span>            : nsContentUtils::StorageAccess
<span class="lineNum">    8776 </span><span class="lineNoCov">          0 : nsContentUtils::StorageAllowedForPrincipal(nsIPrincipal* aPrincipal)</span>
<span class="lineNum">    8777 </span>            : {
<span class="lineNum">    8778 </span><span class="lineNoCov">          0 :   return InternalStorageAllowedForPrincipal(aPrincipal, nullptr);</span>
<span class="lineNum">    8779 </span>            : }
<span class="lineNum">    8780 </span>            : 
<span class="lineNum">    8781 </span>            : // static, private
<span class="lineNum">    8782 </span>            : nsContentUtils::StorageAccess
<span class="lineNum">    8783 </span><span class="lineNoCov">          0 : nsContentUtils::InternalStorageAllowedForPrincipal(nsIPrincipal* aPrincipal,</span>
<span class="lineNum">    8784 </span>            :                                                    nsPIDOMWindowInner* aWindow)
<span class="lineNum">    8785 </span>            : {
<span class="lineNum">    8786 </span>            :   MOZ_ASSERT(aPrincipal);
<span class="lineNum">    8787 </span>            :   MOZ_ASSERT(!aWindow || aWindow-&gt;IsInnerWindow());
<span class="lineNum">    8788 </span>            : 
<span class="lineNum">    8789 </span><span class="lineNoCov">          0 :   StorageAccess access = StorageAccess::eAllow;</span>
<span class="lineNum">    8790 </span>            : 
<span class="lineNum">    8791 </span>            :   // We don't allow storage on the null principal, in general. Even if the
<span class="lineNum">    8792 </span>            :   // calling context is chrome.
<span class="lineNum">    8793 </span><span class="lineNoCov">          0 :   if (aPrincipal-&gt;GetIsNullPrincipal()) {</span>
<span class="lineNum">    8794 </span>            :     return StorageAccess::eDeny;
<span class="lineNum">    8795 </span>            :   }
<span class="lineNum">    8796 </span>            : 
<span class="lineNum">    8797 </span><span class="lineNoCov">          0 :   if (aWindow) {</span>
<span class="lineNum">    8798 </span>            :     // If the document is sandboxed, then it is not permitted to use storage
<span class="lineNum">    8799 </span><span class="lineNoCov">          0 :     nsIDocument* document = aWindow-&gt;GetExtantDoc();</span>
<span class="lineNum">    8800 </span><span class="lineNoCov">          0 :     if (document-&gt;GetSandboxFlags() &amp; SANDBOXED_ORIGIN) {</span>
<span class="lineNum">    8801 </span>            :       return StorageAccess::eDeny;
<span class="lineNum">    8802 </span>            :     }
<span class="lineNum">    8803 </span>            : 
<span class="lineNum">    8804 </span>            :     // Check if we are in private browsing, and record that fact
<span class="lineNum">    8805 </span><span class="lineNoCov">          0 :     if (IsInPrivateBrowsing(document)) {</span>
<span class="lineNum">    8806 </span><span class="lineNoCov">          0 :       access = StorageAccess::ePrivateBrowsing;</span>
<span class="lineNum">    8807 </span>            :     }
<span class="lineNum">    8808 </span>            :   }
<span class="lineNum">    8809 </span>            : 
<span class="lineNum">    8810 </span>            :   nsCOMPtr&lt;nsIPermissionManager&gt; permissionManager =
<span class="lineNum">    8811 </span><span class="lineNoCov">          0 :     services::GetPermissionManager();</span>
<span class="lineNum">    8812 </span><span class="lineNoCov">          0 :   if (!permissionManager) {</span>
<span class="lineNum">    8813 </span>            :     return StorageAccess::eDeny;
<span class="lineNum">    8814 </span>            :   }
<span class="lineNum">    8815 </span>            : 
<span class="lineNum">    8816 </span>            :   // check the permission manager for any allow or deny permissions
<span class="lineNum">    8817 </span>            :   // for cookies for the window.
<span class="lineNum">    8818 </span>            :   uint32_t perm;
<span class="lineNum">    8819 </span><span class="lineNoCov">          0 :   permissionManager-&gt;TestPermissionFromPrincipal(aPrincipal, &quot;cookie&quot;, &amp;perm);</span>
<span class="lineNum">    8820 </span><span class="lineNoCov">          0 :   if (perm == nsIPermissionManager::DENY_ACTION) {</span>
<span class="lineNum">    8821 </span>            :     return StorageAccess::eDeny;
<span class="lineNum">    8822 </span>            :   }
<span class="lineNum">    8823 </span><span class="lineNoCov">          0 :   if (perm == nsICookiePermission::ACCESS_SESSION) {</span>
<span class="lineNum">    8824 </span><span class="lineNoCov">          0 :     return std::min(access, StorageAccess::eSessionScoped);</span>
<span class="lineNum">    8825 </span>            :   }
<span class="lineNum">    8826 </span><span class="lineNoCov">          0 :   if (perm == nsIPermissionManager::ALLOW_ACTION) {</span>
<span class="lineNum">    8827 </span><span class="lineNoCov">          0 :     return access;</span>
<span class="lineNum">    8828 </span>            :   }
<span class="lineNum">    8829 </span>            : 
<span class="lineNum">    8830 </span>            :   // Check if we should only allow storage for the session, and record that fact
<span class="lineNum">    8831 </span><span class="lineNoCov">          0 :   if (sCookiesLifetimePolicy == nsICookieService::ACCEPT_SESSION) {</span>
<span class="lineNum">    8832 </span>            :     // Storage could be StorageAccess::ePrivateBrowsing or StorageAccess::eAllow
<span class="lineNum">    8833 </span>            :     // so perform a std::min comparison to make sure we preserve ePrivateBrowsing
<span class="lineNum">    8834 </span>            :     // if it has been set.
<span class="lineNum">    8835 </span><span class="lineNoCov">          0 :     access = std::min(StorageAccess::eSessionScoped, access);</span>
<span class="lineNum">    8836 </span>            :   }
<span class="lineNum">    8837 </span>            : 
<span class="lineNum">    8838 </span>            :   // About URIs are allowed to access storage, even if they don't have chrome
<span class="lineNum">    8839 </span>            :   // privileges. If this is not desired, than the consumer will have to
<span class="lineNum">    8840 </span>            :   // implement their own restriction functionality.
<span class="lineNum">    8841 </span>            :   //
<span class="lineNum">    8842 </span>            :   // This is due to backwards-compatibility and the state of storage access before
<span class="lineNum">    8843 </span>            :   // the introducton of nsContentUtils::InternalStorageAllowedForPrincipal:
<span class="lineNum">    8844 </span>            :   //
<span class="lineNum">    8845 </span>            :   // BEFORE:
<span class="lineNum">    8846 </span>            :   // localStorage, caches: allowed in 3rd-party iframes always
<span class="lineNum">    8847 </span>            :   // IndexedDB: allowed in 3rd-party iframes only if 3rd party URI is an about:
<span class="lineNum">    8848 </span>            :   //   URI within a specific whitelist
<span class="lineNum">    8849 </span>            :   //
<span class="lineNum">    8850 </span>            :   // AFTER:
<span class="lineNum">    8851 </span>            :   // localStorage, caches: allowed in 3rd-party iframes by default. Preference
<span class="lineNum">    8852 </span>            :   //   can be set to disable in 3rd-party, which will not disallow in about: URIs.
<span class="lineNum">    8853 </span>            :   // IndexedDB: allowed in 3rd-party iframes by default. Preference can be set to
<span class="lineNum">    8854 </span>            :   //   disable in 3rd-party, which will disallow in about: URIs, unless they are
<span class="lineNum">    8855 </span>            :   //   within a specific whitelist.
<span class="lineNum">    8856 </span>            :   //
<span class="lineNum">    8857 </span>            :   // This means that behavior for storage with internal about: URIs should not be
<span class="lineNum">    8858 </span>            :   // affected, which is desireable due to the lack of automated testing for about:
<span class="lineNum">    8859 </span>            :   // URIs with these preferences set, and the importance of the correct functioning
<span class="lineNum">    8860 </span>            :   // of these URIs even with custom preferences.
<span class="lineNum">    8861 </span>            :   nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">    8862 </span><span class="lineNoCov">          0 :   nsresult rv = aPrincipal-&gt;GetURI(getter_AddRefs(uri));</span>
<span class="lineNum">    8863 </span><span class="lineNoCov">          0 :   if (NS_SUCCEEDED(rv) &amp;&amp; uri) {</span>
<span class="lineNum">    8864 </span><span class="lineNoCov">          0 :     bool isAbout = false;</span>
<span class="lineNum">    8865 </span><span class="lineNoCov">          0 :     MOZ_ALWAYS_SUCCEEDS(uri-&gt;SchemeIs(&quot;about&quot;, &amp;isAbout));</span>
<span class="lineNum">    8866 </span><span class="lineNoCov">          0 :     if (isAbout) {</span>
<span class="lineNum">    8867 </span><span class="lineNoCov">          0 :       return access;</span>
<span class="lineNum">    8868 </span>            :     }
<span class="lineNum">    8869 </span>            :   }
<span class="lineNum">    8870 </span>            : 
<span class="lineNum">    8871 </span>            :   // We don't want to prompt for every attempt to access permissions.
<span class="lineNum">    8872 </span><span class="lineNoCov">          0 :   if (sCookiesBehavior == nsICookieService::BEHAVIOR_REJECT) {</span>
<span class="lineNum">    8873 </span>            :     return StorageAccess::eDeny;
<span class="lineNum">    8874 </span>            :   }
<span class="lineNum">    8875 </span>            : 
<span class="lineNum">    8876 </span>            :   // In the absense of a window, we assume that we are first-party.
<span class="lineNum">    8877 </span><span class="lineNoCov">          0 :   if (aWindow &amp;&amp; (sCookiesBehavior == nsICookieService::BEHAVIOR_REJECT_FOREIGN ||</span>
<span class="lineNum">    8878 </span>            :                   sCookiesBehavior == nsICookieService::BEHAVIOR_LIMIT_FOREIGN)) {
<span class="lineNum">    8879 </span>            :     nsCOMPtr&lt;mozIThirdPartyUtil&gt; thirdPartyUtil =
<span class="lineNum">    8880 </span><span class="lineNoCov">          0 :       do_GetService(THIRDPARTYUTIL_CONTRACTID);</span>
<span class="lineNum">    8881 </span>            :     MOZ_ASSERT(thirdPartyUtil);
<span class="lineNum">    8882 </span>            : 
<span class="lineNum">    8883 </span><span class="lineNoCov">          0 :     bool thirdPartyWindow = false;</span>
<span class="lineNum">    8884 </span><span class="lineNoCov">          0 :     if (NS_SUCCEEDED(thirdPartyUtil-&gt;IsThirdPartyWindow(</span>
<span class="lineNum">    8885 </span><span class="lineNoCov">          0 :           aWindow-&gt;GetOuterWindow(), nullptr, &amp;thirdPartyWindow)) &amp;&amp; thirdPartyWindow) {</span>
<span class="lineNum">    8886 </span>            :       // XXX For non-cookie forms of storage, we handle BEHAVIOR_LIMIT_FOREIGN by
<span class="lineNum">    8887 </span>            :       // simply rejecting the request to use the storage. In the future, if we
<span class="lineNum">    8888 </span>            :       // change the meaning of BEHAVIOR_LIMIT_FOREIGN to be one which makes sense
<span class="lineNum">    8889 </span>            :       // for non-cookie storage types, this may change.
<span class="lineNum">    8890 </span>            : 
<span class="lineNum">    8891 </span><span class="lineNoCov">          0 :       return StorageAccess::eDeny;</span>
<span class="lineNum">    8892 </span>            :     }
<span class="lineNum">    8893 </span>            :   }
<span class="lineNum">    8894 </span>            : 
<span class="lineNum">    8895 </span><span class="lineNoCov">          0 :   return access;</span>
<span class="lineNum">    8896 </span>            : }
<span class="lineNum">    8897 </span>            : 
<span class="lineNum">    8898 </span>            : namespace {
<span class="lineNum">    8899 </span>            : 
<span class="lineNum">    8900 </span>            : // We put StringBuilder in the anonymous namespace to prevent anything outside
<span class="lineNum">    8901 </span>            : // this file from accidentally being linked against it.
<span class="lineNum">    8902 </span>            : 
<span class="lineNum">    8903 </span>            : class StringBuilder
<span class="lineNum">    8904 </span>            : {
<span class="lineNum">    8905 </span>            : private:
<span class="lineNum">    8906 </span>            :   // Try to keep the size of StringBuilder close to a jemalloc bucket size.
<span class="lineNum">    8907 </span>            :   static const uint32_t STRING_BUFFER_UNITS = 1020;
<span class="lineNum">    8908 </span>            :   class Unit
<span class="lineNum">    8909 </span>            :   {
<span class="lineNum">    8910 </span>            :   public:
<span class="lineNum">    8911 </span><span class="lineNoCov">          0 :     Unit() : mAtom(nullptr), mType(eUnknown), mLength(0)</span>
<span class="lineNum">    8912 </span>            :     {
<a name="8913"><span class="lineNum">    8913 </span>            :       MOZ_COUNT_CTOR(StringBuilder::Unit);</a>
<span class="lineNum">    8914 </span>            :     }
<span class="lineNum">    8915 </span><span class="lineNoCov">          0 :     ~Unit()</span>
<span class="lineNum">    8916 </span>            :     {
<span class="lineNum">    8917 </span><span class="lineNoCov">          0 :       if (mType == eString || mType == eStringWithEncode) {</span>
<span class="lineNum">    8918 </span><span class="lineNoCov">          0 :         delete mString;</span>
<span class="lineNum">    8919 </span>            :       }
<span class="lineNum">    8920 </span>            :       MOZ_COUNT_DTOR(StringBuilder::Unit);
<span class="lineNum">    8921 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    8922 </span>            : 
<span class="lineNum">    8923 </span>            :     enum Type
<span class="lineNum">    8924 </span>            :     {
<span class="lineNum">    8925 </span>            :       eUnknown,
<span class="lineNum">    8926 </span>            :       eAtom,
<span class="lineNum">    8927 </span>            :       eString,
<span class="lineNum">    8928 </span>            :       eStringWithEncode,
<span class="lineNum">    8929 </span>            :       eLiteral,
<span class="lineNum">    8930 </span>            :       eTextFragment,
<span class="lineNum">    8931 </span>            :       eTextFragmentWithEncode,
<span class="lineNum">    8932 </span>            :     };
<span class="lineNum">    8933 </span>            : 
<span class="lineNum">    8934 </span>            :     union
<span class="lineNum">    8935 </span>            :     {
<span class="lineNum">    8936 </span>            :       nsIAtom*              mAtom;
<span class="lineNum">    8937 </span>            :       const char*           mLiteral;
<span class="lineNum">    8938 </span>            :       nsAutoString*         mString;
<span class="lineNum">    8939 </span>            :       const nsTextFragment* mTextFragment;
<span class="lineNum">    8940 </span>            :     };
<span class="lineNum">    8941 </span>            :     Type     mType;
<span class="lineNum">    8942 </span>            :     uint32_t mLength;
<a name="8943"><span class="lineNum">    8943 </span>            :   };</a>
<span class="lineNum">    8944 </span>            : public:
<span class="lineNum">    8945 </span><span class="lineNoCov">          0 :   StringBuilder() : mLast(this), mLength(0)</span>
<span class="lineNum">    8946 </span>            :   {
<span class="lineNum">    8947 </span>            :     MOZ_COUNT_CTOR(StringBuilder);
<a name="8948"><span class="lineNum">    8948 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    8949 </span>            : 
<span class="lineNum">    8950 </span><span class="lineNoCov">          0 :   ~StringBuilder()</span>
<span class="lineNum">    8951 </span><span class="lineNoCov">          0 :   {</span>
<span class="lineNum">    8952 </span>            :     MOZ_COUNT_DTOR(StringBuilder);
<a name="8953"><span class="lineNum">    8953 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    8954 </span>            : 
<span class="lineNum">    8955 </span><span class="lineNoCov">          0 :   void Append(nsIAtom* aAtom)</span>
<span class="lineNum">    8956 </span>            :   {
<span class="lineNum">    8957 </span><span class="lineNoCov">          0 :     Unit* u = AddUnit();</span>
<span class="lineNum">    8958 </span><span class="lineNoCov">          0 :     u-&gt;mAtom = aAtom;</span>
<span class="lineNum">    8959 </span><span class="lineNoCov">          0 :     u-&gt;mType = Unit::eAtom;</span>
<span class="lineNum">    8960 </span><span class="lineNoCov">          0 :     uint32_t len = aAtom-&gt;GetLength();</span>
<span class="lineNum">    8961 </span><span class="lineNoCov">          0 :     u-&gt;mLength = len;</span>
<span class="lineNum">    8962 </span><span class="lineNoCov">          0 :     mLength += len;</span>
<span class="lineNum">    8963 </span><span class="lineNoCov">          0 :   }</span>
<a name="8964"><span class="lineNum">    8964 </span>            : </a>
<span class="lineNum">    8965 </span>            :   template&lt;int N&gt;
<span class="lineNum">    8966 </span><span class="lineNoCov">          0 :   void Append(const char (&amp;aLiteral)[N])</span>
<span class="lineNum">    8967 </span>            :   {
<span class="lineNum">    8968 </span><span class="lineNoCov">          0 :     Unit* u = AddUnit();</span>
<span class="lineNum">    8969 </span><span class="lineNoCov">          0 :     u-&gt;mLiteral = aLiteral;</span>
<span class="lineNum">    8970 </span><span class="lineNoCov">          0 :     u-&gt;mType = Unit::eLiteral;</span>
<span class="lineNum">    8971 </span><span class="lineNoCov">          0 :     uint32_t len = N - 1;</span>
<span class="lineNum">    8972 </span><span class="lineNoCov">          0 :     u-&gt;mLength = len;</span>
<span class="lineNum">    8973 </span><span class="lineNoCov">          0 :     mLength += len;</span>
<span class="lineNum">    8974 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    8975 </span>            : 
<span class="lineNum">    8976 </span>            :   template&lt;int N&gt;
<span class="lineNum">    8977 </span>            :   void Append(char (&amp;aLiteral)[N])
<span class="lineNum">    8978 </span>            :   {
<span class="lineNum">    8979 </span>            :     Unit* u = AddUnit();
<span class="lineNum">    8980 </span>            :     u-&gt;mLiteral = aLiteral;
<span class="lineNum">    8981 </span>            :     u-&gt;mType = Unit::eLiteral;
<span class="lineNum">    8982 </span>            :     uint32_t len = N - 1;
<span class="lineNum">    8983 </span>            :     u-&gt;mLength = len;
<span class="lineNum">    8984 </span>            :     mLength += len;
<a name="8985"><span class="lineNum">    8985 </span>            :   }</a>
<span class="lineNum">    8986 </span>            : 
<span class="lineNum">    8987 </span><span class="lineNoCov">          0 :   void Append(const nsAString&amp; aString)</span>
<span class="lineNum">    8988 </span>            :   {
<span class="lineNum">    8989 </span><span class="lineNoCov">          0 :     Unit* u = AddUnit();</span>
<span class="lineNum">    8990 </span><span class="lineNoCov">          0 :     u-&gt;mString = new nsAutoString(aString);</span>
<span class="lineNum">    8991 </span><span class="lineNoCov">          0 :     u-&gt;mType = Unit::eString;</span>
<span class="lineNum">    8992 </span><span class="lineNoCov">          0 :     uint32_t len = aString.Length();</span>
<span class="lineNum">    8993 </span><span class="lineNoCov">          0 :     u-&gt;mLength = len;</span>
<span class="lineNum">    8994 </span><span class="lineNoCov">          0 :     mLength += len;</span>
<a name="8995"><span class="lineNum">    8995 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    8996 </span>            : 
<span class="lineNum">    8997 </span><span class="lineNoCov">          0 :   void Append(nsAutoString* aString)</span>
<span class="lineNum">    8998 </span>            :   {
<span class="lineNum">    8999 </span><span class="lineNoCov">          0 :     Unit* u = AddUnit();</span>
<span class="lineNum">    9000 </span><span class="lineNoCov">          0 :     u-&gt;mString = aString;</span>
<span class="lineNum">    9001 </span><span class="lineNoCov">          0 :     u-&gt;mType = Unit::eString;</span>
<span class="lineNum">    9002 </span><span class="lineNoCov">          0 :     uint32_t len = aString-&gt;Length();</span>
<span class="lineNum">    9003 </span><span class="lineNoCov">          0 :     u-&gt;mLength = len;</span>
<span class="lineNum">    9004 </span><span class="lineNoCov">          0 :     mLength += len;</span>
<a name="9005"><span class="lineNum">    9005 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    9006 </span>            : 
<span class="lineNum">    9007 </span><span class="lineNoCov">          0 :   void AppendWithAttrEncode(nsAutoString* aString, uint32_t aLen)</span>
<span class="lineNum">    9008 </span>            :   {
<span class="lineNum">    9009 </span><span class="lineNoCov">          0 :     Unit* u = AddUnit();</span>
<span class="lineNum">    9010 </span><span class="lineNoCov">          0 :     u-&gt;mString = aString;</span>
<span class="lineNum">    9011 </span><span class="lineNoCov">          0 :     u-&gt;mType = Unit::eStringWithEncode;</span>
<span class="lineNum">    9012 </span><span class="lineNoCov">          0 :     u-&gt;mLength = aLen;</span>
<span class="lineNum">    9013 </span><span class="lineNoCov">          0 :     mLength += aLen;</span>
<a name="9014"><span class="lineNum">    9014 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    9015 </span>            : 
<span class="lineNum">    9016 </span><span class="lineNoCov">          0 :   void Append(const nsTextFragment* aTextFragment)</span>
<span class="lineNum">    9017 </span>            :   {
<span class="lineNum">    9018 </span><span class="lineNoCov">          0 :     Unit* u = AddUnit();</span>
<span class="lineNum">    9019 </span><span class="lineNoCov">          0 :     u-&gt;mTextFragment = aTextFragment;</span>
<span class="lineNum">    9020 </span><span class="lineNoCov">          0 :     u-&gt;mType = Unit::eTextFragment;</span>
<span class="lineNum">    9021 </span><span class="lineNoCov">          0 :     uint32_t len = aTextFragment-&gt;GetLength();</span>
<span class="lineNum">    9022 </span><span class="lineNoCov">          0 :     u-&gt;mLength = len;</span>
<span class="lineNum">    9023 </span><span class="lineNoCov">          0 :     mLength += len;</span>
<a name="9024"><span class="lineNum">    9024 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    9025 </span>            : 
<span class="lineNum">    9026 </span><span class="lineNoCov">          0 :   void AppendWithEncode(const nsTextFragment* aTextFragment, uint32_t aLen)</span>
<span class="lineNum">    9027 </span>            :   {
<span class="lineNum">    9028 </span><span class="lineNoCov">          0 :     Unit* u = AddUnit();</span>
<span class="lineNum">    9029 </span><span class="lineNoCov">          0 :     u-&gt;mTextFragment = aTextFragment;</span>
<span class="lineNum">    9030 </span><span class="lineNoCov">          0 :     u-&gt;mType = Unit::eTextFragmentWithEncode;</span>
<span class="lineNum">    9031 </span><span class="lineNoCov">          0 :     u-&gt;mLength = aLen;</span>
<span class="lineNum">    9032 </span><span class="lineNoCov">          0 :     mLength += aLen;</span>
<a name="9033"><span class="lineNum">    9033 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    9034 </span>            : 
<span class="lineNum">    9035 </span><span class="lineNoCov">          0 :   bool ToString(nsAString&amp; aOut)</span>
<span class="lineNum">    9036 </span>            :   {
<span class="lineNum">    9037 </span><span class="lineNoCov">          0 :     if (!aOut.SetCapacity(mLength, fallible)) {</span>
<span class="lineNum">    9038 </span>            :       return false;
<span class="lineNum">    9039 </span>            :     }
<span class="lineNum">    9040 </span>            : 
<span class="lineNum">    9041 </span><span class="lineNoCov">          0 :     for (StringBuilder* current = this; current; current = current-&gt;mNext) {</span>
<span class="lineNum">    9042 </span><span class="lineNoCov">          0 :       uint32_t len = current-&gt;mUnits.Length();</span>
<span class="lineNum">    9043 </span><span class="lineNoCov">          0 :       for (uint32_t i = 0; i &lt; len; ++i) {</span>
<span class="lineNum">    9044 </span><span class="lineNoCov">          0 :         Unit&amp; u = current-&gt;mUnits[i];</span>
<span class="lineNum">    9045 </span><span class="lineNoCov">          0 :         switch (u.mType) {</span>
<span class="lineNum">    9046 </span>            :           case Unit::eAtom:
<span class="lineNum">    9047 </span><span class="lineNoCov">          0 :             aOut.Append(nsDependentAtomString(u.mAtom));</span>
<span class="lineNum">    9048 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    9049 </span>            :           case Unit::eString:
<span class="lineNum">    9050 </span><span class="lineNoCov">          0 :             aOut.Append(*(u.mString));</span>
<span class="lineNum">    9051 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    9052 </span>            :           case Unit::eStringWithEncode:
<span class="lineNum">    9053 </span><span class="lineNoCov">          0 :             EncodeAttrString(*(u.mString), aOut);</span>
<span class="lineNum">    9054 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    9055 </span>            :           case Unit::eLiteral:
<span class="lineNum">    9056 </span><span class="lineNoCov">          0 :             aOut.AppendASCII(u.mLiteral, u.mLength);</span>
<span class="lineNum">    9057 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    9058 </span>            :           case Unit::eTextFragment:
<span class="lineNum">    9059 </span><span class="lineNoCov">          0 :             u.mTextFragment-&gt;AppendTo(aOut);</span>
<span class="lineNum">    9060 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    9061 </span>            :           case Unit::eTextFragmentWithEncode:
<span class="lineNum">    9062 </span><span class="lineNoCov">          0 :             EncodeTextFragment(u.mTextFragment, aOut);</span>
<span class="lineNum">    9063 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    9064 </span>            :           default:
<span class="lineNum">    9065 </span><span class="lineNoCov">          0 :             MOZ_CRASH(&quot;Unknown unit type?&quot;);</span>
<span class="lineNum">    9066 </span>            :         }
<span class="lineNum">    9067 </span>            :       }
<span class="lineNum">    9068 </span>            :     }
<span class="lineNum">    9069 </span>            :     return true;
<a name="9070"><span class="lineNum">    9070 </span>            :   }</a>
<span class="lineNum">    9071 </span>            : private:
<span class="lineNum">    9072 </span><span class="lineNoCov">          0 :   Unit* AddUnit()</span>
<span class="lineNum">    9073 </span>            :   {
<span class="lineNum">    9074 </span><span class="lineNoCov">          0 :     if (mLast-&gt;mUnits.Length() == STRING_BUFFER_UNITS) {</span>
<span class="lineNum">    9075 </span><span class="lineNoCov">          0 :       new StringBuilder(this);</span>
<span class="lineNum">    9076 </span>            :     }
<span class="lineNum">    9077 </span><span class="lineNoCov">          0 :     return mLast-&gt;mUnits.AppendElement();</span>
<a name="9078"><span class="lineNum">    9078 </span>            :   }</a>
<span class="lineNum">    9079 </span>            : 
<span class="lineNum">    9080 </span><span class="lineNoCov">          0 :   explicit StringBuilder(StringBuilder* aFirst)</span>
<span class="lineNum">    9081 </span><span class="lineNoCov">          0 :   : mLast(nullptr), mLength(0)</span>
<span class="lineNum">    9082 </span>            :   {
<span class="lineNum">    9083 </span>            :     MOZ_COUNT_CTOR(StringBuilder);
<span class="lineNum">    9084 </span><span class="lineNoCov">          0 :     aFirst-&gt;mLast-&gt;mNext = this;</span>
<span class="lineNum">    9085 </span><span class="lineNoCov">          0 :     aFirst-&gt;mLast = this;</span>
<a name="9086"><span class="lineNum">    9086 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    9087 </span>            : 
<span class="lineNum">    9088 </span><span class="lineNoCov">          0 :   void EncodeAttrString(const nsAutoString&amp; aValue, nsAString&amp; aOut)</span>
<span class="lineNum">    9089 </span>            :   {
<span class="lineNum">    9090 </span><span class="lineNoCov">          0 :     const char16_t* c = aValue.BeginReading();</span>
<span class="lineNum">    9091 </span><span class="lineNoCov">          0 :     const char16_t* end = aValue.EndReading();</span>
<span class="lineNum">    9092 </span><span class="lineNoCov">          0 :     while (c &lt; end) {</span>
<span class="lineNum">    9093 </span><span class="lineNoCov">          0 :       switch (*c) {</span>
<span class="lineNum">    9094 </span>            :       case '&quot;':
<span class="lineNum">    9095 </span><span class="lineNoCov">          0 :         aOut.AppendLiteral(&quot;&amp;quot;&quot;);</span>
<span class="lineNum">    9096 </span>            :         break;
<span class="lineNum">    9097 </span>            :       case '&amp;':
<span class="lineNum">    9098 </span><span class="lineNoCov">          0 :         aOut.AppendLiteral(&quot;&amp;amp;&quot;);</span>
<span class="lineNum">    9099 </span>            :         break;
<span class="lineNum">    9100 </span>            :       case 0x00A0:
<span class="lineNum">    9101 </span><span class="lineNoCov">          0 :         aOut.AppendLiteral(&quot;&amp;nbsp;&quot;);</span>
<span class="lineNum">    9102 </span>            :         break;
<span class="lineNum">    9103 </span>            :       default:
<span class="lineNum">    9104 </span><span class="lineNoCov">          0 :         aOut.Append(*c);</span>
<span class="lineNum">    9105 </span>            :         break;
<span class="lineNum">    9106 </span>            :       }
<span class="lineNum">    9107 </span><span class="lineNoCov">          0 :       ++c;</span>
<span class="lineNum">    9108 </span>            :     }
<a name="9109"><span class="lineNum">    9109 </span><span class="lineNoCov">          0 :   }</span></a>
<span class="lineNum">    9110 </span>            : 
<span class="lineNum">    9111 </span><span class="lineNoCov">          0 :   void EncodeTextFragment(const nsTextFragment* aValue, nsAString&amp; aOut)</span>
<span class="lineNum">    9112 </span>            :   {
<span class="lineNum">    9113 </span><span class="lineNoCov">          0 :     uint32_t len = aValue-&gt;GetLength();</span>
<span class="lineNum">    9114 </span><span class="lineNoCov">          0 :     if (aValue-&gt;Is2b()) {</span>
<span class="lineNum">    9115 </span><span class="lineNoCov">          0 :       const char16_t* data = aValue-&gt;Get2b();</span>
<span class="lineNum">    9116 </span><span class="lineNoCov">          0 :       for (uint32_t i = 0; i &lt; len; ++i) {</span>
<span class="lineNum">    9117 </span><span class="lineNoCov">          0 :         const char16_t c = data[i];</span>
<span class="lineNum">    9118 </span><span class="lineNoCov">          0 :         switch (c) {</span>
<span class="lineNum">    9119 </span>            :           case '&lt;':
<span class="lineNum">    9120 </span><span class="lineNoCov">          0 :             aOut.AppendLiteral(&quot;&amp;lt;&quot;);</span>
<span class="lineNum">    9121 </span>            :             break;
<span class="lineNum">    9122 </span>            :           case '&gt;':
<span class="lineNum">    9123 </span><span class="lineNoCov">          0 :             aOut.AppendLiteral(&quot;&amp;gt;&quot;);</span>
<span class="lineNum">    9124 </span>            :             break;
<span class="lineNum">    9125 </span>            :           case '&amp;':
<span class="lineNum">    9126 </span><span class="lineNoCov">          0 :             aOut.AppendLiteral(&quot;&amp;amp;&quot;);</span>
<span class="lineNum">    9127 </span>            :             break;
<span class="lineNum">    9128 </span>            :           case 0x00A0:
<span class="lineNum">    9129 </span><span class="lineNoCov">          0 :             aOut.AppendLiteral(&quot;&amp;nbsp;&quot;);</span>
<span class="lineNum">    9130 </span>            :             break;
<span class="lineNum">    9131 </span>            :           default:
<span class="lineNum">    9132 </span><span class="lineNoCov">          0 :             aOut.Append(c);</span>
<span class="lineNum">    9133 </span>            :             break;
<span class="lineNum">    9134 </span>            :         }
<span class="lineNum">    9135 </span>            :       }
<span class="lineNum">    9136 </span>            :     } else {
<span class="lineNum">    9137 </span><span class="lineNoCov">          0 :       const char* data = aValue-&gt;Get1b();</span>
<span class="lineNum">    9138 </span><span class="lineNoCov">          0 :       for (uint32_t i = 0; i &lt; len; ++i) {</span>
<span class="lineNum">    9139 </span><span class="lineNoCov">          0 :         const unsigned char c = data[i];</span>
<span class="lineNum">    9140 </span><span class="lineNoCov">          0 :         switch (c) {</span>
<span class="lineNum">    9141 </span>            :           case '&lt;':
<span class="lineNum">    9142 </span><span class="lineNoCov">          0 :             aOut.AppendLiteral(&quot;&amp;lt;&quot;);</span>
<span class="lineNum">    9143 </span>            :             break;
<span class="lineNum">    9144 </span>            :           case '&gt;':
<span class="lineNum">    9145 </span><span class="lineNoCov">          0 :             aOut.AppendLiteral(&quot;&amp;gt;&quot;);</span>
<span class="lineNum">    9146 </span>            :             break;
<span class="lineNum">    9147 </span>            :           case '&amp;':
<span class="lineNum">    9148 </span><span class="lineNoCov">          0 :             aOut.AppendLiteral(&quot;&amp;amp;&quot;);</span>
<span class="lineNum">    9149 </span>            :             break;
<span class="lineNum">    9150 </span>            :           case 0x00A0:
<span class="lineNum">    9151 </span><span class="lineNoCov">          0 :             aOut.AppendLiteral(&quot;&amp;nbsp;&quot;);</span>
<span class="lineNum">    9152 </span>            :             break;
<span class="lineNum">    9153 </span>            :           default:
<span class="lineNum">    9154 </span><span class="lineNoCov">          0 :             aOut.Append(c);</span>
<span class="lineNum">    9155 </span>            :             break;
<span class="lineNum">    9156 </span>            :         }
<span class="lineNum">    9157 </span>            :       }
<span class="lineNum">    9158 </span>            :     }
<span class="lineNum">    9159 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    9160 </span>            : 
<span class="lineNum">    9161 </span>            :   AutoTArray&lt;Unit, STRING_BUFFER_UNITS&gt; mUnits;
<span class="lineNum">    9162 </span>            :   nsAutoPtr&lt;StringBuilder&gt;                mNext;
<span class="lineNum">    9163 </span>            :   StringBuilder*                          mLast;
<span class="lineNum">    9164 </span>            :   // mLength is used only in the first StringBuilder object in the linked list.
<span class="lineNum">    9165 </span>            :   uint32_t                                mLength;
<span class="lineNum">    9166 </span>            : };
<span class="lineNum">    9167 </span>            : 
<span class="lineNum">    9168 </span>            : } // namespace
<a name="9169"><span class="lineNum">    9169 </span>            : </a>
<span class="lineNum">    9170 </span>            : static void
<span class="lineNum">    9171 </span><span class="lineNoCov">          0 : AppendEncodedCharacters(const nsTextFragment* aText, StringBuilder&amp; aBuilder)</span>
<span class="lineNum">    9172 </span>            : {
<span class="lineNum">    9173 </span><span class="lineNoCov">          0 :   uint32_t extraSpaceNeeded = 0;</span>
<span class="lineNum">    9174 </span><span class="lineNoCov">          0 :   uint32_t len = aText-&gt;GetLength();</span>
<span class="lineNum">    9175 </span><span class="lineNoCov">          0 :   if (aText-&gt;Is2b()) {</span>
<span class="lineNum">    9176 </span><span class="lineNoCov">          0 :     const char16_t* data = aText-&gt;Get2b();</span>
<span class="lineNum">    9177 </span><span class="lineNoCov">          0 :     for (uint32_t i = 0; i &lt; len; ++i) {</span>
<span class="lineNum">    9178 </span><span class="lineNoCov">          0 :       const char16_t c = data[i];</span>
<span class="lineNum">    9179 </span><span class="lineNoCov">          0 :       switch (c) {</span>
<span class="lineNum">    9180 </span>            :         case '&lt;':
<span class="lineNum">    9181 </span><span class="lineNoCov">          0 :           extraSpaceNeeded += ArrayLength(&quot;&amp;lt;&quot;) - 2;</span>
<span class="lineNum">    9182 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    9183 </span>            :         case '&gt;':
<span class="lineNum">    9184 </span><span class="lineNoCov">          0 :           extraSpaceNeeded += ArrayLength(&quot;&amp;gt;&quot;) - 2;</span>
<span class="lineNum">    9185 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    9186 </span>            :         case '&amp;':
<span class="lineNum">    9187 </span><span class="lineNoCov">          0 :           extraSpaceNeeded += ArrayLength(&quot;&amp;amp;&quot;) - 2;</span>
<span class="lineNum">    9188 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    9189 </span>            :         case 0x00A0:
<span class="lineNum">    9190 </span><span class="lineNoCov">          0 :           extraSpaceNeeded += ArrayLength(&quot;&amp;nbsp;&quot;) - 2;</span>
<span class="lineNum">    9191 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    9192 </span>            :         default:
<span class="lineNum">    9193 </span>            :           break;
<span class="lineNum">    9194 </span>            :       }
<span class="lineNum">    9195 </span>            :     }
<span class="lineNum">    9196 </span>            :   } else {
<span class="lineNum">    9197 </span><span class="lineNoCov">          0 :     const char* data = aText-&gt;Get1b();</span>
<span class="lineNum">    9198 </span><span class="lineNoCov">          0 :     for (uint32_t i = 0; i &lt; len; ++i) {</span>
<span class="lineNum">    9199 </span><span class="lineNoCov">          0 :       const unsigned char c = data[i];</span>
<span class="lineNum">    9200 </span><span class="lineNoCov">          0 :       switch (c) {</span>
<span class="lineNum">    9201 </span>            :         case '&lt;':
<span class="lineNum">    9202 </span><span class="lineNoCov">          0 :           extraSpaceNeeded += ArrayLength(&quot;&amp;lt;&quot;) - 2;</span>
<span class="lineNum">    9203 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    9204 </span>            :         case '&gt;':
<span class="lineNum">    9205 </span><span class="lineNoCov">          0 :           extraSpaceNeeded += ArrayLength(&quot;&amp;gt;&quot;) - 2;</span>
<span class="lineNum">    9206 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    9207 </span>            :         case '&amp;':
<span class="lineNum">    9208 </span><span class="lineNoCov">          0 :           extraSpaceNeeded += ArrayLength(&quot;&amp;amp;&quot;) - 2;</span>
<span class="lineNum">    9209 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    9210 </span>            :         case 0x00A0:
<span class="lineNum">    9211 </span><span class="lineNoCov">          0 :           extraSpaceNeeded += ArrayLength(&quot;&amp;nbsp;&quot;) - 2;</span>
<span class="lineNum">    9212 </span><span class="lineNoCov">          0 :           break;</span>
<span class="lineNum">    9213 </span>            :         default:
<span class="lineNum">    9214 </span>            :           break;
<span class="lineNum">    9215 </span>            :       }
<span class="lineNum">    9216 </span>            :     }
<span class="lineNum">    9217 </span>            :   }
<span class="lineNum">    9218 </span>            : 
<span class="lineNum">    9219 </span><span class="lineNoCov">          0 :   if (extraSpaceNeeded) {</span>
<span class="lineNum">    9220 </span><span class="lineNoCov">          0 :     aBuilder.AppendWithEncode(aText, len + extraSpaceNeeded);</span>
<span class="lineNum">    9221 </span>            :   } else {
<span class="lineNum">    9222 </span><span class="lineNoCov">          0 :     aBuilder.Append(aText);</span>
<span class="lineNum">    9223 </span>            :   }
<span class="lineNum">    9224 </span><span class="lineNoCov">          0 : }</span>
<a name="9225"><span class="lineNum">    9225 </span>            : </a>
<span class="lineNum">    9226 </span>            : static void
<span class="lineNum">    9227 </span><span class="lineNoCov">          0 : AppendEncodedAttributeValue(nsAutoString* aValue, StringBuilder&amp; aBuilder)</span>
<span class="lineNum">    9228 </span>            : {
<span class="lineNum">    9229 </span><span class="lineNoCov">          0 :   const char16_t* c = aValue-&gt;BeginReading();</span>
<span class="lineNum">    9230 </span><span class="lineNoCov">          0 :   const char16_t* end = aValue-&gt;EndReading();</span>
<span class="lineNum">    9231 </span>            : 
<span class="lineNum">    9232 </span><span class="lineNoCov">          0 :   uint32_t extraSpaceNeeded = 0;</span>
<span class="lineNum">    9233 </span><span class="lineNoCov">          0 :   while (c &lt; end) {</span>
<span class="lineNum">    9234 </span><span class="lineNoCov">          0 :     switch (*c) {</span>
<span class="lineNum">    9235 </span>            :       case '&quot;':
<span class="lineNum">    9236 </span><span class="lineNoCov">          0 :         extraSpaceNeeded += ArrayLength(&quot;&amp;quot;&quot;) - 2;</span>
<span class="lineNum">    9237 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    9238 </span>            :       case '&amp;':
<span class="lineNum">    9239 </span><span class="lineNoCov">          0 :         extraSpaceNeeded += ArrayLength(&quot;&amp;amp;&quot;) - 2;</span>
<span class="lineNum">    9240 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    9241 </span>            :       case 0x00A0:
<span class="lineNum">    9242 </span><span class="lineNoCov">          0 :         extraSpaceNeeded += ArrayLength(&quot;&amp;nbsp;&quot;) - 2;</span>
<span class="lineNum">    9243 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    9244 </span>            :       default:
<span class="lineNum">    9245 </span>            :         break;
<span class="lineNum">    9246 </span>            :     }
<span class="lineNum">    9247 </span><span class="lineNoCov">          0 :     ++c;</span>
<span class="lineNum">    9248 </span>            :   }
<span class="lineNum">    9249 </span>            : 
<span class="lineNum">    9250 </span><span class="lineNoCov">          0 :   if (extraSpaceNeeded) {</span>
<span class="lineNum">    9251 </span><span class="lineNoCov">          0 :     aBuilder.AppendWithAttrEncode(aValue, aValue-&gt;Length() + extraSpaceNeeded);</span>
<span class="lineNum">    9252 </span>            :   } else {
<span class="lineNum">    9253 </span><span class="lineNoCov">          0 :     aBuilder.Append(aValue);</span>
<span class="lineNum">    9254 </span>            :   }
<span class="lineNum">    9255 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    9256 </span>            : 
<span class="lineNum">    9257 </span>            : static void
<span class="lineNum">    9258 </span><span class="lineNoCov">          0 : StartElement(Element* aContent, StringBuilder&amp; aBuilder)</span>
<span class="lineNum">    9259 </span>            : {
<span class="lineNum">    9260 </span><span class="lineNoCov">          0 :   nsIAtom* localName = aContent-&gt;NodeInfo()-&gt;NameAtom();</span>
<span class="lineNum">    9261 </span><span class="lineNoCov">          0 :   int32_t tagNS = aContent-&gt;GetNameSpaceID();</span>
<span class="lineNum">    9262 </span>            : 
<span class="lineNum">    9263 </span><span class="lineNoCov">          0 :   aBuilder.Append(&quot;&lt;&quot;);</span>
<span class="lineNum">    9264 </span><span class="lineNoCov">          0 :   if (aContent-&gt;IsHTMLElement() || aContent-&gt;IsSVGElement() ||</span>
<span class="lineNum">    9265 </span><span class="lineNoCov">          0 :       aContent-&gt;IsMathMLElement()) {</span>
<span class="lineNum">    9266 </span><span class="lineNoCov">          0 :     aBuilder.Append(localName);</span>
<span class="lineNum">    9267 </span>            :   } else {
<span class="lineNum">    9268 </span><span class="lineNoCov">          0 :     aBuilder.Append(aContent-&gt;NodeName());</span>
<span class="lineNum">    9269 </span>            :   }
<span class="lineNum">    9270 </span>            : 
<span class="lineNum">    9271 </span><span class="lineNoCov">          0 :   int32_t count = aContent-&gt;GetAttrCount();</span>
<span class="lineNum">    9272 </span><span class="lineNoCov">          0 :   for (int32_t i = 0; i &lt; count; i++) {</span>
<span class="lineNum">    9273 </span><span class="lineNoCov">          0 :     const nsAttrName* name = aContent-&gt;GetAttrNameAt(i);</span>
<span class="lineNum">    9274 </span><span class="lineNoCov">          0 :     int32_t attNs = name-&gt;NamespaceID();</span>
<span class="lineNum">    9275 </span><span class="lineNoCov">          0 :     nsIAtom* attName = name-&gt;LocalName();</span>
<span class="lineNum">    9276 </span>            : 
<span class="lineNum">    9277 </span>            :     // Filter out any attribute starting with [-|_]moz
<span class="lineNum">    9278 </span>            :     nsDependentAtomString attrNameStr(attName);
<span class="lineNum">    9279 </span><span class="lineNoCov">          0 :     if (StringBeginsWith(attrNameStr, NS_LITERAL_STRING(&quot;_moz&quot;)) ||</span>
<span class="lineNum">    9280 </span><span class="lineNoCov">          0 :         StringBeginsWith(attrNameStr, NS_LITERAL_STRING(&quot;-moz&quot;))) {</span>
<span class="lineNum">    9281 </span>            :       continue;
<span class="lineNum">    9282 </span>            :     }
<span class="lineNum">    9283 </span>            : 
<span class="lineNum">    9284 </span><span class="lineNoCov">          0 :     auto* attValue = new nsAutoString();</span>
<span class="lineNum">    9285 </span><span class="lineNoCov">          0 :     aContent-&gt;GetAttr(attNs, attName, *attValue);</span>
<span class="lineNum">    9286 </span>            : 
<span class="lineNum">    9287 </span>            :     // Filter out special case of &lt;br type=&quot;_moz*&quot;&gt; used by the editor.
<span class="lineNum">    9288 </span>            :     // Bug 16988.  Yuck.
<span class="lineNum">    9289 </span><span class="lineNoCov">          0 :     if (localName == nsGkAtoms::br &amp;&amp; tagNS == kNameSpaceID_XHTML &amp;&amp;</span>
<span class="lineNum">    9290 </span><span class="lineNoCov">          0 :         attName == nsGkAtoms::type &amp;&amp; attNs == kNameSpaceID_None &amp;&amp;</span>
<span class="lineNum">    9291 </span><span class="lineNoCov">          0 :         StringBeginsWith(*attValue, NS_LITERAL_STRING(&quot;_moz&quot;))) {</span>
<span class="lineNum">    9292 </span><span class="lineNoCov">          0 :       delete attValue;</span>
<span class="lineNum">    9293 </span>            :       continue;
<span class="lineNum">    9294 </span>            :     }
<span class="lineNum">    9295 </span>            : 
<span class="lineNum">    9296 </span><span class="lineNoCov">          0 :     aBuilder.Append(&quot; &quot;);</span>
<span class="lineNum">    9297 </span>            : 
<span class="lineNum">    9298 </span><span class="lineNoCov">          0 :     if (MOZ_LIKELY(attNs == kNameSpaceID_None) ||</span>
<span class="lineNum">    9299 </span><span class="lineNoCov">          0 :         (attNs == kNameSpaceID_XMLNS &amp;&amp;</span>
<span class="lineNum">    9300 </span><span class="lineNoCov">          0 :          attName == nsGkAtoms::xmlns)) {</span>
<span class="lineNum">    9301 </span>            :       // Nothing else required
<span class="lineNum">    9302 </span><span class="lineNoCov">          0 :     } else if (attNs == kNameSpaceID_XML) {</span>
<span class="lineNum">    9303 </span><span class="lineNoCov">          0 :       aBuilder.Append(&quot;xml:&quot;);</span>
<span class="lineNum">    9304 </span><span class="lineNoCov">          0 :     } else if (attNs == kNameSpaceID_XMLNS) {</span>
<span class="lineNum">    9305 </span><span class="lineNoCov">          0 :       aBuilder.Append(&quot;xmlns:&quot;);</span>
<span class="lineNum">    9306 </span><span class="lineNoCov">          0 :     } else if (attNs == kNameSpaceID_XLink) {</span>
<span class="lineNum">    9307 </span><span class="lineNoCov">          0 :       aBuilder.Append(&quot;xlink:&quot;);</span>
<span class="lineNum">    9308 </span>            :     } else {
<span class="lineNum">    9309 </span><span class="lineNoCov">          0 :       nsIAtom* prefix = name-&gt;GetPrefix();</span>
<span class="lineNum">    9310 </span><span class="lineNoCov">          0 :       if (prefix) {</span>
<span class="lineNum">    9311 </span><span class="lineNoCov">          0 :         aBuilder.Append(prefix);</span>
<span class="lineNum">    9312 </span><span class="lineNoCov">          0 :         aBuilder.Append(&quot;:&quot;);</span>
<span class="lineNum">    9313 </span>            :       }
<span class="lineNum">    9314 </span>            :     }
<span class="lineNum">    9315 </span>            : 
<span class="lineNum">    9316 </span><span class="lineNoCov">          0 :     aBuilder.Append(attName);</span>
<span class="lineNum">    9317 </span><span class="lineNoCov">          0 :     aBuilder.Append(R&quot;(=&quot;)&quot;);</span>
<span class="lineNum">    9318 </span><span class="lineNoCov">          0 :     AppendEncodedAttributeValue(attValue, aBuilder);</span>
<span class="lineNum">    9319 </span><span class="lineNoCov">          0 :     aBuilder.Append(R&quot;(&quot;)&quot;);</span>
<span class="lineNum">    9320 </span>            :   }
<span class="lineNum">    9321 </span>            : 
<span class="lineNum">    9322 </span><span class="lineNoCov">          0 :   aBuilder.Append(&quot;&gt;&quot;);</span>
<span class="lineNum">    9323 </span>            : 
<span class="lineNum">    9324 </span>            :   /*
<span class="lineNum">    9325 </span>            :   // Per HTML spec we should append one \n if the first child of
<span class="lineNum">    9326 </span>            :   // pre/textarea/listing is a textnode and starts with a \n.
<span class="lineNum">    9327 </span>            :   // But because browsers haven't traditionally had that behavior,
<span class="lineNum">    9328 </span>            :   // we're not changing our behavior either - yet.
<span class="lineNum">    9329 </span>            :   if (aContent-&gt;IsHTMLElement()) {
<span class="lineNum">    9330 </span>            :     if (localName == nsGkAtoms::pre || localName == nsGkAtoms::textarea ||
<span class="lineNum">    9331 </span>            :         localName == nsGkAtoms::listing) {
<span class="lineNum">    9332 </span>            :       nsIContent* fc = aContent-&gt;GetFirstChild();
<span class="lineNum">    9333 </span>            :       if (fc &amp;&amp;
<span class="lineNum">    9334 </span>            :           (fc-&gt;NodeType() == nsIDOMNode::TEXT_NODE ||
<span class="lineNum">    9335 </span>            :            fc-&gt;NodeType() == nsIDOMNode::CDATA_SECTION_NODE)) {
<span class="lineNum">    9336 </span>            :         const nsTextFragment* text = fc-&gt;GetText();
<span class="lineNum">    9337 </span>            :         if (text &amp;&amp; text-&gt;GetLength() &amp;&amp; text-&gt;CharAt(0) == char16_t('\n')) {
<span class="lineNum">    9338 </span>            :           aBuilder.Append(&quot;\n&quot;);
<span class="lineNum">    9339 </span>            :         }
<span class="lineNum">    9340 </span>            :       }
<span class="lineNum">    9341 </span>            :     }
<span class="lineNum">    9342 </span>            :   }*/
<span class="lineNum">    9343 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    9344 </span>            : 
<span class="lineNum">    9345 </span>            : static inline bool
<span class="lineNum">    9346 </span><span class="lineNoCov">          0 : ShouldEscape(nsIContent* aParent)</span>
<span class="lineNum">    9347 </span>            : {
<span class="lineNum">    9348 </span><span class="lineNoCov">          0 :   if (!aParent || !aParent-&gt;IsHTMLElement()) {</span>
<span class="lineNum">    9349 </span>            :     return true;
<span class="lineNum">    9350 </span>            :   }
<span class="lineNum">    9351 </span>            : 
<span class="lineNum">    9352 </span>            :   static const nsIAtom* nonEscapingElements[] = {
<span class="lineNum">    9353 </span>            :     nsGkAtoms::style, nsGkAtoms::script, nsGkAtoms::xmp,
<span class="lineNum">    9354 </span>            :     nsGkAtoms::iframe, nsGkAtoms::noembed, nsGkAtoms::noframes,
<span class="lineNum">    9355 </span>            :     nsGkAtoms::plaintext,
<span class="lineNum">    9356 </span>            :     // Per the current spec noscript should be escaped in case
<span class="lineNum">    9357 </span>            :     // scripts are disabled or if document doesn't have
<span class="lineNum">    9358 </span>            :     // browsing context. However the latter seems to be a spec bug
<span class="lineNum">    9359 </span>            :     // and Gecko hasn't traditionally done the former.
<span class="lineNum">    9360 </span>            :     nsGkAtoms::noscript
<span class="lineNum">    9361 </span><span class="lineNoCov">          0 :   };</span>
<span class="lineNum">    9362 </span><span class="lineNoCov">          0 :   static mozilla::BloomFilter&lt;12, nsIAtom&gt; sFilter;</span>
<span class="lineNum">    9363 </span>            :   static bool sInitialized = false;
<span class="lineNum">    9364 </span><span class="lineNoCov">          0 :   if (!sInitialized) {</span>
<span class="lineNum">    9365 </span><span class="lineNoCov">          0 :     sInitialized = true;</span>
<span class="lineNum">    9366 </span><span class="lineNoCov">          0 :     for (auto&amp; nonEscapingElement : nonEscapingElements) {</span>
<span class="lineNum">    9367 </span><span class="lineNoCov">          0 :       sFilter.add(nonEscapingElement);</span>
<span class="lineNum">    9368 </span>            :     }
<span class="lineNum">    9369 </span>            :   }
<span class="lineNum">    9370 </span>            : 
<span class="lineNum">    9371 </span><span class="lineNoCov">          0 :   nsIAtom* tag = aParent-&gt;NodeInfo()-&gt;NameAtom();</span>
<span class="lineNum">    9372 </span><span class="lineNoCov">          0 :   if (sFilter.mightContain(tag)) {</span>
<span class="lineNum">    9373 </span><span class="lineNoCov">          0 :     for (auto&amp; nonEscapingElement : nonEscapingElements) {</span>
<span class="lineNum">    9374 </span><span class="lineNoCov">          0 :       if (tag == nonEscapingElement) {</span>
<span class="lineNum">    9375 </span>            :         return false;
<span class="lineNum">    9376 </span>            :       }
<span class="lineNum">    9377 </span>            :     }
<span class="lineNum">    9378 </span>            :   }
<span class="lineNum">    9379 </span>            :   return true;
<span class="lineNum">    9380 </span>            : }
<span class="lineNum">    9381 </span>            : 
<span class="lineNum">    9382 </span>            : static inline bool
<span class="lineNum">    9383 </span><span class="lineNoCov">          0 : IsVoidTag(Element* aElement)</span>
<span class="lineNum">    9384 </span>            : {
<span class="lineNum">    9385 </span><span class="lineNoCov">          0 :   if (!aElement-&gt;IsHTMLElement()) {</span>
<span class="lineNum">    9386 </span>            :     return false;
<span class="lineNum">    9387 </span>            :   }
<span class="lineNum">    9388 </span><span class="lineNoCov">          0 :   return FragmentOrElement::IsHTMLVoid(aElement-&gt;NodeInfo()-&gt;NameAtom());</span>
<span class="lineNum">    9389 </span>            : }
<span class="lineNum">    9390 </span>            : 
<span class="lineNum">    9391 </span>            : bool
<span class="lineNum">    9392 </span><span class="lineNoCov">          0 : nsContentUtils::SerializeNodeToMarkup(nsINode* aRoot,</span>
<span class="lineNum">    9393 </span>            :                                       bool aDescendentsOnly,
<span class="lineNum">    9394 </span>            :                                       nsAString&amp; aOut)
<span class="lineNum">    9395 </span>            : {
<span class="lineNum">    9396 </span>            :   // If you pass in a DOCUMENT_NODE, you must pass aDescendentsOnly as true
<span class="lineNum">    9397 </span>            :   MOZ_ASSERT(aDescendentsOnly ||
<span class="lineNum">    9398 </span>            :              aRoot-&gt;NodeType() != nsIDOMNode::DOCUMENT_NODE);
<span class="lineNum">    9399 </span>            : 
<span class="lineNum">    9400 </span>            :   nsINode* current = aDescendentsOnly ?
<span class="lineNum">    9401 </span><span class="lineNoCov">          0 :     nsNodeUtils::GetFirstChildOfTemplateOrNode(aRoot) : aRoot;</span>
<span class="lineNum">    9402 </span>            : 
<span class="lineNum">    9403 </span><span class="lineNoCov">          0 :   if (!current) {</span>
<span class="lineNum">    9404 </span>            :     return true;
<span class="lineNum">    9405 </span>            :   }
<span class="lineNum">    9406 </span>            : 
<span class="lineNum">    9407 </span><span class="lineNoCov">          0 :   StringBuilder builder;</span>
<span class="lineNum">    9408 </span>            :   nsIContent* next;
<span class="lineNum">    9409 </span>            :   while (true) {
<span class="lineNum">    9410 </span><span class="lineNoCov">          0 :     bool isVoid = false;</span>
<span class="lineNum">    9411 </span><span class="lineNoCov">          0 :     switch (current-&gt;NodeType()) {</span>
<span class="lineNum">    9412 </span>            :       case nsIDOMNode::ELEMENT_NODE: {
<span class="lineNum">    9413 </span><span class="lineNoCov">          0 :         Element* elem = current-&gt;AsElement();</span>
<span class="lineNum">    9414 </span><span class="lineNoCov">          0 :         StartElement(elem, builder);</span>
<span class="lineNum">    9415 </span><span class="lineNoCov">          0 :         isVoid = IsVoidTag(elem);</span>
<span class="lineNum">    9416 </span><span class="lineNoCov">          0 :         if (!isVoid &amp;&amp;</span>
<span class="lineNum">    9417 </span>            :             (next = nsNodeUtils::GetFirstChildOfTemplateOrNode(current))) {
<span class="lineNum">    9418 </span>            :           current = next;
<span class="lineNum">    9419 </span>            :           continue;
<span class="lineNum">    9420 </span>            :         }
<span class="lineNum">    9421 </span>            :         break;
<span class="lineNum">    9422 </span>            :       }
<span class="lineNum">    9423 </span>            : 
<span class="lineNum">    9424 </span>            :       case nsIDOMNode::TEXT_NODE:
<span class="lineNum">    9425 </span>            :       case nsIDOMNode::CDATA_SECTION_NODE: {
<span class="lineNum">    9426 </span><span class="lineNoCov">          0 :         const nsTextFragment* text = static_cast&lt;nsIContent*&gt;(current)-&gt;GetText();</span>
<span class="lineNum">    9427 </span><span class="lineNoCov">          0 :         nsIContent* parent = current-&gt;GetParent();</span>
<span class="lineNum">    9428 </span><span class="lineNoCov">          0 :         if (ShouldEscape(parent)) {</span>
<span class="lineNum">    9429 </span><span class="lineNoCov">          0 :           AppendEncodedCharacters(text, builder);</span>
<span class="lineNum">    9430 </span>            :         } else {
<span class="lineNum">    9431 </span><span class="lineNoCov">          0 :           builder.Append(text);</span>
<span class="lineNum">    9432 </span>            :         }
<span class="lineNum">    9433 </span>            :         break;
<span class="lineNum">    9434 </span>            :       }
<span class="lineNum">    9435 </span>            : 
<span class="lineNum">    9436 </span>            :       case nsIDOMNode::COMMENT_NODE: {
<span class="lineNum">    9437 </span><span class="lineNoCov">          0 :         builder.Append(&quot;&lt;!--&quot;);</span>
<span class="lineNum">    9438 </span><span class="lineNoCov">          0 :         builder.Append(static_cast&lt;nsIContent*&gt;(current)-&gt;GetText());</span>
<span class="lineNum">    9439 </span><span class="lineNoCov">          0 :         builder.Append(&quot;--&gt;&quot;);</span>
<span class="lineNum">    9440 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    9441 </span>            :       }
<span class="lineNum">    9442 </span>            : 
<span class="lineNum">    9443 </span>            :       case nsIDOMNode::DOCUMENT_TYPE_NODE: {
<span class="lineNum">    9444 </span><span class="lineNoCov">          0 :         builder.Append(&quot;&lt;!DOCTYPE &quot;);</span>
<span class="lineNum">    9445 </span><span class="lineNoCov">          0 :         builder.Append(current-&gt;NodeName());</span>
<span class="lineNum">    9446 </span><span class="lineNoCov">          0 :         builder.Append(&quot;&gt;&quot;);</span>
<span class="lineNum">    9447 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    9448 </span>            :       }
<span class="lineNum">    9449 </span>            : 
<span class="lineNum">    9450 </span>            :       case nsIDOMNode::PROCESSING_INSTRUCTION_NODE: {
<span class="lineNum">    9451 </span><span class="lineNoCov">          0 :         builder.Append(&quot;&lt;?&quot;);</span>
<span class="lineNum">    9452 </span><span class="lineNoCov">          0 :         builder.Append(current-&gt;NodeName());</span>
<span class="lineNum">    9453 </span><span class="lineNoCov">          0 :         builder.Append(&quot; &quot;);</span>
<span class="lineNum">    9454 </span><span class="lineNoCov">          0 :         builder.Append(static_cast&lt;nsIContent*&gt;(current)-&gt;GetText());</span>
<span class="lineNum">    9455 </span><span class="lineNoCov">          0 :         builder.Append(&quot;&gt;&quot;);</span>
<span class="lineNum">    9456 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    9457 </span>            :       }
<span class="lineNum">    9458 </span>            :     }
<span class="lineNum">    9459 </span>            : 
<span class="lineNum">    9460 </span>            :     while (true) {
<span class="lineNum">    9461 </span><span class="lineNoCov">          0 :       if (!isVoid &amp;&amp; current-&gt;NodeType() == nsIDOMNode::ELEMENT_NODE) {</span>
<span class="lineNum">    9462 </span><span class="lineNoCov">          0 :         builder.Append(&quot;&lt;/&quot;);</span>
<span class="lineNum">    9463 </span><span class="lineNoCov">          0 :         nsIContent* elem = static_cast&lt;nsIContent*&gt;(current);</span>
<span class="lineNum">    9464 </span><span class="lineNoCov">          0 :         if (elem-&gt;IsHTMLElement() || elem-&gt;IsSVGElement() ||</span>
<span class="lineNum">    9465 </span>            :             elem-&gt;IsMathMLElement()) {
<span class="lineNum">    9466 </span><span class="lineNoCov">          0 :           builder.Append(elem-&gt;NodeInfo()-&gt;NameAtom());</span>
<span class="lineNum">    9467 </span>            :         } else {
<span class="lineNum">    9468 </span><span class="lineNoCov">          0 :           builder.Append(current-&gt;NodeName());</span>
<span class="lineNum">    9469 </span>            :         }
<span class="lineNum">    9470 </span><span class="lineNoCov">          0 :         builder.Append(&quot;&gt;&quot;);</span>
<span class="lineNum">    9471 </span>            :       }
<span class="lineNum">    9472 </span><span class="lineNoCov">          0 :       isVoid = false;</span>
<span class="lineNum">    9473 </span>            : 
<span class="lineNum">    9474 </span><span class="lineNoCov">          0 :       if (current == aRoot) {</span>
<span class="lineNum">    9475 </span><span class="lineNoCov">          0 :         return builder.ToString(aOut);</span>
<span class="lineNum">    9476 </span>            :       }
<span class="lineNum">    9477 </span>            : 
<span class="lineNum">    9478 </span><span class="lineNoCov">          0 :       if ((next = current-&gt;GetNextSibling())) {</span>
<span class="lineNum">    9479 </span><span class="lineNoCov">          0 :         current = next;</span>
<span class="lineNum">    9480 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">    9481 </span>            :       }
<span class="lineNum">    9482 </span>            : 
<span class="lineNum">    9483 </span><span class="lineNoCov">          0 :       current = current-&gt;GetParentNode();</span>
<span class="lineNum">    9484 </span>            : 
<span class="lineNum">    9485 </span>            :       // Handle template element. If the parent is a template's content,
<span class="lineNum">    9486 </span>            :       // then adjust the parent to be the template element.
<span class="lineNum">    9487 </span><span class="lineNoCov">          0 :       if (current != aRoot &amp;&amp;</span>
<span class="lineNum">    9488 </span>            :           current-&gt;NodeType() == nsIDOMNode::DOCUMENT_FRAGMENT_NODE) {
<span class="lineNum">    9489 </span><span class="lineNoCov">          0 :         DocumentFragment* frag = static_cast&lt;DocumentFragment*&gt;(current);</span>
<span class="lineNum">    9490 </span><span class="lineNoCov">          0 :         nsIContent* fragHost = frag-&gt;GetHost();</span>
<span class="lineNum">    9491 </span><span class="lineNoCov">          0 :         if (fragHost &amp;&amp; nsNodeUtils::IsTemplateElement(fragHost)) {</span>
<span class="lineNum">    9492 </span><span class="lineNoCov">          0 :           current = fragHost;</span>
<span class="lineNum">    9493 </span>            :         }
<span class="lineNum">    9494 </span>            :       }
<span class="lineNum">    9495 </span>            : 
<span class="lineNum">    9496 </span><span class="lineNoCov">          0 :       if (aDescendentsOnly &amp;&amp; current == aRoot) {</span>
<span class="lineNum">    9497 </span><span class="lineNoCov">          0 :         return builder.ToString(aOut);</span>
<span class="lineNum">    9498 </span>            :       }
<span class="lineNum">    9499 </span>            :     }
<span class="lineNum">    9500 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    9501 </span>            : }
<span class="lineNum">    9502 </span>            : 
<span class="lineNum">    9503 </span>            : bool
<span class="lineNum">    9504 </span><span class="lineNoCov">          0 : nsContentUtils::IsSpecificAboutPage(JSObject* aGlobal, const char* aUri)</span>
<span class="lineNum">    9505 </span>            : {
<span class="lineNum">    9506 </span>            :   // aUri must start with about: or this isn't the right function to be using.
<span class="lineNum">    9507 </span>            :   MOZ_ASSERT(strncmp(aUri, &quot;about:&quot;, 6) == 0);
<span class="lineNum">    9508 </span>            : 
<span class="lineNum">    9509 </span>            :   // Make sure the global is a window
<span class="lineNum">    9510 </span><span class="lineNoCov">          0 :   nsGlobalWindow* win = xpc::WindowGlobalOrNull(aGlobal);</span>
<span class="lineNum">    9511 </span><span class="lineNoCov">          0 :   if (!win) {</span>
<span class="lineNum">    9512 </span>            :     return false;
<span class="lineNum">    9513 </span>            :   }
<span class="lineNum">    9514 </span>            : 
<span class="lineNum">    9515 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIPrincipal&gt; principal = win-&gt;GetPrincipal();</span>
<span class="lineNum">    9516 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(principal, false);</span>
<span class="lineNum">    9517 </span>            :   nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">    9518 </span><span class="lineNoCov">          0 :   principal-&gt;GetURI(getter_AddRefs(uri));</span>
<span class="lineNum">    9519 </span><span class="lineNoCov">          0 :   if (!uri) {</span>
<span class="lineNum">    9520 </span>            :     return false;
<span class="lineNum">    9521 </span>            :   }
<span class="lineNum">    9522 </span>            : 
<span class="lineNum">    9523 </span>            :   // First check the scheme to avoid getting long specs in the common case.
<span class="lineNum">    9524 </span><span class="lineNoCov">          0 :   bool isAbout = false;</span>
<span class="lineNum">    9525 </span><span class="lineNoCov">          0 :   uri-&gt;SchemeIs(&quot;about&quot;, &amp;isAbout);</span>
<span class="lineNum">    9526 </span><span class="lineNoCov">          0 :   if (!isAbout) {</span>
<span class="lineNum">    9527 </span>            :     return false;
<span class="lineNum">    9528 </span>            :   }
<span class="lineNum">    9529 </span>            : 
<span class="lineNum">    9530 </span>            :   // Now check the spec itself
<span class="lineNum">    9531 </span><span class="lineNoCov">          0 :   nsAutoCString spec;</span>
<span class="lineNum">    9532 </span><span class="lineNoCov">          0 :   uri-&gt;GetSpecIgnoringRef(spec);</span>
<span class="lineNum">    9533 </span><span class="lineNoCov">          0 :   return spec.EqualsASCII(aUri);</span>
<span class="lineNum">    9534 </span>            : }
<span class="lineNum">    9535 </span>            : 
<span class="lineNum">    9536 </span>            : /* static */ void
<span class="lineNum">    9537 </span><span class="lineNoCov">          0 : nsContentUtils::SetScrollbarsVisibility(nsIDocShell* aDocShell, bool aVisible)</span>
<span class="lineNum">    9538 </span>            : {
<span class="lineNum">    9539 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIScrollable&gt; scroller = do_QueryInterface(aDocShell);</span>
<span class="lineNum">    9540 </span>            : 
<span class="lineNum">    9541 </span><span class="lineNoCov">          0 :   if (scroller) {</span>
<span class="lineNum">    9542 </span>            :     int32_t prefValue;
<span class="lineNum">    9543 </span>            : 
<span class="lineNum">    9544 </span><span class="lineNoCov">          0 :     if (aVisible) {</span>
<span class="lineNum">    9545 </span>            :       prefValue = nsIScrollable::Scrollbar_Auto;
<span class="lineNum">    9546 </span>            :     } else {
<span class="lineNum">    9547 </span><span class="lineNoCov">          0 :       prefValue = nsIScrollable::Scrollbar_Never;</span>
<span class="lineNum">    9548 </span>            :     }
<span class="lineNum">    9549 </span>            : 
<span class="lineNum">    9550 </span>            :     scroller-&gt;SetDefaultScrollbarPreferences(
<span class="lineNum">    9551 </span><span class="lineNoCov">          0 :                 nsIScrollable::ScrollOrientation_Y, prefValue);</span>
<span class="lineNum">    9552 </span>            :     scroller-&gt;SetDefaultScrollbarPreferences(
<span class="lineNum">    9553 </span><span class="lineNoCov">          0 :                 nsIScrollable::ScrollOrientation_X, prefValue);</span>
<span class="lineNum">    9554 </span>            :   }
<span class="lineNum">    9555 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    9556 </span>            : 
<span class="lineNum">    9557 </span>            : /* static */ void
<span class="lineNum">    9558 </span><span class="lineNoCov">          0 : nsContentUtils::GetPresentationURL(nsIDocShell* aDocShell, nsAString&amp; aPresentationUrl)</span>
<span class="lineNum">    9559 </span>            : {
<span class="lineNum">    9560 </span>            :   MOZ_ASSERT(aDocShell);
<span class="lineNum">    9561 </span>            : 
<span class="lineNum">    9562 </span>            :   // Simulate receiver context for web platform test
<span class="lineNum">    9563 </span><span class="lineNoCov">          0 :   if (Preferences::GetBool(&quot;dom.presentation.testing.simulate-receiver&quot;)) {</span>
<span class="lineNum">    9564 </span>            :     nsCOMPtr&lt;nsIDocument&gt; doc;
<span class="lineNum">    9565 </span>            : 
<span class="lineNum">    9566 </span>            :     nsCOMPtr&lt;nsPIDOMWindowOuter&gt; docShellWin =
<span class="lineNum">    9567 </span><span class="lineNoCov">          0 :       do_QueryInterface(aDocShell-&gt;GetScriptGlobalObject());</span>
<span class="lineNum">    9568 </span><span class="lineNoCov">          0 :     if (docShellWin) {</span>
<span class="lineNum">    9569 </span><span class="lineNoCov">          0 :       doc = docShellWin-&gt;GetExtantDoc();</span>
<span class="lineNum">    9570 </span>            :     }
<span class="lineNum">    9571 </span>            : 
<span class="lineNum">    9572 </span><span class="lineNoCov">          0 :     if (NS_WARN_IF(!doc)) {</span>
<span class="lineNum">    9573 </span>            :       return;
<span class="lineNum">    9574 </span>            :     }
<span class="lineNum">    9575 </span>            : 
<span class="lineNum">    9576 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIURI&gt; uri = doc-&gt;GetDocumentURI();</span>
<span class="lineNum">    9577 </span><span class="lineNoCov">          0 :     if (NS_WARN_IF(!uri)) {</span>
<span class="lineNum">    9578 </span>            :       return;
<span class="lineNum">    9579 </span>            :     }
<span class="lineNum">    9580 </span>            : 
<span class="lineNum">    9581 </span><span class="lineNoCov">          0 :     nsAutoCString uriStr;</span>
<span class="lineNum">    9582 </span><span class="lineNoCov">          0 :     uri-&gt;GetSpec(uriStr);</span>
<span class="lineNum">    9583 </span><span class="lineNoCov">          0 :     aPresentationUrl = NS_ConvertUTF8toUTF16(uriStr);</span>
<span class="lineNum">    9584 </span>            :     return;
<span class="lineNum">    9585 </span>            :   }
<span class="lineNum">    9586 </span>            : 
<span class="lineNum">    9587 </span><span class="lineNoCov">          0 :   if (XRE_IsContentProcess()) {</span>
<span class="lineNum">    9588 </span>            :     nsCOMPtr&lt;nsIDocShellTreeItem&gt; sameTypeRoot;
<span class="lineNum">    9589 </span><span class="lineNoCov">          0 :     aDocShell-&gt;GetSameTypeRootTreeItem(getter_AddRefs(sameTypeRoot));</span>
<span class="lineNum">    9590 </span>            :     nsCOMPtr&lt;nsIDocShellTreeItem&gt; root;
<span class="lineNum">    9591 </span><span class="lineNoCov">          0 :     aDocShell-&gt;GetRootTreeItem(getter_AddRefs(root));</span>
<span class="lineNum">    9592 </span><span class="lineNoCov">          0 :     if (sameTypeRoot.get() == root.get()) {</span>
<span class="lineNum">    9593 </span>            :       // presentation URL is stored in TabChild for the top most
<span class="lineNum">    9594 </span>            :       // &lt;iframe mozbrowser&gt; in content process.
<span class="lineNum">    9595 </span><span class="lineNoCov">          0 :       TabChild* tabChild = TabChild::GetFrom(aDocShell);</span>
<span class="lineNum">    9596 </span><span class="lineNoCov">          0 :       if (tabChild) {</span>
<span class="lineNum">    9597 </span><span class="lineNoCov">          0 :         aPresentationUrl = tabChild-&gt;PresentationURL();</span>
<span class="lineNum">    9598 </span>            :       }
<span class="lineNum">    9599 </span>            :       return;
<span class="lineNum">    9600 </span>            :     }
<span class="lineNum">    9601 </span>            :   }
<span class="lineNum">    9602 </span>            : 
<span class="lineNum">    9603 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsILoadContext&gt; loadContext(do_QueryInterface(aDocShell));</span>
<span class="lineNum">    9604 </span>            :   nsCOMPtr&lt;nsIDOMElement&gt; topFrameElement;
<span class="lineNum">    9605 </span><span class="lineNoCov">          0 :   loadContext-&gt;GetTopFrameElement(getter_AddRefs(topFrameElement));</span>
<span class="lineNum">    9606 </span><span class="lineNoCov">          0 :   if (!topFrameElement) {</span>
<span class="lineNum">    9607 </span>            :     return;
<span class="lineNum">    9608 </span>            :   }
<span class="lineNum">    9609 </span>            : 
<span class="lineNum">    9610 </span><span class="lineNoCov">          0 :   topFrameElement-&gt;GetAttribute(NS_LITERAL_STRING(&quot;mozpresentation&quot;), aPresentationUrl);</span>
<span class="lineNum">    9611 </span>            : }
<span class="lineNum">    9612 </span>            : 
<span class="lineNum">    9613 </span>            : /* static */ nsIDocShell*
<span class="lineNum">    9614 </span><span class="lineNoCov">          0 : nsContentUtils::GetDocShellForEventTarget(EventTarget* aTarget)</span>
<span class="lineNum">    9615 </span>            : {
<span class="lineNum">    9616 </span>            :   nsCOMPtr&lt;nsPIDOMWindowInner&gt; innerWindow;
<span class="lineNum">    9617 </span>            : 
<span class="lineNum">    9618 </span><span class="lineNoCov">          0 :   if (nsCOMPtr&lt;nsINode&gt; node = do_QueryInterface(aTarget)) {</span>
<span class="lineNum">    9619 </span>            :     bool ignore;
<span class="lineNum">    9620 </span>            :     innerWindow =
<span class="lineNum">    9621 </span><span class="lineNoCov">          0 :       do_QueryInterface(node-&gt;OwnerDoc()-&gt;GetScriptHandlingObject(ignore));</span>
<span class="lineNum">    9622 </span><span class="lineNoCov">          0 :   } else if ((innerWindow = do_QueryInterface(aTarget))) {</span>
<span class="lineNum">    9623 </span>            :     // Nothing else to do
<span class="lineNum">    9624 </span>            :   } else {
<span class="lineNum">    9625 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;DOMEventTargetHelper&gt; helper = do_QueryInterface(aTarget);</span>
<span class="lineNum">    9626 </span><span class="lineNoCov">          0 :     if (helper) {</span>
<span class="lineNum">    9627 </span><span class="lineNoCov">          0 :       innerWindow = helper-&gt;GetOwner();</span>
<span class="lineNum">    9628 </span>            :     }
<span class="lineNum">    9629 </span>            :   }
<span class="lineNum">    9630 </span>            : 
<span class="lineNum">    9631 </span><span class="lineNoCov">          0 :   if (innerWindow) {</span>
<span class="lineNum">    9632 </span><span class="lineNoCov">          0 :     return innerWindow-&gt;GetDocShell();</span>
<span class="lineNum">    9633 </span>            :   }
<span class="lineNum">    9634 </span>            : 
<span class="lineNum">    9635 </span>            :   return nullptr;
<span class="lineNum">    9636 </span>            : }
<span class="lineNum">    9637 </span>            : 
<span class="lineNum">    9638 </span>            : /*
<span class="lineNum">    9639 </span>            :  * Note: this function only relates to figuring out HTTPS state, which is an
<span class="lineNum">    9640 </span>            :  * input to the Secure Context algorithm.  We are not actually implementing any
<span class="lineNum">    9641 </span>            :  * part of the Secure Context algorithm itself here.
<span class="lineNum">    9642 </span>            :  *
<span class="lineNum">    9643 </span>            :  * This is a bit of a hack.  Ideally we'd propagate HTTPS state through
<span class="lineNum">    9644 </span>            :  * nsIChannel as described in the Fetch and HTML specs, but making channels
<span class="lineNum">    9645 </span>            :  * know about whether they should inherit HTTPS state, propagating information
<span class="lineNum">    9646 </span>            :  * about who the channel's &quot;client&quot; is, exposing GetHttpsState API on channels
<span class="lineNum">    9647 </span>            :  * and modifying the various cache implementations to store and retrieve HTTPS
<span class="lineNum">    9648 </span>            :  * state involves a huge amount of code (see bug 1220687).  We avoid that for
<span class="lineNum">    9649 </span>            :  * now using this function.
<span class="lineNum">    9650 </span>            :  *
<span class="lineNum">    9651 </span>            :  * This function takes advantage of the observation that we can return true if
<span class="lineNum">    9652 </span>            :  * nsIContentSecurityManager::IsOriginPotentiallyTrustworthy returns true for
<span class="lineNum">    9653 </span>            :  * the document's origin (e.g. the origin has a scheme of 'https' or host
<span class="lineNum">    9654 </span>            :  * 'localhost' etc.).  Since we generally propagate a creator document's origin
<span class="lineNum">    9655 </span>            :  * onto data:, blob:, etc. documents, this works for them too.
<span class="lineNum">    9656 </span>            :  *
<span class="lineNum">    9657 </span>            :  * The scenario where this observation breaks down is sandboxing without the
<span class="lineNum">    9658 </span>            :  * 'allow-same-origin' flag, since in this case a document is given a unique
<span class="lineNum">    9659 </span>            :  * origin (IsOriginPotentiallyTrustworthy would return false).  We handle that
<span class="lineNum">    9660 </span>            :  * by using the origin that the document would have had had it not been
<span class="lineNum">    9661 </span>            :  * sandboxed.
<span class="lineNum">    9662 </span>            :  *
<span class="lineNum">    9663 </span>            :  * DEFICIENCIES: Note that this function uses nsIScriptSecurityManager's
<span class="lineNum">    9664 </span>            :  * getChannelResultPrincipalIfNotSandboxed, and that method's ignoring of
<span class="lineNum">    9665 </span>            :  * sandboxing is limited to the immediate sandbox.  In the case that aDocument
<span class="lineNum">    9666 </span>            :  * should inherit its origin (e.g. data: URI) but its parent has ended up
<span class="lineNum">    9667 </span>            :  * with a unique origin due to sandboxing further up the parent chain we may
<span class="lineNum">    9668 </span>            :  * end up returning false when we would ideally return true (since we will
<span class="lineNum">    9669 </span>            :  * examine the parent's origin for 'https' and not finding it.)  This means
<span class="lineNum">    9670 </span>            :  * that we may restrict the privileges of some pages unnecessarily in this
<span class="lineNum">    9671 </span>            :  * edge case.
<span class="lineNum">    9672 </span>            :  */
<span class="lineNum">    9673 </span>            : /* static */ bool
<span class="lineNum">    9674 </span><span class="lineNoCov">          0 : nsContentUtils::HttpsStateIsModern(nsIDocument* aDocument)</span>
<span class="lineNum">    9675 </span>            : {
<span class="lineNum">    9676 </span><span class="lineNoCov">          0 :   if (!aDocument) {</span>
<span class="lineNum">    9677 </span>            :     return false;
<span class="lineNum">    9678 </span>            :   }
<span class="lineNum">    9679 </span>            : 
<span class="lineNum">    9680 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIPrincipal&gt; principal = aDocument-&gt;NodePrincipal();</span>
<span class="lineNum">    9681 </span>            : 
<span class="lineNum">    9682 </span><span class="lineNoCov">          0 :   if (principal-&gt;GetIsSystemPrincipal()) {</span>
<span class="lineNum">    9683 </span>            :     return true;
<span class="lineNum">    9684 </span>            :   }
<span class="lineNum">    9685 </span>            : 
<span class="lineNum">    9686 </span>            :   // If aDocument is sandboxed, try and get the principal that it would have
<span class="lineNum">    9687 </span>            :   // been given had it not been sandboxed:
<span class="lineNum">    9688 </span><span class="lineNoCov">          0 :   if (principal-&gt;GetIsNullPrincipal() &amp;&amp;</span>
<span class="lineNum">    9689 </span><span class="lineNoCov">          0 :       (aDocument-&gt;GetSandboxFlags() &amp; SANDBOXED_ORIGIN)) {</span>
<span class="lineNum">    9690 </span><span class="lineNoCov">          0 :     nsIChannel* channel = aDocument-&gt;GetChannel();</span>
<span class="lineNum">    9691 </span><span class="lineNoCov">          0 :     if (channel) {</span>
<span class="lineNum">    9692 </span>            :       nsCOMPtr&lt;nsIScriptSecurityManager&gt; ssm =
<span class="lineNum">    9693 </span><span class="lineNoCov">          0 :         nsContentUtils::GetSecurityManager();</span>
<span class="lineNum">    9694 </span>            :       nsresult rv =
<span class="lineNum">    9695 </span>            :         ssm-&gt;GetChannelResultPrincipalIfNotSandboxed(channel,
<span class="lineNum">    9696 </span><span class="lineNoCov">          0 :                                                      getter_AddRefs(principal));</span>
<span class="lineNum">    9697 </span><span class="lineNoCov">          0 :       if (NS_FAILED(rv)) {</span>
<span class="lineNum">    9698 </span>            :         return false;
<span class="lineNum">    9699 </span>            :       }
<span class="lineNum">    9700 </span><span class="lineNoCov">          0 :       if (principal-&gt;GetIsSystemPrincipal()) {</span>
<span class="lineNum">    9701 </span>            :         // If a document with the system principal is sandboxing a subdocument
<span class="lineNum">    9702 </span>            :         // that would normally inherit the embedding element's principal (e.g.
<span class="lineNum">    9703 </span>            :         // a srcdoc document) then the embedding document does not trust the
<span class="lineNum">    9704 </span>            :         // content that is written to the embedded document.  Unlike when the
<span class="lineNum">    9705 </span>            :         // embedding document is https, in this case we have no indication as
<span class="lineNum">    9706 </span>            :         // to whether the embedded document's contents are delivered securely
<span class="lineNum">    9707 </span>            :         // or not, and the sandboxing would possibly indicate that they were
<span class="lineNum">    9708 </span>            :         // not.  To play it safe we return false here.  (See bug 1162772
<span class="lineNum">    9709 </span>            :         // comment 73-80.)
<span class="lineNum">    9710 </span>            :         return false;
<span class="lineNum">    9711 </span>            :       }
<span class="lineNum">    9712 </span>            :     }
<span class="lineNum">    9713 </span>            :   }
<span class="lineNum">    9714 </span>            : 
<span class="lineNum">    9715 </span><span class="lineNoCov">          0 :   if (principal-&gt;GetIsNullPrincipal()) {</span>
<span class="lineNum">    9716 </span>            :     return false;
<span class="lineNum">    9717 </span>            :   }
<span class="lineNum">    9718 </span>            : 
<span class="lineNum">    9719 </span>            :   MOZ_ASSERT(principal-&gt;GetIsCodebasePrincipal());
<span class="lineNum">    9720 </span>            : 
<span class="lineNum">    9721 </span>            :   nsCOMPtr&lt;nsIContentSecurityManager&gt; csm =
<span class="lineNum">    9722 </span><span class="lineNoCov">          0 :     do_GetService(NS_CONTENTSECURITYMANAGER_CONTRACTID);</span>
<span class="lineNum">    9723 </span>            :   NS_WARNING_ASSERTION(csm, &quot;csm is null&quot;);
<span class="lineNum">    9724 </span><span class="lineNoCov">          0 :   if (csm) {</span>
<span class="lineNum">    9725 </span><span class="lineNoCov">          0 :     bool isTrustworthyOrigin = false;</span>
<span class="lineNum">    9726 </span><span class="lineNoCov">          0 :     csm-&gt;IsOriginPotentiallyTrustworthy(principal, &amp;isTrustworthyOrigin);</span>
<span class="lineNum">    9727 </span><span class="lineNoCov">          0 :     if (isTrustworthyOrigin) {</span>
<span class="lineNum">    9728 </span><span class="lineNoCov">          0 :       return true;</span>
<span class="lineNum">    9729 </span>            :     }
<span class="lineNum">    9730 </span>            :   }
<span class="lineNum">    9731 </span>            : 
<span class="lineNum">    9732 </span>            :   return false;
<span class="lineNum">    9733 </span>            : }
<span class="lineNum">    9734 </span>            : 
<span class="lineNum">    9735 </span>            : /* static */ CustomElementDefinition*
<span class="lineNum">    9736 </span><span class="lineNoCov">          0 : nsContentUtils::LookupCustomElementDefinition(nsIDocument* aDoc,</span>
<span class="lineNum">    9737 </span>            :                                               const nsAString&amp; aLocalName,
<span class="lineNum">    9738 </span>            :                                               uint32_t aNameSpaceID,
<span class="lineNum">    9739 </span>            :                                               const nsAString* aIs)
<span class="lineNum">    9740 </span>            : {
<span class="lineNum">    9741 </span>            :   MOZ_ASSERT(aDoc);
<span class="lineNum">    9742 </span>            : 
<span class="lineNum">    9743 </span>            :   // To support imported document.
<span class="lineNum">    9744 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocument&gt; doc = aDoc-&gt;MasterDocument();</span>
<span class="lineNum">    9745 </span>            : 
<span class="lineNum">    9746 </span><span class="lineNoCov">          0 :   if (aNameSpaceID != kNameSpaceID_XHTML ||</span>
<span class="lineNum">    9747 </span><span class="lineNoCov">          0 :       !doc-&gt;GetDocShell()) {</span>
<span class="lineNum">    9748 </span>            :     return nullptr;
<span class="lineNum">    9749 </span>            :   }
<span class="lineNum">    9750 </span>            : 
<span class="lineNum">    9751 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsPIDOMWindowInner&gt; window(doc-&gt;GetInnerWindow());</span>
<span class="lineNum">    9752 </span><span class="lineNoCov">          0 :   if (!window) {</span>
<span class="lineNum">    9753 </span>            :     return nullptr;
<span class="lineNum">    9754 </span>            :   }
<span class="lineNum">    9755 </span>            : 
<span class="lineNum">    9756 </span><span class="lineNoCov">          0 :   RefPtr&lt;CustomElementRegistry&gt; registry(window-&gt;CustomElements());</span>
<span class="lineNum">    9757 </span><span class="lineNoCov">          0 :   if (!registry) {</span>
<span class="lineNum">    9758 </span>            :     return nullptr;
<span class="lineNum">    9759 </span>            :   }
<span class="lineNum">    9760 </span>            : 
<span class="lineNum">    9761 </span><span class="lineNoCov">          0 :   return registry-&gt;LookupCustomElementDefinition(aLocalName, aIs);</span>
<span class="lineNum">    9762 </span>            : }
<span class="lineNum">    9763 </span>            : 
<span class="lineNum">    9764 </span>            : /* static */ void
<span class="lineNum">    9765 </span><span class="lineNoCov">          0 : nsContentUtils::SetupCustomElement(Element* aElement,</span>
<span class="lineNum">    9766 </span>            :                                    const nsAString* aTypeExtension)
<span class="lineNum">    9767 </span>            : {
<span class="lineNum">    9768 </span>            :   MOZ_ASSERT(aElement);
<span class="lineNum">    9769 </span>            : 
<span class="lineNum">    9770 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocument&gt; doc = aElement-&gt;OwnerDoc();</span>
<span class="lineNum">    9771 </span>            : 
<span class="lineNum">    9772 </span><span class="lineNoCov">          0 :   if (!doc) {</span>
<span class="lineNum">    9773 </span>            :     return;
<span class="lineNum">    9774 </span>            :   }
<span class="lineNum">    9775 </span>            : 
<span class="lineNum">    9776 </span>            :   // To support imported document.
<span class="lineNum">    9777 </span><span class="lineNoCov">          0 :   doc = doc-&gt;MasterDocument();</span>
<span class="lineNum">    9778 </span>            : 
<span class="lineNum">    9779 </span><span class="lineNoCov">          0 :   if (aElement-&gt;GetNameSpaceID() != kNameSpaceID_XHTML ||</span>
<span class="lineNum">    9780 </span><span class="lineNoCov">          0 :       !doc-&gt;GetDocShell()) {</span>
<span class="lineNum">    9781 </span>            :     return;
<span class="lineNum">    9782 </span>            :   }
<span class="lineNum">    9783 </span>            : 
<span class="lineNum">    9784 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsPIDOMWindowInner&gt; window(doc-&gt;GetInnerWindow());</span>
<span class="lineNum">    9785 </span><span class="lineNoCov">          0 :   if (!window) {</span>
<span class="lineNum">    9786 </span>            :     return;
<span class="lineNum">    9787 </span>            :   }
<span class="lineNum">    9788 </span>            : 
<span class="lineNum">    9789 </span><span class="lineNoCov">          0 :   RefPtr&lt;CustomElementRegistry&gt; registry(window-&gt;CustomElements());</span>
<span class="lineNum">    9790 </span><span class="lineNoCov">          0 :   if (!registry) {</span>
<span class="lineNum">    9791 </span>            :     return;
<span class="lineNum">    9792 </span>            :   }
<span class="lineNum">    9793 </span>            : 
<span class="lineNum">    9794 </span><span class="lineNoCov">          0 :   return registry-&gt;SetupCustomElement(aElement, aTypeExtension);</span>
<span class="lineNum">    9795 </span>            : }
<span class="lineNum">    9796 </span>            : 
<span class="lineNum">    9797 </span>            : /* static */ void
<span class="lineNum">    9798 </span><span class="lineNoCov">          0 : nsContentUtils::EnqueueLifecycleCallback(nsIDocument* aDoc,</span>
<span class="lineNum">    9799 </span>            :                                          nsIDocument::ElementCallbackType aType,
<span class="lineNum">    9800 </span>            :                                          Element* aCustomElement,
<span class="lineNum">    9801 </span>            :                                          LifecycleCallbackArgs* aArgs,
<span class="lineNum">    9802 </span>            :                                          CustomElementDefinition* aDefinition)
<span class="lineNum">    9803 </span>            : {
<span class="lineNum">    9804 </span>            :   MOZ_ASSERT(aDoc);
<span class="lineNum">    9805 </span>            : 
<span class="lineNum">    9806 </span>            :   // To support imported document.
<span class="lineNum">    9807 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocument&gt; doc = aDoc-&gt;MasterDocument();</span>
<span class="lineNum">    9808 </span>            : 
<span class="lineNum">    9809 </span><span class="lineNoCov">          0 :   if (!doc-&gt;GetDocShell()) {</span>
<span class="lineNum">    9810 </span>            :     return;
<span class="lineNum">    9811 </span>            :   }
<span class="lineNum">    9812 </span>            : 
<span class="lineNum">    9813 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsPIDOMWindowInner&gt; window(doc-&gt;GetInnerWindow());</span>
<span class="lineNum">    9814 </span><span class="lineNoCov">          0 :   if (!window) {</span>
<span class="lineNum">    9815 </span>            :     return;
<span class="lineNum">    9816 </span>            :   }
<span class="lineNum">    9817 </span>            : 
<span class="lineNum">    9818 </span><span class="lineNoCov">          0 :   RefPtr&lt;CustomElementRegistry&gt; registry(window-&gt;CustomElements());</span>
<span class="lineNum">    9819 </span><span class="lineNoCov">          0 :   if (!registry) {</span>
<span class="lineNum">    9820 </span><span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">    9821 </span>            :   }
<span class="lineNum">    9822 </span>            : 
<span class="lineNum">    9823 </span><span class="lineNoCov">          0 :   registry-&gt;EnqueueLifecycleCallback(aType, aCustomElement, aArgs, aDefinition);</span>
<span class="lineNum">    9824 </span>            : }
<span class="lineNum">    9825 </span>            : 
<span class="lineNum">    9826 </span>            : /* static */ void
<span class="lineNum">    9827 </span><span class="lineNoCov">          0 : nsContentUtils::GetCustomPrototype(nsIDocument* aDoc,</span>
<span class="lineNum">    9828 </span>            :                                    int32_t aNamespaceID,
<span class="lineNum">    9829 </span>            :                                    nsIAtom* aAtom,
<span class="lineNum">    9830 </span>            :                                    JS::MutableHandle&lt;JSObject*&gt; aPrototype)
<span class="lineNum">    9831 </span>            : {
<span class="lineNum">    9832 </span>            :   MOZ_ASSERT(aDoc);
<span class="lineNum">    9833 </span>            : 
<span class="lineNum">    9834 </span>            :   // To support imported document.
<span class="lineNum">    9835 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocument&gt; doc = aDoc-&gt;MasterDocument();</span>
<span class="lineNum">    9836 </span>            : 
<span class="lineNum">    9837 </span><span class="lineNoCov">          0 :   if (aNamespaceID != kNameSpaceID_XHTML ||</span>
<span class="lineNum">    9838 </span><span class="lineNoCov">          0 :       !doc-&gt;GetDocShell()) {</span>
<span class="lineNum">    9839 </span>            :     return;
<span class="lineNum">    9840 </span>            :   }
<span class="lineNum">    9841 </span>            : 
<span class="lineNum">    9842 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsPIDOMWindowInner&gt; window(doc-&gt;GetInnerWindow());</span>
<span class="lineNum">    9843 </span><span class="lineNoCov">          0 :   if (!window) {</span>
<span class="lineNum">    9844 </span>            :     return;
<span class="lineNum">    9845 </span>            :   }
<span class="lineNum">    9846 </span>            : 
<span class="lineNum">    9847 </span><span class="lineNoCov">          0 :   RefPtr&lt;CustomElementRegistry&gt; registry(window-&gt;CustomElements());</span>
<span class="lineNum">    9848 </span><span class="lineNoCov">          0 :   if (!registry) {</span>
<span class="lineNum">    9849 </span>            :     return;
<span class="lineNum">    9850 </span>            :   }
<span class="lineNum">    9851 </span>            : 
<span class="lineNum">    9852 </span><span class="lineNoCov">          0 :   return registry-&gt;GetCustomPrototype(aAtom, aPrototype);</span>
<span class="lineNum">    9853 </span>            : }
<span class="lineNum">    9854 </span>            : 
<span class="lineNum">    9855 </span>            : /* static */ bool
<span class="lineNum">    9856 </span><span class="lineNoCov">          0 : nsContentUtils::AttemptLargeAllocationLoad(nsIHttpChannel* aChannel)</span>
<span class="lineNum">    9857 </span>            : {
<span class="lineNum">    9858 </span>            :   MOZ_ASSERT(aChannel);
<span class="lineNum">    9859 </span>            : 
<span class="lineNum">    9860 </span>            :   nsCOMPtr&lt;nsILoadGroup&gt; loadGroup;
<span class="lineNum">    9861 </span><span class="lineNoCov">          0 :   nsresult rv = aChannel-&gt;GetLoadGroup(getter_AddRefs(loadGroup));</span>
<span class="lineNum">    9862 </span><span class="lineNoCov">          0 :   if (NS_WARN_IF(NS_FAILED(rv) || !loadGroup)) {</span>
<span class="lineNum">    9863 </span>            :     return false;
<span class="lineNum">    9864 </span>            :   }
<span class="lineNum">    9865 </span>            : 
<span class="lineNum">    9866 </span>            :   nsCOMPtr&lt;nsIInterfaceRequestor&gt; callbacks;
<span class="lineNum">    9867 </span><span class="lineNoCov">          0 :   rv = loadGroup-&gt;GetNotificationCallbacks(getter_AddRefs(callbacks));</span>
<span class="lineNum">    9868 </span><span class="lineNoCov">          0 :   if (NS_WARN_IF(NS_FAILED(rv) || !callbacks)) {</span>
<span class="lineNum">    9869 </span>            :     return false;
<span class="lineNum">    9870 </span>            :   }
<span class="lineNum">    9871 </span>            : 
<span class="lineNum">    9872 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsILoadContext&gt; loadContext = do_GetInterface(callbacks);</span>
<span class="lineNum">    9873 </span><span class="lineNoCov">          0 :   if (NS_WARN_IF(!loadContext)) {</span>
<span class="lineNum">    9874 </span>            :     return false;
<span class="lineNum">    9875 </span>            :   }
<span class="lineNum">    9876 </span>            : 
<span class="lineNum">    9877 </span>            :   nsCOMPtr&lt;mozIDOMWindowProxy&gt; window;
<span class="lineNum">    9878 </span><span class="lineNoCov">          0 :   rv = loadContext-&gt;GetAssociatedWindow(getter_AddRefs(window));</span>
<span class="lineNum">    9879 </span><span class="lineNoCov">          0 :   if (NS_WARN_IF(NS_FAILED(rv) || !window)) {</span>
<span class="lineNum">    9880 </span>            :     return false;
<span class="lineNum">    9881 </span>            :   }
<span class="lineNum">    9882 </span>            : 
<span class="lineNum">    9883 </span><span class="lineNoCov">          0 :   nsPIDOMWindowOuter* outer = nsPIDOMWindowOuter::From(window);</span>
<span class="lineNum">    9884 </span><span class="lineNoCov">          0 :   if (NS_WARN_IF(!outer)) {</span>
<span class="lineNum">    9885 </span>            :     return false;
<span class="lineNum">    9886 </span>            :   }
<span class="lineNum">    9887 </span>            : 
<span class="lineNum">    9888 </span><span class="lineNoCov">          0 :   if (!XRE_IsContentProcess()) {</span>
<span class="lineNum">    9889 </span><span class="lineNoCov">          0 :     outer-&gt;SetLargeAllocStatus(LargeAllocStatus::NON_E10S);</span>
<span class="lineNum">    9890 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">    9891 </span>            :   }
<span class="lineNum">    9892 </span>            : 
<span class="lineNum">    9893 </span><span class="lineNoCov">          0 :   nsIDocShell* docShell = outer-&gt;GetDocShell();</span>
<span class="lineNum">    9894 </span><span class="lineNoCov">          0 :   if (!docShell-&gt;GetIsOnlyToplevelInTabGroup()) {</span>
<span class="lineNum">    9895 </span><span class="lineNoCov">          0 :     outer-&gt;SetLargeAllocStatus(LargeAllocStatus::NOT_ONLY_TOPLEVEL_IN_TABGROUP);</span>
<span class="lineNum">    9896 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">    9897 </span>            :   }
<span class="lineNum">    9898 </span>            : 
<span class="lineNum">    9899 </span>            :   // Get the request method, and check if it is a GET request. If it is not GET,
<span class="lineNum">    9900 </span>            :   // then we cannot perform a large allocation load.
<span class="lineNum">    9901 </span><span class="lineNoCov">          0 :   nsAutoCString requestMethod;</span>
<span class="lineNum">    9902 </span><span class="lineNoCov">          0 :   rv = aChannel-&gt;GetRequestMethod(requestMethod);</span>
<span class="lineNum">    9903 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, false);</span>
<span class="lineNum">    9904 </span>            : 
<span class="lineNum">    9905 </span><span class="lineNoCov">          0 :   if (NS_WARN_IF(!requestMethod.LowerCaseEqualsLiteral(&quot;get&quot;))) {</span>
<span class="lineNum">    9906 </span><span class="lineNoCov">          0 :     outer-&gt;SetLargeAllocStatus(LargeAllocStatus::NON_GET);</span>
<span class="lineNum">    9907 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">    9908 </span>            :   }
<span class="lineNum">    9909 </span>            : 
<span class="lineNum">    9910 </span><span class="lineNoCov">          0 :   TabChild* tabChild = TabChild::GetFrom(outer-&gt;AsOuter());</span>
<span class="lineNum">    9911 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(tabChild, false);</span>
<span class="lineNum">    9912 </span>            : 
<span class="lineNum">    9913 </span><span class="lineNoCov">          0 :   if (tabChild-&gt;IsAwaitingLargeAlloc())  {</span>
<span class="lineNum">    9914 </span>            :     NS_WARNING(&quot;In a Large-Allocation TabChild, ignoring Large-Allocation header!&quot;);
<span class="lineNum">    9915 </span><span class="lineNoCov">          0 :     tabChild-&gt;StopAwaitingLargeAlloc();</span>
<span class="lineNum">    9916 </span><span class="lineNoCov">          0 :     outer-&gt;SetLargeAllocStatus(LargeAllocStatus::SUCCESS);</span>
<span class="lineNum">    9917 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">    9918 </span>            :   }
<span class="lineNum">    9919 </span>            : 
<span class="lineNum">    9920 </span>            :   // On Win32 systems, we want to behave differently, so set the isWin32 bool to
<span class="lineNum">    9921 </span>            :   // be true iff we are on win32.
<span class="lineNum">    9922 </span>            : #if defined(XP_WIN) &amp;&amp; defined(_X86_)
<span class="lineNum">    9923 </span>            :   const bool isWin32 = true;
<span class="lineNum">    9924 </span>            : #else
<span class="lineNum">    9925 </span><span class="lineNoCov">          0 :   const bool isWin32 = false;</span>
<span class="lineNum">    9926 </span>            : #endif
<span class="lineNum">    9927 </span>            : 
<span class="lineNum">    9928 </span>            :   static bool sLargeAllocForceEnable = false;
<span class="lineNum">    9929 </span>            :   static bool sCachedLargeAllocForceEnable = false;
<span class="lineNum">    9930 </span><span class="lineNoCov">          0 :   if (!sCachedLargeAllocForceEnable) {</span>
<span class="lineNum">    9931 </span><span class="lineNoCov">          0 :     sCachedLargeAllocForceEnable = true;</span>
<span class="lineNum">    9932 </span>            :     mozilla::Preferences::AddBoolVarCache(&amp;sLargeAllocForceEnable,
<span class="lineNum">    9933 </span><span class="lineNoCov">          0 :                                           &quot;dom.largeAllocation.forceEnable&quot;);</span>
<span class="lineNum">    9934 </span>            :   }
<span class="lineNum">    9935 </span>            : 
<span class="lineNum">    9936 </span>            :   // We want to enable the large allocation header on 32-bit windows machines,
<span class="lineNum">    9937 </span>            :   // and disable it on other machines, while still printing diagnostic messages.
<span class="lineNum">    9938 </span>            :   // dom.largeAllocation.forceEnable can allow you to enable the process
<span class="lineNum">    9939 </span>            :   // switching behavior of the Large-Allocation header on non 32-bit windows
<span class="lineNum">    9940 </span>            :   // machines.
<span class="lineNum">    9941 </span><span class="lineNoCov">          0 :   bool largeAllocEnabled = isWin32 || sLargeAllocForceEnable;</span>
<span class="lineNum">    9942 </span><span class="lineNoCov">          0 :   if (!largeAllocEnabled) {</span>
<span class="lineNum">    9943 </span>            :     NS_WARNING(&quot;dom.largeAllocation.forceEnable not set - &quot;
<span class="lineNum">    9944 </span>            :                &quot;ignoring otherwise successful Large-Allocation header.&quot;);
<span class="lineNum">    9945 </span>            :     // On platforms which aren't WIN32, we don't activate the largeAllocation
<span class="lineNum">    9946 </span>            :     // header, instead we simply emit diagnostics into the console.
<span class="lineNum">    9947 </span><span class="lineNoCov">          0 :     outer-&gt;SetLargeAllocStatus(LargeAllocStatus::NON_WIN32);</span>
<span class="lineNum">    9948 </span><span class="lineNoCov">          0 :     return false;</span>
<span class="lineNum">    9949 </span>            :   }
<span class="lineNum">    9950 </span>            : 
<span class="lineNum">    9951 </span>            :   // At this point the fress process load should succeed! We just need to get
<span class="lineNum">    9952 </span>            :   // ourselves a nsIWebBrowserChrome3 to ask to perform the reload. We should
<span class="lineNum">    9953 </span>            :   // have one, as we have already confirmed that we are running in a content
<span class="lineNum">    9954 </span>            :   // process.
<span class="lineNum">    9955 </span>            :   nsCOMPtr&lt;nsIDocShellTreeOwner&gt; treeOwner;
<span class="lineNum">    9956 </span><span class="lineNoCov">          0 :   docShell-&gt;GetTreeOwner(getter_AddRefs(treeOwner));</span>
<span class="lineNum">    9957 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(treeOwner, false);</span>
<span class="lineNum">    9958 </span>            : 
<span class="lineNum">    9959 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIWebBrowserChrome3&gt; wbc3 = do_GetInterface(treeOwner);</span>
<span class="lineNum">    9960 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(wbc3, false);</span>
<span class="lineNum">    9961 </span>            : 
<span class="lineNum">    9962 </span>            :   nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">    9963 </span><span class="lineNoCov">          0 :   rv = aChannel-&gt;GetURI(getter_AddRefs(uri));</span>
<span class="lineNum">    9964 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, false);</span>
<span class="lineNum">    9965 </span><span class="lineNoCov">          0 :   NS_ENSURE_TRUE(uri, false);</span>
<span class="lineNum">    9966 </span>            : 
<span class="lineNum">    9967 </span>            :   nsCOMPtr&lt;nsIURI&gt; referrer;
<span class="lineNum">    9968 </span><span class="lineNoCov">          0 :   rv = aChannel-&gt;GetReferrer(getter_AddRefs(referrer));</span>
<span class="lineNum">    9969 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, false);</span>
<span class="lineNum">    9970 </span>            : 
<span class="lineNum">    9971 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsILoadInfo&gt; loadInfo = aChannel-&gt;GetLoadInfo();</span>
<span class="lineNum">    9972 </span><span class="lineNoCov">          0 :   if (!loadInfo) {</span>
<span class="lineNum">    9973 </span>            :     return false;
<span class="lineNum">    9974 </span>            :   }
<span class="lineNum">    9975 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIPrincipal&gt; triggeringPrincipal = loadInfo-&gt;TriggeringPrincipal();</span>
<span class="lineNum">    9976 </span>            : 
<span class="lineNum">    9977 </span>            :   // Get the channel's load flags, and use them to generate nsIWebNavigation
<span class="lineNum">    9978 </span>            :   // load flags. We want to make sure to propagate the refresh and cache busting
<span class="lineNum">    9979 </span>            :   // flags.
<span class="lineNum">    9980 </span>            :   nsLoadFlags channelLoadFlags;
<span class="lineNum">    9981 </span><span class="lineNoCov">          0 :   aChannel-&gt;GetLoadFlags(&amp;channelLoadFlags);</span>
<span class="lineNum">    9982 </span>            : 
<span class="lineNum">    9983 </span><span class="lineNoCov">          0 :   uint32_t webnavLoadFlags = nsIWebNavigation::LOAD_FLAGS_NONE;</span>
<span class="lineNum">    9984 </span><span class="lineNoCov">          0 :   if (channelLoadFlags &amp; nsIRequest::LOAD_BYPASS_CACHE) {</span>
<span class="lineNum">    9985 </span>            :     webnavLoadFlags |= nsIWebNavigation::LOAD_FLAGS_BYPASS_CACHE;
<span class="lineNum">    9986 </span>            :     webnavLoadFlags |= nsIWebNavigation::LOAD_FLAGS_BYPASS_PROXY;
<span class="lineNum">    9987 </span><span class="lineNoCov">          0 :   } else if (channelLoadFlags &amp; nsIRequest::VALIDATE_ALWAYS) {</span>
<span class="lineNum">    9988 </span><span class="lineNoCov">          0 :     webnavLoadFlags |= nsIWebNavigation::LOAD_FLAGS_IS_REFRESH;</span>
<span class="lineNum">    9989 </span>            :   }
<span class="lineNum">    9990 </span>            : 
<span class="lineNum">    9991 </span>            :   // Actually perform the cross process load
<span class="lineNum">    9992 </span><span class="lineNoCov">          0 :   bool reloadSucceeded = false;</span>
<span class="lineNum">    9993 </span>            :   rv = wbc3-&gt;ReloadInFreshProcess(docShell, uri, referrer,
<span class="lineNum">    9994 </span>            :                                   triggeringPrincipal, webnavLoadFlags,
<span class="lineNum">    9995 </span><span class="lineNoCov">          0 :                                   &amp;reloadSucceeded);</span>
<span class="lineNum">    9996 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, false);</span>
<span class="lineNum">    9997 </span>            : 
<span class="lineNum">    9998 </span><span class="lineNoCov">          0 :   return reloadSucceeded;</span>
<span class="lineNum">    9999 </span>            : }
<a name="10000"><span class="lineNum">   10000 </span>            : </a>
<span class="lineNum">   10001 </span>            : /* static */ void
<span class="lineNum">   10002 </span><span class="lineNoCov">          0 : nsContentUtils::AppendDocumentLevelNativeAnonymousContentTo(</span>
<span class="lineNum">   10003 </span>            :     nsIDocument* aDocument,
<span class="lineNum">   10004 </span>            :     nsTArray&lt;nsIContent*&gt;&amp; aElements)
<span class="lineNum">   10005 </span>            : {
<span class="lineNum">   10006 </span>            :   MOZ_ASSERT(aDocument);
<span class="lineNum">   10007 </span>            : 
<span class="lineNum">   10008 </span>            :   // XXXheycam This probably needs to find the nsCanvasFrame's NAC too.
<span class="lineNum">   10009 </span><span class="lineNoCov">          0 :   if (nsIPresShell* presShell = aDocument-&gt;GetShell()) {</span>
<span class="lineNum">   10010 </span><span class="lineNoCov">          0 :     if (nsIFrame* scrollFrame = presShell-&gt;GetRootScrollFrame()) {</span>
<span class="lineNum">   10011 </span><span class="lineNoCov">          0 :       nsIAnonymousContentCreator* creator = do_QueryFrame(scrollFrame);</span>
<span class="lineNum">   10012 </span>            :       MOZ_ASSERT(creator,
<span class="lineNum">   10013 </span>            :                  &quot;scroll frame should always implement nsIAnonymousContentCreator&quot;);
<span class="lineNum">   10014 </span><span class="lineNoCov">          0 :       creator-&gt;AppendAnonymousContentTo(aElements, 0);</span>
<span class="lineNum">   10015 </span>            :     }
<span class="lineNum">   10016 </span>            :   }
<span class="lineNum">   10017 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">   10018 </span>            : 
<span class="lineNum">   10019 </span>            : /* static */ void
<span class="lineNum">   10020 </span><span class="lineNoCov">          0 : nsContentUtils::GetContentPolicyTypeForUIImageLoading(nsIContent* aLoadingNode,</span>
<span class="lineNum">   10021 </span>            :                                                       nsIPrincipal** aLoadingPrincipal,
<span class="lineNum">   10022 </span>            :                                                       nsContentPolicyType&amp; aContentPolicyType)
<span class="lineNum">   10023 </span>            : {
<span class="lineNum">   10024 </span>            :   // Use the serialized loadingPrincipal from the image element. Fall back
<span class="lineNum">   10025 </span>            :   // to mContent's principal (SystemPrincipal) if not available.
<span class="lineNum">   10026 </span><span class="lineNoCov">          0 :   aContentPolicyType = nsIContentPolicy::TYPE_INTERNAL_IMAGE;</span>
<span class="lineNum">   10027 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIPrincipal&gt; loadingPrincipal = aLoadingNode-&gt;NodePrincipal();</span>
<span class="lineNum">   10028 </span><span class="lineNoCov">          0 :   nsAutoString imageLoadingPrincipal;</span>
<span class="lineNum">   10029 </span>            :   aLoadingNode-&gt;GetAttr(kNameSpaceID_None, nsGkAtoms::loadingprincipal,
<span class="lineNum">   10030 </span><span class="lineNoCov">          0 :                         imageLoadingPrincipal);</span>
<span class="lineNum">   10031 </span><span class="lineNoCov">          0 :   if (!imageLoadingPrincipal.IsEmpty()) {</span>
<span class="lineNum">   10032 </span>            :     nsCOMPtr&lt;nsISupports&gt; serializedPrincipal;
<span class="lineNum">   10033 </span>            :     NS_DeserializeObject(NS_ConvertUTF16toUTF8(imageLoadingPrincipal),
<span class="lineNum">   10034 </span><span class="lineNoCov">          0 :                          getter_AddRefs(serializedPrincipal));</span>
<span class="lineNum">   10035 </span><span class="lineNoCov">          0 :     loadingPrincipal = do_QueryInterface(serializedPrincipal);</span>
<span class="lineNum">   10036 </span>            : 
<span class="lineNum">   10037 </span><span class="lineNoCov">          0 :     if (loadingPrincipal) {</span>
<span class="lineNum">   10038 </span>            :       // Set the content policy type to TYPE_INTERNAL_IMAGE_FAVICON for
<span class="lineNum">   10039 </span>            :       // indicating it's a favicon loading.
<span class="lineNum">   10040 </span><span class="lineNoCov">          0 :       aContentPolicyType = nsIContentPolicy::TYPE_INTERNAL_IMAGE_FAVICON;</span>
<span class="lineNum">   10041 </span>            :     } else {
<span class="lineNum">   10042 </span>            :       // Fallback if the deserialization is failed.
<span class="lineNum">   10043 </span><span class="lineNoCov">          0 :       loadingPrincipal = aLoadingNode-&gt;NodePrincipal();</span>
<span class="lineNum">   10044 </span>            :     }
<span class="lineNum">   10045 </span>            :   }
<span class="lineNum">   10046 </span>            :   loadingPrincipal.forget(aLoadingPrincipal);
<span class="lineNum">   10047 </span><span class="lineNoCov">          0 : }</span>
<a name="10048"><span class="lineNum">   10048 </span>            : </a>
<span class="lineNum">   10049 </span>            : /* static */ nsresult
<span class="lineNum">   10050 </span><span class="lineNoCov">          0 : nsContentUtils::CreateJSValueFromSequenceOfObject(JSContext* aCx,</span>
<span class="lineNum">   10051 </span>            :                                                   const Sequence&lt;JSObject*&gt;&amp; aTransfer,
<span class="lineNum">   10052 </span>            :                                                   JS::MutableHandle&lt;JS::Value&gt; aValue)
<span class="lineNum">   10053 </span>            : {
<span class="lineNum">   10054 </span><span class="lineNoCov">          0 :   if (aTransfer.IsEmpty()) {</span>
<span class="lineNum">   10055 </span>            :     return NS_OK;
<span class="lineNum">   10056 </span>            :   }
<span class="lineNum">   10057 </span>            : 
<span class="lineNum">   10058 </span><span class="lineNoCov">          0 :   JS::Rooted&lt;JSObject*&gt; array(aCx, JS_NewArrayObject(aCx, aTransfer.Length()));</span>
<span class="lineNum">   10059 </span><span class="lineNoCov">          0 :   if (!array) {</span>
<span class="lineNum">   10060 </span>            :     return NS_ERROR_OUT_OF_MEMORY;
<span class="lineNum">   10061 </span>            :   }
<span class="lineNum">   10062 </span>            : 
<span class="lineNum">   10063 </span><span class="lineNoCov">          0 :   for (uint32_t i = 0; i &lt; aTransfer.Length(); ++i) {</span>
<span class="lineNum">   10064 </span><span class="lineNoCov">          0 :     JS::Rooted&lt;JSObject*&gt; object(aCx, aTransfer[i]);</span>
<span class="lineNum">   10065 </span><span class="lineNoCov">          0 :     if (!object) {</span>
<span class="lineNum">   10066 </span>            :       continue;
<span class="lineNum">   10067 </span>            :     }
<span class="lineNum">   10068 </span>            : 
<span class="lineNum">   10069 </span><span class="lineNoCov">          0 :     if (NS_WARN_IF(!JS_DefineElement(aCx, array, i, object,</span>
<span class="lineNum">   10070 </span>            :                                      JSPROP_ENUMERATE))) {
<span class="lineNum">   10071 </span><span class="lineNoCov">          0 :       return NS_ERROR_OUT_OF_MEMORY;</span>
<span class="lineNum">   10072 </span>            :     }
<span class="lineNum">   10073 </span>            :   }
<span class="lineNum">   10074 </span>            : 
<span class="lineNum">   10075 </span><span class="lineNoCov">          0 :   aValue.setObject(*array);</span>
<span class="lineNum">   10076 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">   10077 </span>            : }
<a name="10078"><span class="lineNum">   10078 </span>            : </a>
<span class="lineNum">   10079 </span>            : /* static */ Element*
<span class="lineNum">   10080 </span><span class="lineNoCov">          0 : nsContentUtils::GetClosestNonNativeAnonymousAncestor(Element* aElement)</span>
<span class="lineNum">   10081 </span>            : {
<span class="lineNum">   10082 </span>            :   MOZ_ASSERT(aElement);
<span class="lineNum">   10083 </span>            :   MOZ_ASSERT(aElement-&gt;IsNativeAnonymous());
<span class="lineNum">   10084 </span>            : 
<span class="lineNum">   10085 </span><span class="lineNoCov">          0 :   Element* e = aElement;</span>
<span class="lineNum">   10086 </span><span class="lineNoCov">          0 :   while (e &amp;&amp; e-&gt;IsNativeAnonymous()) {</span>
<span class="lineNum">   10087 </span><span class="lineNoCov">          0 :     e = e-&gt;GetParentElement();</span>
<span class="lineNum">   10088 </span>            :   }
<span class="lineNum">   10089 </span><span class="lineNoCov">          0 :   return e;</span>
<span class="lineNum">   10090 </span>            : }
<span class="lineNum">   10091 </span>            : 
<span class="lineNum">   10092 </span>            : /**
<span class="lineNum">   10093 </span>            :  * Checks whether the given type is a supported document type for
<span class="lineNum">   10094 </span>            :  * loading within the nsObjectLoadingContent specified by aContent.
<span class="lineNum">   10095 </span>            :  *
<span class="lineNum">   10096 </span>            :  * NOTE Helper method for nsContentUtils::HtmlObjectContentTypeForMIMEType.
<span class="lineNum">   10097 </span>            :  * NOTE Does not take content policy or capabilities into account
<span class="lineNum">   10098 </span>            :  */
<span class="lineNum">   10099 </span>            : static bool
<span class="lineNum">   10100 </span><span class="lineNoCov">          0 : HtmlObjectContentSupportsDocument(const nsCString&amp; aMimeType,</span>
<span class="lineNum">   10101 </span>            :                                   nsIContent* aContent)
<span class="lineNum">   10102 </span>            : {
<span class="lineNum">   10103 </span>            :   nsCOMPtr&lt;nsIWebNavigationInfo&gt; info(
<span class="lineNum">   10104 </span><span class="lineNoCov">          0 :     do_GetService(NS_WEBNAVIGATION_INFO_CONTRACTID));</span>
<span class="lineNum">   10105 </span><span class="lineNoCov">          0 :   if (!info) {</span>
<span class="lineNum">   10106 </span>            :     return false;
<span class="lineNum">   10107 </span>            :   }
<span class="lineNum">   10108 </span>            : 
<span class="lineNum">   10109 </span>            :   nsCOMPtr&lt;nsIWebNavigation&gt; webNav;
<span class="lineNum">   10110 </span><span class="lineNoCov">          0 :   if (aContent) {</span>
<span class="lineNum">   10111 </span><span class="lineNoCov">          0 :     nsIDocument* currentDoc = aContent-&gt;GetComposedDoc();</span>
<span class="lineNum">   10112 </span><span class="lineNoCov">          0 :     if (currentDoc) {</span>
<span class="lineNum">   10113 </span><span class="lineNoCov">          0 :       webNav = do_GetInterface(currentDoc-&gt;GetWindow());</span>
<span class="lineNum">   10114 </span>            :     }
<span class="lineNum">   10115 </span>            :   }
<span class="lineNum">   10116 </span>            : 
<span class="lineNum">   10117 </span>            :   uint32_t supported;
<span class="lineNum">   10118 </span><span class="lineNoCov">          0 :   nsresult rv = info-&gt;IsTypeSupported(aMimeType, webNav, &amp;supported);</span>
<span class="lineNum">   10119 </span>            : 
<span class="lineNum">   10120 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">   10121 </span>            :     return false;
<span class="lineNum">   10122 </span>            :   }
<span class="lineNum">   10123 </span>            : 
<span class="lineNum">   10124 </span><span class="lineNoCov">          0 :   if (supported != nsIWebNavigationInfo::UNSUPPORTED) {</span>
<span class="lineNum">   10125 </span>            :     // Don't want to support plugins as documents
<span class="lineNum">   10126 </span><span class="lineNoCov">          0 :     return supported != nsIWebNavigationInfo::PLUGIN;</span>
<span class="lineNum">   10127 </span>            :   }
<span class="lineNum">   10128 </span>            : 
<span class="lineNum">   10129 </span>            :   // Try a stream converter
<span class="lineNum">   10130 </span>            :   // NOTE: We treat any type we can convert from as a supported type. If a
<span class="lineNum">   10131 </span>            :   // type is not actually supported, the URI loader will detect that and
<span class="lineNum">   10132 </span>            :   // return an error, and we'll fallback.
<span class="lineNum">   10133 </span>            :   nsCOMPtr&lt;nsIStreamConverterService&gt; convServ =
<span class="lineNum">   10134 </span><span class="lineNoCov">          0 :     do_GetService(&quot;@mozilla.org/streamConverters;1&quot;);</span>
<span class="lineNum">   10135 </span><span class="lineNoCov">          0 :   bool canConvert = false;</span>
<span class="lineNum">   10136 </span><span class="lineNoCov">          0 :   if (convServ) {</span>
<span class="lineNum">   10137 </span><span class="lineNoCov">          0 :     rv = convServ-&gt;CanConvert(aMimeType.get(), &quot;*/*&quot;, &amp;canConvert);</span>
<span class="lineNum">   10138 </span>            :   }
<span class="lineNum">   10139 </span><span class="lineNoCov">          0 :   return NS_SUCCEEDED(rv) &amp;&amp; canConvert;</span>
<span class="lineNum">   10140 </span>            : }
<a name="10141"><span class="lineNum">   10141 </span>            : </a>
<span class="lineNum">   10142 </span>            : /* static */ uint32_t
<span class="lineNum">   10143 </span><span class="lineNoCov">          0 : nsContentUtils::HtmlObjectContentTypeForMIMEType(const nsCString&amp; aMIMEType,</span>
<span class="lineNum">   10144 </span>            :                                                  nsIContent* aContent)
<span class="lineNum">   10145 </span>            : {
<span class="lineNum">   10146 </span><span class="lineNoCov">          0 :   if (aMIMEType.IsEmpty()) {</span>
<span class="lineNum">   10147 </span>            :     return nsIObjectLoadingContent::TYPE_NULL;
<span class="lineNum">   10148 </span>            :   }
<span class="lineNum">   10149 </span>            : 
<span class="lineNum">   10150 </span><span class="lineNoCov">          0 :   if (imgLoader::SupportImageWithMimeType(aMIMEType.get())) {</span>
<span class="lineNum">   10151 </span>            :     return nsIObjectLoadingContent::TYPE_IMAGE;
<span class="lineNum">   10152 </span>            :   }
<span class="lineNum">   10153 </span>            : 
<span class="lineNum">   10154 </span>            :   // Faking support of the PDF content as a document for EMBED tags
<span class="lineNum">   10155 </span>            :   // when internal PDF viewer is enabled.
<span class="lineNum">   10156 </span><span class="lineNoCov">          0 :   if (aMIMEType.LowerCaseEqualsLiteral(&quot;application/pdf&quot;) &amp;&amp;</span>
<span class="lineNum">   10157 </span><span class="lineNoCov">          0 :       IsPDFJSEnabled()) {</span>
<span class="lineNum">   10158 </span>            :     return nsIObjectLoadingContent::TYPE_DOCUMENT;
<span class="lineNum">   10159 </span>            :   }
<span class="lineNum">   10160 </span>            : 
<span class="lineNum">   10161 </span><span class="lineNoCov">          0 :   if (HtmlObjectContentSupportsDocument(aMIMEType, aContent)) {</span>
<span class="lineNum">   10162 </span>            :     return nsIObjectLoadingContent::TYPE_DOCUMENT;
<span class="lineNum">   10163 </span>            :   }
<span class="lineNum">   10164 </span>            : 
<span class="lineNum">   10165 </span><span class="lineNoCov">          0 :   RefPtr&lt;nsPluginHost&gt; pluginHost = nsPluginHost::GetInst();</span>
<span class="lineNum">   10166 </span><span class="lineNoCov">          0 :   if (pluginHost &amp;&amp;</span>
<span class="lineNum">   10167 </span><span class="lineNoCov">          0 :       pluginHost-&gt;HavePluginForType(aMIMEType, nsPluginHost::eExcludeNone)) {</span>
<span class="lineNum">   10168 </span>            :     // ShouldPlay will handle checking for disabled plugins
<span class="lineNum">   10169 </span>            :     return nsIObjectLoadingContent::TYPE_PLUGIN;
<span class="lineNum">   10170 </span>            :   }
<span class="lineNum">   10171 </span>            : 
<span class="lineNum">   10172 </span><span class="lineNoCov">          0 :   return nsIObjectLoadingContent::TYPE_NULL;</span>
<span class="lineNum">   10173 </span>            : }
<span class="lineNum">   10174 </span>            : 
<span class="lineNum">   10175 </span>            : /* static */ already_AddRefed&lt;nsIEventTarget&gt;
<span class="lineNum">   10176 </span><span class="lineNoCov">          0 :   nsContentUtils::GetEventTargetByLoadInfo(nsILoadInfo* aLoadInfo, TaskCategory aCategory)</span>
<span class="lineNum">   10177 </span>            : {
<span class="lineNum">   10178 </span><span class="lineNoCov">          0 :   if (NS_WARN_IF(!aLoadInfo)) {</span>
<span class="lineNum">   10179 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">   10180 </span>            :   }
<span class="lineNum">   10181 </span>            : 
<span class="lineNum">   10182 </span>            :   nsCOMPtr&lt;nsIDOMDocument&gt; domDoc;
<span class="lineNum">   10183 </span><span class="lineNoCov">          0 :   aLoadInfo-&gt;GetLoadingDocument(getter_AddRefs(domDoc));</span>
<span class="lineNum">   10184 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIDocument&gt; doc = do_QueryInterface(domDoc);</span>
<span class="lineNum">   10185 </span>            :   nsCOMPtr&lt;nsIEventTarget&gt; target;
<span class="lineNum">   10186 </span><span class="lineNoCov">          0 :   if (doc) {</span>
<span class="lineNum">   10187 </span><span class="lineNoCov">          0 :     if (DocGroup* group = doc-&gt;GetDocGroup()) {</span>
<span class="lineNum">   10188 </span><span class="lineNoCov">          0 :       target = group-&gt;EventTargetFor(aCategory);</span>
<span class="lineNum">   10189 </span>            :     }
<span class="lineNum">   10190 </span>            :   } else {
<span class="lineNum">   10191 </span>            :     // There's no document yet, but this might be a top-level load where we can
<span class="lineNum">   10192 </span>            :     // find a TabGroup.
<span class="lineNum">   10193 </span>            :     uint64_t outerWindowId;
<span class="lineNum">   10194 </span><span class="lineNoCov">          0 :     if (NS_FAILED(aLoadInfo-&gt;GetOuterWindowID(&amp;outerWindowId))) {</span>
<span class="lineNum">   10195 </span>            :       // No window. This might be an add-on XHR, a service worker request, or
<span class="lineNum">   10196 </span>            :       // something else.
<span class="lineNum">   10197 </span><span class="lineNoCov">          0 :       return nullptr;</span>
<span class="lineNum">   10198 </span>            :     }
<span class="lineNum">   10199 </span><span class="lineNoCov">          0 :     RefPtr&lt;nsGlobalWindow&gt; window = nsGlobalWindow::GetOuterWindowWithId(outerWindowId);</span>
<span class="lineNum">   10200 </span><span class="lineNoCov">          0 :     if (!window) {</span>
<span class="lineNum">   10201 </span><span class="lineNoCov">          0 :       return nullptr;</span>
<span class="lineNum">   10202 </span>            :     }
<span class="lineNum">   10203 </span>            : 
<span class="lineNum">   10204 </span><span class="lineNoCov">          0 :     target = window-&gt;TabGroup()-&gt;EventTargetFor(aCategory);</span>
<span class="lineNum">   10205 </span>            :   }
<span class="lineNum">   10206 </span>            : 
<span class="lineNum">   10207 </span>            :   return target.forget();
<span class="lineNum">   10208 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
