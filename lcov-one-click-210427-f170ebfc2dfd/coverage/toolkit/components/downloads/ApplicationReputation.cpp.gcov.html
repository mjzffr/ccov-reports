<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mochitest-e10s.info - toolkit/components/downloads/ApplicationReputation.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../index.html">top level</a> - <a href="index.html">toolkit/components/downloads</a> - ApplicationReputation.cpp<span style="font-size: 80%;"> (source / <a href="ApplicationReputation.cpp.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mochitest-e10s.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">488</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-04-21</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">45</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</a>
<span class="lineNum">       2 </span>            : /* vim: set ts=2 et sw=2 tw=80: */
<span class="lineNum">       3 </span>            : /* This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       4 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       5 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       6 </span>            : // See
<span class="lineNum">       7 </span>            : // https://wiki.mozilla.org/Security/Features/Application_Reputation_Design_Doc
<span class="lineNum">       8 </span>            : // for a description of Chrome's implementation of this feature.
<span class="lineNum">       9 </span>            : #include &quot;ApplicationReputation.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;chrome/common/safe_browsing/csd.pb.h&quot;
<span class="lineNum">      11 </span>            : 
<span class="lineNum">      12 </span>            : #include &quot;nsIArray.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;nsIApplicationReputation.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;nsIChannel.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;nsIHttpChannel.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;nsIIOService.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;nsIPrefService.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;nsISimpleEnumerator.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;nsIStreamListener.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;nsIStringStream.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;nsITimer.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;nsIUploadChannel2.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;nsIURI.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;nsIURL.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;nsIUrlClassifierDBService.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;nsIX509Cert.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;nsIX509CertDB.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;nsIX509CertList.h&quot;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : #include &quot;mozilla/ArrayUtils.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;mozilla/BasePrincipal.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;mozilla/ErrorNames.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;mozilla/LoadContext.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;mozilla/Preferences.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;mozilla/Services.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;mozilla/SizePrintfMacros.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;mozilla/Telemetry.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;mozilla/TimeStamp.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;mozilla/intl/LocaleService.h&quot;
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : #include &quot;nsAutoPtr.h&quot;
<span class="lineNum">      42 </span>            : #include &quot;nsCOMPtr.h&quot;
<span class="lineNum">      43 </span>            : #include &quot;nsDebug.h&quot;
<span class="lineNum">      44 </span>            : #include &quot;nsDependentSubstring.h&quot;
<span class="lineNum">      45 </span>            : #include &quot;nsError.h&quot;
<span class="lineNum">      46 </span>            : #include &quot;nsNetCID.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;nsReadableUtils.h&quot;
<span class="lineNum">      48 </span>            : #include &quot;nsServiceManagerUtils.h&quot;
<span class="lineNum">      49 </span>            : #include &quot;nsString.h&quot;
<span class="lineNum">      50 </span>            : #include &quot;nsTArray.h&quot;
<span class="lineNum">      51 </span>            : #include &quot;nsThreadUtils.h&quot;
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : #include &quot;nsIContentPolicy.h&quot;
<span class="lineNum">      54 </span>            : #include &quot;nsILoadInfo.h&quot;
<span class="lineNum">      55 </span>            : #include &quot;nsContentUtils.h&quot;
<span class="lineNum">      56 </span>            : #include &quot;nsWeakReference.h&quot;
<span class="lineNum">      57 </span>            : #include &quot;nsCharSeparatedTokenizer.h&quot;
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span>            : using namespace mozilla::downloads;
<span class="lineNum">      60 </span>            : using mozilla::ArrayLength;
<span class="lineNum">      61 </span>            : using mozilla::BasePrincipal;
<span class="lineNum">      62 </span>            : using mozilla::OriginAttributes;
<span class="lineNum">      63 </span>            : using mozilla::Preferences;
<span class="lineNum">      64 </span>            : using mozilla::TimeStamp;
<span class="lineNum">      65 </span>            : using mozilla::Telemetry::Accumulate;
<span class="lineNum">      66 </span>            : using mozilla::intl::LocaleService;
<span class="lineNum">      67 </span>            : using safe_browsing::ClientDownloadRequest;
<span class="lineNum">      68 </span>            : using safe_browsing::ClientDownloadRequest_CertificateChain;
<span class="lineNum">      69 </span>            : using safe_browsing::ClientDownloadRequest_Resource;
<span class="lineNum">      70 </span>            : using safe_browsing::ClientDownloadRequest_SignatureInfo;
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span>            : // Preferences that we need to initialize the query.
<span class="lineNum">      73 </span>            : #define PREF_SB_APP_REP_URL &quot;browser.safebrowsing.downloads.remote.url&quot;
<span class="lineNum">      74 </span>            : #define PREF_SB_MALWARE_ENABLED &quot;browser.safebrowsing.malware.enabled&quot;
<span class="lineNum">      75 </span>            : #define PREF_SB_DOWNLOADS_ENABLED &quot;browser.safebrowsing.downloads.enabled&quot;
<span class="lineNum">      76 </span>            : #define PREF_SB_DOWNLOADS_REMOTE_ENABLED &quot;browser.safebrowsing.downloads.remote.enabled&quot;
<span class="lineNum">      77 </span>            : #define PREF_SB_DOWNLOADS_REMOTE_TIMEOUT &quot;browser.safebrowsing.downloads.remote.timeout_ms&quot;
<span class="lineNum">      78 </span>            : #define PREF_DOWNLOAD_BLOCK_TABLE &quot;urlclassifier.downloadBlockTable&quot;
<span class="lineNum">      79 </span>            : #define PREF_DOWNLOAD_ALLOW_TABLE &quot;urlclassifier.downloadAllowTable&quot;
<span class="lineNum">      80 </span>            : 
<span class="lineNum">      81 </span>            : // Preferences that are needed to action the verdict.
<span class="lineNum">      82 </span>            : #define PREF_BLOCK_DANGEROUS            &quot;browser.safebrowsing.downloads.remote.block_dangerous&quot;
<span class="lineNum">      83 </span>            : #define PREF_BLOCK_DANGEROUS_HOST       &quot;browser.safebrowsing.downloads.remote.block_dangerous_host&quot;
<span class="lineNum">      84 </span>            : #define PREF_BLOCK_POTENTIALLY_UNWANTED &quot;browser.safebrowsing.downloads.remote.block_potentially_unwanted&quot;
<span class="lineNum">      85 </span>            : #define PREF_BLOCK_UNCOMMON             &quot;browser.safebrowsing.downloads.remote.block_uncommon&quot;
<span class="lineNum">      86 </span>            : 
<span class="lineNum">      87 </span>            : // MOZ_LOG=ApplicationReputation:5
<span class="lineNum">      88 </span>            : mozilla::LazyLogModule ApplicationReputationService::prlog(&quot;ApplicationReputation&quot;);
<span class="lineNum">      89 </span>            : #define LOG(args) MOZ_LOG(ApplicationReputationService::prlog, mozilla::LogLevel::Debug, args)
<span class="lineNum">      90 </span>            : #define LOG_ENABLED() MOZ_LOG_TEST(ApplicationReputationService::prlog, mozilla::LogLevel::Debug)
<span class="lineNum">      91 </span>            : 
<span class="lineNum">      92 </span>            : namespace mozilla {
<span class="lineNum">      93 </span>            : namespace downloads {
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span>            : enum class TelemetryMatchInfo : uint8_t
<span class="lineNum">      96 </span>            : {
<span class="lineNum">      97 </span>            :   eNoMatch   = 0x00,
<span class="lineNum">      98 </span>            :   eV2Match   = 0x01,
<span class="lineNum">      99 </span>            :   eV4Match   = 0x02,
<span class="lineNum">     100 </span>            :   eBothMatch = eV2Match | eV4Match,
<a name="101"><span class="lineNum">     101 </span>            : };</a>
<span class="lineNum">     102 </span>            : 
<span class="lineNum">     103 </span><span class="lineNoCov">          0 : MOZ_MAKE_ENUM_CLASS_BITWISE_OPERATORS(TelemetryMatchInfo)</span>
<span class="lineNum">     104 </span>            : 
<span class="lineNum">     105 </span>            : // Given a comma-separated list of tables which matched a URL, check to see if
<span class="lineNum">     106 </span>            : // at least one of these tables is present in the given pref.
<span class="lineNum">     107 </span>            : bool
<span class="lineNum">     108 </span><span class="lineNoCov">          0 : LookupTablesInPrefs(const nsACString&amp; tables, const char* aPref)</span>
<span class="lineNum">     109 </span>            : {
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :   nsAutoCString prefList;</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :   Preferences::GetCString(aPref, &amp;prefList);</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :   if (prefList.IsEmpty()) {</span>
<span class="lineNum">     113 </span>            :     return false;
<span class="lineNum">     114 </span>            :   }
<span class="lineNum">     115 </span>            : 
<span class="lineNum">     116 </span>            :   // Check if V2 and V4 are enabled in preference
<span class="lineNum">     117 </span>            :   // If V2 and V4 are both enabled, then we should do a telemetry record
<span class="lineNum">     118 </span>            :   // Both V2 and V4 begin with &quot;goog&quot; but V4 ends with &quot;-proto&quot;
<span class="lineNum">     119 </span>            :   nsCCharSeparatedTokenizer prefTokens(prefList, ',');
<span class="lineNum">     120 </span>            :   nsCString prefToken;
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :   bool isV4Enabled = false;</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :   bool isV2Enabled = false;</span>
<span class="lineNum">     123 </span>            : 
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :   while (prefTokens.hasMoreTokens()) {</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :     prefToken = prefTokens.nextToken();</span>
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :     if (StringBeginsWith(prefToken, NS_LITERAL_CSTRING(&quot;goog&quot;))) {</span>
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :       if (StringEndsWith(prefToken, NS_LITERAL_CSTRING(&quot;-proto&quot;))) {</span>
<span class="lineNum">     128 </span>            :         isV4Enabled = true;
<span class="lineNum">     129 </span>            :       } else {
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :         isV2Enabled = true;</span>
<span class="lineNum">     131 </span>            :       }
<span class="lineNum">     132 </span>            :     }
<span class="lineNum">     133 </span>            :   }
<span class="lineNum">     134 </span>            : 
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :   bool shouldRecordTelemetry = isV2Enabled &amp;&amp; isV4Enabled;</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :   TelemetryMatchInfo telemetryInfo = TelemetryMatchInfo::eNoMatch;</span>
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span>            :   // Parsed tables separated by &quot;,&quot; into tokens then lookup each token
<span class="lineNum">     139 </span>            :   // in preference list
<span class="lineNum">     140 </span>            :   nsCCharSeparatedTokenizer tokens(tables, ',');
<span class="lineNum">     141 </span>            :   nsCString table;
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :   bool found = false;</span>
<span class="lineNum">     143 </span>            : 
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :   while (tokens.hasMoreTokens()) {</span>
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :     table = tokens.nextToken();</span>
<span class="lineNum">     146 </span><span class="lineNoCov">          0 :     if (table.IsEmpty()) {</span>
<span class="lineNum">     147 </span>            :       continue;
<span class="lineNum">     148 </span>            :     }
<span class="lineNum">     149 </span>            : 
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :     if (!FindInReadable(table, prefList)) {</span>
<span class="lineNum">     151 </span>            :       continue;
<span class="lineNum">     152 </span>            :     }
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :     found = true;</span>
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :     if (!shouldRecordTelemetry) {</span>
<span class="lineNum">     156 </span>            :       return found;
<span class="lineNum">     157 </span>            :     }
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span>            :     // We are checking if the table found is V2 or V4 to record telemetry
<span class="lineNum">     160 </span>            :     // Both V2 and V4 begin with &quot;goog&quot; but V4 ends with &quot;-proto&quot;
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :     if (StringBeginsWith(prefToken, NS_LITERAL_CSTRING(&quot;goog&quot;))) {</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :       if (StringEndsWith(prefToken, NS_LITERAL_CSTRING(&quot;-proto&quot;))) {</span>
<span class="lineNum">     163 </span>            :         telemetryInfo |= TelemetryMatchInfo::eV4Match;
<span class="lineNum">     164 </span>            :       } else {
<span class="lineNum">     165 </span>            :         telemetryInfo |= TelemetryMatchInfo::eV2Match;
<span class="lineNum">     166 </span>            :       }
<span class="lineNum">     167 </span>            :     }
<span class="lineNum">     168 </span>            :   }
<span class="lineNum">     169 </span>            : 
<span class="lineNum">     170 </span>            :   // Record telemetry for matching allow list and block list
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :   if (!strcmp(aPref, PREF_DOWNLOAD_BLOCK_TABLE)) {</span>
<span class="lineNum">     172 </span>            :     Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_BLOCKLIST_MATCH,
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :                static_cast&lt;uint8_t&gt;(telemetryInfo));</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :   } else if (!strcmp(aPref, PREF_DOWNLOAD_ALLOW_TABLE)) {</span>
<span class="lineNum">     175 </span>            :     Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_ALLOWLIST_MATCH,
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :                static_cast&lt;uint8_t&gt;(telemetryInfo));</span>
<span class="lineNum">     177 </span>            :   }
<span class="lineNum">     178 </span>            : 
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :   return found;</span>
<span class="lineNum">     180 </span>            : }
<span class="lineNum">     181 </span>            : } // namespace downloads
<span class="lineNum">     182 </span>            : } // namespace mozilla
<span class="lineNum">     183 </span>            : 
<span class="lineNum">     184 </span>            : class PendingDBLookup;
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span>            : // A single use class private to ApplicationReputationService encapsulating an
<span class="lineNum">     187 </span>            : // nsIApplicationReputationQuery and an nsIApplicationReputationCallback. Once
<span class="lineNum">     188 </span>            : // created by ApplicationReputationService, it is guaranteed to call mCallback.
<span class="lineNum">     189 </span>            : // This class is private to ApplicationReputationService.
<span class="lineNum">     190 </span>            : class PendingLookup final : public nsIStreamListener,
<span class="lineNum">     191 </span>            :                             public nsITimerCallback,
<span class="lineNum">     192 </span>            :                             public nsIObserver,
<span class="lineNum">     193 </span>            :                             public nsSupportsWeakReference
<span class="lineNum">     194 </span>            : {
<span class="lineNum">     195 </span>            : public:
<span class="lineNum">     196 </span>            :   NS_DECL_ISUPPORTS
<span class="lineNum">     197 </span>            :   NS_DECL_NSIREQUESTOBSERVER
<span class="lineNum">     198 </span>            :   NS_DECL_NSISTREAMLISTENER
<span class="lineNum">     199 </span>            :   NS_DECL_NSITIMERCALLBACK
<span class="lineNum">     200 </span>            :   NS_DECL_NSIOBSERVER
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span>            :   // Constructor and destructor.
<span class="lineNum">     203 </span>            :   PendingLookup(nsIApplicationReputationQuery* aQuery,
<span class="lineNum">     204 </span>            :                 nsIApplicationReputationCallback* aCallback);
<span class="lineNum">     205 </span>            : 
<span class="lineNum">     206 </span>            :   // Start the lookup. The lookup may have 2 parts: local and remote. In the
<span class="lineNum">     207 </span>            :   // local lookup, PendingDBLookups are created to query the local allow and
<span class="lineNum">     208 </span>            :   // blocklists for various URIs associated with this downloaded file. In the
<span class="lineNum">     209 </span>            :   // event that no results are found, a remote lookup is sent to the Application
<span class="lineNum">     210 </span>            :   // Reputation server.
<span class="lineNum">     211 </span>            :   nsresult StartLookup();
<span class="lineNum">     212 </span>            : 
<span class="lineNum">     213 </span>            : private:
<span class="lineNum">     214 </span>            :   ~PendingLookup();
<span class="lineNum">     215 </span>            : 
<span class="lineNum">     216 </span>            :   friend class PendingDBLookup;
<span class="lineNum">     217 </span>            : 
<span class="lineNum">     218 </span>            :   // Telemetry states.
<span class="lineNum">     219 </span>            :   // Status of the remote response (valid or not).
<span class="lineNum">     220 </span>            :   enum SERVER_RESPONSE_TYPES {
<span class="lineNum">     221 </span>            :     SERVER_RESPONSE_VALID = 0,
<span class="lineNum">     222 </span>            :     SERVER_RESPONSE_FAILED = 1,
<span class="lineNum">     223 </span>            :     SERVER_RESPONSE_INVALID = 2,
<span class="lineNum">     224 </span>            :   };
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span>            :   // Number of blocklist and allowlist hits we have seen.
<span class="lineNum">     227 </span>            :   uint32_t mBlocklistCount;
<span class="lineNum">     228 </span>            :   uint32_t mAllowlistCount;
<span class="lineNum">     229 </span>            : 
<span class="lineNum">     230 </span>            :   // The query containing metadata about the downloaded file.
<span class="lineNum">     231 </span>            :   nsCOMPtr&lt;nsIApplicationReputationQuery&gt; mQuery;
<span class="lineNum">     232 </span>            : 
<span class="lineNum">     233 </span>            :   // The callback with which to report the verdict.
<span class="lineNum">     234 </span>            :   nsCOMPtr&lt;nsIApplicationReputationCallback&gt; mCallback;
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span>            :   // An array of strings created from certificate information used to whitelist
<span class="lineNum">     237 </span>            :   // the downloaded file.
<span class="lineNum">     238 </span>            :   nsTArray&lt;nsCString&gt; mAllowlistSpecs;
<span class="lineNum">     239 </span>            :   // The source URI of the download, the referrer and possibly any redirects.
<span class="lineNum">     240 </span>            :   nsTArray&lt;nsCString&gt; mAnylistSpecs;
<span class="lineNum">     241 </span>            : 
<span class="lineNum">     242 </span>            :   // When we started this query
<span class="lineNum">     243 </span>            :   TimeStamp mStartTime;
<span class="lineNum">     244 </span>            : 
<span class="lineNum">     245 </span>            :   // The channel used to talk to the remote lookup server
<span class="lineNum">     246 </span>            :   nsCOMPtr&lt;nsIChannel&gt; mChannel;
<span class="lineNum">     247 </span>            : 
<span class="lineNum">     248 </span>            :   // Timer to abort this lookup if it takes too long
<span class="lineNum">     249 </span>            :   nsCOMPtr&lt;nsITimer&gt; mTimeoutTimer;
<span class="lineNum">     250 </span>            : 
<span class="lineNum">     251 </span>            :   // A protocol buffer for storing things we need in the remote request. We
<span class="lineNum">     252 </span>            :   // store the resource chain (redirect information) as well as signature
<span class="lineNum">     253 </span>            :   // information extracted using the Windows Authenticode API, if the binary is
<span class="lineNum">     254 </span>            :   // signed.
<span class="lineNum">     255 </span>            :   ClientDownloadRequest mRequest;
<span class="lineNum">     256 </span>            : 
<span class="lineNum">     257 </span>            :   // The response from the application reputation query. This is read in chunks
<span class="lineNum">     258 </span>            :   // as part of our nsIStreamListener implementation and may contain embedded
<span class="lineNum">     259 </span>            :   // NULLs.
<span class="lineNum">     260 </span>            :   nsCString mResponse;
<span class="lineNum">     261 </span>            : 
<span class="lineNum">     262 </span>            :   // Returns true if the file is likely to be binary.
<span class="lineNum">     263 </span>            :   bool IsBinaryFile();
<span class="lineNum">     264 </span>            : 
<span class="lineNum">     265 </span>            :   // Returns the type of download binary for the file.
<span class="lineNum">     266 </span>            :   ClientDownloadRequest::DownloadType GetDownloadType(const nsAString&amp; aFilename);
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span>            :   // Clean up and call the callback. PendingLookup must not be used after this
<span class="lineNum">     269 </span>            :   // function is called.
<span class="lineNum">     270 </span>            :   nsresult OnComplete(bool shouldBlock, nsresult rv,
<span class="lineNum">     271 </span>            :     uint32_t verdict = nsIApplicationReputationService::VERDICT_SAFE);
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span>            :   // Wrapper function for nsIStreamListener.onStopRequest to make it easy to
<span class="lineNum">     274 </span>            :   // guarantee calling the callback
<span class="lineNum">     275 </span>            :   nsresult OnStopRequestInternal(nsIRequest *aRequest,
<span class="lineNum">     276 </span>            :                                  nsISupports *aContext,
<span class="lineNum">     277 </span>            :                                  nsresult aResult,
<span class="lineNum">     278 </span>            :                                  bool* aShouldBlock,
<span class="lineNum">     279 </span>            :                                  uint32_t* aVerdict);
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span>            :   // Strip url parameters, fragments, and user@pass fields from the URI spec
<span class="lineNum">     282 </span>            :   // using nsIURL. If aURI is not an nsIURL, returns the original nsIURI.spec.
<span class="lineNum">     283 </span>            :   nsresult GetStrippedSpec(nsIURI* aUri, nsACString&amp; spec);
<span class="lineNum">     284 </span>            : 
<span class="lineNum">     285 </span>            :   // Escape '/' and '%' in certificate attribute values.
<span class="lineNum">     286 </span>            :   nsCString EscapeCertificateAttribute(const nsACString&amp; aAttribute);
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span>            :   // Escape ':' in fingerprint values.
<span class="lineNum">     289 </span>            :   nsCString EscapeFingerprint(const nsACString&amp; aAttribute);
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span>            :   // Generate whitelist strings for the given certificate pair from the same
<span class="lineNum">     292 </span>            :   // certificate chain.
<span class="lineNum">     293 </span>            :   nsresult GenerateWhitelistStringsForPair(
<span class="lineNum">     294 </span>            :     nsIX509Cert* certificate, nsIX509Cert* issuer);
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span>            :   // Generate whitelist strings for the given certificate chain, which starts
<span class="lineNum">     297 </span>            :   // with the signer and may go all the way to the root cert.
<span class="lineNum">     298 </span>            :   nsresult GenerateWhitelistStringsForChain(
<span class="lineNum">     299 </span>            :     const ClientDownloadRequest_CertificateChain&amp; aChain);
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span>            :   // For signed binaries, generate strings of the form:
<span class="lineNum">     302 </span>            :   // http://sb-ssl.google.com/safebrowsing/csd/certificate/
<span class="lineNum">     303 </span>            :   //   &lt;issuer_cert_sha1_fingerprint&gt;[/CN=&lt;cn&gt;][/O=&lt;org&gt;][/OU=&lt;unit&gt;]
<span class="lineNum">     304 </span>            :   // for each (cert, issuer) pair in each chain of certificates that is
<span class="lineNum">     305 </span>            :   // associated with the binary.
<span class="lineNum">     306 </span>            :   nsresult GenerateWhitelistStrings();
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span>            :   // Parse the XPCOM certificate lists and stick them into the protocol buffer
<span class="lineNum">     309 </span>            :   // version.
<span class="lineNum">     310 </span>            :   nsresult ParseCertificates(nsIArray* aSigArray);
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span>            :   // Adds the redirects to mAnylistSpecs to be looked up.
<span class="lineNum">     313 </span>            :   nsresult AddRedirects(nsIArray* aRedirects);
<span class="lineNum">     314 </span>            : 
<span class="lineNum">     315 </span>            :   // Helper function to ensure that we call PendingLookup::LookupNext or
<span class="lineNum">     316 </span>            :   // PendingLookup::OnComplete.
<span class="lineNum">     317 </span>            :   nsresult DoLookupInternal();
<span class="lineNum">     318 </span>            : 
<span class="lineNum">     319 </span>            :   // Looks up all the URIs that may be responsible for allowlisting or
<span class="lineNum">     320 </span>            :   // blocklisting the downloaded file. These URIs may include whitelist strings
<span class="lineNum">     321 </span>            :   // generated by certificates verifying the binary as well as the target URI
<span class="lineNum">     322 </span>            :   // from which the file was downloaded.
<span class="lineNum">     323 </span>            :   nsresult LookupNext();
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span>            :   // Sends a query to the remote application reputation service. Returns NS_OK
<span class="lineNum">     326 </span>            :   // on success.
<span class="lineNum">     327 </span>            :   nsresult SendRemoteQuery();
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span>            :   // Helper function to ensure that we always call the callback.
<span class="lineNum">     330 </span>            :   nsresult SendRemoteQueryInternal();
<span class="lineNum">     331 </span>            : };
<span class="lineNum">     332 </span>            : 
<span class="lineNum">     333 </span>            : // A single-use class for looking up a single URI in the safebrowsing DB. This
<span class="lineNum">     334 </span>            : // class is private to PendingLookup.
<span class="lineNum">     335 </span>            : class PendingDBLookup final : public nsIUrlClassifierCallback
<span class="lineNum">     336 </span>            : {
<span class="lineNum">     337 </span>            : public:
<span class="lineNum">     338 </span>            :   NS_DECL_ISUPPORTS
<span class="lineNum">     339 </span>            :   NS_DECL_NSIURLCLASSIFIERCALLBACK
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span>            :   // Constructor and destructor
<span class="lineNum">     342 </span>            :   explicit PendingDBLookup(PendingLookup* aPendingLookup);
<span class="lineNum">     343 </span>            : 
<span class="lineNum">     344 </span>            :   // Look up the given URI in the safebrowsing DBs, optionally on both the allow
<span class="lineNum">     345 </span>            :   // list and the blocklist. If there is a match, call
<span class="lineNum">     346 </span>            :   // PendingLookup::OnComplete. Otherwise, call PendingLookup::LookupNext.
<span class="lineNum">     347 </span>            :   nsresult LookupSpec(const nsACString&amp; aSpec, bool aAllowlistOnly);
<span class="lineNum">     348 </span>            : 
<span class="lineNum">     349 </span>            : private:
<span class="lineNum">     350 </span>            :   ~PendingDBLookup();
<span class="lineNum">     351 </span>            : 
<span class="lineNum">     352 </span>            :   // The download appeared on the allowlist, blocklist, or no list (and thus
<span class="lineNum">     353 </span>            :   // could trigger a remote query.
<span class="lineNum">     354 </span>            :   enum LIST_TYPES {
<span class="lineNum">     355 </span>            :     ALLOW_LIST = 0,
<span class="lineNum">     356 </span>            :     BLOCK_LIST = 1,
<span class="lineNum">     357 </span>            :     NO_LIST = 2,
<span class="lineNum">     358 </span>            :   };
<span class="lineNum">     359 </span>            : 
<span class="lineNum">     360 </span>            :   nsCString mSpec;
<span class="lineNum">     361 </span>            :   bool mAllowlistOnly;
<span class="lineNum">     362 </span>            :   RefPtr&lt;PendingLookup&gt; mPendingLookup;
<span class="lineNum">     363 </span>            :   nsresult LookupSpecInternal(const nsACString&amp; aSpec);
<a name="364"><span class="lineNum">     364 </span>            : };</a>
<span class="lineNum">     365 </span>            : 
<span class="lineNum">     366 </span><span class="lineNoCov">          0 : NS_IMPL_ISUPPORTS(PendingDBLookup,</span>
<a name="367"><span class="lineNum">     367 </span>            :                   nsIUrlClassifierCallback)</a>
<span class="lineNum">     368 </span>            : 
<span class="lineNum">     369 </span><span class="lineNoCov">          0 : PendingDBLookup::PendingDBLookup(PendingLookup* aPendingLookup) :</span>
<span class="lineNum">     370 </span>            :   mAllowlistOnly(false),
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :   mPendingLookup(aPendingLookup)</span>
<span class="lineNum">     372 </span>            : {
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :   LOG((&quot;Created pending DB lookup [this = %p]&quot;, this));</span>
<a name="374"><span class="lineNum">     374 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     375 </span>            : 
<span class="lineNum">     376 </span><span class="lineNoCov">          0 : PendingDBLookup::~PendingDBLookup()</span>
<span class="lineNum">     377 </span>            : {
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :   LOG((&quot;Destroying pending DB lookup [this = %p]&quot;, this));</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :   mPendingLookup = nullptr;</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 : }</span>
<a name="381"><span class="lineNum">     381 </span>            : </a>
<span class="lineNum">     382 </span>            : nsresult
<span class="lineNum">     383 </span><span class="lineNoCov">          0 : PendingDBLookup::LookupSpec(const nsACString&amp; aSpec,</span>
<span class="lineNum">     384 </span>            :                             bool aAllowlistOnly)
<span class="lineNum">     385 </span>            : {
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :   LOG((&quot;Checking principal %s [this=%p]&quot;, aSpec.Data(), this));</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :   mSpec = aSpec;</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :   mAllowlistOnly = aAllowlistOnly;</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :   nsresult rv = LookupSpecInternal(aSpec);</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :     LOG((&quot;Error in LookupSpecInternal&quot;));</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :     return mPendingLookup-&gt;OnComplete(false, NS_OK);</span>
<span class="lineNum">     393 </span>            :   }
<span class="lineNum">     394 </span>            :   // LookupSpecInternal has called nsIUrlClassifierCallback.lookup, which is
<span class="lineNum">     395 </span>            :   // guaranteed to call HandleEvent.
<span class="lineNum">     396 </span>            :   return rv;
<span class="lineNum">     397 </span>            : }
<a name="398"><span class="lineNum">     398 </span>            : </a>
<span class="lineNum">     399 </span>            : nsresult
<span class="lineNum">     400 </span><span class="lineNoCov">          0 : PendingDBLookup::LookupSpecInternal(const nsACString&amp; aSpec)</span>
<span class="lineNum">     401 </span>            : {
<span class="lineNum">     402 </span>            :   nsresult rv;
<span class="lineNum">     403 </span>            : 
<span class="lineNum">     404 </span>            :   nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIIOService&gt; ios = do_GetService(NS_IOSERVICE_CONTRACTID, &amp;rv);</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :   rv = ios-&gt;NewURI(aSpec, nullptr, nullptr, getter_AddRefs(uri));</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     408 </span>            : 
<span class="lineNum">     409 </span>            :   OriginAttributes attrs;
<span class="lineNum">     410 </span>            :   nsCOMPtr&lt;nsIPrincipal&gt; principal =
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :     BasePrincipal::CreateCodebasePrincipal(uri, attrs);</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :   if (!principal) {</span>
<span class="lineNum">     413 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">     414 </span>            :   }
<span class="lineNum">     415 </span>            : 
<span class="lineNum">     416 </span>            :   // Check local lists to see if the URI has already been whitelisted or
<span class="lineNum">     417 </span>            :   // blacklisted.
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :   LOG((&quot;Checking DB service for principal %s [this = %p]&quot;, mSpec.get(), this));</span>
<span class="lineNum">     419 </span>            :   nsCOMPtr&lt;nsIUrlClassifierDBService&gt; dbService =
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :     do_GetService(NS_URLCLASSIFIERDBSERVICE_CONTRACTID, &amp;rv);</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :   nsAutoCString tables;</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :   nsAutoCString allowlist;</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :   Preferences::GetCString(PREF_DOWNLOAD_ALLOW_TABLE, &amp;allowlist);</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :   if (!allowlist.IsEmpty()) {</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :     tables.Append(allowlist);</span>
<span class="lineNum">     428 </span>            :   }
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :   nsAutoCString blocklist;</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :   Preferences::GetCString(PREF_DOWNLOAD_BLOCK_TABLE, &amp;blocklist);</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :   if (!mAllowlistOnly &amp;&amp; !blocklist.IsEmpty()) {</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :     tables.Append(',');</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :     tables.Append(blocklist);</span>
<span class="lineNum">     434 </span>            :   }
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :   return dbService-&gt;Lookup(principal, tables, this);</span>
<span class="lineNum">     436 </span>            : }
<a name="437"><span class="lineNum">     437 </span>            : </a>
<span class="lineNum">     438 </span>            : NS_IMETHODIMP
<span class="lineNum">     439 </span><span class="lineNoCov">          0 : PendingDBLookup::HandleEvent(const nsACString&amp; tables)</span>
<span class="lineNum">     440 </span>            : {
<span class="lineNum">     441 </span>            :   // HandleEvent is guaranteed to call either:
<span class="lineNum">     442 </span>            :   // 1) PendingLookup::OnComplete if the URL matches the blocklist, or
<span class="lineNum">     443 </span>            :   // 2) PendingLookup::LookupNext if the URL does not match the blocklist.
<span class="lineNum">     444 </span>            :   // Blocklisting trumps allowlisting.
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :   if (!mAllowlistOnly &amp;&amp; LookupTablesInPrefs(tables, PREF_DOWNLOAD_BLOCK_TABLE)) {</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :     mPendingLookup-&gt;mBlocklistCount++;</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :     Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_LOCAL, BLOCK_LIST);</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :     LOG((&quot;Found principal %s on blocklist [this = %p]&quot;, mSpec.get(), this));</span>
<span class="lineNum">     449 </span>            :     return mPendingLookup-&gt;OnComplete(true, NS_OK,
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :       nsIApplicationReputationService::VERDICT_DANGEROUS);</span>
<span class="lineNum">     451 </span>            :   }
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :   if (LookupTablesInPrefs(tables, PREF_DOWNLOAD_ALLOW_TABLE)) {</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :     mPendingLookup-&gt;mAllowlistCount++;</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :     Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_LOCAL, ALLOW_LIST);</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :     LOG((&quot;Found principal %s on allowlist [this = %p]&quot;, mSpec.get(), this));</span>
<span class="lineNum">     457 </span>            :     // Don't call onComplete, since blocklisting trumps allowlisting
<span class="lineNum">     458 </span>            :   } else {
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :     LOG((&quot;Didn't find principal %s on any list [this = %p]&quot;, mSpec.get(),</span>
<span class="lineNum">     460 </span>            :          this));
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :     Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_LOCAL, NO_LIST);</span>
<span class="lineNum">     462 </span>            :   }
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :   return mPendingLookup-&gt;LookupNext();</span>
<a name="464"><span class="lineNum">     464 </span>            : }</a>
<span class="lineNum">     465 </span>            : 
<span class="lineNum">     466 </span><span class="lineNoCov">          0 : NS_IMPL_ISUPPORTS(PendingLookup,</span>
<span class="lineNum">     467 </span>            :                   nsIStreamListener,
<span class="lineNum">     468 </span>            :                   nsIRequestObserver,
<span class="lineNum">     469 </span>            :                   nsIObserver,
<a name="470"><span class="lineNum">     470 </span>            :                   nsISupportsWeakReference)</a>
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span><span class="lineNoCov">          0 : PendingLookup::PendingLookup(nsIApplicationReputationQuery* aQuery,</span>
<span class="lineNum">     473 </span>            :                              nsIApplicationReputationCallback* aCallback) :
<span class="lineNum">     474 </span>            :   mBlocklistCount(0),
<span class="lineNum">     475 </span>            :   mAllowlistCount(0),
<span class="lineNum">     476 </span>            :   mQuery(aQuery),
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :   mCallback(aCallback)</span>
<span class="lineNum">     478 </span>            : {
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :   LOG((&quot;Created pending lookup [this = %p]&quot;, this));</span>
<a name="480"><span class="lineNum">     480 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     481 </span>            : 
<span class="lineNum">     482 </span><span class="lineNoCov">          0 : PendingLookup::~PendingLookup()</span>
<span class="lineNum">     483 </span>            : {
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :   LOG((&quot;Destroying pending lookup [this = %p]&quot;, this));</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     486 </span>            : 
<span class="lineNum">     487 </span>            : static const char16_t* const kBinaryFileExtensions[] = {
<span class="lineNum">     488 </span>            :     // Extracted from the &quot;File Type Policies&quot; Chrome extension
<span class="lineNum">     489 </span>            :     //u&quot;.001&quot;,
<span class="lineNum">     490 </span>            :     //u&quot;.7z&quot;,
<span class="lineNum">     491 </span>            :     //u&quot;.ace&quot;,
<span class="lineNum">     492 </span>            :     //u&quot;.action&quot;, // Mac script
<span class="lineNum">     493 </span>            :     //u&quot;.ad&quot;, // Windows
<span class="lineNum">     494 </span>            :     u&quot;.ade&quot;, // MS Access
<span class="lineNum">     495 </span>            :     u&quot;.adp&quot;, // MS Access
<span class="lineNum">     496 </span>            :     u&quot;.apk&quot;, // Android package
<span class="lineNum">     497 </span>            :     u&quot;.app&quot;, // Executable application
<span class="lineNum">     498 </span>            :     u&quot;.application&quot;, // MS ClickOnce
<span class="lineNum">     499 </span>            :     u&quot;.appref-ms&quot;, // MS ClickOnce
<span class="lineNum">     500 </span>            :     //u&quot;.arc&quot;,
<span class="lineNum">     501 </span>            :     //u&quot;.arj&quot;,
<span class="lineNum">     502 </span>            :     u&quot;.as&quot;, // Mac archive
<span class="lineNum">     503 </span>            :     u&quot;.asp&quot;, // Windows Server script
<span class="lineNum">     504 </span>            :     u&quot;.asx&quot;, // Windows Media Player
<span class="lineNum">     505 </span>            :     //u&quot;.b64&quot;,
<span class="lineNum">     506 </span>            :     //u&quot;.balz&quot;,
<span class="lineNum">     507 </span>            :     u&quot;.bas&quot;, // Basic script
<span class="lineNum">     508 </span>            :     u&quot;.bash&quot;, // Linux shell
<span class="lineNum">     509 </span>            :     u&quot;.bat&quot;, // Windows shell
<span class="lineNum">     510 </span>            :     //u&quot;.bhx&quot;,
<span class="lineNum">     511 </span>            :     //u&quot;.bin&quot;,
<span class="lineNum">     512 </span>            :     u&quot;.bz&quot;, // Linux archive (bzip)
<span class="lineNum">     513 </span>            :     u&quot;.bz2&quot;, // Linux archive (bzip2)
<span class="lineNum">     514 </span>            :     u&quot;.bzip2&quot;, // Linux archive (bzip2)
<span class="lineNum">     515 </span>            :     u&quot;.cab&quot;, // Windows archive
<span class="lineNum">     516 </span>            :     u&quot;.cdr&quot;, // Mac disk image
<span class="lineNum">     517 </span>            :     u&quot;.cfg&quot;, // Windows
<span class="lineNum">     518 </span>            :     u&quot;.chi&quot;, // Windows Help
<span class="lineNum">     519 </span>            :     u&quot;.chm&quot;, // Windows Help
<span class="lineNum">     520 </span>            :     u&quot;.class&quot;, // Java
<span class="lineNum">     521 </span>            :     u&quot;.cmd&quot;, // Windows executable
<span class="lineNum">     522 </span>            :     u&quot;.com&quot;, // Windows executable
<span class="lineNum">     523 </span>            :     u&quot;.command&quot;, // Mac script
<span class="lineNum">     524 </span>            :     u&quot;.cpgz&quot;, // Mac archive
<span class="lineNum">     525 </span>            :     //u&quot;.cpio&quot;,
<span class="lineNum">     526 </span>            :     u&quot;.cpl&quot;, // Windows executable
<span class="lineNum">     527 </span>            :     u&quot;.crt&quot;, // Windows signed certificate
<span class="lineNum">     528 </span>            :     u&quot;.crx&quot;, // Chrome extensions
<span class="lineNum">     529 </span>            :     u&quot;.csh&quot;, // Linux shell
<span class="lineNum">     530 </span>            :     u&quot;.dart&quot;, // Mac disk image
<span class="lineNum">     531 </span>            :     u&quot;.dc42&quot;, // Apple DiskCopy Image
<span class="lineNum">     532 </span>            :     u&quot;.deb&quot;, // Linux package
<span class="lineNum">     533 </span>            :     u&quot;.dex&quot;, // Android
<span class="lineNum">     534 </span>            :     u&quot;.diskcopy42&quot;, // Apple DiskCopy Image
<span class="lineNum">     535 </span>            :     u&quot;.dll&quot;, // Windows executable
<span class="lineNum">     536 </span>            :     u&quot;.dmg&quot;, // Mac disk image
<span class="lineNum">     537 </span>            :     u&quot;.dmgpart&quot;, // Mac disk image
<span class="lineNum">     538 </span>            :     //u&quot;.docb&quot;, // MS Office
<span class="lineNum">     539 </span>            :     //u&quot;.docm&quot;, // MS Word
<span class="lineNum">     540 </span>            :     //u&quot;.docx&quot;, // MS Word
<span class="lineNum">     541 </span>            :     //u&quot;.dotm&quot;, // MS Word
<span class="lineNum">     542 </span>            :     //u&quot;.dott&quot;, // MS Office
<span class="lineNum">     543 </span>            :     u&quot;.drv&quot;, // Windows driver
<span class="lineNum">     544 </span>            :     u&quot;.dvdr&quot;, // Mac Disk image
<span class="lineNum">     545 </span>            :     u&quot;.efi&quot;, // Firmware
<span class="lineNum">     546 </span>            :     u&quot;.eml&quot;, // MS Outlook
<span class="lineNum">     547 </span>            :     u&quot;.exe&quot;, // Windows executable
<span class="lineNum">     548 </span>            :     //u&quot;.fat&quot;,
<span class="lineNum">     549 </span>            :     u&quot;.fon&quot;, // Windows font
<span class="lineNum">     550 </span>            :     u&quot;.fxp&quot;, // MS FoxPro
<span class="lineNum">     551 </span>            :     u&quot;.gadget&quot;, // Windows
<span class="lineNum">     552 </span>            :     u&quot;.grp&quot;, // Windows
<span class="lineNum">     553 </span>            :     u&quot;.gz&quot;, // Linux archive (gzip)
<span class="lineNum">     554 </span>            :     u&quot;.gzip&quot;, // Linux archive (gzip)
<span class="lineNum">     555 </span>            :     u&quot;.hfs&quot;, // Mac disk image
<span class="lineNum">     556 </span>            :     u&quot;.hlp&quot;, // Windows Help
<span class="lineNum">     557 </span>            :     u&quot;.hqx&quot;, // Mac archive
<span class="lineNum">     558 </span>            :     u&quot;.hta&quot;, // HTML trusted application
<span class="lineNum">     559 </span>            :     u&quot;.htt&quot;, // MS HTML template
<span class="lineNum">     560 </span>            :     u&quot;.img&quot;, // Mac disk image
<span class="lineNum">     561 </span>            :     u&quot;.imgpart&quot;, // Mac disk image
<span class="lineNum">     562 </span>            :     u&quot;.inf&quot;, // Windows installer
<span class="lineNum">     563 </span>            :     u&quot;.ini&quot;, // Generic config file
<span class="lineNum">     564 </span>            :     u&quot;.ins&quot;, // IIS config
<span class="lineNum">     565 </span>            :     //u&quot;.inx&quot;, // InstallShield
<span class="lineNum">     566 </span>            :     u&quot;.iso&quot;, // CD image
<span class="lineNum">     567 </span>            :     u&quot;.isp&quot;, // IIS config
<span class="lineNum">     568 </span>            :     //u&quot;.isu&quot;, // InstallShield
<span class="lineNum">     569 </span>            :     u&quot;.jar&quot;, // Java
<span class="lineNum">     570 </span>            :     u&quot;.jnlp&quot;, // Java
<span class="lineNum">     571 </span>            :     //u&quot;.job&quot;, // Windows
<span class="lineNum">     572 </span>            :     u&quot;.js&quot;, // JavaScript script
<span class="lineNum">     573 </span>            :     u&quot;.jse&quot;, // JScript
<span class="lineNum">     574 </span>            :     u&quot;.ksh&quot;, // Linux shell
<span class="lineNum">     575 </span>            :     //u&quot;.lha&quot;,
<span class="lineNum">     576 </span>            :     u&quot;.lnk&quot;, // Windows
<span class="lineNum">     577 </span>            :     u&quot;.local&quot;, // Windows
<span class="lineNum">     578 </span>            :     //u&quot;.lpaq1&quot;,
<span class="lineNum">     579 </span>            :     //u&quot;.lpaq5&quot;,
<span class="lineNum">     580 </span>            :     //u&quot;.lpaq8&quot;,
<span class="lineNum">     581 </span>            :     //u&quot;.lzh&quot;,
<span class="lineNum">     582 </span>            :     //u&quot;.lzma&quot;,
<span class="lineNum">     583 </span>            :     u&quot;.mad&quot;, // MS Access
<span class="lineNum">     584 </span>            :     u&quot;.maf&quot;, // MS Access
<span class="lineNum">     585 </span>            :     u&quot;.mag&quot;, // MS Access
<span class="lineNum">     586 </span>            :     u&quot;.mam&quot;, // MS Access
<span class="lineNum">     587 </span>            :     u&quot;.manifest&quot;, // Windows
<span class="lineNum">     588 </span>            :     u&quot;.maq&quot;, // MS Access
<span class="lineNum">     589 </span>            :     u&quot;.mar&quot;, // MS Access
<span class="lineNum">     590 </span>            :     u&quot;.mas&quot;, // MS Access
<span class="lineNum">     591 </span>            :     u&quot;.mat&quot;, // MS Access
<span class="lineNum">     592 </span>            :     u&quot;.mau&quot;, // Media attachment
<span class="lineNum">     593 </span>            :     u&quot;.mav&quot;, // MS Access
<span class="lineNum">     594 </span>            :     u&quot;.maw&quot;, // MS Access
<span class="lineNum">     595 </span>            :     u&quot;.mda&quot;, // MS Access
<span class="lineNum">     596 </span>            :     u&quot;.mdb&quot;, // MS Access
<span class="lineNum">     597 </span>            :     u&quot;.mde&quot;, // MS Access
<span class="lineNum">     598 </span>            :     u&quot;.mdt&quot;, // MS Access
<span class="lineNum">     599 </span>            :     u&quot;.mdw&quot;, // MS Access
<span class="lineNum">     600 </span>            :     u&quot;.mdz&quot;, // MS Access
<span class="lineNum">     601 </span>            :     u&quot;.mht&quot;, // MS HTML
<span class="lineNum">     602 </span>            :     u&quot;.mhtml&quot;, // MS HTML
<span class="lineNum">     603 </span>            :     u&quot;.mim&quot;, // MS Mail
<span class="lineNum">     604 </span>            :     u&quot;.mmc&quot;, // MS Office
<span class="lineNum">     605 </span>            :     u&quot;.mof&quot;, // Windows
<span class="lineNum">     606 </span>            :     u&quot;.mpkg&quot;, // Mac installer
<span class="lineNum">     607 </span>            :     u&quot;.msc&quot;, // Windows executable
<span class="lineNum">     608 </span>            :     u&quot;.msg&quot;, // MS Outlook
<span class="lineNum">     609 </span>            :     u&quot;.msh&quot;, // Windows shell
<span class="lineNum">     610 </span>            :     u&quot;.msh1&quot;, // Windows shell
<span class="lineNum">     611 </span>            :     u&quot;.msh1xml&quot;, // Windows shell
<span class="lineNum">     612 </span>            :     u&quot;.msh2&quot;, // Windows shell
<span class="lineNum">     613 </span>            :     u&quot;.msh2xml&quot;, // Windows shell
<span class="lineNum">     614 </span>            :     u&quot;.mshxml&quot;, // Windows
<span class="lineNum">     615 </span>            :     u&quot;.msi&quot;, // Windows installer
<span class="lineNum">     616 </span>            :     u&quot;.msp&quot;, // Windows installer
<span class="lineNum">     617 </span>            :     u&quot;.mst&quot;, // Windows installer
<span class="lineNum">     618 </span>            :     u&quot;.ndif&quot;, // Mac disk image
<span class="lineNum">     619 </span>            :     //u&quot;.ntfs&quot;, // 7z
<span class="lineNum">     620 </span>            :     u&quot;.ocx&quot;, // ActiveX
<span class="lineNum">     621 </span>            :     u&quot;.ops&quot;, // MS Office
<span class="lineNum">     622 </span>            :     //u&quot;.out&quot;, // Linux binary
<span class="lineNum">     623 </span>            :     //u&quot;.paf&quot;, // PortableApps package
<span class="lineNum">     624 </span>            :     //u&quot;.paq8f&quot;,
<span class="lineNum">     625 </span>            :     //u&quot;.paq8jd&quot;,
<span class="lineNum">     626 </span>            :     //u&quot;.paq8l&quot;,
<span class="lineNum">     627 </span>            :     //u&quot;.paq8o&quot;,
<span class="lineNum">     628 </span>            :     u&quot;.partial&quot;, // Downloads
<span class="lineNum">     629 </span>            :     u&quot;.pax&quot;, // Mac archive
<span class="lineNum">     630 </span>            :     u&quot;.pcd&quot;, // Microsoft Visual Test
<span class="lineNum">     631 </span>            :     u&quot;.pdf&quot;, // Adobe Acrobat
<span class="lineNum">     632 </span>            :     //u&quot;.pea&quot;,
<span class="lineNum">     633 </span>            :     u&quot;.pet&quot;, // Linux package
<span class="lineNum">     634 </span>            :     u&quot;.pif&quot;, // Windows
<span class="lineNum">     635 </span>            :     u&quot;.pkg&quot;, // Mac installer
<span class="lineNum">     636 </span>            :     u&quot;.pl&quot;, // Perl script
<span class="lineNum">     637 </span>            :     u&quot;.plg&quot;, // MS Visual Studio
<span class="lineNum">     638 </span>            :     //u&quot;.potx&quot;, // MS PowerPoint
<span class="lineNum">     639 </span>            :     //u&quot;.ppam&quot;, // MS PowerPoint
<span class="lineNum">     640 </span>            :     //u&quot;.ppsx&quot;, // MS PowerPoint
<span class="lineNum">     641 </span>            :     //u&quot;.pptm&quot;, // MS PowerPoint
<span class="lineNum">     642 </span>            :     //u&quot;.pptx&quot;, // MS PowerPoint
<span class="lineNum">     643 </span>            :     u&quot;.prf&quot;, // MS Outlook
<span class="lineNum">     644 </span>            :     u&quot;.prg&quot;, // Windows
<span class="lineNum">     645 </span>            :     u&quot;.ps1&quot;, // Windows shell
<span class="lineNum">     646 </span>            :     u&quot;.ps1xml&quot;, // Windows shell
<span class="lineNum">     647 </span>            :     u&quot;.ps2&quot;, // Windows shell
<span class="lineNum">     648 </span>            :     u&quot;.ps2xml&quot;, // Windows shell
<span class="lineNum">     649 </span>            :     u&quot;.psc1&quot;, // Windows shell
<span class="lineNum">     650 </span>            :     u&quot;.psc2&quot;, // Windows shell
<span class="lineNum">     651 </span>            :     u&quot;.pst&quot;, // MS Outlook
<span class="lineNum">     652 </span>            :     u&quot;.pup&quot;, // Linux package
<span class="lineNum">     653 </span>            :     u&quot;.py&quot;, // Python script
<span class="lineNum">     654 </span>            :     u&quot;.pyc&quot;, // Python binary
<span class="lineNum">     655 </span>            :     u&quot;.pyw&quot;, // Python GUI
<span class="lineNum">     656 </span>            :     //u&quot;.quad&quot;,
<span class="lineNum">     657 </span>            :     //u&quot;.r00&quot;,
<span class="lineNum">     658 </span>            :     //u&quot;.r01&quot;,
<span class="lineNum">     659 </span>            :     //u&quot;.r02&quot;,
<span class="lineNum">     660 </span>            :     //u&quot;.r03&quot;,
<span class="lineNum">     661 </span>            :     //u&quot;.r04&quot;,
<span class="lineNum">     662 </span>            :     //u&quot;.r05&quot;,
<span class="lineNum">     663 </span>            :     //u&quot;.r06&quot;,
<span class="lineNum">     664 </span>            :     //u&quot;.r07&quot;,
<span class="lineNum">     665 </span>            :     //u&quot;.r08&quot;,
<span class="lineNum">     666 </span>            :     //u&quot;.r09&quot;,
<span class="lineNum">     667 </span>            :     //u&quot;.r10&quot;,
<span class="lineNum">     668 </span>            :     //u&quot;.r11&quot;,
<span class="lineNum">     669 </span>            :     //u&quot;.r12&quot;,
<span class="lineNum">     670 </span>            :     //u&quot;.r13&quot;,
<span class="lineNum">     671 </span>            :     //u&quot;.r14&quot;,
<span class="lineNum">     672 </span>            :     //u&quot;.r15&quot;,
<span class="lineNum">     673 </span>            :     //u&quot;.r16&quot;,
<span class="lineNum">     674 </span>            :     //u&quot;.r17&quot;,
<span class="lineNum">     675 </span>            :     //u&quot;.r18&quot;,
<span class="lineNum">     676 </span>            :     //u&quot;.r19&quot;,
<span class="lineNum">     677 </span>            :     //u&quot;.r20&quot;,
<span class="lineNum">     678 </span>            :     //u&quot;.r21&quot;,
<span class="lineNum">     679 </span>            :     //u&quot;.r22&quot;,
<span class="lineNum">     680 </span>            :     //u&quot;.r23&quot;,
<span class="lineNum">     681 </span>            :     //u&quot;.r24&quot;,
<span class="lineNum">     682 </span>            :     //u&quot;.r25&quot;,
<span class="lineNum">     683 </span>            :     //u&quot;.r26&quot;,
<span class="lineNum">     684 </span>            :     //u&quot;.r27&quot;,
<span class="lineNum">     685 </span>            :     //u&quot;.r28&quot;,
<span class="lineNum">     686 </span>            :     //u&quot;.r29&quot;,
<span class="lineNum">     687 </span>            :     //u&quot;.rar&quot;,
<span class="lineNum">     688 </span>            :     u&quot;.rb&quot;, // Ruby script
<span class="lineNum">     689 </span>            :     u&quot;.reg&quot;, // Windows Registry
<span class="lineNum">     690 </span>            :     u&quot;.rels&quot;, // MS Office
<span class="lineNum">     691 </span>            :     //u&quot;.rgs&quot;, // Windows Registry
<span class="lineNum">     692 </span>            :     u&quot;.rpm&quot;, // Linux package
<span class="lineNum">     693 </span>            :     //u&quot;.rtf&quot;, // MS Office
<span class="lineNum">     694 </span>            :     //u&quot;.run&quot;, // Linux shell
<span class="lineNum">     695 </span>            :     u&quot;.scf&quot;, // Windows shell
<span class="lineNum">     696 </span>            :     u&quot;.scr&quot;, // Windows
<span class="lineNum">     697 </span>            :     u&quot;.sct&quot;, // Windows shell
<span class="lineNum">     698 </span>            :     u&quot;.search-ms&quot;, // Windows
<span class="lineNum">     699 </span>            :     u&quot;.sh&quot;, // Linux shell
<span class="lineNum">     700 </span>            :     u&quot;.shar&quot;, // Linux shell
<span class="lineNum">     701 </span>            :     u&quot;.shb&quot;, // Windows
<span class="lineNum">     702 </span>            :     u&quot;.shs&quot;, // Windows shell
<span class="lineNum">     703 </span>            :     //u&quot;.sldm&quot;, // MS PowerPoint
<span class="lineNum">     704 </span>            :     //u&quot;.sldx&quot;, // MS PowerPoint
<span class="lineNum">     705 </span>            :     u&quot;.slp&quot;, // Linux package
<span class="lineNum">     706 </span>            :     u&quot;.smi&quot;, // Mac disk image
<span class="lineNum">     707 </span>            :     u&quot;.sparsebundle&quot;, // Mac disk image
<span class="lineNum">     708 </span>            :     u&quot;.sparseimage&quot;, // Mac disk image
<span class="lineNum">     709 </span>            :     u&quot;.spl&quot;, // Adobe Flash
<span class="lineNum">     710 </span>            :     //u&quot;.squashfs&quot;,
<span class="lineNum">     711 </span>            :     u&quot;.svg&quot;,
<span class="lineNum">     712 </span>            :     u&quot;.swf&quot;, // Adobe Flash
<span class="lineNum">     713 </span>            :     u&quot;.swm&quot;, // Windows Imaging
<span class="lineNum">     714 </span>            :     u&quot;.sys&quot;, // Windows
<span class="lineNum">     715 </span>            :     u&quot;.tar&quot;, // Linux archive
<span class="lineNum">     716 </span>            :     u&quot;.taz&quot;, // Linux archive (bzip2)
<span class="lineNum">     717 </span>            :     u&quot;.tbz&quot;, // Linux archive (bzip2)
<span class="lineNum">     718 </span>            :     u&quot;.tbz2&quot;, // Linux archive (bzip2)
<span class="lineNum">     719 </span>            :     u&quot;.tcsh&quot;, // Linux shell
<span class="lineNum">     720 </span>            :     u&quot;.tgz&quot;, // Linux archive (gzip)
<span class="lineNum">     721 </span>            :     //u&quot;.toast&quot;, // Roxio disk image
<span class="lineNum">     722 </span>            :     //u&quot;.torrent&quot;, // Bittorrent
<span class="lineNum">     723 </span>            :     u&quot;.tpz&quot;, // Linux archive (gzip)
<span class="lineNum">     724 </span>            :     u&quot;.txz&quot;, // Linux archive (xz)
<span class="lineNum">     725 </span>            :     u&quot;.tz&quot;, // Linux archive (gzip)
<span class="lineNum">     726 </span>            :     //u&quot;.u3p&quot;, // U3 Smart Apps
<span class="lineNum">     727 </span>            :     u&quot;.udf&quot;, // MS Excel
<span class="lineNum">     728 </span>            :     u&quot;.udif&quot;, // Mac disk image
<span class="lineNum">     729 </span>            :     u&quot;.url&quot;, // Windows
<span class="lineNum">     730 </span>            :     //u&quot;.uu&quot;,
<span class="lineNum">     731 </span>            :     //u&quot;.uue&quot;,
<span class="lineNum">     732 </span>            :     u&quot;.vb&quot;, // Visual Basic script
<span class="lineNum">     733 </span>            :     u&quot;.vbe&quot;, // Visual Basic script
<span class="lineNum">     734 </span>            :     u&quot;.vbs&quot;, // Visual Basic script
<span class="lineNum">     735 </span>            :     //u&quot;.vbscript&quot;, // Visual Basic script
<span class="lineNum">     736 </span>            :     u&quot;.vhd&quot;, // Windows virtual hard drive
<span class="lineNum">     737 </span>            :     u&quot;.vhdx&quot;, // Windows virtual hard drive
<span class="lineNum">     738 </span>            :     u&quot;.vmdk&quot;, // VMware virtual disk
<span class="lineNum">     739 </span>            :     u&quot;.vsd&quot;, // MS Visio
<span class="lineNum">     740 </span>            :     u&quot;.vsmacros&quot;, // MS Visual Studio
<span class="lineNum">     741 </span>            :     u&quot;.vss&quot;, // MS Visio
<span class="lineNum">     742 </span>            :     u&quot;.vst&quot;, // MS Visio
<span class="lineNum">     743 </span>            :     u&quot;.vsw&quot;, // MS Visio
<span class="lineNum">     744 </span>            :     u&quot;.website&quot;,  // Windows
<span class="lineNum">     745 </span>            :     u&quot;.wim&quot;, // Windows Imaging
<span class="lineNum">     746 </span>            :     //u&quot;.workflow&quot;, // Mac Automator
<span class="lineNum">     747 </span>            :     //u&quot;.wrc&quot;, // FreeArc archive
<span class="lineNum">     748 </span>            :     u&quot;.ws&quot;, // Windows script
<span class="lineNum">     749 </span>            :     u&quot;.wsc&quot;, // Windows script
<span class="lineNum">     750 </span>            :     u&quot;.wsf&quot;, // Windows script
<span class="lineNum">     751 </span>            :     u&quot;.wsh&quot;, // Windows script
<span class="lineNum">     752 </span>            :     u&quot;.xar&quot;, // MS Excel
<span class="lineNum">     753 </span>            :     u&quot;.xbap&quot;, // XAML Browser Application
<span class="lineNum">     754 </span>            :     u&quot;.xip&quot;, // Mac archive
<span class="lineNum">     755 </span>            :     //u&quot;.xlsm&quot;, // MS Excel
<span class="lineNum">     756 </span>            :     //u&quot;.xlsx&quot;, // MS Excel
<span class="lineNum">     757 </span>            :     //u&quot;.xltm&quot;, // MS Excel
<span class="lineNum">     758 </span>            :     //u&quot;.xltx&quot;, // MS Excel
<span class="lineNum">     759 </span>            :     u&quot;.xml&quot;,
<span class="lineNum">     760 </span>            :     u&quot;.xnk&quot;, // MS Exchange
<span class="lineNum">     761 </span>            :     u&quot;.xrm-ms&quot;, // Windows
<span class="lineNum">     762 </span>            :     u&quot;.xsl&quot;, // XML Stylesheet
<span class="lineNum">     763 </span>            :     //u&quot;.xxe&quot;,
<span class="lineNum">     764 </span>            :     u&quot;.xz&quot;, // Linux archive (xz)
<span class="lineNum">     765 </span>            :     u&quot;.z&quot;, // InstallShield
<span class="lineNum">     766 </span>            : #ifdef XP_WIN // disable on Mac/Linux, see 1167493
<span class="lineNum">     767 </span>            :     u&quot;.zip&quot;, // Generic archive
<span class="lineNum">     768 </span>            : #endif
<span class="lineNum">     769 </span>            :     u&quot;.zipx&quot;, // WinZip
<span class="lineNum">     770 </span>            :     //u&quot;.zpaq&quot;,
<span class="lineNum">     771 </span>            : };
<a name="772"><span class="lineNum">     772 </span>            : </a>
<span class="lineNum">     773 </span>            : bool
<span class="lineNum">     774 </span><span class="lineNoCov">          0 : PendingLookup::IsBinaryFile()</span>
<span class="lineNum">     775 </span>            : {
<span class="lineNum">     776 </span>            :   nsString fileName;
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :   nsresult rv = mQuery-&gt;GetSuggestedFileName(fileName);</span>
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :     LOG((&quot;No suggested filename [this = %p]&quot;, this));</span>
<span class="lineNum">     780 </span>            :     return false;
<span class="lineNum">     781 </span>            :   }
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :   LOG((&quot;Suggested filename: %s [this = %p]&quot;,</span>
<span class="lineNum">     783 </span>            :        NS_ConvertUTF16toUTF8(fileName).get(), this));
<span class="lineNum">     784 </span>            : 
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :   for (size_t i = 0; i &lt; ArrayLength(kBinaryFileExtensions); ++i) {</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :     if (StringEndsWith(fileName, nsDependentString(kBinaryFileExtensions[i]))) {</span>
<span class="lineNum">     787 </span>            :       return true;
<span class="lineNum">     788 </span>            :     }
<span class="lineNum">     789 </span>            :   }
<span class="lineNum">     790 </span>            : 
<span class="lineNum">     791 </span>            :   return false;
<span class="lineNum">     792 </span>            : }
<a name="793"><span class="lineNum">     793 </span>            : </a>
<span class="lineNum">     794 </span>            : ClientDownloadRequest::DownloadType
<span class="lineNum">     795 </span><span class="lineNoCov">          0 : PendingLookup::GetDownloadType(const nsAString&amp; aFilename) {</span>
<span class="lineNum">     796 </span>            :   MOZ_ASSERT(IsBinaryFile());
<span class="lineNum">     797 </span>            : 
<span class="lineNum">     798 </span>            :   // From https://cs.chromium.org/chromium/src/chrome/common/safe_browsing/download_protection_util.cc?l=17
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :   if (StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.zip&quot;))) {</span>
<span class="lineNum">     800 </span>            :     return ClientDownloadRequest::ZIPPED_EXECUTABLE;
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :   } else if (StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.apk&quot;))) {</span>
<span class="lineNum">     802 </span>            :     return ClientDownloadRequest::ANDROID_APK;
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :   } else if (StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.app&quot;)) ||</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.cdr&quot;)) ||</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.dart&quot;)) ||</span>
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.dc42&quot;)) ||</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.diskcopy42&quot;)) ||</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.dmg&quot;)) ||</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.dmgpart&quot;)) ||</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.dvdr&quot;)) ||</span>
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.img&quot;)) ||</span>
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.imgpart&quot;)) ||</span>
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.iso&quot;)) ||</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.mpkg&quot;)) ||</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.ndif&quot;)) ||</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.pkg&quot;)) ||</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.smi&quot;)) ||</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.sparsebundle&quot;)) ||</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.sparseimage&quot;)) ||</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.toast&quot;)) ||</span>
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :              StringEndsWith(aFilename, NS_LITERAL_STRING(&quot;.udif&quot;))) {</span>
<span class="lineNum">     822 </span>            :     return ClientDownloadRequest::MAC_EXECUTABLE;
<span class="lineNum">     823 </span>            :   }
<span class="lineNum">     824 </span>            : 
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :   return ClientDownloadRequest::WIN_EXECUTABLE; // default to Windows binaries</span>
<span class="lineNum">     826 </span>            : }
<a name="827"><span class="lineNum">     827 </span>            : </a>
<span class="lineNum">     828 </span>            : nsresult
<span class="lineNum">     829 </span><span class="lineNoCov">          0 : PendingLookup::LookupNext()</span>
<span class="lineNum">     830 </span>            : {
<span class="lineNum">     831 </span>            :   // We must call LookupNext or SendRemoteQuery upon return.
<span class="lineNum">     832 </span>            :   // Look up all of the URLs that could allow or block this download.
<span class="lineNum">     833 </span>            :   // Blocklist first.
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :   if (mBlocklistCount &gt; 0) {</span>
<span class="lineNum">     835 </span>            :     return OnComplete(true, NS_OK,
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :                       nsIApplicationReputationService::VERDICT_DANGEROUS);</span>
<span class="lineNum">     837 </span>            :   }
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :   int index = mAnylistSpecs.Length() - 1;</span>
<span class="lineNum">     839 </span>            :   nsCString spec;
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :   if (index &gt;= 0) {</span>
<span class="lineNum">     841 </span>            :     // Check the source URI, referrer and redirect chain.
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :     spec = mAnylistSpecs[index];</span>
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :     mAnylistSpecs.RemoveElementAt(index);</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :     RefPtr&lt;PendingDBLookup&gt; lookup(new PendingDBLookup(this));</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :     return lookup-&gt;LookupSpec(spec, false);</span>
<span class="lineNum">     846 </span>            :   }
<span class="lineNum">     847 </span>            :   // If any of mAnylistSpecs matched the blocklist, go ahead and block.
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :   if (mBlocklistCount &gt; 0) {</span>
<span class="lineNum">     849 </span>            :     return OnComplete(true, NS_OK,
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :                       nsIApplicationReputationService::VERDICT_DANGEROUS);</span>
<span class="lineNum">     851 </span>            :   }
<span class="lineNum">     852 </span>            :   // If any of mAnylistSpecs matched the allowlist, go ahead and pass.
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :   if (mAllowlistCount &gt; 0) {</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :     return OnComplete(false, NS_OK);</span>
<span class="lineNum">     855 </span>            :   }
<span class="lineNum">     856 </span>            :   // Only binary signatures remain.
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :   index = mAllowlistSpecs.Length() - 1;</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :   if (index &gt;= 0) {</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :     spec = mAllowlistSpecs[index];</span>
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :     LOG((&quot;PendingLookup::LookupNext: checking %s on allowlist&quot;, spec.get()));</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :     mAllowlistSpecs.RemoveElementAt(index);</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :     RefPtr&lt;PendingDBLookup&gt; lookup(new PendingDBLookup(this));</span>
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :     return lookup-&gt;LookupSpec(spec, true);</span>
<span class="lineNum">     864 </span>            :   }
<span class="lineNum">     865 </span>            :   // There are no more URIs to check against local list. If the file is
<span class="lineNum">     866 </span>            :   // not eligible for remote lookup, bail.
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :   if (!IsBinaryFile()) {</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :     LOG((&quot;Not eligible for remote lookups [this=%p]&quot;, this));</span>
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :     return OnComplete(false, NS_OK);</span>
<span class="lineNum">     870 </span>            :   }
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :   nsresult rv = SendRemoteQuery();</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :     return OnComplete(false, rv);</span>
<span class="lineNum">     874 </span>            :   }
<span class="lineNum">     875 </span>            :   return NS_OK;
<span class="lineNum">     876 </span>            : }
<a name="877"><span class="lineNum">     877 </span>            : </a>
<span class="lineNum">     878 </span>            : nsCString
<span class="lineNum">     879 </span><span class="lineNoCov">          0 : PendingLookup::EscapeCertificateAttribute(const nsACString&amp; aAttribute)</span>
<span class="lineNum">     880 </span>            : {
<span class="lineNum">     881 </span>            :   // Escape '/' because it's a field separator, and '%' because Chrome does
<span class="lineNum">     882 </span>            :   nsCString escaped;
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :   escaped.SetCapacity(aAttribute.Length());</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :   for (unsigned int i = 0; i &lt; aAttribute.Length(); ++i) {</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :     if (aAttribute.Data()[i] == '%') {</span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :       escaped.AppendLiteral(&quot;%25&quot;);</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :     } else if (aAttribute.Data()[i] == '/') {</span>
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :       escaped.AppendLiteral(&quot;%2F&quot;);</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :     } else if (aAttribute.Data()[i] == ' ') {</span>
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :       escaped.AppendLiteral(&quot;%20&quot;);</span>
<span class="lineNum">     891 </span>            :     } else {
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :       escaped.Append(aAttribute.Data()[i]);</span>
<span class="lineNum">     893 </span>            :     }
<span class="lineNum">     894 </span>            :   }
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :   return escaped;</span>
<span class="lineNum">     896 </span>            : }
<a name="897"><span class="lineNum">     897 </span>            : </a>
<span class="lineNum">     898 </span>            : nsCString
<span class="lineNum">     899 </span><span class="lineNoCov">          0 : PendingLookup::EscapeFingerprint(const nsACString&amp; aFingerprint)</span>
<span class="lineNum">     900 </span>            : {
<span class="lineNum">     901 </span>            :   // Google's fingerprint doesn't have colons
<span class="lineNum">     902 </span>            :   nsCString escaped;
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :   escaped.SetCapacity(aFingerprint.Length());</span>
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :   for (unsigned int i = 0; i &lt; aFingerprint.Length(); ++i) {</span>
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :     if (aFingerprint.Data()[i] != ':') {</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :       escaped.Append(aFingerprint.Data()[i]);</span>
<span class="lineNum">     907 </span>            :     }
<span class="lineNum">     908 </span>            :   }
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :   return escaped;</span>
<span class="lineNum">     910 </span>            : }
<a name="911"><span class="lineNum">     911 </span>            : </a>
<span class="lineNum">     912 </span>            : nsresult
<span class="lineNum">     913 </span><span class="lineNoCov">          0 : PendingLookup::GenerateWhitelistStringsForPair(</span>
<span class="lineNum">     914 </span>            :   nsIX509Cert* certificate,
<span class="lineNum">     915 </span>            :   nsIX509Cert* issuer)
<span class="lineNum">     916 </span>            : {
<span class="lineNum">     917 </span>            :   // The whitelist paths have format:
<span class="lineNum">     918 </span>            :   // http://sb-ssl.google.com/safebrowsing/csd/certificate/&lt;issuer_cert_fingerprint&gt;[/CN=&lt;cn&gt;][/O=&lt;org&gt;][/OU=&lt;unit&gt;]
<span class="lineNum">     919 </span>            :   // Any of CN, O, or OU may be omitted from the whitelist entry. Unfortunately
<span class="lineNum">     920 </span>            :   // this is not publicly documented, but the Chrome implementation can be found
<span class="lineNum">     921 </span>            :   // here:
<span class="lineNum">     922 </span>            :   // https://code.google.com/p/chromium/codesearch#search/&amp;q=GetCertificateWhitelistStrings
<span class="lineNum">     923 </span>            :   nsCString whitelistString(
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :     &quot;http://sb-ssl.google.com/safebrowsing/csd/certificate/&quot;);</span>
<span class="lineNum">     925 </span>            : 
<span class="lineNum">     926 </span>            :   nsString fingerprint;
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :   nsresult rv = issuer-&gt;GetSha1Fingerprint(fingerprint);</span>
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     929 </span>            :   whitelistString.Append(
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :     EscapeFingerprint(NS_ConvertUTF16toUTF8(fingerprint)));</span>
<span class="lineNum">     931 </span>            : 
<span class="lineNum">     932 </span>            :   nsString commonName;
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :   rv = certificate-&gt;GetCommonName(commonName);</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :   if (!commonName.IsEmpty()) {</span>
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :     whitelistString.AppendLiteral(&quot;/CN=&quot;);</span>
<span class="lineNum">     937 </span>            :     whitelistString.Append(
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :       EscapeCertificateAttribute(NS_ConvertUTF16toUTF8(commonName)));</span>
<span class="lineNum">     939 </span>            :   }
<span class="lineNum">     940 </span>            : 
<span class="lineNum">     941 </span>            :   nsString organization;
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :   rv = certificate-&gt;GetOrganization(organization);</span>
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :   if (!organization.IsEmpty()) {</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :     whitelistString.AppendLiteral(&quot;/O=&quot;);</span>
<span class="lineNum">     946 </span>            :     whitelistString.Append(
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :       EscapeCertificateAttribute(NS_ConvertUTF16toUTF8(organization)));</span>
<span class="lineNum">     948 </span>            :   }
<span class="lineNum">     949 </span>            : 
<span class="lineNum">     950 </span>            :   nsString organizationalUnit;
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :   rv = certificate-&gt;GetOrganizationalUnit(organizationalUnit);</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :   if (!organizationalUnit.IsEmpty()) {</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :     whitelistString.AppendLiteral(&quot;/OU=&quot;);</span>
<span class="lineNum">     955 </span>            :     whitelistString.Append(
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :       EscapeCertificateAttribute(NS_ConvertUTF16toUTF8(organizationalUnit)));</span>
<span class="lineNum">     957 </span>            :   }
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :   LOG((&quot;Whitelisting %s&quot;, whitelistString.get()));</span>
<span class="lineNum">     959 </span>            : 
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :   mAllowlistSpecs.AppendElement(whitelistString);</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">     962 </span>            : }
<span class="lineNum">     963 </span>            : 
<span class="lineNum">     964 </span>            : nsresult
<span class="lineNum">     965 </span><span class="lineNoCov">          0 : PendingLookup::GenerateWhitelistStringsForChain(</span>
<span class="lineNum">     966 </span>            :   const safe_browsing::ClientDownloadRequest_CertificateChain&amp; aChain)
<span class="lineNum">     967 </span>            : {
<span class="lineNum">     968 </span>            :   // We need a signing certificate and an issuer to construct a whitelist
<span class="lineNum">     969 </span>            :   // entry.
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :   if (aChain.element_size() &lt; 2) {</span>
<span class="lineNum">     971 </span>            :     return NS_OK;
<span class="lineNum">     972 </span>            :   }
<span class="lineNum">     973 </span>            : 
<span class="lineNum">     974 </span>            :   // Get the signer.
<span class="lineNum">     975 </span>            :   nsresult rv;
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIX509CertDB&gt; certDB = do_GetService(NS_X509CERTDB_CONTRACTID, &amp;rv);</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     978 </span>            : 
<span class="lineNum">     979 </span>            :   nsCOMPtr&lt;nsIX509Cert&gt; signer;
<span class="lineNum">     980 </span>            :   nsDependentCSubstring signerDER(
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :     const_cast&lt;char *&gt;(aChain.element(0).certificate().data()),</span>
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :     aChain.element(0).certificate().size());</span>
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :   rv = certDB-&gt;ConstructX509(signerDER, getter_AddRefs(signer));</span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     985 </span>            : 
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :   for (int i = 1; i &lt; aChain.element_size(); ++i) {</span>
<span class="lineNum">     987 </span>            :     // Get the issuer.
<span class="lineNum">     988 </span>            :     nsCOMPtr&lt;nsIX509Cert&gt; issuer;
<span class="lineNum">     989 </span>            :     nsDependentCSubstring issuerDER(
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :       const_cast&lt;char *&gt;(aChain.element(i).certificate().data()),</span>
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :       aChain.element(i).certificate().size());</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :     rv = certDB-&gt;ConstructX509(issuerDER, getter_AddRefs(issuer));</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     994 </span>            : 
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :     rv = GenerateWhitelistStringsForPair(signer, issuer);</span>
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">     997 </span>            :   }
<span class="lineNum">     998 </span>            :   return NS_OK;
<span class="lineNum">     999 </span>            : }
<span class="lineNum">    1000 </span>            : 
<span class="lineNum">    1001 </span>            : nsresult
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 : PendingLookup::GenerateWhitelistStrings()</span>
<span class="lineNum">    1003 </span>            : {
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :   for (int i = 0; i &lt; mRequest.signature().certificate_chain_size(); ++i) {</span>
<span class="lineNum">    1005 </span>            :     nsresult rv = GenerateWhitelistStringsForChain(
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :       mRequest.signature().certificate_chain(i));</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1008 </span>            :   }
<span class="lineNum">    1009 </span>            :   return NS_OK;
<span class="lineNum">    1010 </span>            : }
<span class="lineNum">    1011 </span>            : 
<span class="lineNum">    1012 </span>            : nsresult
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 : PendingLookup::AddRedirects(nsIArray* aRedirects)</span>
<span class="lineNum">    1014 </span>            : {
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :   uint32_t length = 0;</span>
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :   aRedirects-&gt;GetLength(&amp;length);</span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :   LOG((&quot;ApplicationReputation: Got %u redirects&quot;, length));</span>
<span class="lineNum">    1018 </span>            :   nsCOMPtr&lt;nsISimpleEnumerator&gt; iter;
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :   nsresult rv = aRedirects-&gt;Enumerate(getter_AddRefs(iter));</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1021 </span>            : 
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :   bool hasMoreRedirects = false;</span>
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :   rv = iter-&gt;HasMoreElements(&amp;hasMoreRedirects);</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1025 </span>            : 
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :   while (hasMoreRedirects) {</span>
<span class="lineNum">    1027 </span>            :     nsCOMPtr&lt;nsISupports&gt; supports;
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :     rv = iter-&gt;GetNext(getter_AddRefs(supports));</span>
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1030 </span>            : 
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIPrincipal&gt; principal = do_QueryInterface(supports, &amp;rv);</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1033 </span>            : 
<span class="lineNum">    1034 </span>            :     nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :     rv = principal-&gt;GetURI(getter_AddRefs(uri));</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1037 </span>            : 
<span class="lineNum">    1038 </span>            :     // Add the spec to our list of local lookups. The most recent redirect is
<span class="lineNum">    1039 </span>            :     // the last element.
<span class="lineNum">    1040 </span>            :     nsCString spec;
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :     rv = GetStrippedSpec(uri, spec);</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :     mAnylistSpecs.AppendElement(spec);</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :     LOG((&quot;ApplicationReputation: Appending redirect %s\n&quot;, spec.get()));</span>
<span class="lineNum">    1045 </span>            : 
<span class="lineNum">    1046 </span>            :     // Store the redirect information in the remote request.
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :     ClientDownloadRequest_Resource* resource = mRequest.add_resources();</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :     resource-&gt;set_url(spec.get());</span>
<span class="lineNum">    1049 </span>            :     resource-&gt;set_type(ClientDownloadRequest::DOWNLOAD_REDIRECT);
<span class="lineNum">    1050 </span>            : 
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :     rv = iter-&gt;HasMoreElements(&amp;hasMoreRedirects);</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1053 </span>            :   }
<span class="lineNum">    1054 </span>            :   return NS_OK;
<span class="lineNum">    1055 </span>            : }
<a name="1056"><span class="lineNum">    1056 </span>            : </a>
<span class="lineNum">    1057 </span>            : nsresult
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 : PendingLookup::StartLookup()</span>
<span class="lineNum">    1059 </span>            : {
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :   mStartTime = TimeStamp::Now();</span>
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :   nsresult rv = DoLookupInternal();</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :     return OnComplete(false, NS_OK);</span>
<span class="lineNum">    1064 </span>            :   }
<span class="lineNum">    1065 </span>            :   return rv;
<span class="lineNum">    1066 </span>            : }
<a name="1067"><span class="lineNum">    1067 </span>            : </a>
<span class="lineNum">    1068 </span>            : nsresult
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 : PendingLookup::GetStrippedSpec(nsIURI* aUri, nsACString&amp; escaped)</span>
<span class="lineNum">    1070 </span>            : {
<span class="lineNum">    1071 </span>            :   // If aURI is not an nsIURL, we do not want to check the lists or send a
<span class="lineNum">    1072 </span>            :   // remote query.
<span class="lineNum">    1073 </span>            :   nsresult rv;
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIURL&gt; url = do_QueryInterface(aUri, &amp;rv);</span>
<span class="lineNum">    1075 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1076 </span>            : 
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :   rv = url-&gt;GetScheme(escaped);</span>
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1079 </span>            : 
<span class="lineNum">    1080 </span>            :   nsCString temp;
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :   rv = url-&gt;GetHostPort(temp);</span>
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1083 </span>            : 
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :   escaped.Append(&quot;://&quot;);</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :   escaped.Append(temp);</span>
<span class="lineNum">    1086 </span>            : 
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :   rv = url-&gt;GetFilePath(temp);</span>
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1089 </span>            : 
<span class="lineNum">    1090 </span>            :   // nsIUrl.filePath starts with '/'
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :   escaped.Append(temp);</span>
<span class="lineNum">    1092 </span>            : 
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1094 </span>            : }
<span class="lineNum">    1095 </span>            : 
<span class="lineNum">    1096 </span>            : nsresult
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 : PendingLookup::DoLookupInternal()</span>
<span class="lineNum">    1098 </span>            : {
<span class="lineNum">    1099 </span>            :   // We want to check the target URI, its referrer, and associated redirects
<span class="lineNum">    1100 </span>            :   // against the local lists.
<span class="lineNum">    1101 </span>            :   nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :   nsresult rv = mQuery-&gt;GetSourceURI(getter_AddRefs(uri));</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1104 </span>            : 
<span class="lineNum">    1105 </span>            :   nsCString sourceSpec;
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :   rv = GetStrippedSpec(uri, sourceSpec);</span>
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1108 </span>            : 
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :   mAnylistSpecs.AppendElement(sourceSpec);</span>
<span class="lineNum">    1110 </span>            : 
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :   ClientDownloadRequest_Resource* resource = mRequest.add_resources();</span>
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :   resource-&gt;set_url(sourceSpec.get());</span>
<span class="lineNum">    1113 </span>            :   resource-&gt;set_type(ClientDownloadRequest::DOWNLOAD_URL);
<span class="lineNum">    1114 </span>            : 
<span class="lineNum">    1115 </span>            :   nsCOMPtr&lt;nsIURI&gt; referrer = nullptr;
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :   rv = mQuery-&gt;GetReferrerURI(getter_AddRefs(referrer));</span>
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :   if (referrer) {</span>
<span class="lineNum">    1118 </span>            :     nsCString referrerSpec;
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :     rv = GetStrippedSpec(referrer, referrerSpec);</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :     mAnylistSpecs.AppendElement(referrerSpec);</span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :     resource-&gt;set_referrer(referrerSpec.get());</span>
<span class="lineNum">    1123 </span>            :   }
<span class="lineNum">    1124 </span>            :   nsCOMPtr&lt;nsIArray&gt; redirects;
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :   rv = mQuery-&gt;GetRedirects(getter_AddRefs(redirects));</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :   if (redirects) {</span>
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 :     AddRedirects(redirects);</span>
<span class="lineNum">    1128 </span>            :   } else {
<span class="lineNum">    1129 </span><span class="lineNoCov">          0 :     LOG((&quot;ApplicationReputation: Got no redirects [this=%p]&quot;, this));</span>
<span class="lineNum">    1130 </span>            :   }
<span class="lineNum">    1131 </span>            : 
<span class="lineNum">    1132 </span>            :   // Extract the signature and parse certificates so we can use it to check
<span class="lineNum">    1133 </span>            :   // whitelists.
<span class="lineNum">    1134 </span>            :   nsCOMPtr&lt;nsIArray&gt; sigArray;
<span class="lineNum">    1135 </span><span class="lineNoCov">          0 :   rv = mQuery-&gt;GetSignatureInfo(getter_AddRefs(sigArray));</span>
<span class="lineNum">    1136 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1137 </span>            : 
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :   if (sigArray) {</span>
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :     rv = ParseCertificates(sigArray);</span>
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1141 </span>            :   }
<span class="lineNum">    1142 </span>            : 
<span class="lineNum">    1143 </span><span class="lineNoCov">          0 :   rv = GenerateWhitelistStrings();</span>
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1145 </span>            : 
<span class="lineNum">    1146 </span>            :   // Start the call chain.
<span class="lineNum">    1147 </span><span class="lineNoCov">          0 :   return LookupNext();</span>
<span class="lineNum">    1148 </span>            : }
<a name="1149"><span class="lineNum">    1149 </span>            : </a>
<span class="lineNum">    1150 </span>            : nsresult
<span class="lineNum">    1151 </span><span class="lineNoCov">          0 : PendingLookup::OnComplete(bool shouldBlock, nsresult rv, uint32_t verdict)</span>
<span class="lineNum">    1152 </span>            : {
<span class="lineNum">    1153 </span>            :   MOZ_ASSERT(!shouldBlock ||
<span class="lineNum">    1154 </span>            :              verdict != nsIApplicationReputationService::VERDICT_SAFE);
<span class="lineNum">    1155 </span>            : 
<span class="lineNum">    1156 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    1157 </span><span class="lineNoCov">          0 :     nsAutoCString errorName;</span>
<span class="lineNum">    1158 </span><span class="lineNoCov">          0 :     mozilla::GetErrorName(rv, errorName);</span>
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :     LOG((&quot;Failed sending remote query for application reputation &quot;</span>
<span class="lineNum">    1160 </span>            :          &quot;[rv = %s, this = %p]&quot;, errorName.get(), this));
<span class="lineNum">    1161 </span>            :   }
<span class="lineNum">    1162 </span>            : 
<span class="lineNum">    1163 </span><span class="lineNoCov">          0 :   if (mTimeoutTimer) {</span>
<span class="lineNum">    1164 </span><span class="lineNoCov">          0 :     mTimeoutTimer-&gt;Cancel();</span>
<span class="lineNum">    1165 </span><span class="lineNoCov">          0 :     mTimeoutTimer = nullptr;</span>
<span class="lineNum">    1166 </span>            :   }
<span class="lineNum">    1167 </span>            : 
<span class="lineNum">    1168 </span>            :   Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_SHOULD_BLOCK,
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :     shouldBlock);</span>
<span class="lineNum">    1170 </span><span class="lineNoCov">          0 :   double t = (TimeStamp::Now() - mStartTime).ToMilliseconds();</span>
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :   LOG((&quot;Application Reputation verdict is %u, obtained in %f ms [this = %p]&quot;,</span>
<span class="lineNum">    1172 </span>            :        verdict, t, this));
<span class="lineNum">    1173 </span><span class="lineNoCov">          0 :   if (shouldBlock) {</span>
<span class="lineNum">    1174 </span><span class="lineNoCov">          0 :     LOG((&quot;Application Reputation check failed, blocking bad binary [this = %p]&quot;,</span>
<span class="lineNum">    1175 </span>            :         this));
<span class="lineNum">    1176 </span>            :   } else {
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :     LOG((&quot;Application Reputation check passed [this = %p]&quot;, this));</span>
<span class="lineNum">    1178 </span>            :   }
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :   nsresult res = mCallback-&gt;OnComplete(shouldBlock, rv, verdict);</span>
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :   return res;</span>
<span class="lineNum">    1181 </span>            : }
<span class="lineNum">    1182 </span>            : 
<span class="lineNum">    1183 </span>            : nsresult
<span class="lineNum">    1184 </span><span class="lineNoCov">          0 : PendingLookup::ParseCertificates(nsIArray* aSigArray)</span>
<span class="lineNum">    1185 </span>            : {
<span class="lineNum">    1186 </span>            :   // If we haven't been set for any reason, bail.
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(aSigArray);</span>
<span class="lineNum">    1188 </span>            : 
<span class="lineNum">    1189 </span>            :   // Binaries may be signed by multiple chains of certificates. If there are no
<span class="lineNum">    1190 </span>            :   // chains, the binary is unsigned (or we were unable to extract signature
<span class="lineNum">    1191 </span>            :   // information on a non-Windows platform)
<span class="lineNum">    1192 </span>            :   nsCOMPtr&lt;nsISimpleEnumerator&gt; chains;
<span class="lineNum">    1193 </span><span class="lineNoCov">          0 :   nsresult rv = aSigArray-&gt;Enumerate(getter_AddRefs(chains));</span>
<span class="lineNum">    1194 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1195 </span>            : 
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :   bool hasMoreChains = false;</span>
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :   rv = chains-&gt;HasMoreElements(&amp;hasMoreChains);</span>
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1199 </span>            : 
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :   while (hasMoreChains) {</span>
<span class="lineNum">    1201 </span>            :     nsCOMPtr&lt;nsISupports&gt; chainSupports;
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :     rv = chains-&gt;GetNext(getter_AddRefs(chainSupports));</span>
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1204 </span>            : 
<span class="lineNum">    1205 </span><span class="lineNoCov">          0 :     nsCOMPtr&lt;nsIX509CertList&gt; certList = do_QueryInterface(chainSupports, &amp;rv);</span>
<span class="lineNum">    1206 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1207 </span>            : 
<span class="lineNum">    1208 </span>            :     safe_browsing::ClientDownloadRequest_CertificateChain* certChain =
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :       mRequest.mutable_signature()-&gt;add_certificate_chain();</span>
<span class="lineNum">    1210 </span>            :     nsCOMPtr&lt;nsISimpleEnumerator&gt; chainElt;
<span class="lineNum">    1211 </span><span class="lineNoCov">          0 :     rv = certList-&gt;GetEnumerator(getter_AddRefs(chainElt));</span>
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1213 </span>            : 
<span class="lineNum">    1214 </span>            :     // Each chain may have multiple certificates.
<span class="lineNum">    1215 </span><span class="lineNoCov">          0 :     bool hasMoreCerts = false;</span>
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :     rv = chainElt-&gt;HasMoreElements(&amp;hasMoreCerts);</span>
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :     while (hasMoreCerts) {</span>
<span class="lineNum">    1218 </span>            :       nsCOMPtr&lt;nsISupports&gt; certSupports;
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :       rv = chainElt-&gt;GetNext(getter_AddRefs(certSupports));</span>
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1221 </span>            : 
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :       nsCOMPtr&lt;nsIX509Cert&gt; cert = do_QueryInterface(certSupports, &amp;rv);</span>
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1224 </span>            : 
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :       uint8_t* data = nullptr;</span>
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :       uint32_t len = 0;</span>
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :       rv = cert-&gt;GetRawDER(&amp;len, &amp;data);</span>
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1229 </span>            : 
<span class="lineNum">    1230 </span>            :       // Add this certificate to the protobuf to send remotely.
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :       certChain-&gt;add_element()-&gt;set_certificate(data, len);</span>
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :       free(data);</span>
<span class="lineNum">    1233 </span>            : 
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :       rv = chainElt-&gt;HasMoreElements(&amp;hasMoreCerts);</span>
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :       NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1236 </span>            :     }
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :     rv = chains-&gt;HasMoreElements(&amp;hasMoreChains);</span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1239 </span>            :   }
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :   if (mRequest.signature().certificate_chain_size() &gt; 0) {</span>
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :     mRequest.mutable_signature()-&gt;set_trusted(true);</span>
<span class="lineNum">    1242 </span>            :   }
<span class="lineNum">    1243 </span>            :   return NS_OK;
<span class="lineNum">    1244 </span>            : }
<a name="1245"><span class="lineNum">    1245 </span>            : </a>
<span class="lineNum">    1246 </span>            : nsresult
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 : PendingLookup::SendRemoteQuery()</span>
<span class="lineNum">    1248 </span>            : {
<span class="lineNum">    1249 </span><span class="lineNoCov">          0 :   nsresult rv = SendRemoteQueryInternal();</span>
<span class="lineNum">    1250 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :     return OnComplete(false, rv);</span>
<span class="lineNum">    1252 </span>            :   }
<span class="lineNum">    1253 </span>            :   // SendRemoteQueryInternal has fired off the query and we call OnComplete in
<span class="lineNum">    1254 </span>            :   // the nsIStreamListener.onStopRequest.
<span class="lineNum">    1255 </span>            :   return rv;
<span class="lineNum">    1256 </span>            : }
<span class="lineNum">    1257 </span>            : 
<span class="lineNum">    1258 </span>            : nsresult
<span class="lineNum">    1259 </span><span class="lineNoCov">          0 : PendingLookup::SendRemoteQueryInternal()</span>
<span class="lineNum">    1260 </span>            : {
<span class="lineNum">    1261 </span>            :   // If we aren't supposed to do remote lookups, bail.
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 :   if (!Preferences::GetBool(PREF_SB_DOWNLOADS_REMOTE_ENABLED, false)) {</span>
<span class="lineNum">    1263 </span><span class="lineNoCov">          0 :     LOG((&quot;Remote lookups are disabled [this = %p]&quot;, this));</span>
<span class="lineNum">    1264 </span>            :     return NS_ERROR_NOT_AVAILABLE;
<span class="lineNum">    1265 </span>            :   }
<span class="lineNum">    1266 </span>            :   // If the remote lookup URL is empty or absent, bail.
<span class="lineNum">    1267 </span>            :   nsCString serviceUrl;
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(Preferences::GetCString(PREF_SB_APP_REP_URL, &amp;serviceUrl),</span>
<span class="lineNum">    1269 </span>            :                     NS_ERROR_NOT_AVAILABLE);
<span class="lineNum">    1270 </span><span class="lineNoCov">          0 :   if (serviceUrl.IsEmpty()) {</span>
<span class="lineNum">    1271 </span><span class="lineNoCov">          0 :     LOG((&quot;Remote lookup URL is empty [this = %p]&quot;, this));</span>
<span class="lineNum">    1272 </span>            :     return NS_ERROR_NOT_AVAILABLE;
<span class="lineNum">    1273 </span>            :   }
<span class="lineNum">    1274 </span>            : 
<span class="lineNum">    1275 </span>            :   // If the blocklist or allowlist is empty (so we couldn't do local lookups),
<span class="lineNum">    1276 </span>            :   // bail
<span class="lineNum">    1277 </span>            :   {
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :     nsAutoCString table;</span>
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :     NS_ENSURE_SUCCESS(Preferences::GetCString(PREF_DOWNLOAD_BLOCK_TABLE,</span>
<span class="lineNum">    1280 </span>            :                                               &amp;table),
<span class="lineNum">    1281 </span>            :                       NS_ERROR_NOT_AVAILABLE);
<span class="lineNum">    1282 </span><span class="lineNoCov">          0 :     if (table.IsEmpty()) {</span>
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 :       LOG((&quot;Blocklist is empty [this = %p]&quot;, this));</span>
<span class="lineNum">    1284 </span>            :       return NS_ERROR_NOT_AVAILABLE;
<span class="lineNum">    1285 </span>            :     }
<span class="lineNum">    1286 </span>            :   }
<span class="lineNum">    1287 </span>            : #ifdef XP_WIN
<span class="lineNum">    1288 </span>            :   // The allowlist is only needed to do signature verification on Windows
<span class="lineNum">    1289 </span>            :   {
<span class="lineNum">    1290 </span>            :     nsAutoCString table;
<span class="lineNum">    1291 </span>            :     NS_ENSURE_SUCCESS(Preferences::GetCString(PREF_DOWNLOAD_ALLOW_TABLE,
<span class="lineNum">    1292 </span>            :                                               &amp;table),
<span class="lineNum">    1293 </span>            :                       NS_ERROR_NOT_AVAILABLE);
<span class="lineNum">    1294 </span>            :     if (table.IsEmpty()) {
<span class="lineNum">    1295 </span>            :       LOG((&quot;Allowlist is empty [this = %p]&quot;, this));
<span class="lineNum">    1296 </span>            :       return NS_ERROR_NOT_AVAILABLE;
<span class="lineNum">    1297 </span>            :     }
<span class="lineNum">    1298 </span>            :   }
<span class="lineNum">    1299 </span>            : #endif
<span class="lineNum">    1300 </span>            : 
<span class="lineNum">    1301 </span><span class="lineNoCov">          0 :   LOG((&quot;Sending remote query for application reputation [this = %p]&quot;,</span>
<span class="lineNum">    1302 </span>            :        this));
<span class="lineNum">    1303 </span>            :   // We did not find a local result, so fire off the query to the
<span class="lineNum">    1304 </span>            :   // application reputation service.
<span class="lineNum">    1305 </span>            :   nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">    1306 </span>            :   nsresult rv;
<span class="lineNum">    1307 </span><span class="lineNoCov">          0 :   rv = mQuery-&gt;GetSourceURI(getter_AddRefs(uri));</span>
<span class="lineNum">    1308 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1309 </span>            :   nsCString spec;
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :   rv = GetStrippedSpec(uri, spec);</span>
<span class="lineNum">    1311 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :   mRequest.set_url(spec.get());</span>
<span class="lineNum">    1313 </span>            : 
<span class="lineNum">    1314 </span>            :   uint32_t fileSize;
<span class="lineNum">    1315 </span><span class="lineNoCov">          0 :   rv = mQuery-&gt;GetFileSize(&amp;fileSize);</span>
<span class="lineNum">    1316 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1317 </span><span class="lineNoCov">          0 :   mRequest.set_length(fileSize);</span>
<span class="lineNum">    1318 </span>            :   // We have no way of knowing whether or not a user initiated the
<span class="lineNum">    1319 </span>            :   // download. Set it to true to lessen the chance of false positives.
<span class="lineNum">    1320 </span><span class="lineNoCov">          0 :   mRequest.set_user_initiated(true);</span>
<span class="lineNum">    1321 </span>            : 
<span class="lineNum">    1322 </span>            :   nsCString locale;
<span class="lineNum">    1323 </span><span class="lineNoCov">          0 :   rv = LocaleService::GetInstance()-&gt;GetAppLocaleAsLangTag(locale);</span>
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1325 </span><span class="lineNoCov">          0 :   mRequest.set_locale(locale.get());</span>
<span class="lineNum">    1326 </span>            :   nsCString sha256Hash;
<span class="lineNum">    1327 </span><span class="lineNoCov">          0 :   rv = mQuery-&gt;GetSha256Hash(sha256Hash);</span>
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :   mRequest.mutable_digests()-&gt;set_sha256(sha256Hash.Data());</span>
<span class="lineNum">    1330 </span>            :   nsString fileName;
<span class="lineNum">    1331 </span><span class="lineNoCov">          0 :   rv = mQuery-&gt;GetSuggestedFileName(fileName);</span>
<span class="lineNum">    1332 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :   mRequest.set_file_basename(NS_ConvertUTF16toUTF8(fileName).get());</span>
<span class="lineNum">    1334 </span><span class="lineNoCov">          0 :   mRequest.set_download_type(GetDownloadType(fileName));</span>
<span class="lineNum">    1335 </span>            : 
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :   if (mRequest.signature().trusted()) {</span>
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :     LOG((&quot;Got signed binary for remote application reputation check &quot;</span>
<span class="lineNum">    1338 </span>            :          &quot;[this = %p]&quot;, this));
<span class="lineNum">    1339 </span>            :   } else {
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 :     LOG((&quot;Got unsigned binary for remote application reputation check &quot;</span>
<span class="lineNum">    1341 </span>            :          &quot;[this = %p]&quot;, this));
<span class="lineNum">    1342 </span>            :   }
<span class="lineNum">    1343 </span>            : 
<span class="lineNum">    1344 </span>            :   // Serialize the protocol buffer to a string. This can only fail if we are
<span class="lineNum">    1345 </span>            :   // out of memory, or if the protocol buffer req is missing required fields
<span class="lineNum">    1346 </span>            :   // (only the URL for now).
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :   std::string serialized;</span>
<span class="lineNum">    1348 </span><span class="lineNoCov">          0 :   if (!mRequest.SerializeToString(&amp;serialized)) {</span>
<span class="lineNum">    1349 </span>            :     return NS_ERROR_UNEXPECTED;
<span class="lineNum">    1350 </span>            :   }
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :   LOG((&quot;Serialized protocol buffer [this = %p]: (length=%&quot; PRIuSIZE &quot;) %s&quot;, this,</span>
<span class="lineNum">    1352 </span>            :        serialized.length(), serialized.c_str()));
<span class="lineNum">    1353 </span>            : 
<span class="lineNum">    1354 </span>            :   // Set the input stream to the serialized protocol buffer
<span class="lineNum">    1355 </span>            :   nsCOMPtr&lt;nsIStringInputStream&gt; sstream =
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :     do_CreateInstance(&quot;@mozilla.org/io/string-input-stream;1&quot;, &amp;rv);</span>
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1358 </span>            : 
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :   rv = sstream-&gt;SetData(serialized.c_str(), serialized.length());</span>
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1361 </span>            : 
<span class="lineNum">    1362 </span>            :   // Set up the channel to transmit the request to the service.
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIIOService&gt; ios = do_GetService(NS_IOSERVICE_CONTRACTID, &amp;rv);</span>
<span class="lineNum">    1364 </span>            :   rv = ios-&gt;NewChannel2(serviceUrl,
<span class="lineNum">    1365 </span>            :                         nullptr,
<span class="lineNum">    1366 </span>            :                         nullptr,
<span class="lineNum">    1367 </span>            :                         nullptr, // aLoadingNode
<span class="lineNum">    1368 </span>            :                         nsContentUtils::GetSystemPrincipal(),
<span class="lineNum">    1369 </span>            :                         nullptr, // aTriggeringPrincipal
<span class="lineNum">    1370 </span>            :                         nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,
<span class="lineNum">    1371 </span>            :                         nsIContentPolicy::TYPE_OTHER,
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :                         getter_AddRefs(mChannel));</span>
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1374 </span>            : 
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsILoadInfo&gt; loadInfo = mChannel-&gt;GetLoadInfo();</span>
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :   if (loadInfo) {</span>
<span class="lineNum">    1377 </span>            :     mozilla::OriginAttributes attrs;
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :     attrs.mFirstPartyDomain.AssignLiteral(NECKO_SAFEBROWSING_FIRST_PARTY_DOMAIN);</span>
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :     loadInfo-&gt;SetOriginAttributes(attrs);</span>
<span class="lineNum">    1380 </span>            :   }
<span class="lineNum">    1381 </span>            : 
<span class="lineNum">    1382 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIHttpChannel&gt; httpChannel(do_QueryInterface(mChannel, &amp;rv));</span>
<span class="lineNum">    1383 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1384 </span><span class="lineNoCov">          0 :   mozilla::Unused &lt;&lt; httpChannel;</span>
<span class="lineNum">    1385 </span>            : 
<span class="lineNum">    1386 </span>            :   // Upload the protobuf to the application reputation service.
<span class="lineNum">    1387 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIUploadChannel2&gt; uploadChannel = do_QueryInterface(mChannel, &amp;rv);</span>
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1389 </span>            : 
<span class="lineNum">    1390 </span>            :   rv = uploadChannel-&gt;ExplicitSetUploadStream(sstream,
<span class="lineNum">    1391 </span>            :     NS_LITERAL_CSTRING(&quot;application/octet-stream&quot;), serialized.size(),
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :     NS_LITERAL_CSTRING(&quot;POST&quot;), false);</span>
<span class="lineNum">    1393 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1394 </span>            : 
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 :   uint32_t timeoutMs = Preferences::GetUint(PREF_SB_DOWNLOADS_REMOTE_TIMEOUT, 10000);</span>
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :   mTimeoutTimer = do_CreateInstance(NS_TIMER_CONTRACTID);</span>
<span class="lineNum">    1397 </span><span class="lineNoCov">          0 :   mTimeoutTimer-&gt;InitWithCallback(this, timeoutMs, nsITimer::TYPE_ONE_SHOT);</span>
<span class="lineNum">    1398 </span>            : 
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :   rv = mChannel-&gt;AsyncOpen2(this);</span>
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1401 </span>            : 
<span class="lineNum">    1402 </span>            :   return NS_OK;
<span class="lineNum">    1403 </span>            : }
<a name="1404"><span class="lineNum">    1404 </span>            : </a>
<span class="lineNum">    1405 </span>            : NS_IMETHODIMP
<span class="lineNum">    1406 </span><span class="lineNoCov">          0 : PendingLookup::Notify(nsITimer* aTimer)</span>
<span class="lineNum">    1407 </span>            : {
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 :   LOG((&quot;Remote lookup timed out [this = %p]&quot;, this));</span>
<span class="lineNum">    1409 </span>            :   MOZ_ASSERT(aTimer == mTimeoutTimer);
<span class="lineNum">    1410 </span>            :   Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_REMOTE_LOOKUP_TIMEOUT,
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 :     true);</span>
<span class="lineNum">    1412 </span><span class="lineNoCov">          0 :   mChannel-&gt;Cancel(NS_ERROR_NET_TIMEOUT);</span>
<span class="lineNum">    1413 </span><span class="lineNoCov">          0 :   mTimeoutTimer-&gt;Cancel();</span>
<span class="lineNum">    1414 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1415 </span>            : }
<span class="lineNum">    1416 </span>            : 
<span class="lineNum">    1417 </span>            : ///////////////////////////////////////////////////////////////////////////////
<a name="1418"><span class="lineNum">    1418 </span>            : // nsIObserver implementation</a>
<span class="lineNum">    1419 </span>            : NS_IMETHODIMP
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 : PendingLookup::Observe(nsISupports *aSubject, const char *aTopic,</span>
<span class="lineNum">    1421 </span>            :                        const char16_t *aData)
<span class="lineNum">    1422 </span>            : {
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :   if (!strcmp(aTopic, &quot;quit-application&quot;)) {</span>
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :     if (mTimeoutTimer) {</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :       mTimeoutTimer-&gt;Cancel();</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :       mTimeoutTimer = nullptr;</span>
<span class="lineNum">    1427 </span>            :     }
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :     if (mChannel) {</span>
<span class="lineNum">    1429 </span><span class="lineNoCov">          0 :       mChannel-&gt;Cancel(NS_ERROR_ABORT);</span>
<span class="lineNum">    1430 </span>            :     }
<span class="lineNum">    1431 </span>            :   }
<span class="lineNum">    1432 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1433 </span>            : }
<span class="lineNum">    1434 </span>            : 
<span class="lineNum">    1435 </span>            : ////////////////////////////////////////////////////////////////////////////////
<a name="1436"><span class="lineNum">    1436 </span>            : //// nsIStreamListener</a>
<span class="lineNum">    1437 </span>            : static nsresult
<span class="lineNum">    1438 </span><span class="lineNoCov">          0 : AppendSegmentToString(nsIInputStream* inputStream,</span>
<span class="lineNum">    1439 </span>            :                       void *closure,
<span class="lineNum">    1440 </span>            :                       const char *rawSegment,
<span class="lineNum">    1441 </span>            :                       uint32_t toOffset,
<span class="lineNum">    1442 </span>            :                       uint32_t count,
<span class="lineNum">    1443 </span>            :                       uint32_t *writeCount) {
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :   nsAutoCString* decodedData = static_cast&lt;nsAutoCString*&gt;(closure);</span>
<span class="lineNum">    1445 </span><span class="lineNoCov">          0 :   decodedData-&gt;Append(rawSegment, count);</span>
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 :   *writeCount = count;</span>
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1448 </span>            : }
<a name="1449"><span class="lineNum">    1449 </span>            : </a>
<span class="lineNum">    1450 </span>            : NS_IMETHODIMP
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 : PendingLookup::OnDataAvailable(nsIRequest *aRequest,</span>
<span class="lineNum">    1452 </span>            :                                nsISupports *aContext,
<span class="lineNum">    1453 </span>            :                                nsIInputStream *aStream,
<span class="lineNum">    1454 </span>            :                                uint64_t offset,
<span class="lineNum">    1455 </span>            :                                uint32_t count) {
<span class="lineNum">    1456 </span>            :   uint32_t read;
<span class="lineNum">    1457 </span><span class="lineNoCov">          0 :   return aStream-&gt;ReadSegments(AppendSegmentToString, &amp;mResponse, count, &amp;read);</span>
<span class="lineNum">    1458 </span>            : }
<a name="1459"><span class="lineNum">    1459 </span>            : </a>
<span class="lineNum">    1460 </span>            : NS_IMETHODIMP
<span class="lineNum">    1461 </span><span class="lineNoCov">          0 : PendingLookup::OnStartRequest(nsIRequest *aRequest,</span>
<span class="lineNum">    1462 </span>            :                               nsISupports *aContext) {
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :   return NS_OK;</span>
<span class="lineNum">    1464 </span>            : }
<a name="1465"><span class="lineNum">    1465 </span>            : </a>
<span class="lineNum">    1466 </span>            : NS_IMETHODIMP
<span class="lineNum">    1467 </span><span class="lineNoCov">          0 : PendingLookup::OnStopRequest(nsIRequest *aRequest,</span>
<span class="lineNum">    1468 </span>            :                              nsISupports *aContext,
<span class="lineNum">    1469 </span>            :                              nsresult aResult) {
<span class="lineNum">    1470 </span><span class="lineNoCov">          0 :   NS_ENSURE_STATE(mCallback);</span>
<span class="lineNum">    1471 </span>            : 
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :   bool shouldBlock = false;</span>
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :   uint32_t verdict = nsIApplicationReputationService::VERDICT_SAFE;</span>
<span class="lineNum">    1474 </span>            :   Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_REMOTE_LOOKUP_TIMEOUT,
<span class="lineNum">    1475 </span><span class="lineNoCov">          0 :     false);</span>
<span class="lineNum">    1476 </span>            : 
<span class="lineNum">    1477 </span>            :   nsresult rv = OnStopRequestInternal(aRequest, aContext, aResult,
<span class="lineNum">    1478 </span><span class="lineNoCov">          0 :                                       &amp;shouldBlock, &amp;verdict);</span>
<span class="lineNum">    1479 </span><span class="lineNoCov">          0 :   OnComplete(shouldBlock, rv, verdict);</span>
<span class="lineNum">    1480 </span><span class="lineNoCov">          0 :   return rv;</span>
<span class="lineNum">    1481 </span>            : }
<span class="lineNum">    1482 </span>            : 
<span class="lineNum">    1483 </span>            : nsresult
<span class="lineNum">    1484 </span><span class="lineNoCov">          0 : PendingLookup::OnStopRequestInternal(nsIRequest *aRequest,</span>
<span class="lineNum">    1485 </span>            :                                      nsISupports *aContext,
<span class="lineNum">    1486 </span>            :                                      nsresult aResult,
<span class="lineNum">    1487 </span>            :                                      bool* aShouldBlock,
<span class="lineNum">    1488 </span>            :                                      uint32_t* aVerdict) {
<span class="lineNum">    1489 </span><span class="lineNoCov">          0 :   if (NS_FAILED(aResult)) {</span>
<span class="lineNum">    1490 </span>            :     Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_SERVER,
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :       SERVER_RESPONSE_FAILED);</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :     return aResult;</span>
<span class="lineNum">    1493 </span>            :   }
<span class="lineNum">    1494 </span>            : 
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :   *aShouldBlock = false;</span>
<span class="lineNum">    1496 </span><span class="lineNoCov">          0 :   *aVerdict = nsIApplicationReputationService::VERDICT_SAFE;</span>
<span class="lineNum">    1497 </span>            :   nsresult rv;
<span class="lineNum">    1498 </span><span class="lineNoCov">          0 :   nsCOMPtr&lt;nsIHttpChannel&gt; channel = do_QueryInterface(aRequest, &amp;rv);</span>
<span class="lineNum">    1499 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    1500 </span>            :     Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_SERVER,
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :       SERVER_RESPONSE_FAILED);</span>
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">    1503 </span>            :   }
<span class="lineNum">    1504 </span>            : 
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :   uint32_t status = 0;</span>
<span class="lineNum">    1506 </span><span class="lineNoCov">          0 :   rv = channel-&gt;GetResponseStatus(&amp;status);</span>
<span class="lineNum">    1507 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    1508 </span>            :     Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_SERVER,
<span class="lineNum">    1509 </span><span class="lineNoCov">          0 :       SERVER_RESPONSE_FAILED);</span>
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :     return rv;</span>
<span class="lineNum">    1511 </span>            :   }
<span class="lineNum">    1512 </span>            : 
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 :   if (status != 200) {</span>
<span class="lineNum">    1514 </span>            :     Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_SERVER,
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :       SERVER_RESPONSE_FAILED);</span>
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :     return NS_ERROR_NOT_AVAILABLE;</span>
<span class="lineNum">    1517 </span>            :   }
<span class="lineNum">    1518 </span>            : 
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :   std::string buf(mResponse.Data(), mResponse.Length());</span>
<span class="lineNum">    1520 </span><span class="lineNoCov">          0 :   safe_browsing::ClientDownloadResponse response;</span>
<span class="lineNum">    1521 </span><span class="lineNoCov">          0 :   if (!response.ParseFromString(buf)) {</span>
<span class="lineNum">    1522 </span><span class="lineNoCov">          0 :     LOG((&quot;Invalid protocol buffer response [this = %p]: %s&quot;, this, buf.c_str()));</span>
<span class="lineNum">    1523 </span>            :     Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_SERVER,
<span class="lineNum">    1524 </span><span class="lineNoCov">          0 :                                    SERVER_RESPONSE_INVALID);</span>
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :     return NS_ERROR_CANNOT_CONVERT_DATA;</span>
<span class="lineNum">    1526 </span>            :   }
<span class="lineNum">    1527 </span>            : 
<span class="lineNum">    1528 </span>            :   Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_SERVER,
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :     SERVER_RESPONSE_VALID);</span>
<span class="lineNum">    1530 </span>            :   // Clamp responses 0-7, we only know about 0-4 for now.
<span class="lineNum">    1531 </span>            :   Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_SERVER_VERDICT,
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 :     std::min&lt;uint32_t&gt;(response.verdict(), 7));</span>
<span class="lineNum">    1533 </span><span class="lineNoCov">          0 :   switch(response.verdict()) {</span>
<span class="lineNum">    1534 </span>            :     case safe_browsing::ClientDownloadResponse::DANGEROUS:
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :       *aShouldBlock = Preferences::GetBool(PREF_BLOCK_DANGEROUS, true);</span>
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :       *aVerdict = nsIApplicationReputationService::VERDICT_DANGEROUS;</span>
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1538 </span>            :     case safe_browsing::ClientDownloadResponse::DANGEROUS_HOST:
<span class="lineNum">    1539 </span><span class="lineNoCov">          0 :       *aShouldBlock = Preferences::GetBool(PREF_BLOCK_DANGEROUS_HOST, true);</span>
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :       *aVerdict = nsIApplicationReputationService::VERDICT_DANGEROUS_HOST;</span>
<span class="lineNum">    1541 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1542 </span>            :     case safe_browsing::ClientDownloadResponse::POTENTIALLY_UNWANTED:
<span class="lineNum">    1543 </span><span class="lineNoCov">          0 :       *aShouldBlock = Preferences::GetBool(PREF_BLOCK_POTENTIALLY_UNWANTED, false);</span>
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :       *aVerdict = nsIApplicationReputationService::VERDICT_POTENTIALLY_UNWANTED;</span>
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1546 </span>            :     case safe_browsing::ClientDownloadResponse::UNCOMMON:
<span class="lineNum">    1547 </span><span class="lineNoCov">          0 :       *aShouldBlock = Preferences::GetBool(PREF_BLOCK_UNCOMMON, false);</span>
<span class="lineNum">    1548 </span><span class="lineNoCov">          0 :       *aVerdict = nsIApplicationReputationService::VERDICT_UNCOMMON;</span>
<span class="lineNum">    1549 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">    1550 </span>            :     default:
<span class="lineNum">    1551 </span>            :       // Treat everything else as safe
<span class="lineNum">    1552 </span>            :       break;
<span class="lineNum">    1553 </span>            :   }
<span class="lineNum">    1554 </span>            : 
<span class="lineNum">    1555 </span>            :   return NS_OK;
<a name="1556"><span class="lineNum">    1556 </span>            : }</a>
<span class="lineNum">    1557 </span>            : 
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 : NS_IMPL_ISUPPORTS(ApplicationReputationService,</span>
<span class="lineNum">    1559 </span>            :                   nsIApplicationReputationService)
<span class="lineNum">    1560 </span>            : 
<span class="lineNum">    1561 </span>            : ApplicationReputationService*
<span class="lineNum">    1562 </span>            :   ApplicationReputationService::gApplicationReputationService = nullptr;
<span class="lineNum">    1563 </span>            : 
<span class="lineNum">    1564 </span>            : ApplicationReputationService*
<span class="lineNum">    1565 </span><span class="lineNoCov">          0 : ApplicationReputationService::GetSingleton()</span>
<span class="lineNum">    1566 </span>            : {
<span class="lineNum">    1567 </span><span class="lineNoCov">          0 :   if (gApplicationReputationService) {</span>
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :     NS_ADDREF(gApplicationReputationService);</span>
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :     return gApplicationReputationService;</span>
<span class="lineNum">    1570 </span>            :   }
<span class="lineNum">    1571 </span>            : 
<span class="lineNum">    1572 </span>            :   // We're not initialized yet.
<span class="lineNum">    1573 </span><span class="lineNoCov">          0 :   gApplicationReputationService = new ApplicationReputationService();</span>
<span class="lineNum">    1574 </span><span class="lineNoCov">          0 :   if (gApplicationReputationService) {</span>
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 :     NS_ADDREF(gApplicationReputationService);</span>
<span class="lineNum">    1576 </span>            :   }
<span class="lineNum">    1577 </span>            : 
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :   return gApplicationReputationService;</span>
<a name="1579"><span class="lineNum">    1579 </span>            : }</a>
<span class="lineNum">    1580 </span>            : 
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 : ApplicationReputationService::ApplicationReputationService()</span>
<span class="lineNum">    1582 </span>            : {
<span class="lineNum">    1583 </span><span class="lineNoCov">          0 :   LOG((&quot;Application reputation service started up&quot;));</span>
<a name="1584"><span class="lineNum">    1584 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1585 </span>            : 
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 : ApplicationReputationService::~ApplicationReputationService() {</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :   LOG((&quot;Application reputation service shutting down&quot;));</span>
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 : }</span>
<a name="1589"><span class="lineNum">    1589 </span>            : </a>
<span class="lineNum">    1590 </span>            : NS_IMETHODIMP
<span class="lineNum">    1591 </span><span class="lineNoCov">          0 : ApplicationReputationService::QueryReputation(</span>
<span class="lineNum">    1592 </span>            :     nsIApplicationReputationQuery* aQuery,
<span class="lineNum">    1593 </span>            :     nsIApplicationReputationCallback* aCallback) {
<span class="lineNum">    1594 </span><span class="lineNoCov">          0 :   LOG((&quot;Starting application reputation check [query=%p]&quot;, aQuery));</span>
<span class="lineNum">    1595 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(aQuery);</span>
<span class="lineNum">    1596 </span><span class="lineNoCov">          0 :   NS_ENSURE_ARG_POINTER(aCallback);</span>
<span class="lineNum">    1597 </span>            : 
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 :   Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_COUNT, true);</span>
<span class="lineNum">    1599 </span><span class="lineNoCov">          0 :   nsresult rv = QueryReputationInternal(aQuery, aCallback);</span>
<span class="lineNum">    1600 </span><span class="lineNoCov">          0 :   if (NS_FAILED(rv)) {</span>
<span class="lineNum">    1601 </span>            :     Accumulate(mozilla::Telemetry::APPLICATION_REPUTATION_SHOULD_BLOCK,
<span class="lineNum">    1602 </span><span class="lineNoCov">          0 :       false);</span>
<span class="lineNum">    1603 </span>            :     aCallback-&gt;OnComplete(false, rv,
<span class="lineNum">    1604 </span><span class="lineNoCov">          0 :                           nsIApplicationReputationService::VERDICT_SAFE);</span>
<span class="lineNum">    1605 </span>            :   }
<span class="lineNum">    1606 </span>            :   return NS_OK;
<a name="1607"><span class="lineNum">    1607 </span>            : }</a>
<span class="lineNum">    1608 </span>            : 
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 : nsresult ApplicationReputationService::QueryReputationInternal(</span>
<span class="lineNum">    1610 </span>            :   nsIApplicationReputationQuery* aQuery,
<span class="lineNum">    1611 </span>            :   nsIApplicationReputationCallback* aCallback) {
<span class="lineNum">    1612 </span>            :   nsresult rv;
<span class="lineNum">    1613 </span>            :   // If malware checks aren't enabled, don't query application reputation.
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :   if (!Preferences::GetBool(PREF_SB_MALWARE_ENABLED, false)) {</span>
<span class="lineNum">    1615 </span>            :     return NS_ERROR_NOT_AVAILABLE;
<span class="lineNum">    1616 </span>            :   }
<span class="lineNum">    1617 </span>            : 
<span class="lineNum">    1618 </span><span class="lineNoCov">          0 :   if (!Preferences::GetBool(PREF_SB_DOWNLOADS_ENABLED, false)) {</span>
<span class="lineNum">    1619 </span>            :     return NS_ERROR_NOT_AVAILABLE;
<span class="lineNum">    1620 </span>            :   }
<span class="lineNum">    1621 </span>            : 
<span class="lineNum">    1622 </span>            :   nsCOMPtr&lt;nsIURI&gt; uri;
<span class="lineNum">    1623 </span><span class="lineNoCov">          0 :   rv = aQuery-&gt;GetSourceURI(getter_AddRefs(uri));</span>
<span class="lineNum">    1624 </span><span class="lineNoCov">          0 :   NS_ENSURE_SUCCESS(rv, rv);</span>
<span class="lineNum">    1625 </span>            :   // Bail if the URI hasn't been set.
<span class="lineNum">    1626 </span><span class="lineNoCov">          0 :   NS_ENSURE_STATE(uri);</span>
<span class="lineNum">    1627 </span>            : 
<span class="lineNum">    1628 </span>            :   // Create a new pending lookup and start the call chain.
<span class="lineNum">    1629 </span><span class="lineNoCov">          0 :   RefPtr&lt;PendingLookup&gt; lookup(new PendingLookup(aQuery, aCallback));</span>
<span class="lineNum">    1630 </span><span class="lineNoCov">          0 :   NS_ENSURE_STATE(lookup);</span>
<span class="lineNum">    1631 </span>            : 
<span class="lineNum">    1632 </span>            :   // Add an observer for shutdown
<span class="lineNum">    1633 </span>            :   nsCOMPtr&lt;nsIObserverService&gt; observerService =
<span class="lineNum">    1634 </span><span class="lineNoCov">          0 :     mozilla::services::GetObserverService();</span>
<span class="lineNum">    1635 </span><span class="lineNoCov">          0 :   if (!observerService) {</span>
<span class="lineNum">    1636 </span>            :     return NS_ERROR_FAILURE;
<span class="lineNum">    1637 </span>            :   }
<span class="lineNum">    1638 </span>            : 
<span class="lineNum">    1639 </span><span class="lineNoCov">          0 :   observerService-&gt;AddObserver(lookup, &quot;quit-application&quot;, true);</span>
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :   return lookup-&gt;StartLookup();</span>
<span class="lineNum">    1641 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
